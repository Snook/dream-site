var g_lastSearch="";function waitForElement(){"undefined"!=typeof someVariable||setTimeout(waitForElement,250)}function handle_store_select(){$("body").change((function(){var e=$(".locations-button").not("locations-button-selected").first().html();$(".locations-button").on("click",(function(t){if(t.preventDefault(),$(this).hasClass("locations-button-selected")?($(this).removeClass("locations-button-selected"),$(this).hasClass("btn-select-checked")&&$(this).html(e)):($(".locations-button-selected").removeClass("locations-button-selected"),$(".btn-select-checked").each((function(){$(this).html(e)})),$(this).addClass("locations-button-selected"),$(this).hasClass("btn-select-checked")&&$(this).html("&nbsp;")),$(".locations-button-selected").length>0){$("#btn-next").prop("disabled",!1);var s=$(".locations-button-selected").parent().parent().find("h3").first().text();$("#selected-location-marker").removeClass("marker-disabled").text(s)}else $("#btn-next").prop("disabled",!0),$("#selected-location-marker").addClass("marker-disabled").text("&nbsp;")}))})).change()}function handle_browser_location(){getQueryVariable("state")||getQueryVariable("zip")||!$("#zipsearch_zipcode_only").length||address_location((function(e,t){"ok"==e?(latitude=t[0].geometry.location.lat(),longitude=t[0].geometry.location.lng(),addressArray=address_components(t),szZip=addressArray.postal_code.long_name,$("#zipsearch_zipcode_only").val(addressArray.postal_code.long_name),retrieve_stores_for_lat_long({latitude:latitude,longitude:longitude,zip:szZip},!1)):"error"==e||"no_result"==e?dd_message({message:t}):dd_console_log(t)}))}function address_components(e){return addressArray=[],$.each(e[0].address_components,(function(){addressArray[this.types[0]]=this})),addressArray}function handle_address_search(){return $("#zipsearch_zipcode").getVal()||$("#zipsearch_city").getVal()||$("#zipsearch_state_id").getVal()?!$("#zipsearch_zipcode").getVal()&&($("#zipsearch_city").getVal()&&!$("#zipsearch_state_id").getVal()||!$("#zipsearch_city").getVal()&&$("#zipsearch_state_id").getVal())?(dd_message({message:"City & State required"}),!1):(address_search="",$("#zipsearch_address").getVal()&&(address_search+=$("#zipsearch_address").getVal()),$("#zipsearch_city").getVal()&&(address_search+=", "+$("#zipsearch_city").getVal()),$("#zipsearch_state_id").getVal()&&(address_search+=" "+$("#zipsearch_state_id").getVal()),$("#zipsearch_zipcode").getVal()&&(address_search+=" "+$("#zipsearch_zipcode").getVal()),void address_location({address:address_search},(function(e,t){"ok"==e?(latitude=t[0].geometry.location.lat(),longitude=t[0].geometry.location.lng(),addressArray=address_components(t),void 0===addressArray.postal_code?address_location({latlong:latitude+","+longitude},(function(e,t){"ok"==e?(latitude=t[0].geometry.location.lat(),longitude=t[0].geometry.location.lng(),addressArray=address_components(t),szZip="",void 0!==addressArray.postal_code&&(szZip=addressArray.postal_code.long_name),retrieve_stores_for_lat_long({latitude:latitude,longitude:longitude,zip:szZip},!0)):"error"==e||"no_results"==e?dd_message({message:t}):dd_console_log(t)})):(szZip=addressArray.postal_code.long_name,retrieve_stores_for_lat_long({latitude:latitude,longitude:longitude,zip:szZip},!0))):"error"==e||"no_result"==e?($("#store_search_results").empty(),$("#store_search_results").html("<text>No local stores near you.</text>")):dd_console_log(t)}))):(dd_message({message:"Zip code or City & State required"}),!1)}function handle_zipcode_search(){if(address_search="",""==$("#zipsearch_zipcode_only").getVal())return dd_message({message:"Zip code required"}),!1;address_search+=" "+$("#zipsearch_zipcode_only").getVal(),address_location({address:address_search},(function(e,t){"ok"==e?(latitude=t[0].geometry.location.lat(),longitude=t[0].geometry.location.lng(),addressArray=address_components(t),szZip=addressArray.postal_code.long_name,retrieve_stores_for_lat_long({latitude:latitude,longitude:longitude,zip:szZip},!0),$("#zipsearch_zipcode_errorMessage").addClass("collapse"),$("#zipsearch_zipcode_only").removeClass("border-red")):"error"==e||"no_result"==e?($("#store_search_results").empty(),$("#zipsearch_zipcode_errorMessage").removeClass("collapse"),$("#zipsearch_zipcode_only").addClass("border-red"),$("#zipsearch_search_btn").removeClass("btn-spinner"),$("#zipsearch_search_btn").removeClass("btn-spinning"),$("#zipsearch_search_btn").addClass("btn-spinner")):dd_console_log(t)}))}function retrieve_stores_for_address(e){e.address||dd_console_log("retrieve_stores_for_address() requires settings.address"),$.extend({address:!1,compact:!1},e),address_location(e,(function(t,s){if("ok"==t){let t="";for(key in latitude=s[0].geometry.location.ob,longitude=s[0].geometry.location.pb,s[0].address_components)"postal_code"==s[0].address_components[key].types[0]&&(t=s[0].address_components[key].long_name);""!=t?retrieve_stores_for_lat_long({latitude:latitude,longitude:longitude,zip:t,compact:e.compact},!1):($("#store_search_results").empty(),$("#store_search_results").html("<text>No local stores near you.</text>"))}else"error"==t||"no_result"==t?($("#store_search_results").empty(),$("#store_search_results").html("<text>No local stores near you.</text>")):dd_console_log(s)}))}function retrieve_stores_for_lat_long(e,t){$.extend({compact:!1},e),$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"location_search",op:"json",latitude:e.latitude,longitude:e.longitude,zip:e.zip,compact:e.compact},success:function(e){$("#store_search_results").html(e.html),t&&($("html, body").animate({scrollTop:$("#store_search_results").offset().top},2e3),$("#zipsearch_search_btn").removeClass("btn-spinner"),$("#zipsearch_search_btn").removeClass("btn-spinning"),$("#zipsearch_search_btn").addClass("btn-spinner")),select_location_click_handler(),"locations"==getQueryVariable("page")&&($("#back_url_top").val("main.php?page=locations&zip="+szZip),historyPush({url:"main.php?page=locations&zip="+szZip,title:szZip+" "+document.title}))},error:function(e,t){response="Unexpected error"}})}function getStoresForState(e,t){if(void 0!==t&&0==t||$("html, body").animate({scrollTop:$("#zipsearch_zipcode_only").offset().top},2e3),g_lastSearch==e)return!1;$("#store_search_results").slideUp(),$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"location_search",op:"json",state:e},success:function(t){$("#store_search_results").html(t.html),$("#store_search_results").slideDown(),select_location_click_handler(),g_lastSearch=e,$("#zipsearch_state_id").val(e),$("#zipsearch_zipcode, #zipsearch_address, #zipsearch_city").val("").blur(),"locations"==getQueryVariable("page")&&($("#back_url_top").val("main.php?page=locations&state="+e),historyPush({url:"main.php?page=locations&state="+e,title:e+" "+document.title}))},error:function(e,t){response="Unexpected error"}})}$((function(){$(document).on("click",".location_state",(function(e){e.preventDefault(),getStoresForState($(this).data("state"))})),$(document).on("click","[data-linear_address]",(function(e){e.preventDefault(),showMap($(this).data("linear_address"))})),$(document).on("click",'[id^="locations_state-"]',(function(e){getStoresForState(this.id.split("-")[1]),e.preventDefault()})),$("#zipsearch_search_btn").on("click",(function(){handle_zipcode_search(),$(this).addClass("")})),$("#full_addr_search_btn").on("click",(function(){!1!==handle_address_search()&&$("html, body").animate({scrollTop:$("#store_search_results").offset().top},2e3)})),$("#zipsearch_zipcode").keypress((function(e){$("#zipsearch_city").getVal()||$("#zipsearch_state_id").getVal(""),13==e.which&&$("#zipsearch_search_btn").trigger("click")})),cookieCheck(),handle_browser_location(),handle_store_select(),"undefined"!=typeof simplemaps_usmap&&(simplemaps_usmap.hooks.zoomable_click_state=function(e){getStoresForState(e,!1)},simplemaps_usmap.hooks.click_state=function(e){getStoresForState(e,!0)})}));