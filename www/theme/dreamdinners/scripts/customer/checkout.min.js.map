{"version":3,"file":"checkout.min.js","names":["handle_ltd_round_up","$","document","on","e","this","is","prop","USER_PREFERENCES","LTD_AUTO_ROUND_UP","value","cookie","session_id","modal_message","title","message","modal","noOk","closeOnEscape","open","event","ui","parent","find","hide","rup_dialog","rup_value","val","div_id","confirm","remove","set_user_pref","ltd_round_up_value","index","buttons","Yes","trigger","No","round_up_val","text","formatAsMoney","slideDown","slideUp","ajax","url","type","timeout","dataType","data","processor","payment_type","success","json","processor_success","processor_message","error","objAJAXRequest","strError","updateFinancials","attr","handle_checkout_delayed_payment","get_user_pref","user_preferences","lang","en","tc","terms_and_conditions","delayed_payment","Agree","unbind","Decline","click","delayed_payment_decline","handle_special_instructions","strip_tags","submit_gift_card_purchase","field","append","submit","submit_order","create_and_submit_form","action","input","special_insts","customers_terms","handlePlatePointsDiscount","inVal","isNaN","cap","maxPPCredit","maxPPDeduction","editSaveAllPlatePointsCredits","editSavePlatePointsCredits","force","html","op","new_credit_value","orderInfo","grand_total","subtotal_all_taxes","showFlex","hideFlex","coupon_code_discount_total","avgCostPerServingEntreeCost","points_discount_total","membership_discount","can_checkout","run_as_guest","foodCost","bag_fee","length","Number","giftCardCost","each","thisCost","service_fee","delivery_fee","totalTax","prediscountFoodTotal","couponDiscount","volumeDiscount","preferredDiscount","dreamRewardsDiscount","sessionDiscount","pointsDiscount","membershipDiscount","customization_fee","paymentsTotal","credit_card_food_total","round_up_donation","subtotal_round_up","Math","ceil","subtotal_round_up_diff","parseFloat","toFixed","hasEnoughNonCCFunds","isEditOrder","show","cost_per_serving","avgCostPerServingEntreeServings","handleCardRefChange","is_discounts_page","addClass","removeClass","remove_item_payment","settings","item","remove_food","removeAllStoreCredit","remove_payment_coupon","remove_payment","remove_gift_card_purchase","remove_dinner_dollars","remove_credit_card_reference","runAsGuest","allowGuest","rewardsCreditClick","obj","checked","add_all_store_credit","gcoid","item_number","page","is_edit_order","location","reload","couponAmount","toUpperCase","coupon","limit_to_mfy_fee","update_special_instructions","special_inst","update_bag_opt_out","opt_out","supports_bag_fee","default_bag_fee","number_bags_required","bagLabel","cbagLabel","add_payment_coupon","add_coupon_code","coupon_code","edit_order_diff","balance","originalOrderInfo","coupon_title","dd_val","valueOf","calculateMaxNewGiftCardPayment","newPaymentNumber","grandtotal","existingPaymentTotal","PaymentNumber","PaymentAmount","get_gift_card_balance","gc_number","trim","card_number","output","card_balance","getGiftCardNumberAndAmount","returnData","dataValid","gc_amount","is_update","didHandleDuplicate","replacementObj","do_add_gift_card","cancel","transaction_data","is_processing","replacingID","id","split","maxNewPayment","toString","amount","c_total","current_subtotal","original_order_total","payment_id","edit_order_html","replaceWith","add_payment_gift_card","getDomObjectToRemove","get","store_id","store_id_of_order","domObjectToRemove","payment_number","empty","handleNewCardFormShown","disabled","required","requireCreditCardFields","handleNewCardFormHidden","parents","doNotRequireCreditCardFields","handleOrderCustomizations","form","requiredOptionSelected","setTimeout","console","log","selectedRef","cc_ref_id","numRefs","add_payment_credit_card","elementsToCheck","_check_elements","doDelayedPayment","name_on_card","exp_month","exp_year","security_code","card_type","billing_zip","billing_addr","do_delayed_payment","cart_subtotal","default_meal_customization_to_selected","initMealCustomizationFields","canContinue","preventDefault","min","max","maxlength","pattern","validateCreditCard","result","validatorType","name","currentTypeWidgetValue","accept","multiple","undefined","which","prev_id","valCheckDiffRemove","addy","JSON","parse","address","status","Cancel","delivered_zip","postal_code","Close","location_type","valCheckDiff","firstname","group","lastname","address_line1","address_line2","city","state_id","address_note","telephone_1","email_address","diffData","checkdiff","Object","keys","href","bounce","handleMealCustomizationAccordion","checkbox","getElementById","$header","$content","slideToggle","has_meal_customization_selected","toggleMealCustomizationOptions","removeAttr","toggleMealCustomizationMasterCheckbox","handleMealCustomizationMasterCheckbox","allow_customization","customizations","stringify","meal_customization_preferences","customization","opted_to_customize_recipes","cost","preferenceChangeListener","pref","setting","user_id","callback","includes","pref_value","isPlainObject","extend","addEventListener"],"sourceRoot":"js/src/dreamdinners/customer","sources":["checkout.js"],"sourcesContent":["cart_subtotal = 0;\r\n\r\nfunction handle_ltd_round_up()\r\n{\r\n\t$(document).on('change', '#add_ltd_round_up', function (e) {\r\n\r\n\t\tif ($(this).is(':checked'))\r\n\t\t{\r\n\t\t\t$('#ltd_round_up_select').prop('disabled', false);\r\n\r\n\t\t\tif (USER_PREFERENCES.LTD_AUTO_ROUND_UP.value == '' && (!$.cookie('ltdru') || $.cookie('ltdru') != session_id))\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'My Preferences',\r\n\t\t\t\t\tmessage: 'Would you like to automatically round up every time you order? You can edit this setting any time in <span class=\"font-weight-bold\">My Preferences</span>.<div class=\"text-center; mt-1\"><select id=\"ltd-round_up_opt_in\"><option>Select a Round Up value</option><option value=\"1\">Nearest Dollar</option><option value=\"2\">2 Dollars</option><option value=\"5\">5 Dollars</option><option value=\"10\">10 Dollars</option><option value=\"35\">35 Dollars</option><option value=\"54\">54 Dollars</option></select></div>',\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\topen: function (event, ui) {\r\n\t\t\t\t\t\t$(this).parent().find('.ui-dialog-titlebar-close').hide();\r\n\r\n\t\t\t\t\t\tvar rup_dialog = $(this);\r\n\r\n\t\t\t\t\t\t$('#ltd-round_up_opt_in').on('change', function (e) {\r\n\r\n\t\t\t\t\t\t\tvar rup_value = $(this).val();\r\n\r\n\t\t\t\t\t\t\tif (rup_value > 0)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\t\tdiv_id: 'rup_confirm',\r\n\t\t\t\t\t\t\t\t\ttitle: 'My Preferences',\r\n\t\t\t\t\t\t\t\t\tmessage: 'You have chosen to set your auto Round Up to ' + ((rup_value == 1) ? 'the nearest dollar.' : '$' + rup_value),\r\n\t\t\t\t\t\t\t\t\tconfirm: function () {\r\n\t\t\t\t\t\t\t\t\t\t$(rup_dialog).remove();\r\n\r\n\t\t\t\t\t\t\t\t\t\tset_user_pref('LTD_AUTO_ROUND_UP', rup_value);\r\n\r\n\t\t\t\t\t\t\t\t\t\tif (ltd_round_up_value == 0 && rup_value != 1 || ($('#ltd_round_up_select option:selected').index() == 0 && !$.cookie('ltdru')))\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\t\t\t\t\ttitle: 'My Preferences',\r\n\t\t\t\t\t\t\t\t\t\t\t\tmessage: 'Preference saved. Would you like to use your selected Round Up value on this order? This can be reviewed and edited.',\r\n\t\t\t\t\t\t\t\t\t\t\t\tmodal: true,\r\n\t\t\t\t\t\t\t\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\t\t\t\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\t\t\t\t\t\t\t\topen: function (event, ui) {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$(this).parent().find('.ui-dialog-titlebar-close').hide();\r\n\t\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"Yes\": function () {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (rup_value == 1)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$('#ltd_round_up_select option:eq(0)').prop('selected', true).trigger('change');\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$('#ltd_round_up_select').val(rup_value).trigger('change');\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"No\": function () {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"No\": function () {\r\n\t\t\t\t\t\t\tset_user_pref('LTD_AUTO_ROUND_UP', 0);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"Ask Again Later\": function () {\r\n\t\t\t\t\t\t\t$.cookie('ltdru', session_id);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#ltd_round_up_select').prop('disabled', true);\r\n\t\t}\r\n\r\n\t\t$('#ltd_round_up_select').trigger('change');\r\n\r\n\t});\r\n\r\n\t$('#ltd_round_up_select').on('change', function (e) {\r\n\r\n\t\tvar round_up_val = $(this).val();\r\n\r\n\t\tif (round_up_val != null)\r\n\t\t{\r\n\t\t\t$('#checkout_total-roundup_donation').text(formatAsMoney(round_up_val));\r\n\r\n\t\t\tif ($('#add_ltd_round_up').is(':checked'))\r\n\t\t\t{\r\n\t\t\t\t$('#ltd_round_up_div').slideDown();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#ltd_round_up_div').slideUp();\r\n\r\n\t\t\t\tround_up_val = 0;\r\n\t\t\t}\r\n\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'cart_add_payment',\r\n\t\t\t\t\tpayment_type: 'ltd_round_up',\r\n\t\t\t\t\tltd_round_up_value: round_up_val\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\t//\tconsole.log('OM Intense logging: ' + message);\r\n\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tupdateFinancials();\r\n\t});\r\n\r\n\tif (!$('#add_ltd_round_up').is(':checked') && USER_PREFERENCES.LTD_AUTO_ROUND_UP.value > 0 && ltd_round_up_value == null)\r\n\t{\r\n\t\t$('#add_ltd_round_up').prop('checked', true);\r\n\r\n\t\tif (USER_PREFERENCES.LTD_AUTO_ROUND_UP.value > 1)\r\n\t\t{\r\n\t\t\t$('#ltd_round_up_select').val(USER_PREFERENCES.LTD_AUTO_ROUND_UP.value).prop('disabled', false).trigger('change');\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#ltd_round_up_select option:first-child').attr('selected', true);\r\n\t\t\t$('#ltd_round_up_select').prop('disabled', false).trigger('change');\r\n\r\n\t\t}\r\n\t}\r\n\telse if ($('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\t$('#ltd_round_up_select').prop('disabled', false).trigger('change');\r\n\t}\r\n}\r\n\r\nfunction handle_checkout_delayed_payment()\r\n{\r\n\tif (USER_PREFERENCES)\r\n\t{\r\n\t\tget_user_pref('TC_DELAYED_PAYMENT_AGREE', null, function (json) {\r\n\r\n\t\t\tif (json.user_preferences['TC_DELAYED_PAYMENT_AGREE'].value == 1 || json.user_preferences['TC_DELAYED_PAYMENT_AGREE'].value == '1')\r\n\t\t\t{\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t$('#is_store_specific_flat_rate_delayed_payment1, #is_flat_rate_delayed_payment1, #is_delayed_payment1').on('click', function (e) {\r\n\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\t\t\tmessage: lang.en.tc.delayed_payment,\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\topen: function (event, ui) {\r\n\t\t\t\t\t\t$(this).parent().find('.ui-dialog-titlebar-close').hide();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"Agree\": function () {\r\n\r\n\t\t\t\t\t\t\t$('#is_store_specific_flat_rate_delayed_payment1, #is_flat_rate_delayed_payment1, #is_delayed_payment1').unbind(\"click\");\r\n\r\n\t\t\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 1);\r\n\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"Decline\": function () {\r\n\r\n\t\t\t\t\t\t\t$('#is_store_specific_flat_rate_delayed_payment0, #is_flat_rate_delayed_payment0, #is_delayed_payment0').click();\r\n\r\n\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\t\t\t\t\t\tmessage: lang.en.tc.delayed_payment_decline\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 0);\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t});\r\n\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction handle_special_instructions()\r\n{\r\n\t$(document).on('keyup', '#special_insts', function (e) {\r\n\r\n\t\tif ($(this).val() != strip_tags($(this).val()))\r\n\t\t{\r\n\t\t\t$(this).val(strip_tags($(this).val()));\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction submit_gift_card_purchase()\r\n{\r\n\tvar field = $('<input></input>');\r\n\tfield.attr(\"type\", \"hidden\");\r\n\tfield.attr(\"name\", \"checkout_submit\");\r\n\tfield.attr(\"value\", \"true\");\r\n\t$(\"#gift_card_checkout\").append(field);\r\n\r\n\t$(\"#gift_card_checkout\").submit();\r\n}\r\n\r\n\r\nfunction submit_order()\r\n{\r\n\tcreate_and_submit_form({\r\n\t\taction: 'main.php?page=checkout',\r\n\t\tinput: ({\r\n\t\t\tspecial_insts: $('#special_insts').val(),\r\n\t\t\tcustomers_terms: $('#customers_terms').val()\r\n\t\t})\r\n\t});\r\n}\r\n\r\nfunction handlePlatePointsDiscount(val)\r\n{\r\n\tinVal = val;\r\n\r\n\tif ((isNaN(val) || val <= 0) && val != \".\")\r\n\t{\r\n\t\tval = 0;\r\n\t}\r\n\r\n\tvar cap = maxPPCredit;\r\n\tif (cap > maxPPDeduction)\r\n\t{\r\n\t\tcap = maxPPDeduction;\r\n\t}\r\n\r\n\tif (val > cap)\r\n\t{\r\n\t\tval = cap;\r\n\t}\r\n\r\n\tif (val < 0)\r\n\t{\r\n\t\tval = 0;\r\n\t}\r\n\r\n\tif (val != inVal || isNaN(inVal) || inVal == \"\")\r\n\t{\r\n\t\t$('#plate_points_discount').val(val);\r\n\t}\r\n\r\n}\r\n\r\nfunction editSaveAllPlatePointsCredits()\r\n{\r\n\t$('#plate_points_discount').val(formatAsMoney(maxPPDeduction));\r\n\teditSavePlatePointsCredits(false);\r\n}\r\n\r\n\r\n\r\n\r\nfunction editSavePlatePointsCredits(force)\r\n{\r\n\tif (force)\r\n\t{\r\n\t\t$(\"#max_plate_points_deduction\").html(maxPPDeduction);\r\n\t}\r\n\r\n\tvar val = $('#plate_points_discount').val();\r\n\r\n\tif (typeof val !== 'undefined')\r\n\t{\r\n\t\tvar cap = maxPPCredit;\r\n\t\tif (cap > maxPPDeduction)\r\n\t\t{\r\n\t\t\tcap = maxPPDeduction;\r\n\t\t}\r\n\r\n\t\tif (val > cap)\r\n\t\t{\r\n\t\t\tval = cap;\r\n\t\t}\r\n\r\n\t\tif (val < 0)\r\n\t\t{\r\n\t\t\tval = 0;\r\n\t\t}\r\n\r\n\t\t$('#plate_points_discount').val(formatAsMoney(val));\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'cart_modify_plate_points_credits',\r\n\t\t\t\top: 'modify',\r\n\t\t\t\tnew_credit_value: val\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t// update subtotal\r\n\t\t\t\t\t$('#sum_checkout_total-subtotal').html(formatAsMoney(json.orderInfo.grand_total));\r\n\r\n\t\t\t\t\t$('#checkout_total-tax').html(formatAsMoney(json.orderInfo.subtotal_all_taxes));\r\n\r\n\t\t\t\t\tif (val > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$('#row-discount_plate_points').showFlex();\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$('#row-discount_plate_points').hideFlex();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// update coupon total\r\n\t\t\t\t\t$('#checkout_total-coupon').html(formatAsMoney(json.orderInfo.coupon_code_discount_total));\r\n\r\n\t\t\t\t\tavgCostPerServingEntreeCost -= json.orderInfo.coupon_code_discount_total;\r\n\r\n\t\t\t\t\t$(\"#checkout_total-points_discount_total\").html(formatAsMoney(json.orderInfo.points_discount_total));\r\n\t\t\t\t\t$(\"#checkout_total-membership_discount\").html(formatAsMoney(json.orderInfo.membership_discount));\r\n\r\n\r\n\r\n\t\t\t\t\t// calculate the balance\r\n\t\t\t\t\tcan_checkout();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nfunction run_as_guest()\r\n{\r\n\tcreate_and_submit_form({\r\n\t\taction: 'main.php?page=checkout',\r\n\t\tinput: ({\r\n\t\t\trun_as_guest: \"true\"\r\n\t\t})\r\n\t});\r\n}\r\n\r\nfunction updateFinancials()\r\n{\r\n\tvar foodCost = 0;\r\n\tvar bag_fee = 0;\r\n\r\n\tif ($('#checkout_total-food').length)\r\n\t{\r\n\t\tfoodCost = Number($('#checkout_total-food').html());\r\n\t}\r\n\r\n\tvar giftCardCost = 0;\r\n\t$('[id^=\"checkout_total-giftcard_purchase\"]').each(function () {\r\n\t\tvar thisCost = Number($(this).html());\r\n\t\tgiftCardCost += thisCost;\r\n\t});\r\n\r\n\tvar service_fee = 0;\r\n\tif ($('#checkout_total-service_fee').length)\r\n\t{\r\n\t\tservice_fee = Number($('#checkout_total-service_fee').html());\r\n\t}\r\n\r\n\tvar delivery_fee = 0;\r\n\tif ($('#checkout_total-delivery_fee').length)\r\n\t{\r\n\t\tdelivery_fee = Number($('#checkout_total-delivery_fee').html());\r\n\t}\r\n\r\n\r\n\tvar totalTax = 0;\r\n\tif ($('#checkout_total-tax').length)\r\n\t{\r\n\t\ttotalTax = Number($('#checkout_total-tax').html());\r\n\t}\r\n\r\n\tvar prediscountFoodTotal = foodCost;\r\n\r\n\t// Note: coupon code and points discount are the only discounts that can affect price\r\n\t// without a page refresh. If there is a change we need to recalculate tax\r\n\tvar couponDiscount = 0;\r\n\tif ($('#checkout_total-coupon').length)\r\n\t{\r\n\t\tcouponDiscount = Number($('#checkout_total-coupon').html());\r\n\t}\r\n\r\n\tvar volumeDiscount = 0;\r\n\tif ($('#checkout_total-volume_discount').length)\r\n\t{\r\n\t\tvolumeDiscount = Number($('#checkout_total-volume_discount').html());\r\n\t}\r\n\r\n\tvar preferredDiscount = 0;\r\n\tif ($('#checkout_total-preferred_discount').length)\r\n\t{\r\n\t\tpreferredDiscount = Number($('#checkout_total-preferred_discount').html());\r\n\t}\r\n\r\n\tvar dreamRewardsDiscount = 0;\r\n\tif ($('#checkout_total-dream_rewards_discount').length)\r\n\t{\r\n\t\tdreamRewardsDiscount = Number($('#checkout_total-dream_rewards_discount').html());\r\n\t}\r\n\r\n\tvar sessionDiscount = 0;\r\n\tif ($('#checkout_total-session_discount_total').length)\r\n\t{\r\n\t\tsessionDiscount = Number($('#checkout_total-session_discount_total').html());\r\n\t}\r\n\r\n\tvar pointsDiscount = 0;\r\n\tif ($('#checkout_total-points_discount_total').length)\r\n\t{\r\n\t\tpointsDiscount = Number($('#checkout_total-points_discount_total').html());\r\n\t}\r\n\r\n\tvar membershipDiscount = 0;\r\n\tif ($('#checkout_total-membership_discount').length)\r\n\t{\r\n\t\tmembershipDiscount = Number($('#checkout_total-membership_discount').html());\r\n\t}\r\n\r\n\tvar bag_fee = 0;\r\n\tif ($('#checkout_total-bag_fee').length)\r\n\t{\r\n\t\tbag_fee = Number($('#checkout_total-bag_fee').html());\r\n\t}\r\n\r\n\tvar customization_fee = 0;\r\n\tif ($('#checkout_total-customization_fee').length)\r\n\t{\r\n\t\tcustomization_fee = Number($('#checkout_total-customization_fee').html());\r\n\t}\r\n\r\n\tvar foodCost = prediscountFoodTotal - (couponDiscount + preferredDiscount + volumeDiscount + dreamRewardsDiscount + sessionDiscount + pointsDiscount + membershipDiscount);\r\n\tvar grand_total = Number(formatAsMoney(foodCost + giftCardCost + service_fee + delivery_fee + bag_fee + totalTax + customization_fee));\r\n\r\n\t$('#sum_checkout_total-subtotal').html(formatAsMoney(grand_total));\r\n\r\n\tvar paymentsTotal = 0;\r\n\t$('[id^=\"checkout_total_payment-\"]').each(function () {\r\n\r\n\t\tif ($(this).is(':visible'))\r\n\t\t{\r\n\t\t\tpaymentsTotal += Number($(this).html());\r\n\t\t}\r\n\t});\r\n\r\n\tif (paymentsTotal > foodCost + service_fee + delivery_fee + bag_fee + totalTax)\r\n\t{\r\n\t\t//more store credit than food cost so we must cap the store credit that can be used\r\n\t\tpaymentsTotal = foodCost + service_fee + delivery_fee+ bag_fee + totalTax;\r\n\t\t$('[id^=\"checkout_total_payment-credits\"]').html(formatAsMoney(paymentsTotal));\r\n\t}\r\n\r\n\tif (giftCardCost > 0)\r\n\t{\r\n\t\t//\t$('[id^=\"gc_checkout_total_adj_payment-creditcard-\"]').html(formatAsMoney(giftCardCost ));\r\n\t}\r\n\r\n\tvar credit_card_food_total = grand_total - paymentsTotal - giftCardCost;\r\n\r\n\tvar round_up_donation = 0;\r\n\r\n\tvar subtotal_round_up = Math.ceil(credit_card_food_total + giftCardCost);\r\n\tvar subtotal_round_up_diff = parseFloat((subtotal_round_up - (credit_card_food_total + giftCardCost)).toFixed(2));\r\n\r\n\tif (subtotal_round_up_diff == 0)\r\n\t{\r\n\t\tsubtotal_round_up_diff = 1.00;\r\n\t}\r\n\r\n\tif ($('#round_up_nearest_dollar').val() != subtotal_round_up_diff)\r\n\t{\r\n\t\t$('#round_up_nearest_dollar').val(subtotal_round_up_diff).text('$ ' + formatAsMoney(subtotal_round_up_diff));\r\n\t\t$('#add_ltd_round_up').trigger('change');\r\n\t}\r\n\r\n\tif ($('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\tif ($('#ltd_round_up_select').find(':selected').attr('id') == 'round_up_nearest_dollar')\r\n\t\t{\r\n\t\t\tround_up_donation = subtotal_round_up_diff;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tround_up_donation = parseFloat($('#ltd_round_up_select').val());\r\n\t\t}\r\n\t}\r\n\r\n\t$('[id^=\"credit_card_amount\"]').html(formatAsMoney(credit_card_food_total + giftCardCost + round_up_donation));\r\n\t$('#debit_credit_card_amount').html(formatAsMoney(credit_card_food_total + giftCardCost + round_up_donation));\r\n\r\n\tvar hasEnoughNonCCFunds = false;\r\n\r\n\tvar isEditOrder = false;\r\n\tif ($('#isEditDeliveredOrder').length)\r\n\t{\r\n\t\tisEditOrder = true;\r\n\t}\r\n\r\n\r\n\tif( isEditOrder ){\r\n\t\tcredit_card_food_total = $('#cc_amount_diff').html();\r\n\r\n\t}\r\n\r\n\tif (credit_card_food_total == 0 && giftCardCost == 0)\r\n\t{\r\n\t\t$('[id^=\"cc\"]').prop('disabled', true);\r\n\t\t$('#billing_postal_code').prop('disabled', true);\r\n\t\t$('#billing_address').prop('disabled', true);\r\n\t\t$('#addCreditCard').prop('disabled', true);\r\n\t\t$('#save_cc_as_ref').prop('disabled', true);\r\n\r\n\t\tif ($('#is_store_specific_flat_rate_delayed_payment1').length)\r\n\t\t{\r\n\t\t\t$('#is_store_specific_flat_rate_delayed_payment1').prop('disabled', true);\r\n\t\t\t$('#is_store_specific_flat_rate_delayed_payment0').prop('disabled', true);\r\n\t\t}\r\n\r\n\t\t$('#enough_funds_alert').show();\r\n\r\n\t\thasEnoughNonCCFunds = true;\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('[id^=\"cc\"]').prop('disabled', false);\r\n\t\t$('#billing_postal_code').prop('disabled', false);\r\n\t\t$('#billing_address').prop('disabled', false);\r\n\t\t$('#addCreditCard').prop('disabled', false);\r\n\t\t$('#save_cc_as_ref').prop('disabled', false);\r\n\r\n\t\tif ($('#is_store_specific_flat_rate_delayed_payment1').length)\r\n\t\t{\r\n\t\t\t$('#is_store_specific_flat_rate_delayed_payment1').prop('disabled', false);\r\n\t\t\t$('#is_store_specific_flat_rate_delayed_payment0').prop('disabled', false);\r\n\t\t}\r\n\r\n\t\t$('#enough_funds_alert').hide();\r\n\t}\r\n\r\n\t//$('#debit_credit_card_amount').html(formatAsMoney(credit_card_food_total + giftCardCost));\r\n\r\n\tvar cost_per_serving = formatAsMoney(avgCostPerServingEntreeCost / avgCostPerServingEntreeServings);\r\n\r\n\t$('#checkout-cost_per_serving').html(cost_per_serving);\r\n\r\n\t$('#sum_checkout_total-balance').html(formatAsMoney(0));\r\n\r\n\treturn hasEnoughNonCCFunds;\r\n}\r\n\r\nfunction can_checkout()\r\n{\r\n\thandleCardRefChange();\r\n\r\n\tvar hasEnoughNonCCFunds = updateFinancials();\r\n\r\n\tif (is_discounts_page)\r\n\t{\r\n\t\tif (hasEnoughNonCCFunds)\r\n\t\t{\r\n\t\t\t$('#checkoutOption').addClass('show');\r\n\t\t\t$('#toPaymentOption').removeClass('show');\r\n\r\n\t\t\t// if balance is 0 and terms and conditions have been checked, enable checkout\r\n\t\t\tif ($('#customers_terms').is(':checked'))\r\n\t\t\t{\r\n\t\t\t\t$('#complete_order').attr('disabled', false);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#complete_order').attr('disabled', true);\r\n\t\t\t}\r\n\r\n\t\t\t$('#customers_terms').attr('required', 'required');\r\n\t\t\t$(\"#to_payment_or_checkout_form\").prop(\"action\", '/main.php?page=checkout');\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#checkoutOption').removeClass('show');\r\n\t\t\t$('#toPaymentOption').addClass('show');\r\n\r\n\t\t\t$(\"#to_payment\").attr('disabled', false);\r\n\r\n\t\t\t$('#customers_terms').attr('required', false);\r\n\t\t\t$(\"#to_payment_or_checkout_form\").prop(\"action\", '/main.php?page=payment');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\t\t// if balance is 0 and terms and conditions have been checked, enable checkout\r\n\t\tif ($('#customers_terms').is(':checked'))\r\n\t\t{\r\n\t\t\t$('#complete_order').attr('disabled', false);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#complete_order').attr('disabled', true);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction remove_item_payment(settings)\r\n{\r\n\tif (settings.item == 'food')\r\n\t{\r\n\t\tremove_food();\r\n\t}\r\n\r\n\tif (settings.item == 'nonfood')\r\n\t{\r\n\t\t// remove_item_nonfood(settings);\r\n\t}\r\n\r\n\tif (settings.item == 'credits')\r\n\t{\r\n\t\tremoveAllStoreCredit(settings);\r\n\t}\r\n\r\n\tif (settings.item == 'coupon')\r\n\t{\r\n\t\tremove_payment_coupon();\r\n\t}\r\n\r\n\tif (settings.item == 'giftcard')\r\n\t{\r\n\t\tremove_payment(settings);\r\n\t}\r\n\r\n\tif (settings.item == 'giftcard_purchase')\r\n\t{\r\n\t\tremove_gift_card_purchase(settings);\r\n\t}\r\n\r\n\tif (settings.item == 'creditcard')\r\n\t{\r\n\t\tremove_payment(settings);\r\n\t}\r\n\r\n\tif (settings.item == 'dinner_dollars')\r\n\t{\r\n\t\tremove_dinner_dollars(settings);\r\n\t}\r\n\r\n\tif (settings.item == 'cc_ref')\r\n\t{\r\n\t\tremove_credit_card_reference(settings);\r\n\t}\r\n\r\n\r\n\tcan_checkout();\r\n}\r\n\r\nfunction remove_food()\r\n{\r\n\tvar runAsGuest = \"false\";\r\n\r\n\tif (allowGuest)\r\n\t{\r\n\t\trunAsGuest = \"true\";\r\n\t}\r\n\r\n\tcreate_and_submit_form({\r\n\t\taction: 'main.php?page=checkout',\r\n\t\tinput: ({\r\n\t\t\tremove: \"food\",\r\n\t\t\trun_as_guest: runAsGuest\r\n\r\n\t\t})\r\n\t});\r\n}\r\n\r\nfunction rewardsCreditClick(obj)\r\n{\r\n\tif (obj.checked)\r\n\t{\r\n\t\tadd_all_store_credit();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar settings = {\r\n\t\t\titem: \"credits\"\r\n\t\t};\r\n\r\n\t\tremoveAllStoreCredit(settings);\r\n\t}\r\n\r\n\tcan_checkout();\r\n}\r\n\r\nfunction remove_gift_card_purchase(settings)\r\n{\r\n\tvar runAsGuest = \"false\";\r\n\r\n\tif (allowGuest)\r\n\t{\r\n\t\trunAsGuest = \"true\";\r\n\t}\r\n\r\n\tcreate_and_submit_form({\r\n\t\taction: 'main.php?page=checkout_gift_card',\r\n\t\tinput: ({\r\n\t\t\tremove: \"gift_card_purchase\",\r\n\t\t\tgcoid: settings.item_number,\r\n\t\t\trun_as_guest: runAsGuest\r\n\t\t})\r\n\t});\r\n}\r\n\r\n\r\nfunction remove_dinner_dollars()\r\n{\r\n\r\n\t$('#plate_points_discount').val(formatAsMoney(0));\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_modify_plate_points_credits',\r\n\t\t\top: 'modify',\r\n\t\t\tnew_credit_value: 0\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\t// update subtotal\r\n\t\t\t\t$('#sum_checkout_total-subtotal').html(formatAsMoney(json.orderInfo.grand_total));\r\n\r\n\t\t\t\t$('#checkout_total-tax').html(formatAsMoney(json.orderInfo.subtotal_all_taxes));\r\n\r\n\t\t\t\t$('#row-discount_plate_points').hideFlex();\r\n\r\n\t\t\t\t// update coupon total\r\n\t\t\t\t$('#checkout_total-coupon').html(formatAsMoney(json.orderInfo.coupon_code_discount_total));\r\n\r\n\t\t\t\tavgCostPerServingEntreeCost -= json.orderInfo.coupon_code_discount_total;\r\n\r\n\t\t\t\t$(\"#checkout_total-points_discount_total\").html(formatAsMoney(json.orderInfo.points_discount_total));\r\n\t\t\t\t$(\"#checkout_total-membership_discount\").html(formatAsMoney(json.orderInfo.membership_discount));\r\n\r\n\t\t\t\t// calculate the balance\r\n\t\t\t\tcan_checkout();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\n\r\n\r\nfunction remove_payment_coupon()\r\n{\r\n\r\n\tvar service_fee = Number($('#checkout_total-service_fee').html());\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_remove_payment',\r\n\t\t\tpayment_type: 'coupon',\r\n\t\t\tpage: 'checkout'\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t// restore coupon input\r\n\t\t\t\t$('#add_coupon_code').prop('disabled', false);\r\n\t\t\t\t$('#add_coupon_add').prop('disabled', false);\r\n\t\t\t\t$('#checkout_total-tax').html(json.orderInfo.subtotal_all_taxes);\r\n\r\n\t\t\t\t// update coupon total\r\n\t\t\t\t$('#checkout_title-coupon_code').html('');\r\n\r\n\t\t\t\tif( json.is_edit_order !== 'undefined' && json.is_edit_order == true ) {\r\n\t\t\t\t\tlocation.reload();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar couponAmount = Number($('#checkout_total-coupon').html());\r\n\r\n\t\t\t\tavgCostPerServingEntreeCost += couponAmount;\r\n\r\n\t\t\t\t// update coupon total\r\n\t\t\t\t$('#checkout_total-coupon').html('0.00');\r\n\r\n\t\t\t\t// hide coupon row\r\n\t\t\t\t$('#row-coupon').slideUp();\r\n\r\n\t\t\t\tvar couponCodeVal = $('#add_coupon_code').val().toUpperCase();\r\n\r\n\t\t\t\tif (coupon.limit_to_mfy_fee == '1')\r\n\t\t\t\t{\r\n\t\t\t\t\tmaxPPDeduction += service_fee;\r\n\t\t\t\t\teditSavePlatePointsCredits(true);\r\n\r\n\t\t\t\t\tif (maxPPCredit > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(\"#edit_plate_points\").attr(\"disabled\", false);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcoupon = false;\r\n\r\n\t\t\t\t// can we checkout?\r\n\t\t\t\tcan_checkout();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction update_special_instructions()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_item_processor',\r\n\t\t\top: 'store_inst',\r\n\t\t\tspecial_inst: $('#special_insts').val()\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t// nothing to do\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction update_bag_opt_out()\r\n{\r\n\r\n\tlet opt_out = 0;\r\n\tif (supports_bag_fee)\r\n\t{\r\n\t\tif ($(\"#opted_to_bring_bags\").is(\":checked\"))\r\n\t\t{\r\n\t\t\topt_out = 1;\r\n\t\t}\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_bag_fee',\r\n\t\t\top: 'set_opt_out',\r\n\t\t\topt_out: opt_out,\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t// update subtotal\r\n\t\t\t\t$('#sum_checkout_total-subtotal').html(formatAsMoney(json.orderInfo.grand_total));\r\n\t\t\t\t$('#checkout_total-tax').html(formatAsMoney(json.orderInfo.subtotal_all_taxes));\r\n\r\n\t\t\t\tif ($(\"#opted_to_bring_bags\").is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#checkout_total-bag_fee_info\").html(\"(You will provide bags)\");\r\n\t\t\t\t\t$(\"#checkout_total-bag_fee\").html(formatAsMoney(0));\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbag_fee = default_bag_fee * number_bags_required;\r\n\t\t\t\t\tlet bagLabel = number_bags_required > 1 ? ' bags' :' bag';\r\n\t\t\t\t\tlet cbagLabel = number_bags_required > 1 ? ' Bags' :' Bag';\r\n\r\n\t\t\t\t\t$(\"#checkout_total-bag_fee_info\").html('(' +number_bags_required +bagLabel+\" * $\" + formatAsMoney(default_bag_fee) + ')');\r\n\t\t\t\t\t$(\"#checkout_total-bag_fee\").html(formatAsMoney(bag_fee));\r\n\t\t\t\t\t$(\"#bag_text\").html(number_bags_required + cbagLabel);\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// calculate the balance\r\n\t\t\t\tcan_checkout();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\n\r\nfunction add_payment_coupon()\r\n{\r\n\tvar add_coupon_code = $('#add_coupon_code').val().toUpperCase();\r\n\tvar service_fee = Number($('#checkout_total-service_fee').html());\r\n\r\n\tif (!add_coupon_code)\r\n\t{\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please enter a promo code.'\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'cart_add_payment',\r\n\t\t\t\tpayment_type: 'coupon',\r\n\t\t\t\tpage: 'checkout',\r\n\t\t\t\tcoupon_code: add_coupon_code,\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tcoupon = json.coupon;\r\n\r\n\t\t\t\t\t// disable input form\r\n\t\t\t\t\t$('#add_coupon_code').prop('disabled', true);\r\n\t\t\t\t\t$('#add_coupon_add').prop('disabled', true);\r\n\r\n\t\t\t\t\t// update subtotal\r\n\t\t\t\t\t$('#sum_checkout_total-subtotal').html(json.orderInfo.grand_total);\r\n\r\n\t\t\t\t\tif(typeof json.edit_order_diff !== 'undefined'){\r\n\t\t\t\t\t\t$('#cc_amount_diff').html(json.balance);\r\n\t\t\t\t\t\t$('#original_order_total').html(json.originalOrderInfo.grand_total);\r\n\t\t\t\t\t\t$('.edit-order-field').removeClass( \"collapse\" );\r\n\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t\t$('#checkout_total-tax').html(json.orderInfo.subtotal_all_taxes);\r\n\r\n\t\t\t\t\t// update coupon total\r\n\t\t\t\t\t$('#checkout_title-coupon_code').html(json.coupon_title);\r\n\r\n\t\t\t\t\t// update coupon total\r\n\t\t\t\t\t$('#checkout_total-coupon').html(formatAsMoney(json.orderInfo.coupon_code_discount_total));\r\n\r\n\t\t\t\t\tavgCostPerServingEntreeCost -= json.orderInfo.coupon_code_discount_total;\r\n\r\n\t\t\t\t\t// show coupon row\r\n\t\t\t\t\t$('#row-coupon').showFlex();\r\n\r\n\t\t\t\t\tif (coupon.limit_to_mfy_fee == '1' && maxPPDeduction > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar dd_val = $('#plate_points_discount').val();\r\n\t\t\t\t\t\tif (maxPPDeduction >= service_fee && maxPPDeduction - dd_val < service_fee)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\tmessage: 'The Service fee is already discounted by using Dinner Dollars. If you wish to use this coupon please lower the amount of Dinner Dollars applied.'\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\tremove_payment_coupon();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar service_fee = Number($('#checkout_total-service_fee').html());\r\n\r\n\t\t\t\t\t\t\tmaxPPDeduction = maxPPDeduction - service_fee.valueOf();\r\n\t\t\t\t\t\t\tif (maxPPDeduction < 0)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tmaxPPDeduction = 0;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tmaxPPDeduction = formatAsMoney(maxPPDeduction);\r\n\t\t\t\t\t\t\teditSavePlatePointsCredits(true);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// calculate the balance\r\n\t\t\t\t\tcan_checkout();\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction calculateMaxNewGiftCardPayment(newPaymentNumber)\r\n{\r\n\tvar grandtotal = Number($('#sum_checkout_total-subtotal').html());\r\n\tvar existingPaymentTotal = 0;\r\n\r\n\t$('[id^=\"row-giftcard-\"]').each(function () {\r\n\r\n\t\tvar PaymentNumber = $(this).data(\"gc_number\");\r\n\t\tvar PaymentAmount = $(this).data(\"gc_amount\");\r\n\r\n\t\tif (PaymentNumber != newPaymentNumber)\r\n\t\t{\r\n\t\t\texistingPaymentTotal += (Number(formatAsMoney(PaymentAmount)));\r\n\t\t}\r\n\t});\r\n\r\n\tif ($('#checkout_total_payment-credits').length)\r\n\t{\r\n\t\texistingPaymentTotal += (Number($('#checkout_total_payment-credits').html()).valueOf());\r\n\t}\r\n\r\n\tvar maxNewPayment = grandtotal.valueOf() - existingPaymentTotal;\r\n\r\n\treturn maxNewPayment;\r\n\r\n}\r\n\r\nfunction get_gift_card_balance()\r\n{\r\n\tvar gc_number = $('#debit_gift_card_number').val();\r\n\tgc_number = gc_number.trim();\r\n\r\n\tif (!gc_number)\r\n\t{\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please enter a gift card number.'\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'GET',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'giftCardBalance',\r\n\t\t\t\tcard_number: gc_number,\r\n\t\t\t\toutput: 'json'\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Gift Card Balance',\r\n\t\t\t\t\t\tmessage: \"Balance for card number <b>\" + json.card_number + \"</b> is <b>\" + json.card_balance + \"</b>\"\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Gift Card Balance Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction getGiftCardNumberAndAmount()\r\n{\r\n\tvar gc_number = $('#debit_gift_card_number').val();\r\n\tvar new_amount = $('#debit_gift_card_amount').val();\r\n\r\n\tvar returnData =\r\n\t\t{\r\n\t\t\tdataValid: true,\r\n\t\t\tgc_number: gc_number,\r\n\t\t\tgc_amount: new_amount,\r\n\t\t\tis_update: true\r\n\t\t};\r\n\r\n\tvar didHandleDuplicate = false;\r\n\r\n\t// check if this card number was added already\r\n\t// Note: this is not adequate for handling rapid clicking\r\n\t// Additional checks are done in do_add_gift_card\r\n\t$('#giftcard_container').find('[data-gc_number=\"' + gc_number + '\"]').each(function () {\r\n\r\n\t\tdidHandleDuplicate = true;\r\n\t\treturnData.replacementObj = this;\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Attention',\r\n\t\t\tmessage: 'You have already entered this gift card number. If you proceed the current amount will be replaced by the amount you are now submitting.',\r\n\t\t\tmodal: true,\r\n\t\t\tconfirm: function () {\r\n\t\t\t\tdo_add_gift_card(returnData);\r\n\t\t\t},\r\n\t\t\tcancel: function () {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\r\n\tif (!didHandleDuplicate)\r\n\t{\r\n\t\tdo_add_gift_card(returnData);\r\n\t}\r\n}\r\n\r\nfunction do_add_gift_card(transaction_data)\r\n{\r\n\r\n\tvar is_processing = $('#debit_gift_card_number').data('processing');\r\n\r\n\tif (!transaction_data || is_processing)\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\tif(transaction_data.gc_number){\r\n\t\ttransaction_data.gc_number = transaction_data.gc_number.trim();\r\n\t}\r\n\r\n\tif (!transaction_data.gc_number)\r\n\t{\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please enter a gift card number.'\r\n\t\t});\r\n\t}\r\n\telse if (!transaction_data.gc_amount)\r\n\t{\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please enter a gift card amount.'\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar replacingID = 0;\r\n\r\n\t\tif (transaction_data.replacementObj)\r\n\t\t{\r\n\t\t\treplacingID = transaction_data.replacementObj.id.split(\"-\")[2];\r\n\t\t}\r\n\r\n\t\t$('#debit_gift_card_number').data('processing', true);\r\n\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'GET',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'giftCardBalance',\r\n\t\t\t\tcard_number: transaction_data.gc_number,\r\n\t\t\t\toutput: 'json'\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (json.card_balance == \"Invalid Card\")\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\ttitle: 'Gift Card Error',\r\n\t\t\t\t\t\t\tmessage: 'The card number is invalid.'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if ((json.card_balance * 1) < (transaction_data.gc_amount * 1))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\ttitle: 'Gift Card Error',\r\n\t\t\t\t\t\t\tmessage: 'There are not enough funds on the gift card for this amount. Available balance: ' + json.card_balance\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar maxNewPayment = calculateMaxNewGiftCardPayment(transaction_data.gc_number);\r\n\t\t\t\t\t\tif (transaction_data.gc_amount > maxNewPayment)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttransaction_data.gc_amount = maxNewPayment.toString();\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\t\t\t\ttype: 'POST',\r\n\t\t\t\t\t\t\ttimeout: 20000,\r\n\t\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\tprocessor: 'cart_add_payment',\r\n\t\t\t\t\t\t\t\tpayment_type: 'gift_card',\r\n\t\t\t\t\t\t\t\tcard_number: transaction_data.gc_number,\r\n\t\t\t\t\t\t\t\tamount: transaction_data.gc_amount,\r\n\t\t\t\t\t\t\t\tc_total: $('#sum_checkout_total-subtotal').html(),\r\n\t\t\t\t\t\t\t\tcurrent_subtotal: $('#sum_checkout_total-subtotal').html(),\r\n\t\t\t\t\t\t\t\toriginal_order_total: $('#original_order_total').html(),\r\n\t\t\t\t\t\t\t\tpayment_id: replacingID,\r\n\t\t\t\t\t\t\t\toutput: 'json'\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t//var payment_id = json.payment_id;\r\n\t\t\t\t\t\t\t\t\tif (transaction_data.replacementObj)\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t$(transaction_data.replacementObj).remove();\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t$('#debit_gift_card_number').val('');\r\n\t\t\t\t\t\t\t\t\t$('#debit_gift_card_amount').val('');\r\n\r\n\t\t\t\t\t\t\t\t\t$('#giftcard_container').append(json.html);\r\n\r\n\t\t\t\t\t\t\t\t\t// show coupon row\r\n\t\t\t\t\t\t\t\t\t$('#giftcard_container').slideDown();\r\n\r\n\t\t\t\t\t\t\t\t\tif(typeof json.edit_order_html !== 'undefined' && json.edit_order_html != null){\r\n\t\t\t\t\t\t\t\t\t\t//location.reload();\r\n\t\t\t\t\t\t\t\t\t\t$('#edit-order-total-container').replaceWith(json.edit_order_html);\r\n\t\t\t\t\t\t\t\t\t}\r\n\r\n\r\n\t\t\t\t\t\t\t\t\t// calculate the balance\r\n\t\t\t\t\t\t\t\t\tcan_checkout();\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\t\t\ttitle: 'Gift Card Error',\r\n\t\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$('#debit_gift_card_number').data('processing', false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#debit_gift_card_number').data('processing', false);\r\n\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Gift Card Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\t\t$('#debit_gift_card_number').data('processing', false);\r\n\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction add_payment_gift_card()\r\n{\r\n\tgetGiftCardNumberAndAmount();\r\n}\r\n\r\nfunction getDomObjectToRemove(settings)\r\n{\r\n\tvar obj = null;\r\n\tif (settings.item == \"giftcard\")\r\n\t{\r\n\t\tobj = $('#row-giftcard-' + settings.item_number).get();\r\n\r\n\t\treturn obj;\r\n\t}\r\n\tif (settings.item == \"creditcard\")\r\n\t{\r\n\t\tobj = $('#row-creditcard-' + settings.item_number).get();\r\n\r\n\t\treturn obj;\r\n\t}\r\n\tif (settings.item == \"credits\")\r\n\t{\r\n\t\tobj = $('#row-credits').get();\r\n\r\n\t\treturn obj;\r\n\t}\r\n\tif (settings.item == \"cc_ref\")\r\n\t{\r\n\t\tobj = $('#row-cc_ref-' + settings.item_number).get();\r\n\t\treturn obj;\r\n\t}\r\n\r\n\treturn null;\r\n}\r\n\r\nfunction add_all_store_credit()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_add_payment',\r\n\t\t\tpayment_type: 'all_store_credit',\r\n\t\t\tstore_id: store_id_of_order,\r\n\t\t\toutput: 'json'\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$('#row-credits').html(json.html);\r\n\t\t\t\t$('#row-credits').slideDown();\r\n\r\n\t\t\t\t// calculate the balance\r\n\t\t\t\tcan_checkout();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Gift Card Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction removeAllStoreCredit(settings)\r\n{\r\n\tvar domObjectToRemove = getDomObjectToRemove(settings);\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_remove_payment',\r\n\t\t\tpayment_type: 'store_credit',\r\n\t\t\tpayment_number: 'all'\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$(domObjectToRemove).slideUp();\r\n\t\t\t\t$(domObjectToRemove).empty();\r\n\t\t\t\t$('#SC-total').prop(\"checked\", false);\r\n\r\n\t\t\t\tcan_checkout();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction remove_payment(settings)\r\n{\r\n\tvar domObjectToRemove = getDomObjectToRemove(settings);\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_remove_payment',\r\n\t\t\tpayment_type: settings.item,\r\n\t\t\tpayment_number: settings.item_number\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tif (settings.item == 'creditcard')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('[id^=\"cc\"]').prop('disabled', false);\r\n\t\t\t\t\t$('#billing_postal_code').prop('disabled', false);\r\n\t\t\t\t\t$('#billing_address').prop('disabled', false);\r\n\t\t\t\t\t$('#addCreditCard').prop('disabled', false);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ($('#is_delayed_payment1').length)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#is_delayed_payment1').prop('disabled', false);\r\n\t\t\t\t\t$('#is_delayed_payment0').prop('disabled', false);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(domObjectToRemove).slideUp();\r\n\r\n\t\t\t\tif (settings.item == 'creditcard' )\r\n\t\t\t\t{\r\n\t\t\t\t\t$(domObjectToRemove).remove();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (settings.item == 'giftcard')\r\n\t\t\t\t{\r\n\t\t\t\t\tlocation.reload();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcan_checkout();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction handleNewCardFormShown()\r\n{\r\n\t$('[id^=\"cc_pay_id\"]').prop({'disabled': true, 'checked' : false, 'required': false});\r\n\t$('[id^=\"gc_pay_id\"]').prop({'disabled': true, 'checked' : false, 'required': false});\r\n\r\n\r\n\trequireCreditCardFields();\r\n}\r\n\r\nfunction handleNewCardFormHidden()\r\n{\r\n\t$('[id^=\"cc_pay_id\"]').prop({'disabled': false, 'required': true}).parents('form:first').removeClass('was-validated').find('.form-feedback').hide();\r\n\t$('[id^=\"gc_pay_id\"]').prop({'disabled': false, 'required': true}).parents('form:first').removeClass('was-validated').find('.form-feedback').hide();\r\n\r\n\r\n\tdoNotRequireCreditCardFields();\r\n}\r\n\r\nfunction handleOrderCustomizations(form){\r\n\ttry\r\n\t{\r\n\t\tif (form.attr('id') == 'to_payment_or_checkout_form')\r\n\t\t{\r\n\t\t\tlet requiredOptionSelected = false;\r\n\t\t\tif ($('#apply-customization').is(':checked'))\r\n\t\t\t{\r\n\t\t\t\t$('[data-user_pref_meal][type=checkbox]').each(function () {\r\n\t\t\t\t\tif ($(this).is(':checked'))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\trequiredOptionSelected = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif (!requiredOptionSelected)\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Missing Customization Options',\r\n\t\t\t\t\t\tmessage: \"At least one meal customization option is required if 'Customize this order' is checked.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\t$('#to_payment').removeClass('btn-spinning');\r\n\r\n\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\t$('#to_payment').removeClass('disabled');\r\n\t\t\t\t\t}, 2000);\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tcatch(error)\r\n\t{\r\n\t\t//not worth failing over\r\n\t\tconsole.log('Issue checking if meal customizations are selected')\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction handleCardRefChange()\r\n{\r\n\tvar selectedRef = false;\r\n\t$('[id^=\"cc_pay_id\"]').each( function() {\r\n\t\tif ($(this).is(':checked')) {\r\n\t\t\tselectedRef = $(this).val();\r\n\t\t}\r\n\t});\r\n\r\n\t$('[id^=\"gc_pay_id\"]').each( function() {\r\n\t\tif ($(this).is(':checked')) {\r\n\t\t\tselectedRef = $(this).val();\r\n\t\t}\r\n\t});\r\n\r\n\tif (selectedRef)\r\n\t{\r\n\t\tdoNotRequireCreditCardFields();\r\n\t}\r\n\r\n}\r\n\r\nfunction requireCreditCardFields()\r\n{\r\n\t$('#ccNameOnCard, #ccType, #ccNumber, #ccMonth, #ccYear, #ccSecurityCode, #billing_address, #billing_postal_code, #billing_city').prop('required', true);\r\n}\r\n\r\nfunction doNotRequireCreditCardFields()\r\n{\r\n\t$('#ccNameOnCard, #ccType, #ccNumber, #ccMonth, #ccYear, #ccSecurityCode, #billing_address, #billing_postal_code, #billing_city').prop('required', false);\r\n}\r\n\r\nfunction remove_credit_card_reference(settings)\r\n{\r\n\tvar domObjectToRemove = getDomObjectToRemove(settings);\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_remove_payment',\r\n\t\t\tpayment_type: 'cc_ref',\r\n\t\t\tcc_ref_id: settings.item_number\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tvar numRefs = $(domObjectToRemove).data('num_cc_refs');\r\n\t\t\t\t$(domObjectToRemove).slideUp();\r\n\t\t\t\t$(domObjectToRemove).remove();\r\n\r\n\t\t\t\tif (numRefs > 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('[id^=\"row-cc_ref\"]').data('num_cc_refs', numRefs - 1);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t// select add new card and expose - no refs left\r\n\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcan_checkout();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction add_payment_credit_card()\r\n{\r\n\tvar elementsToCheck = $('[id^=\"cc\"]').get();\r\n\r\n\tif (!_check_elements(elementsToCheck))\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\t$('#addCreditCard').prop('disabled', true);\r\n\r\n\tvar doDelayedPayment = false;\r\n\r\n\tif ($('#is_delayed_payment1').length)\r\n\t{\r\n\t\tif ($('#is_delayed_payment1').attr('checked'))\r\n\t\t{\r\n\t\t\tdoDelayedPayment = true;\r\n\t\t}\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_add_payment',\r\n\t\t\tpayment_type: 'credit_card',\r\n\t\t\tcard_number: $('#ccNumber').val(),\r\n\t\t\tname_on_card: $('#ccNameOnCard').val(),\r\n\t\t\texp_month: $('#ccMonth').val(),\r\n\t\t\texp_year: $('#ccYear').val(),\r\n\t\t\tsecurity_code: $('#ccSecurityCode').val(),\r\n\t\t\tcard_type: $('#ccType').val(),\r\n\t\t\tbilling_zip: $('#billing_postal_code').val(),\r\n\t\t\tbilling_addr: $('#billing_address').val(),\r\n\t\t\tdo_delayed_payment: doDelayedPayment,\r\n\t\t\toutput: 'json'\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$('[id^=\"cc\"]').prop('disabled', true);\r\n\t\t\t\t$('#billing_postal_code').prop('disabled', true);\r\n\t\t\t\t$('#billing_address').prop('disabled', true);\r\n\t\t\t\t$('#addCreditCard').prop('disabled', true);\r\n\r\n\t\t\t\tif ($('#is_delayed_payment1').length)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#is_delayed_payment1').prop('disabled', true);\r\n\t\t\t\t\t$('#is_delayed_payment0').prop('disabled', true);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$('#creditcard_container').append(json.html);\r\n\t\t\t\t$('#creditcard_container').slideDown();\r\n\r\n\t\t\t\t// calculate the balance\r\n\t\t\t\tcan_checkout();\r\n\r\n\t\t\t\tif (cart_subtotal == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Alert',\r\n\t\t\t\t\t\tmessage: 'You have added all required payments, you may now submit your order.'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Credit Card Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t\t$('#addCreditCard').prop('disabled', false);\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\r\n\t\t\t$('#addCreditCard').prop('disabled', false);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n$(function () {\r\n\r\n\tif( $('#apply-customization').length && default_meal_customization_to_selected == true)\r\n\t{\r\n\t\t$('#apply-customization').click();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tinitMealCustomizationFields();\r\n\t}\r\n\r\n\r\n\r\n\t$(\"form\").submit( function(e) {\r\n\r\n\t\tlet canContinue = handleOrderCustomizations($(this));\r\n\t\tif ($(this).data('was_submitted') === true || !canContinue)\r\n\t\t{\r\n\t\t\t// Previously submitted - don't submit again\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).data('was_submitted', true);\r\n\t\t}\r\n\t});\r\n\r\n\t$(document).on('click', '.help-cvv', function (e) {\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Help',\r\n\t\t\tmessage: 'The security code is a 3 digit number located on the back of MasterCard, Visa, Discover. On American Express cards, the security code is a group of 4 digits printed on the front.'\r\n\t\t})\r\n\t});\r\n\r\n\t$(document).on('change', '#ccType', function (e) {\r\n\r\n\t\tif ($(this).val() == 'American Express')\r\n\t\t{\r\n\t\t\t$('#ccSecurityCode').prop({'min': '0', 'max': '9999', 'maxlength': '4', 'pattern': '^[0-9]{4}$'});\r\n\t\t}\r\n\t\telse if ($(this).val() != '' && $(this).val() != null)\r\n\t\t{\r\n\t\t\t$('#ccSecurityCode').prop({'min': '0', 'max': '999', 'maxlength': '3', 'pattern': '^[0-9]{3}$'});\r\n\t\t}\r\n\t});\r\n\r\n\tif (USER_PREFERENCES && $('#ccNumber').length)\r\n\t{\r\n\t\t$('#ccNumber').validateCreditCard(function (result) {\r\n\r\n\t\t\t\tvar validatorType = false;\r\n\t\t\t\tif (result.card_type != null && result.card_type.name != null)\r\n\t\t\t\t{\r\n\t\t\t\t\tvalidatorType = result.card_type.name;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (($('#ccType').val() == '' || $('#ccType').val() == null) && validatorType)\r\n\t\t\t\t{\r\n\t\t\t\t\tswitch (validatorType)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcase 'visa':\r\n\t\t\t\t\t\t\t$('#ccType').val('Visa');\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'mastercard':\r\n\t\t\t\t\t\t\t$('#ccType').val('Mastercard');\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'amex':\r\n\t\t\t\t\t\t\t$('#ccType').val('American Express');\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'discover':\r\n\t\t\t\t\t\t\t$('#ccType').val('Discover');\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ($('#ccType').val() != '')\r\n\t\t\t\t{\r\n\t\t\t\t\t// get validator type name of current type setting\r\n\t\t\t\t\tvar currentTypeWidgetValue = false;\r\n\t\t\t\t\tswitch ($('#ccType').val())\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcase 'Visa':\r\n\t\t\t\t\t\t\tcurrentTypeWidgetValue = 'visa';\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'Mastercard':\r\n\t\t\t\t\t\t\tcurrentTypeWidgetValue = 'mastercard';\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'American Express':\r\n\t\t\t\t\t\t\tcurrentTypeWidgetValue = 'amex';\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'Discover':\r\n\t\t\t\t\t\t\tcurrentTypeWidgetValue = 'discover';\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (currentTypeWidgetValue && currentTypeWidgetValue != validatorType && $(\"#ccNumber\").val().length > 2)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(\".credit_card_warning\").removeClass('collapse');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(\".credit_card_warning\").addClass('collapse');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\taccept: [\r\n\t\t\t\t\t'visa',\r\n\t\t\t\t\t'mastercard',\r\n\t\t\t\t\t'discover',\r\n\t\t\t\t\t'amex'\r\n\t\t\t\t]\r\n\t\t\t});\r\n\t}\r\n\r\n\t// Register click handler for CC logos\r\n\t$(document).on('click', '[data-credit_card_logo]', function (e) {\r\n\t\t$('#ccType').val($(this).data('credit_card_logo')).trigger('change');\r\n\t});\r\n\r\n\t// Click handler for remove items\r\n\t$(document).on('click', '[id^=\"remove-\"]', function (e) {\r\n\t\t// store the id and some of its parts\r\n\t\tvar remove = {\r\n\t\t\tid: this.id,\r\n\t\t\titem: this.id.split(\"-\")[1],\r\n\t\t\titem_number: this.id.split(\"-\")[2],\r\n\t\t\ttype: 'Payment'\r\n\t\t};\r\n\r\n\t\t// figure out if it has multiples like gift cards\r\n\t\tvar multiple = (remove.item_number != undefined) ? '-' + remove.item_number : '';\r\n\r\n\t\t// get the friendly item description to display in the popup\r\n\t\tremove.title = $('#checkout_title-' + remove.item + multiple).text();\r\n\r\n\t\t// it's payment by default, figure out if it is an item\r\n\t\tif (remove.item == 'nonfood' || remove.item == 'food' || remove.item == 'giftcard_purchase')\r\n\t\t{\r\n\t\t\tremove.type = 'Item';\r\n\t\t}\r\n\r\n\t\t// show removal confirmation\r\n\t\tmodal_message({\r\n\t\t\ttitle: 'Remove ' + remove.type,\r\n\t\t\tmessage: 'Are you sure you wish to remove ' + remove.title + '.',\r\n\t\t\tconfirm: function () {\r\n\t\t\t\tremove_item_payment(remove);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\r\n\t// Watch for change on terms checkbox\r\n\t$(document).on('change', '#customers_terms', function (e) {\r\n\t\tcan_checkout();\r\n\t});\r\n\r\n\t// Coupon add handler\r\n\t$(document).on('click', '#add_coupon_add', function (e) {\r\n\t\tadd_payment_coupon();\r\n\t\te.preventDefault();\r\n\t});\r\n\r\n\t// Coupon add enter key\r\n\t$(document).on('keyup', '#add_coupon_code', function (e) {\r\n\t\tif (e.which == 13)\r\n\t\t{\r\n\t\t\tadd_payment_coupon();\r\n\t\t}\r\n\t});\r\n\r\n\t// credit card\r\n\t$(document).on('click', '#addCreditCard', function (e) {\r\n\t\tadd_payment_credit_card();\r\n\t});\r\n\r\n\t//Gift Card Add handler\r\n\t$(document).on('click', '#giftCardBalance', function (e) {\r\n\t\tget_gift_card_balance();\r\n\t\te.preventDefault();\r\n\t});\r\n\r\n\t// Gift Card Button click\r\n\t$(document).on('click', '#giftCardRedeem', function (e) {\r\n\t\tadd_payment_gift_card();\r\n\t\te.preventDefault();\r\n\t});\r\n\r\n\t$(document).on('change', '#shipping_phone_number', function (e) {\r\n\r\n\t\t$('.shipping_phone_number_new_div').hideFlex();\r\n\t\t$('#shipping_phone_number_new').prop('required', false);\r\n\r\n\t\tif ($(this).val() == 'new')\r\n\t\t{\r\n\t\t\t$('.shipping_phone_number_new_div').showFlex();\r\n\t\t\t$('#shipping_phone_number_new').prop('required', true);\r\n\r\n\t\t}\r\n\t});\r\n\r\n\t$(document).on('change', '#address_book_select', function (e) {\r\n\r\n\t\tlet id = $(this).val();\r\n\t\tlet prev_id = (($('#address_book_update_update').val() == 'update') ? '' : $('#address_book_update_update').val());\r\n\r\n\t\tif (id == '')\r\n\t\t{\r\n\t\t\t$('#address_book_update_update').val('update');\r\n\r\n\t\t\t$('#shipping_firstname').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_lastname').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_address_line1').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_address_line2').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_city').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_state_id').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_address_note').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_phone_number').valCheckDiffRemove('');\r\n\t\t\t$('#shipping_gift_email_address').valCheckDiffRemove('');\r\n\r\n\t\t\t$('#shipping_postal_code').valCheckDiffRemove();\r\n\t\t}\r\n\t\telse if (id)\r\n\t\t{\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'delivered_box',\r\n\t\t\t\t\top: 'update_address',\r\n\t\t\t\t\tid: id\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet addy = JSON.parse(json.address);\r\n\r\n\t\t\t\t\t\tswitch (json.status)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tcase 'no_inventory':\r\n\t\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message,\r\n\t\t\t\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\t\t\t\"Cancel\": function () {\r\n\t\t\t\t\t\t\t\t\t\t\t$('#address_book_select').val(prev_id);\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\"Change Address\": function () {\r\n\t\t\t\t\t\t\t\t\t\t\tcreate_and_submit_form({\r\n\t\t\t\t\t\t\t\t\t\t\t\taction: 'main.php?page=box_select',\r\n\t\t\t\t\t\t\t\t\t\t\t\tinput: ({\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tdelivered_zip: addy.postal_code\r\n\t\t\t\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'not_eligible':\r\n\t\t\t\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\t\t\t\tmessage: 'We are sorry, Dream Dinners does not currently ship to ' + addy.postal_code,\r\n\t\t\t\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\t\t\t\"Close\": function () {\r\n\t\t\t\t\t\t\t\t\t\t\t$('#address_book_select').val(prev_id);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\t\tif (addy.location_type == 'ADDRESS_BOOK')\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$('#address_book_update_update').val(addy.id);\r\n\r\n\t\t\t\t\t\t\t\t\t$('#shipping_firstname').valCheckDiff({value : addy.firstname, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_lastname').valCheckDiff({value : addy.lastname, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_address_line1').valCheckDiff({value : addy.address_line1, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_address_line2').valCheckDiff({value : addy.address_line2, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_city').valCheckDiff({value : addy.city, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_state_id').valCheckDiff({value : addy.state_id, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_address_note').valCheckDiff({value : addy.address_note, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_phone_number').valCheckDiff({value : addy.telephone_1, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t\t$('#shipping_gift_email_address').valCheckDiff({value : addy.email_address, group : 'shipaddy'});\r\n\r\n\t\t\t\t\t\t\t\t\t$('#shipping_postal_code').valCheckDiff({value : addy.postal_code, group : 'shipaddy'});\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$('#shipping_firstname').val(addy.firstname);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_lastname').val(addy.lastname);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_address_line1').val(addy.address_line1);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_address_line2').val(addy.address_line2);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_city').val(addy.city);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_state_id').val(addy.state_id);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_address_note').val(addy.address_note);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_phone_number').val(addy.telephone_1);\r\n\t\t\t\t\t\t\t\t\t$('#shipping_gift_email_address').val(addy.email_address);\r\n\r\n\t\t\t\t\t\t\t\t\t$('#shipping_postal_code').val(addy.postal_code);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t$(document).on('dd:checkdiff', function (e) {\r\n\r\n\t\tlet diffData = $(document).data().checkdiff;\r\n\r\n\t\tif (Object.keys(diffData['shipaddy']).length === 0)\r\n\t\t{\r\n\t\t\t$('.update_contact_row').hideFlex();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('.update_contact_row').showFlex();\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t$(document).on('shown.bs.collapse', '#add_new_cc', function(e) {\r\n\t\thandleNewCardFormShown();\r\n\t});\r\n\r\n\t$(document).on('hidden.bs.collapse', '#add_new_cc', function(e) {\r\n\t\thandleNewCardFormHidden();\r\n\t});\r\n\r\n\t$(document).on('change', '[id^=\"cc_pay_id\"]', function(e) {\r\n\t\thandleCardRefChange();\r\n\t});\r\n\r\n\t$(document).on('change', '[id^=\"gc_pay_id\"]', function(e) {\r\n\t\thandleCardRefChange();\r\n\t});\r\n\r\n\t$(document).on('click', '.box-change-zip', function (e) {\r\n\r\n\t\te.preventDefault();\r\n\r\n\t\tlet href = $(this).attr('href');\r\n\r\n\t\tmodal_message({\r\n\t\t\tmessage : 'Menu item availability and taxes may be different for another delivery area. In order to change the zip code, we need to send you through the order process again.',\r\n\t\t\tbuttons: {\r\n\t\t\t\t\"Change Zip\": function () {\r\n\t\t\t\t\tbounce(href);\r\n\t\t\t\t},\r\n\t\t\t\t\"Cancel\": function () {\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n\r\n\t// Logged in functions\r\n\tif (USER_PREFERENCES)\r\n\t{\r\n\t\thandle_ltd_round_up();\r\n\t\thandle_checkout_delayed_payment();\r\n\t\thandle_special_instructions();\r\n\t\thandleMealCustomizationAccordion();\r\n\r\n\t\t$(document).on('click', '#apply_plate_points', function (e) {\r\n\t\t\teditSavePlatePointsCredits(false);\r\n\t\t});\r\n\r\n\t\t$(document).on('click', '#apply_all_plate_points', function (e) {\r\n\t\t\teditSaveAllPlatePointsCredits(false);\r\n\t\t});\r\n\r\n\t\t/*\r\n\t\t\t\t$(document).on('keyup', '#plate_points_discount', function (e) {\r\n\t\t\t\t\tif (e.which == 13)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$('#edit_plate_points').trigger('click');\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t*/\r\n\t\tif ($(\"#apply_plate_points\").length && maxPPDeduction <= 0)\r\n\t\t{\r\n\t\t\t$(\"#apply_plate_points\").attr(\"disabled\", true);\r\n\t\t\t$(\"#apply_all_plate_points\").attr(\"disabled\", true);\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tcan_checkout();\r\n\r\n});\r\n\r\nconst checkbox = document.getElementById('opted_to_bring_bags');\r\nif (checkbox)\r\n{\r\n\tcheckbox.addEventListener('click', function handleClick() {\r\n\t\tif (checkbox.checked)\r\n\t\t{\r\n\t\t\t$(\"#bag_text\").hideFlex();\r\n\t\t\t$(\"#opted_to_bring_bags_hidden\").val(\"1\");\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#bag_text\").showFlex();\r\n\t\t\t$(\"#opted_to_bring_bags_hidden\").val(\"0\");\r\n\t\t}\r\n\t\tupdate_bag_opt_out();\r\n\t});\r\n}\r\n\r\nfunction handleMealCustomizationAccordion()\r\n{\r\n\t$(\"#customization-header\").click(function (e) {\r\n\t\te.preventDefault();\r\n\r\n\t\t$header = $(this);\r\n\t\t$content = $(\"#customization-row\");\r\n\t\t$header.html(function () {\r\n\t\t\treturn \"Meal Customizations\" + ($content.is(\":visible\") ? \" &#8744;\" : \" &#8743;\");\r\n\t\t});\r\n\t\t$content.slideToggle(500, function () {\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction initMealCustomizationFields()\r\n{\r\n\tif(typeof has_meal_customization_selected === 'undefined'){\r\n\t\thas_meal_customization_selected = false;\r\n\t}\r\n\ttoggleMealCustomizationOptions(has_meal_customization_selected);\r\n}\r\n\r\nfunction toggleMealCustomizationOptions(on){\r\n\tif(on){\r\n\t\t$('[data-user_pref_meal][type=checkbox]').removeAttr(\"disabled\");\r\n\t\t$('.customization-readonly-option').removeClass('text-gray-400')\r\n\t}else{\r\n\t\t$('[data-user_pref_meal][type=checkbox]').attr(\"disabled\", true);\r\n\t\t$('.customization-readonly-option').addClass('text-gray-400')\r\n\t}\r\n}\r\n\r\nfunction toggleMealCustomizationMasterCheckbox(on){\r\n\tif(on){\r\n\t\t$('#apply-customization').prop('checked', true);\r\n\t\t$('#apply-customization').attr('checked', true);\r\n\t\thas_meal_customization_selected = true;\r\n\t}else{\r\n\t\t$('#apply-customization').prop('checked', false);\r\n\t\t$('#apply-customization').attr('checked', true);\r\n\t\thas_meal_customization_selected = false;\r\n\t\thandleMealCustomizationMasterCheckbox(false);\r\n\t}\r\n}\r\n\r\nfunction handleMealCustomizationMasterCheckbox(allow_customization){\r\n\thas_meal_customization_selected = allow_customization;\r\n\ttoggleMealCustomizationOptions(allow_customization);\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: \"JSON\",\r\n\t\tdata: {\r\n\t\t\tprocessor: 'cart_order_customization_preference',\r\n\t\t\top: 'set_customization_applies_to_order',\r\n\t\t\tallow_customization: allow_customization,\r\n\t\t\tcustomizations: JSON.stringify(meal_customization_preferences)\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tcustomization = json;\r\n\t\t\t\tif(customization.opted_to_customize_recipes == true){\r\n\t\t\t\t\t$('#customization-fee-row').show();\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$('#customization-fee-row').hide();\r\n\t\t\t\t}\r\n\t\t\t\t$('#checkout_total-customization_fee').text(formatAsMoney(customization.cost));\r\n\t\t\t\t$('#sum_checkout_total-subtotal').text(formatAsMoney(customization.orderInfo.grand_total));\r\n\t\t\t\t$('#credit_card_amount').text(formatAsMoney(customization.orderInfo.grand_total));\r\n\t\t\t\t$('#checkout_total-tax').text(formatAsMoney(customization.orderInfo.subtotal_all_taxes));\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tmodal_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\n$(document).on('click', '#apply-customization', function (e) {\r\n\tlet allow_customization = $(this).prop('checked');\r\n\thandleMealCustomizationMasterCheckbox(allow_customization);\r\n});\r\n\r\n\r\nfunction preferenceChangeListener(pref, setting, user_id, callback){\r\n\r\n\tpref = pref.toUpperCase();\r\n\r\n\tif(!pref.includes('MEAL'))\r\n\t{\r\n\t\tset_user_pref(pref, setting, user_id, callback);\r\n\t}\r\n\telse\r\n\t{\r\n\t\tlet pref_value = USER_PREFERENCES[pref].value;\r\n\r\n\t\tif ($.isPlainObject(pref_value) && $.isPlainObject(setting))\r\n\t\t{\r\n\t\t\tsetting = JSON.stringify($.extend(USER_PREFERENCES[pref].value, setting));\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsetting = setting.toString()\r\n\t\t}\r\n\r\n\t\tmeal_customization_preferences[pref].value = setting;\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'cart_order_customization_preference',\r\n\t\t\t\top: 'update_order_meal_customization',\r\n\t\t\t\tcustomizations: JSON.stringify(meal_customization_preferences)\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif(json.opted_to_customize_recipes == true){\r\n\t\t\t\t\t\t$('#customization-fee-row').show();\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t$('#customization-fee-row').hide();\r\n\t\t\t\t\t\t//toggleMealCustomizationMasterCheckbox(false);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$('#checkout_total-customization_fee').text(formatAsMoney(json.cost));\r\n\t\t\t\t\t$('#sum_checkout_total-subtotal').text(formatAsMoney(json.orderInfo.grand_total));\r\n\t\t\t\t\t$('#credit_card_amount').text(formatAsMoney(json.orderInfo.grand_total));\r\n\r\n\t\t\t\t\tif(typeof callback !== 'undefined'){\r\n\t\t\t\t\t\tcallback(json);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tmodal_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\tmodal_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}"],"mappings":"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"}