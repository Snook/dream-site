{"version":3,"sourceRoot":"js/src/dreamdinners","sources":["order_mgr_delivered.js"],"sourcesContent":["var itemChanges = false;\r\nvar discountOrPaymentChanges = false;\r\nvar deliveryChanges = false;\r\nvar discountChanges = false;\r\nvar reportingChanges = false;\r\nvar paymentChanges = false;\r\nvar changeList = null;\r\nvar currentlySavingOrder = false;\r\nvar intenseLoggingOn = true;\r\nvar boxesDeletedFromActiveOrder = []; // for showing box deletions in change list\r\n\r\nvar needPlatePointsMaxDiscountChangeWarning = false;\r\nvar lastMaxPPDiscountAmount = -1;\r\n\r\nfunction admin_order_mgr_init()\r\n{\r\n\r\n\tif (store_id != STORE_DETAILS.id)\r\n\t{\r\n\t\tSTORE_DETAILS.id = store_id;\r\n\r\n\t\t//STORE_DETAILS.id is either the current fadmin store - in which case a match is guaranteed or\r\n\t\t// is the current Site Admin store (last selection from a store drop down.) However in this case if the order was accessed by the address\r\n\t\t// bar a match is not guaranteed so force STORE_DETAILS.id to store_id which is always the store of the order\r\n\t}\r\n\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetupForNewOrder();\r\n\t}\r\n\telse if (orderState == 'SAVED')\r\n\t{\r\n\t\tsetupForSavedOrder();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetupForActiveOrder();\r\n\t}\r\n\r\n\tinitChangeList();\r\n\tinit_inside_box_editing();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tcalculateTotal();\r\n\t\tsetAllPaymentFieldsToUnrequired();\r\n\t\tsetupCouponState();\r\n\t}\r\n\r\n\tsetUpKeyHandlers();\r\n\r\n\thandle_special_instruction_notes();\r\n\thandle_cancel_order_delivered();\r\n\thandle_delete_saved_order_delivered();\r\n\r\n\thandle_free_menu_item_edit();\r\n\thandleDirectOrderDiscountFocusing();\r\n\r\n\t$('#shipping_phone_number').trigger('change');\r\n\r\n\tupdateInventory();\r\n\r\n\thandle_is_gift();\r\n\r\n}\r\n\r\nfunction handleSessionSelection()\r\n{\r\n\t$(\"[data-select_delivery_day]\").on('click', function () {\r\n\t\tlet selected_session_id = $(this).data(\"select_delivery_day\");\r\n\t\tlet sessionDate = $(this).data(\"date\");\r\n\t\tdoReschedule(selected_session_id, sessionDate);\r\n\t});\r\n\r\n}\r\n\r\nfunction handle_is_gift()\r\n{\r\n\tif ($(\"#shipping_is_gift\").is(':checked'))\r\n\t{\r\n\t\t$(\".shipping_email_address_div\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\".shipping_email_address_div\").hide();\r\n\t}\r\n\r\n\t$(\"#shipping_is_gift\").on('change', function () {\r\n\t\tif ($(this).is(':checked'))\r\n\t\t{\r\n\t\t\t$(\".shipping_email_address_div\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\".shipping_email_address_div\").hide();\r\n\t\t}\r\n\t});\r\n\r\n}\r\n\r\nfunction validateBoxes()\r\n{\r\n\tlet hasAtLeastOneBox = false;\r\n\tlet noCustomBoxesAreIncomplete = true;\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\thasAtLeastOneBox = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\thasAtLeastOneBox = true;\r\n\r\n\t\t\tlet itemCount = 0;\r\n\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\titemCount += ($(this).val() * 1);\r\n\t\t\t});\r\n\r\n\t\t\tlet number_items_required = $(\"#box_inst_id_\" + list_id).data(\"number_items_required\");\r\n\r\n\t\t\tif (number_items_required != itemCount)\r\n\t\t\t{\r\n\t\t\t\tnoCustomBoxesAreIncomplete = false;\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\treturn (hasAtLeastOneBox && noCustomBoxesAreIncomplete);\r\n}\r\n\r\nfunction countItemsInBox(box_instance_id)\r\n{\r\n\tlet retVal = 0;\r\n\t$(\"[id^='qty_\" + box_instance_id + \"_']\").each(function () {\r\n\t\tretVal += ($(this).val() * 1);\r\n\t});\r\n\r\n\treturn retVal;\r\n}\r\n\r\nfunction init_inside_box_editing()\r\n{\r\n\r\n\t$(\"[id^='qty_']\").off('click', function () {\r\n\r\n\t});\r\n\r\n\t$(\"[id^='qty_']\").on('change', function () {\r\n\t\tlet itemError = false;\r\n\t\tlet boxError = false;\r\n\r\n\t\tlet menu_item_id = this.id.split(\"_\")[2];\r\n\t\tlet box_inst_id = this.id.split(\"_\")[1];\r\n\t\tlet number_items_required = $(\"#box_inst_id_\" + box_inst_id).data(\"number_items_required\");\r\n\t\tlet newQty = $(this).val();\r\n\r\n\t\tlet curTotal = countItemsInBox(box_inst_id);\r\n\t\tif (curTotal > number_items_required)\r\n\t\t{\r\n\t\t\tlet delta = curTotal - number_items_required;\r\n\t\t\t$(this).val(newQty - delta);\r\n\t\t\tboxError = true;\r\n\t\t}\r\n\r\n\t\tnewQty = $(this).val();\r\n\r\n\t\tif (isNaN(newQty))\r\n\t\t{\r\n\t\t\tnewQty = 0;\r\n\t\t\t$(this).val(0);\r\n\t\t}\r\n\t\tif (newQty < 0)\r\n\t\t{\r\n\t\t\tnewQty = 0;\r\n\t\t\t$(this).val(0);\r\n\t\t}\r\n\r\n\t\tif (newQty - Math.floor(newQty) != 0)\r\n\t\t{\r\n\t\t\tnewQty = Math.floor(newQty);\r\n\t\t\t$(this).val(newQty);\r\n\t\t}\r\n\r\n\t\tlet lastQty = $(this).data('last_qty'); // last quantity is already removed from current_inventory array\r\n\t\tvar servings = $(this).data('servings_per_item');\r\n\t\tvar recipeID = $(this).data('recipe_id');\r\n\r\n\t\tif (newQty > 2)\r\n\t\t{\r\n\t\t\titemError = true;\r\n\t\t\t$(this).val(2);\r\n\t\t\tnewQty = 2;\r\n\t\t}\r\n\r\n\t\tlet new_servings_needed = (newQty - lastQty) * servings;\r\n\r\n\t\twhile (new_servings_needed > current_inventory[recipeID])\r\n\t\t{\r\n\t\t\tnewQty--;\r\n\t\t\tnew_servings_needed = (newQty - lastQty) * servings;\r\n\t\t}\r\n\r\n\t\t$(this).val(newQty);\r\n\t\t$(this).data('last_qty', newQty);\r\n\t\tcurrent_inventory[recipeID] -= new_servings_needed;\r\n\r\n\t\t$(\"[id^='inv_']\").filter(\"[data-recipe_id='\" + recipeID + \"']\").html(current_inventory[recipeID] + \"/serv\");\r\n\r\n\t\tupdateChangeList();\r\n\r\n\t\tif (boxError && itemError)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"Each box can only have up to 2 of the same menu item and a total of \" + number_items_required + \" items.\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (itemError)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"Each box can only have up to 2 of the same menu item\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (boxError)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"You can only add a total of \" + number_items_required + \" items to this box.\"\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction addToInitialInventory(list_id)\r\n{\r\n\r\n\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t{\r\n\t\t$(\"[id^='qty_\" + list_id + \"_']\").each(function () {\r\n\t\t\tvar curAmount = $(this).val();\r\n\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\tvar curInv = initial_inventory[recipeID];\r\n\t\t\tvar adjInv = curInv + (curAmount * servings);\r\n\t\t\tinitial_inventory[recipeID] = adjInv;\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\tvar curAmount = $(this).val();\r\n\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\tvar curInv = current_inventory[recipeID];\r\n\t\t\tvar adjInv = curInv + (curAmount * servings);\r\n\t\t\tinitial_inventory[recipeID] = adjInv;\r\n\t\t});\r\n\t}\r\n}\r\n\r\n$(document).on('click', '.add_box', function (e) {\r\n\r\n\tlet bundle_id = $(this).data(\"bundle_id\");\r\n\tlet box_id = $(this).data(\"box_id\");\r\n\tlet box_type = $(this).data(\"box_type\");\r\n\tlet box_label = $(this).data(\"box_label\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\top: 'add_box',\r\n\t\t\tbundle_id: bundle_id,\r\n\t\t\tbox_id: box_id,\r\n\t\t\tbox_type: box_type,\r\n\t\t\tbox_label: box_label,\r\n\t\t\tmenu_id: menu_id,\r\n\t\t\tstore_id: store_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$(\"#box_editor\").append(json.html);\r\n\r\n\t\t\t\tlet currentDeliveryFee = $('#subtotal_delivery_fee').val();\r\n\t\t\t\tlet newDeliveryFee = Number(formatAsMoney(currentDeliveryFee)) + Number(formatAsMoney(json.bundle_info.price_shipping));\r\n\r\n\t\t\t\t$('#subtotal_delivery_fee').val(newDeliveryFee);\r\n\r\n\t\t\t\tupdateInventory();\r\n\t\t\t\tcalculateTotal();\r\n\t\t\t\tinit_inside_box_editing();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n});\r\n\r\n$(document).on('click', '.box-delete', function (e) {\r\n\r\n\tlet box_inst_id = $(this).data('box_instance_id');\r\n\r\n\tif (orderState == 'ACTIVE')\r\n\t{\r\n\t\tlet currentDeliveryFee = $('#subtotal_delivery_fee').val();\r\n\t\tlet newDeliveryFee = Number(formatAsMoney(currentDeliveryFee)) - Number(formatAsMoney($(\"#box_inst_id_\" + box_inst_id).data('price_shipping')));\r\n\r\n\t\t$('#subtotal_delivery_fee').val(newDeliveryFee);\r\n\r\n\t\t// active orders defer database updates until finalized\r\n\t\taddToInitialInventory(box_inst_id);\r\n\t\tboxesDeletedFromActiveOrder[box_inst_id] = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\t\t$(\"#bi_\" + box_inst_id).remove();\r\n\t\tupdateInventory();\r\n\t\tcalculateTotal();\r\n\t\treturn;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\top: 'delete_box',\r\n\t\t\tbox_inst_id: box_inst_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$(\"#bi_\" + box_inst_id).remove();\r\n\t\t\t\tupdateInventory();\r\n\t\t\t\tcalculateTotal();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n\r\n});\r\n\r\nfunction updateInventory()\r\n{\r\n\r\n\t// re init current values\r\n\tcurrent_inventory = Object.assign({}, initial_inventory);\r\n\r\n\t// loop through all existing boxes and accumulate values in current_inventory\r\n\t// after items have been accumulated push numbers to the display\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\t$(\"[id^='qty_\" + list_id + \"_']\").each(function () {\r\n\t\t\t\tvar curAmount = $(this).val();\r\n\t\t\t\tvar claimedAmount = $(this).data('claimed_qty');\r\n\t\t\t\tcurAmount -= claimedAmount;\r\n\t\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\t\tvar curInv = current_inventory[recipeID];\r\n\t\t\t\tvar adjInv = curInv - (curAmount * servings);\r\n\t\t\t\tcurrent_inventory[recipeID] = adjInv;\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\tvar curAmount = $(this).val();\r\n\t\t\t\tvar claimedAmount = $(this).data('claimed_qty');\r\n\t\t\t\tcurAmount -= claimedAmount;\r\n\t\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\t\tvar curInv = current_inventory[recipeID];\r\n\t\t\t\tvar adjInv = curInv - (curAmount * servings);\r\n\t\t\t\tcurrent_inventory[recipeID] = adjInv;\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\tfor (const recipe_id in current_inventory)\r\n\t{\r\n\r\n\t\t$(\"[id^='inv_']\").filter(\"[data-recipe_id='\" + recipe_id + \"']\").each(function () {\r\n\r\n\t\t\t// TODO:  item < serving per item is also out of stock\r\n\t\t\tif (current_inventory[recipe_id] == 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).html('Out of stock');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(this).html(current_inventory[recipe_id] + \"/serv\");\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction handleDirectOrderDiscountFocusing()\r\n{\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").focus(function (e) {\r\n\r\n\t\tif ($(this).val() == 0)\r\n\t\t{\r\n\t\t\t$(this).val(\"\");\r\n\t\t}\r\n\t\tif ($(this).val().length > 0)\r\n\t\t{\r\n\t\t\t$(this).select();\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").blur(function (e) {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tcurVal = (curVal.trim());\r\n\r\n\t\tif (curVal == \"\" || isNaN(curVal))\r\n\t\t{\r\n\t\t\t$(this).val(\"0\");\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction intenseLogging(message)\r\n{\r\n\tif (window.console && intenseLoggingOn)\r\n\t{\r\n\t\tconsole.log('OM Intense logging: ' + message);\r\n\t}\r\n}\r\n\r\nfunction saveSpecialInstructions()\r\n{\r\n\r\n\tvar special_instructions = strip_tags($(\"#order_user_notes\").val());\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_special_instructions',\r\n\t\t\torder_id: order_id,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tupdateInstructionsOrgValues();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveSpecialInstructions: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"saveSpecialInstructions: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction handle_special_instruction_notes()\r\n{\r\n\t$('[id^=\"gd_special_instruction_note_button-\"]').each(function () {\r\n\r\n\t\t$(this).on('click', function (e) {\r\n\r\n\t\t\tvar booking_id = $(this).data('booking_id');\r\n\t\t\tvar user_id = $(this).data('user_id');\r\n\t\t\tvar do_op = 'get';\r\n\t\t\tvar special_instructions = '';\r\n\r\n\t\t\tif ($(this).data('edit_mode') == true)\r\n\t\t\t{\r\n\t\t\t\tdo_op = 'save';\r\n\r\n\t\t\t\tspecial_instructions = strip_tags($('#gd_special_instruction_note-' + booking_id + ' > textarea').val());\r\n\t\t\t}\r\n\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\t\top: 'update_special_instructions',\r\n\t\t\t\t\t'do': do_op,\r\n\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\tnote: special_instructions\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (do_op == 'get')\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar textarea_elem = $('<textarea></textarea>').addClass('form-control').val((json.special_instruction_note ? json.special_instruction_note : \"\")).on('keyup', function (e) {\r\n\r\n\t\t\t\t\t\t\t\tif ($(this).val() != strip_tags($(this).val()))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(this).val(strip_tags($(this).val()));\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).addClass('special_instruction_note_edit').html(textarea_elem);\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', true).html('Save Note');\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).data('special_instruction_note_value', (json.special_instruction_note ? json.special_instruction_note : \"\")).on('click', function (e) {\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + $(this).data('booking_id')).removeClass('special_instruction_note_edit').html($(this).data('special_instruction_note_value'));\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + $(this).data('booking_id')).data('edit_mode', false).html('Special Instructions');\r\n\r\n\t\t\t\t\t\t\t\t$(this).hide();\r\n\r\n\t\t\t\t\t\t\t}).show();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).removeClass('special_instruction_note_edit').html(nl2br(json.special_instruction_note));\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).hide();\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', false).html('Special Instructions');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\tintenseLogging(\"handle_special_instruction_notes: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\t\t\tresponse = 'Unexpected error';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction setUpKeyHandlers()\r\n{\r\n\tdocument.onkeypress = OMDefaultKeyHandler;\r\n\r\n\t$(\"#coupon_code\").on('keypress', function (evt) {\r\n\t\t// the enter key will submit a coupon code\r\n\t\tevt = (evt) ? evt : event;\r\n\t\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\t\tif (charCode == 13)\r\n\t\t{\r\n\t\t\tprocessCode();\r\n\t\t\tevt.stopPropagation();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#order_user_notes\").on('keypress', function (evt) {\r\n\t\tevt.stopPropagation();\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#payment1_gc_payment_number\").on('keyup', function (evt) {\r\n\r\n\t\tif ($(this).val().length == 15 && !isNaN($(this).val()) && $(this).val() != lastCheckedGiftCertNumber)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Warning',\r\n\t\t\t\tmessage: \"It appears that you may be entering a gift Card number. If so, select Gift Card from payment selector. This is the Certificate (Gift Certificate) payment type.\"\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tlastCheckedGiftCertNumber = $(this).val();\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n}\r\n\r\nfunction OMDefaultKeyHandler(evt)\r\n{\r\n\t// by default the document just eats the enter key\r\n\tevt = (evt) ? evt : event;\r\n\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\tif (charCode == 13)\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction initChangeList()\r\n{\r\n\t$(\"#changeListTab\").on('click', function () {\r\n\r\n\t\tvar html = getChangeListHTML();\r\n\r\n\t\tif (!html || html == \"\")\r\n\t\t{\r\n\t\t\thtml = \"<h3><i>No Changes</i></h3>\"\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Change List',\r\n\t\t\tmessage: html,\r\n\t\t\theight: 620,\r\n\t\t\twidth: 300,\r\n\t\t\tmodal: false,\r\n\t\t\tdiv_id: 'changelist',\r\n\t\t\tdialogClass: 'fixedDialog',\r\n\t\t\tnoOk: true,\r\n\t\t\tposition: {\r\n\t\t\t\tmy: \"left top\",\r\n\t\t\t\tat: \"left bottom\",\r\n\t\t\t\tof: this\r\n\t\t\t},\r\n\t\t\tclose: function (event, ui) {\r\n\t\t\t\t$(\"#changelist\").remove();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction updateItemsOrgValues()\r\n{\r\n\t// TODO\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction saveAll()\r\n{\r\n\tsaveItems(true, false, true);\r\n}\r\n\r\nfunction saveItems(saveDiscountsUponCompletion, activateOnSaveDiscountsCompletion)\r\n{\r\n\r\n\tintenseLogging(\"saveItems() called\");\r\n\r\n\tif (currentlySavingOrder)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Items are still being saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tdd_toast({\r\n\t\tmessage: 'Items Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\r\n\tif (activateOnSaveDiscountsCompletion)\r\n\t{\r\n\t\tif (!validateBoxes())\r\n\t\t{\r\n\t\t\t$(\"#activate_confirm\").remove();\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Problem with boxes',\r\n\t\t\t\tmessage: \"Please review the selected box(es) and ensure item counts are correct.\"\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\tvar boxList = {};\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\t\tboxList[list_id] = {};\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\t$(\"li[data-box_inst_id|='\" + list_id + \"']\").each(function () {\r\n\t\t\t\tboxList[list_id][$(this).data(\"menu_item_id\")] = 1;\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\tboxList[list_id][$(this).data(\"menu_item_id\")] = $(this).val();\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tvar subtotal_delivery_fee = $(\"#subtotal_delivery_fee\").val();\r\n\tif (isNaN(subtotal_delivery_fee))\r\n\t{\r\n\t\tsubtotal_delivery_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar special_instructions = $(\"#order_user_notes\").val();\r\n\r\n\tcurrentlySavingOrder = true;\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_items',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: boxList,\r\n\t\t\tsubtotal_delivery_fee: subtotal_delivery_fee,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tupdateItemsOrgValues();\r\n\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"saveItems() successful\");\r\n\r\n\t\t\t\tif (saveDiscountsUponCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDiscounts(activateOnSaveDiscountsCompletion);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"update_items: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tcurrentlySavingOrder = false;\r\n\t\t\tintenseLogging(\"update_items: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\n/*\r\nfunction saveDeliveryAddress(payOnCompletion, token)\r\n{\r\n\r\n\tvar shipping_data = {};\r\n\t$(\"[id^='shipping_']\").each(function(){\r\n\t\tshipping_data[this.id] = $(this).val();\r\n\t});\r\n\r\n\tintenseLogging(\"saveDeliveryAddress() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 200000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'save_delivery_address',\r\n\t\t\torder_id: order_id,\r\n\t\t\tshipping_data: shipping_data\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDeliveryAddress() successful\");\r\n\r\n\t\t\t\tdd_toast({\r\n\t\t\t\t\tmessage: 'Delivery Address Saved',\r\n\t\t\t\t\tposition: 'topcenter'\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, token);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"save_delivery_address: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"save_delivery_address: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\n */\r\n\r\nfunction setShipToAddressAndSaveOrder()\r\n{\r\n\r\n\tvar shipping_data = {};\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\t\tshipping_data[this.id] = $(this).val();\r\n\t});\r\n\r\n\tif ($(\"#shipping_is_gift\").is(\":checked\"))\r\n\t{\r\n\t\tshipping_data[\"shipping_is_gift\"] = \"on\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\tshipping_data[\"shipping_is_gift\"] = \"0\";\r\n\t}\r\n\r\n\tintenseLogging(\"setShipToAddressAndSaveOrder() called\");\r\n\r\n\t// similar to saveDeliveryAddress but no order id is passed\r\n\t// and the response to success is to expose the calendar\r\n\t// I.E., this is part of initializing a new order\r\n\t// A SAVED order will have been created when this call completes.\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 200000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'save_delivery_address',\r\n\t\t\tshipping_data: shipping_data,\r\n\t\t\torder_state: orderState,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"setShipToAddressAndSaveOrder() successful\");\r\n\t\t\t\tbounce(\"main.php?page=admin_order_mgr_delivered&order=\" + json.order_id + \"&atabs=mgr.sessionsTab\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"setShipToAddressAndSaveOrder: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"save_delivery_address: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction Reschedule(org_session_id)\r\n{\r\n\r\n\tintenseLogging(\"Reschedule() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'reschedule',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tsaved_booking_id: saved_booking_id,\r\n\t\t\torg_session_id: org_session_id,\r\n\t\t\torder_state: orderState\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"Reschedule() successful\");\r\n\r\n\t\t\t\tsession_id = json.new_session_id;\r\n\t\t\t\t$(\"#curSessionDate\").html(json.new_session_time);\r\n\t\t\t\t$(\"#curShipDate\").html(json.new_ship_time);\r\n\t\t\t\t$(\"#session\").val(json.new_session_id);\r\n\r\n\t\t\t\tRetrieveCalendar(0);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"reschedule: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"reschedule: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction onSaveItems()\r\n{\r\n\tintenseLogging(\"onSaveItems() called\");\r\n\r\n\tsaveItems(false, false, false);\r\n\treturn false;\r\n\r\n}\r\n\r\nfunction setupForNewOrder()\r\n{\r\n\tHideLineItemsIfZero();\r\n\tvar timestamp = getQueryVariable('month');\r\n\r\n}\r\n\r\nfunction setupForSavedOrder()\r\n{\r\n\tRetrieveCalendar(0);\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\t$(\"#addPaymentAndActivateButton\").attr('disabled', 'disabled');\r\n\t$(\"#items_tab_li\").removeClass(\"disabled\");\r\n\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n}\r\n\r\nfunction setupForActiveOrder()\r\n{\r\n\tif (discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").click();\r\n\t\t$(\"#items_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#sessions_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#discountsDiv\").find(\":input\").prop(\"disabled\", true);\r\n\t\t$(\"#discountsDiv\").find(\"*\").addClass(\"om_disabled\");\r\n\t}\r\n\r\n\t$(\"#addPaymentAndActivate\").hide();\r\n\r\n}\r\n\r\nfunction isDeliveryAddressComplete()\r\n{\r\n\tvar validated = true;\r\n\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\r\n\t\tif (!$(this).val() && $(this).attr('required'))\r\n\t\t{\r\n\t\t\tvalidated = false;\r\n\t\t}\r\n\t});\r\n\treturn validated;\r\n}\r\n\r\nfunction onDeliveryTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onDeliveryTabDeselected()\r\n{\r\n\t/*\r\n\tif (!isDeliveryAddressComplete())\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please check the Delivery Address and phone number fields for completeness.'\r\n\t\t});\r\n\r\n\t\treturn false;\r\n\t}\r\n*/\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction onSessionTabSelected()\r\n{\r\n\tRetrieveCalendar(0);\r\n}\r\n\r\nfunction onSessionTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onItemsTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onItemsTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\tif (itemTabIsDirty)\r\n\t\t{\r\n\t\t\tsaveItems(false, false, false);\r\n\t\t}\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentTabSelected()\r\n{\r\n}\r\n\r\nfunction onPaymentTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE' && (discountChanges || reportingChanges))\r\n\t{\r\n\t\tsaveDiscounts(false, false);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onNotesTabSelected()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_history',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$(\"#history_div\").html(json.html);\r\n\r\n\t\t\thandle_guest_account_notes();\r\n\r\n\t\t\thandle_admin_carryover_notes();\r\n\r\n\t\t\thandle_admin_order_notes();\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"get_history: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onNotesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentSelected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n}\r\n\r\nfunction onPaymentDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\t\tupdateChangeList();\r\n\t\tpaymentChanges = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = false;\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction updateDiscountOrgValues()\r\n{\r\n\r\n\t$(\"#org_coupon_id\").val($(\"#coupon_id\").val());\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction _validate_discounts()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction _validate_address()\r\n{/*\r\n\t$thisOrder->orderAddress->firstname = $shippingData['shipping_firstname'];\r\n\t$thisOrder->orderAddress->lastname = $shippingData['shipping_lastname'];\r\n\t$thisOrder->orderAddress->address_line1 = $shippingData['shipping_address_line1'];\r\n\t$thisOrder->orderAddress->address_line2 = $shippingData['shipping_address_line2'];\r\n\t$thisOrder->orderAddress->city = $shippingData['shipping_city'];\r\n\t$thisOrder->orderAddress->state_id = $shippingData['shipping_state_id'];\r\n\t$thisOrder->orderAddress->postal_code = $shippingData['shipping_postal_code'];\r\n\t$thisOrder->orderAddress->telephone_1 = (($shipping_phone_number == 'new') ? $shipping_phone_number_new : $shipping_phone_number);\r\n\t$thisOrder->orderAddress->address_note = trim(strip_tags($shipping_address_note));\r\n\t$thisOrder->orderAddress->email_address = $shipping_email_address;\r\n\t$thisOrder->orderAddress->is_gift = (!empty($shippingData['shipping_is_gift']) ? 1 : 0);\r\n*/\r\n\t// TODO: phone and email validation\r\n\r\n\tvalidationSuccess = true;\r\n\r\n\tif ($(\"#shipping_firstname\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_firstname\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_firstname\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_firstname\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_firstname\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_lastname\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_lastname\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_lastname\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_lastname\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_lastname\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_address_line1\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_address_line1\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_address_line1\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_address_line1\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_address_line1\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_city\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_city\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_city\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_city\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_city\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_state_id\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_state_id\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_postal_code\").val().length != 5)\r\n\t{\r\n\t\t$(\"#shipping_postal_code\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_postal_code\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_postal_code\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_postal_code\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\treturn validationSuccess;\r\n}\r\n\r\nfunction saveDiscounts(payOnCompletion)\r\n{\r\n\tintenseLogging(\"saveDiscounts() called\");\r\n\r\n\tif (!_validate_discounts())\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (!payOnCompletion)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Discounts Saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t}\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar dinner_dollars_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(dinner_dollars_discount))\r\n\t{\r\n\t\tdinner_dollars_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar coupon_id = 0;\r\n\tvar coupon_free_menu_item = 0;\r\n\tif ($(\"#coupon_id\").val())\r\n\t{\r\n\r\n\t\tcoupon_id = $(\"#coupon_id\").val();\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'update_discounts',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tplate_points_discount: dinner_dollars_discount,\r\n\t\t\tcoupon_id: coupon_id,\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDiscounts() successful\");\r\n\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\t\t\t\tupdateReportingOrgValues();\r\n\r\n\t\t\t\tif (coupon_free_menu_item)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#free_menu_item_coupon').attr('disabled', true);\r\n\t\t\t\t\tcouponFreeMenuItem = coupon_free_menu_item;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (!_validate_address())\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\tmessage: \"Please review and correct the shipping address.\"\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_discounts: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"update_discounts: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction updateReportingOrgValues()\r\n{\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction getPaymentData(type, payment_number)\r\n{\r\n\r\n\tif (type != 'CC')\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val()\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val(),\r\n\t\t\tccNameOnCard: \"\",\r\n\t\t\tccType: 'CC',\r\n\t\t\tccMonth: \"\",\r\n\t\t\tccYear: \"\",\r\n\t\t\tcc_security_code: \"\",\r\n\t\t\tbilling_address: \"\",\r\n\t\t\tbilling_postal_code: \"\",\r\n\t\t\tis_store_specific_flat_rate_deposit_delayed_payment: 0,\r\n\t\t\tdo_not_ref: 0\r\n\t\t}\r\n\t}\r\n\r\n\tif (payment_number == 1)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"REFERENCE\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_reference_total_amount\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CERT\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_gc_total_amount\").val();\r\n\t\t\t\tpaymentData.cert_type = $(\"#payment1_gift_cert_type\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_gc_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFUND_CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_refund_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_refund_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CREDIT\":\r\n\t\t\t\tpaymentData.amount = $(\"#OEH_remaing_balance\").html();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment1_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment1_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment1_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment1_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment1_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_1\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_1\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_1').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CARD\":\r\n\t\t\t\tpaymentData.amount = $(\"#debit_gift_card_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#debit_gift_card_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"DPADJUST\":\r\n\t\t\t\t// TODO: ???\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p1_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\r\n\t}\r\n\telse if (payment_number == 2)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment2_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment2_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment2_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment2_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment2_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_2\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_2').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p2_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\t}\r\n\r\n}\r\n\r\nfunction validatePayment1(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\t\tcase \"REFERENCE\":\r\n\t\t\tinputArray = $(\"#payment1_reference :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CERT\":\r\n\t\t\tinputArray = $(\"#payment1_gc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment1_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFUND_CASH\":\r\n\t\t\tinputArray = $(\"#payment1_refund_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment1_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CREDIT\":\r\n\t\t\tinputArray = $(\"#payment1_credit :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment1_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CARD\":\r\n\t\t\tinputArray = $(\"#payment1_debit_gift_card :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"DPADJUST\":\r\n\t\t\tinputArray = $(\"#dp_adjust_div :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment1_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n\r\n}\r\n\r\nfunction validatePayment2(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment2_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment2_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n}\r\n\r\nfunction addPaymentAndActivate()\r\n{\r\n\tintenseLogging(\"addPaymentAndActivate() called\");\r\n\r\n\t// always first ensure that discounts are updated on server\r\n\tvar message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\tvar changesBlurb = getAbbreviatedSummaryString();\r\n\t//message += \"<br /><br />\" + changesBlurb;\r\n\r\n\tdd_message({\r\n\t\tdiv_id: 'activate_confirm',\r\n\t\ttitle: 'Add Payment and Book Order',\r\n\t\tmessage: message,\r\n\t\tmodal: true,\r\n\t\twidth: 400,\r\n\t\theight: 180,\r\n\t\tconfirm: function () {\r\n\t\t\tvar discounts_are_valid = saveItems(true, true);\r\n\t\t}\r\n\t});\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction save2PaymentsAndBookOrder(payment2Type, payment1Data, token)\r\n{\r\n\r\n\tintenseLogging(\"save2PaymentsAndBookOrder() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\t\tif (!max_plate_points_deduction)\r\n\t\t{\r\n\t\t\tmax_plate_points_deduction = 0;\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tadd_payment_data: payment2Data,\r\n\t\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, json.warnOfOutstandingSavedOrdersOnFullSession, false, false, payment1Data);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction savePayment2(payment2Type, warnOfOutstandingSavedOrdersOnFullSession, token)\r\n{\r\n\r\n\tintenseLogging(\"savePayment2() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'add_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment2Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"savePayment2() add_payment successful\");\r\n\r\n\t\t\t\t\tif (warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, warnOfOutstandingSavedOrdersOnFullSession, false, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction handleDirectPayment(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"handleDirectPayment() called\");\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\t// Handle Payment 1 for certain\r\n\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\tvar DP_State = 0;\r\n\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t{\r\n\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\tif (DP_State == 1)\r\n\t\t{\r\n\t\t\tDP_State = 4;\r\n\t\t} // translate to CPayment constants - for now\r\n\t\tif (DP_State == 2)\r\n\t\t{\r\n\t\t\tDP_State = 5;\r\n\t\t}\r\n\r\n\t\tif (DP_State > 0)\r\n\t\t{\r\n\t\t\t// TODO: validate amounts\r\n\t\t}\r\n\t}\r\n\r\n\tvar use_store_credits = false;\r\n\tvar store_credit_amount = 0;\r\n\tif ($(\"#use_store_credits\").length)\r\n\t{\r\n\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t{\r\n\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\tuse_store_credits = true;\r\n\t\t}\r\n\t}\r\n\r\n\tvar mainPaymentData = null;\r\n\tvar additionalPaymentData = null;\r\n\r\n\tif (payment2Type)\r\n\t{\r\n\t\tmainPaymentData = getPaymentData(payment2Type, 2);\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t}\r\n\t\t}\r\n\t\tadditionalPaymentData = payment1Data;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmainPaymentData = payment1Data;\r\n\t}\r\n\r\n\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\tif (!max_plate_points_deduction)\r\n\t{\r\n\t\tmax_plate_points_deduction = 0;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: store_id,\r\n\t\t\top: 'save_payment',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tpayment_data: mainPaymentData,\r\n\t\t\tadd_payment_data: additionalPaymentData,\r\n\t\t\tdelay_remainder: DP_State,\r\n\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\tdd_csrf_token: token,\r\n\t\t\tpayment2Type: payment2Type\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"handleDirectPayment() save_payment successful\");\r\n\r\n\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tif (strError == 'timeout')\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Order Processing Timed Out',\r\n\t\t\t\t\tmessage: \"The request to finalized the order has timed out. This may be due to network congestion. The order may have been successful. The page will refresh and show the actual current status.\",\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t'Refresh': function () {\r\n\t\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onAddPaymentAndActivate(addOnly, go_to_confirm, token)\r\n{\r\n\tintenseLogging(\"onAddPaymentAndActivate() called\");\r\n\treturn handleDirectPayment(addOnly, go_to_confirm, token);\r\n}\r\n\r\nfunction RetrieveCalendar(timestamp)\r\n{\r\n\tintenseLogging(\"RetrieveCalendar() called\");\r\n\r\n\tvar op = 'retrieve_new';\r\n\tif (orderState != 'SAVED')\r\n\t{\r\n\t\top = 'retrieve_for_reschedule';\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'GET',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_calendarProcessorDelivered',\r\n\t\t\tstore_id: store_id,\r\n\t\t\taction: op,\r\n\t\t\tcur_session_id: session_id,\r\n\t\t\ttimestamp: timestamp,\r\n\t\t\tservice_days: service_days_for_current_zip\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar() successful\");\r\n\t\t\t\t$(\"#calendar_holder\").html(json.data);\r\n\t\t\t\thandleSessionSelection();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"RetrieveCalendar: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDayClick(obj)\r\n{\r\n}\r\n\r\nfunction doReschedule(id, sessionTime)\r\n{\r\n\tvar curSessionDate = $(\"#curSessionDate\").html();\r\n\r\n\tdd_message({\r\n\t\ttitle: 'Reschedule',\r\n\t\tmessage: '<div style=\"text-align: center;\"><div>From</div><div style=\"font-weight: bold;\">' + curSessionDate + '</div><div>to</div><div style=\"font-weight: bold;\">' + sessionTime + '</div>',\r\n\t\tmodal: true,\r\n\t\tconfirm: function () {\r\n\r\n\t\t\tvar org_session_id = session_id;\r\n\t\t\tsession_id = id;\r\n\t\t\tReschedule(org_session_id);\r\n\r\n\t\t},\r\n\t\topen: function () {\r\n\r\n\t\t\t$(this).siblings('.ui-dialog-buttonpane').find(\"button:contains('Confirm')\").focus();\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onRescheduleClick(id, sessionTime, isDiscounted, control_message)\r\n{\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tif (control_message == \"locked\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"You cannot reschedule to this session as it is in the previous calendar month and all activity for that month has been locked and finalized.\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tdoReschedule(id, sessionTime);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSessionClick(id, sessionTime, isDiscounted)\r\n{\r\n\t// Obsolete - delivered orders always set a session based on current date and service days\r\n\tintenseLogging(\"onSessionClick() called .................... please investiage should not occur for Delivered order\");\r\n\r\n}\r\n\r\nfunction monthChange(monthVal)\r\n{\r\n\tRetrieveCalendar(monthVal);\r\n}\r\n\r\nfunction handleSummaryDisplayChange(obj)\r\n{\r\n\tif (obj.checked)\r\n\t{\r\n\t\tShowAllLineItems();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tHideLineItemsIfZero();\r\n\t}\r\n}\r\n\r\nfunction HideLineItemsIfZero()\r\n{\r\n\r\n\tvar deliveryFeeOrg = Number($('#OEH_subtotal_delivery_fee_org').html());\r\n\tvar deliveryFee = Number($('#OEH_subtotal_delivery_fee').html());\r\n\r\n\tif (deliveryFeeOrg == 0 && deliveryFee == 0)\r\n\t{\r\n\t\t$('#DeliveryFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryFeeRow').show();\r\n\t}\r\n\r\n\tvar doDiscountOrg = Number($('#OEH_direct_order_discount_org').html());\r\n\tvar doDiscount = Number($('#OEH_direct_order_discount').html());\r\n\r\n\tif (doDiscountOrg == 0 && doDiscount == 0)\r\n\t{\r\n\t\t$('#directDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#directDiscountRow').show();\r\n\t}\r\n\r\n\tvar couponDiscountOrg = Number($('#OEH_coupon_discount_org').html());\r\n\tvar couponDiscount = Number($('#OEH_coupon_discount').html());\r\n\r\n\tif (couponDiscountOrg == 0 && couponDiscount == 0)\r\n\t{\r\n\t\t$('#couponDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#couponDiscountRow').show();\r\n\t}\r\n\r\n\tvar membershipDiscountOrg = Number($('#OEH_membership_discount_org').html());\r\n\tvar membershipDiscount = Number($('#OEH_membership_discount').html());\r\n\r\n\tif (membershipDiscountOrg == 0 && membershipDiscount == 0)\r\n\t{\r\n\t\t$('#membershipDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#membershipDiscountRow').show();\r\n\t}\r\n\r\n\tvar foodTaxOrg = Number($('#OEH_food_tax_subtotal_org').html());\r\n\tvar foodTax = Number($('#OEH_food_tax_subtotal').html());\r\n\r\n\tif (foodTaxOrg == 0 && foodTax == 0)\r\n\t{\r\n\t\t$('#foodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#foodTaxRow').show();\r\n\t}\r\n\r\n\tvar nonFoodTaxOrg = Number($('#OEH_tax_subtotal_org').html());\r\n\tvar nonFoodTax = Number($('#OEH_tax_subtotal').html());\r\n\r\n\tif (nonFoodTaxOrg == 0 && nonFoodTax == 0)\r\n\t{\r\n\t\t$('#nonFoodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxRow').show();\r\n\t}\r\n\r\n\tvar deliveryTaxOrg = Number($('#OEH_delivery_tax_subtotal_org').html());\r\n\tvar deliveryTax = Number($('#OEH_delivery_tax_subtotal').html());\r\n\r\n\tif (deliveryTaxOrg == 0 && deliveryTax == 0)\r\n\t{\r\n\t\t$('#DeliveryTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryTaxRow').show();\r\n\t}\r\n\r\n\tvar ddOrg = Number($('#OEH_plate_points_order_discount_fee_org').html());\r\n\tvar dd = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\tdd = isNaN(dd)? 0:dd;\r\n\tddOrg = isNaN(ddOrg)? 0:ddOrg;\r\n\r\n\tif (ddOrg == 0 && dd == 0)\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').show();\r\n\t}\r\n\r\n}\r\n\r\nfunction ShowAllLineItems()\r\n{\r\n\t$('#DeliveryFeeRow').show();\r\n\t$('#directDiscountRow').show();\r\n\t$('#couponDiscountRow').show();\r\n\t$('#foodTaxRow').show();\r\n\t$('#nonFoodTaxRow').show();\r\n\t$('#dinnerDollarsDiscountRow').show();\r\n}\r\n\r\nfunction sort_by_price(a, b)\r\n{\r\n\tif (a.price == b.price)\r\n\t{\r\n\t\treturn 0;\r\n\t}\r\n\r\n\treturn (a.price < b.price) ? 1 : -1;\r\n}\r\n\r\nfunction drawChangeList()\r\n{\r\n\tvar html = getChangeListHTML();\r\n\t$(\"#changelist\").html(html);\r\n\r\n}\r\n\r\nfunction getChangeListHTML()\r\n{\r\n\r\n\tvar htmlStr = \"\";\r\n\tvar first = true;\r\n\r\n\tlet editedExistingBoxHTML = {};\r\n\tlet existingNewBoxHTML = {};\r\n\r\n\tfor (var thisBox in changeList.box_contents)\r\n\t{\r\n\t\tif (changeList.box_contents.hasOwnProperty(thisBox))\r\n\t\t{\r\n\t\t\tlet tempHTML = \"\";\r\n\r\n\t\t\tfor (var thisItem in changeList.box_contents[thisBox])\r\n\t\t\t{\r\n\t\t\t\tlet item_name = $(\"#qty_\" + thisBox + \"_\" + thisItem).data('title');\r\n\r\n\t\t\t\tif (changeList.box_contents[thisBox][thisItem] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\ttempHTML += \"-Added \" + changeList.box_contents[thisBox][thisItem] + \" \" + item_name + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\ttempHTML += \"-Removed \" + changeList.box_contents[thisBox][thisItem] + \" \" + item_name + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!changeList.boxes[thisBox])\r\n\t\t\t{\r\n\t\t\t\t// an existing boxes contents have changed\r\n\r\n\t\t\t\tif (first)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"<h3>Edited Boxes</h3><ul style='margin: 4px;'>\";\r\n\t\t\t\t\tfirst = false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\t\teditedExistingBoxHTML[thisBox] = \"Box: \" + title + \"<br />\" + tempHTML;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\texistingNewBoxHTML[thisBox] = tempHTML;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tvar first = true;\r\n\r\n\tfor (var box_inst_id in changeList.boxes)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Added Boxes</h3><ul style='margin: 0px; padding: 0px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.boxes.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\tif (changeList.boxes[box_inst_id] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.boxes[box_inst_id] + \" <i>\" + title + \"</i> \";\r\n\r\n\t\t\t\tif (existingNewBoxHTML[box_inst_id])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"<br />\" + existingNewBoxHTML[box_inst_id];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.boxes[box_inst_id] * -1 + \"<i>\" + boxesDeletedFromActiveOrder[box_inst_id] + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tfor (var box_inst_id in editedExistingBoxHTML)\r\n\t{\r\n\t\tif (editedExistingBoxHTML.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\thtmlStr += editedExistingBoxHTML[box_inst_id];\r\n\t\t}\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tvar hadMiscCostChanges = false;\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\t\thadMiscCostChanges = true;\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (!hadMiscCostChanges && first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.reporting)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Reporting</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.reporting.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (item == 'fundraiser')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse if (changeList.reporting[item][\"orgVal\"] > 0 && changeList.reporting[item][\"orgVal\"] != changeList.reporting[item][\"newVal\"])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Changed \" + getHumanReadableName(item) + \" to \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (item == 'fundraiser_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == false)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was removed from the order.'\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was added to the order.'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.coupon)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.coupon.change_type = 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Added coupon code: \" + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type = 'removed')\r\n\t\t{\r\n\t\t\thtmlStr += \"Removed coupon code: \" + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type = 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Change coupon code to: \" + \"<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment2_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\t}\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction getHumanReadableName(id)\r\n{\r\n\tswitch (id)\r\n\t{\r\n\t\tcase 'direct_order_discount':\r\n\t\t\treturn \"Direct Order Discount\";\r\n\t\tcase 'plate_points_discount':\r\n\t\t\treturn \"Dinner Dollars\";\r\n\t\tcase \"misc_food_subtotal\":\r\n\t\t\treturn \"Miscellaneous Food Cost\";\r\n\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\treturn \"Miscellaneous Non-food Cost\";\r\n\t\tcase \"subtotal_service_fee\":\r\n\t\t\treturn \"Service Fee\";\r\n\t\tcase \"subtotal_delivery_fee\":\r\n\t\t\treturn \"Delivery Fee\";\r\n\t\tcase 'misc_food_subtotal_desc':\r\n\t\t\treturn 'Misc Food Description';\r\n\t\tcase 'misc_nonfood_subtotal_desc':\r\n\t\t\treturn 'Misc Non-food Description';\r\n\t\tcase 'service_fee_description':\r\n\t\t\treturn 'Service Fee Description';\r\n\t\tcase 'session_discount':\r\n\t\t\treturn 'Session Discount';\r\n\t\tcase 'fundraiser':\r\n\t\t\treturn 'Fundraiser';\r\n\t\tcase 'fundraiser_value':\r\n\t\t\treturn 'Fundraiser Value';\r\n\t\tcase 'ltd_roundup_value':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up Value';\r\n\t\tcase 'ltd_roundup':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up';\r\n\t\tdefault:\r\n\t\t\treturn 'error';\r\n\t}\r\n}\r\n\r\nfunction getAbbreviatedSummaryString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\r\n\thtmlStr += \"<h3>Delivered Order</h3>\";\r\n\r\n\tvar first = true;\r\n\tfor (var box_inst_id in changeList.boxes)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Added Boxes</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.boxes.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\tif (changeList.boxes[box_inst_id] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.boxes[box_inst_id] + \"<i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.boxes[box_inst_id] * -1 + \"<i>\" + boxesDeletedFromActiveOrder[box_inst_id] + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif (curVal > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += getHumanReadableName(this.id) + \" costs of $\" + formatAsMoney(curVal);\r\n\r\n\t\t\t\tvar descIDStr = \"\";\r\n\r\n\t\t\t\tswitch (this.id)\r\n\t\t\t\t{\r\n\t\t\t\t\tcase \"misc_food_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_food_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_nonfood_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"subtotal_service_fee\":\r\n\t\t\t\t\t\tdescIDStr = \"service_fee_description\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar desc = null;\r\n\t\t\t\tif (descIDStr != \"\")\r\n\t\t\t\t{\r\n\t\t\t\t\tdesc = $(\"#\" + descIDStr).val();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (desc)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \". <span>( \" + desc + \" )</span><br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \".<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\t// Discounts\r\n\r\n\tvar discountsHTML = \"\";\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() > 0)\r\n\t\t{\r\n\t\t\tdiscountsHTML += getHumanReadableName(this.id) + \" applied.<br />\";\r\n\t\t}\r\n\t});\r\n\r\n\tif (discountsHTML != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Discounts</h3>\" + discountsHTML;\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction updateChangeList()\r\n{\r\n\r\n\tlet itemChanges = false;\r\n\tlet discountChanges = false;\r\n\tlet reportingChanges = false;\r\n\r\n\tlet discountOrPaymentChanges = false;\r\n\tlet showSaveButton = false;\r\n\r\n\tchangeList = {};\r\n\tchangeList.stdMenuItems = {};\r\n\tchangeList.FTMenuItems = {};\r\n\tchangeList.miscCosts = {};\r\n\tchangeList.miscDescs = {};\r\n\tchangeList.bundleItems = {};\r\n\tchangeList.order_type = \"\";\r\n\tchangeList.discounts = {};\r\n\tchangeList.reporting = {};\r\n\tchangeList.delivery = {};\r\n\tchangeList.boxes = {}\r\n\tchangeList.box_contents = {}\r\n\r\n\tfor (var box_inst in current_box_ids)\r\n\t{\r\n\t\tcurrent_box_ids[box_inst] = 0;\r\n\t}\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\t\tcurrent_box_ids[list_id] = 1;\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\tif (!$(this).data(\"is_saved\"))\r\n\t\t\t{\r\n\t\t\t\tchangeList.boxes[list_id] = 1;\r\n\t\t\t\titemChanges = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif (!$(this).data(\"is_saved\"))\r\n\t\t\t{\r\n\t\t\t\tchangeList.boxes[list_id] = 1;\r\n\t\t\t\titemChanges = true;\r\n\r\n\t\t\t\t// also need to see it contents changed\r\n\t\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\t\tlet curQty = $(this).val();\r\n\t\t\t\t\tlet savedQty = $(this).data('claimed_qty');\r\n\t\t\t\t\tlet menu_item_id = $(this).data('menu_item_id');\r\n\r\n\t\t\t\t\tif (curQty != savedQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!changeList.box_contents[list_id])\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tchangeList.box_contents[list_id] = {};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tchangeList.box_contents[list_id][menu_item_id] = curQty - savedQty\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t// also need to see it contents changed\r\n\t\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\t\tlet curQty = $(this).val();\r\n\t\t\t\t\tlet savedQty = $(this).data('claimed_qty');\r\n\t\t\t\t\tlet menu_item_id = $(this).data('menu_item_id');\r\n\r\n\t\t\t\t\tif (curQty != savedQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!changeList.box_contents.list_id)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tchangeList.box_contents.list_id = {};\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tchangeList.box_contents.list_id[menu_item_id] = curQty - savedQty\r\n\t\t\t\t\t\titemChanges = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tfor (var box_inst in current_box_ids)\r\n\t{\r\n\t\tif (current_box_ids[box_inst] == 0)\r\n\t\t{\r\n\t\t\tchangeList.boxes[box_inst] = -1;\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function ()\r\n\t{\r\n\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tchangeList.FTMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.stdMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\t*/\r\n\r\n\t// Misc Costs\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif (curVal == undefined || curVal == \"\")\r\n\t\t{\r\n\t\t\tcurVal = \"0.00\";\r\n\t\t}\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tif (itemChanges)\r\n\t{\r\n\t\t$(\"#items_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\t// Discounts\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t// we're not  tracking description fields for now\r\n\t\t\tchangeList.discounts[this.id] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// coupons\r\n\tvar orgCouponVal = $(\"#org_coupon_id\").val();\r\n\tvar curCouponVal = $(\"#coupon_id\").val();\r\n\r\n\tif (orgCouponVal != curCouponVal)\r\n\t{\r\n\t\tdiscountOrPaymentChanges = true;\r\n\r\n\t\tif (orgCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"added\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse if (curCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//removed\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"removed\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"changed\"\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (deliveryChanges)\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#payments_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && (showSaveButton || $('#use_store_credit').is(':checked')))\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && ($('#use_store_credit').is(':checked') || paymentChanges))\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\r\n\t}\r\n\r\n\tif (orderState == 'ACTIVE' || discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").show();\r\n\t\tif (showSaveButton || paymentChanges || $('#use_store_credits').is(':checked'))\r\n\t\t{\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", true);\r\n\t\t\t$(\"#finalize_msg\").hide();\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (itemChanges || discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#changeListTab\").addClass('unsaved_data_list');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#changeListTab\").removeClass('unsaved_data_list');\r\n\t}\r\n\r\n\tdrawChangeList();\r\n}\r\n\r\nfunction handleAutoAdjust(obj)\r\n{\r\n\t// called when the document is loaded or when the \"autoAdjust\" check box changes\r\n\r\n\t// if checked then setup the amounts to be credited/debited\r\n\tif (obj.checked)\r\n\t{\r\n\t\tvar balance = Number($('#OEH_remaing_balance').html());\r\n\r\n\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || balance > 0))\r\n\t\t{\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('DPADJUST');\r\n\t\t\t\tchangePayment1('DPADJUST');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tadjustPendingDelayedPayment(balance);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('REFERENCE');\r\n\t\t\t\tchangePayment1('REFERENCE');\r\n\t\t\t}\r\n\r\n\t\t\tassignBalanceToRefTransactions(balance);\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\t$('#payment1_type').val('');\r\n\t\t\tchangePayment1('');\r\n\t\t}\r\n\r\n\t\t// also clear any credits\r\n\t\tfor (ident in existingPaymentAmountArray)\r\n\t\t{\r\n\t\t\t$('#Cr_RT_' + ident).val(\"\");\r\n\t\t}\r\n\r\n\t\t// or if trying to credit\r\n\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n}\r\n\r\nfunction getAbbreviatedChangeString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\tvar addedStd = 0;\r\n\tvar removedStd = 0;\r\n\r\n\tvar htmlStr = \"\";\r\n\r\n\tif (needPlatePointsMaxDiscountChangeWarning)\r\n\t{\r\n\t\thtmlStr += \"<div style='color:red;'>Warning: The amount discountable by Dinner Dollars has changed. You may wish to review and adjust the Dinner Dollars discount.</div>\";\r\n\r\n\t}\r\n\tvar first = true;\r\n\tfor (var box_inst_id in changeList.boxes)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Added Boxes</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.boxes.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\tif (changeList.boxes[box_inst_id] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.boxes[box_inst_id] + \"<i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.boxes[box_inst_id] * -1 + \"<i>\" + boxesDeletedFromActiveOrder[box_inst_id] + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif ($('#autoAdjust').is(\":checked\"))\r\n\t{\r\n\t\thtmlStr += \"<span style='color:red'>Auto-Adjust is checked and will \" + $(\"#adj_action\").html() + \"</span>\";\r\n\r\n\t}\r\n\r\n\thtmlStr = \"<div id='finalize_changes_div'>\" + htmlStr + \"</div>\";\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction addPaymentToLockedOrder()\r\n{\r\n\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\tvar billing_address = $(\"#billing_address_1\").val();\r\n\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_token',\r\n\t\t\torder_id: order_id,\r\n\t\t\tamount: amt,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tbilling_name: billing_name,\r\n\t\t\tbilling_address: billing_address,\r\n\t\t\tbilling_zip: billing_zip,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val(),\r\n\t\t\tchain_token: true\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder() get_token successful\");\r\n\r\n\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\tsend(token, 1, false, true, true, false);\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction submitPage()\r\n{\r\n\tintenseLogging(\"submitPage() called\");\r\n\r\n\tvar form = $(\"#editorForm\")[0];\r\n\r\n\tvar is_valid = confirm_and_check_form(form);\r\n\r\n\tif (is_valid)\r\n\t{\r\n\t\tvar message = \"This can not be undone. Are you sure you want to submit the changes?\";\r\n\t\tvar changesBlurb = getAbbreviatedChangeString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tvar dialogHeight = 460;\r\n\r\n\t\tif (message.length < 128)\r\n\t\t{\r\n\t\t\tdialogHeight = 160;\r\n\t\t}\r\n\t\telse if (message.length < 256)\r\n\t\t{\r\n\t\t\tdialogHeight = 260;\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Finalize',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: dialogHeight,\r\n\t\t\tconfirm: function () {\r\n\r\n\t\t\t\tif (supports_transparent_redirect && $(\"#payment1_type\").val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"submitPage() confirmed\");\r\n\r\n\t\t\t\t\tif (!discountEligable.limited_access)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tupdateActiveOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\taddPaymentToLockedOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeList',\r\n\t\t\t\t\t\tvalue: JSON.stringify(changeList)\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeListStr',\r\n\t\t\t\t\t\tvalue: getChangeListHTML()\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$(\"#submit_changes\").val(\"true\");\r\n\t\t\t\t\t$(\"#editorForm\").submit();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n}\r\n\r\nfunction resetPage()\r\n{\r\n\tintenseLogging(\"resetPage() called\");\r\n\r\n\tbounce(window.location.href);\r\n}\r\n\r\nfunction confirm_and_check_form(form)\r\n{\r\n\r\n\tintenseLogging(\"confirm_and_check_form() called\");\r\n\r\n\tif (orderState == 'NEW' || orderState == 'SAVED')\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn _check_form(form);\r\n}\r\n\r\n// rounds to the nearest penny\r\n// move to global once this is found to be reliable\r\nfunction dd_round_amount(inAmount)\r\n{\r\n\tinAmount += .000005;\r\n\r\n\tvar tempVal = inAmount * 1000.0;\r\n\ttempVal = parseInt(tempVal);\r\n\ttempVal = tempVal / 10;\r\n\tvar pennyFraction = tempVal - Math.floor(tempVal);\r\n\tif (pennyFraction >= .5)\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal) + 1;\r\n\t}\r\n\telse\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal);\r\n\t}\r\n\r\n\treturn tempVal / 100;\r\n}\r\n\r\n/*\r\n\r\n function reportTestFailure(testNum, actual, correct)\r\n {\r\n if (actual != correct)\r\n {\r\n alert(\"Test #: \" + testNum + \" actual: \" + actual + \" correct: \" + correct);\r\n }\r\n }\r\n\r\n function doTests()\r\n {\r\n\r\n var testmultiplier = \".5\";\r\n\r\n var testNum = \"260.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(1, newResult, 130.05);\r\n\r\n var testNum = \"209.10\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(2, newResult, 104.55);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(3, newResult, 104.55);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(4, newResult, 104.5);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(5, newResult, .5);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(6, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(7, newResult, .03);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(8, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(9, newResult, 250);\r\n\r\n var testNum = \"209.10\";\r\n var testmultiplier = \".12\";\r\n\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(10, newResult, 25.09);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(11, newResult, 25.09);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(12, newResult, 25.08);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(13, newResult, .12);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(14, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(15, newResult, .01);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(16, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(17, newResult, 60);\r\n\r\n }\r\n\r\n doTests();\r\n\r\n */\r\n\r\n// this massive function is called anytime something that affects costs or payments is altered\r\nfunction calculateTotal()\r\n{\r\n\r\n\tvar total = 0;\r\n\tvar servings = 0;\r\n\tvar productsSubTotal = 0;\r\n\tvar discounted_total = 0;\r\n\tvar main_items_count = 0;\r\n\tvar num_boxes = 0;\r\n\r\n\tfor (var x in entreeIDToInventoryMap)\r\n\t{\r\n\t\tentreeIDToInventoryMap[x].remaining = entreeIDToInventoryMap[x].org_remaining;\r\n\t\t$('#inv_' + x).html(entreeIDToInventoryMap[x].org_remaining + \"/serv\");\r\n\t}\r\n\r\n\t// ---------------------------------------------------------- Items\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet box_local_id = this.id.split(\"_\")[2];\r\n\r\n\t\tlet cost = $(this).data(\"box_price\");\r\n\t\tlet items_in_box = $(this).data(\"number_items_required\");\r\n\t\tlet servings_in_box = $(this).data(\"number_servings_required\");\r\n\t\ttotal += (cost * 1);\r\n\t\tmain_items_count += items_in_box;\r\n\t\tservings += servings_in_box;\r\n\t\tnum_boxes++;\r\n\t});\r\n\r\n\tdiscounted_total = total;\r\n\r\n\t// update the entree and serving totals display\r\n\t$('#OEH_item_count').html(main_items_count);\r\n\t$('#OEH_number_servings').html(servings);\r\n\t$('#OEH_number_boxes').html(num_boxes);\r\n\r\n\tdiscounted_total = Math.round(discounted_total * 100) / 100;\r\n\r\n\t// --------------------------------------------------------------------- menu items subtotal\r\n\t$('#orderSubTotal').val(formatAsMoney(Math.round(total * 100) / 100));\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney(discounted_total));\r\n\t$('#orderTotal').val(formatAsMoney(discounted_total));\r\n\r\n\t// ------------------------------------------------------ food subtotal\r\n\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney((discounted_total * 1)));\r\n\r\n\tvar newGrandTotal = discounted_total;\r\n\tvar pre_discounts_grand_total = newGrandTotal;\r\n\r\n\t// -------------------------------DISCOUNTS-----------------------------------------\r\n\t// ---------------------------------------------- Direct Order\r\n\tvar directDiscountVal = Number(0);\r\n\r\n\tdirectDiscount = $('#direct_order_discount');\r\n\r\n\tif (directDiscount.length)\r\n\t{\r\n\t\tdirectDiscountVal = directDiscount.val();\r\n\r\n\t\tif (isNaN(directDiscountVal))\r\n\t\t{\r\n\t\t\tdirectDiscountVal = 0;\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal > pre_discounts_grand_total)\r\n\t\t{\r\n\t\t\tdirectDiscountVal = pre_discounts_grand_total;\r\n\t\t\tdirectDiscount.val(directDiscountVal);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal)\r\n\t\t{\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - directDiscountVal);\r\n\t\t}\r\n\r\n\t\t$('#OEH_direct_order_discount').html(formatAsMoney(directDiscountVal));\r\n\r\n\t}\r\n\r\n\t//----------------------------------------------------Dinner Dollars\r\n\tdiscountablePlatePointsAmount = handleDinnerDollars(newGrandTotal);\r\n\r\n\t// ------------------------------------------------------------------- coupon Discount\r\n\r\n\tif (couponDiscountMethod == 'PERCENT')\r\n\t{\r\n\t\tvar newDiscountAmount = Math.floor(pre_discounts_grand_total * (couponDiscountVar));\r\n\t\tnewDiscountAmount /= 100;\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tvar couponDiscountVal = Number(0);\r\n\tcouponDiscount = $('#couponValue');\r\n\r\n\tif (couponDiscount.length)\r\n\t{\r\n\t\tif (couponDiscount.val() == \"\")\r\n\t\t{\r\n\t\t\tcouponDiscount.val('0.00');\r\n\t\t}\r\n\t\tcouponDiscountVal = couponDiscount.val();\r\n\t}\r\n\r\n\tvar couponDiscountValIsDeliveryFee = false;\r\n\r\n\tif (typeof coupon != 'undefined' && coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t{\r\n\t\tvar currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\t\tif (couponDiscountVal != currentDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponDiscountVal = currentDeliveryFee;\r\n\t\t\t$('#couponValue').val(couponDiscountVal);\r\n\r\n\t\t}\r\n\r\n\t\tcouponDiscountValIsDeliveryFee = true;\r\n\t}\r\n\r\n\tif (couponDiscountVal)\r\n\t{\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - couponDiscountVal);\r\n\t\t$('#OEH_coupon_discount').html(formatAsMoney(couponDiscountVal));\r\n\t}\r\n\r\n\tvar curPPDiscount = 0;\r\n\t// ----------------------------------------------  PLATEPOINTS Discount\r\n\tif ($('#plate_points_discount').length)\r\n\t{\r\n\t\tcurPPDiscount = $('#plate_points_discount').val();\r\n\t\tif (curPPDiscount * 1 > discountablePlatePointsAmount * 1)\r\n\t\t{\r\n\t\t\tcurPPDiscount = discountablePlatePointsAmount;\r\n\r\n\t\t\tif (curPPDiscount == 0)\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(\"\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(formatAsMoney(curPPDiscount));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(curPPDiscount));\r\n\r\n\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - curPPDiscount);\r\n\t}\r\n\r\n\t// ----------------------------------------------------------Membership Discount\r\n\r\n\tif (orderIsEligibleForMembershipDiscount && storeSupportsMembership)\r\n\t{\r\n\t\tvar couponAdjustment = Number(0);\r\n\t\tif (couponDiscountValIsServiceFee || couponDiscountValIsDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponAdjustment = couponDiscountVal;\r\n\t\t}\r\n\r\n\t\tvar membership_discount_basis = Number((newGrandTotal * 1) + (couponAdjustment * 1));\r\n\t\tvar memberDiscountAmount = Number(membership_discount_basis * (membership_status.discount_var / 100));\r\n\t\tmemberDiscountAmount = Math.round(memberDiscountAmount * 100) / 100;\r\n\r\n\t\t$(\"#OEH_membership_discount\").html(formatAsMoney(memberDiscountAmount));\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - memberDiscountAmount);\r\n\r\n\t}\r\n\r\n\tvar deliveryFee = Number(0);\r\n\tif ($('#subtotal_delivery_fee')[0])\r\n\t{\r\n\t\tdeliveryFee = Number($('#subtotal_delivery_fee').val());\r\n\t\t$('#OEH_subtotal_delivery_fee').html(formatAsMoney(deliveryFee));\r\n\r\n\t\tnewGrandTotal = Number((newGrandTotal * 1) + (deliveryFee * 1));\r\n\r\n\t\tvar newFoodTotal = newGrandTotal - (deliveryFee * 1);\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------- tax\r\n\tvar newFoodTax = 0;\r\n\tvar avalaraCalcTax = 0;\r\n\tvar newDeliveryTax = 0;\r\n\r\n\tif (orderState != \"NEW\" && newFoodTotal > 0)\r\n\t{\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: false,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\top: 'retrieve_sales_tax',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tstore_id: store_id,\r\n\t\t\t\tsubtotal_all_items: newGrandTotal,\r\n\t\t\t\tsubtotal_delivery_fee: deliveryFee\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tintenseLogging(\"retrieving Sales tax\");\r\n\r\n\t\t\t\tavalaraCalcTax = json.subtotal_food_sales_taxes;\r\n\t\t\t\tnewDeliveryTax = json.subtotal_delivery_tax;\r\n\r\n\t\t\t\t$('#OEH_food_tax_subtotal').text(formatAsMoney(avalaraCalcTax));\r\n\t\t\t\t$('#OEH_delivery_tax_subtotal').text(formatAsMoney(newDeliveryTax));\r\n\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\t\tintenseLogging(\"retrieving Sales tax: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tvar newNonFoodTax = 0; // convert to float\r\n\tif (productsSubTotal)\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food & Enrollment Tax');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food Tax');\r\n\r\n\t}\r\n\r\n\tnewFoodTax = formatAsMoney(avalaraCalcTax);\r\n\r\n\ttaxElem = document.getElementById('OEH_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newNonFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_food_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_delivery_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newDeliveryTax);\r\n\t}\r\n\r\n\tvar preTaxTotal = Number(newGrandTotal);\r\n\tnewGrandTotal = (newGrandTotal * 1) + (newFoodTax * 1) + (newNonFoodTax * 1) + (newDeliveryTax * 1);\r\n\r\n\t// -------------------------------------------------------------------- grand total\r\n\t$('#OEH_grandtotal').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_new_total').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_delta').html(formatAsMoney((orderInfoGrandTotal - newGrandTotal) * -1));\r\n\r\n\tvar paymentTotal = 0;\r\n\tif ($('#OEH_paymentsTotal').length)\r\n\t{\r\n\t\tpaymentTotal = $('#OEH_paymentsTotal').html();\r\n\t}\r\n\r\n\tvar remainingBalance = Number(formatAsMoney(paymentTotal - newGrandTotal));\r\n\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance * -1));\r\n\r\n\t// Values are now calculated and the summary display updated\r\n\t// Next Display \"balance\" messages and set up payments\r\n\r\n\tif (orderState == 'CANCELLED')\r\n\t{\r\n\t\tremainingBalance = paymentTotal;\r\n\t\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance));\r\n\r\n\t}\r\n\r\n\tif (remainingBalance > 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to the customer.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_customer_owed');\r\n\t\t$(\"#newPaymentDiv\").hide();\r\n\r\n\t\tif (canAdjustDelayedPayment && currentDPAmount > 0)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').show();\r\n\t\t}\r\n\r\n\t\t$('#payment1_type').val('');\r\n\t\t$('#payment2_type').val('');\r\n\t\tchangePayment1('');\r\n\t\tchangePayment2('');\r\n\r\n\t\tpaymentChanges = true;\r\n\r\n\t\t$(\"#use_store_credits\").prop('checked', false);\r\n\t\t$(\"#use_store_credits\").prop('disabled', true);\r\n\r\n\t}\r\n\telse if (remainingBalance < 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to your store.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_store_owed');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tvar doNewLivePaymentAdjustments = true;\r\n\t\tif (doNewLivePaymentAdjustments)\r\n\t\t{\r\n\r\n\t\t\tvar defaultPaymentAmount = remainingBalance * -1;\r\n\r\n\t\t\tif ($(\"#use_store_credits\").is(\":checked\"))\r\n\t\t\t{\r\n\r\n\t\t\t\tvar amountStoreCredit = Number($(\"#store_credits_amount\").val());\r\n\t\t\t\tif (isNaN(amountStoreCredit.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tamountStoreCredit = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount -= amountStoreCredit.valueOf();\r\n\t\t\t}\r\n\r\n\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount);\r\n\r\n\t\t\tif ($('#payment1_type').val() == 'CC')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val() == 'CHECK')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if (($('#payment1_type').val() == 'GIFT_CERT' || $('#payment1_type').val() == \"GIFT_CARD\") && $('#payment2_type').val() != \"\")\r\n\t\t\t{\r\n\t\t\t\tvar payment1Amount = null;\r\n\t\t\t\tif ($('#payment1_type').val() == 'GIFT_CERT')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#payment1_gc_total_amount').val());\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment1_type').val() == 'GIFT_CARD')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#debit_gift_card_amount').val());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isNaN(payment1Amount.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount - payment1Amount.valueOf());\r\n\t\t\t\tif ($('#payment2_type').val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CHECK')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CASH')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cash_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse // == 0\r\n\t{\r\n\t\t$(\"#balance_msg\").html(\"0.00\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_balanced');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tassignBalanceToRefTransactions(0);\r\n\t}\r\n\r\n\tvar autoAdjustDiv = $('#autoAdjustDiv');\r\n\tif (autoAdjustDiv.length)\r\n\t{\r\n\r\n\t\tif (remainingBalance != 0 && canAutoAdjust)\r\n\t\t{\r\n\t\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || remainingBalance < 0))\r\n\t\t\t{\r\n\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>adjust customer's delayed payment.</b></span>\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (remainingBalance > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>credit customer's credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>charge original credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tautoAdjustDiv.show();\r\n\t\t\tif (!forceManualAutoAdjust)\r\n\t\t\t{\r\n\t\t\t\t$('#autoAdjust').prop('checked', true);\r\n\t\t\t\thandleAutoAdjust($('#autoAdjust').get()[0]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// if the div is hidden skip these steps\r\n\r\n\t\t\tif (autoAdjustDiv.is(\":visible\"))\r\n\t\t\t{\r\n\t\t\t\tautoAdjustDiv.hide();\r\n\t\t\t\t$('#autoAdjust').prop('checked', false);\r\n\t\t\t\t$('#payment1_type').val('');\r\n\t\t\t\t$('#payment2_type').val('');\r\n\t\t\t\tchangePayment1('');\r\n\t\t\t\tchangePayment2('');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$('#help_msg').html(\"\");\r\n\r\n\t// enforce a few rules by disallowing checkout\r\n\tif ($('#submit_changes').length)\r\n\t{\r\n\r\n\t\tif (servings > 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", false);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal >= (Number(preTaxTotal) + Number(directDiscountVal)) && preTaxTotal != 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t\t$('#help_msg').html($('#help_msg').html() + \"You cannot use a Direct Order Discount that is equal to or greater than the food cost total. Please use the \\\"No Charge\\\" payment type to give away an order.\");\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($('#help_msg').length)\r\n\t{\r\n\t\tif ($('#help_msg').html() != \"\")\r\n\t\t{\r\n\t\t\t$('#help_msg').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#help_msg').hide();\r\n\t\t}\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n\r\n\tHideLineItemsIfZero();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n}\r\n\r\nfunction handleDinnerDollars(total){\r\n\r\n\r\n\t//var serviceFee = Number(document.getElementById('OEH_subtotal_delivery_fee').value);\r\n\tvar discountablePlatePointsAmount = total;// + serviceFee.valueOf();\r\n\r\n\tif (discountablePlatePointsAmount != lastMaxPPDiscountAmount && lastMaxPPDiscountAmount != -1)\r\n\t{\r\n\t\tneedPlatePointsMaxDiscountChangeWarning = true;\r\n\t}\r\n\r\n\tlastMaxPPDiscountAmount = discountablePlatePointsAmount;\r\n\r\n\tif (discountablePlatePointsAmount < 0) discountablePlatePointsAmount = 0;\r\n\r\n\t$(\"#max_plate_points_deduction\").html(formatAsMoney(discountablePlatePointsAmount))\r\n\r\n\tvar maxPPCredit = $(\"#plate_points_available\").html() * 1;\r\n\tvar maxPPDeduction = $(\"#max_plate_points_deduction\").html() * 1;\r\n\tvar curPPDiscount = $(\"#plate_points_discount\").val() * 1;\r\n\r\n\tif (maxPPDeduction < curPPDiscount)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").val(maxPPDeduction);\r\n\t}\r\n\r\n\tif (maxPPCredit > maxPPDeduction)\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').hide();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_fee').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').show();\r\n\t}\r\n\r\n\r\n\r\n\treturn discountablePlatePointsAmount;\r\n}\r\n\r\n$(document).on('change', '#shipping_phone_number', function (e) {\r\n\r\n\t$('.shipping_phone_number_new_div').hideFlex();\r\n\t$('#shipping_phone_number_new').prop('required', false);\r\n\r\n\tif ($(this).val() == 'new')\r\n\t{\r\n\t\t$('.shipping_phone_number_new_div').showFlex();\r\n\t\t$('#shipping_phone_number_new').prop('required', true);\r\n\r\n\t}\r\n});\r\n\r\n$(document).on('change keyup', '.delivery-input', function (e) {\r\n\r\n\tdeliveryChanges = false;\r\n\r\n\t$('.delivery-input').each(function () {\r\n\r\n\t\tif ($(this).data('org_value'))\r\n\t\t{\r\n\t\t\tvar val = $(this).val();\r\n\t\t\tvar org_value = $(this).data('org_value');\r\n\r\n\t\t\tif (val != org_value)\r\n\t\t\t{\r\n\t\t\t\tdeliveryChanges = true;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n});\r\n$(document).on('change', '#address_book_select', function (e) {\r\n\r\n\tlet id = $(this).val();\r\n\r\n\tif (id)\r\n\t{\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\top: 'retrieve_address_from_address_book',\r\n\t\t\t\taddress_id: id,\r\n\t\t\t\tuser_id: user_id\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#shipping_firstname').val(json.address.firstname);\r\n\t\t\t\t\t$('#shipping_lastname').val(json.address.lastname);\r\n\t\t\t\t\t$('#shipping_address_line1').val(json.address.address_line1);\r\n\t\t\t\t\t$('#shipping_address_line2').val(json.address.address_line2);\r\n\t\t\t\t\t$('#shipping_city').val(json.address.city);\r\n\t\t\t\t\t$('#shipping_state_id').val(json.address.state_id);\r\n\t\t\t\t\t$('#shipping_postal_code').val(json.address.postal_code);\r\n\t\t\t\t\t$('#shipping_address_note').val(json.address.address_note);\r\n\t\t\t\t\t$('#shipping_phone_number').val(json.address.telephone_1);\r\n\t\t\t\t\t$('#shipping_gift_email_address').val(json.address.email_address);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Address Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n});"],"names":["itemChanges","discountOrPaymentChanges","deliveryChanges","discountChanges","reportingChanges","paymentChanges","changeList","currentlySavingOrder","intenseLoggingOn","boxesDeletedFromActiveOrder","needPlatePointsMaxDiscountChangeWarning","lastMaxPPDiscountAmount","admin_order_mgr_init","store_id","STORE_DETAILS","id","orderState","setupForNewOrder","setupForSavedOrder","setupForActiveOrder","initChangeList","init_inside_box_editing","calculateTotal","setAllPaymentFieldsToUnrequired","setupCouponState","setUpKeyHandlers","handle_special_instruction_notes","handle_cancel_order_delivered","handle_delete_saved_order_delivered","handle_free_menu_item_edit","handleDirectOrderDiscountFocusing","$","trigger","updateInventory","handle_is_gift","handleSessionSelection","on","selected_session_id","this","data","sessionDate","doReschedule","is","show","hide","validateBoxes","hasAtLeastOneBox","noCustomBoxesAreIncomplete","each","list_id","split","itemCount","filter","val","number_items_required","countItemsInBox","box_instance_id","retVal","off","itemError","boxError","menu_item_id","box_inst_id","newQty","curTotal","delta","isNaN","Math","floor","lastQty","servings","recipeID","new_servings_needed","current_inventory","html","updateChangeList","dd_message","title","message","addToInitialInventory","curAmount","curInv","initial_inventory","adjInv","document","e","bundle_id","box_id","box_type","box_label","ajax","url","type","timeout","dataType","processor","op","menu_id","order_id","user_id","success","json","processor_success","append","currentDeliveryFee","newDeliveryFee","Number","formatAsMoney","bundle_info","price_shipping","processor_message","error","objAJAXRequest","strError","response","remove","Object","assign","claimedAmount","recipe_id","focus","length","select","blur","curVal","trim","intenseLogging","window","console","log","saveSpecialInstructions","special_instructions","strip_tags","updateInstructionsOrgValues","responseText","booking_id","do_op","do","note","textarea_elem","addClass","special_instruction_note","removeClass","nl2br","onkeypress","OMDefaultKeyHandler","evt","event","charCode","which","keyCode","processCode","stopPropagation","lastCheckedGiftCertNumber","getChangeListHTML","height","width","modal","div_id","dialogClass","noOk","position","my","at","of","close","ui","updateItemsOrgValues","saveAll","saveItems","saveDiscountsUponCompletion","activateOnSaveDiscountsCompletion","dd_toast","boxList","subtotal_delivery_fee","items","itemTabIsDirty","saveDiscounts","setShipToAddressAndSaveOrder","shipping_data","order_state","bounce","Reschedule","org_session_id","session_id","saved_booking_id","new_session_id","new_session_time","new_ship_time","RetrieveCalendar","onSaveItems","HideLineItemsIfZero","timestamp","getQueryVariable","attr","discountEligable","limited_access","click","find","prop","isDeliveryAddressComplete","validated","onDeliveryTabSelected","onDeliveryTabDeselected","onSessionTabSelected","onSessionTabDeselected","onItemsTabSelected","onItemsTabDeselected","onPaymentTabSelected","onPaymentTabDeselected","onNotesTabSelected","handle_guest_account_notes","handle_admin_carryover_notes","handle_admin_order_notes","onNotesTabDeselected","onPaymentSelected","onPaymentDeselected","updateDiscountOrgValues","_validate_discounts","_validate_address","validationSuccess","payOnCompletion","direct_order_discount","dinner_dollars_discount","coupon_id","coupon_free_menu_item","plate_points_discount","updateReportingOrgValues","couponFreeMenuItem","onAddPaymentAndActivate","paymentToken","getPaymentData","payment_number","paymentData","number","amount","cert_type","ccNameOnCard","ccType","ccMonth","ccYear","cc_security_code","billing_address","billing_postal_code","is_store_specific_flat_rate_deposit_delayed_payment","do_not_ref","save_card","DPSetting","alert","indexOf","reference_id","validatePayment1","inputArray","validates","substr","_check_elements","depositWarningStr","CC1Amount","store_specific_deposit","validatePayment2","addPaymentAndActivate","changesBlurb","getAbbreviatedSummaryString","confirm","discounts_are_valid","save2PaymentsAndBookOrder","payment2Type","payment1Data","token","payment2Data","supports_transparent_redirect","DP_State","max_plate_points_deduction","async","payment_data","add_payment_data","delay_remainder","dd_csrf_token","warnOfOutstandingSavedOrdersOnFullSession","billing_name","billing_zip","amt","chain_token","getTokenToken","send","savePayment2","handleDirectPayment","addOnly","go_to_confirm","payment1Type","displayModalWaitDialog","use_store_credits","store_credit_amount","mainPaymentData","additionalPaymentData","store_credits_amount","closeOnEscape","buttons","Refresh","location","href","action","cur_session_id","service_days","service_days_for_current_zip","onDayClick","obj","sessionTime","curSessionDate","open","siblings","onRescheduleClick","isDiscounted","control_message","onSessionClick","monthChange","monthVal","handleSummaryDisplayChange","checked","ShowAllLineItems","deliveryFeeOrg","deliveryFee","doDiscountOrg","doDiscount","couponDiscountOrg","couponDiscount","membershipDiscountOrg","membershipDiscount","foodTaxOrg","foodTax","nonFoodTaxOrg","nonFoodTax","deliveryTaxOrg","deliveryTax","ddOrg","dd","sort_by_price","a","b","price","drawChangeList","htmlStr","first","editedExistingBoxHTML","existingNewBoxHTML","thisBox","box_contents","hasOwnProperty","tempHTML","thisItem","item_name","boxes","hadMiscCostChanges","item","miscCosts","getHumanReadableName","miscDescs","order_type","discounts","reporting","coupon","change_type","ccRefundTotal","parseFloat","descIDStr","desc","discountsHTML","valueOf","showSaveButton","stdMenuItems","FTMenuItems","bundleItems","delivery","box_inst","current_box_ids","curQty","savedQty","orgVal","undefined","newVal","diff","orgCouponVal","curCouponVal","handleAutoAdjust","balance","canAdjustDelayedPayment","currentDPAmount","changePayment1","adjustPendingDelayedPayment","assignBalanceToRefTransactions","ident","existingPaymentAmountArray","reportPaymentStatus","getAbbreviatedChangeString","addedStd","removedStd","addPaymentToLockedOrder","submitPage","form","is_valid","confirm_and_check_form","dialogHeight","updateActiveOrder","name","value","JSON","stringify","appendTo","submit","resetPage","_check_form","dd_round_amount","inAmount","tempVal","parseInt","pennyFraction","total","productsSubTotal","discounted_total","main_items_count","num_boxes","x","entreeIDToInventoryMap","remaining","org_remaining","box_local_id","cost","items_in_box","servings_in_box","round","newGrandTotal","pre_discounts_grand_total","directDiscountVal","directDiscount","discountablePlatePointsAmount","handleDinnerDollars","couponDiscountMethod","newDiscountAmount","couponDiscountVal","couponDiscountValIsDeliveryFee","limit_to_delivery_fee","discount_method","curPPDiscount","orderIsEligibleForMembershipDiscount","storeSupportsMembership","couponAdjustment","couponDiscountValIsServiceFee","membership_discount_basis","memberDiscountAmount","membership_status","discount_var","newFoodTotal","newFoodTax","avalaraCalcTax","newDeliveryTax","subtotal_all_items","subtotal_food_sales_taxes","subtotal_delivery_tax","text","newNonFoodTax","taxElem","getElementById","innerHTML","preTaxTotal","orderInfoGrandTotal","paymentTotal","remainingBalance","changePayment2","doNewLivePaymentAdjustments","defaultPaymentAmount","amountStoreCredit","payment1Amount","autoAdjustDiv","canAutoAdjust","forceManualAutoAdjust","get","maxPPCredit","maxPPDeduction","platePointsDiscountOrg","platePointsDiscount","hideFlex","showFlex","org_value","address_id","address","firstname","lastname","address_line1","address_line2","city","state_id","postal_code","address_note","telephone_1","email_address"],"mappings":"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"}