{"version":3,"file":"order_mgr_delivered.min.js","names":["itemChanges","discountOrPaymentChanges","deliveryChanges","discountChanges","reportingChanges","paymentChanges","changeList","currentlySavingOrder","intenseLoggingOn","boxesDeletedFromActiveOrder","needPlatePointsMaxDiscountChangeWarning","lastMaxPPDiscountAmount","admin_order_mgr_init","store_id","STORE_DETAILS","id","orderState","setupForNewOrder","setupForSavedOrder","setupForActiveOrder","initChangeList","init_inside_box_editing","calculateTotal","setAllPaymentFieldsToUnrequired","setupCouponState","setUpKeyHandlers","handle_special_instruction_notes","handle_cancel_order_delivered","handle_delete_saved_order_delivered","handle_free_menu_item_edit","handleDirectOrderDiscountFocusing","$","trigger","updateInventory","handle_is_gift","handleSessionSelection","on","doReschedule","this","data","is","show","hide","validateBoxes","hasAtLeastOneBox","noCustomBoxesAreIncomplete","each","list_id","split","itemCount","filter","val","countItemsInBox","box_instance_id","retVal","off","itemError","boxError","box_inst_id","number_items_required","newQty","curTotal","delta","isNaN","Math","floor","lastQty","servings","recipeID","new_servings_needed","current_inventory","html","updateChangeList","dd_message","title","message","addToInitialInventory","curAmount","adjInv","initial_inventory","Object","assign","recipe_id","focus","e","length","select","blur","curVal","trim","intenseLogging","window","console","log","saveSpecialInstructions","special_instructions","strip_tags","ajax","url","type","timeout","dataType","processor","user_id","op","order_id","success","json","processor_success","updateInstructionsOrgValues","processor_message","error","objAJAXRequest","strError","responseText","response","booking_id","do_op","do","note","textarea_elem","addClass","special_instruction_note","removeClass","nl2br","document","onkeypress","OMDefaultKeyHandler","evt","event","charCode","which","keyCode","processCode","stopPropagation","lastCheckedGiftCertNumber","getChangeListHTML","height","width","modal","div_id","dialogClass","noOk","position","my","at","of","close","ui","remove","updateItemsOrgValues","saveAll","saveItems","saveDiscountsUponCompletion","activateOnSaveDiscountsCompletion","dd_toast","boxList","subtotal_delivery_fee","items","itemTabIsDirty","saveDiscounts","setShipToAddressAndSaveOrder","shipping_data","order_state","bounce","Reschedule","org_session_id","session_id","saved_booking_id","new_session_id","new_session_time","new_ship_time","RetrieveCalendar","onSaveItems","HideLineItemsIfZero","getQueryVariable","attr","discountEligable","limited_access","click","find","prop","isDeliveryAddressComplete","validated","onDeliveryTabSelected","onDeliveryTabDeselected","onSessionTabSelected","onSessionTabDeselected","onItemsTabSelected","onItemsTabDeselected","onPaymentTabSelected","onPaymentTabDeselected","onNotesTabSelected","handle_guest_account_notes","handle_admin_carryover_notes","handle_admin_order_notes","onNotesTabDeselected","onPaymentSelected","onPaymentDeselected","updateDiscountOrgValues","_validate_discounts","_validate_address","validationSuccess","payOnCompletion","direct_order_discount","dinner_dollars_discount","coupon_id","plate_points_discount","updateReportingOrgValues","onAddPaymentAndActivate","paymentToken","getPaymentData","payment_number","paymentData","number","amount","cert_type","ccNameOnCard","ccType","ccMonth","ccYear","cc_security_code","billing_address","billing_postal_code","is_store_specific_flat_rate_deposit_delayed_payment","do_not_ref","save_card","DPSetting","alert","indexOf","reference_id","validatePayment1","inputArray","validates","substr","_check_elements","depositWarningStr","store_specific_deposit","validatePayment2","addPaymentAndActivate","getAbbreviatedSummaryString","confirm","save2PaymentsAndBookOrder","payment2Type","payment1Data","token","payment2Data","supports_transparent_redirect","billing_name","billing_zip","amt","async","dd_csrf_token","chain_token","getTokenToken","send","warnOfOutstandingSavedOrdersOnFullSession","DP_State","max_plate_points_deduction","payment_data","add_payment_data","delay_remainder","savePayment2","handleDirectPayment","addOnly","go_to_confirm","payment1Type","displayModalWaitDialog","use_store_credits","store_credit_amount","mainPaymentData","additionalPaymentData","store_credits_amount","closeOnEscape","buttons","Refresh","location","href","timestamp","action","cur_session_id","service_days","service_days_for_current_zip","onDayClick","obj","sessionTime","curSessionDate","open","siblings","onRescheduleClick","isDiscounted","control_message","onSessionClick","monthChange","monthVal","handleSummaryDisplayChange","checked","ShowAllLineItems","deliveryFeeOrg","Number","deliveryFee","doDiscountOrg","doDiscount","couponDiscountOrg","couponDiscount","membershipDiscountOrg","membershipDiscount","foodTaxOrg","foodTax","nonFoodTaxOrg","nonFoodTax","deliveryTaxOrg","deliveryTax","ddOrg","dd","sort_by_price","a","b","price","drawChangeList","htmlStr","first","editedExistingBoxHTML","existingNewBoxHTML","thisBox","box_contents","hasOwnProperty","tempHTML","thisItem","item_name","boxes","hadMiscCostChanges","item","miscCosts","getHumanReadableName","formatAsMoney","miscDescs","order_type","discounts","reporting","coupon","change_type","ccRefundTotal","parseFloat","descIDStr","desc","discountsHTML","valueOf","showSaveButton","box_inst","stdMenuItems","FTMenuItems","bundleItems","delivery","current_box_ids","curQty","savedQty","menu_item_id","orgVal","undefined","newVal","diff","orgCouponVal","curCouponVal","handleAutoAdjust","balance","canAdjustDelayedPayment","currentDPAmount","changePayment1","adjustPendingDelayedPayment","assignBalanceToRefTransactions","ident","existingPaymentAmountArray","reportPaymentStatus","getAbbreviatedChangeString","addPaymentToLockedOrder","submitPage","form","confirm_and_check_form","dialogHeight","updateActiveOrder","name","value","JSON","stringify","appendTo","submit","resetPage","_check_form","dd_round_amount","inAmount","tempVal","parseInt","total","discounted_total","main_items_count","num_boxes","x","entreeIDToInventoryMap","remaining","org_remaining","cost","items_in_box","servings_in_box","round","newGrandTotal","pre_discounts_grand_total","directDiscountVal","directDiscount","discountablePlatePointsAmount","handleDinnerDollars","couponDiscountMethod","newDiscountAmount","couponDiscountVal","couponDiscountValIsDeliveryFee","limit_to_delivery_fee","discount_method","currentDeliveryFee","curPPDiscount","orderIsEligibleForMembershipDiscount","storeSupportsMembership","couponAdjustment","couponDiscountValIsServiceFee","membership_discount_basis","memberDiscountAmount","membership_status","discount_var","newFoodTotal","newFoodTax","avalaraCalcTax","newDeliveryTax","subtotal_all_items","subtotal_food_sales_taxes","subtotal_delivery_tax","text","taxElem","getElementById","innerHTML","preTaxTotal","orderInfoGrandTotal","paymentTotal","remainingBalance","changePayment2","defaultPaymentAmount","amountStoreCredit","payment1Amount","autoAdjustDiv","canAutoAdjust","forceManualAutoAdjust","get","maxPPCredit","maxPPDeduction","platePointsDiscountOrg","platePointsDiscount","bundle_id","box_id","box_type","box_label","menu_id","append","newDeliveryFee","bundle_info","price_shipping","hideFlex","showFlex","address_id","address","firstname","lastname","address_line1","address_line2","city","state_id","postal_code","address_note","telephone_1","email_address"],"sourceRoot":"js/src/dreamdinners/admin","sources":["order_mgr_delivered.js"],"sourcesContent":["var itemChanges = false;\r\nvar discountOrPaymentChanges = false;\r\nvar deliveryChanges = false;\r\nvar discountChanges = false;\r\nvar reportingChanges = false;\r\nvar paymentChanges = false;\r\nvar changeList = null;\r\nvar currentlySavingOrder = false;\r\nvar intenseLoggingOn = true;\r\nvar boxesDeletedFromActiveOrder = []; // for showing box deletions in change list\r\n\r\nvar needPlatePointsMaxDiscountChangeWarning = false;\r\nvar lastMaxPPDiscountAmount = -1;\r\n\r\nfunction admin_order_mgr_init()\r\n{\r\n\r\n\tif (store_id != STORE_DETAILS.id)\r\n\t{\r\n\t\tSTORE_DETAILS.id = store_id;\r\n\r\n\t\t//STORE_DETAILS.id is either the current fadmin store - in which case a match is guaranteed or\r\n\t\t// is the current Site Admin store (last selection from a store drop down.) However in this case if the order was accessed by the address\r\n\t\t// bar a match is not guaranteed so force STORE_DETAILS.id to store_id which is always the store of the order\r\n\t}\r\n\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetupForNewOrder();\r\n\t}\r\n\telse if (orderState == 'SAVED')\r\n\t{\r\n\t\tsetupForSavedOrder();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetupForActiveOrder();\r\n\t}\r\n\r\n\tinitChangeList();\r\n\tinit_inside_box_editing();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tcalculateTotal();\r\n\t\tsetAllPaymentFieldsToUnrequired();\r\n\t\tsetupCouponState();\r\n\t}\r\n\r\n\tsetUpKeyHandlers();\r\n\r\n\thandle_special_instruction_notes();\r\n\thandle_cancel_order_delivered();\r\n\thandle_delete_saved_order_delivered();\r\n\r\n\thandle_free_menu_item_edit();\r\n\thandleDirectOrderDiscountFocusing();\r\n\r\n\t$('#shipping_phone_number').trigger('change');\r\n\r\n\tupdateInventory();\r\n\r\n\thandle_is_gift();\r\n\r\n}\r\n\r\nfunction handleSessionSelection()\r\n{\r\n\t$(\"[data-select_delivery_day]\").on('click', function () {\r\n\t\tlet selected_session_id = $(this).data(\"select_delivery_day\");\r\n\t\tlet sessionDate = $(this).data(\"date\");\r\n\t\tdoReschedule(selected_session_id, sessionDate);\r\n\t});\r\n\r\n}\r\n\r\nfunction handle_is_gift()\r\n{\r\n\tif ($(\"#shipping_is_gift\").is(':checked'))\r\n\t{\r\n\t\t$(\".shipping_email_address_div\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\".shipping_email_address_div\").hide();\r\n\t}\r\n\r\n\t$(\"#shipping_is_gift\").on('change', function () {\r\n\t\tif ($(this).is(':checked'))\r\n\t\t{\r\n\t\t\t$(\".shipping_email_address_div\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\".shipping_email_address_div\").hide();\r\n\t\t}\r\n\t});\r\n\r\n}\r\n\r\nfunction validateBoxes()\r\n{\r\n\tlet hasAtLeastOneBox = false;\r\n\tlet noCustomBoxesAreIncomplete = true;\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\thasAtLeastOneBox = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\thasAtLeastOneBox = true;\r\n\r\n\t\t\tlet itemCount = 0;\r\n\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\titemCount += ($(this).val() * 1);\r\n\t\t\t});\r\n\r\n\t\t\tlet number_items_required = $(\"#box_inst_id_\" + list_id).data(\"number_items_required\");\r\n\r\n\t\t\tif (number_items_required != itemCount)\r\n\t\t\t{\r\n\t\t\t\tnoCustomBoxesAreIncomplete = false;\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\treturn (hasAtLeastOneBox && noCustomBoxesAreIncomplete);\r\n}\r\n\r\nfunction countItemsInBox(box_instance_id)\r\n{\r\n\tlet retVal = 0;\r\n\t$(\"[id^='qty_\" + box_instance_id + \"_']\").each(function () {\r\n\t\tretVal += ($(this).val() * 1);\r\n\t});\r\n\r\n\treturn retVal;\r\n}\r\n\r\nfunction init_inside_box_editing()\r\n{\r\n\r\n\t$(\"[id^='qty_']\").off('click', function () {\r\n\r\n\t});\r\n\r\n\t$(\"[id^='qty_']\").on('change', function () {\r\n\t\tlet itemError = false;\r\n\t\tlet boxError = false;\r\n\r\n\t\tlet menu_item_id = this.id.split(\"_\")[2];\r\n\t\tlet box_inst_id = this.id.split(\"_\")[1];\r\n\t\tlet number_items_required = $(\"#box_inst_id_\" + box_inst_id).data(\"number_items_required\");\r\n\t\tlet newQty = $(this).val();\r\n\r\n\t\tlet curTotal = countItemsInBox(box_inst_id);\r\n\t\tif (curTotal > number_items_required)\r\n\t\t{\r\n\t\t\tlet delta = curTotal - number_items_required;\r\n\t\t\t$(this).val(newQty - delta);\r\n\t\t\tboxError = true;\r\n\t\t}\r\n\r\n\t\tnewQty = $(this).val();\r\n\r\n\t\tif (isNaN(newQty))\r\n\t\t{\r\n\t\t\tnewQty = 0;\r\n\t\t\t$(this).val(0);\r\n\t\t}\r\n\t\tif (newQty < 0)\r\n\t\t{\r\n\t\t\tnewQty = 0;\r\n\t\t\t$(this).val(0);\r\n\t\t}\r\n\r\n\t\tif (newQty - Math.floor(newQty) != 0)\r\n\t\t{\r\n\t\t\tnewQty = Math.floor(newQty);\r\n\t\t\t$(this).val(newQty);\r\n\t\t}\r\n\r\n\t\tlet lastQty = $(this).data('last_qty'); // last quantity is already removed from current_inventory array\r\n\t\tvar servings = $(this).data('servings_per_item');\r\n\t\tvar recipeID = $(this).data('recipe_id');\r\n\r\n\t\tif (newQty > 2)\r\n\t\t{\r\n\t\t\titemError = true;\r\n\t\t\t$(this).val(2);\r\n\t\t\tnewQty = 2;\r\n\t\t}\r\n\r\n\t\tlet new_servings_needed = (newQty - lastQty) * servings;\r\n\r\n\t\twhile (new_servings_needed > current_inventory[recipeID])\r\n\t\t{\r\n\t\t\tnewQty--;\r\n\t\t\tnew_servings_needed = (newQty - lastQty) * servings;\r\n\t\t}\r\n\r\n\t\t$(this).val(newQty);\r\n\t\t$(this).data('last_qty', newQty);\r\n\t\tcurrent_inventory[recipeID] -= new_servings_needed;\r\n\r\n\t\t$(\"[id^='inv_']\").filter(\"[data-recipe_id='\" + recipeID + \"']\").html(current_inventory[recipeID] + \"/serv\");\r\n\r\n\t\tupdateChangeList();\r\n\r\n\t\tif (boxError && itemError)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"Each box can only have up to 2 of the same menu item and a total of \" + number_items_required + \" items.\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (itemError)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"Each box can only have up to 2 of the same menu item\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (boxError)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"You can only add a total of \" + number_items_required + \" items to this box.\"\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction addToInitialInventory(list_id)\r\n{\r\n\r\n\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t{\r\n\t\t$(\"[id^='qty_\" + list_id + \"_']\").each(function () {\r\n\t\t\tvar curAmount = $(this).val();\r\n\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\tvar curInv = initial_inventory[recipeID];\r\n\t\t\tvar adjInv = curInv + (curAmount * servings);\r\n\t\t\tinitial_inventory[recipeID] = adjInv;\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\tvar curAmount = $(this).val();\r\n\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\tvar curInv = current_inventory[recipeID];\r\n\t\t\tvar adjInv = curInv + (curAmount * servings);\r\n\t\t\tinitial_inventory[recipeID] = adjInv;\r\n\t\t});\r\n\t}\r\n}\r\n\r\n$(document).on('click', '.add_box', function (e) {\r\n\r\n\tlet bundle_id = $(this).data(\"bundle_id\");\r\n\tlet box_id = $(this).data(\"box_id\");\r\n\tlet box_type = $(this).data(\"box_type\");\r\n\tlet box_label = $(this).data(\"box_label\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\top: 'add_box',\r\n\t\t\tbundle_id: bundle_id,\r\n\t\t\tbox_id: box_id,\r\n\t\t\tbox_type: box_type,\r\n\t\t\tbox_label: box_label,\r\n\t\t\tmenu_id: menu_id,\r\n\t\t\tstore_id: store_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$(\"#box_editor\").append(json.html);\r\n\r\n\t\t\t\tlet currentDeliveryFee = $('#subtotal_delivery_fee').val();\r\n\t\t\t\tlet newDeliveryFee = Number(formatAsMoney(currentDeliveryFee)) + Number(formatAsMoney(json.bundle_info.price_shipping));\r\n\r\n\t\t\t\t$('#subtotal_delivery_fee').val(newDeliveryFee);\r\n\r\n\t\t\t\tupdateInventory();\r\n\t\t\t\tcalculateTotal();\r\n\t\t\t\tinit_inside_box_editing();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n});\r\n\r\n$(document).on('click', '.box-delete', function (e) {\r\n\r\n\tlet box_inst_id = $(this).data('box_instance_id');\r\n\r\n\tif (orderState == 'ACTIVE')\r\n\t{\r\n\t\tlet currentDeliveryFee = $('#subtotal_delivery_fee').val();\r\n\t\tlet newDeliveryFee = Number(formatAsMoney(currentDeliveryFee)) - Number(formatAsMoney($(\"#box_inst_id_\" + box_inst_id).data('price_shipping')));\r\n\r\n\t\t$('#subtotal_delivery_fee').val(newDeliveryFee);\r\n\r\n\t\t// active orders defer database updates until finalized\r\n\t\taddToInitialInventory(box_inst_id);\r\n\t\tboxesDeletedFromActiveOrder[box_inst_id] = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\t\t$(\"#bi_\" + box_inst_id).remove();\r\n\t\tupdateInventory();\r\n\t\tcalculateTotal();\r\n\t\treturn;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\top: 'delete_box',\r\n\t\t\tbox_inst_id: box_inst_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\t$(\"#bi_\" + box_inst_id).remove();\r\n\t\t\t\tupdateInventory();\r\n\t\t\t\tcalculateTotal();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n\r\n});\r\n\r\nfunction updateInventory()\r\n{\r\n\r\n\t// re init current values\r\n\tcurrent_inventory = Object.assign({}, initial_inventory);\r\n\r\n\t// loop through all existing boxes and accumulate values in current_inventory\r\n\t// after items have been accumulated push numbers to the display\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\t$(\"[id^='qty_\" + list_id + \"_']\").each(function () {\r\n\t\t\t\tvar curAmount = $(this).val();\r\n\t\t\t\tvar claimedAmount = $(this).data('claimed_qty');\r\n\t\t\t\tcurAmount -= claimedAmount;\r\n\t\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\t\tvar curInv = current_inventory[recipeID];\r\n\t\t\t\tvar adjInv = curInv - (curAmount * servings);\r\n\t\t\t\tcurrent_inventory[recipeID] = adjInv;\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\tvar curAmount = $(this).val();\r\n\t\t\t\tvar claimedAmount = $(this).data('claimed_qty');\r\n\t\t\t\tcurAmount -= claimedAmount;\r\n\t\t\t\tvar recipeID = $(this).data('recipe_id');\r\n\t\t\t\tvar servings = $(this).data('servings_per_item');\r\n\t\t\t\tvar curInv = current_inventory[recipeID];\r\n\t\t\t\tvar adjInv = curInv - (curAmount * servings);\r\n\t\t\t\tcurrent_inventory[recipeID] = adjInv;\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\tfor (const recipe_id in current_inventory)\r\n\t{\r\n\r\n\t\t$(\"[id^='inv_']\").filter(\"[data-recipe_id='\" + recipe_id + \"']\").each(function () {\r\n\r\n\t\t\t// TODO:  item < serving per item is also out of stock\r\n\t\t\tif (current_inventory[recipe_id] == 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).html('Out of stock');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(this).html(current_inventory[recipe_id] + \"/serv\");\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction handleDirectOrderDiscountFocusing()\r\n{\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").focus(function (e) {\r\n\r\n\t\tif ($(this).val() == 0)\r\n\t\t{\r\n\t\t\t$(this).val(\"\");\r\n\t\t}\r\n\t\tif ($(this).val().length > 0)\r\n\t\t{\r\n\t\t\t$(this).select();\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").blur(function (e) {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tcurVal = (curVal.trim());\r\n\r\n\t\tif (curVal == \"\" || isNaN(curVal))\r\n\t\t{\r\n\t\t\t$(this).val(\"0\");\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction intenseLogging(message)\r\n{\r\n\tif (window.console && intenseLoggingOn)\r\n\t{\r\n\t\tconsole.log('OM Intense logging: ' + message);\r\n\t}\r\n}\r\n\r\nfunction saveSpecialInstructions()\r\n{\r\n\r\n\tvar special_instructions = strip_tags($(\"#order_user_notes\").val());\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_special_instructions',\r\n\t\t\torder_id: order_id,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tupdateInstructionsOrgValues();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveSpecialInstructions: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"saveSpecialInstructions: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction handle_special_instruction_notes()\r\n{\r\n\t$('[id^=\"gd_special_instruction_note_button-\"]').each(function () {\r\n\r\n\t\t$(this).on('click', function (e) {\r\n\r\n\t\t\tvar booking_id = $(this).data('booking_id');\r\n\t\t\tvar user_id = $(this).data('user_id');\r\n\t\t\tvar do_op = 'get';\r\n\t\t\tvar special_instructions = '';\r\n\r\n\t\t\tif ($(this).data('edit_mode') == true)\r\n\t\t\t{\r\n\t\t\t\tdo_op = 'save';\r\n\r\n\t\t\t\tspecial_instructions = strip_tags($('#gd_special_instruction_note-' + booking_id + ' > textarea').val());\r\n\t\t\t}\r\n\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\t\top: 'update_special_instructions',\r\n\t\t\t\t\t'do': do_op,\r\n\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\tnote: special_instructions\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (do_op == 'get')\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar textarea_elem = $('<textarea></textarea>').addClass('form-control').val((json.special_instruction_note ? json.special_instruction_note : \"\")).on('keyup', function (e) {\r\n\r\n\t\t\t\t\t\t\t\tif ($(this).val() != strip_tags($(this).val()))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(this).val(strip_tags($(this).val()));\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).addClass('special_instruction_note_edit').html(textarea_elem);\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', true).html('Save Note');\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).data('special_instruction_note_value', (json.special_instruction_note ? json.special_instruction_note : \"\")).on('click', function (e) {\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + $(this).data('booking_id')).removeClass('special_instruction_note_edit').html($(this).data('special_instruction_note_value'));\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + $(this).data('booking_id')).data('edit_mode', false).html('Special Instructions');\r\n\r\n\t\t\t\t\t\t\t\t$(this).hide();\r\n\r\n\t\t\t\t\t\t\t}).show();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).removeClass('special_instruction_note_edit').html(nl2br(json.special_instruction_note));\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).hide();\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', false).html('Special Instructions');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\tintenseLogging(\"handle_special_instruction_notes: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\t\t\tresponse = 'Unexpected error';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction setUpKeyHandlers()\r\n{\r\n\tdocument.onkeypress = OMDefaultKeyHandler;\r\n\r\n\t$(\"#coupon_code\").on('keypress', function (evt) {\r\n\t\t// the enter key will submit a coupon code\r\n\t\tevt = (evt) ? evt : event;\r\n\t\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\t\tif (charCode == 13)\r\n\t\t{\r\n\t\t\tprocessCode();\r\n\t\t\tevt.stopPropagation();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#order_user_notes\").on('keypress', function (evt) {\r\n\t\tevt.stopPropagation();\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#payment1_gc_payment_number\").on('keyup', function (evt) {\r\n\r\n\t\tif ($(this).val().length == 15 && !isNaN($(this).val()) && $(this).val() != lastCheckedGiftCertNumber)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Warning',\r\n\t\t\t\tmessage: \"It appears that you may be entering a gift Card number. If so, select Gift Card from payment selector. This is the Certificate (Gift Certificate) payment type.\"\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tlastCheckedGiftCertNumber = $(this).val();\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n}\r\n\r\nfunction OMDefaultKeyHandler(evt)\r\n{\r\n\t// by default the document just eats the enter key\r\n\tevt = (evt) ? evt : event;\r\n\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\tif (charCode == 13)\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction initChangeList()\r\n{\r\n\t$(\"#changeListTab\").on('click', function () {\r\n\r\n\t\tvar html = getChangeListHTML();\r\n\r\n\t\tif (!html || html == \"\")\r\n\t\t{\r\n\t\t\thtml = \"<h3><i>No Changes</i></h3>\"\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Change List',\r\n\t\t\tmessage: html,\r\n\t\t\theight: 620,\r\n\t\t\twidth: 300,\r\n\t\t\tmodal: false,\r\n\t\t\tdiv_id: 'changelist',\r\n\t\t\tdialogClass: 'fixedDialog',\r\n\t\t\tnoOk: true,\r\n\t\t\tposition: {\r\n\t\t\t\tmy: \"left top\",\r\n\t\t\t\tat: \"left bottom\",\r\n\t\t\t\tof: this\r\n\t\t\t},\r\n\t\t\tclose: function (event, ui) {\r\n\t\t\t\t$(\"#changelist\").remove();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction updateItemsOrgValues()\r\n{\r\n\t// TODO\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction saveAll()\r\n{\r\n\tsaveItems(true, false, true);\r\n}\r\n\r\nfunction saveItems(saveDiscountsUponCompletion, activateOnSaveDiscountsCompletion)\r\n{\r\n\r\n\tintenseLogging(\"saveItems() called\");\r\n\r\n\tif (currentlySavingOrder)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Items are still being saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tdd_toast({\r\n\t\tmessage: 'Items Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\r\n\tif (activateOnSaveDiscountsCompletion)\r\n\t{\r\n\t\tif (!validateBoxes())\r\n\t\t{\r\n\t\t\t$(\"#activate_confirm\").remove();\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Problem with boxes',\r\n\t\t\t\tmessage: \"Please review the selected box(es) and ensure item counts are correct.\"\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\tvar boxList = {};\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\t\tboxList[list_id] = {};\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\t$(\"li[data-box_inst_id|='\" + list_id + \"']\").each(function () {\r\n\t\t\t\tboxList[list_id][$(this).data(\"menu_item_id\")] = 1;\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\tboxList[list_id][$(this).data(\"menu_item_id\")] = $(this).val();\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tvar subtotal_delivery_fee = $(\"#subtotal_delivery_fee\").val();\r\n\tif (isNaN(subtotal_delivery_fee))\r\n\t{\r\n\t\tsubtotal_delivery_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar special_instructions = $(\"#order_user_notes\").val();\r\n\r\n\tcurrentlySavingOrder = true;\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_items',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: boxList,\r\n\t\t\tsubtotal_delivery_fee: subtotal_delivery_fee,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tupdateItemsOrgValues();\r\n\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"saveItems() successful\");\r\n\r\n\t\t\t\tif (saveDiscountsUponCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDiscounts(activateOnSaveDiscountsCompletion);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"update_items: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tcurrentlySavingOrder = false;\r\n\t\t\tintenseLogging(\"update_items: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\n/*\r\nfunction saveDeliveryAddress(payOnCompletion, token)\r\n{\r\n\r\n\tvar shipping_data = {};\r\n\t$(\"[id^='shipping_']\").each(function(){\r\n\t\tshipping_data[this.id] = $(this).val();\r\n\t});\r\n\r\n\tintenseLogging(\"saveDeliveryAddress() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 200000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'save_delivery_address',\r\n\t\t\torder_id: order_id,\r\n\t\t\tshipping_data: shipping_data\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDeliveryAddress() successful\");\r\n\r\n\t\t\t\tdd_toast({\r\n\t\t\t\t\tmessage: 'Delivery Address Saved',\r\n\t\t\t\t\tposition: 'topcenter'\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, token);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"save_delivery_address: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"save_delivery_address: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\n */\r\n\r\nfunction setShipToAddressAndSaveOrder()\r\n{\r\n\r\n\tvar shipping_data = {};\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\t\tshipping_data[this.id] = $(this).val();\r\n\t});\r\n\r\n\tif ($(\"#shipping_is_gift\").is(\":checked\"))\r\n\t{\r\n\t\tshipping_data[\"shipping_is_gift\"] = \"on\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\tshipping_data[\"shipping_is_gift\"] = \"0\";\r\n\t}\r\n\r\n\tintenseLogging(\"setShipToAddressAndSaveOrder() called\");\r\n\r\n\t// similar to saveDeliveryAddress but no order id is passed\r\n\t// and the response to success is to expose the calendar\r\n\t// I.E., this is part of initializing a new order\r\n\t// A SAVED order will have been created when this call completes.\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 200000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'save_delivery_address',\r\n\t\t\tshipping_data: shipping_data,\r\n\t\t\torder_state: orderState,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"setShipToAddressAndSaveOrder() successful\");\r\n\t\t\t\tbounce(\"main.php?page=admin_order_mgr_delivered&order=\" + json.order_id + \"&atabs=mgr.sessionsTab\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"setShipToAddressAndSaveOrder: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"save_delivery_address: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction Reschedule(org_session_id)\r\n{\r\n\r\n\tintenseLogging(\"Reschedule() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'reschedule',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tsaved_booking_id: saved_booking_id,\r\n\t\t\torg_session_id: org_session_id,\r\n\t\t\torder_state: orderState\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"Reschedule() successful\");\r\n\r\n\t\t\t\tsession_id = json.new_session_id;\r\n\t\t\t\t$(\"#curSessionDate\").html(json.new_session_time);\r\n\t\t\t\t$(\"#curShipDate\").html(json.new_ship_time);\r\n\t\t\t\t$(\"#session\").val(json.new_session_id);\r\n\r\n\t\t\t\tRetrieveCalendar(0);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"reschedule: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"reschedule: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction onSaveItems()\r\n{\r\n\tintenseLogging(\"onSaveItems() called\");\r\n\r\n\tsaveItems(false, false, false);\r\n\treturn false;\r\n\r\n}\r\n\r\nfunction setupForNewOrder()\r\n{\r\n\tHideLineItemsIfZero();\r\n\tvar timestamp = getQueryVariable('month');\r\n\r\n}\r\n\r\nfunction setupForSavedOrder()\r\n{\r\n\tRetrieveCalendar(0);\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\t$(\"#addPaymentAndActivateButton\").attr('disabled', 'disabled');\r\n\t$(\"#items_tab_li\").removeClass(\"disabled\");\r\n\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n}\r\n\r\nfunction setupForActiveOrder()\r\n{\r\n\tif (discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").click();\r\n\t\t$(\"#items_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#sessions_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#discountsDiv\").find(\":input\").prop(\"disabled\", true);\r\n\t\t$(\"#discountsDiv\").find(\"*\").addClass(\"om_disabled\");\r\n\t}\r\n\r\n\t$(\"#addPaymentAndActivate\").hide();\r\n\r\n}\r\n\r\nfunction isDeliveryAddressComplete()\r\n{\r\n\tvar validated = true;\r\n\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\r\n\t\tif (!$(this).val() && $(this).attr('required'))\r\n\t\t{\r\n\t\t\tvalidated = false;\r\n\t\t}\r\n\t});\r\n\treturn validated;\r\n}\r\n\r\nfunction onDeliveryTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onDeliveryTabDeselected()\r\n{\r\n\t/*\r\n\tif (!isDeliveryAddressComplete())\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please check the Delivery Address and phone number fields for completeness.'\r\n\t\t});\r\n\r\n\t\treturn false;\r\n\t}\r\n*/\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction onSessionTabSelected()\r\n{\r\n\tRetrieveCalendar(0);\r\n}\r\n\r\nfunction onSessionTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onItemsTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onItemsTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\tif (itemTabIsDirty)\r\n\t\t{\r\n\t\t\tsaveItems(false, false, false);\r\n\t\t}\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentTabSelected()\r\n{\r\n}\r\n\r\nfunction onPaymentTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE' && (discountChanges || reportingChanges))\r\n\t{\r\n\t\tsaveDiscounts(false, false);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onNotesTabSelected()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_history',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$(\"#history_div\").html(json.html);\r\n\r\n\t\t\thandle_guest_account_notes();\r\n\r\n\t\t\thandle_admin_carryover_notes();\r\n\r\n\t\t\thandle_admin_order_notes();\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"get_history: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onNotesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentSelected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n}\r\n\r\nfunction onPaymentDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\t\tupdateChangeList();\r\n\t\tpaymentChanges = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = false;\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction updateDiscountOrgValues()\r\n{\r\n\r\n\t$(\"#org_coupon_id\").val($(\"#coupon_id\").val());\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction _validate_discounts()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction _validate_address()\r\n{/*\r\n\t$thisOrder->orderAddress->firstname = $shippingData['shipping_firstname'];\r\n\t$thisOrder->orderAddress->lastname = $shippingData['shipping_lastname'];\r\n\t$thisOrder->orderAddress->address_line1 = $shippingData['shipping_address_line1'];\r\n\t$thisOrder->orderAddress->address_line2 = $shippingData['shipping_address_line2'];\r\n\t$thisOrder->orderAddress->city = $shippingData['shipping_city'];\r\n\t$thisOrder->orderAddress->state_id = $shippingData['shipping_state_id'];\r\n\t$thisOrder->orderAddress->postal_code = $shippingData['shipping_postal_code'];\r\n\t$thisOrder->orderAddress->telephone_1 = (($shipping_phone_number == 'new') ? $shipping_phone_number_new : $shipping_phone_number);\r\n\t$thisOrder->orderAddress->address_note = trim(strip_tags($shipping_address_note));\r\n\t$thisOrder->orderAddress->email_address = $shipping_email_address;\r\n\t$thisOrder->orderAddress->is_gift = (!empty($shippingData['shipping_is_gift']) ? 1 : 0);\r\n*/\r\n\t// TODO: phone and email validation\r\n\r\n\tvalidationSuccess = true;\r\n\r\n\tif ($(\"#shipping_firstname\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_firstname\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_firstname\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_firstname\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_firstname\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_lastname\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_lastname\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_lastname\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_lastname\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_lastname\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_address_line1\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_address_line1\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_address_line1\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_address_line1\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_address_line1\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_city\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_city\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_city\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_city\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_city\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_state_id\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_state_id\").val().length == 0)\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_state_id\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_state_id\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\tif ($(\"#shipping_postal_code\").val().length != 5)\r\n\t{\r\n\t\t$(\"#shipping_postal_code\").removeClass(\"is-valid\");\r\n\t\t$(\"#shipping_postal_code\").addClass(\"is-invalid\");\r\n\t\tvalidationSuccess = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#shipping_postal_code\").removeClass(\"is-invalid\");\r\n\t\t$(\"#shipping_postal_code\").addClass(\"is-valid\");\r\n\t}\r\n\r\n\treturn validationSuccess;\r\n}\r\n\r\nfunction saveDiscounts(payOnCompletion)\r\n{\r\n\tintenseLogging(\"saveDiscounts() called\");\r\n\r\n\tif (!_validate_discounts())\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (!payOnCompletion)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Discounts Saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t}\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar dinner_dollars_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(dinner_dollars_discount))\r\n\t{\r\n\t\tdinner_dollars_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar coupon_id = 0;\r\n\tvar coupon_free_menu_item = 0;\r\n\tif ($(\"#coupon_id\").val())\r\n\t{\r\n\r\n\t\tcoupon_id = $(\"#coupon_id\").val();\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'update_discounts',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tplate_points_discount: dinner_dollars_discount,\r\n\t\t\tcoupon_id: coupon_id,\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDiscounts() successful\");\r\n\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\t\t\t\tupdateReportingOrgValues();\r\n\r\n\t\t\t\tif (coupon_free_menu_item)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#free_menu_item_coupon').attr('disabled', true);\r\n\t\t\t\t\tcouponFreeMenuItem = coupon_free_menu_item;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (!_validate_address())\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\tmessage: \"Please review and correct the shipping address.\"\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_discounts: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"update_discounts: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction updateReportingOrgValues()\r\n{\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction getPaymentData(type, payment_number)\r\n{\r\n\r\n\tif (type != 'CC')\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val()\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val(),\r\n\t\t\tccNameOnCard: \"\",\r\n\t\t\tccType: 'CC',\r\n\t\t\tccMonth: \"\",\r\n\t\t\tccYear: \"\",\r\n\t\t\tcc_security_code: \"\",\r\n\t\t\tbilling_address: \"\",\r\n\t\t\tbilling_postal_code: \"\",\r\n\t\t\tis_store_specific_flat_rate_deposit_delayed_payment: 0,\r\n\t\t\tdo_not_ref: 0\r\n\t\t}\r\n\t}\r\n\r\n\tif (payment_number == 1)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"REFERENCE\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_reference_total_amount\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CERT\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_gc_total_amount\").val();\r\n\t\t\t\tpaymentData.cert_type = $(\"#payment1_gift_cert_type\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_gc_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFUND_CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_refund_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_refund_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CREDIT\":\r\n\t\t\t\tpaymentData.amount = $(\"#OEH_remaing_balance\").html();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment1_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment1_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment1_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment1_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment1_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_1\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_1\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_1').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CARD\":\r\n\t\t\t\tpaymentData.amount = $(\"#debit_gift_card_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#debit_gift_card_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"DPADJUST\":\r\n\t\t\t\t// TODO: ???\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p1_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\r\n\t}\r\n\telse if (payment_number == 2)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment2_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment2_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment2_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment2_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment2_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_2\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_2').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p2_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\t}\r\n\r\n}\r\n\r\nfunction validatePayment1(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\t\tcase \"REFERENCE\":\r\n\t\t\tinputArray = $(\"#payment1_reference :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CERT\":\r\n\t\t\tinputArray = $(\"#payment1_gc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment1_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFUND_CASH\":\r\n\t\t\tinputArray = $(\"#payment1_refund_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment1_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CREDIT\":\r\n\t\t\tinputArray = $(\"#payment1_credit :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment1_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CARD\":\r\n\t\t\tinputArray = $(\"#payment1_debit_gift_card :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"DPADJUST\":\r\n\t\t\tinputArray = $(\"#dp_adjust_div :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment1_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n\r\n}\r\n\r\nfunction validatePayment2(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment2_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment2_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n}\r\n\r\nfunction addPaymentAndActivate()\r\n{\r\n\tintenseLogging(\"addPaymentAndActivate() called\");\r\n\r\n\t// always first ensure that discounts are updated on server\r\n\tvar message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\tvar changesBlurb = getAbbreviatedSummaryString();\r\n\t//message += \"<br /><br />\" + changesBlurb;\r\n\r\n\tdd_message({\r\n\t\tdiv_id: 'activate_confirm',\r\n\t\ttitle: 'Add Payment and Book Order',\r\n\t\tmessage: message,\r\n\t\tmodal: true,\r\n\t\twidth: 400,\r\n\t\theight: 180,\r\n\t\tconfirm: function () {\r\n\t\t\tvar discounts_are_valid = saveItems(true, true);\r\n\t\t}\r\n\t});\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction save2PaymentsAndBookOrder(payment2Type, payment1Data, token)\r\n{\r\n\r\n\tintenseLogging(\"save2PaymentsAndBookOrder() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\t\tif (!max_plate_points_deduction)\r\n\t\t{\r\n\t\t\tmax_plate_points_deduction = 0;\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tadd_payment_data: payment2Data,\r\n\t\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, json.warnOfOutstandingSavedOrdersOnFullSession, false, false, payment1Data);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction savePayment2(payment2Type, warnOfOutstandingSavedOrdersOnFullSession, token)\r\n{\r\n\r\n\tintenseLogging(\"savePayment2() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'add_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment2Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"savePayment2() add_payment successful\");\r\n\r\n\t\t\t\t\tif (warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, warnOfOutstandingSavedOrdersOnFullSession, false, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction handleDirectPayment(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"handleDirectPayment() called\");\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\t// Handle Payment 1 for certain\r\n\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\tvar DP_State = 0;\r\n\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t{\r\n\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\tif (DP_State == 1)\r\n\t\t{\r\n\t\t\tDP_State = 4;\r\n\t\t} // translate to CPayment constants - for now\r\n\t\tif (DP_State == 2)\r\n\t\t{\r\n\t\t\tDP_State = 5;\r\n\t\t}\r\n\r\n\t\tif (DP_State > 0)\r\n\t\t{\r\n\t\t\t// TODO: validate amounts\r\n\t\t}\r\n\t}\r\n\r\n\tvar use_store_credits = false;\r\n\tvar store_credit_amount = 0;\r\n\tif ($(\"#use_store_credits\").length)\r\n\t{\r\n\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t{\r\n\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\tuse_store_credits = true;\r\n\t\t}\r\n\t}\r\n\r\n\tvar mainPaymentData = null;\r\n\tvar additionalPaymentData = null;\r\n\r\n\tif (payment2Type)\r\n\t{\r\n\t\tmainPaymentData = getPaymentData(payment2Type, 2);\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t}\r\n\t\t}\r\n\t\tadditionalPaymentData = payment1Data;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmainPaymentData = payment1Data;\r\n\t}\r\n\r\n\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\tif (!max_plate_points_deduction)\r\n\t{\r\n\t\tmax_plate_points_deduction = 0;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: store_id,\r\n\t\t\top: 'save_payment',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tpayment_data: mainPaymentData,\r\n\t\t\tadd_payment_data: additionalPaymentData,\r\n\t\t\tdelay_remainder: DP_State,\r\n\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\tdd_csrf_token: token,\r\n\t\t\tpayment2Type: payment2Type\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"handleDirectPayment() save_payment successful\");\r\n\r\n\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tif (strError == 'timeout')\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Order Processing Timed Out',\r\n\t\t\t\t\tmessage: \"The request to finalized the order has timed out. This may be due to network congestion. The order may have been successful. The page will refresh and show the actual current status.\",\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t'Refresh': function () {\r\n\t\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onAddPaymentAndActivate(addOnly, go_to_confirm, token)\r\n{\r\n\tintenseLogging(\"onAddPaymentAndActivate() called\");\r\n\treturn handleDirectPayment(addOnly, go_to_confirm, token);\r\n}\r\n\r\nfunction RetrieveCalendar(timestamp)\r\n{\r\n\tintenseLogging(\"RetrieveCalendar() called\");\r\n\r\n\tvar op = 'retrieve_new';\r\n\tif (orderState != 'SAVED')\r\n\t{\r\n\t\top = 'retrieve_for_reschedule';\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'GET',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_calendarProcessorDelivered',\r\n\t\t\tstore_id: store_id,\r\n\t\t\taction: op,\r\n\t\t\tcur_session_id: session_id,\r\n\t\t\ttimestamp: timestamp,\r\n\t\t\tservice_days: service_days_for_current_zip\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar() successful\");\r\n\t\t\t\t$(\"#calendar_holder\").html(json.data);\r\n\t\t\t\thandleSessionSelection();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"RetrieveCalendar: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDayClick(obj)\r\n{\r\n}\r\n\r\nfunction doReschedule(id, sessionTime)\r\n{\r\n\tvar curSessionDate = $(\"#curSessionDate\").html();\r\n\r\n\tdd_message({\r\n\t\ttitle: 'Reschedule',\r\n\t\tmessage: '<div style=\"text-align: center;\"><div>From</div><div style=\"font-weight: bold;\">' + curSessionDate + '</div><div>to</div><div style=\"font-weight: bold;\">' + sessionTime + '</div>',\r\n\t\tmodal: true,\r\n\t\tconfirm: function () {\r\n\r\n\t\t\tvar org_session_id = session_id;\r\n\t\t\tsession_id = id;\r\n\t\t\tReschedule(org_session_id);\r\n\r\n\t\t},\r\n\t\topen: function () {\r\n\r\n\t\t\t$(this).siblings('.ui-dialog-buttonpane').find(\"button:contains('Confirm')\").focus();\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onRescheduleClick(id, sessionTime, isDiscounted, control_message)\r\n{\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tif (control_message == \"locked\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"You cannot reschedule to this session as it is in the previous calendar month and all activity for that month has been locked and finalized.\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tdoReschedule(id, sessionTime);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSessionClick(id, sessionTime, isDiscounted)\r\n{\r\n\t// Obsolete - delivered orders always set a session based on current date and service days\r\n\tintenseLogging(\"onSessionClick() called .................... please investiage should not occur for Delivered order\");\r\n\r\n}\r\n\r\nfunction monthChange(monthVal)\r\n{\r\n\tRetrieveCalendar(monthVal);\r\n}\r\n\r\nfunction handleSummaryDisplayChange(obj)\r\n{\r\n\tif (obj.checked)\r\n\t{\r\n\t\tShowAllLineItems();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tHideLineItemsIfZero();\r\n\t}\r\n}\r\n\r\nfunction HideLineItemsIfZero()\r\n{\r\n\r\n\tvar deliveryFeeOrg = Number($('#OEH_subtotal_delivery_fee_org').html());\r\n\tvar deliveryFee = Number($('#OEH_subtotal_delivery_fee').html());\r\n\r\n\tif (deliveryFeeOrg == 0 && deliveryFee == 0)\r\n\t{\r\n\t\t$('#DeliveryFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryFeeRow').show();\r\n\t}\r\n\r\n\tvar doDiscountOrg = Number($('#OEH_direct_order_discount_org').html());\r\n\tvar doDiscount = Number($('#OEH_direct_order_discount').html());\r\n\r\n\tif (doDiscountOrg == 0 && doDiscount == 0)\r\n\t{\r\n\t\t$('#directDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#directDiscountRow').show();\r\n\t}\r\n\r\n\tvar couponDiscountOrg = Number($('#OEH_coupon_discount_org').html());\r\n\tvar couponDiscount = Number($('#OEH_coupon_discount').html());\r\n\r\n\tif (couponDiscountOrg == 0 && couponDiscount == 0)\r\n\t{\r\n\t\t$('#couponDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#couponDiscountRow').show();\r\n\t}\r\n\r\n\tvar membershipDiscountOrg = Number($('#OEH_membership_discount_org').html());\r\n\tvar membershipDiscount = Number($('#OEH_membership_discount').html());\r\n\r\n\tif (membershipDiscountOrg == 0 && membershipDiscount == 0)\r\n\t{\r\n\t\t$('#membershipDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#membershipDiscountRow').show();\r\n\t}\r\n\r\n\tvar foodTaxOrg = Number($('#OEH_food_tax_subtotal_org').html());\r\n\tvar foodTax = Number($('#OEH_food_tax_subtotal').html());\r\n\r\n\tif (foodTaxOrg == 0 && foodTax == 0)\r\n\t{\r\n\t\t$('#foodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#foodTaxRow').show();\r\n\t}\r\n\r\n\tvar nonFoodTaxOrg = Number($('#OEH_tax_subtotal_org').html());\r\n\tvar nonFoodTax = Number($('#OEH_tax_subtotal').html());\r\n\r\n\tif (nonFoodTaxOrg == 0 && nonFoodTax == 0)\r\n\t{\r\n\t\t$('#nonFoodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxRow').show();\r\n\t}\r\n\r\n\tvar deliveryTaxOrg = Number($('#OEH_delivery_tax_subtotal_org').html());\r\n\tvar deliveryTax = Number($('#OEH_delivery_tax_subtotal').html());\r\n\r\n\tif (deliveryTaxOrg == 0 && deliveryTax == 0)\r\n\t{\r\n\t\t$('#DeliveryTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryTaxRow').show();\r\n\t}\r\n\r\n\tvar ddOrg = Number($('#OEH_plate_points_order_discount_fee_org').html());\r\n\tvar dd = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\tdd = isNaN(dd)? 0:dd;\r\n\tddOrg = isNaN(ddOrg)? 0:ddOrg;\r\n\r\n\tif (ddOrg == 0 && dd == 0)\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').show();\r\n\t}\r\n\r\n}\r\n\r\nfunction ShowAllLineItems()\r\n{\r\n\t$('#DeliveryFeeRow').show();\r\n\t$('#directDiscountRow').show();\r\n\t$('#couponDiscountRow').show();\r\n\t$('#foodTaxRow').show();\r\n\t$('#nonFoodTaxRow').show();\r\n\t$('#dinnerDollarsDiscountRow').show();\r\n}\r\n\r\nfunction sort_by_price(a, b)\r\n{\r\n\tif (a.price == b.price)\r\n\t{\r\n\t\treturn 0;\r\n\t}\r\n\r\n\treturn (a.price < b.price) ? 1 : -1;\r\n}\r\n\r\nfunction drawChangeList()\r\n{\r\n\tvar html = getChangeListHTML();\r\n\t$(\"#changelist\").html(html);\r\n\r\n}\r\n\r\nfunction getChangeListHTML()\r\n{\r\n\r\n\tvar htmlStr = \"\";\r\n\tvar first = true;\r\n\r\n\tlet editedExistingBoxHTML = {};\r\n\tlet existingNewBoxHTML = {};\r\n\r\n\tfor (var thisBox in changeList.box_contents)\r\n\t{\r\n\t\tif (changeList.box_contents.hasOwnProperty(thisBox))\r\n\t\t{\r\n\t\t\tlet tempHTML = \"\";\r\n\r\n\t\t\tfor (var thisItem in changeList.box_contents[thisBox])\r\n\t\t\t{\r\n\t\t\t\tlet item_name = $(\"#qty_\" + thisBox + \"_\" + thisItem).data('title');\r\n\r\n\t\t\t\tif (changeList.box_contents[thisBox][thisItem] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\ttempHTML += \"-Added \" + changeList.box_contents[thisBox][thisItem] + \" \" + item_name + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\ttempHTML += \"-Removed \" + changeList.box_contents[thisBox][thisItem] + \" \" + item_name + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!changeList.boxes[thisBox])\r\n\t\t\t{\r\n\t\t\t\t// an existing boxes contents have changed\r\n\r\n\t\t\t\tif (first)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"<h3>Edited Boxes</h3><ul style='margin: 4px;'>\";\r\n\t\t\t\t\tfirst = false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\t\teditedExistingBoxHTML[thisBox] = \"Box: \" + title + \"<br />\" + tempHTML;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\texistingNewBoxHTML[thisBox] = tempHTML;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tvar first = true;\r\n\r\n\tfor (var box_inst_id in changeList.boxes)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Added Boxes</h3><ul style='margin: 0px; padding: 0px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.boxes.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\tif (changeList.boxes[box_inst_id] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.boxes[box_inst_id] + \" <i>\" + title + \"</i> \";\r\n\r\n\t\t\t\tif (existingNewBoxHTML[box_inst_id])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"<br />\" + existingNewBoxHTML[box_inst_id];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.boxes[box_inst_id] * -1 + \"<i>\" + boxesDeletedFromActiveOrder[box_inst_id] + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tfor (var box_inst_id in editedExistingBoxHTML)\r\n\t{\r\n\t\tif (editedExistingBoxHTML.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\thtmlStr += editedExistingBoxHTML[box_inst_id];\r\n\t\t}\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tvar hadMiscCostChanges = false;\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\t\thadMiscCostChanges = true;\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (!hadMiscCostChanges && first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.reporting)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Reporting</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.reporting.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (item == 'fundraiser')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse if (changeList.reporting[item][\"orgVal\"] > 0 && changeList.reporting[item][\"orgVal\"] != changeList.reporting[item][\"newVal\"])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Changed \" + getHumanReadableName(item) + \" to \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (item == 'fundraiser_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == false)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was removed from the order.'\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was added to the order.'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.coupon)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.coupon.change_type = 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Added coupon code: \" + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type = 'removed')\r\n\t\t{\r\n\t\t\thtmlStr += \"Removed coupon code: \" + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type = 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Change coupon code to: \" + \"<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment2_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\t}\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction getHumanReadableName(id)\r\n{\r\n\tswitch (id)\r\n\t{\r\n\t\tcase 'direct_order_discount':\r\n\t\t\treturn \"Direct Order Discount\";\r\n\t\tcase 'plate_points_discount':\r\n\t\t\treturn \"Dinner Dollars\";\r\n\t\tcase \"misc_food_subtotal\":\r\n\t\t\treturn \"Miscellaneous Food Cost\";\r\n\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\treturn \"Miscellaneous Non-food Cost\";\r\n\t\tcase \"subtotal_service_fee\":\r\n\t\t\treturn \"Service Fee\";\r\n\t\tcase \"subtotal_delivery_fee\":\r\n\t\t\treturn \"Delivery Fee\";\r\n\t\tcase 'misc_food_subtotal_desc':\r\n\t\t\treturn 'Misc Food Description';\r\n\t\tcase 'misc_nonfood_subtotal_desc':\r\n\t\t\treturn 'Misc Non-food Description';\r\n\t\tcase 'service_fee_description':\r\n\t\t\treturn 'Service Fee Description';\r\n\t\tcase 'session_discount':\r\n\t\t\treturn 'Session Discount';\r\n\t\tcase 'fundraiser':\r\n\t\t\treturn 'Fundraiser';\r\n\t\tcase 'fundraiser_value':\r\n\t\t\treturn 'Fundraiser Value';\r\n\t\tcase 'ltd_roundup_value':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up Value';\r\n\t\tcase 'ltd_roundup':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up';\r\n\t\tdefault:\r\n\t\t\treturn 'error';\r\n\t}\r\n}\r\n\r\nfunction getAbbreviatedSummaryString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\r\n\thtmlStr += \"<h3>Delivered Order</h3>\";\r\n\r\n\tvar first = true;\r\n\tfor (var box_inst_id in changeList.boxes)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Added Boxes</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.boxes.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\tif (changeList.boxes[box_inst_id] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.boxes[box_inst_id] + \"<i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.boxes[box_inst_id] * -1 + \"<i>\" + boxesDeletedFromActiveOrder[box_inst_id] + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif (curVal > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += getHumanReadableName(this.id) + \" costs of $\" + formatAsMoney(curVal);\r\n\r\n\t\t\t\tvar descIDStr = \"\";\r\n\r\n\t\t\t\tswitch (this.id)\r\n\t\t\t\t{\r\n\t\t\t\t\tcase \"misc_food_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_food_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_nonfood_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"subtotal_service_fee\":\r\n\t\t\t\t\t\tdescIDStr = \"service_fee_description\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar desc = null;\r\n\t\t\t\tif (descIDStr != \"\")\r\n\t\t\t\t{\r\n\t\t\t\t\tdesc = $(\"#\" + descIDStr).val();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (desc)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \". <span>( \" + desc + \" )</span><br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \".<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\t// Discounts\r\n\r\n\tvar discountsHTML = \"\";\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() > 0)\r\n\t\t{\r\n\t\t\tdiscountsHTML += getHumanReadableName(this.id) + \" applied.<br />\";\r\n\t\t}\r\n\t});\r\n\r\n\tif (discountsHTML != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Discounts</h3>\" + discountsHTML;\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction updateChangeList()\r\n{\r\n\r\n\tlet itemChanges = false;\r\n\tlet discountChanges = false;\r\n\tlet reportingChanges = false;\r\n\r\n\tlet discountOrPaymentChanges = false;\r\n\tlet showSaveButton = false;\r\n\r\n\tchangeList = {};\r\n\tchangeList.stdMenuItems = {};\r\n\tchangeList.FTMenuItems = {};\r\n\tchangeList.miscCosts = {};\r\n\tchangeList.miscDescs = {};\r\n\tchangeList.bundleItems = {};\r\n\tchangeList.order_type = \"\";\r\n\tchangeList.discounts = {};\r\n\tchangeList.reporting = {};\r\n\tchangeList.delivery = {};\r\n\tchangeList.boxes = {}\r\n\tchangeList.box_contents = {}\r\n\r\n\tfor (var box_inst in current_box_ids)\r\n\t{\r\n\t\tcurrent_box_ids[box_inst] = 0;\r\n\t}\r\n\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet list_id = this.id.split(\"_\")[3];\r\n\t\tcurrent_box_ids[list_id] = 1;\r\n\r\n\t\tif ($(this).data(\"contents_are_fixed\") == true)\r\n\t\t{\r\n\t\t\tif (!$(this).data(\"is_saved\"))\r\n\t\t\t{\r\n\t\t\t\tchangeList.boxes[list_id] = 1;\r\n\t\t\t\titemChanges = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif (!$(this).data(\"is_saved\"))\r\n\t\t\t{\r\n\t\t\t\tchangeList.boxes[list_id] = 1;\r\n\t\t\t\titemChanges = true;\r\n\r\n\t\t\t\t// also need to see it contents changed\r\n\t\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\t\tlet curQty = $(this).val();\r\n\t\t\t\t\tlet savedQty = $(this).data('claimed_qty');\r\n\t\t\t\t\tlet menu_item_id = $(this).data('menu_item_id');\r\n\r\n\t\t\t\t\tif (curQty != savedQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!changeList.box_contents[list_id])\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tchangeList.box_contents[list_id] = {};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tchangeList.box_contents[list_id][menu_item_id] = curQty - savedQty\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t// also need to see it contents changed\r\n\t\t\t\t$(\"input\").filter(\"[data-box_inst_id='\" + list_id + \"']\").each(function () {\r\n\t\t\t\t\tlet curQty = $(this).val();\r\n\t\t\t\t\tlet savedQty = $(this).data('claimed_qty');\r\n\t\t\t\t\tlet menu_item_id = $(this).data('menu_item_id');\r\n\r\n\t\t\t\t\tif (curQty != savedQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!changeList.box_contents.list_id)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tchangeList.box_contents.list_id = {};\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tchangeList.box_contents.list_id[menu_item_id] = curQty - savedQty\r\n\t\t\t\t\t\titemChanges = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tfor (var box_inst in current_box_ids)\r\n\t{\r\n\t\tif (current_box_ids[box_inst] == 0)\r\n\t\t{\r\n\t\t\tchangeList.boxes[box_inst] = -1;\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function ()\r\n\t{\r\n\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tchangeList.FTMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.stdMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\t*/\r\n\r\n\t// Misc Costs\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif (curVal == undefined || curVal == \"\")\r\n\t\t{\r\n\t\t\tcurVal = \"0.00\";\r\n\t\t}\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tif (itemChanges)\r\n\t{\r\n\t\t$(\"#items_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\t// Discounts\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t// we're not  tracking description fields for now\r\n\t\t\tchangeList.discounts[this.id] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// coupons\r\n\tvar orgCouponVal = $(\"#org_coupon_id\").val();\r\n\tvar curCouponVal = $(\"#coupon_id\").val();\r\n\r\n\tif (orgCouponVal != curCouponVal)\r\n\t{\r\n\t\tdiscountOrPaymentChanges = true;\r\n\r\n\t\tif (orgCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"added\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse if (curCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//removed\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"removed\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"changed\"\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (deliveryChanges)\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#payments_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && (showSaveButton || $('#use_store_credit').is(':checked')))\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && ($('#use_store_credit').is(':checked') || paymentChanges))\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\r\n\t}\r\n\r\n\tif (orderState == 'ACTIVE' || discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").show();\r\n\t\tif (showSaveButton || paymentChanges || $('#use_store_credits').is(':checked'))\r\n\t\t{\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", true);\r\n\t\t\t$(\"#finalize_msg\").hide();\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (itemChanges || discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#changeListTab\").addClass('unsaved_data_list');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#changeListTab\").removeClass('unsaved_data_list');\r\n\t}\r\n\r\n\tdrawChangeList();\r\n}\r\n\r\nfunction handleAutoAdjust(obj)\r\n{\r\n\t// called when the document is loaded or when the \"autoAdjust\" check box changes\r\n\r\n\t// if checked then setup the amounts to be credited/debited\r\n\tif (obj.checked)\r\n\t{\r\n\t\tvar balance = Number($('#OEH_remaing_balance').html());\r\n\r\n\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || balance > 0))\r\n\t\t{\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('DPADJUST');\r\n\t\t\t\tchangePayment1('DPADJUST');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tadjustPendingDelayedPayment(balance);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('REFERENCE');\r\n\t\t\t\tchangePayment1('REFERENCE');\r\n\t\t\t}\r\n\r\n\t\t\tassignBalanceToRefTransactions(balance);\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\t$('#payment1_type').val('');\r\n\t\t\tchangePayment1('');\r\n\t\t}\r\n\r\n\t\t// also clear any credits\r\n\t\tfor (ident in existingPaymentAmountArray)\r\n\t\t{\r\n\t\t\t$('#Cr_RT_' + ident).val(\"\");\r\n\t\t}\r\n\r\n\t\t// or if trying to credit\r\n\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n}\r\n\r\nfunction getAbbreviatedChangeString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\tvar addedStd = 0;\r\n\tvar removedStd = 0;\r\n\r\n\tvar htmlStr = \"\";\r\n\r\n\tif (needPlatePointsMaxDiscountChangeWarning)\r\n\t{\r\n\t\thtmlStr += \"<div style='color:red;'>Warning: The amount discountable by Dinner Dollars has changed. You may wish to review and adjust the Dinner Dollars discount.</div>\";\r\n\r\n\t}\r\n\tvar first = true;\r\n\tfor (var box_inst_id in changeList.boxes)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Added Boxes</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.boxes.hasOwnProperty(box_inst_id))\r\n\t\t{\r\n\t\t\tvar title = $(\"#box_inst_id_\" + box_inst_id).data('box_label');\r\n\r\n\t\t\tif (changeList.boxes[box_inst_id] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.boxes[box_inst_id] + \"<i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.boxes[box_inst_id] * -1 + \"<i>\" + boxesDeletedFromActiveOrder[box_inst_id] + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif ($('#autoAdjust').is(\":checked\"))\r\n\t{\r\n\t\thtmlStr += \"<span style='color:red'>Auto-Adjust is checked and will \" + $(\"#adj_action\").html() + \"</span>\";\r\n\r\n\t}\r\n\r\n\thtmlStr = \"<div id='finalize_changes_div'>\" + htmlStr + \"</div>\";\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction addPaymentToLockedOrder()\r\n{\r\n\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\tvar billing_address = $(\"#billing_address_1\").val();\r\n\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_token',\r\n\t\t\torder_id: order_id,\r\n\t\t\tamount: amt,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tbilling_name: billing_name,\r\n\t\t\tbilling_address: billing_address,\r\n\t\t\tbilling_zip: billing_zip,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val(),\r\n\t\t\tchain_token: true\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder() get_token successful\");\r\n\r\n\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\tsend(token, 1, false, true, true, false);\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction submitPage()\r\n{\r\n\tintenseLogging(\"submitPage() called\");\r\n\r\n\tvar form = $(\"#editorForm\")[0];\r\n\r\n\tvar is_valid = confirm_and_check_form(form);\r\n\r\n\tif (is_valid)\r\n\t{\r\n\t\tvar message = \"This can not be undone. Are you sure you want to submit the changes?\";\r\n\t\tvar changesBlurb = getAbbreviatedChangeString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tvar dialogHeight = 460;\r\n\r\n\t\tif (message.length < 128)\r\n\t\t{\r\n\t\t\tdialogHeight = 160;\r\n\t\t}\r\n\t\telse if (message.length < 256)\r\n\t\t{\r\n\t\t\tdialogHeight = 260;\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Finalize',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: dialogHeight,\r\n\t\t\tconfirm: function () {\r\n\r\n\t\t\t\tif (supports_transparent_redirect && $(\"#payment1_type\").val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"submitPage() confirmed\");\r\n\r\n\t\t\t\t\tif (!discountEligable.limited_access)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tupdateActiveOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\taddPaymentToLockedOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeList',\r\n\t\t\t\t\t\tvalue: JSON.stringify(changeList)\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeListStr',\r\n\t\t\t\t\t\tvalue: getChangeListHTML()\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$(\"#submit_changes\").val(\"true\");\r\n\t\t\t\t\t$(\"#editorForm\").submit();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n}\r\n\r\nfunction resetPage()\r\n{\r\n\tintenseLogging(\"resetPage() called\");\r\n\r\n\tbounce(window.location.href);\r\n}\r\n\r\nfunction confirm_and_check_form(form)\r\n{\r\n\r\n\tintenseLogging(\"confirm_and_check_form() called\");\r\n\r\n\tif (orderState == 'NEW' || orderState == 'SAVED')\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn _check_form(form);\r\n}\r\n\r\n// rounds to the nearest penny\r\n// move to global once this is found to be reliable\r\nfunction dd_round_amount(inAmount)\r\n{\r\n\tinAmount += .000005;\r\n\r\n\tvar tempVal = inAmount * 1000.0;\r\n\ttempVal = parseInt(tempVal);\r\n\ttempVal = tempVal / 10;\r\n\tvar pennyFraction = tempVal - Math.floor(tempVal);\r\n\tif (pennyFraction >= .5)\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal) + 1;\r\n\t}\r\n\telse\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal);\r\n\t}\r\n\r\n\treturn tempVal / 100;\r\n}\r\n\r\n/*\r\n\r\n function reportTestFailure(testNum, actual, correct)\r\n {\r\n if (actual != correct)\r\n {\r\n alert(\"Test #: \" + testNum + \" actual: \" + actual + \" correct: \" + correct);\r\n }\r\n }\r\n\r\n function doTests()\r\n {\r\n\r\n var testmultiplier = \".5\";\r\n\r\n var testNum = \"260.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(1, newResult, 130.05);\r\n\r\n var testNum = \"209.10\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(2, newResult, 104.55);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(3, newResult, 104.55);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(4, newResult, 104.5);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(5, newResult, .5);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(6, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(7, newResult, .03);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(8, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(9, newResult, 250);\r\n\r\n var testNum = \"209.10\";\r\n var testmultiplier = \".12\";\r\n\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(10, newResult, 25.09);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(11, newResult, 25.09);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(12, newResult, 25.08);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(13, newResult, .12);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(14, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(15, newResult, .01);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(16, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(17, newResult, 60);\r\n\r\n }\r\n\r\n doTests();\r\n\r\n */\r\n\r\n// this massive function is called anytime something that affects costs or payments is altered\r\nfunction calculateTotal()\r\n{\r\n\r\n\tvar total = 0;\r\n\tvar servings = 0;\r\n\tvar productsSubTotal = 0;\r\n\tvar discounted_total = 0;\r\n\tvar main_items_count = 0;\r\n\tvar num_boxes = 0;\r\n\r\n\tfor (var x in entreeIDToInventoryMap)\r\n\t{\r\n\t\tentreeIDToInventoryMap[x].remaining = entreeIDToInventoryMap[x].org_remaining;\r\n\t\t$('#inv_' + x).html(entreeIDToInventoryMap[x].org_remaining + \"/serv\");\r\n\t}\r\n\r\n\t// ---------------------------------------------------------- Items\r\n\t$(\"[id^='box_inst_id_']\").each(function () {\r\n\t\tlet box_local_id = this.id.split(\"_\")[2];\r\n\r\n\t\tlet cost = $(this).data(\"box_price\");\r\n\t\tlet items_in_box = $(this).data(\"number_items_required\");\r\n\t\tlet servings_in_box = $(this).data(\"number_servings_required\");\r\n\t\ttotal += (cost * 1);\r\n\t\tmain_items_count += items_in_box;\r\n\t\tservings += servings_in_box;\r\n\t\tnum_boxes++;\r\n\t});\r\n\r\n\tdiscounted_total = total;\r\n\r\n\t// update the entree and serving totals display\r\n\t$('#OEH_item_count').html(main_items_count);\r\n\t$('#OEH_number_servings').html(servings);\r\n\t$('#OEH_number_boxes').html(num_boxes);\r\n\r\n\tdiscounted_total = Math.round(discounted_total * 100) / 100;\r\n\r\n\t// --------------------------------------------------------------------- menu items subtotal\r\n\t$('#orderSubTotal').val(formatAsMoney(Math.round(total * 100) / 100));\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney(discounted_total));\r\n\t$('#orderTotal').val(formatAsMoney(discounted_total));\r\n\r\n\t// ------------------------------------------------------ food subtotal\r\n\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney((discounted_total * 1)));\r\n\r\n\tvar newGrandTotal = discounted_total;\r\n\tvar pre_discounts_grand_total = newGrandTotal;\r\n\r\n\t// -------------------------------DISCOUNTS-----------------------------------------\r\n\t// ---------------------------------------------- Direct Order\r\n\tvar directDiscountVal = Number(0);\r\n\r\n\tdirectDiscount = $('#direct_order_discount');\r\n\r\n\tif (directDiscount.length)\r\n\t{\r\n\t\tdirectDiscountVal = directDiscount.val();\r\n\r\n\t\tif (isNaN(directDiscountVal))\r\n\t\t{\r\n\t\t\tdirectDiscountVal = 0;\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal > pre_discounts_grand_total)\r\n\t\t{\r\n\t\t\tdirectDiscountVal = pre_discounts_grand_total;\r\n\t\t\tdirectDiscount.val(directDiscountVal);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal)\r\n\t\t{\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - directDiscountVal);\r\n\t\t}\r\n\r\n\t\t$('#OEH_direct_order_discount').html(formatAsMoney(directDiscountVal));\r\n\r\n\t}\r\n\r\n\t//----------------------------------------------------Dinner Dollars\r\n\tdiscountablePlatePointsAmount = handleDinnerDollars(newGrandTotal);\r\n\r\n\t// ------------------------------------------------------------------- coupon Discount\r\n\r\n\tif (couponDiscountMethod == 'PERCENT')\r\n\t{\r\n\t\tvar newDiscountAmount = Math.floor(pre_discounts_grand_total * (couponDiscountVar));\r\n\t\tnewDiscountAmount /= 100;\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tvar couponDiscountVal = Number(0);\r\n\tcouponDiscount = $('#couponValue');\r\n\r\n\tif (couponDiscount.length)\r\n\t{\r\n\t\tif (couponDiscount.val() == \"\")\r\n\t\t{\r\n\t\t\tcouponDiscount.val('0.00');\r\n\t\t}\r\n\t\tcouponDiscountVal = couponDiscount.val();\r\n\t}\r\n\r\n\tvar couponDiscountValIsDeliveryFee = false;\r\n\r\n\tif (typeof coupon != 'undefined' && coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t{\r\n\t\tvar currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\t\tif (couponDiscountVal != currentDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponDiscountVal = currentDeliveryFee;\r\n\t\t\t$('#couponValue').val(couponDiscountVal);\r\n\r\n\t\t}\r\n\r\n\t\tcouponDiscountValIsDeliveryFee = true;\r\n\t}\r\n\r\n\tif (couponDiscountVal)\r\n\t{\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - couponDiscountVal);\r\n\t\t$('#OEH_coupon_discount').html(formatAsMoney(couponDiscountVal));\r\n\t}\r\n\r\n\tvar curPPDiscount = 0;\r\n\t// ----------------------------------------------  PLATEPOINTS Discount\r\n\tif ($('#plate_points_discount').length)\r\n\t{\r\n\t\tcurPPDiscount = $('#plate_points_discount').val();\r\n\t\tif (curPPDiscount * 1 > discountablePlatePointsAmount * 1)\r\n\t\t{\r\n\t\t\tcurPPDiscount = discountablePlatePointsAmount;\r\n\r\n\t\t\tif (curPPDiscount == 0)\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(\"\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(formatAsMoney(curPPDiscount));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(curPPDiscount));\r\n\r\n\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - curPPDiscount);\r\n\t}\r\n\r\n\t// ----------------------------------------------------------Membership Discount\r\n\r\n\tif (orderIsEligibleForMembershipDiscount && storeSupportsMembership)\r\n\t{\r\n\t\tvar couponAdjustment = Number(0);\r\n\t\tif (couponDiscountValIsServiceFee || couponDiscountValIsDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponAdjustment = couponDiscountVal;\r\n\t\t}\r\n\r\n\t\tvar membership_discount_basis = Number((newGrandTotal * 1) + (couponAdjustment * 1));\r\n\t\tvar memberDiscountAmount = Number(membership_discount_basis * (membership_status.discount_var / 100));\r\n\t\tmemberDiscountAmount = Math.round(memberDiscountAmount * 100) / 100;\r\n\r\n\t\t$(\"#OEH_membership_discount\").html(formatAsMoney(memberDiscountAmount));\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - memberDiscountAmount);\r\n\r\n\t}\r\n\r\n\tvar deliveryFee = Number(0);\r\n\tif ($('#subtotal_delivery_fee')[0])\r\n\t{\r\n\t\tdeliveryFee = Number($('#subtotal_delivery_fee').val());\r\n\t\t$('#OEH_subtotal_delivery_fee').html(formatAsMoney(deliveryFee));\r\n\r\n\t\tnewGrandTotal = Number((newGrandTotal * 1) + (deliveryFee * 1));\r\n\r\n\t\tvar newFoodTotal = newGrandTotal - (deliveryFee * 1);\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------- tax\r\n\tvar newFoodTax = 0;\r\n\tvar avalaraCalcTax = 0;\r\n\tvar newDeliveryTax = 0;\r\n\r\n\tif (orderState != \"NEW\" && newFoodTotal > 0)\r\n\t{\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: false,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\top: 'retrieve_sales_tax',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tstore_id: store_id,\r\n\t\t\t\tsubtotal_all_items: newGrandTotal,\r\n\t\t\t\tsubtotal_delivery_fee: deliveryFee\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tintenseLogging(\"retrieving Sales tax\");\r\n\r\n\t\t\t\tavalaraCalcTax = json.subtotal_food_sales_taxes;\r\n\t\t\t\tnewDeliveryTax = json.subtotal_delivery_tax;\r\n\r\n\t\t\t\t$('#OEH_food_tax_subtotal').text(formatAsMoney(avalaraCalcTax));\r\n\t\t\t\t$('#OEH_delivery_tax_subtotal').text(formatAsMoney(newDeliveryTax));\r\n\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\t\tintenseLogging(\"retrieving Sales tax: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tvar newNonFoodTax = 0; // convert to float\r\n\tif (productsSubTotal)\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food & Enrollment Tax');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food Tax');\r\n\r\n\t}\r\n\r\n\tnewFoodTax = formatAsMoney(avalaraCalcTax);\r\n\r\n\ttaxElem = document.getElementById('OEH_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newNonFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_food_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_delivery_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newDeliveryTax);\r\n\t}\r\n\r\n\tvar preTaxTotal = Number(newGrandTotal);\r\n\tnewGrandTotal = (newGrandTotal * 1) + (newFoodTax * 1) + (newNonFoodTax * 1) + (newDeliveryTax * 1);\r\n\r\n\t// -------------------------------------------------------------------- grand total\r\n\t$('#OEH_grandtotal').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_new_total').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_delta').html(formatAsMoney((orderInfoGrandTotal - newGrandTotal) * -1));\r\n\r\n\tvar paymentTotal = 0;\r\n\tif ($('#OEH_paymentsTotal').length)\r\n\t{\r\n\t\tpaymentTotal = $('#OEH_paymentsTotal').html();\r\n\t}\r\n\r\n\tvar remainingBalance = Number(formatAsMoney(paymentTotal - newGrandTotal));\r\n\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance * -1));\r\n\r\n\t// Values are now calculated and the summary display updated\r\n\t// Next Display \"balance\" messages and set up payments\r\n\r\n\tif (orderState == 'CANCELLED')\r\n\t{\r\n\t\tremainingBalance = paymentTotal;\r\n\t\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance));\r\n\r\n\t}\r\n\r\n\tif (remainingBalance > 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to the customer.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_customer_owed');\r\n\t\t$(\"#newPaymentDiv\").hide();\r\n\r\n\t\tif (canAdjustDelayedPayment && currentDPAmount > 0)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').show();\r\n\t\t}\r\n\r\n\t\t$('#payment1_type').val('');\r\n\t\t$('#payment2_type').val('');\r\n\t\tchangePayment1('');\r\n\t\tchangePayment2('');\r\n\r\n\t\tpaymentChanges = true;\r\n\r\n\t\t$(\"#use_store_credits\").prop('checked', false);\r\n\t\t$(\"#use_store_credits\").prop('disabled', true);\r\n\r\n\t}\r\n\telse if (remainingBalance < 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to your store.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_store_owed');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tvar doNewLivePaymentAdjustments = true;\r\n\t\tif (doNewLivePaymentAdjustments)\r\n\t\t{\r\n\r\n\t\t\tvar defaultPaymentAmount = remainingBalance * -1;\r\n\r\n\t\t\tif ($(\"#use_store_credits\").is(\":checked\"))\r\n\t\t\t{\r\n\r\n\t\t\t\tvar amountStoreCredit = Number($(\"#store_credits_amount\").val());\r\n\t\t\t\tif (isNaN(amountStoreCredit.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tamountStoreCredit = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount -= amountStoreCredit.valueOf();\r\n\t\t\t}\r\n\r\n\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount);\r\n\r\n\t\t\tif ($('#payment1_type').val() == 'CC')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val() == 'CHECK')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if (($('#payment1_type').val() == 'GIFT_CERT' || $('#payment1_type').val() == \"GIFT_CARD\") && $('#payment2_type').val() != \"\")\r\n\t\t\t{\r\n\t\t\t\tvar payment1Amount = null;\r\n\t\t\t\tif ($('#payment1_type').val() == 'GIFT_CERT')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#payment1_gc_total_amount').val());\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment1_type').val() == 'GIFT_CARD')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#debit_gift_card_amount').val());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isNaN(payment1Amount.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount - payment1Amount.valueOf());\r\n\t\t\t\tif ($('#payment2_type').val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CHECK')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CASH')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cash_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse // == 0\r\n\t{\r\n\t\t$(\"#balance_msg\").html(\"0.00\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_balanced');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tassignBalanceToRefTransactions(0);\r\n\t}\r\n\r\n\tvar autoAdjustDiv = $('#autoAdjustDiv');\r\n\tif (autoAdjustDiv.length)\r\n\t{\r\n\r\n\t\tif (remainingBalance != 0 && canAutoAdjust)\r\n\t\t{\r\n\t\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || remainingBalance < 0))\r\n\t\t\t{\r\n\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>adjust customer's delayed payment.</b></span>\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (remainingBalance > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>credit customer's credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>charge original credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tautoAdjustDiv.show();\r\n\t\t\tif (!forceManualAutoAdjust)\r\n\t\t\t{\r\n\t\t\t\t$('#autoAdjust').prop('checked', true);\r\n\t\t\t\thandleAutoAdjust($('#autoAdjust').get()[0]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// if the div is hidden skip these steps\r\n\r\n\t\t\tif (autoAdjustDiv.is(\":visible\"))\r\n\t\t\t{\r\n\t\t\t\tautoAdjustDiv.hide();\r\n\t\t\t\t$('#autoAdjust').prop('checked', false);\r\n\t\t\t\t$('#payment1_type').val('');\r\n\t\t\t\t$('#payment2_type').val('');\r\n\t\t\t\tchangePayment1('');\r\n\t\t\t\tchangePayment2('');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$('#help_msg').html(\"\");\r\n\r\n\t// enforce a few rules by disallowing checkout\r\n\tif ($('#submit_changes').length)\r\n\t{\r\n\r\n\t\tif (servings > 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", false);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal >= (Number(preTaxTotal) + Number(directDiscountVal)) && preTaxTotal != 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t\t$('#help_msg').html($('#help_msg').html() + \"You cannot use a Direct Order Discount that is equal to or greater than the food cost total. Please use the \\\"No Charge\\\" payment type to give away an order.\");\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($('#help_msg').length)\r\n\t{\r\n\t\tif ($('#help_msg').html() != \"\")\r\n\t\t{\r\n\t\t\t$('#help_msg').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#help_msg').hide();\r\n\t\t}\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n\r\n\tHideLineItemsIfZero();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n}\r\n\r\nfunction handleDinnerDollars(total){\r\n\r\n\r\n\t//var serviceFee = Number(document.getElementById('OEH_subtotal_delivery_fee').value);\r\n\tvar discountablePlatePointsAmount = total;// + serviceFee.valueOf();\r\n\r\n\tif (discountablePlatePointsAmount != lastMaxPPDiscountAmount && lastMaxPPDiscountAmount != -1)\r\n\t{\r\n\t\tneedPlatePointsMaxDiscountChangeWarning = true;\r\n\t}\r\n\r\n\tlastMaxPPDiscountAmount = discountablePlatePointsAmount;\r\n\r\n\tif (discountablePlatePointsAmount < 0) discountablePlatePointsAmount = 0;\r\n\r\n\t$(\"#max_plate_points_deduction\").html(formatAsMoney(discountablePlatePointsAmount))\r\n\r\n\tvar maxPPCredit = $(\"#plate_points_available\").html() * 1;\r\n\tvar maxPPDeduction = $(\"#max_plate_points_deduction\").html() * 1;\r\n\tvar curPPDiscount = $(\"#plate_points_discount\").val() * 1;\r\n\r\n\tif (maxPPDeduction < curPPDiscount)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").val(maxPPDeduction);\r\n\t}\r\n\r\n\tif (maxPPCredit > maxPPDeduction)\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').hide();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_fee').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#dinnerDollarsDiscountRow').show();\r\n\t}\r\n\r\n\r\n\r\n\treturn discountablePlatePointsAmount;\r\n}\r\n\r\n$(document).on('change', '#shipping_phone_number', function (e) {\r\n\r\n\t$('.shipping_phone_number_new_div').hideFlex();\r\n\t$('#shipping_phone_number_new').prop('required', false);\r\n\r\n\tif ($(this).val() == 'new')\r\n\t{\r\n\t\t$('.shipping_phone_number_new_div').showFlex();\r\n\t\t$('#shipping_phone_number_new').prop('required', true);\r\n\r\n\t}\r\n});\r\n\r\n$(document).on('change keyup', '.delivery-input', function (e) {\r\n\r\n\tdeliveryChanges = false;\r\n\r\n\t$('.delivery-input').each(function () {\r\n\r\n\t\tif ($(this).data('org_value'))\r\n\t\t{\r\n\t\t\tvar val = $(this).val();\r\n\t\t\tvar org_value = $(this).data('org_value');\r\n\r\n\t\t\tif (val != org_value)\r\n\t\t\t{\r\n\t\t\t\tdeliveryChanges = true;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n});\r\n$(document).on('change', '#address_book_select', function (e) {\r\n\r\n\tlet id = $(this).val();\r\n\r\n\tif (id)\r\n\t{\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor_delivered',\r\n\t\t\t\top: 'retrieve_address_from_address_book',\r\n\t\t\t\taddress_id: id,\r\n\t\t\t\tuser_id: user_id\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#shipping_firstname').val(json.address.firstname);\r\n\t\t\t\t\t$('#shipping_lastname').val(json.address.lastname);\r\n\t\t\t\t\t$('#shipping_address_line1').val(json.address.address_line1);\r\n\t\t\t\t\t$('#shipping_address_line2').val(json.address.address_line2);\r\n\t\t\t\t\t$('#shipping_city').val(json.address.city);\r\n\t\t\t\t\t$('#shipping_state_id').val(json.address.state_id);\r\n\t\t\t\t\t$('#shipping_postal_code').val(json.address.postal_code);\r\n\t\t\t\t\t$('#shipping_address_note').val(json.address.address_note);\r\n\t\t\t\t\t$('#shipping_phone_number').val(json.address.telephone_1);\r\n\t\t\t\t\t$('#shipping_gift_email_address').val(json.address.email_address);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Address Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n});"],"mappings":"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"}