{"version":3,"file":"order_mgr.min.js","names":["itemChanges","feeChanges","discountOrPaymentChanges","deliveryChanges","discountChanges","reportingChanges","paymentChanges","initialSessionDiscountSetting","initialPreferredUserDiscountSetting","changeList","isFactoringCredit","currentCreditAvailable","stationNeedsAttention","relatedOrdersAreLoaded","currentlySavingOrder","onTimeShotAtSupplyingZeroPaymentHasOccurred","needPlatePointsMaxDiscountChangeWarning","needRefferalRewardMaxDiscountChangeWarning","lastMaxPPDiscountAmount","lastMaxReferralRewardDiscountAmount","feesTabIsDirty","admin_order_mgr_init","store_id","STORE_DETAILS","id","orderState","setupForNewOrder","setupForSavedOrder","setupForActiveOrder","hasBundle","bundleSetup","setupSiteAdminFunctions","initChangeList","calculateTotal","setAllPaymentFieldsToUnrequired","setupCouponState","setUpKeyHandlers","getQueryVariable","vars","window","location","search","substring","split","newQueryString","first","i","length","historyPush","url","handle_special_instruction_notes","handle_cancel_order","handle_delete_saved_order","handle_free_menu_item_edit","handle_fundraiser_selection","handle_ltd_round_up","handleDirectOrderDiscountFocusing","$","trigger","handleAutoOrderButtons","initNoInventoryRows","handleDinnerDollarAccordion","handleAdminNoteAccordion","setMealCustomizationDefault","default_meal_customization_to_selected","prop","click","$header","this","$content","html","is","slideToggle","each","remaining","data","servings","entree_id","$itemCount","val","find","addClass","hide","e","size","on","entreeID","entreeIDToInventoryMap","countMissedMeals","dd_message","title","message","setItemTabAsDirty","preventDefault","intenseLoggingOn","focus","select","blur","curVal","trim","isNaN","intenseLogging","console","log","saveSpecialInstructions","special_instructions","strip_tags","ajax","type","timeout","dataType","processor","user_id","op","order_id","success","json","processor_success","updateInstructionsOrgValues","processor_message","error","objAJAXRequest","strError","responseText","response","booking_id","do_op","do","note","textarea_elem","special_instruction_note","removeClass","show","nl2br","lastCheckedGiftCertNumber","document","onkeypress","OMDefaultKeyHandler","evt","event","charCode","which","keyCode","processCode","stopPropagation","getChangeListHTML","height","width","modal","div_id","dialogClass","noOk","position","my","at","of","close","ui","remove","flagName","checkbox","newState","oldState","cancel","confirm","flag","new_state","attr","updateMealCustomizationOrgValues","dd_toast","updateItemsOrgValues","isDreamTaste","isFundraiser","updateChangeList","saveAll","saveItems","saveDiscountsUponCompletion","activateOnSaveDiscountsCompletion","saveDeliveryAddressUponCompletion","itemsList","introItemsList","subItemsList","is_intro","item_id","misc_food_subtotal","misc_nonfood_subtotal","subtotal_service_fee","subtotal_delivery_fee","misc_food_subtotal_desc","misc_nonfood_subtotal_desc","service_fee_description","ltdOrderedMealsArray","bagFeeTotal","bagFeeCount","storeSupportsBagFees","storeDefaultBagFee","opted_to_bring_bags","manual_customization_fee","opted_to_customize","mealCustomizationFee","items","meal_customization_fee","intro_items","sub_items","itemTabIsDirty","saveDiscounts","setSessionAndSave","session_id","displayModalWaitDialog","dd_csrf_token","full_session_warning_required","bounce","getTokenToken","Reschedule","org_session_id","transition_type","suppressEmail","saved_booking_id","order_state","key","new_session_id","new_session_time","RetrieveCalendar","canDelayPayment","showFlex","hideFlex","session_discount","value","activeSessionDiscount","session_info","session_type_title","remaining_slots","remaining_intro_slots","client_ops","hasOwnProperty","href","formatAsMoney","onSetSessionAndSave","obj","onSaveItems","HideLineItemsIfZero","timestamp","discountEligable","limited_access","isDeliveryAddressComplete","validated","saveDeliveryAddress","payOnCompletion","token","shipping_data","onAddPaymentAndActivate","onDeliveryTabSelected","onDeliveryTabDeselected","onSessionTabSelected","onSessionTabDeselected","onItemsTabSelected","onItemsTabDeselected","onFeesTabSelected","onFeesTabDeselected","onPaymentTabSelected","handle_admin_order_notes","onPaymentTabDeselected","onRelatedOrdersTabSelected","onRelatedOrdersTabDeselected","onNotesTabSelected","handle_guest_account_notes","handle_admin_carryover_notes","onNotesTabDeselected","onPaymentSelected","onPaymentDeselected","onSiteAdminTabSelected","onSiteAdminTabDeselected","updateDiscountOrgValues","updateActiveOrder","go_to_confirm","direct_order_discount","PUDSetting","plate_points_discount","SessDiscSetting","DR_level","curOrderLevel","dream_rewards_level","JSON","stringify","changeListStr","_validate_discounts","couponFreeMenuItemRequired","_check_elements","get","referral_reward_discount","coupon_id","coupon_free_menu_item","fundraiser_id","fundraiser_value","add_ltd_round_up","ltd_round_up_select","updateReportingOrgValues","couponFreeMenuItem","paymentToken","send","paymentNumber","warnOfOutstandingSavedOrdersOnFullSession","addOnly","payment1Data","next_dest","contentWindow","pp_success","error_code","buttons","Okay","reloadOnFailure","comment_payload","PayFlow_Payload","addNameValuePair","user_email","expdate","csc","amt","payload","USER_DETAILS","store_credit_amount","DP_State","depositAmount","store_specific_deposit","payflowErrorURL","parmList","retrieveEncodedString","tr_action","pfp_test_mode","transparent_redirect_link","create_and_submit_form","action","target","input","SECURETOKEN","SECURETOKENID","tokenID","PARMLIST","getPaymentData","payment_number","paymentData","number","amount","cert_type","ccNameOnCard","ccType","ccMonth","ccYear","cc_security_code","billing_address","billing_city","billing_state_id","billing_postal_code","is_store_specific_flat_rate_deposit_delayed_payment","do_not_ref","save_card","DPSetting","alert","indexOf","reference_id","validatePayment1","inputArray","validates","substr","depositWarningStr","validatePayment2","addPaymentAndActivate","minimumVal","minimumType","order_minimum","minimum","minimum_type","servingsCount","enforce36ServingMinimum","underFilledMessage","toLowerCase","Number","itemCount","orderIsEligibleForMembershipDiscount","storeSupportsMembership","membership_status","eligible_menus","menu_id","number_qualifying_orders","quantityOrdered","valueOf","requiredMinimum","getAbbreviatedSummaryString","bundleIsSelected","numBundItems","countSelectedBundleItems","intro_servings_required","save2PaymentsAndBookOrder","payment2Type","payment2Data","supports_transparent_redirect","billing_name","billing_zip","async","chain_token","max_plate_points_deduction","payment_data","add_payment_data","delay_remainder","savePayment2","handleDirectPayment","payment1Type","use_store_credits","mainPaymentData","additionalPaymentData","store_credits_amount","closeOnEscape","Refresh","cur_session_id","onDayClick","doReschedule","sessionTime","curSessionDate","open","siblings","onRescheduleClick","isDiscounted","control_message","Continue","Cancel","onSessionClick","monthChange","monthVal","handle_delayed_payment","GUEST_PREFERENCES","TC_DELAYED_PAYMENT_AGREE","lang","en","tc","terms_and_conditions","delayed_payment","parent","Agree","off","set_user_pref","Decline","delayed_payment_decline","createBonusCredit","creditConsumed","creditBasis","removeBonusCredit","handleSummaryDisplayChange","checked","ShowAllLineItems","bagFeeOrg","bagFee","bagFeeTaxOrg","bagFeeTax","serviceFeeOrg","serviceFee","deliveryFeeOrg","deliveryFee","serviceTaxOrg","serviceTax","miscFoodOrg","miscFood","miscNonFoodOrg","miscNonFood","miscMealCustomizationFeeOrg","miscMealCustomizationFee","doDiscountOrg","doDiscount","couponDiscountOrg","couponDiscount","platePointsDiscountOrg","platePointsDiscount","referralRewardDiscountOrg","referralRewardDiscount","membershipDiscountOrg","membershipDiscount","foodTaxOrg","foodTax","nonFoodTaxOrg","nonFoodTax","deliveryTaxOrg","deliveryTax","productsSubtotalOrg","productsSubtotal","sort_by_price","a","b","price","drawChangeList","htmlStr","item","stdMenuItems","localStorage","getItem","pricing_type","translateServingSize","indexedItems","FTMenuItems","hadMiscCostChanges","miscCosts","getHumanReadableName","sideBundleItem","miscDescs","order_type","bundleItems","discounts","reporting","coupon","change_type","code","toUpperCase","ccRefundTotal","parseFloat","result","bundleChecked","stdItemCount","FTItemCount","descIDStr","desc","discountsHTML","newSDValue","newPUDValue","showSaveButton","delivery","orgVal","newVal","diff","bundleOrgVal","customizationSelection","name","text","toFixed","orgCouponVal","curCouponVal","curCouponCode","handleAutoAdjust","balance","canAdjustDelayedPayment","currentDPAmount","changePayment1","adjustPendingDelayedPayment","assignBalanceToRefTransactions","ident","existingPaymentAmountArray","reportPaymentStatus","getAbbreviatedChangeString","addedStd","removedStd","addedFT","removedFT","addedSBI","removedSBI","addedBI","removedBI","addPaymentToLockedOrder","submitPage","form","confirm_and_check_form","dialogHeight","appendTo","submit","resetPage","_check_form","dd_round_amount","inAmount","tempVal","parseInt","Math","floor","updateSideStationStatus","qty","slideUp","css","slideDown","requiredItemCount","sideStationBundleInfo","number_items_required","numSelected","bundle","mid","menu_item","itemQty","fixed_quantity","inv_qty","servings_per_item","bundle_groups","bid","group_info","stationHelpElem","help_message","handleMealCustomizationFeeInput","handleBagCountInput","bagCountLockedToField","handleBagWaiverInput","handleMealCustomizationWaiverInput","mealCustomizationFeeFieldLocked","mealCustomizationFeeTotal","calculateMealCustomizationFee","customizableMealQty","priceConfig","meal_customization_cost","fee","operator","cost","limit","limitLow","limitHigh","getNumberBagsRequiredFromItems","entreeCount","sidesCount","bagsRequired","entreeRemainder","total","entrees","core_servings","halfQty","wholeQty","sideDishQty","sideDishSubTotal","bundlesSubTotal","coreItemsSubtotal","bundlesQty","discounted_total","creditContribution","main_items_count","hasServiceFeeWithMFYCoupon","hasDeliveryFeeWithCoupon","sortedCoreItemList","itemsSelected","x","org_remaining","itemId","orgAmount","getAttribute","PlatePointsRulesVersion","serving_size","push","selectedBundleItemCount","selectedBundleServingsCount","originallyHadBundle","bundleInfo","tasteBundleMenuData","number_servings_required","selectedWholeBundleItemCount","selectedHalfBundleItemCount","tasteItemQty","discountablePlatePointsAmount","limit_to_mfy_fee","discount_method","limit_to_delivery_fee","getElementById","currentServiceFee","couponlimitedToFT","color","removeAttr","discountableReferralRewardAmount","maxPPCredit","maxPPDeduction","curPPDiscount","maxRRCredit","maxRRDeduction","addonsSubtotal","addonsQty","itemNumber","qty_str","prc_str","addQty","addonsQtyNumber","addPrc","addPrcNumber","core_items_count","totalMealQuantity","itemCountLabel","itemCountAdjustmentAmount","displayServingsAdjustment","couponTypeElem","cfm_size","displayMealCount","displayServingCount","orderEditSuccess","newAddonQty","setItem","freeMealValue","newAddonAmount","round","miscFoodSubtotal","food_costs","newGrandTotal","pre_discounts_grand_total","curReferralRewardDiscount","directDiscountVal","directDiscount","couponDiscountMethod","CouponCodeStr","newDiscountAmount","formatterUSD","Intl","NumberFormat","minimumFractionDigits","maximumFractionDigits","couponlimitedToCore","format","couponDiscountVar","newDiscountVal","couponDiscountVal","UPDiscountElem","couponDiscountValIsServiceFee","couponDiscountValIsDeliveryFee","currentDeliveryFee","limit_to_recipe_id","menu_item_id","discount_var","selectedUP","UPDiscount","UPType","PcntTypeValue","originalUP","activeUP","preferredData","preferredCapRemaining","preferred_cap_value","capacityUP","remainingObj","countRemaining","preferred_cap_type","basis","include_sides","halfCost","sort","rounded_pud_result","promoVal","couponAdjustment","membership_discount_basis","memberDiscountAmount","SessDisc","session_discount_basis","selectedSD","sessionDiscount","rawAmount","originalSD","SDiscountElem","miscNonFoodSubtotal","BagFeeTotal","calculatedBagCount","numBagsRequired","storeSupportsMealCustomization","newNonFoodTax","curNonFoodTax","enrollmentTax","curEnrollmentTax","newDeliveryTax","curDeliveryTax","newFoodTax","newServiceTax","food_portion_of_points_credit","fee_portion_of_points_credit","discountMFYFeeFirst","foodPortionOfMaxDeduction","curFoodTax","curServiceTax","newBagFeeTax","curBagFeeTax","taxElem","innerHTML","preTaxTotal","round_up_donation","subtotal_round_up","ceil","subtotal_round_up_diff","orderInfoGrandTotal","paymentTotal","remainingBalance","changePayment2","defaultPaymentAmount","amountStoreCredit","payment1Amount","autoAdjustDiv","canAutoAdjust","forceManualAutoAdjust","canIncrementBundleSubItem","selector","pid","itemInfo","parentItemInfo","parentNumItemsRequired","groupID","bundle_to_menu_item_group_id","total_org","total_current","groupInfo","inputItemInfo","inputGroupID","this_org","this_cur","preferenceChangeListener","pref","setting","user","callback","pref_value","USER_PREFERENCES","isPlainObject","extend","toString","includes","replace","meal_customization_preferences","details","customizations","costInputFeesTab","setFeesTabAsDirty","canIncrement","qtyUpdate"],"sourceRoot":"js/src/dreamdinners/admin","sources":["order_mgr.js"],"sourcesContent":["var itemChanges = false;\r\nvar feeChanges = false;\r\nvar discountOrPaymentChanges = false;\r\nvar deliveryChanges = false;\r\nvar discountChanges = false;\r\nvar reportingChanges = false;\r\nvar paymentChanges = false;\r\nvar initialSessionDiscountSetting = \"noSD\";\r\nvar initialPreferredUserDiscountSetting = \"noUP\";\r\nvar changeList = null;\r\nvar isFactoringCredit = false;\r\nvar currentCreditAvailable = 0;\r\nvar stationNeedsAttention = false;\r\nvar relatedOrdersAreLoaded = false;\r\nvar currentlySavingOrder = false;\r\nvar onTimeShotAtSupplyingZeroPaymentHasOccurred = false;\r\nvar needPlatePointsMaxDiscountChangeWarning = false;\r\nvar needRefferalRewardMaxDiscountChangeWarning = false;\r\nvar lastMaxPPDiscountAmount = -1;\r\nvar lastMaxReferralRewardDiscountAmount = -1;\r\nlet feesTabIsDirty = false;\r\n\r\nfunction admin_order_mgr_init()\r\n{\r\n\r\n\tif (store_id != STORE_DETAILS.id)\r\n\t{\r\n\t\tSTORE_DETAILS.id = store_id;\r\n\r\n\t\t//STORE_DETAILS.id is either the current fadmin store - in which case a match is guaranteed or\r\n\t\t// is the current Site Admin store (last selection from a store drop down.) However in this case if the order was accessed by the address\r\n\t\t// bar a match is not guaranteed so force STORE_DETAILS.id to store_id which is always the store of the order\r\n\t}\r\n\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetupForNewOrder();\r\n\t}\r\n\telse if (orderState == 'SAVED')\r\n\t{\r\n\t\tsetupForSavedOrder();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetupForActiveOrder();\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tbundleSetup();\r\n\t}\r\n\r\n\tsetupSiteAdminFunctions();\r\n\r\n\tinitChangeList();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tcalculateTotal();\r\n\r\n\t\tsetAllPaymentFieldsToUnrequired();\r\n\r\n\t\tsetupCouponState();\r\n\t}\r\n\r\n\tsetUpKeyHandlers();\r\n\r\n\tif (getQueryVariable(\"session_full\") == \"true\")\r\n\t{\r\n\t\tvar query = window.location.search.substring(1);\r\n\t\tvar vars = query.split(\"&\");\r\n\t\tvar newQueryString = \"main.php?\";\r\n\r\n\t\tvar first = true;\r\n\t\tfor (var i = 0; i < vars.length; i++)\r\n\t\t{\r\n\r\n\t\t\tvar pair = vars[i].split(\"=\");\r\n\t\t\tif (pair[0] != 'session_full')\r\n\t\t\t{\r\n\t\t\t\tif (!first)\r\n\t\t\t\t{\r\n\t\t\t\t\tnewQueryString += \"&\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewQueryString += vars[i];\r\n\t\t\t}\r\n\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thistoryPush({url: newQueryString});\r\n\t}\r\n\r\n\thandle_special_instruction_notes();\r\n\thandle_cancel_order();\r\n\thandle_delete_saved_order();\r\n\r\n\thandle_free_menu_item_edit();\r\n\thandle_fundraiser_selection();\r\n\thandle_ltd_round_up();\r\n\thandleDirectOrderDiscountFocusing();\r\n\r\n\t$('#shipping_phone_number').trigger('change');\r\n\r\n\thandleAutoOrderButtons();\r\n\r\n\t$('#selectedBundle').trigger('change');\r\n\r\n\tinitNoInventoryRows();\r\n\r\n\thandleDinnerDollarAccordion();\r\n\thandleAdminNoteAccordion();\r\n\r\n\tsetMealCustomizationDefault();\r\n\r\n}\r\nfunction setMealCustomizationDefault()\r\n{\r\n\tif( $('#opted_to_customize_recipes').length && default_meal_customization_to_selected == true && $('#opted_to_customize_recipes').prop('checked'))\r\n\t{\r\n\t\t$('#opted_to_customize_recipes').click();\r\n\t}\r\n}\r\n\r\nfunction handleDinnerDollarAccordion()\r\n{\r\n\t$(\".dd_accordion_header\").click(function () {\r\n\r\n\t\t$header = $(this);\r\n\t\t$content = $(\".dd_accordion_content\");\r\n\t\t$header.html(function () {\r\n\t\t\treturn ($content.is(\":visible\") ? \"Show \" : \"Hide \") + \"Recent Dinner Dollar History\" + ($content.is(\":visible\") ? \" &#8744;\" : \" &#8743;\");\r\n\t\t});\r\n\t\t$content.slideToggle(500, function () {\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction handleAdminNoteAccordion()\r\n{\r\n\t$(\".dod_accordion_header\").click(function () {\r\n\r\n\t\t$header = $(this);\r\n\t\t$content = $(\".dod_accordion_content\");\r\n\t\t$header.html(function () {\r\n\t\t\treturn ($content.is(\":visible\") ? \"Show \" : \"Hide \") + \"Admin Order Notes\" + ($content.is(\":visible\") ? \" &#8744;\" : \" &#8743;\");\r\n\t\t});\r\n\t\t$content.slideToggle(500, function () {\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction initNoInventoryRows()\r\n{\r\n\t$('.inventory-row').each(function () {\r\n\t\tlet remaining = $(this).data('orig-remaining');\r\n\t\tlet servings = $(this).data('servings');\r\n\t\tlet entree_id = $(this).data('entree');\r\n\t\tif (remaining < servings)\r\n\t\t{\r\n\r\n\t\t\t$itemCount = $('input[name=\"qty_' + entree_id + '\"]').val();\r\n\t\t\tif ($itemCount == 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).find(\"input,button,textarea,select,a,td\").addClass('text-muted');\r\n\t\t\t\t$(this).find(\"img\").hide();\r\n\t\t\t}\r\n\t\t}\r\n\t})\r\n}\r\n\r\nfunction handleAutoOrderButtons(e, size)\r\n{\r\n\r\n\t$(\"#selectMediumStarterPackEntrees\").on('click', function (e) {\r\n\r\n\t\tvar countMissedMeals = 0;\r\n\r\n\t\t$(\"[id^='bnd_'] input\").each(function () {\r\n\r\n\t\t\tif ($(this).data('pricing_type') == 'HALF')\r\n\t\t\t{\r\n\t\t\t\tvar id = this.id.split(\"_\")[1];\r\n\r\n\t\t\t\t$(\"#qty_\" + id).each(function () {\r\n\r\n\t\t\t\t\tvar entreeID = $(this).data('entreeid');\r\n\r\n\t\t\t\t\tvar curInventory = entreeIDToInventoryMap[entreeID].remaining;\r\n\r\n\t\t\t\t\tif (3 > curInventory)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcountMissedMeals++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(this).val(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n\r\n\t$(\"#selectLargeStarterPackEntrees\").on('click', function (e) {\r\n\t\tvar countMissedMeals = 0;\r\n\r\n\t\t$(\"[id^='bnd_'] input\").each(function () {\r\n\r\n\t\t\tif ($(this).data('pricing_type') == 'FULL')\r\n\t\t\t{\r\n\t\t\t\tvar id = this.id.split(\"_\")[1];\r\n\r\n\t\t\t\t$(\"#qty_\" + id).each(function () {\r\n\r\n\t\t\t\t\tvar entreeID = $(this).data('entreeid');\r\n\r\n\t\t\t\t\tvar curInventory = entreeIDToInventoryMap[entreeID].remaining;\r\n\r\n\t\t\t\t\tif (6 > curInventory)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcountMissedMeals++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(this).val(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (countMissedMeals > 0)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: '1 or more items could not be selected due to lack of inventory.  Please review the selections and adjust to select a full 12 item order.'\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tcalculateTotal();\r\n\t\tsetItemTabAsDirty();\r\n\r\n\t\te.preventDefault();\r\n\r\n\t});\r\n\r\n}\r\n\r\nvar intenseLoggingOn = true;\r\n\r\nfunction handleDirectOrderDiscountFocusing()\r\n{\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").focus(function (e) {\r\n\r\n\t\tif ($(this).val() == 0)\r\n\t\t{\r\n\t\t\t$(this).val(\"\");\r\n\t\t}\r\n\t\tif ($(this).val().length > 0)\r\n\t\t{\r\n\t\t\t$(this).select();\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").blur(function (e) {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tcurVal = (curVal.trim());\r\n\r\n\t\tif (curVal == \"\" || isNaN(curVal))\r\n\t\t{\r\n\t\t\t$(this).val(\"0\");\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction intenseLogging(message)\r\n{\r\n\tif (window.console && intenseLoggingOn)\r\n\t{\r\n\t\tconsole.log('OM Intense logging: ' + message);\r\n\t}\r\n}\r\n\r\nfunction saveSpecialInstructions()\r\n{\r\n\r\n\tvar special_instructions = strip_tags($(\"#order_user_notes\").val());\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_special_instructions',\r\n\t\t\torder_id: order_id,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tupdateInstructionsOrgValues();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveSpecialInstructions: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"saveSpecialInstructions: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction handle_special_instruction_notes()\r\n{\r\n\t$('[id^=\"gd_special_instruction_note_button-\"]').each(function () {\r\n\r\n\t\t$(this).on('click', function (e) {\r\n\r\n\t\t\tvar booking_id = $(this).data('booking_id');\r\n\t\t\tvar user_id = $(this).data('user_id');\r\n\t\t\tvar do_op = 'get';\r\n\t\t\tvar special_instructions = '';\r\n\r\n\t\t\tif ($(this).data('edit_mode') == true)\r\n\t\t\t{\r\n\t\t\t\tdo_op = 'save';\r\n\r\n\t\t\t\tspecial_instructions = strip_tags($('#gd_special_instruction_note-' + booking_id + ' > textarea').val());\r\n\t\t\t}\r\n\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\t\top: 'update_special_instructions',\r\n\t\t\t\t\t'do': do_op,\r\n\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\tnote: special_instructions\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (do_op == 'get')\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar textarea_elem = $('<textarea></textarea>').addClass('form-control').val((json.special_instruction_note ? json.special_instruction_note : \"\")).on('keyup', function (e) {\r\n\r\n\t\t\t\t\t\t\t\tif ($(this).val() != strip_tags($(this).val()))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(this).val(strip_tags($(this).val()));\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).addClass('special_instruction_note_edit').html(textarea_elem);\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', true).html('Save Note');\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).data('special_instruction_note_value', (json.special_instruction_note ? json.special_instruction_note : \"\")).on('click', function (e) {\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + $(this).data('booking_id')).removeClass('special_instruction_note_edit').html($(this).data('special_instruction_note_value'));\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + $(this).data('booking_id')).data('edit_mode', false).html('Special Instructions');\r\n\r\n\t\t\t\t\t\t\t\t$(this).hide();\r\n\r\n\t\t\t\t\t\t\t}).show();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).removeClass('special_instruction_note_edit').html(nl2br(json.special_instruction_note));\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).hide();\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', false).html('Special Instructions');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\tintenseLogging(\"handle_special_instruction_notes: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\t\t\tresponse = 'Unexpected error';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nvar lastCheckedGiftCertNumber = null;\r\n\r\nfunction setUpKeyHandlers()\r\n{\r\n\tdocument.onkeypress = OMDefaultKeyHandler;\r\n\r\n\t$(\"#coupon_code\").on('keypress', function (evt) {\r\n\t\t// the enter key will submit a coupon code\r\n\t\tevt = (evt) ? evt : event;\r\n\t\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\t\tif (charCode == 13)\r\n\t\t{\r\n\t\t\tprocessCode();\r\n\t\t\tevt.stopPropagation();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#order_user_notes\").on('keypress', function (evt) {\r\n\t\tevt.stopPropagation();\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#payment1_gc_payment_number\").on('keyup', function (evt) {\r\n\r\n\t\tif ($(this).val().length == 15 && !isNaN($(this).val()) && $(this).val() != lastCheckedGiftCertNumber)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Warning',\r\n\t\t\t\tmessage: \"It appears that you may be entering a gift Card number. If so, select Gift Card from payment selector. This is the Certificate (Gift Certificate) payment type.\"\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tlastCheckedGiftCertNumber = $(this).val();\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n}\r\n\r\nfunction OMDefaultKeyHandler(evt)\r\n{\r\n\t// by default the document just eats the enter key\r\n\r\n\tevt = (evt) ? evt : event;\r\n\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\tif (charCode == 13)\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction initChangeList()\r\n{\r\n\t$(\"#changeListTab\").on('click', function () {\r\n\r\n\t\tlet html = getChangeListHTML();\r\n\r\n\t\tif (!html || html == \"\")\r\n\t\t{\r\n\t\t\thtml = \"<h3><i>No Changes</i></h3>\"\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Change List',\r\n\t\t\tmessage: html,\r\n\t\t\theight: 620,\r\n\t\t\twidth: 300,\r\n\t\t\tmodal: false,\r\n\t\t\tdiv_id: 'changelist',\r\n\t\t\tdialogClass: 'fixedDialog',\r\n\t\t\tnoOk: true,\r\n\t\t\tposition: {\r\n\t\t\t\tmy: \"left top\",\r\n\t\t\t\tat: \"left bottom\",\r\n\t\t\t\tof: this\r\n\t\t\t},\r\n\t\t\tclose: function (event, ui) {\r\n\t\t\t\t$(\"#changelist\").remove();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction setupSiteAdminFunctions()\r\n{\r\n\t$(\"#in-store_status, #plate_points_status\").on('click', function () {\r\n\r\n\t\tvar flagName = this.id;\r\n\t\tvar checkbox = $(this);\r\n\t\tif (orderState != 'ACTIVE')\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"These flags can only be set on ACTIVE orders.\"\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar newState = \"off\";\r\n\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tnewState = \"on\";\r\n\t\t\t}\r\n\r\n\t\t\tvar oldState = 1;\r\n\t\t\tif (newState == \"on\")\r\n\t\t\t{\r\n\t\t\t\toldState = 0;\r\n\t\t\t}\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Status Update',\r\n\t\t\t\tmessage: \"Are you sure you want to update the order status?\",\r\n\t\t\t\tcancel: function () {\r\n\t\t\t\t\tcheckbox.prop('checked', oldState ? true : false)\r\n\r\n\t\t\t\t},\r\n\t\t\t\tconfirm: function () {\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\t\t\ttype: 'POST',\r\n\t\t\t\t\t\ttimeout: 20000,\r\n\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\t\t\top: 'update_status_flag',\r\n\t\t\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\t\t\tflag: flagName,\r\n\t\t\t\t\t\t\tnew_state: newState\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Update Success',\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\t\tintenseLogging(\"update_status_flag: \" + json.processor_message);\r\n\r\n\t\t\t\t\t\t\t\t$(this).attr(\"checked\", oldState);\r\n\r\n\t\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\t\t\t\t\tintenseLogging(\"update_status_flag: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\t\t\t\t$(this).attr(\"checked\", oldState);\r\n\r\n\t\t\t\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\tmessage: response\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction updateMealCustomizationOrgValues()\r\n{\r\n\tdd_toast({\r\n\t\tmessage: 'Meal Customization Fee Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\t$(\"#subtotal_meal_customization_fee\").data('org_value', $(\"#subtotal_meal_customization_fee\").val());\r\n\r\n}\r\nfunction updateItemsOrgValues()\r\n{\r\n\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\t$('#selectedBundle').data('org_value', $('#selectedBundle').is(':checked') ? \"1\" : \"0\");\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t$(this).data('org_value', $(this).val());\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t$(this).data('org_value', $(this).is(':checked') ? \"1\" : \"0\");\r\n\t\t});\r\n\t}\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction saveAll()\r\n{\r\n\tsaveItems(true, false, true);\r\n}\r\n\r\nfunction saveItems(saveDiscountsUponCompletion, activateOnSaveDiscountsCompletion, saveDeliveryAddressUponCompletion)\r\n{\r\n\r\n\tintenseLogging(\"saveItems() called\");\r\n\r\n\tif (currentlySavingOrder)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Items are still being saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tdd_toast({\r\n\t\tmessage: 'Items Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\r\n\tvar itemsList = {};\r\n\tvar introItemsList = {};\r\n\tvar subItemsList = {};\r\n\r\n\tvar is_intro = \"false\";\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// this will pick up any FT items\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($(\"#selectedBundle\").is(\":checked\"))\r\n\t\t{\r\n\r\n\t\t\tis_intro = \"true\";\r\n\r\n\t\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\t\tintroItemsList[item_id] = \"on\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\t$(\"[id^=sbi_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\tsubItemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tvar misc_food_subtotal = $(\"#misc_food_subtotal\").val();\r\n\tif (isNaN(misc_food_subtotal))\r\n\t{\r\n\t\tmisc_food_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_nonfood_subtotal = $(\"#misc_nonfood_subtotal\").val();\r\n\tif (isNaN(misc_nonfood_subtotal))\r\n\t{\r\n\t\tmisc_nonfood_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_service_fee = $(\"#subtotal_service_fee\").val();\r\n\tif (isNaN(subtotal_service_fee))\r\n\t{\r\n\t\tsubtotal_service_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_delivery_fee = $(\"#subtotal_delivery_fee\").val();\r\n\tif (isNaN(subtotal_delivery_fee))\r\n\t{\r\n\t\tsubtotal_delivery_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_food_subtotal_desc = $(\"#misc_food_subtotal_desc\").val();\r\n\tvar misc_nonfood_subtotal_desc = $(\"#misc_nonfood_subtotal_desc\").val();\r\n\tvar service_fee_description = $(\"#service_fee_description\").val();\r\n\r\n\tvar special_instructions = $(\"#order_user_notes\").val();\r\n\r\n\tvar ltdOrderedMealsArray = $(\"#ltdOrderedMealsArray\").val();\r\n\r\n\tvar bagFeeTotal = 0;\r\n\tvar bagFeeCount = 0;\r\n\tif (storeSupportsBagFees)\r\n\t{\r\n\t\tvar bagFeeCount = $(\"#total_bag_count\").val();\r\n\r\n\t\tif (isNaN(bagFeeCount))\r\n\t\t{\r\n\t\t\tbagFeeCount = 0;\r\n\t\t}\r\n\r\n\t\tbagFeeTotal = storeDefaultBagFee * bagFeeCount;\r\n\t}\r\n\r\n\tlet opted_to_bring_bags = $(\"#opted_to_bring_bags\").is(\":checked\");\r\n\r\n\tlet manual_customization_fee = $(\"#manual_customization_fee\").val();\r\n\tlet opted_to_customize = ($(\"#opted_to_customize_recipes\").length > 0 && !$(\"#opted_to_customize_recipes\").is(\":checked\"));\r\n\tlet mealCustomizationFee = $(\"#subtotal_meal_customization_fee\").val();\r\n\r\n\tcurrentlySavingOrder = true;\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_items',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: itemsList,\r\n\t\t\tmisc_food_subtotal: misc_food_subtotal,\r\n\t\t\tmisc_nonfood_subtotal: misc_nonfood_subtotal,\r\n\t\t\tsubtotal_service_fee: subtotal_service_fee,\r\n\t\t\tmisc_food_subtotal_desc: misc_food_subtotal_desc,\r\n\t\t\tmisc_nonfood_subtotal_desc: misc_nonfood_subtotal_desc,\r\n\t\t\tservice_fee_description: service_fee_description,\r\n\t\t\tsubtotal_delivery_fee: subtotal_delivery_fee,\r\n\t\t\tmanual_customization_fee: manual_customization_fee,\r\n\t\t\topted_to_customize: opted_to_customize,\r\n\t\t\tmeal_customization_fee: mealCustomizationFee,\r\n\t\t\tis_intro: is_intro,\r\n\t\t\tintro_items: introItemsList,\r\n\t\t\tsub_items: subItemsList,\r\n\t\t\tltdOrderedMealsArray: ltdOrderedMealsArray,\r\n\t\t\tspecial_instructions: special_instructions,\r\n\t\t\tstoreSupportsBagFees: storeSupportsBagFees,\r\n\t\t\tbagFeeTotal: bagFeeTotal,\r\n\t\t\tbagFeeCount: bagFeeCount,\r\n\t\t\topted_to_bring_bags: opted_to_bring_bags\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tfeesTabIsDirty = false;\r\n\t\t\t\tif(opted_to_customize){\r\n\t\t\t\t\tupdateMealCustomizationOrgValues();\r\n\t\t\t\t}\r\n\t\t\t\tupdateItemsOrgValues();\r\n\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"saveItems() successful\");\r\n\r\n\t\t\t\tif (saveDiscountsUponCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDiscounts(activateOnSaveDiscountsCompletion, saveDeliveryAddressUponCompletion);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"update_items: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tcurrentlySavingOrder = false;\r\n\t\t\tintenseLogging(\"update_items: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction setSessionAndSave(session_id)\r\n{\r\n\r\n\tintenseLogging(\"setSessionAndSave() called\");\r\n\r\n\tdisplayModalWaitDialog('saving_div', \"Setting session. Please wait ...\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'set_session_and_save',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val()\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"setSessionAndSave() successful\");\r\n\r\n\t\t\t\tif (json.full_session_warning_required)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr&order=\" + json.order_id + \"&session_full=true\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"#saving_div\").remove();\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tintenseLogging(\"set_session_and_save: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t$(\"#saving_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"set_session_and_save: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction Reschedule(org_session_id, transition_type, suppressEmail)\r\n{\r\n\r\n\tintenseLogging(\"Reschedule() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'reschedule',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tsaved_booking_id: saved_booking_id,\r\n\t\t\torg_session_id: org_session_id,\r\n\t\t\torder_state: orderState,\r\n\t\t\ttransition_type: transition_type,\r\n\t\t\tsuppressEmail: suppressEmail\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"Reschedule() successful\");\r\n\r\n\t\t\t\tsession_id = json.new_session_id;\r\n\t\t\t\t$(\"#curSessionDate\").html(json.new_session_time);\r\n\r\n\t\t\t\t$(\"#session\").val(json.new_session_id);\r\n\r\n\t\t\t\tRetrieveCalendar(0);\r\n\r\n\t\t\t\tif (!json.canDelayPayment)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\".delayedPaymentSection\").hideFlex();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\".delayedPaymentSection\").showFlex();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (json.session_discount)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#noSessionDiscountRow\").hide();\r\n\t\t\t\t\t$(\"#newSessionDiscountBody\").show();\r\n\t\t\t\t\t$(\"#sessionDiscountTypeSpan\").html(json.session_discount.type);\r\n\t\t\t\t\t$(\"#sessionDiscountValueSpan\").html(json.session_discount.value);\r\n\t\t\t\t\tactiveSessionDiscount.id = json.session_discount.id;\r\n\t\t\t\t\tactiveSessionDiscount.type = json.session_discount.type;\r\n\t\t\t\t\tactiveSessionDiscount.value = json.session_discount.value;\r\n\t\t\t\t\tcalculateTotal();\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#noSessionDiscountRow\").show();\r\n\t\t\t\t\t$(\"#newSessionDiscountBody\").hide();\r\n\t\t\t\t\tactiveSessionDiscount.id = 0;\r\n\t\t\t\t\tactiveSessionDiscount.type = 'none';\r\n\t\t\t\t\tactiveSessionDiscount.value = 0;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(\"#curSessionTypeSpan\").html(json.session_info.session_type_title);\r\n\t\t\t\t$(\"#curSessionRemainingSlotsSpan\").html(json.session_info.remaining_slots);\r\n\t\t\t\t$(\"#curSessionRemainingIntroSlotsSpan\").html(json.session_info.remaining_intro_slots);\r\n\r\n\t\t\t\tif (json.client_ops.hasOwnProperty('require_delivery_address') && !$(\"#shipping_address_line1\").length)\r\n\t\t\t\t{\r\n\t\t\t\t\t// rather than load a new tab for now just reload the page\r\n\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor (var key in json.client_ops)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (json.client_ops.hasOwnProperty(key))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tswitch (key)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tcase 'adj_service_fee':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"#subtotal_service_fee\").val(json.client_ops[key]);\r\n\t\t\t\t\t\t\t\t$(\"#OEH_subtotal_service_fee_org\").html(formatAsMoney(json.client_ops[key]));\r\n\t\t\t\t\t\t\t\tid = \"OEH_subtotal_service_fee_org\"\r\n\t\t\t\t\t\t\t\tcalculateTotal();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'update_svc_fee_desc':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"#service_fee_description\").val(json.client_ops[key]);\r\n\t\t\t\t\t\t\t\tcalculateTotal();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'adj_delivery_fee':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tif (!$(\"#subtotal_delivery_fee\").length)\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t// The current DOM has no delivery fee field so for now causea refresh\r\n\t\t\t\t\t\t\t\t\tbounce(window.location.href);\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t$(\"#subtotal_delivery_fee\").val(json.client_ops[key]);\r\n\t\t\t\t\t\t\t\t$(\"#OEH_subtotal_delivery_fee_org\").html(formatAsMoney(json.client_ops[key]));\r\n\t\t\t\t\t\t\t\tcalculateTotal();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'require_delivery_address':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"[id^='shipping_']\").each(function () {\r\n\t\t\t\t\t\t\t\t\t$(this).attr('required', 'required');\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'delete_delivery_address':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"#delivery_tab_li\").remove();\r\n\t\t\t\t\t\t\t\t$(\"#delivery\").remove();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"reschedule: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"reschedule: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction onSetSessionAndSave(obj)\r\n{\r\n\tintenseLogging(\"onSetSessionAndSave() called\");\r\n\r\n\tvar session_id = $(\"#selected_session\").attr(\"data-session_id\");\r\n\tsetSessionAndSave(session_id);\r\n\treturn false;\r\n}\r\n\r\nfunction onSaveItems()\r\n{\r\n\tintenseLogging(\"onSaveItems() called\");\r\n\r\n\tsaveItems(false, false, false);\r\n\treturn false;\r\n\r\n}\r\n\r\nfunction setupForNewOrder()\r\n{\r\n\tHideLineItemsIfZero();\r\n\tvar timestamp = getQueryVariable('month');\r\n\tif (!timestamp)\r\n\t{\r\n\t\ttimestamp = \"0\";\r\n\t}\r\n\tRetrieveCalendar(timestamp);\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\r\n}\r\n\r\nfunction setupForSavedOrder()\r\n{\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n}\r\n\r\nfunction setupForActiveOrder()\r\n{\r\n\tif (discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").click();\r\n\r\n\t\t$(\"#items_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#fees_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#sessions_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#discountsDiv\").find(\":input\").prop(\"disabled\", true);\r\n\t\t$(\"#discountsDiv\").find(\"*\").addClass(\"om_disabled\");\r\n\r\n\t}\r\n\r\n\t$(\"#addPaymentAndActivate\").hide();\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n}\r\n\r\nfunction isDeliveryAddressComplete()\r\n{\r\n\tvar validated = true;\r\n\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\r\n\t\tif (!$(this).val() && $(this).attr('required'))\r\n\t\t{\r\n\t\t\tvalidated = false;\r\n\t\t}\r\n\t});\r\n\treturn validated;\r\n}\r\n\r\nfunction saveDeliveryAddress(payOnCompletion, token)\r\n{\r\n\r\n\tvar shipping_data = {};\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\t\tshipping_data[this.id] = $(this).val();\r\n\t});\r\n\r\n\tintenseLogging(\"saveDeliveryAddress() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 200000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'save_delivery_address',\r\n\t\t\torder_id: order_id,\r\n\t\t\tshipping_data: shipping_data\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDeliveryAddress() successful\");\r\n\r\n\t\t\t\tdd_toast({\r\n\t\t\t\t\tmessage: 'Delivery Address Saved',\r\n\t\t\t\t\tposition: 'topcenter'\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, token);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"save_delivery_address: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"save_delivery_address: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDeliveryTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onDeliveryTabDeselected()\r\n{\r\n\tif (!isDeliveryAddressComplete())\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please check the Delivery Address and phone number fields for completeness.'\r\n\t\t});\r\n\r\n\t\treturn false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsaveDeliveryAddress(false, false);\r\n\t\treturn true;\r\n\t}\r\n\r\n}\r\n\r\nfunction onSessionTabSelected()\r\n{\r\n\tRetrieveCalendar(0);\r\n}\r\n\r\nfunction onSessionTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onItemsTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onItemsTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\tif (itemTabIsDirty)\r\n\t\t{\r\n\t\t\t/*\r\n\t\t\t dd_message({\r\n\t\t\t title: 'Attention',\r\n\t\t\t message: 'You have unsaved changes. Do you wish to save changes to the items tab?',\r\n\t\t\t confirm: function() {\r\n\t\t\t }\r\n\t\t\t });\r\n\t\t\t */\r\n\r\n\t\t\tsaveItems(false, false, false);\r\n\t\t}\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onFeesTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onFeesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentTabSelected()\r\n{\r\n\thandle_admin_order_notes();\r\n\thandle_free_menu_item_edit();\r\n}\r\n\r\nfunction onPaymentTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE' && (discountChanges || reportingChanges))\r\n\t{\r\n\t\tsaveDiscounts(false, false);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onRelatedOrdersTabSelected()\r\n{\r\n\tif (!relatedOrdersAreLoaded)\r\n\t{\r\n\r\n\t\tintenseLogging(\"Loading related Orders\");\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'retrieve_related_orders',\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\r\n\t\t\t\tintenseLogging(\"Loading related Orders successful\");\r\n\r\n\t\t\t\t$(\"#related_orders\").html(json.data);\r\n\t\t\t\t$(\"#loading_related_orders\").remove();\r\n\t\t\t\trelatedOrdersAreLoaded = true;\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#loading_related_orders\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"retrieve_related_orders: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nfunction onRelatedOrdersTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onNotesTabSelected()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_history',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$(\"#history_div\").html(json.html);\r\n\r\n\t\t\thandle_guest_account_notes();\r\n\r\n\t\t\thandle_admin_carryover_notes();\r\n\r\n\t\t\thandle_admin_order_notes();\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"get_history: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onNotesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentSelected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n}\r\n\r\nfunction onPaymentDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\t\tupdateChangeList();\r\n\t\tpaymentChanges = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = false;\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction onSiteAdminTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onSiteAdminTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction updateDiscountOrgValues()\r\n{\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\t$(\"#org_coupon_id\").val($(\"#coupon_id\").val());\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction updateActiveOrder(payOnCompletion, go_to_confirm)\r\n{\r\n\tintenseLogging(\"updateActiveOrder() called\");\r\n\r\n\tvar itemsList = {};\r\n\tvar introItemsList = {};\r\n\tvar subItemsList = {};\r\n\r\n\tvar is_intro = \"false\";\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t//pick up any sides\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($(\"#selectedBundle\").is(\":checked\"))\r\n\t\t{\r\n\r\n\t\t\tis_intro = \"true\";\r\n\r\n\t\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\t\tintroItemsList[item_id] = \"on\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id^=sbi_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\tsubItemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tvar misc_food_subtotal = $(\"#misc_food_subtotal\").val();\r\n\tif (isNaN(misc_food_subtotal))\r\n\t{\r\n\t\tmisc_food_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_nonfood_subtotal = $(\"#misc_nonfood_subtotal\").val();\r\n\tif (isNaN(misc_nonfood_subtotal))\r\n\t{\r\n\t\tmisc_nonfood_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_service_fee = $(\"#subtotal_service_fee\").val();\r\n\tif (isNaN(subtotal_service_fee))\r\n\t{\r\n\t\tsubtotal_service_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_delivery_fee = $(\"#subtotal_delivery_fee\").val();\r\n\tif (isNaN(subtotal_delivery_fee))\r\n\t{\r\n\t\tsubtotal_delivery_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_food_subtotal_desc = $(\"#misc_food_subtotal_desc\").val();\r\n\tvar misc_nonfood_subtotal_desc = $(\"#misc_nonfood_subtotal_desc\").val();\r\n\tvar service_fee_description = $(\"#service_fee_description\").val();\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar PUDSetting = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\tif (PUDSetting == null || PUDSetting == \"\")\r\n\t{\r\n\t\tPUDSetting = \"noUP\";\r\n\t}\r\n\r\n\tvar plate_points_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(plate_points_discount))\r\n\t{\r\n\t\tplate_points_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar SessDiscSetting = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\tif (SessDiscSetting == null || SessDiscSetting == \"\")\r\n\t{\r\n\t\tSessDiscSetting = \"noSD\";\r\n\t}\r\n\r\n\tvar DR_level = 0;\r\n\tif ($(\"#dr_level_for_order\").length)\r\n\t{\r\n\t\tvar curOrderLevel = $(\"#dr_level_for_order\").val();\r\n\t\tif (curOrderLevel > 0)\r\n\t\t{\r\n\t\t\tDR_level = curOrderLevel;\r\n\t\t}\r\n\t}\r\n\r\n\tvar ltdOrderedMealsArray = $(\"#ltdOrderedMealsArray\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_active_order',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: itemsList,\r\n\t\t\tmisc_food_subtotal: misc_food_subtotal,\r\n\t\t\tmisc_nonfood_subtotal: misc_nonfood_subtotal,\r\n\t\t\tsubtotal_service_fee: subtotal_service_fee,\r\n\t\t\tsubtotal_delivery_fee: subtotal_delivery_fee,\r\n\t\t\tmisc_food_subtotal_desc: misc_food_subtotal_desc,\r\n\t\t\tmisc_nonfood_subtotal_desc: misc_nonfood_subtotal_desc,\r\n\t\t\tservice_fee_description: service_fee_description,\r\n\t\t\tis_intro: is_intro,\r\n\t\t\tintro_items: introItemsList,\r\n\t\t\tsub_items: subItemsList,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tPUDSetting: PUDSetting,\r\n\t\t\tplate_points_discount: plate_points_discount,\r\n\t\t\tSessDiscSetting: SessDiscSetting,\r\n\t\t\tdream_rewards_level: DR_level,\r\n\t\t\tchangeList: JSON.stringify(changeList),\r\n\t\t\tchangeListStr: getChangeListHTML(),\r\n\t\t\tltdOrderedMealsArray: ltdOrderedMealsArray,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val()\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"updateActiveOrder() successful\");\r\n\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tupdateItemsOrgValues();\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(payOnCompletion, go_to_confirm, json.getTokenToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_active_order: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"update_active_order: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction _validate_discounts()\r\n{\r\n\t// check to see if coupon requires free menu selection\r\n\tif (couponFreeMenuItemRequired)\r\n\t{\r\n\t\treturn _check_elements([$('#free_menu_item_coupon').get(0)]);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction saveDiscounts(payOnCompletion, saveDeliveryAddressUponCompletion)\r\n{\r\n\tintenseLogging(\"saveDiscounts() called\");\r\n\r\n\tif (!_validate_discounts())\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (!payOnCompletion)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Discounts Saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t}\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar PUDSetting = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\tif (PUDSetting == null || PUDSetting == \"\")\r\n\t{\r\n\t\tPUDSetting = \"noUP\";\r\n\t}\r\n\r\n\tvar plate_points_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(plate_points_discount))\r\n\t{\r\n\t\tplate_points_discount = \"0.00\";\r\n\t}\r\n\r\n\tlet referral_reward_discount = $(\"#referral_reward_discount\").val();\r\n\tif (isNaN(referral_reward_discount))\r\n\t{\r\n\t\treferral_reward_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar SessDiscSetting = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\tif (SessDiscSetting == null || SessDiscSetting == \"\")\r\n\t{\r\n\t\tSessDiscSetting = \"noSD\";\r\n\t}\r\n\r\n\tvar DR_level = 0;\r\n\tif ($(\"#dr_level_for_order\").length)\r\n\t{\r\n\t\tvar curOrderLevel = $(\"#dr_level_for_order\").val();\r\n\t\tif (curOrderLevel > 0)\r\n\t\t{\r\n\t\t\tDR_level = curOrderLevel;\r\n\t\t}\r\n\t}\r\n\r\n\tvar coupon_id = 0;\r\n\tvar coupon_free_menu_item = 0;\r\n\tif ($(\"#coupon_id\").val())\r\n\t{\r\n\t\tif (couponFreeMenuItemRequired)\r\n\t\t{\r\n\t\t\tif ($('#free_menu_item_coupon').val())\r\n\t\t\t{\r\n\t\t\t\tcoupon_free_menu_item = $('#free_menu_item_coupon').val();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tcoupon_id = $(\"#coupon_id\").val();\r\n\t}\r\n\r\n\tvar fundraiser_id = $('#fundraiser_id').val();\r\n\tvar fundraiser_value = $('#fundraiser_value').val();\r\n\tvar add_ltd_round_up = ($('#add_ltd_round_up').is(':checked') ? true : false);\r\n\tvar ltd_round_up_select = $('#ltd_round_up_select').val();\r\n\r\n\tvar bagFeeTotal = 0;\r\n\tvar bagFeeCount = 0;\r\n\tif (storeSupportsBagFees)\r\n\t{\r\n\t\tvar bagFeeCount = $(\"#total_bag_count\").val();\r\n\r\n\t\tif (isNaN(bagFeeCount))\r\n\t\t{\r\n\t\t\tbagFeeCount = 0;\r\n\t\t}\r\n\r\n\t\tbagFeeTotal = storeDefaultBagFee * bagFeeCount;\r\n\t}\r\n\r\n\tlet opted_to_bring_bags = $(\"#opted_to_bring_bags\").is(\":checked\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'update_discounts',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tPUDSetting: PUDSetting,\r\n\t\t\tplate_points_discount: plate_points_discount,\r\n\t\t\treferral_reward_discount: referral_reward_discount,\r\n\t\t\tSessDiscSetting: SessDiscSetting,\r\n\t\t\tcoupon_id: coupon_id,\r\n\t\t\tcoupon_free_menu_item: coupon_free_menu_item,\r\n\t\t\tdream_rewards_level: DR_level,\r\n\t\t\tfundraiser_id: fundraiser_id,\r\n\t\t\tfundraiser_value: fundraiser_value,\r\n\t\t\tadd_ltd_round_up: add_ltd_round_up,\r\n\t\t\tltd_round_up_select: ltd_round_up_select,\r\n\t\t\tstoreSupportsBagFees: storeSupportsBagFees,\r\n\t\t\tbagFeeTotal: bagFeeTotal,\r\n\t\t\tbagFeeCount: bagFeeCount,\r\n\t\t\topted_to_bring_bags: opted_to_bring_bags\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDiscounts() successful\");\r\n\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\t\t\t\tupdateReportingOrgValues();\r\n\r\n\t\t\t\tif (coupon_free_menu_item)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#free_menu_item_coupon').attr('disabled', true);\r\n\t\t\t\t\tcouponFreeMenuItem = coupon_free_menu_item;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (saveDeliveryAddressUponCompletion && $(\"#shipping_firstname\")[0])\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDeliveryAddress(payOnCompletion, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t\telse if (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_discounts: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"update_discounts: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction updateReportingOrgValues()\r\n{\r\n\t$('#fundraiser_id').data('org_value', $('#fundraiser_id').val());\r\n\t$('#fundraiser_value').data('org_value', $('#fundraiser_value').val());\r\n\t$('#ltd_round_up_select').data('org_value', $('#ltd_round_up_select').val());\r\n\t$('#OEH_ltd_round_up_org').data('org_value', $('#ltd_round_up_select').val());\r\n\r\n\tif ($('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\t$('#add_ltd_round_up').data('org_value', true);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#add_ltd_round_up').data('org_value', false);\r\n\t}\r\n\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction send(token, paymentNumber, warnOfOutstandingSavedOrdersOnFullSession, addOnly, go_to_confirm, payment1Data)\r\n{\r\n\r\n\tintenseLogging(\"send() called for payment# \" + paymentNumber);\r\n\r\n\t$('#paypal-result').on(\"load\", function () {\r\n\r\n\t\tintenseLogging(\"result iFrame loading\");\r\n\r\n\t\ttry\r\n\t\t{\r\n\t\t\tvar next_dest = $('#paypal-result').get(0).contentWindow.next_dest;\r\n\t\t\tvar success = $('#paypal-result').get(0).contentWindow.pp_success;\r\n\r\n\t\t}\r\n\t\tcatch (e)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"exception occurred accessing result iframe\");\r\n\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Exception',\r\n\t\t\t\tmessage: 'We are sorry but an unexpected error occurred during payment processing. Please try again or contact support.'\r\n\t\t\t});\r\n\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// in Safari - exception is not thrown and success is undefined\r\n\t\t// the test is false and we drop into the success = false block\r\n\t\t// then error_code and message also are set to undefined\r\n\r\n\t\tif (success)\r\n\t\t{\r\n\t\t\tintenseLogging(\"success found in iframe\");\r\n\r\n\t\t\tbounce(next_dest);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar error_code = $('#paypal-result').get(0).contentWindow.error_code;\r\n\t\t\tvar message = $('#paypal-result').get(0).contentWindow.message;\r\n\r\n\t\t\tintenseLogging(\"error found in iframe: #\" + error_code + \" | \" + message);\r\n\r\n\t\t\tif (typeof error_code == 'undefined')\r\n\t\t\t{\r\n\t\t\t\terror_code = \"Generic\";\r\n\t\t\t\tmessage = 'Some required information is missing or incorrect. Please correct the fields below and try again.';\r\n\r\n\t\t\t\tintenseLogging(\"error code undefined in iframe\");\r\n\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\tmessage: message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t\telse if (next_dest && next_dest.length > 0)\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"Okay\": function () {\r\n\t\t\t\t\t\t\tbounce(next_dest);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tvar reload = $('#paypal-result').get(0).contentWindow.reloadOnFailure;\r\n\r\n\t\t\t\tif (reload)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"reloadOnFailure found in iframe: reloading\");\r\n\r\n\t\t\t\t\tmessage += \"<br /><br /><span style='color:red'>The credit card payment failed however the order was booked with the gift certificate. The page will now reload.</span>\";\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\t\tmessage: message,\r\n\t\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\"Okay\": function () {\r\n\t\t\t\t\t\t\t\tbounce(window.location.href);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\t\tmessage: message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t});\r\n\r\n\tvar comment_payload = new PayFlow_Payload();\r\n\r\n\tcomment_payload.addNameValuePair('UserID', user_id);\r\n\tcomment_payload.addNameValuePair('StoreID', STORE_DETAILS.id);\r\n\tcomment_payload.addNameValuePair('OrderID', order_id); // TODO: need id here of somekind so the payment can be tracked to an order. Either we create a \"blank\" order\r\n\t// or we use another id that is tied to the order when it is later inserted.\r\n\tcomment_payload.addNameValuePair('Email', user_email);\r\n\r\n\tif (paymentNumber == 1)\r\n\t{\r\n\t\tvar expdate = $(\"#payment1_ccMonth\").val();\r\n\t\texpdate += $(\"#payment1_ccYear\").val();\r\n\t\tvar csc = $(\"#payment1_cc_security_code\").val();\r\n\t\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t\tvar payload = new PayFlow_Payload();\r\n\r\n\t\tpayload.addNameValuePair('admin_user_id', USER_DETAILS.id);\r\n\t\tpayload.addNameValuePair('user_id', user_id);\r\n\t\tpayload.addNameValuePair('store_id', STORE_DETAILS.id);\r\n\t\tpayload.addNameValuePair('order_id', order_id);\r\n\t\tpayload.addNameValuePair('caller_id', 'fadmin_order');\r\n\t\tif (addOnly)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('add_only', 'true');\r\n\t\t}\r\n\t\tif (go_to_confirm)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('go_to_confirm', 'true');\r\n\t\t}\r\n\t\tpayload.addNameValuePair('is_second_payment', 'false');\r\n\r\n\t\tvar use_store_credits = false;\r\n\t\tvar store_credit_amount = 0;\r\n\t\tif ($(\"#use_store_credits\").length)\r\n\t\t{\r\n\t\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\t\tpayload.addNameValuePair('use_sc', 'true');\r\n\t\t\t\tpayload.addNameValuePair('sc_amt', store_credit_amount);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\tpayload.addNameValuePair('DP_State', DP_State);\r\n\t\t\t\tpayload.addNameValuePair('org_amount', amt);\r\n\r\n\t\t\t\tvar depositAmount = 20;\r\n\t\t\t\tif (DP_State == 1 && store_specific_deposit && store_specific_deposit > 20)\r\n\t\t\t\t{\r\n\t\t\t\t\tdepositAmount = store_specific_deposit;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (amt * 1 <= depositAmount * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Delayed Payment Error',\r\n\t\t\t\t\t\tmessage: \"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tamt = depositAmount;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof payflowErrorURL == 'undefined')\r\n\t\t{\r\n\t\t\tpayflowErrorURL = \"https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback\";\r\n\t\t}\r\n\r\n\t\t// make PARMLIST\r\n\t\tvar parmList = 'ERRORURL=' + payflowErrorURL + \"&ACCT=\" + $(\"#payment1_ccNumber\").val() + \"&EXPDATE=\" + expdate + \"&CSC=\" + csc + \"&AMT=\" + amt + \"&USER1=\" + payload.retrieveEncodedString() + \"&COMMENT1=\" + comment_payload.retrieveEncodedString();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar expdate = $(\"#payment2_ccMonth\").val();\r\n\t\texpdate += $(\"#payment2_ccYear\").val();\r\n\t\tvar csc = $(\"#payment2_cc_security_code\").val();\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\tvar payload = new PayFlow_Payload();\r\n\r\n\t\tpayload.addNameValuePair('user_id', user_id);\r\n\t\tpayload.addNameValuePair('store_id', STORE_DETAILS.id);\r\n\t\tpayload.addNameValuePair('order_id', order_id);\r\n\t\tpayload.addNameValuePair('caller_id', 'fadmin_order');\r\n\t\tpayload.addNameValuePair('add_only', 'false');\r\n\t\tpayload.addNameValuePair('is_second_payment', 'true');\r\n\t\tif (go_to_confirm)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('go_to_confirm', 'true');\r\n\t\t}\r\n\r\n\t\tif (payment1Data)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair(\"hasPayment1\", true);\r\n\r\n\t\t\tfor (var key in payment1Data)\r\n\t\t\t{\r\n\t\t\t\tif (payment1Data.hasOwnProperty(key))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayload.addNameValuePair(\"p1_\" + key, payment1Data[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#payment2_is_store_specific_flat_rate_deposit_delayed_payment1').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\tpayload.addNameValuePair('DP_State', DP_State);\r\n\t\t\t\tpayload.addNameValuePair('org_amount', amt);\r\n\r\n\t\t\t\tvar depositAmount = 20;\r\n\t\t\t\tif (DP_State == 1 && store_specific_deposit && store_specific_deposit > 20)\r\n\t\t\t\t{\r\n\t\t\t\t\tdepositAmount = store_specific_deposit;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (amt * 1 <= depositAmount * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Delayed Payment Error',\r\n\t\t\t\t\t\tmessage: \"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tamt = depositAmount;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof payflowErrorURL == 'undefined')\r\n\t\t{\r\n\t\t\tpayflowErrorURL = \"https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback\";\r\n\t\t}\r\n\r\n\t\t// make PARMLIST\r\n\t\tvar parmList = 'ERRORURL=' + payflowErrorURL + \"&ACCT=\" + $(\"#payment2_ccNumber\").val() + \"&EXPDATE=\" + expdate + \"&CSC=\" + csc + \"&AMT=\" + amt + \"&USER1=\" + payload.retrieveEncodedString() + \"&COMMENT1=\" + comment_payload.retrieveEncodedString();\r\n\t}\r\n\r\n\tvar tr_action = 'https://payflowlink.paypal.com';\r\n\tif (typeof pfp_test_mode != 'undefined' && pfp_test_mode)\r\n\t{\r\n\t\tvar tr_action = 'https://pilot-payflowlink.paypal.com';\r\n\t}\r\n\r\n\tif (typeof transparent_redirect_link != 'undefined')\r\n\t{\r\n\t\ttr_action = transparent_redirect_link;\r\n\t}\r\n\r\n\tintenseLogging(\"posting to PayFlow\");\r\n\r\n\t// Create dynamic form to post and redirect to session_menu\r\n\tcreate_and_submit_form({\r\n\t\taction: tr_action,\r\n\t\ttarget: \"paypal-result\",\r\n\t\tinput: ({\r\n\t\t\tSECURETOKEN: token.token,\r\n\t\t\tSECURETOKENID: token.tokenID,\r\n\t\t\tPARMLIST: parmList\r\n\t\t})\r\n\t});\r\n\r\n}\r\n\r\nfunction getPaymentData(type, payment_number)\r\n{\r\n\r\n\tif (type != 'CC')\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val()\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val(),\r\n\t\t\tccNameOnCard: \"\",\r\n\t\t\tccType: 'CC',\r\n\t\t\tccMonth: \"\",\r\n\t\t\tccYear: \"\",\r\n\t\t\tcc_security_code: \"\",\r\n\t\t\tbilling_address: \"\",\r\n\t\t\tbilling_city: \"\",\r\n\t\t\tbilling_state_id: \"\",\r\n\t\t\tbilling_postal_code: \"\",\r\n\t\t\tis_store_specific_flat_rate_deposit_delayed_payment: 0,\r\n\t\t\tdo_not_ref: 0\r\n\t\t}\r\n\t}\r\n\r\n\tif (payment_number == 1)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"REFERENCE\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_reference_total_amount\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CERT\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_gc_total_amount\").val();\r\n\t\t\t\tpaymentData.cert_type = $(\"#payment1_gift_cert_type\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_gc_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFUND_CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_refund_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_refund_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CREDIT\":\r\n\t\t\t\tpaymentData.amount = $(\"#OEH_remaing_balance\").html();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment1_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment1_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment1_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment1_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment1_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_1\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_1\").val();\r\n\t\t\t\tpaymentData.billing_city = $(\"#billing_city_1\").val();\r\n\t\t\t\tpaymentData.billing_state_id = $(\"#billing_state_id_1\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_1').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CARD\":\r\n\t\t\t\tpaymentData.amount = $(\"#debit_gift_card_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#debit_gift_card_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"DPADJUST\":\r\n\t\t\t\t// TODO: ???\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p1_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\r\n\t}\r\n\telse if (payment_number == 2)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment2_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment2_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment2_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment2_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment2_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_2\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_2').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p2_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\t}\r\n\r\n}\r\n\r\nfunction validatePayment1(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\t\tcase \"REFERENCE\":\r\n\t\t\tinputArray = $(\"#payment1_reference :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CERT\":\r\n\t\t\tinputArray = $(\"#payment1_gc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment1_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFUND_CASH\":\r\n\t\t\tinputArray = $(\"#payment1_refund_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment1_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CREDIT\":\r\n\t\t\tinputArray = $(\"#payment1_credit :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment1_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CARD\":\r\n\t\t\tinputArray = $(\"#payment1_debit_gift_card :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"DPADJUST\":\r\n\t\t\tinputArray = $(\"#dp_adjust_div :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment1_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n\r\n}\r\n\r\nfunction validatePayment2(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment2_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment2_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n}\r\n\r\nfunction addPaymentAndActivate()\r\n{\r\n\tlet minimumVal = null;\r\n\tlet minimumType = null;\r\n\r\n\tif (typeof order_minimum !== 'undefined' && typeof order_minimum.minimum !== 'undefined')\r\n\t{\r\n\t\tminimumVal = order_minimum.minimum;\r\n\t\tminimumType = order_minimum.minimum_type\r\n\t}\r\n\r\n\tintenseLogging(\"addPaymentAndActivate() called\");\r\n\tlet servingsCount = 0;\r\n\tlet enforce36ServingMinimum = false;\r\n\tlet underFilledMessage = 'This order is for less than 36 servings. Do you wish to continue?';\r\n\r\n\tif (minimumVal != null)\r\n\t{\r\n\t\tunderFilledMessage = 'This order is for less than ' + minimumVal + ' ' + minimumType.toLowerCase() + 's. Do you wish to continue?';\r\n\t}\r\n\r\n\tservingsCount = Number($('#OEH_number_servings').html());\r\n\tlet itemCount = Number($('#OEH_number_core_servings').html());\r\n\r\n\tif (orderIsEligibleForMembershipDiscount && storeSupportsMembership)\r\n\t{\r\n\t\tif (membership_status.eligible_menus[menu_id].number_qualifying_orders == 0)\r\n\t\t{\r\n\t\t\tunderFilledMessage = 'This Meal Prep+ order has less than 36 core servings. Because this guest does not have a consecutive standard order for this menu month, this order is required to have at least 36 servings before a smaller order can be added.';\r\n\t\t\tenforce36ServingMinimum = true;\r\n\t\t}\r\n\t}\r\n\r\n\tlet quantityOrdered = servingsCount.valueOf();\r\n\tlet requiredMinimum = 36;\r\n\tif (minimumVal != null)\r\n\t{\r\n\t\trequiredMinimum = minimumVal;\r\n\t\tif (minimumType === 'ITEM')\r\n\t\t{\r\n\t\t\tquantityOrdered = itemCount.valueOf();\r\n\t\t}\r\n\t}\r\n\r\n\tif (quantityOrdered < requiredMinimum && enforce36ServingMinimum)\r\n\t{\r\n\t\tintenseLogging(\"addPaymentAndActivate() - warning for less than \" + requiredMinimum + '' + minimumType);\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Warning',\r\n\t\t\tmessage: underFilledMessage\r\n\t\t});\r\n\r\n\t\treturn false;\r\n\r\n\t}\r\n\telse if (quantityOrdered < requiredMinimum && !isDreamTaste && !isFundraiser && !$(\"#selectedBundle\").is(\":checked\"))\r\n\t{\r\n\r\n\t\tintenseLogging(\"addPaymentAndActivate() - warning for less than \" + requiredMinimum + '' + minimumType);\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Warning',\r\n\t\t\tmessage: underFilledMessage,\r\n\t\t\tconfirm: function () {\r\n\t\t\t\t// always first ensure that discounts are updated on server\r\n\t\t\t\tintenseLogging(\"addPaymentAndActivate() - confirm dialog\");\r\n\r\n\t\t\t\tlet message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\t\t\t\tlet changesBlurb = getAbbreviatedSummaryString();\r\n\t\t\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Add Payment and Book Order',\r\n\t\t\t\t\tdiv_id: 'aPaBO',\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\twidth: 400,\r\n\t\t\t\t\theight: 460,\r\n\t\t\t\t\tconfirm: function () {\r\n\t\t\t\t\t\tvar discounts_are_valid = saveItems(true, true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tintenseLogging(\"addPaymentAndActivate() - confirm dialog\");\r\n\r\n\t\tif (hasBundle)\r\n\t\t{\r\n\t\t\tlet bundleIsSelected = false;\r\n\t\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tbundleIsSelected = true;\r\n\t\t\t}\r\n\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\r\n\t\t\t\tlet numBundItems = countSelectedBundleItems();\r\n\t\t\t\tif (numBundItems < intro_servings_required)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Please select at least ' + intro_servings_required + ' servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\telse if (numBundItems > 18)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Please select no more than 18 servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (stationNeedsAttention)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Please review the Side Station and ensure the correct number of items are selected.'\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// always first ensure that discounts are updated on server\r\n\t\tlet message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\t\tlet changesBlurb = getAbbreviatedSummaryString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Add Payment and Book Order',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: 460,\r\n\t\t\tconfirm: function () {\r\n\t\t\t\tlet discounts_are_valid = saveItems(true, true, true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction save2PaymentsAndBookOrder(payment2Type, payment1Data, token)\r\n{\r\n\r\n\tintenseLogging(\"save2PaymentsAndBookOrder() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\t\tif (!max_plate_points_deduction)\r\n\t\t{\r\n\t\t\tmax_plate_points_deduction = 0;\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tadd_payment_data: payment2Data,\r\n\t\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, json.warnOfOutstandingSavedOrdersOnFullSession, false, false, payment1Data);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction savePayment2(payment2Type, warnOfOutstandingSavedOrdersOnFullSession, token)\r\n{\r\n\r\n\tintenseLogging(\"savePayment2() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'add_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment2Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"savePayment2() add_payment successful\");\r\n\r\n\t\t\t\t\tif (warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, warnOfOutstandingSavedOrdersOnFullSession, false, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction handleDirectPayment(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"handleDirectPayment() called\");\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\t// Handle Payment 1 for certain\r\n\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\tvar DP_State = 0;\r\n\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t{\r\n\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\tif (DP_State == 1)\r\n\t\t{\r\n\t\t\tDP_State = 4;\r\n\t\t} // translate to CPayment constants - for now\r\n\t\tif (DP_State == 2)\r\n\t\t{\r\n\t\t\tDP_State = 5;\r\n\t\t}\r\n\r\n\t\tif (DP_State > 0)\r\n\t\t{\r\n\t\t\t// TODO: validate amounts\r\n\t\t}\r\n\t}\r\n\r\n\tvar use_store_credits = false;\r\n\tvar store_credit_amount = 0;\r\n\tif ($(\"#use_store_credits\").length)\r\n\t{\r\n\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t{\r\n\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\tuse_store_credits = true;\r\n\t\t}\r\n\t}\r\n\r\n\tvar mainPaymentData = null;\r\n\tvar additionalPaymentData = null;\r\n\r\n\tif (payment2Type)\r\n\t{\r\n\t\tmainPaymentData = getPaymentData(payment2Type, 2);\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t}\r\n\t\t}\r\n\t\tadditionalPaymentData = payment1Data;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmainPaymentData = payment1Data;\r\n\t}\r\n\r\n\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\tif (!max_plate_points_deduction)\r\n\t{\r\n\t\tmax_plate_points_deduction = 0;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: store_id,\r\n\t\t\top: 'save_payment',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tpayment_data: mainPaymentData,\r\n\t\t\tadd_payment_data: additionalPaymentData,\r\n\t\t\tdelay_remainder: DP_State,\r\n\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\tdd_csrf_token: token,\r\n\t\t\tpayment2Type: payment2Type\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"handleDirectPayment() save_payment successful\");\r\n\r\n\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tif (strError == 'timeout')\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Order Processing Timed Out',\r\n\t\t\t\t\tmessage: \"The request to finalized the order has timed out. This may be due to network congestion. The order may have been successful. The page will refresh and show the actual current status.\",\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t'Refresh': function () {\r\n\t\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onAddPaymentAndActivate(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"onAddPaymentAndActivate() called\");\r\n\r\n\tif (!supports_transparent_redirect)\r\n\t{\r\n\t\treturn handleDirectPayment(addOnly, go_to_confirm, token);\r\n\t}\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\tif (payment2Type && payment2Type != \"\")\r\n\t{\r\n\t\tsave2PaymentsAndBookOrder(payment2Type, payment1Data, token);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (payment1Type != \"\" && payment1Type != \"CC\")\r\n\t{\r\n\t\t// Handle Payment 1 for certain\r\n\t\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar use_store_credits = false;\r\n\t\tvar store_credit_amount = 0;\r\n\t\tif ($(\"#use_store_credits\").length)\r\n\t\t{\r\n\t\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\t\tuse_store_credits = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\t\tif (!max_plate_points_deduction)\r\n\t\t{\r\n\t\t\tmax_plate_points_deduction = 0;\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"onAddPaymentAndActivate save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse if (payment1Type != \"\" && payment1Type == \"CC\")\r\n\t{\r\n\t\t/*\r\n\r\n\t\t '#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t ' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t ' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t ' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2'\r\n\t\t */\r\n\r\n\t\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_1\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\t\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 1, false, addOnly, go_to_confirm, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"onAddPaymentAndActivate get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction RetrieveCalendar(timestamp)\r\n{\r\n\r\n\tintenseLogging(\"RetrieveCalendar() called\");\r\n\r\n\tvar op = 'retrieve';\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\top = 'retrieve_for_reschedule';\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'GET',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_calendarProcessor',\r\n\t\t\tstore_id: store_id,\r\n\t\t\taction: op,\r\n\t\t\tcur_session_id: session_id,\r\n\t\t\ttimestamp: timestamp\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar() successful\");\r\n\r\n\t\t\t\t$(\"#calendar_holder\").html(json.data);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"RetrieveCalendar: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDayClick(obj)\r\n{\r\n}\r\n\r\nfunction doReschedule(id, sessionTime, transition_type)\r\n{\r\n\tvar curSessionDate = $(\"#curSessionDate\").html();\r\n\r\n\tdd_message({\r\n\t\ttitle: 'Reschedule',\r\n\t\tmessage: '<div style=\"text-align: center;\"><div>From</div><div style=\"font-weight: bold;\">' + curSessionDate + '</div><div>to</div><div style=\"font-weight: bold;\">' + sessionTime + '</div>'\r\n\t\t\t+ '<div style=\"margin-top:5px;\"><input type=\"checkbox\" name=\"reschedule_suppress_email\" id=\"reschedule_suppress_email\" />&nbsp;<label for=\"reschedule_suppress_email\">Suppress Sending Reschedule Email to Guest</label></div>',\r\n\t\tmodal: true,\r\n\t\tconfirm: function () {\r\n\t\t\tvar suppressEmail = false;\r\n\t\t\tif ($(\"#reschedule_suppress_email\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tsuppressEmail = true;\r\n\t\t\t}\r\n\r\n\t\t\tvar org_session_id = session_id;\r\n\t\t\tsession_id = id;\r\n\t\t\tReschedule(org_session_id, transition_type, suppressEmail);\r\n\r\n\t\t},\r\n\t\topen: function () {\r\n\r\n\t\t\t$(this).siblings('.ui-dialog-buttonpane').find(\"button:contains('Confirm')\").focus();\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onRescheduleClick(id, sessionTime, isDiscounted, control_message)\r\n{\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tif (control_message == \"locked\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"This order cannot be rescheduled as it is in the previous calendar month and that month has been locked and finalized.\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to an Assembly.</span><br /><br />The Service Fee will be removed. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"tononpreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"MFY_to_Assembled\");\r\n\t\t\t\t\t\t$(\"#tononpreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Pickup.</span><br /><br />The Service Fee will be applied. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"Assembly_to_MFY\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Home Delivery.</span><br /><br />The Service Fee will be adjusted, the Delivery Fee will be added and a Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"MFY_to_HD\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Community Pick Up.</span><br />\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"MFY_to_CPU\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"CPU_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Pick Up.</span><br />\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"CPU_to_MFY\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Assembly.</span><br /><br />The Delivery Fee, Service Fee, and Delivery Address will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"HD_to_Assembled\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Pick Up.</span><br /><br />The Delivery Fee will be removed. The Service Fee will be adjusted. The Delivery Address will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"HD_to_MFY\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Community Pick Up.</span><br /><br />The Delivery Address will be removed and the Delivery Fee and Service Fee may be adjusted.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"HD_to_CPU\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"CPU_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Assembly.</span><br /><br />The Delivery Fee and Service Fee will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"CPU_to_Assembled\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"CPU_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Home Delivery.</span><br /><br />The Delivery Fee and Service Fee may be adjusted. The Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"CPU_to_HD\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Community Pick Up.</span><br /><br />A Delivery Fee and Service Fee may be added.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"Assembly_to_CPU\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Home Delivery.</span><br /><br />The Service and Delivery Fees will be added. The Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"Assembly_to_HD\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_WI\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Walk-in.</span><br /><br /> \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_WI\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Walk-in.</span><br /><br /> \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_WI\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Walk-in.</span><br /><br />The Delivery Fee will be removed. The Service Fee will be adjusted. The Delivery Address will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Pickup.</span><br /><br />The Service Fee will be adjusted. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Pick Up.</span><br /><br />The Service Fee will be adjusted. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-In to Community Pick Up.</span><br />\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Home Delivery.</span><br /><br />The Service Fee will be adjusted, the Delivery Fee will be added and a Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"none_wi\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdoReschedule(id, sessionTime, \"None\");\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tdoReschedule(id, sessionTime, \"None\");\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSessionClick(id, sessionTime, isDiscounted)\r\n{\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetSessionAndSave(id);\r\n\t}\r\n}\r\n\r\nfunction monthChange(monthVal)\r\n{\r\n\tRetrieveCalendar(monthVal);\r\n}\r\n\r\nfunction handle_delayed_payment()\r\n{\r\n\tif (GUEST_PREFERENCES[user_id].TC_DELAYED_PAYMENT_AGREE.value == 1)\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2').on('click', function (e) {\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\tmessage: lang.en.tc.delayed_payment,\r\n\t\t\tmodal: true,\r\n\t\t\tnoOk: true,\r\n\t\t\tcloseOnEscape: false,\r\n\t\t\topen: function (event, ui) {\r\n\t\t\t\t$(this).parent().find('.ui-dialog-titlebar-close').hide();\r\n\t\t\t},\r\n\t\t\tbuttons: {\r\n\t\t\t\t'Agree': function () {\r\n\r\n\t\t\t\t\t$(this).remove();\r\n\r\n\t\t\t\t\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t\t\t\t\t' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t\t\t\t\t' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t\t\t\t\t' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2').off('click');\r\n\r\n\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 1, user_id);\r\n\r\n\t\t\t\t},\r\n\t\t\t\t'Decline': function () {\r\n\r\n\t\t\t\t\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment0, #payment2_is_store_specific_flat_rate_deposit_delayed_payment0, ' +\r\n\t\t\t\t\t\t'#ref_payment1_is_store_specific_flat_rate_deposit_delayed0, #ref_payment2_is_store_specific_flat_rate_deposit_delayed0').trigger('click');\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\t\t\t\tmessage: lang.en.tc.delayed_payment_decline\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 0, user_id);\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction createBonusCredit(creditConsumed)\r\n{\r\n\tisFactoringCredit = true;\r\n\tcurrentCreditAvailable = creditBasis * 0.10;\r\n\r\n\tif (creditConsumed > currentCreditAvailable)\r\n\t{\r\n\t\tcreditConsumed = currentCreditAvailable;\r\n\t\tcurrentCreditAvailable = 0;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tcurrentCreditAvailable -= creditConsumed;\r\n\r\n\t}\r\n\r\n\t$('#couponValue').val(creditConsumed);\r\n\t$(\"#OEH_bonus_credit\").html(\" ( Bonus Credit: \" + formatAsMoney(currentCreditAvailable) + \" )\");\r\n}\r\n\r\nfunction removeBonusCredit()\r\n{\r\n\tisFactoringCredit = false;\r\n\t$(\"#OEH_bonus_credit\").html(\"\");\r\n}\r\n\r\nfunction handleSummaryDisplayChange(obj)\r\n{\r\n\tif (obj.checked)\r\n\t{\r\n\t\tShowAllLineItems();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tHideLineItemsIfZero();\r\n\t}\r\n}\r\n\r\nfunction HideLineItemsIfZero()\r\n{\r\n\tvar bagFeeOrg = Number($('#OEH_subtotal_bag_fee_org').html());\r\n\tvar bagFee = Number($('#OEH_subtotal_bag_fee').html());\r\n\r\n\tif (bagFeeOrg == 0 && bagFee == 0)\r\n\t{\r\n\t\t$('#BagFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#BagFeeRow').show();\r\n\t}\r\n\r\n\tvar bagFeeTaxOrg = Number($('#OEH_bag_fee_tax_subtotal_org').html());\r\n\tvar bagFeeTax = Number($('#OEH_bag_fee_tax_subtotal').html());\r\n\r\n\tif (bagFeeTaxOrg == 0 && bagFeeTax == 0)\r\n\t{\r\n\t\t$('#BagFeeTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#BagFeeTaxRow').show();\r\n\t}\r\n\r\n\tvar serviceFeeOrg = Number($('#OEH_subtotal_service_fee_org').html());\r\n\tvar serviceFee = Number($('#OEH_subtotal_service_fee').html());\r\n\r\n\tif (serviceFeeOrg == 0 && serviceFee == 0)\r\n\t{\r\n\t\t$('#ServiceFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#ServiceFeeRow').show();\r\n\t}\r\n\r\n\tvar deliveryFeeOrg = Number($('#OEH_subtotal_delivery_fee_org').html());\r\n\tvar deliveryFee = Number($('#OEH_subtotal_delivery_fee').html());\r\n\r\n\tif (deliveryFeeOrg == 0 && deliveryFee == 0)\r\n\t{\r\n\t\t$('#DeliveryFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryFeeRow').show();\r\n\t}\r\n\r\n\tvar serviceTaxOrg = Number($('#OEH_service_tax_subtotal_org').html());\r\n\tvar serviceTax = Number($('#OEH_service_tax_subtotal').html());\r\n\r\n\tif (serviceTaxOrg == 0 && serviceTax == 0)\r\n\t{\r\n\t\t$('#ServiceTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#ServiceTaxRow').show();\r\n\t}\r\n\r\n\tvar miscFoodOrg = Number($('#OEH_misc_food_subtotal_org').html());\r\n\tvar miscFood = Number($('#OEH_misc_food_subtotal').html());\r\n\r\n\tif (miscFoodOrg == 0 && miscFood == 0)\r\n\t{\r\n\t\t$('#miscFoodRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#miscFoodRow').show();\r\n\t}\r\n\r\n\tvar miscNonFoodOrg = Number($('#OEH_misc_nonfood_subtotal_org').html());\r\n\tvar miscNonFood = Number($('#OEH_misc_nonfood_subtotal').html());\r\n\r\n\tif (miscNonFoodOrg == 0 && miscNonFood == 0)\r\n\t{\r\n\t\t$('#miscNonFoodRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#miscNonFoodRow').show();\r\n\t}\r\n\r\n\tvar miscMealCustomizationFeeOrg = Number($('#OEH_subtotal_meal_customization_fee').html());\r\n\tvar miscMealCustomizationFee = Number($('#OEH_subtotal_meal_customization_fee_org').html());\r\n\r\n\tif (miscMealCustomizationFeeOrg == 0 && miscMealCustomizationFee == 0)\r\n\t{\r\n\t\t$('#MealCustomizationFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#MealCustomizationFeeRow').show();\r\n\t}\r\n\r\n\r\n\tvar doDiscountOrg = Number($('#OEH_direct_order_discount_org').html());\r\n\tvar doDiscount = Number($('#OEH_direct_order_discount').html());\r\n\r\n\tif (doDiscountOrg == 0 && doDiscount == 0)\r\n\t{\r\n\t\t$('#directDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#directDiscountRow').show();\r\n\t}\r\n\r\n\tvar couponDiscountOrg = Number($('#OEH_coupon_discount_org').html());\r\n\tvar couponDiscount = Number($('#OEH_coupon_discount').html());\r\n\r\n\tif (couponDiscountOrg == 0 && couponDiscount == 0)\r\n\t{\r\n\t\t$('#couponDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#couponDiscountRow').show();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_food').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_food').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#platePointsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#platePointsDiscountRow').show();\r\n\t}\r\n\r\n\tvar referralRewardDiscountOrg = Number($('#OEH_referral_reward_order_discount_orig').html());\r\n\tvar referralRewardDiscount = Number($('#OEH_referral_reward_order_discount').html());\r\n\r\n\tif (referralRewardDiscountOrg == 0 && referralRewardDiscount == 0)\r\n\t{\r\n\t\t$('#referralRewardDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#referralRewardDiscountRow').show();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_fee').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#platePointsFeeDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#platePointsFeeDiscountRow').show();\r\n\t}\r\n\r\n\tvar membershipDiscountOrg = Number($('#OEH_membership_discount_org').html());\r\n\tvar membershipDiscount = Number($('#OEH_membership_discount').html());\r\n\r\n\tif (membershipDiscountOrg == 0 && membershipDiscount == 0)\r\n\t{\r\n\t\t$('#membershipDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#membershipDiscountRow').show();\r\n\t}\r\n\r\n\tvar sessionDiscountOrg = Number($('#OEH_session_discount').html());\r\n\r\n\tif (sessionDiscountOrg == 0)\r\n\t{\r\n\t\t$('#sessionDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#sessionDiscountRow').show();\r\n\t}\r\n\r\n\tvar pudDiscount = Number($('#OEH_preferred').html());\r\n\r\n\tif (pudDiscount == 0)\r\n\t{\r\n\t\t$('#preferredUserDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#preferredUserDiscountRow').show();\r\n\t}\r\n\r\n\tvar foodTaxOrg = Number($('#OEH_food_tax_subtotal_org').html());\r\n\tvar foodTax = Number($('#OEH_food_tax_subtotal').html());\r\n\r\n\tif (foodTaxOrg == 0 && foodTax == 0)\r\n\t{\r\n\t\t$('#foodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#foodTaxRow').show();\r\n\t}\r\n\r\n\tvar nonFoodTaxOrg = Number($('#OEH_tax_subtotal_org').html());\r\n\tvar nonFoodTax = Number($('#OEH_tax_subtotal').html());\r\n\r\n\tif (nonFoodTaxOrg == 0 && nonFoodTax == 0)\r\n\t{\r\n\t\t$('#nonFoodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxRow').show();\r\n\t}\r\n\r\n\tlet deliveryTaxOrg = Number($('#OEH_delivery_tax_subtotal_org').html());\r\n\tlet deliveryTax = Number($('#OEH_delivery_tax_subtotal').html());\r\n\r\n\tif (deliveryTaxOrg == 0 && deliveryTax == 0)\r\n\t{\r\n\t\t$('#DeliveryTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryTaxRow').show();\r\n\t}\r\n\r\n\tlet productsSubtotalOrg = Number($('#OEH_products_subtotal_org').html());\r\n\tlet productsSubtotal = Number($('#OEH_products_subtotal').html());\r\n\r\n\tif (productsSubtotalOrg == 0 && productsSubtotal == 0)\r\n\t{\r\n\t\t$('#productSubtotalRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#productSubtotalRow').show();\r\n\t}\r\n\r\n\tif (!$('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\t$('#LTDRoundUpRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#LTDRoundUpRow').show();\r\n\t}\r\n}\r\n\r\nfunction ShowAllLineItems()\r\n{\r\n\t$('#ServiceFeeRow').show();\r\n\t$('#DeliveryFeeRow').show();\r\n\t$('#ServiceTaxRow').show();\r\n\t$('#miscFoodRow').show();\r\n\t$('#miscNonFoodRow').show();\r\n\t$('#directDiscountRow').show();\r\n\t$('#couponDiscountRow').show();\r\n\t$('#foodTaxRow').show();\r\n\t$('#nonFoodTaxRow').show();\r\n\t$('#productSubtotalRow').show();\r\n\t$('#platePointsDiscountRow').show();\r\n\t$('#referralRewardDiscountRow').show();\r\n\t$('#preferredUserDiscountRow').show();\r\n\t$('#sessionDiscountRow').show();\r\n\t$('#LTDRoundUpRow').show();\r\n\t$('#MealCustomizationFeeRow').show();\r\n\t$('#BagFeeRow').show();\r\n}\r\n\r\nfunction sort_by_price(a, b)\r\n{\r\n\tif (a.price == b.price)\r\n\t{\r\n\t\treturn 0;\r\n\t}\r\n\r\n\treturn (a.price < b.price) ? 1 : -1;\r\n}\r\n\r\nfunction drawChangeList()\r\n{\r\n\tvar html = getChangeListHTML();\r\n\t$(\"#changelist\").html(html);\r\n\r\n}\r\n\r\nfunction getChangeListHTML()\r\n{\r\n\r\n\tlet htmlStr = \"\";\r\n\tlet first = true;\r\n\r\n\tfor (let item in changeList.stdMenuItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Standard Items <span id='changed-item-count'> - \" + localStorage.getItem('core-item-count') + \" total</span></h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.stdMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tlet title = $(\"#qty_\" + item).data(\"item_title\");\r\n\r\n\t\t\tlet pricing_type = translateServingSize($(\"#qty_\" + item).data(\"servings\"));\r\n\r\n\t\t\tpricing_type = \"(\" + pricing_type + \")\";\r\n\r\n\t\t\tif (changeList.stdMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.stdMenuItems[item] + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.stdMenuItems[item] * -1 + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\r\n\tlet indexedItems = [];\r\n\tfor (let item in changeList.FTMenuItems)\r\n\t{\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tvar index = $(\"#qty_\" + item).data(\"index\");\r\n\t\t\tindexedItems[index] = item;\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (let key in indexedItems)\r\n\t{\r\n\t\tlet item = indexedItems[key];\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Sides <span id='changed-sides-count'> - \" + localStorage.getItem('side-item-count') + \" total</span></h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tlet title = $(\"#qty_\" + item).data(\"item_title\");\r\n\r\n\t\t\tif (changeList.FTMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.FTMenuItems[item] + \" <i>\" + title + \"</i>\";\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.FTMenuItems[item] * -1 + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tlet hadMiscCostChanges = false;\r\n\tfor (let item in changeList.miscCosts)\r\n\t{\r\n\t\thadMiscCostChanges = true;\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.sideBundleItem)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Sides Bundle Item List</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.sideBundleItem.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tlet title = $(\"#sbi_\" + item).data(\"item_title\");\r\n\r\n\t\t\tif (changeList.sideBundleItem[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.sideBundleItem[item] + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.sideBundleItem[item] * -1 + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.miscDescs)\r\n\t{\r\n\t\tif (!hadMiscCostChanges && first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.bundleItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\tif (isDreamTaste)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Meal Prep Workshop Items List</h3><ul style='margin: 4px;'>\";\r\n\r\n\t\t\t}\r\n\t\t\telse if (isFundraiser)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Fundraiser Event Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Intro Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\t}\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.bundleItems.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tlet title = $(\"#bnd_\" + item).data(\"item_title\");\r\n\t\t\tlet pricing_type = \"(\" + $(\"#bnd_\" + item).data(\"servings\") + \" Serving)\";\r\n\r\n\t\t\tif (changeList.bundleItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.bundleItems[item] + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.bundleItems[item] * -1 + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.reporting)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Reporting</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.reporting.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (item == 'fundraiser')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse if (changeList.reporting[item][\"orgVal\"] > 0 && changeList.reporting[item][\"orgVal\"] != changeList.reporting[item][\"newVal\"])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Changed \" + getHumanReadableName(item) + \" to \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (item == 'fundraiser_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == false)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was removed from the order.'\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was added to the order.'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.coupon)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.coupon.change_type == 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Added coupon code: \" + changeList.coupon.code + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type == 'removed')\r\n\t\t{\r\n\t\t\thtmlStr += \"Removed coupon code: \" + changeList.coupon.code + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type == 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Change coupon code to: \" + changeList.coupon.code + \"<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.bagFee['Bag Count'])\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Bag Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Updated Bag Count: Was \" + changeList.bagFee['Bag Count']['orgVal'] + \" bags. Updated to \" + changeList.bagFee['Bag Count']['newVal'] + \" bags<br />\";\r\n\t}\r\n\r\n\tif (changeList.mealCustomizationFee['Meal Customization Fee'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Meal Customization Fee: Was $\" + changeList.mealCustomizationFee['Meal Customization Fee']['orgVal'] + \". Updated to $\" + changeList.mealCustomizationFee['Meal Customization Fee']['newVal'] + \"<br />\";\r\n\t}\r\n\r\n\tif (typeof changeList.mealCustomizationFee['Meal Customization Selection'] != 'undefined' && typeof changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] != 'undefined' && changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Selection</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tlet previous = changeList.mealCustomizationFee['Meal Customization Selection']['orgVal'] == 1 ? \" not selected\" : \" selected\";\r\n\t\tlet newVal = changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] == \"on\" ? \" selected\" : \" not selected\";\r\n\r\n\r\n\t\thtmlStr += \"Meal Customization was\" + previous + \". Updated to \" + newVal+ \".<br />\";\r\n\t}\r\n\r\n\r\n\r\n\tif (changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tfor (let key in changeList.mealCustomizationFee['Meal Customization'])\r\n\t\t{\r\n\t\t\tif(typeof changeList.mealCustomizationFee['Meal Customization'][key] !== 'undefined' && typeof changeList.mealCustomizationFee['Meal Customization'][key]['name'] !== 'undefined')\r\n\t\t\t{\r\n\t\t\t\tif(changeList.mealCustomizationFee['Meal Customization'][key]['newVal'].toUpperCase() == 'OPTED IN')\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" to \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" of \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tlet payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment2_type').val() != \"\")\r\n\t\t{\r\n\t\t\tlet payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\t}\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction translateServingSize(servings)\r\n{\r\n\tvar result = '';\r\n\tswitch (servings)\r\n\t{\r\n\t\tcase 6:\r\n\t\t\tresult = 'Large - ' + servings + '';\r\n\t\t\tbreak;\r\n\t\tcase 3:\r\n\t\tcase 4:\r\n\t\t\tresult = 'Medium - ' + servings + '';\r\n\t\t\tbreak;\r\n\t\tcase 2:\r\n\t\t\tresult = 'Small - ' + servings + '';\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tresult = servings;\r\n\t}\r\n\r\n\treturn result;\r\n\r\n}\r\n\r\nfunction getHumanReadableName(id)\r\n{\r\n\tswitch (id)\r\n\t{\r\n\t\tcase 'direct_order_discount':\r\n\t\t\treturn \"Direct Order Discount\";\r\n\t\tcase 'plate_points_discount':\r\n\t\t\treturn \"Dinner Dollars\";\r\n\t\tcase \"misc_food_subtotal\":\r\n\t\t\treturn \"Miscellaneous Food Cost\";\r\n\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\treturn \"Miscellaneous Non-food Cost\";\r\n\t\tcase \"subtotal_service_fee\":\r\n\t\t\treturn \"Service Fee\";\r\n\t\tcase \"subtotal_delivery_fee\":\r\n\t\t\treturn \"Delivery Fee\";\r\n\t\tcase 'misc_food_subtotal_desc':\r\n\t\t\treturn 'Misc Food Description';\r\n\t\tcase 'misc_nonfood_subtotal_desc':\r\n\t\t\treturn 'Misc Non-food Description';\r\n\t\tcase 'service_fee_description':\r\n\t\t\treturn 'Service Fee Description';\r\n\t\tcase 'session_discount':\r\n\t\t\treturn 'Session Discount';\r\n\t\tcase 'fundraiser':\r\n\t\t\treturn 'Fundraiser';\r\n\t\tcase 'fundraiser_value':\r\n\t\t\treturn 'Fundraiser Value';\r\n\t\tcase 'ltd_roundup_value':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up Value';\r\n\t\tcase 'ltd_roundup':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up';\r\n\t\tdefault:\r\n\t\t\treturn 'error';\r\n\t}\r\n}\r\n\r\nfunction getAbbreviatedSummaryString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\r\n\tif (isDreamTaste)\r\n\t{\r\n\t\thtmlStr += \"<h3>Meal Prep Workshop Order</h3>\";\r\n\t}\r\n\telse if (isFundraiser)\r\n\t{\r\n\t\thtmlStr += \"<h3>Fundraiser Order</h3>\";\r\n\t}\r\n\telse if (bundleChecked)\r\n\t{\r\n\t\thtmlStr += \"<h3>Starter Pack Order</h3>\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\thtmlStr += \"<h3>Standard Order</h3>\";\r\n\t}\r\n\r\n\tvar stdItemCount = 0;\r\n\tvar FTItemCount = 0;\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\tif ($(this).val() > 0)\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tFTItemCount += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tstdItemCount += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tif (stdItemCount > 0)\r\n\t{\r\n\t\thtmlStr += stdItemCount + \" Standard Items Selected.<br />\"\r\n\t}\r\n\tif (FTItemCount > 0)\r\n\t{\r\n\t\thtmlStr += FTItemCount + \" Sides &amp; Sweets Items Selected.<br />\"\r\n\t}\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif (curVal > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += getHumanReadableName(this.id) + \" costs of $\" + formatAsMoney(curVal);\r\n\r\n\t\t\t\tvar descIDStr = \"\";\r\n\r\n\t\t\t\tswitch (this.id)\r\n\t\t\t\t{\r\n\t\t\t\t\tcase \"misc_food_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_food_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_nonfood_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"subtotal_service_fee\":\r\n\t\t\t\t\t\tdescIDStr = \"service_fee_description\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar desc = null;\r\n\t\t\t\tif (descIDStr != \"\")\r\n\t\t\t\t{\r\n\t\t\t\t\tdesc = $(\"#\" + descIDStr).val();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (desc)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \". <span>( \" + desc + \" )</span><br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \".<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\tvar bundleOrgVal = $('#selectedBundle').data('org_value');\r\n\r\n\tvar bundleItems = 0;\r\n\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\tif ($(this).is(\":checked\"))\r\n\t\t{\r\n\t\t\tbundleItems++;\r\n\t\t}\r\n\t});\r\n\r\n\tif (bundleItems > 0)\r\n\t{\r\n\t\thtmlStr += bundleItems + \" Intro Items Selected.<br />\"\r\n\t}\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\tvar bundleItems = 0;\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tbundleItems += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (bundleItems > 0)\r\n\t\t{\r\n\t\t\thtmlStr += bundleItems + \" Items Selected.<br />\"\r\n\t\t}\r\n\t}\r\n\r\n\t// Discounts\r\n\r\n\tvar discountsHTML = \"\";\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() > 0)\r\n\t\t{\r\n\t\t\tdiscountsHTML += getHumanReadableName(this.id) + \" applied.<br />\";\r\n\t\t}\r\n\t});\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\r\n\t\tvar newSDValue = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\r\n\t\tif (newSDValue && newSDValue != \"noSD\")\r\n\t\t{\r\n\t\t\tdiscountsHTML += \"Session discount is applied.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tvar newPUDValue = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\r\n\t\tif (newPUDValue && newPUDValue != \"noUP\")\r\n\t\t{\r\n\t\t\tdiscountsHTML += \"Preferred User Discount is applied.<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (discountsHTML != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Discounts</h3>\" + discountsHTML;\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (changeList.bagFee['Bag Count'])\r\n\t\t{\r\n\t\t\thtmlStr += \"Bag Count set to \" + changeList.bagFee['Bag Count']['newVal'] + \" bags<br />\";\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction updateChangeList()\r\n{\r\n\r\n\titemChanges = false;\r\n\tdiscountChanges = false;\r\n\treportingChanges = false;\r\n\tfeeChanges = false;\r\n\r\n\tdiscountOrPaymentChanges = false;\r\n\tlet showSaveButton = false;\r\n\r\n\tchangeList = {};\r\n\tchangeList.stdMenuItems = {};\r\n\tchangeList.FTMenuItems = {};\r\n\tchangeList.miscCosts = {};\r\n\tchangeList.miscDescs = {};\r\n\tchangeList.bundleItems = {};\r\n\tchangeList.order_type = \"\";\r\n\tchangeList.discounts = {};\r\n\tchangeList.reporting = {};\r\n\tchangeList.delivery = {};\r\n\tchangeList.bagFee = {};\r\n\tchangeList.mealCustomizationFee = {'Meal Customization':null,'Meal Customization Fee':null};\r\n\r\n\r\n\tchangeList.sideBundleItem = {};\r\n\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tchangeList.FTMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.stdMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// bundle items\r\n\t$(\"[name^='sbi_']\").each(function () {\r\n\t\tif ($(this).val() != $(this).data('lastqty'))\r\n\t\t{\r\n\t\t\tchangeList.sideBundleItem[$(this).attr('id').split(\"_\")[1]] = $(this).val() - $(this).data('lastqty');\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Misc Costs\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.miscDescs[this.id] = 1;\r\n\t\t\t}\r\n\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\tvar bundleOrgVal = $('#selectedBundle').data('org_value');\r\n\r\n\tif (bundleChecked)\r\n\t{\r\n\t\tif (bundleOrgVal == \"0\")\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').addClass('unsaved_data_cb');\r\n\t\t\tchangeList.order_type = \"to Intro\";\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif (bundleOrgVal == \"1\")\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').addClass('unsaved_data_cb');\r\n\t\t\tchangeList.order_type = \"to Standard\";\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t\t{\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\t\titemChanges = true;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('org_value') == \"0\")\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().addClass('unsaved_data_cb');\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = 1;\r\n\t\t\t\t\titemChanges = true;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().removeClass('unsaved_data_cb');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('org_value') == \"1\")\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().addClass('unsaved_data_cb');\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = -1;\r\n\t\t\t\t\titemChanges = true;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().removeClass('unsaved_data_cb');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\t// bag fees\r\n\tif ($(\"#total_bag_count\").length)\r\n\t{\r\n\t\tif ($(\"#total_bag_count\").val() != $(\"#total_bag_count\").data(\"org_value\"))\r\n\t\t{\r\n\t\t\tchangeList.bagFee['Bag Count'] = {\r\n\t\t\t\tnewVal: $(\"#total_bag_count\").val(),\r\n\t\t\t\torgVal: $(\"#total_bag_count\").data(\"org_value\")\r\n\t\t\t}\r\n\t\t\tfeeChanges = true;\r\n\t\t\t$(\"#total_bag_count\").addClass('unsaved_data');\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#total_bag_count\").removeClass('unsaved_data');\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// meal customization fees\r\n\tif ($(\"#subtotal_meal_customization_fee\").length)\r\n\t{\r\n\t\tif($(\"#subtotal_meal_customization_fee\").val() == ''){\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").val('0.00');\r\n\t\t}\r\n\t\tif ($(\"#subtotal_meal_customization_fee\").val() != $(\"#subtotal_meal_customization_fee\").data(\"org_value\"))\r\n\t\t{\r\n\t\t\tchangeList.mealCustomizationFee['Meal Customization Fee'] = {\r\n\t\t\t\tnewVal: $(\"#subtotal_meal_customization_fee\").val(),\r\n\t\t\t\torgVal: $(\"#subtotal_meal_customization_fee\").data(\"org_value\")\r\n\t\t\t}\r\n\t\t\tfeeChanges = true;\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").addClass('unsaved_data');\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").removeClass('unsaved_data');\r\n\t\t}\r\n\t}\r\n\r\n\tlet customizationSelection = $(\"#opted_to_customize_recipes\").is(\":checked\")  ? '1':'0';\r\n\tlet origCustomizationSelection = (typeof $(\"#opted_to_customize_recipes\").data(\"org_value\") == 'undefined' || $(\"#opted_to_customize_recipes\").data(\"org_value\") == '' || $(\"#opted_to_customize_recipes\").data(\"org_value\") == '0') ? '0':'1';\r\n\tif( origCustomizationSelection != customizationSelection){\r\n\t\tchangeList.mealCustomizationFee['Meal Customization Selection'] = {\r\n\t\t\tnewVal: $(\"#opted_to_customize_recipes\").val(),\r\n\t\t\torgVal: $(\"#opted_to_customize_recipes\").data(\"org_value\")\r\n\t\t}\r\n\t\tfeeChanges = true;\r\n\t\t$(\"#opted_to_customize_recipes\").addClass('unsaved_data');\r\n\t}\r\n\r\n\t$(\"[data-dd_type='fee_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.miscDescs[this.id] = 1;\r\n\t\t\t}\r\n\r\n\t\t\tfeeChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"[data-dd_type='customization_fee_toggle']\").each(function () {\r\n\t\tvar curVal = $(this).is(\":checked\") ? 'Opted in' : 'Opted out';\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\t\tvar name = $(this).data('name');\r\n\r\n\r\n\t\tif (curVal.toLowerCase() != orgVal.toLowerCase() )\r\n\t\t{\r\n\t\t\t//$(this).addClass('unsaved_data');\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] == null){\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'] = [];\r\n\t\t\t}\r\n\r\n\r\n\t\t\tchangeList.mealCustomizationFee['Meal Customization'][this.id] = {\r\n\t\t\t\tname : name,\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal\r\n\t\t\t}\r\n\r\n\t\t\t//feeChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t\t\t{\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'][this.id] = '';\r\n\t\t\t}\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"[data-dd_type='customization_fee_detail']\").each(function () {\r\n\t\tlet curVal = $.trim($(this).val());\r\n\t\tlet orgVal = $(this).data('org_value');\r\n\t\tlet name = $(this).data('name');\r\n\r\n\t\tlet key = this.id + 'detail';\r\n\r\n\t\tif (curVal.toLowerCase() != orgVal.toLowerCase() )\r\n\t\t{\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] == null){\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'] = [];\r\n\t\t\t}\r\n\r\n\r\n\t\t\tchangeList.mealCustomizationFee['Meal Customization'][key] = {\r\n\t\t\t\tname : name,\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t\t\t{\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'][key] = '';\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\r\n\tif (feeChanges)\r\n\t{\r\n\t\t$(\"#fees_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#fees_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (itemChanges)\r\n\t{\r\n\t\t$(\"#items_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\t// Reporting Fundraising\r\n\t$(\"#fundraiser_id\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\tchangeList.reporting['fundraiser'] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\ttitle: $(this).find(':selected').text()\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#fundraiser_value\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\tchangeList.reporting['fundraiser_value'] = {\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal,\r\n\t\t\t\tdiff: curVal - orgVal\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Reporting, LTD Roundup\r\n\t$(\"#add_ltd_round_up\").each(function () {\r\n\t\tvar curVal = false;\r\n\r\n\t\tif ($(this).is(':checked'))\r\n\t\t{\r\n\t\t\tcurVal = true;\r\n\t\t}\r\n\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif (curVal != orgVal)\r\n\t\t{\r\n\t\t\tchangeList.reporting['ltd_roundup'] = {\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#ltd_round_up_select\").each(function () {\r\n\t\tif (!$(\"#add_ltd_round_up\").is(':checked'))\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal).toFixed(2);\r\n\t\t\torgVal = parseFloat(orgVal).toFixed(2);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\tchangeList.reporting['ltd_roundup_value'] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: curVal - orgVal\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Discounts\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\tcurVal = parseFloat(curVal);\r\n\t\torgVal = parseFloat(orgVal);\r\n\t\tif (isNaN(curVal))\r\n\t\t{\r\n\t\t\tcurVal = Number(0);\r\n\t\t}\r\n\t\tif (isNaN(orgVal))\r\n\t\t{\r\n\t\t\torgVal = Number(0);\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t// we're not  tracking description fields for now\r\n\t\t\tchangeList.discounts[this.id] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tif (initialSessionDiscountSetting != $(\"input[name='SessDisc']:checked\", '#editorForm').val())\r\n\t\t{\r\n\t\t\t$(\".SD_area\").addClass('unsaved_data_cb');\r\n\r\n\t\t\tvar newSDValue = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\r\n\t\t\tif (newSDValue == \"noSD\")\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['session_discount'] = {\r\n\t\t\t\t\tnewVal: 0,\r\n\t\t\t\t\torgVal: $(\"#OEH_session_discount_org\").html(),\r\n\t\t\t\t\tdiff: $(\"#OEH_session_discount_org\").html() * -1\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['session_discount'] = {\r\n\t\t\t\t\tnewVal: $(\"#OEH_session_discount\").html(),\r\n\t\t\t\t\torgVal: 0,\r\n\t\t\t\t\tdiff: $(\"#OEH_session_discount\").html()\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\".SD_area\").removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tif (initialPreferredUserDiscountSetting != $(\"input[name='PUD']:checked\", '#editorForm').val())\r\n\t\t{\r\n\t\t\t$(\"#PUD_area\").addClass('unsaved_data_cb');\r\n\r\n\t\t\tvar newPUDValue = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\r\n\t\t\tif (newPUDValue == \"noUP\")\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['preferred_user_discount'] = {\r\n\t\t\t\t\tnewVal: 0,\r\n\t\t\t\t\torgVal: $(\"#OEH_preferred_org\").html(),\r\n\t\t\t\t\tdiff: $(\"#OEH_preferred_org\").html() * -1\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['preferred_user_discount'] = {\r\n\t\t\t\t\tnewVal: $(\"#OEH_preferred\").html(),\r\n\t\t\t\t\torgVal: 0,\r\n\t\t\t\t\tdiff: $(\"#OEH_preferred\").html()\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#PUD_area\").removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\t// coupons\r\n\tvar orgCouponVal = $(\"#org_coupon_id\").val();\r\n\tvar curCouponVal = $(\"#coupon_id\").val();\r\n\tvar curCouponCode = $(\"#coupon_code\").val();\r\n\r\n\tif (orgCouponVal != curCouponVal)\r\n\t{\r\n\t\tdiscountOrPaymentChanges = true;\r\n\r\n\t\tif (orgCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tcode: curCouponCode,\r\n\t\t\t\tchange_type: \"added\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse if (curCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//removed\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tcode: curCouponCode,\r\n\t\t\t\tchange_type: \"removed\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tcode: curCouponCode,\r\n\t\t\t\tchange_type: \"changed\"\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (deliveryChanges)\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#payments_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && (showSaveButton || $('#use_store_credit').is(':checked')))\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && ($('#use_store_credit').is(':checked') || paymentChanges))\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\r\n\t}\r\n\r\n\tif (orderState == 'ACTIVE' || discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").show();\r\n\t\tif (showSaveButton || paymentChanges || $('#use_store_credits').is(':checked'))\r\n\t\t{\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", true);\r\n\t\t\t$(\"#finalize_msg\").hide();\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (itemChanges || discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#changeListTab\").addClass('unsaved_data_list');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#changeListTab\").removeClass('unsaved_data_list');\r\n\t}\r\n\r\n\tdrawChangeList();\r\n}\r\n\r\nfunction handleAutoAdjust(obj)\r\n{\r\n\t// called when the document is loaded or when the \"autoAdjust\" check box changes\r\n\r\n\t// if checked then setup the amounts to be credited/debited\r\n\tif (obj.checked)\r\n\t{\r\n\t\tvar balance = Number($('#OEH_remaing_balance').html());\r\n\r\n\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || balance > 0))\r\n\t\t{\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('DPADJUST');\r\n\t\t\t\tchangePayment1('DPADJUST');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tadjustPendingDelayedPayment(balance);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('REFERENCE');\r\n\t\t\t\tchangePayment1('REFERENCE');\r\n\t\t\t}\r\n\r\n\t\t\tassignBalanceToRefTransactions(balance);\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\t$('#payment1_type').val('');\r\n\t\t\tchangePayment1('');\r\n\t\t}\r\n\r\n\t\t// also clear any credits\r\n\t\tfor (ident in existingPaymentAmountArray)\r\n\t\t{\r\n\t\t\t$('#Cr_RT_' + ident).val(\"\");\r\n\t\t}\r\n\r\n\t\t// or if trying to credit\r\n\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n}\r\n\r\nfunction getAbbreviatedChangeString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\tvar addedStd = 0;\r\n\tvar removedStd = 0;\r\n\r\n\tif (needPlatePointsMaxDiscountChangeWarning)\r\n\t{\r\n\t\thtmlStr += \"<div style='color:red;'>Warning: The amount discountable by Dinner Dollars has changed. You may wish to review and adjust the Dinner Dollars discount.</div>\";\r\n\r\n\t}\r\n\r\n\tif (needRefferalRewardMaxDiscountChangeWarning)\r\n\t{\r\n\t\thtmlStr += \"<div style='color:red;'>Warning: The amount discountable by Referral Rewards has changed. You may wish to review and adjust the Referral Rewards discount.</div>\";\r\n\r\n\t}\r\n\r\n\r\n\tfor (var item in changeList.stdMenuItems)\r\n\t{\r\n\t\tif (changeList.stdMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.stdMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedStd += (changeList.stdMenuItems[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedStd += (changeList.stdMenuItems[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedStd)\r\n\t{\r\n\t\thtmlStr += addedStd + \" Standard items were added.<br />\"\r\n\t}\r\n\tif (removedStd)\r\n\t{\r\n\t\thtmlStr += removedStd + \" Standard items were removed.<br />\"\r\n\t}\r\n\r\n\tvar addedFT = 0;\r\n\tvar removedFT = 0;\r\n\r\n\tfor (var item in changeList.FTMenuItems)\r\n\t{\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.FTMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedFT += (changeList.FTMenuItems[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedFT += (changeList.FTMenuItems[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedFT)\r\n\t{\r\n\t\thtmlStr += addedFT + \" Sides &amp; Sweets items were added.<br />\"\r\n\t}\r\n\tif (removedFT)\r\n\t{\r\n\t\thtmlStr += removedFT + \" Sides &amp; Sweets items were removed.<br />\"\r\n\t}\r\n\r\n\tvar addedSBI = 0;\r\n\tvar removedSBI = 0;\r\n\r\n\tfor (var item in changeList.sideBundleItem)\r\n\t{\r\n\t\tif (changeList.sideBundleItem.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.sideBundleItem[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedSBI += (changeList.sideBundleItem[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedSBI += (changeList.sideBundleItem[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedSBI)\r\n\t{\r\n\t\thtmlStr += addedSBI + \" Sides &amp; Sweets bundle items were added.<br />\"\r\n\t}\r\n\tif (removedSBI)\r\n\t{\r\n\t\thtmlStr += removedSBI + \" Sides &amp; Sweets bundle items were removed.<br />\"\r\n\t}\r\n\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tvar addedBI = 0;\r\n\tvar removedBI = 0;\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.bundleItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\tif (isDreamTaste)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Meal Prep Workshop Items List</h3>\";\r\n\t\t\t}\r\n\t\t\telse if (isFundraiser)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Fundraiser Event Items List</h3>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Intro Items List</h3>\";\r\n\t\t\t}\r\n\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.bundleItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.bundleItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedBI += (changeList.bundleItems[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedBI += (changeList.bundleItems[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (addedBI)\r\n\t{\r\n\t\thtmlStr += addedBI + \" items were added.<br />\"\r\n\t}\r\n\tif (removedBI)\r\n\t{\r\n\t\thtmlStr += removedBI + \" items were removed.<br />\"\r\n\t}\r\n\r\n\tif (htmlStr != \"\")\r\n\t{\r\n\t\thtmlStr = \"<h3>Purchase Changes</h3>\" + htmlStr;\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.bagFee['Bag Count'])\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Bag Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Updated Bag Count: Was \" + changeList.bagFee['Bag Count']['orgVal'] + \" bags. Updated to \" + changeList.bagFee['Bag Count']['newVal'] + \" bags<br />\";\r\n\t}\r\n\r\n\tif (typeof changeList.mealCustomizationFee['Meal Customization Selection'] != 'undefined' && changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Selection</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tlet previous = changeList.mealCustomizationFee['Meal Customization Selection']['orgVal'] == 1 ? \" not selected\" : \" selected\";\r\n\t\tlet newVal = changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] == \"on\" ? \" selected\" : \" not selected\";\r\n\r\n\r\n\t\thtmlStr += \"Meal Customization was\" + previous + \". Updated to \" + newVal+ \".<br />\";\r\n\r\n\t}\r\n\tif (changeList.mealCustomizationFee['Meal Customization Fee'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Updated Meal Customization Fee: Was $\" + changeList.mealCustomizationFee['Meal Customization Fee']['orgVal'] + \". Updated to $\" + changeList.mealCustomizationFee['Meal Customization Fee']['newVal'] + \"<br />\";\r\n\t}\r\n\tif (changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tfor (let key in changeList.mealCustomizationFee['Meal Customization'])\r\n\t\t{\r\n\t\t\tif(typeof changeList.mealCustomizationFee['Meal Customization'][key] !== 'undefined' && typeof changeList.mealCustomizationFee['Meal Customization'][key]['name'] !== 'undefined')\r\n\t\t\t{\r\n\t\t\t\tif(changeList.mealCustomizationFee['Meal Customization'][key]['newVal'].toUpperCase() == 'OPTED IN')\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" to \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" of \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif ($('#autoAdjust').is(\":checked\"))\r\n\t{\r\n\t\thtmlStr += \"<span style='color:red'>Auto-Adjust is checked and will \" + $(\"#adj_action\").html() + \"</span>\";\r\n\r\n\t}\r\n\r\n\thtmlStr = \"<div id='finalize_changes_div'>\" + htmlStr + \"</div>\";\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction addPaymentToLockedOrder()\r\n{\r\n\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\tvar billing_address = $(\"#billing_address_1\").val();\r\n\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_token',\r\n\t\t\torder_id: order_id,\r\n\t\t\tamount: amt,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tbilling_name: billing_name,\r\n\t\t\tbilling_address: billing_address,\r\n\t\t\tbilling_zip: billing_zip,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val(),\r\n\t\t\tchain_token: true\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder() get_token successful\");\r\n\r\n\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\tsend(token, 1, false, true, true, false);\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction submitPage()\r\n{\r\n\tintenseLogging(\"submitPage() called\");\r\n\r\n\tvar form = $(\"#editorForm\")[0];\r\n\r\n\tvar is_valid = confirm_and_check_form(form);\r\n\r\n\tif (is_valid)\r\n\t{\r\n\t\tvar message = \"This can not be undone. Are you sure you want to submit the changes?\";\r\n\t\tvar changesBlurb = getAbbreviatedChangeString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tvar dialogHeight = 460;\r\n\r\n\t\tif (message.length < 128)\r\n\t\t{\r\n\t\t\tdialogHeight = 160;\r\n\t\t}\r\n\t\telse if (message.length < 256)\r\n\t\t{\r\n\t\t\tdialogHeight = 260;\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Finalize',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: dialogHeight,\r\n\t\t\tconfirm: function () {\r\n\r\n\t\t\t\tif (supports_transparent_redirect && $(\"#payment1_type\").val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"submitPage() confirmed\");\r\n\r\n\t\t\t\t\tif (!discountEligable.limited_access)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tupdateActiveOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\taddPaymentToLockedOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeList',\r\n\t\t\t\t\t\tvalue: JSON.stringify(changeList)\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeListStr',\r\n\t\t\t\t\t\tvalue: getChangeListHTML()\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$(\"#submit_changes\").val(\"true\");\r\n\t\t\t\t\t$(\"#editorForm\").submit();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n}\r\n\r\nfunction resetPage()\r\n{\r\n\tintenseLogging(\"resetPage() called\");\r\n\r\n\tbounce(window.location.href);\r\n}\r\n\r\nfunction confirm_and_check_form(form)\r\n{\r\n\r\n\tintenseLogging(\"confirm_and_check_form() called\");\r\n\r\n\tif (orderState == 'NEW' || orderState == 'SAVED')\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tvar bundleIsSelected = false;\r\n\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t{\r\n\t\t\tbundleIsSelected = true;\r\n\t\t}\r\n\r\n\t\tif (bundleIsSelected)\r\n\t\t{\r\n\r\n\t\t\tvar numBundItems = countSelectedBundleItems();\r\n\t\t\tif (numBundItems < intro_servings_required)\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Please select at least ' + intro_servings_required + ' servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\telse if (numBundItems > 18)\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Please select no more than 18 servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (stationNeedsAttention)\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please review the Side Station and ensure the correct number of items are selected.'\r\n\t\t});\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn _check_form(form);\r\n}\r\n\r\n// rounds to the nearest penny\r\n// move to global once this is found to be reliable\r\nfunction dd_round_amount(inAmount)\r\n{\r\n\tinAmount += .000005;\r\n\r\n\tvar tempVal = inAmount * 1000.0;\r\n\ttempVal = parseInt(tempVal);\r\n\ttempVal = tempVal / 10;\r\n\tvar pennyFraction = tempVal - Math.floor(tempVal);\r\n\tif (pennyFraction >= .5)\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal) + 1;\r\n\t}\r\n\telse\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal);\r\n\t}\r\n\r\n\treturn tempVal / 100;\r\n}\r\n\r\n/*\r\n\r\n function reportTestFailure(testNum, actual, correct)\r\n {\r\n if (actual != correct)\r\n {\r\n alert(\"Test #: \" + testNum + \" actual: \" + actual + \" correct: \" + correct);\r\n }\r\n }\r\n\r\n function doTests()\r\n {\r\n\r\n var testmultiplier = \".5\";\r\n\r\n var testNum = \"260.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(1, newResult, 130.05);\r\n\r\n var testNum = \"209.10\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(2, newResult, 104.55);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(3, newResult, 104.55);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(4, newResult, 104.5);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(5, newResult, .5);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(6, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(7, newResult, .03);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(8, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(9, newResult, 250);\r\n\r\n var testNum = \"209.10\";\r\n var testmultiplier = \".12\";\r\n\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(10, newResult, 25.09);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(11, newResult, 25.09);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(12, newResult, 25.08);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(13, newResult, .12);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(14, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(15, newResult, .01);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(16, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(17, newResult, 60);\r\n\r\n }\r\n\r\n doTests();\r\n\r\n */\r\n\r\nfunction updateSideStationStatus(entree_id, qty)\r\n{\r\n\tqty = Number(qty);\r\n\tstationNeedsAttention = false;\r\n\r\n\tif (qty == 0)\r\n\t{\r\n\t\t$('#desc' + entree_id).slideUp();\r\n\t\t$(\"#sidestation_help_\" + entree_id).css('color', \"#b00\").html(\"You must set the Bundle quantity to greater than zero.\");\r\n\t\t$('.bundle-subitem-qty[data-parent_item=\"' + entree_id + '\"]').val(0);\r\n\t\treturn;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#desc' + entree_id).slideDown();\r\n\t}\r\n\r\n\tlet requiredItemCount = qty * sideStationBundleInfo[entree_id].number_items_required;\r\n\t$(\"#required_items_station_\" + entree_id).text(requiredItemCount);\r\n\r\n\tlet numSelected = 0;\r\n\r\n\t$.each(sideStationBundleInfo[entree_id].bundle, function (mid, menu_item) {\r\n\r\n\t\tlet itemQty = $('#sbi_' + mid);\r\n\r\n\t\tif (itemQty && itemQty.val() != \"\")\r\n\t\t{\r\n\t\t\tif (isNaN(itemQty.val()) == true || itemQty.val() - parseInt(itemQty.val()) != 0)\r\n\t\t\t{\r\n\t\t\t\titemQty.val(0);\r\n\t\t\t}\r\n\r\n\t\t\t// if it is a fixed quantity, the input is read only so update the value times the master quantity\r\n\t\t\tif (menu_item.fixed_quantity !== '0')\r\n\t\t\t{\r\n\t\t\t\titemQty.val(qty * Number(menu_item.fixed_quantity));\r\n\t\t\t}\r\n\r\n\t\t\tif (itemQty.val() > 0)\r\n\t\t\t{\r\n\t\t\t\titemQty.val(parseInt(itemQty.val()));\r\n\t\t\t\tnumSelected += (itemQty.val() * 1);\r\n\t\t\t}\r\n\r\n\t\t\tlet inv_qty = entreeIDToInventoryMap[menu_item.entree_id].remaining;\r\n\t\t\tinv_qty -= (itemQty.val() * menu_item.servings_per_item);\r\n\r\n\t\t\t$('[data-entree_inventory_remaining=\"' + menu_item.entree_id + '\"]').text(inv_qty);\r\n\r\n\t\t\tentreeIDToInventoryMap[menu_item.entree_id].remaining = inv_qty;\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t$.each(sideStationBundleInfo[entree_id].bundle_groups, function (bid, group_info) {\r\n\t\t$('.group-select-num[data-group_id=\"' + group_info.id + '\"]').text(parseInt(group_info.number_items_required) * parseInt(qty));\r\n\t});\r\n\r\n\t$(\"#selected_items_station_\" + entree_id).html(numSelected);\r\n\r\n\tlet stationHelpElem = $(\"#sidestation_help_\" + entree_id);\r\n\tlet help_message = \"\";\r\n\tif (numSelected == 0)\r\n\t{\r\n\t\thelp_message = \"Please select \" + requiredItemCount + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#b00\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse if (numSelected > requiredItemCount)\r\n\t{\r\n\t\thelp_message = \"You have selected \" + (numSelected - requiredItemCount) + \" items more than the required amount. Please remove \" + (numSelected - requiredItemCount) + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#b00\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse if (numSelected < requiredItemCount)\r\n\t{\r\n\t\thelp_message = \"You have selected \" + (requiredItemCount - numSelected) + \" items less than the required amount. Please add \" + (requiredItemCount - numSelected) + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#b00\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\thelp_message = \"You have selected the correct number of sidestation items. You may continue with item selection or checkout.\";\r\n\t\tstationHelpElem.css('color', \"#0b0\");\r\n\t\tstationNeedsAttention = false;\r\n\t}\r\n\r\n\tstationHelpElem.html(help_message);\r\n}\r\n\r\nfunction handleMealCustomizationFeeInput()\r\n{\r\n\t$('#manual_customization_fee').val('true');\r\n\tcalculateTotal();\r\n}\r\n\r\n\r\nfunction handleBagCountInput()\r\n{\r\n\tbagCountLockedToField = true;\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction handleBagWaiverInput()\r\n{\r\n\tif (!$(\"#opted_to_bring_bags\").is(\":checked\"))\r\n\t{\r\n\t\tbagCountLockedToField = false;\r\n\t}\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction handleMealCustomizationWaiverInput()\r\n{\r\n\tif ($(\"#opted_to_customize_recipes\").is(\":checked\"))\r\n\t{\r\n\t\tmealCustomizationFeeFieldLocked = true;\r\n\r\n\t\t$('.icon-customize').hide();\r\n\r\n\t}else{\r\n\t\tlet mealCustomizationFeeTotal = $(\"#subtotal_meal_customization_fee\").data('org_value');\r\n\t\t$(\"#subtotal_meal_customization_fee\").prop(\"disabled\", false);\r\n\t\t$(\"#subtotal_meal_customization_fee\").val(formatAsMoney(mealCustomizationFeeTotal));\r\n\r\n\t\t$(\"#customization-row-container\").show();\r\n\t\tmealCustomizationFeeFieldLocked = false;\r\n\t\t$('.icon-customize').show();\r\n\r\n\t\tif (true)\r\n\t\t{\r\n\t\t\tfeeChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t}\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction calculateMealCustomizationFee(customizableMealQty){\r\n\tlet priceConfig = meal_customization_cost;\r\n\r\n\tif(typeof priceConfig === 'undefined' || priceConfig.length == 0){\r\n\t\treturn 0;\r\n\t}\r\n\r\n\tlet fee = 0;\r\n\tfor (var key in priceConfig) {\r\n\r\n\t\tswitch(priceConfig[key].operator) {\r\n\t\t\tcase 'EQUAL_OR_LESS':\r\n\t\t\t\tif(customizableMealQty <= parseInt(priceConfig[key].value)){\r\n\t\t\t\t\tfee = priceConfig[key].cost;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'BETWEEN_INCLUSIVE':\r\n\t\t\t\tlet limit = priceConfig[key].value.split('-');\r\n\t\t\t\tlet limitLow = parseInt(limit[0]);\r\n\t\t\t\tlet limitHigh = parseInt(limit[1]);\r\n\t\t\t\tif(customizableMealQty >= limitLow && customizableMealQty <= limitHigh ){\r\n\t\t\t\t\tfee = priceConfig[key].cost;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'GREATER':\r\n\t\t\t\tif(customizableMealQty > parseInt(priceConfig[key].value)){\r\n\t\t\t\t\tfee = priceConfig[key].cost;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t// code block\r\n\t\t}\r\n\t}\r\n\r\n\treturn fee;\r\n\r\n}\r\n\r\nfunction getNumberBagsRequiredFromItems(entreeCount, sidesCount)\r\n{\r\n\r\n\tlet entreesPerBag = 4;\r\n\t//\tlet sidesPerBag = 6;\r\n\r\n\tlet bagsRequired = Math.floor(entreeCount / entreesPerBag);\r\n\tlet entreeRemainder = 0;\r\n\tif (entreeCount % entreesPerBag > 0)\r\n\t{\r\n\t\tentreeRemainder = entreesPerBag - (entreeCount % entreesPerBag);\r\n\t}\r\n\r\n\tif (entreeRemainder > 0)\r\n\t{\r\n\t\tbagsRequired++;\r\n\t}\r\n\t/*\r\n\t\t// simple for now since we are assuming 2 sides fit the space of 1 entree. this could change\r\n\r\n\t\tlet sidesCapacityOfRemainder = entreeRemainder * 2;\r\n\t\tsidesCount -= sidesCapacityOfRemainder;\r\n\r\n\t\tif (sidesCount <= 0)\r\n\t\t{\r\n\t\t\treturn bagsRequired;\r\n\t\t}\r\n\r\n\t\tlet sidesBagsRequired = Math.floor(sidesCount / sidesPerBag);\r\n\t\tlet sidesRemainder = 0;\r\n\t\tif (sidesCount % sidesPerBag > 0)\r\n\t\t{\r\n\t\t\tsidesRemainder = sidesPerBag - (sidesCount % sidesPerBag);\r\n\t\t}\r\n\r\n\t\tif (sidesRemainder > 0)\r\n\t\t{\r\n\t\t\tsidesBagsRequired++;\r\n\t\t}\r\n\t*/\r\n\r\n\t//return bagsRequired + sidesBagsRequired;\r\n\r\n\treturn bagsRequired;\r\n}\r\n\r\n// this massive function is called anytime something that affects costs or payments is altered\r\nfunction calculateTotal()\r\n{\r\n\tlet total = 0;\r\n\tlet entrees = 0;\r\n\tlet servings = 0;\r\n\tlet core_servings = 0;\r\n\tlet halfQty = 0;\r\n\tlet wholeQty = 0;\r\n\tlet customizableMealQty = 0;\r\n\tlet introQty = 0;\r\n\tlet sideDishQty = 0;\r\n\tlet sideDishSubTotal = 0;\r\n\tlet bundlesSubTotal = 0;\r\n\tlet productsSubTotal = 0;\r\n\tlet coreItemsSubtotal = 0;\r\n\tlet bundlesQty = 0;\r\n\tlet discounted_total = 0;\r\n\tlet creditContribution = 0;\r\n\tlet main_items_count = 0;\r\n\tlet bundleIsSelected = false;\r\n\tlet PUDExcludedItemsTotal = 0;\r\n\tlet PUDExcludedFullItemsCount = 0;\r\n\tlet PUDExcludedHalfItemsCount = 0;\r\n\tlet creditConsumed = 0;\r\n\tlet hasServiceFeeWithMFYCoupon = false;\r\n\tlet hasDeliveryFeeWithCoupon = false;\r\n\r\n\tlet sortedCoreItemList = [];\r\n\r\n\tlet itemsSelected = [];\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t{\r\n\t\t\tbundleIsSelected = true;\r\n\t\t}\r\n\t}\r\n\r\n\tfor (let x in entreeIDToInventoryMap)\r\n\t{\r\n\t\tentreeIDToInventoryMap[x].remaining = entreeIDToInventoryMap[x].org_remaining;\r\n\t\t$('[data-entree_inventory_remaining=\"' + x + '\"]').text(entreeIDToInventoryMap[x].org_remaining);\r\n\r\n\t}\r\n\r\n\t// ---------------------------------------------------------- Items\r\n\t// loop through all the quantity input boxes and gather up the totals\r\n\r\n\t// var count = 0;\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\t//  count++;\r\n\r\n\t\tif ($(this).val() != \"\")\r\n\t\t{\r\n\t\t\tif (isNaN($(this).val()) == true || $(this).val() - parseInt($(this).val(), 10) != 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).val(0);\r\n\t\t\t}\r\n\r\n\t\t\tlet itemQty = Number($(this).val());\r\n\t\t\tlet itemId = this.id.split(\"_\")[1];\r\n\r\n\t\t\tif (isFactoringCredit)\r\n\t\t\t{\r\n\t\t\t\tlet orgAmount = $(this).data('org_value');\r\n\t\t\t\tif ($(this).data('dd_type') == 'std')\r\n\t\t\t\t{\r\n\t\t\t\t\tif (orgAmount < itemQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = itemQty - orgAmount;\r\n\t\t\t\t\t\tcreditContribution += (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (itemQty < orgAmount)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = orgAmount - itemQty;\r\n\t\t\t\t\t\tcreditContribution -= (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse // addon\r\n\t\t\t\t{\r\n\t\t\t\t\tlet orgAmount = itemQty.getAttribute('data-org_value');\r\n\t\t\t\t\tif (orgAmount < itemQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = itemQty - orgAmount;\r\n\t\t\t\t\t\tcreditConsumed += (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (itemQty < orgAmount)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = orgAmount - itemQty;\r\n\t\t\t\t\t\tcreditContribution -= (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ((isNaN(itemQty) == false))\r\n\t\t\t{\r\n\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\tlet temp_servings = Number($(this).data('servings'));\r\n\t\t\t\tinv_qty = inv_qty - (itemQty * temp_servings);\r\n\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\r\n\t\t\t\tif ($(this).data('dd_type') != 'cts' && ($(this).data('menu_class') != 'Extended Fast Lane' || PlatePointsRulesVersion == 1))\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (itemQty > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet obj = {\r\n\t\t\t\t\t\t\tid: itemId,\r\n\t\t\t\t\t\t\tqty: itemQty,\r\n\t\t\t\t\t\t\tprice: $(this).data('price'),\r\n\t\t\t\t\t\t\tserving_size: $(this).data('servings')\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tsortedCoreItemList.push(obj)\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttotal += itemQty * $(this).data('price');\r\n\r\n\t\t\t\tif ($(this).data('dd_type') != 'cts')\r\n\t\t\t\t{\r\n\t\t\t\t\tentrees += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\tservings += itemQty * $(this).data('servings');\r\n\r\n\t\t\t\t\tif ($(this).data('menu_class') != 'Extended Fast Lane' || PlatePointsRulesVersion == 1)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcore_servings += itemQty * $(this).data('servings');\r\n\t\t\t\t\t\tcoreItemsSubtotal += itemQty * $(this).data('price');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif ($(this).data('pricing_type') == 'FULL')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\twholeQty += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\thalfQty += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif($(this).data('item_is_customizable') == '1'){\r\n\t\t\t\t\t\tcustomizableMealQty += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tsideDishQty += itemQty;\r\n\t\t\t\t\tsideDishSubTotal += itemQty * $(this).data('price');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ($(this).data('is_bundle') == true)\r\n\t\t\t\t{\r\n\t\t\t\t\tbundlesSubTotal += itemQty * $(this).data('price');\r\n\t\t\t\t\tbundlesQty += itemQty;\r\n\t\t\t\t}\r\n\r\n\t\t\t\titemsSelected[itemId] = itemQty;\r\n\r\n\t\t\t\t$('#sbi_inv_' + entree_id).html(inv_qty);\r\n\t\t\t}\r\n\r\n\t\t\tif ($(this).data('is_bundle') == true)\r\n\t\t\t{\r\n\t\t\t\tupdateSideStationStatus(itemId, itemQty);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\t// bundle support\r\n\t\tlet selectedBundleItemCount = 0;\r\n\t\tlet selectedBundleServingsCount = 0;\r\n\r\n\t\tif (originallyHadBundle)\r\n\t\t{\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t\t\tif ($(this).data('org_value') == \"1\") //was initially chosen\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!$(this).is(\":checked\"))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\t\tinv_qty = inv_qty + $(this).data('servings');\r\n\t\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\r\n\t\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\t\tinv_qty = inv_qty - $(this).data('servings');\r\n\t\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\r\n\t\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{ //bundle is not selected\r\n\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t\t\tif ($(this).data('org_value') == \"1\") //was initially chosen\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\tinv_qty = inv_qty + $(this).data('servings');\r\n\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\tinv_qty = inv_qty - $(this).data('servings');\r\n\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// bundle support\r\n\t\tif (bundleIsSelected)\r\n\t\t{\r\n\t\t\ttotal += (bundleInfo.price * 1);\r\n\t\t\twholeQty += selectedBundleItemCount;\r\n\t\t\tservings += selectedBundleServingsCount;\r\n\t\t}\r\n\t}\r\n\r\n\tif (tasteBundleMenuData)\r\n\t{\r\n\t\tif (isDreamTaste || isFundraiser)\r\n\t\t{\r\n\r\n\t\t\t$(\"#OEH_number_core_servings\").html(bundleInfo.number_servings_required);\r\n\r\n\t\t\t// bundle support\r\n\t\t\tlet selectedWholeBundleItemCount = 0;\r\n\t\t\tlet selectedHalfBundleItemCount = 0;\r\n\t\t\tlet selectedBundleServingsCount = 0;\r\n\r\n\t\t\ttotal += Number(bundleInfo.price);\r\n\r\n\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\t\tlet tasteItemQty = $(this).val();\r\n\t\t\t\tif (tasteItemQty > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tservings += ($(this).data('servings') * tasteItemQty);\r\n\t\t\t\t\tif ($(this).data('servings') == 3)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tselectedHalfBundleItemCount += (tasteItemQty * 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tselectedWholeBundleItemCount += (tasteItemQty * 1);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\tinv_qty = inv_qty - (tasteItemQty * 3);\r\n\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\twholeQty += (selectedWholeBundleItemCount * 1);\r\n\t\t\thalfQty += (selectedHalfBundleItemCount * 1);\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tlet discountablePlatePointsAmount = 0;\r\n\r\n\tif ($(\"#selectedBundle\").is(':checked'))\r\n\t{\r\n\t\t$(\"#max_plate_points_deduction\").html(formatAsMoney(0));\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\r\n\t\t\tif (currentServiceFee > 0)\r\n\t\t\t{\r\n\t\t\t\thasServiceFeeWithMFYCoupon = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\r\n\t\t\tif (currentDeliveryFee > 0)\r\n\t\t\t{\r\n\t\t\t\thasDeliveryFeeWithCoupon = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\t\tlet serviceFee = Number(document.getElementById('subtotal_service_fee').value);\r\n\t\tdiscountablePlatePointsAmount = total + serviceFee.valueOf();\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\r\n\t\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\r\n\t\t\t// adjust the discountablePlatePointsAmount and service to match coupon\r\n\t\t\tdiscountablePlatePointsAmount = formatAsMoney(discountablePlatePointsAmount - currentServiceFee);\r\n\t\t\t$(\"#OEH_subtotal_service_fee\").val(currentServiceFee);\r\n\r\n\t\t\thasServiceFeeWithMFYCoupon = true;\r\n\t\t\tif (discountablePlatePointsAmount < 0)\r\n\t\t\t{\r\n\t\t\t\tdiscountablePlatePointsAmount = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\t\t\thasDeliveryFeeWithCoupon = true;\r\n\t\t}\r\n\r\n\t\tneedPlatePointsMaxDiscountChangeWarning = false;\r\n\r\n\t\tif (discountablePlatePointsAmount != lastMaxPPDiscountAmount && lastMaxPPDiscountAmount != -1)\r\n\t\t{\r\n\t\t\tneedPlatePointsMaxDiscountChangeWarning = true;\r\n\t\t}\r\n\r\n\t\tlastMaxPPDiscountAmount = discountablePlatePointsAmount;\r\n\r\n\t\tif (couponlimitedToFT)\r\n\t\t{\r\n\t\t\tlet tempCouponVal = Number(document.getElementById('couponValue').value);\r\n\t\t\tdiscountablePlatePointsAmount -= tempCouponVal;\r\n\t\t\tif (discountablePlatePointsAmount < 0)\r\n\t\t\t{\r\n\t\t\t\tdiscountablePlatePointsAmount = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$(\"#max_plate_points_deduction\").html(formatAsMoney(discountablePlatePointsAmount))\r\n\t}\r\n\r\n\tif (discountablePlatePointsAmount <= 0)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").attr(\"disabled\", \"disabled\");\r\n\t\t$(\"#plate_points_discount\").css({\r\n\t\t\t\"background-color\": \"#c0c0c0\",\r\n\t\t\t\"color\": \"#060606\"\r\n\t\t});\r\n\t\t$(\"#pp_discountable_cost_msg\").show();\r\n\r\n\t}\r\n\telse if (!discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").removeAttr(\"disabled\");\r\n\t\t$(\"#plate_points_discount\").css({\r\n\t\t\t\"background-color\": \"#fff\",\r\n\t\t\t\"color\": \"#000\"\r\n\t\t});\r\n\t}\r\n\r\n\r\n\tlet discountableReferralRewardAmount = total + Number(document.getElementById('subtotal_service_fee').value);\r\n\r\n\tif (typeof coupon != 'undefined' && coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t{\r\n\r\n\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\r\n\t\t// adjust the discountablePlatePointsAmount and service to match coupon\r\n\t\tdiscountableReferralRewardAmount = formatAsMoney(discountableReferralRewardAmount - currentServiceFee);\r\n\t\t$(\"#OEH_subtotal_service_fee\").val(currentServiceFee);\r\n\r\n\t\thasServiceFeeWithMFYCoupon = true;\r\n\t\tif (discountableReferralRewardAmount < 0)\r\n\t\t{\r\n\t\t\tdiscountableReferralRewardAmount = 0;\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tneedRefferalRewardMaxDiscountChangeWarning = false;\r\n\r\n\tif (discountableReferralRewardAmount != lastMaxReferralRewardDiscountAmount && lastMaxReferralRewardDiscountAmount != -1)\r\n\t{\r\n\t\tneedRefferalRewardMaxDiscountChangeWarning = true;\r\n\t}\r\n\r\n\tlastMaxReferralRewardDiscountAmount = discountableReferralRewardAmount;\r\n\r\n\tif (couponlimitedToFT)\r\n\t{\r\n\t\tlet tempCouponVal = Number(document.getElementById('couponValue').value);\r\n\t\tdiscountableReferralRewardAmount -= tempCouponVal;\r\n\t\tif (discountableReferralRewardAmount < 0)\r\n\t\t{\r\n\t\t\tdiscountableReferralRewardAmount = 0;\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t$(\"#referral_reward_discount\").html(formatAsMoney(discountableReferralRewardAmount))\r\n\r\n\r\n\tif (discountableReferralRewardAmount <= 0)\r\n\t{\r\n\t\t$(\"#referral_reward_discount\").attr(\"disabled\", \"disabled\");\r\n\t\t$(\"#referral_reward_discount\").css({\r\n\t\t\t\"background-color\": \"#c0c0c0\",\r\n\t\t\t\"color\": \"#060606\"\r\n\t\t});\r\n\t\t$(\"#rr_discountable_cost_msg\").show();\r\n\r\n\t}\r\n\telse if (!discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#referral_reward_discount\").removeAttr(\"disabled\");\r\n\t\t$(\"#referral_reward_discount\").css({\r\n\t\t\t\"background-color\": \"#fff\",\r\n\t\t\t\"color\": \"#000\"\r\n\t\t});\r\n\t\t$(\"#rr_discountable_cost_msg\").hide();\r\n\r\n\t}\r\n\r\n\tlet maxPPCredit = $(\"#plate_points_available\").html() * 1;\r\n\tlet maxPPDeduction = $(\"#max_plate_points_deduction\").html() * 1;\r\n\tlet curPPDiscount = $(\"#plate_points_discount\").val() * 1;\r\n\r\n\tif (maxPPDeduction < curPPDiscount)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").val(maxPPDeduction);\r\n\t}\r\n\r\n\tif (maxPPCredit > maxPPDeduction)\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').hide();\r\n\t}\r\n\r\n\tlet maxRRCredit = $(\"#referral_reward_available\").html() * 1;\r\n\tlet maxRRDeduction = $(\"#max_referral_reward_deduction\").html() * 1;\r\n\tlet curRRDiscount = $(\"#referral_reward_discount\").val() * 1;\r\n\r\n\tif (maxRRDeduction < curRRDiscount)\r\n\t{\r\n\t\t$(\"#referral_reward_discount\").val(maxRRDeduction);\r\n\t}\r\n\r\n\tif (maxRRCredit > maxRRDeduction)\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').hide();\r\n\t}\r\n\r\n\tdiscounted_total = total;\r\n\r\n\tlet addonsSubtotal = 0;\r\n\tlet addonsQty = 0;\r\n\r\n\t//var itemRows = document.getElementById('itemsTbl').rows;\r\n\t//for (i = 0; i < itemRows.length; i++)\r\n\r\n\t$(\"#itemsTbl tr\").each(function () {\r\n\r\n\t\tif (this.id.indexOf('row_') != -1)\r\n\t\t{\r\n\t\t\tlet itemNumber = this.id.substr(4);\r\n\r\n\t\t\tlet qty_str = 'qna_' + itemNumber;\r\n\t\t\tlet prc_str = 'prc_' + itemNumber;\r\n\r\n\t\t\tlet addQty = $('#' + qty_str).val();\r\n\t\t\tlet addonsQtyNumber = Number(addQty);\r\n\t\t\tlet addPrc = $(\"#\" + prc_str).html();\r\n\t\t\tlet addPrcNumber = Number(addPrc);\r\n\t\t\taddonsSubtotal += (Number(addPrc) * addQty);\r\n\t\t\taddonsQty += addonsQtyNumber;\r\n\r\n\t\t\t/// var inv_qty =  Number(document.getElementById('inv_org_' + itemNumber).innerHTML);\r\n\t\t\tlet inv_qty = entreeIDToInventoryMap[itemNumber].remaining;\r\n\r\n\t\t\tinv_qty = inv_qty - addQty;\r\n\t\t\t$('[data-entree_inventory_remaining=\"' + itemNumber + '\"]').text(inv_qty);\r\n\t\t\tentreeIDToInventoryMap[itemNumber].remaining = inv_qty;\r\n\r\n\t\t\tif (isFactoringCredit)\r\n\t\t\t{\r\n\t\t\t\torgAmount = document.getElementById(qty_str).getAttribute('data-org_value');\r\n\t\t\t\tif (orgAmount < addonsQtyNumber)\r\n\t\t\t\t{\r\n\t\t\t\t\tdiff = addonsQtyNumber - orgAmount;\r\n\t\t\t\t\tcreditConsumed += (diff * addPrcNumber);\r\n\t\t\t\t}\r\n\t\t\t\telse if (addQty < orgAmount)\r\n\t\t\t\t{\r\n\t\t\t\t\tdiff = orgAmount - addQty;\r\n\t\t\t\t\tcreditContribution -= (diff * addPrcNumber);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tmain_items_count = halfQty + wholeQty + sideDishQty;\r\n\tcore_items_count = halfQty + wholeQty;\r\n\r\n\tlet totalMealQuantity = Number(halfQty + wholeQty);\r\n\r\n\tlet itemCountLabel = $('#OEH_item_count_label');\r\n\r\n\tlet itemCountAdjustmentAmount = 0;\r\n\tlet displayServingsAdjustment = 0;\r\n\r\n\t// coupon code free meal count contribution\r\n\tlet couponTypeElem = $('#coupon_type');\r\n\tif (couponTypeElem.length && couponTypeElem.val() == 'FREE_MEAL')\r\n\t{\r\n\t\tcfm_size = Number($('#free_entree_servings').val());\r\n\r\n\t\tif (cfm_size > 0)\r\n\t\t{\r\n\t\t\tdisplayServingsAdjustment += cfm_size;\r\n\t\t\titemCountAdjustmentAmount++;\r\n\t\t}\r\n\t}\r\n\r\n\tif (itemCountAdjustmentAmount == 0)\r\n\t{\r\n\t\tdisplayMealCount = introQty + wholeQty + halfQty + sideDishQty + addonsQty;\r\n\t\tdisplayServingCount = servings;\r\n\t\titemCountLabel.html(\"Total Item Count\");\r\n\t}\r\n\telse\r\n\t{\r\n\t\tdisplayMealCount = introQty + wholeQty + sideDishQty + halfQty + itemCountAdjustmentAmount + addonsQty;\r\n\t\tdisplayServingCount = servings + displayServingsAdjustment;\r\n\t\titemCountLabel.html(\"Total # Items (incl. free meals)\");\r\n\t}\r\n\r\n\tif (orderEditSuccess)\r\n\t{\r\n\t\tdisplayMealCount += newAddonQty;\r\n\t}\r\n\r\n\t// update the entree and serving totals display\r\n\t$('#OEH_item_count').html(displayMealCount);\r\n\t$('#OEH_number_servings').html(displayServingCount);\r\n\r\n\tif (typeof (order_minimum) !== 'undefined' && order_minimum.minimum_type == 'ITEM')\r\n\t{\r\n\t\tcore_servings = core_items_count;\r\n\t}\r\n\tlocalStorage.setItem('core-item-count', core_items_count);\r\n\tlocalStorage.setItem('side-item-count', sideDishQty);\r\n\r\n\tif (PlatePointsRulesVersion > 1)\r\n\t{\r\n\t\t$('#OEH_number_core_servings').html(core_servings);\r\n\t}\r\n\r\n\tlet premarkup_total = 0;\r\n\r\n\tlet freeMealValue = 0;\r\n\r\n\t// also must add coupon code free meal\r\n\t// coupon code free meal count contribution\r\n\tcouponTypeElem = $('#coupon_type');\r\n\tif (couponTypeElem.length && couponTypeElem.val() == 'FREE_MEAL')\r\n\t{\r\n\t\tfreeMealValue = Number($('#couponValue').val());\r\n\r\n\t\tif (freeMealValue > 0)\r\n\t\t{\r\n\t\t\tdiscounted_total += freeMealValue;\r\n\t\t}\r\n\t}\r\n\r\n\tdiscounted_total += addonsSubtotal;\r\n\r\n\tif (orderEditSuccess)\r\n\t{\r\n\t\tdiscounted_total += newAddonAmount;\r\n\t}\r\n\r\n\tdiscounted_total = Math.round(discounted_total * 100) / 100;\r\n\r\n\t// --------------------------------------------------------------------- menu items subtotal\r\n\t$('#orderSubTotal').val(formatAsMoney(Math.round(total * 100) / 100));\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney(discounted_total));\r\n\t$('#orderTotal').val(formatAsMoney(discounted_total));\r\n\r\n\t// ------------------------------------------------------ food subtotal\r\n\r\n\tlet miscFoodSubtotal = Number(document.getElementById('misc_food_subtotal').value);\r\n\r\n\t// menu items total plus misc food cost\r\n\tlet food_costs = (discounted_total * 1) + (miscFoodSubtotal * 1);\r\n\t$('#OEH_food_cost_subtotal').html(formatAsMoney((discounted_total * 1) + (miscFoodSubtotal * 1)));\r\n\r\n\tlet newGrandTotal = discounted_total;\r\n\tlet pre_discounts_grand_total = newGrandTotal;\r\n\r\n\t// -------------------------------DISCOUNTS-----------------------------------------\r\n\r\n\tcurPPDiscount = 0;\r\n\t// ----------------------------------------------  PLATEPOINTS Discount\r\n\tif ($('#plate_points_discount').length)\r\n\t{\r\n\t\tcurPPDiscount = $('#plate_points_discount').val();\r\n\t\tif (curPPDiscount * 1 > discountablePlatePointsAmount * 1)\r\n\t\t{\r\n\t\t\tcurPPDiscount = discountablePlatePointsAmount;\r\n\r\n\t\t\tif (curPPDiscount == 0)\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(\"\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(formatAsMoney(curPPDiscount));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//$('#OEH_plate_points_order_discount').html(formatAsMoney(curPPDiscount));\r\n\t\t// This is now done in the taxesd section\r\n\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - curPPDiscount);\r\n\t}\r\n\r\n\tlet curReferralRewardDiscount = 0;\r\n\t// ----------------------------------------------  Referral Reward Discount\r\n\tif ($('#referral_reward_discount').length)\r\n\t{\r\n\t\tcurReferralRewardDiscount = $('#referral_reward_discount').val();\r\n\t\tif (curReferralRewardDiscount * 1 > discountablePlatePointsAmount * 1)\r\n\t\t{\r\n\t\t\tcurReferralRewardDiscount = discountablePlatePointsAmount;\r\n\r\n\t\t\tif (curReferralRewardDiscount == 0)\r\n\t\t\t{\r\n\t\t\t\t$('#referral_reward_discount').val(\"\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#referral_reward_discount').val(formatAsMoney(curReferralRewardDiscount));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$('#OEH_referral_reward_order_discount').html(formatAsMoney(curReferralRewardDiscount));\r\n\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - curReferralRewardDiscount);\r\n\t}\r\n\r\n\t// ---------------------------------------------- Direct Order\r\n\tlet directDiscountVal = Number(0);\r\n\r\n\tdirectDiscount = $('#direct_order_discount');\r\n\r\n\tif (directDiscount.length)\r\n\t{\r\n\t\tdirectDiscountVal = directDiscount.val();\r\n\r\n\t\tif (isNaN(directDiscountVal))\r\n\t\t{\r\n\t\t\tdirectDiscountVal = 0;\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal > food_costs)\r\n\t\t{\r\n\t\t\tdirectDiscountVal = food_costs;\r\n\t\t\tdirectDiscount.val(directDiscountVal);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal)\r\n\t\t{\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - directDiscountVal);\r\n\t\t}\r\n\r\n\t\t$('#OEH_direct_order_discount').html(formatAsMoney(directDiscountVal));\r\n\r\n\t}\r\n\r\n\t// Adjust Bonus Credit and discount\r\n\tif (isFactoringCredit)\r\n\t{\r\n\t\t//alert(creditContribution);\r\n\t\t//alert(creditConsumed);\r\n\t\tcreditBasis += creditContribution;\r\n\t\tcreateBonusCredit(creditConsumed);\r\n\t}\r\n\r\n\t// ------------------------------------------------------------------- coupon Discount\r\n\r\n\tif (couponDiscountMethod == 'PERCENT')\r\n\t{\r\n\r\n\t\tlet CouponCodeStr = $('#coupon_code').val();\r\n\t\tvar newDiscountAmount = 0;\r\n\t\ttry\r\n\t\t{\r\n\t\t\t//this method correctly handles rounding in a way that matches server side\r\n\t\t\tlet formatterUSD = new Intl.NumberFormat('en-US', {\r\n\t\t\t\tminimumFractionDigits: 2,\r\n\t\t\t\tmaximumFractionDigits: 2\r\n\t\t\t});\r\n\t\t\tif (CouponCodeStr == 'VOLUME' || couponlimitedToCore)\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount =  formatterUSD.format(coreItemsSubtotal * (couponDiscountVar / 100))\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = formatterUSD.format(pre_discounts_grand_total * (couponDiscountVar / 100))\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch(e)\r\n\t\t{\r\n\t\t\t//original way which lead to off-by-one issue compared to server's method of rounding\r\n\t\t\tif (CouponCodeStr == 'VOLUME' || couponlimitedToCore )\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = Math.floor(coreItemsSubtotal * (couponDiscountVar));\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = Math.floor(pre_discounts_grand_total * (couponDiscountVar));\r\n\t\t\t}\r\n\r\n\t\t\tnewDiscountAmount /= 100;\r\n\t\t}\r\n\r\n\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tif (couponlimitedToFT)\r\n\t{\r\n\t\tif (couponDiscountMethod == 'FLAT')\r\n\t\t{\r\n\t\t\tlet newDiscountVal = sideDishSubTotal;\r\n\r\n\t\t\tif (newDiscountVal > couponDiscountVar)\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = couponDiscountVar;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = newDiscountVal;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (couponDiscountMethod == 'PERCENT')\r\n\t\t{\r\n\t\t\tlet newDiscountVal = sideDishSubTotal;\r\n\r\n\t\t\tvar newDiscountAmount = Math.floor(newDiscountVal * (couponDiscountVar));\r\n\r\n\t\t\tnewDiscountAmount /= 100;\r\n\t\t}\r\n\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tlet couponDiscountVal = Number(0);\r\n\tcouponDiscount = $('#couponValue');\r\n\r\n\tif (couponDiscount.length)\r\n\t{\r\n\t\tif (couponDiscount.val() == \"\")\r\n\t\t{\r\n\t\t\tcouponDiscount.val('0.00');\r\n\t\t}\r\n\t\tcouponDiscountVal = couponDiscount.val();\r\n\t}\r\n\r\n\tlet couponDiscountValIsServiceFee = false;\r\n\tlet couponDiscountValIsDeliveryFee = false;\r\n\r\n\tif (typeof coupon != 'undefined')\r\n\t{\r\n\t\tif (coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\t\t\tif (couponDiscountVal != currentServiceFee)\r\n\t\t\t{\r\n\t\t\t\tcouponDiscountVal = currentServiceFee;\r\n\t\t\t}\r\n\r\n\t\t\tcouponDiscountValIsServiceFee = true;\r\n\t\t}\r\n\r\n\t\tif (coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\t\t\tif (couponDiscountVal != currentDeliveryFee)\r\n\t\t\t{\r\n\t\t\t\tif(parseFloat(couponDiscountVal) > parseFloat(currentDeliveryFee)){\r\n\t\t\t\t\tcouponDiscountVal = currentDeliveryFee;\r\n\t\t\t\t\tcouponDiscountValIsDeliveryFee = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//couponDiscountValIsDeliveryFee = true;\r\n\t\t}\r\n\r\n\t\tif (coupon.limit_to_recipe_id == '1')\r\n\t\t{\r\n\t\t\tlet prc_str = $('#prc_' + coupon.menu_item_id).text();\r\n\r\n\t\t\tif (coupon.discount_method == 'FLAT')\r\n\t\t\t{\r\n\t\t\t\tif (prc_str > coupon.discount_var)\r\n\t\t\t\t{\r\n\t\t\t\t\tcouponDiscountVal = formatAsMoney(prc_str - coupon.discount_var);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tcouponDiscountVal = formatAsMoney(prc_str);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (coupon.discount_method == 'PERCENT')\r\n\t\t\t{\r\n\t\t\t\tcouponDiscountVal = formatAsMoney(prc_str * (coupon.discount_var / 100));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$('#couponValue').val(couponDiscountVal);\r\n\t}\r\n\r\n\tif (couponDiscountVal)\r\n\t{\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - couponDiscountVal);\r\n\t\t$('#OEH_coupon_discount').html(formatAsMoney(couponDiscountVal));\r\n\t}\r\n\r\n\t// ------------------------------------------------ Preferred Customer\r\n\tlet PUDElem = $('#PUDnoUP');\r\n\tlet UPDiscountElem;\r\n\tif (PUDElem.length && !bundleIsSelected)\r\n\t{\r\n\t\tlet selectedUP = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\t\tif (selectedUP == null || selectedUP == \"\")\r\n\t\t{\r\n\t\t\tselectedUP = \"noUP\";\r\n\t\t}\r\n\r\n\t\tlet UPDiscount = -1;\r\n\r\n\t\tlet UPType = 'none';\r\n\t\tlet PcntTypeValue = 0.0;\r\n\r\n\t\tif (originalUP != false || activeUP != false)\r\n\t\t{\r\n\t\t\tlet preferredData = false;\r\n\r\n\t\t\tif (selectedUP == \"activeUP\")\r\n\t\t\t{\r\n\t\t\t\tpreferredData = activeUP;\r\n\t\t\t}\r\n\t\t\telse if (selectedUP == \"originalUP\")\r\n\t\t\t{\r\n\t\t\t\tpreferredData = originalUP;\r\n\t\t\t}\r\n\r\n\t\t\tlet preferredCapRemaining = preferredData.preferred_cap_value;\r\n\r\n\t\t\tif (capacityUP.remainingObj.countRemaining !== null)\r\n\t\t\t{\r\n\t\t\t\tpreferredCapRemaining = capacityUP.remainingObj.countRemaining\r\n\t\t\t}\r\n\r\n\t\t\tif (preferredData.type == \"FLAT\")//Only allows ITEMS type\r\n\t\t\t{\r\n\r\n\t\t\t\tif ((preferredData.preferred_cap_type == 'ITEMS' && totalMealQuantity <= preferredCapRemaining) ||\r\n\t\t\t\t\tpreferredData.preferred_cap_type == 'NONE')\r\n\t\t\t\t{\r\n\t\t\t\t\tlet cost = (wholeQty - PUDExcludedFullItemsCount) * preferredData.value;\r\n\t\t\t\t\tlet halfCost = Number(formatAsMoney(((halfQty - PUDExcludedHalfItemsCount) * (preferredData.value / 2))));\r\n\t\t\t\t\tcost += halfCost;\r\n\t\t\t\t\tlet basis = discounted_total - cost - addonsSubtotal - productsSubTotal - PUDExcludedItemsTotal;\r\n\t\t\t\t\tif (preferredData.include_sides === '0')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbasis -= sideDishSubTotal;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tUPDiscount = formatAsMoney(basis);\r\n\t\t\t\t\tUPType = 'flat';\r\n\t\t\t\t}else if((preferredData.preferred_cap_type == 'ITEMS' && totalMealQuantity > preferredCapRemaining)){\r\n\r\n\t\t\t\t\tlet cost = 0;\r\n\t\t\t\t\tlet halfCost = 0;\r\n\t\t\t\t\tlet itemCount = 0;\r\n\t\t\t\t\tsortedCoreItemList.sort((a, b) => (a.price < b.price) ? 1 : -1);\r\n\t\t\t\t\tfor(let i = 0; i < totalMealQuantity; i++){\r\n\t\t\t\t\t\titemCount += sortedCoreItemList[i].qty;\r\n\t\t\t\t\t\tif(itemCount <= preferredCapRemaining){\r\n\t\t\t\t\t\t\tif(sortedCoreItemList[i].serving_size > 5)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tcost += sortedCoreItemList[i].qty * preferredData.value;\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\thalfCost += Number(formatAsMoney(((sortedCoreItemList[i].qty - PUDExcludedHalfItemsCount) * (preferredData.value / 2))))\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tcost += sortedCoreItemList[i].qty * sortedCoreItemList[i].price;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tcost += halfCost;\r\n\r\n\r\n\t\t\t\t\tlet basis = discounted_total - cost - addonsSubtotal - productsSubTotal - PUDExcludedItemsTotal;\r\n\t\t\t\t\tif (preferredData.include_sides === '0')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbasis -= sideDishSubTotal;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tUPDiscount = formatAsMoney(basis);\r\n\t\t\t\t\tUPType = 'flat';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (preferredData.type == \"PERCENT\")\r\n\t\t\t{\r\n\t\t\t\tif ((preferredData.preferred_cap_type == 'ITEMS' && totalMealQuantity <= preferredCapRemaining) ||\r\n\t\t\t\t\t(preferredData.preferred_cap_type == 'SERVINGS' && servings <= preferredCapRemaining) ||\r\n\t\t\t\t\tpreferredData.preferred_cap_type == 'NONE')\r\n\t\t\t\t{\r\n\t\t\t\t\tlet basis = pre_discounts_grand_total - addonsSubtotal - productsSubTotal;\r\n\t\t\t\t\tif (preferredData.include_sides === '0')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbasis -= sideDishSubTotal;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlet multiplier = preferredData.value / 100;\r\n\t\t\t\t\tlet pud_result = basis * multiplier;\r\n\t\t\t\t\tlet rounded_pud_result = dd_round_amount(pud_result);\r\n\t\t\t\t\tUPDiscount = formatAsMoney(rounded_pud_result);\r\n\t\t\t\t\tUPType = 'pcnt';\r\n\t\t\t\t\tPcntTypeValue = preferredData.value / 100;\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (selectedUP == \"noUP\")\r\n\t\t{\r\n\t\t\tUPDiscount = 0;\r\n\t\t}\r\n\r\n\t\tif (UPType == 'flat')\r\n\t\t{\r\n\t\t\tif (typeof promoVal != 'undefined' && promoVal > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= promoVal;\r\n\t\t\t}\r\n\r\n\t\t\tif (freeMealValue > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= freeMealValue;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (UPType == 'pcnt')\r\n\t\t{\r\n\t\t\tif (typeof promoVal != 'undefined' && promoVal > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= (promoVal * PcntTypeValue);\r\n\t\t\t\tUPDiscount = Math.round(UPDiscount * 100) / 100;\r\n\t\t\t}\r\n\r\n\t\t\tif (freeMealValue > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= (freeMealValue * PcntTypeValue);\r\n\t\t\t\tUPDiscount = Math.round(UPDiscount * 100) / 100;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (UPDiscount != -1)\r\n\t\t{\r\n\t\t\tUPDiscountElem = $('#OEH_preferred');\r\n\t\t\tif (UPDiscountElem.length)\r\n\t\t\t{\r\n\t\t\t\tUPDiscountElem.html(formatAsMoney(UPDiscount));\r\n\t\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - UPDiscount);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// ----------------------------------------------------------Membership Discount\r\n\r\n\tif (orderIsEligibleForMembershipDiscount && storeSupportsMembership)\r\n\t{\r\n\t\tlet couponAdjustment = Number(0);\r\n\t\tif (couponDiscountValIsServiceFee || couponDiscountValIsDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponAdjustment = couponDiscountVal;\r\n\t\t}\r\n\r\n\t\tlet membership_discount_basis = Number((newGrandTotal * 1) + (couponAdjustment * 1));\r\n\t\tlet memberDiscountAmount = Number(membership_discount_basis * (membership_status.discount_var / 100));\r\n\t\tmemberDiscountAmount = Math.round(memberDiscountAmount * 100) / 100;\r\n\r\n\t\t$(\"#OEH_membership_discount\").html(formatAsMoney(memberDiscountAmount));\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - memberDiscountAmount);\r\n\r\n\t}\r\n\r\n\t// -------------------------------------------------------- Session Discount\r\n\r\n\tSessDisc = $('#SessDiscnoSD');\r\n\tif (SessDisc.length && !orderIsEligibleForMembershipDiscount)\r\n\t{\r\n\t\tlet couponAdjustment = Number(0);\r\n\t\tif (couponDiscountValIsServiceFee || couponDiscountValIsDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponAdjustment = couponDiscountVal;\r\n\t\t}\r\n\r\n\t\tlet session_discount_basis = Number((newGrandTotal * 1) + (directDiscountVal * 1) + (miscFoodSubtotal * 1) + (couponAdjustment * 1));\r\n\r\n\t\tlet selectedSD = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\t\tif (selectedSD == null || selectedSD == \"\")\r\n\t\t{\r\n\t\t\tselectedSD = \"noSD\";\r\n\t\t}\r\n\r\n\t\tlet sessionDiscount = -1;\r\n\r\n\t\tif (selectedSD == \"originalSD\")\r\n\t\t{\r\n\r\n\t\t\tlet rawAmount = (session_discount_basis * originalSD.value) / 100;\r\n\t\t\trawAmount += .00000001; // salt to avoid rounding error\r\n\t\t\t// can't do this in formatAsMoney without a full validation of order manager as odd things happen\r\n\t\t\tsessionDiscount = formatAsMoney(rawAmount);\r\n\t\t}\r\n\t\telse if (selectedSD == \"activeSD\")\r\n\t\t{\r\n\t\t\tsessionDiscount = formatAsMoney((session_discount_basis * activeSessionDiscount.value) / 100);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsessionDiscount = 0;\r\n\t\t}\r\n\r\n\t\tSDiscountElem = $('#OEH_session_discount');\r\n\t\tif (SDiscountElem.length)\r\n\t\t{\r\n\t\t\tSDiscountElem.html(formatAsMoney(sessionDiscount));\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - sessionDiscount);\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (miscFoodSubtotal * 1));\r\n\t$('#OEH_misc_food_subtotal').html(formatAsMoney(miscFoodSubtotal));\r\n\r\n\tlet miscNonFoodSubtotal = Number($('#misc_nonfood_subtotal').val());\r\n\t$('#OEH_misc_nonfood_subtotal').html(formatAsMoney(miscNonFoodSubtotal));\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (miscNonFoodSubtotal * 1));\r\n\r\n\tlet serviceFee = Number($('#subtotal_service_fee').val());\r\n\t$('#OEH_subtotal_service_fee').html(formatAsMoney(serviceFee));\r\n\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (serviceFee * 1));\r\n\r\n\tlet deliveryFee = Number(0);\r\n\tif ($('#subtotal_delivery_fee')[0])\r\n\t{\r\n\t\tdeliveryFee = Number($('#subtotal_delivery_fee').val());\r\n\t\t$('#OEH_subtotal_delivery_fee').html(formatAsMoney(deliveryFee));\r\n\r\n\t\tnewGrandTotal = Number((newGrandTotal * 1) + (deliveryFee * 1));\r\n\t}\r\n\r\n\tlet BagFeeTotal = Number(0);\r\n\t// Bag Fees\r\n\tif (storeSupportsBagFees)\r\n\t{\r\n\t\tlet calculatedBagCount = getNumberBagsRequiredFromItems(halfQty + wholeQty, sideDishQty);\r\n\r\n\t\tif (!$(\"#opted_to_bring_bags\").is(\":checked\"))\r\n\t\t{\r\n\t\t\t$(\"#total_bag_count\").prop(\"disabled\", false);\r\n\r\n\t\t\tif (bagCountLockedToField)\r\n\t\t\t{\r\n\t\t\t\tnumBagsRequired = $(\"#total_bag_count\").val();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnumBagsRequired = calculatedBagCount;\r\n\t\t\t\t$(\"#total_bag_count\").val(calculatedBagCount);\r\n\t\t\t}\r\n\r\n\t\t\tif (isNaN(numBagsRequired))\r\n\t\t\t{\r\n\t\t\t\tnumBagsRequired = 0;\r\n\t\t\t}\r\n\r\n\t\t\tBagFeeTotal = storeDefaultBagFee * numBagsRequired;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#total_bag_count\").prop(\"disabled\", \"disabled\");\r\n\t\t\t$(\"#total_bag_count\").val(\"0\");\r\n\t\t}\r\n\r\n\t\t$(\"#OEH_subtotal_bag_fee\").html(formatAsMoney(BagFeeTotal));\r\n\r\n\t}\r\n\tlet mealCustomizationFeeTotal = 0;\r\n\t// Meal Customization Fees\r\n\tif (storeSupportsMealCustomization)\r\n\t{\r\n\r\n\t\tif($('#manual_customization_fee').val() == 'true')\r\n\t\t{\r\n\t\t\t//use manually entered value\r\n\t\t\tmealCustomizationFeeTotal = Number($(\"#subtotal_meal_customization_fee\").val());\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tmealCustomizationFeeTotal =  calculateMealCustomizationFee(customizableMealQty);\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").val(formatAsMoney(mealCustomizationFeeTotal));\r\n\t\t}\r\n\r\n\t\tif ($(\"#opted_to_customize_recipes\").is(\":checked\"))\r\n\t\t{\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").prop(\"disabled\", \"disabled\");\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").val(\"\");\r\n\t\t\tmealCustomizationFeeTotal = 0;\r\n\t\t\t$(\"#customization-row-container\").hide();\r\n\t\t}\r\n\r\n\t\t$(\"#OEH_subtotal_meal_customization_fee\").html(formatAsMoney(mealCustomizationFeeTotal));\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------- tax\r\n\r\n\t// Currently the only taxed product is the enrollment fee which is taxed at a special rate\r\n\tlet newNonFoodTax = formatAsMoney(miscNonFoodSubtotal * (curNonFoodTax / 100));\r\n\tlet enrollmentTax = formatAsMoney(productsSubTotal * (curEnrollmentTax / 100));\r\n\r\n\tlet newDeliveryTax = 0;\r\n\tif (!hasDeliveryFeeWithCoupon)\r\n\t{\r\n\t\tnewDeliveryTax = formatAsMoney(deliveryFee * (curDeliveryTax / 100));\r\n\t}\r\n\r\n\tnewNonFoodTax *= 1; // convert to float\r\n\tnewNonFoodTax += (enrollmentTax * 1);\r\n\t//TODO: will have other products than enrollment someday.\r\n\tif (productsSubTotal)\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food & Enrollment Tax');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food Tax');\r\n\r\n\t}\r\n\r\n\tlet newFoodTax = 0;\r\n\tlet newServiceTax = 0;\r\n\r\n\tif (curPPDiscount > 0)\r\n\t{\r\n\t\tlet food_portion_of_points_credit = 0;\r\n\t\tlet fee_portion_of_points_credit = 0;\r\n\r\n\t\tif (hasServiceFeeWithMFYCoupon)\r\n\t\t{\r\n\t\t\tfood_portion_of_points_credit = curPPDiscount;\r\n\t\t\tfee_portion_of_points_credit = 0;\r\n\t\t}\r\n\t\telse if (discountMFYFeeFirst && serviceFee > 0)\r\n\t\t{\r\n\r\n\t\t\tif (curPPDiscount > serviceFee)\r\n\t\t\t{\r\n\t\t\t\tfood_portion_of_points_credit = curPPDiscount - serviceFee;\r\n\t\t\t\tfee_portion_of_points_credit = serviceFee;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tfee_portion_of_points_credit = curPPDiscount;\r\n\t\t\t\tfood_portion_of_points_credit = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tlet foodPortionOfMaxDeduction = discountablePlatePointsAmount - serviceFee;\r\n\r\n\t\t\tif (curPPDiscount > foodPortionOfMaxDeduction)\r\n\t\t\t{\r\n\t\t\t\tlet remainderAfterFoodDiscount = curPPDiscount - foodPortionOfMaxDeduction;\r\n\t\t\t\tfood_portion_of_points_credit = foodPortionOfMaxDeduction;\r\n\t\t\t\tfee_portion_of_points_credit = remainderAfterFoodDiscount;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tfood_portion_of_points_credit = curPPDiscount;\r\n\t\t\t\tfee_portion_of_points_credit = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (hasServiceFeeWithMFYCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - food_portion_of_points_credit - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewServiceTax = 0;\r\n\t\t}\r\n\t\telse if (hasDeliveryFeeWithCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - food_portion_of_points_credit - serviceFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewDeliveryTax = 0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - serviceFee - food_portion_of_points_credit - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tlet mealCustomizationFee = Number($('#subtotal_meal_customization_fee').val())\r\n\t\t\tif (isNaN(mealCustomizationFee)) { mealCustomizationFee = 0;}\r\n\t\t\tnewServiceTax = formatAsMoney(((((serviceFee + mealCustomizationFee) - fee_portion_of_points_credit)) * (curServiceTax / 100)) + .000001);\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_food').html(formatAsMoney(food_portion_of_points_credit));\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(fee_portion_of_points_credit));\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif (hasServiceFeeWithMFYCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewServiceTax = 0;\r\n\t\t}\r\n\t\telse if (hasDeliveryFeeWithCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - serviceFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewDeliveryTax = 0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - serviceFee - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tlet mealCustomizationFee = Number($('#subtotal_meal_customization_fee').val())\r\n\t\t\tif (isNaN(mealCustomizationFee)) { mealCustomizationFee = 0;}\r\n\t\t\tnewServiceTax = formatAsMoney((serviceFee + mealCustomizationFee) * (curServiceTax / 100) + .000001);\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_food').html(formatAsMoney(0));\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(0));\r\n\t}\r\n\r\n\tlet newBagFeeTax = formatAsMoney(BagFeeTotal * (curBagFeeTax / 100) + .000001);\r\n\r\n\ttaxElem = document.getElementById('OEH_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newNonFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_food_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_service_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newServiceTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_delivery_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newDeliveryTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_bag_fee_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newBagFeeTax);\r\n\t}\r\n\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (BagFeeTotal * 1) + (mealCustomizationFeeTotal * 1));\r\n\r\n\tlet preTaxTotal = Number(newGrandTotal);\r\n\tnewGrandTotal = (newGrandTotal * 1) + (newFoodTax * 1) + (newNonFoodTax * 1) + (newServiceTax * 1) + (newDeliveryTax * 1) + (newBagFeeTax * 1);\r\n\r\n\t/*\r\n\t * *\r\n\t * LTD ROUND UP, MUST BE AFTER GRAND TOTAL\r\n\t * *\r\n\t */\r\n\tlet round_up_donation = 0;\r\n\r\n\tlet subtotal_round_up = Math.ceil(newGrandTotal);\r\n\tlet subtotal_round_up_diff = parseFloat((subtotal_round_up - (newGrandTotal)).toFixed(2));\r\n\r\n\tif (subtotal_round_up_diff == 0)\r\n\t{\r\n\t\tsubtotal_round_up_diff = 1.00;\r\n\t}\r\n\r\n\tif ($('#round_up_nearest_dollar').val() != subtotal_round_up_diff)\r\n\t{\r\n\t\t$('#round_up_nearest_dollar').val(subtotal_round_up_diff).text('$ ' + formatAsMoney(subtotal_round_up_diff));\r\n\t\t$('#add_ltd_round_up').trigger('change');\r\n\t}\r\n\r\n\tif ($('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\tif ($('#ltd_round_up_select').find(':selected').attr('id') == 'round_up_nearest_dollar')\r\n\t\t{\r\n\t\t\tround_up_donation = subtotal_round_up_diff;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tround_up_donation = parseFloat($('#ltd_round_up_select').val());\r\n\t\t}\r\n\t}\r\n\r\n\tif (isNaN(round_up_donation))\r\n\t{\r\n\t\tround_up_donation = 0;\r\n\t}\r\n\r\n\t$('#OEH_ltd_round_up').html(formatAsMoney(round_up_donation));\r\n\r\n\tnewGrandTotal += Number(round_up_donation);\r\n\t/*\r\n\t * end Round UP\r\n\t */\r\n\r\n\t// -------------------------------------------------------------------- grand total\r\n\t$('#OEH_grandtotal').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_new_total').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_delta').html(formatAsMoney((orderInfoGrandTotal - newGrandTotal) * -1));\r\n\r\n\tlet paymentTotal = 0;\r\n\tif ($('#OEH_paymentsTotal').length)\r\n\t{\r\n\t\tpaymentTotal = $('#OEH_paymentsTotal').html();\r\n\t}\r\n\r\n\tlet remainingBalance = Number(formatAsMoney(paymentTotal - newGrandTotal));\r\n\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance * -1));\r\n\r\n\t// Values are now calculated and the summary display updated\r\n\t// Next Display \"balance\" messages and set up payments\r\n\r\n\tif (orderState == 'CANCELLED')\r\n\t{\r\n\t\tremainingBalance = paymentTotal;\r\n\t\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance));\r\n\r\n\t}\r\n\r\n\tif (remainingBalance > 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to the customer.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_customer_owed');\r\n\t\t$(\"#newPaymentDiv\").hide();\r\n\r\n\t\tif (canAdjustDelayedPayment && currentDPAmount > 0)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').show();\r\n\t\t}\r\n\r\n\t\t$('#payment1_type').val('');\r\n\t\t$('#payment2_type').val('');\r\n\t\tchangePayment1('');\r\n\t\tchangePayment2('');\r\n\r\n\t\tpaymentChanges = true;\r\n\r\n\t\t$(\"#use_store_credits\").prop('checked', false);\r\n\t\t$(\"#use_store_credits\").prop('disabled', true);\r\n\r\n\t}\r\n\telse if (remainingBalance < 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to your store.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_store_owed');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tlet doNewLivePaymentAdjustments = true;\r\n\t\tif (doNewLivePaymentAdjustments)\r\n\t\t{\r\n\r\n\t\t\tlet defaultPaymentAmount = remainingBalance * -1;\r\n\r\n\t\t\tif ($(\"#use_store_credits\").is(\":checked\"))\r\n\t\t\t{\r\n\r\n\t\t\t\tlet amountStoreCredit = Number($(\"#store_credits_amount\").val());\r\n\t\t\t\tif (isNaN(amountStoreCredit.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tamountStoreCredit = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount -= amountStoreCredit.valueOf();\r\n\t\t\t}\r\n\r\n\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount);\r\n\r\n\t\t\tif ($('#payment1_type').val() == 'CC')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val() == 'CHECK')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if (($('#payment1_type').val() == 'GIFT_CERT' || $('#payment1_type').val() == \"GIFT_CARD\") && $('#payment2_type').val() != \"\")\r\n\t\t\t{\r\n\t\t\t\tlet payment1Amount = null;\r\n\t\t\t\tif ($('#payment1_type').val() == 'GIFT_CERT')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#payment1_gc_total_amount').val());\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment1_type').val() == 'GIFT_CARD')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#debit_gift_card_amount').val());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isNaN(payment1Amount.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount - payment1Amount.valueOf());\r\n\t\t\t\tif ($('#payment2_type').val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CHECK')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CASH')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cash_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse // == 0\r\n\t{\r\n\t\t$(\"#balance_msg\").html(\"0.00\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_balanced');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tassignBalanceToRefTransactions(0);\r\n\t}\r\n\r\n\tif (newGrandTotal == 0 && $('#payment1_type').val() == \"\" && $('#payment2_type').val() == \"\" && !onTimeShotAtSupplyingZeroPaymentHasOccurred && orderState == 'SAVED')\r\n\t{\r\n\t\t$('#payment1_type').val('CASH');\r\n\t\tchangePayment1('CASH');\r\n\t\t$('#payment1_cash_total_amount').val(\"0.00\");\r\n\r\n\t\tonTimeShotAtSupplyingZeroPaymentHasOccurred = true;\r\n\t}\r\n\r\n\tlet autoAdjustDiv = $('#autoAdjustDiv');\r\n\tif (autoAdjustDiv.length)\r\n\t{\r\n\r\n\t\tif (remainingBalance != 0 && canAutoAdjust)\r\n\t\t{\r\n\t\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || remainingBalance < 0))\r\n\t\t\t{\r\n\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>adjust customer's delayed payment.</b></span>\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (remainingBalance > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>credit customer's credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>charge original credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tautoAdjustDiv.show();\r\n\t\t\tif (!forceManualAutoAdjust)\r\n\t\t\t{\r\n\t\t\t\t$('#autoAdjust').prop('checked', true);\r\n\t\t\t\thandleAutoAdjust($('#autoAdjust').get()[0]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// if the div is hidden skip these steps\r\n\r\n\t\t\tif (autoAdjustDiv.is(\":visible\"))\r\n\t\t\t{\r\n\t\t\t\tautoAdjustDiv.hide();\r\n\t\t\t\t$('#autoAdjust').prop('checked', false);\r\n\t\t\t\t$('#payment1_type').val('');\r\n\t\t\t\t$('#payment2_type').val('');\r\n\t\t\t\tchangePayment1('');\r\n\t\t\t\tchangePayment2('');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$('#help_msg').html(\"\");\r\n\r\n\t// enforce a few rules by disallowing checkout\r\n\tif ($('#submit_changes').length)\r\n\t{\r\n\r\n\t\tif (servings > 0 || sideDishQty > 0 || addonsSubtotal > 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", false);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal >= (Number(preTaxTotal) + Number(directDiscountVal)) && preTaxTotal != 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t\t$('#help_msg').html($('#help_msg').html() + \"You cannot use a Direct Order Discount that is equal to or greater than the food cost total. Please use the \\\"No Charge\\\" payment type to give away an order.\");\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($('#help_msg').length)\r\n\t{\r\n\t\tif ($('#help_msg').html() != \"\")\r\n\t\t{\r\n\t\t\t$('#help_msg').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#help_msg').hide();\r\n\t\t}\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n\r\n\tHideLineItemsIfZero();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n}\r\n\r\n$(document).on('focusin', '.bundle-subitem-qty', function (e) {\r\n\r\n\t$(this).data('org_val', $(this).val());\r\n\r\n}).on('keyup change', '.bundle-subitem-qty', function (e) {\r\n\r\n\tlet canIncrement = canIncrementBundleSubItem($(this), '.bundle-subitem-qty');\r\n\r\n\tif (canIncrement !== true)\r\n\t{\r\n\t\t$(this).val($(this).data('org_val'));\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Max Items Reached',\r\n\t\t\tmessage: canIncrement\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(this).data('org_val', $(this).val());\r\n\r\n\t\tqtyUpdate(this);\r\n\t}\r\n\r\n\tcalculateTotal();\r\n\r\n});\r\n\r\nfunction canIncrementBundleSubItem(input, selector)\r\n{\r\n\tlet mid = $(input).data('menu_item_id');\r\n\tlet pid = $(input).data('parent_item');\r\n\r\n\tlet itemInfo = sideStationBundleInfo[pid].bundle[mid];\r\n\tlet parentItemInfo = sideStationBundleInfo[pid];\r\n\tlet parentNumItemsRequired = parseInt(parentItemInfo.number_items_required);\r\n\tlet groupID = parseInt(itemInfo.bundle_to_menu_item_group_id) || 0;\r\n\r\n\t// check that we aren't going over the total\r\n\tlet total_org = 0;\r\n\tlet total_current = 0;\r\n\tlet groupInfo = [];\r\n\r\n\t$(selector + '[data-parent_item=\"' + pid + '\"]').each(function () {\r\n\r\n\t\tlet mid = $(this).data('menu_item_id');\r\n\t\tlet pid = $(this).data('parent_item');\r\n\r\n\t\tlet inputItemInfo = sideStationBundleInfo[pid].bundle[mid];\r\n\t\tlet inputGroupID = parseInt(inputItemInfo.bundle_to_menu_item_group_id) || 0;\r\n\r\n\t\tlet this_org = parseInt($(this).data('org_val')) || 0;\r\n\t\tlet this_cur = parseInt($(this).val()) || 0;\r\n\r\n\t\ttotal_org += this_org;\r\n\t\ttotal_current += this_cur;\r\n\r\n\t\tif (typeof groupInfo[inputGroupID] == 'undefined')\r\n\t\t{\r\n\t\t\tgroupInfo[inputGroupID] = {\r\n\t\t\t\ttotal_org: 0,\r\n\t\t\t\ttotal_current: 0\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tgroupInfo[inputGroupID].total_org += this_org;\r\n\t\tgroupInfo[inputGroupID].total_current += this_cur;\r\n\r\n\t});\r\n\r\n\t// check if over the bundle total\r\n\tif (total_current > (parentNumItemsRequired * parseInt($('#qty_' + pid).val())))\r\n\t{\r\n\t\treturn 'Number of items for the bundle has been reached';\r\n\t}\r\n\r\n\t// check if over the group total\r\n\tif (parentItemInfo.bundle_groups.length > 0)\r\n\t{\r\n\t\tif (groupInfo[groupID].total_current > (parseInt(parentItemInfo.bundle_groups[groupID].number_items_required) * parseInt($('#qty_' + pid).val())))\r\n\t\t{\r\n\t\t\treturn 'Number of items for the group has been reached';\r\n\t\t}\r\n\t}\r\n\r\n\t// all else\r\n\treturn true;\r\n\r\n}\r\n\r\n\r\nfunction preferenceChangeListener(pref, setting, user, callback){\r\n\r\n\tpref = pref.toUpperCase();\r\n\tlet pref_value = USER_PREFERENCES[pref].value;\r\n\r\n\tif ($.isPlainObject(pref_value) && $.isPlainObject(setting))\r\n\t{\r\n\t\tsetting = JSON.stringify($.extend(USER_PREFERENCES[pref].value, setting));\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetting = setting.toString()\r\n\t}\r\n\r\n\tif(pref.includes('_DETAILS')){\r\n\t\tlet key = 'MEAL_EXCLUDE_'+pref.replace('MEAL_','').replace('_DETAILS','');\r\n\t\tmeal_customization_preferences[key].details = setting;\r\n\t}else{\r\n\t\tmeal_customization_preferences[pref].value = setting;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_orderCustomization',\r\n\t\t\top: 'update_order_meal_customization',\r\n\t\t\torder_id: order_id,\r\n\t\t\tcustomizations: JSON.stringify(meal_customization_preferences)\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tif(json.cost > 0){\r\n\t\t\t\t\t$('#customization-fee-row').show();\r\n\t\t\t\t\t$('#MealCustomizationFeeRow').show();\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$('#customization-fee-row').hide();\r\n\t\t\t\t\t$('#MealCustomizationFeeRow').hide();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif($('#manual_customization_fee').val() != 'true')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#subtotal_meal_customization_fee').val(formatAsMoney(json.cost));\r\n\t\t\t\t\t$(\"#OEH_subtotal_meal_customization_fee\").html(formatAsMoney(json.cost));\r\n\t\t\t\t}\r\n\t\t\t\thandleMealCustomizationFeeInput();\r\n\r\n\t\t\t\tif(typeof callback !== 'undefined'){\r\n\t\t\t\t\tcallback(json);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\n$(document).on('change', '#shipping_phone_number', function (e) {\r\n\r\n\t$('.shipping_phone_number_new_div').hideFlex();\r\n\t$('#shipping_phone_number_new').prop('required', false);\r\n\r\n\tif ($(this).val() == 'new')\r\n\t{\r\n\t\t$('.shipping_phone_number_new_div').showFlex();\r\n\t\t$('#shipping_phone_number_new').prop('required', true);\r\n\r\n\t}\r\n});\r\n\r\n$(document).on('change', '#hide-zero-sides', function (e) {\r\n\r\n\tif ($(this).is(':checked'))\r\n\t{\r\n\t\t$('#sidesTbl [data-orig-remaining=\"0\"]').hideFlex();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#sidesTbl [data-orig-remaining]').showFlex();\r\n\t}\r\n});\r\n\r\n$(document).on('change keyup', '.delivery-input', function (e) {\r\n\r\n\tdeliveryChanges = false;\r\n\r\n\t$('.delivery-input').each(function () {\r\n\r\n\t\tif ($(this).data('org_value'))\r\n\t\t{\r\n\t\t\tlet val = $(this).val();\r\n\t\t\tlet org_value = $(this).data('org_value');\r\n\r\n\t\t\tif (val != org_value)\r\n\t\t\t{\r\n\t\t\t\tdeliveryChanges = true;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n});\r\n\r\nfunction costInputFeesTab(obj)\r\n{\r\n\t// TODO: validation\r\n\r\n\tsetFeesTabAsDirty();\r\n\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction setFeesTabAsDirty()\r\n{\r\n\tfeesTabIsDirty = true;\r\n}"],"mappings":"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"}