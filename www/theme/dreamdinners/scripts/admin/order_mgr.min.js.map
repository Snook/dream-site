{"version":3,"sourceRoot":"js/src/dreamdinners","sources":["order_mgr.js"],"sourcesContent":["var itemChanges = false;\r\nvar feeChanges = false;\r\nvar discountOrPaymentChanges = false;\r\nvar deliveryChanges = false;\r\nvar discountChanges = false;\r\nvar reportingChanges = false;\r\nvar paymentChanges = false;\r\nvar initialSessionDiscountSetting = \"noSD\";\r\nvar initialPreferredUserDiscountSetting = \"noUP\";\r\nvar changeList = null;\r\nvar isFactoringCredit = false;\r\nvar currentCreditAvailable = 0;\r\nvar stationNeedsAttention = false;\r\nvar relatedOrdersAreLoaded = false;\r\nvar currentlySavingOrder = false;\r\nvar onTimeShotAtSupplyingZeroPaymentHasOccurred = false;\r\nvar needPlatePointsMaxDiscountChangeWarning = false;\r\nvar lastMaxPPDiscountAmount = -1;\r\nlet feesTabIsDirty = false;\r\n\r\nfunction admin_order_mgr_init()\r\n{\r\n\r\n\tif (store_id != STORE_DETAILS.id)\r\n\t{\r\n\t\tSTORE_DETAILS.id = store_id;\r\n\r\n\t\t//STORE_DETAILS.id is either the current fadmin store - in which case a match is guaranteed or\r\n\t\t// is the current Site Admin store (last selection from a store drop down.) However in this case if the order was accessed by the address\r\n\t\t// bar a match is not guaranteed so force STORE_DETAILS.id to store_id which is always the store of the order\r\n\t}\r\n\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetupForNewOrder();\r\n\t}\r\n\telse if (orderState == 'SAVED')\r\n\t{\r\n\t\tsetupForSavedOrder();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetupForActiveOrder();\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tbundleSetup();\r\n\t}\r\n\r\n\tsetupSiteAdminFunctions();\r\n\r\n\tinitChangeList();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tcalculateTotal();\r\n\r\n\t\tsetAllPaymentFieldsToUnrequired();\r\n\r\n\t\tsetupCouponState();\r\n\t}\r\n\r\n\tsetUpKeyHandlers();\r\n\r\n\tif (getQueryVariable(\"session_full\") == \"true\")\r\n\t{\r\n\t\tvar query = window.location.search.substring(1);\r\n\t\tvar vars = query.split(\"&\");\r\n\t\tvar newQueryString = \"main.php?\";\r\n\r\n\t\tvar first = true;\r\n\t\tfor (var i = 0; i < vars.length; i++)\r\n\t\t{\r\n\r\n\t\t\tvar pair = vars[i].split(\"=\");\r\n\t\t\tif (pair[0] != 'session_full')\r\n\t\t\t{\r\n\t\t\t\tif (!first)\r\n\t\t\t\t{\r\n\t\t\t\t\tnewQueryString += \"&\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewQueryString += vars[i];\r\n\t\t\t}\r\n\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thistoryPush({url: newQueryString});\r\n\t}\r\n\r\n\thandle_special_instruction_notes();\r\n\thandle_cancel_order();\r\n\thandle_delete_saved_order();\r\n\r\n\thandle_free_menu_item_edit();\r\n\thandle_fundraiser_selection();\r\n\thandle_ltd_round_up();\r\n\thandleDirectOrderDiscountFocusing();\r\n\r\n\t$('#shipping_phone_number').trigger('change');\r\n\r\n\thandleAutoOrderButtons();\r\n\r\n\t$('#selectedBundle').trigger('change');\r\n\r\n\tinitNoInventoryRows();\r\n\r\n\thandleDinnerDollarAccordion();\r\n\thandleAdminNoteAccordion();\r\n\r\n\tsetMealCustomizationDefault();\r\n\r\n}\r\nfunction setMealCustomizationDefault()\r\n{\r\n\tif( $('#opted_to_customize_recipes').length && default_meal_customization_to_selected == true && $('#opted_to_customize_recipes').prop('checked'))\r\n\t{\r\n\t\t$('#opted_to_customize_recipes').click();\r\n\t}\r\n}\r\n\r\nfunction handleDinnerDollarAccordion()\r\n{\r\n\t$(\".dd_accordion_header\").click(function () {\r\n\r\n\t\t$header = $(this);\r\n\t\t$content = $(\".dd_accordion_content\");\r\n\t\t$header.html(function () {\r\n\t\t\treturn ($content.is(\":visible\") ? \"Show \" : \"Hide \") + \"Recent Dinner Dollar History\" + ($content.is(\":visible\") ? \" &#8744;\" : \" &#8743;\");\r\n\t\t});\r\n\t\t$content.slideToggle(500, function () {\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction handleAdminNoteAccordion()\r\n{\r\n\t$(\".dod_accordion_header\").click(function () {\r\n\r\n\t\t$header = $(this);\r\n\t\t$content = $(\".dod_accordion_content\");\r\n\t\t$header.html(function () {\r\n\t\t\treturn ($content.is(\":visible\") ? \"Show \" : \"Hide \") + \"Admin Order Notes\" + ($content.is(\":visible\") ? \" &#8744;\" : \" &#8743;\");\r\n\t\t});\r\n\t\t$content.slideToggle(500, function () {\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction initNoInventoryRows()\r\n{\r\n\t$('.inventory-row').each(function () {\r\n\t\tlet remaining = $(this).data('orig-remaining');\r\n\t\tlet servings = $(this).data('servings');\r\n\t\tlet entree_id = $(this).data('entree');\r\n\t\tif (remaining < servings)\r\n\t\t{\r\n\r\n\t\t\t$itemCount = $('input[name=\"qty_' + entree_id + '\"]').val();\r\n\t\t\tif ($itemCount == 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).find(\"input,button,textarea,select,a,td\").addClass('text-muted');\r\n\t\t\t\t$(this).find(\"img\").hide();\r\n\t\t\t}\r\n\t\t}\r\n\t})\r\n}\r\n\r\nfunction handleAutoOrderButtons(e, size)\r\n{\r\n\r\n\t$(\"#selectMediumStarterPackEntrees\").on('click', function (e) {\r\n\r\n\t\tvar countMissedMeals = 0;\r\n\r\n\t\t$(\"[id^='bnd_'] input\").each(function () {\r\n\r\n\t\t\tif ($(this).data('pricing_type') == 'HALF')\r\n\t\t\t{\r\n\t\t\t\tvar id = this.id.split(\"_\")[1];\r\n\r\n\t\t\t\t$(\"#qty_\" + id).each(function () {\r\n\r\n\t\t\t\t\tvar entreeID = $(this).data('entreeid');\r\n\r\n\t\t\t\t\tvar curInventory = entreeIDToInventoryMap[entreeID].remaining;\r\n\r\n\t\t\t\t\tif (3 > curInventory)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcountMissedMeals++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(this).val(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n\r\n\t$(\"#selectLargeStarterPackEntrees\").on('click', function (e) {\r\n\t\tvar countMissedMeals = 0;\r\n\r\n\t\t$(\"[id^='bnd_'] input\").each(function () {\r\n\r\n\t\t\tif ($(this).data('pricing_type') == 'FULL')\r\n\t\t\t{\r\n\t\t\t\tvar id = this.id.split(\"_\")[1];\r\n\r\n\t\t\t\t$(\"#qty_\" + id).each(function () {\r\n\r\n\t\t\t\t\tvar entreeID = $(this).data('entreeid');\r\n\r\n\t\t\t\t\tvar curInventory = entreeIDToInventoryMap[entreeID].remaining;\r\n\r\n\t\t\t\t\tif (6 > curInventory)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcountMissedMeals++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$(this).val(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (countMissedMeals > 0)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: '1 or more items could not be selected due to lack of inventory.  Please review the selections and adjust to select a full 12 item order.'\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tcalculateTotal();\r\n\t\tsetItemTabAsDirty();\r\n\r\n\t\te.preventDefault();\r\n\r\n\t});\r\n\r\n}\r\n\r\nvar intenseLoggingOn = true;\r\n\r\nfunction handleDirectOrderDiscountFocusing()\r\n{\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").focus(function (e) {\r\n\r\n\t\tif ($(this).val() == 0)\r\n\t\t{\r\n\t\t\t$(this).val(\"\");\r\n\t\t}\r\n\t\tif ($(this).val().length > 0)\r\n\t\t{\r\n\t\t\t$(this).select();\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").blur(function (e) {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tcurVal = (curVal.trim());\r\n\r\n\t\tif (curVal == \"\" || isNaN(curVal))\r\n\t\t{\r\n\t\t\t$(this).val(\"0\");\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction intenseLogging(message)\r\n{\r\n\tif (window.console && intenseLoggingOn)\r\n\t{\r\n\t\tconsole.log('OM Intense logging: ' + message);\r\n\t}\r\n}\r\n\r\nfunction saveSpecialInstructions()\r\n{\r\n\r\n\tvar special_instructions = strip_tags($(\"#order_user_notes\").val());\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_special_instructions',\r\n\t\t\torder_id: order_id,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tupdateInstructionsOrgValues();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveSpecialInstructions: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"saveSpecialInstructions: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction handle_special_instruction_notes()\r\n{\r\n\t$('[id^=\"gd_special_instruction_note_button-\"]').each(function () {\r\n\r\n\t\t$(this).on('click', function (e) {\r\n\r\n\t\t\tvar booking_id = $(this).data('booking_id');\r\n\t\t\tvar user_id = $(this).data('user_id');\r\n\t\t\tvar do_op = 'get';\r\n\t\t\tvar special_instructions = '';\r\n\r\n\t\t\tif ($(this).data('edit_mode') == true)\r\n\t\t\t{\r\n\t\t\t\tdo_op = 'save';\r\n\r\n\t\t\t\tspecial_instructions = strip_tags($('#gd_special_instruction_note-' + booking_id + ' > textarea').val());\r\n\t\t\t}\r\n\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\t\top: 'update_special_instructions',\r\n\t\t\t\t\t'do': do_op,\r\n\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\tnote: special_instructions\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (do_op == 'get')\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar textarea_elem = $('<textarea></textarea>').addClass('form-control').val((json.special_instruction_note ? json.special_instruction_note : \"\")).on('keyup', function (e) {\r\n\r\n\t\t\t\t\t\t\t\tif ($(this).val() != strip_tags($(this).val()))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(this).val(strip_tags($(this).val()));\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).addClass('special_instruction_note_edit').html(textarea_elem);\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', true).html('Save Note');\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).data('special_instruction_note_value', (json.special_instruction_note ? json.special_instruction_note : \"\")).on('click', function (e) {\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + $(this).data('booking_id')).removeClass('special_instruction_note_edit').html($(this).data('special_instruction_note_value'));\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + $(this).data('booking_id')).data('edit_mode', false).html('Special Instructions');\r\n\r\n\t\t\t\t\t\t\t\t$(this).hide();\r\n\r\n\t\t\t\t\t\t\t}).show();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).removeClass('special_instruction_note_edit').html(nl2br(json.special_instruction_note));\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).hide();\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', false).html('Special Instructions');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t\tintenseLogging(\"handle_special_instruction_notes: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\t\t\tresponse = 'Unexpected error';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nvar lastCheckedGiftCertNumber = null;\r\n\r\nfunction setUpKeyHandlers()\r\n{\r\n\tdocument.onkeypress = OMDefaultKeyHandler;\r\n\r\n\t$(\"#coupon_code\").on('keypress', function (evt) {\r\n\t\t// the enter key will submit a coupon code\r\n\t\tevt = (evt) ? evt : event;\r\n\t\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\t\tif (charCode == 13)\r\n\t\t{\r\n\t\t\tprocessCode();\r\n\t\t\tevt.stopPropagation();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#order_user_notes\").on('keypress', function (evt) {\r\n\t\tevt.stopPropagation();\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#payment1_gc_payment_number\").on('keyup', function (evt) {\r\n\r\n\t\tif ($(this).val().length == 15 && !isNaN($(this).val()) && $(this).val() != lastCheckedGiftCertNumber)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Warning',\r\n\t\t\t\tmessage: \"It appears that you may be entering a gift Card number. If so, select Gift Card from payment selector. This is the Certificate (Gift Certificate) payment type.\"\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tlastCheckedGiftCertNumber = $(this).val();\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n}\r\n\r\nfunction OMDefaultKeyHandler(evt)\r\n{\r\n\t// by default the document just eats the enter key\r\n\r\n\tevt = (evt) ? evt : event;\r\n\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\tif (charCode == 13)\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction initChangeList()\r\n{\r\n\t$(\"#changeListTab\").on('click', function () {\r\n\r\n\t\tlet html = getChangeListHTML();\r\n\r\n\t\tif (!html || html == \"\")\r\n\t\t{\r\n\t\t\thtml = \"<h3><i>No Changes</i></h3>\"\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Change List',\r\n\t\t\tmessage: html,\r\n\t\t\theight: 620,\r\n\t\t\twidth: 300,\r\n\t\t\tmodal: false,\r\n\t\t\tdiv_id: 'changelist',\r\n\t\t\tdialogClass: 'fixedDialog',\r\n\t\t\tnoOk: true,\r\n\t\t\tposition: {\r\n\t\t\t\tmy: \"left top\",\r\n\t\t\t\tat: \"left bottom\",\r\n\t\t\t\tof: this\r\n\t\t\t},\r\n\t\t\tclose: function (event, ui) {\r\n\t\t\t\t$(\"#changelist\").remove();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction setupSiteAdminFunctions()\r\n{\r\n\t$(\"#in-store_status, #plate_points_status\").on('click', function () {\r\n\r\n\t\tvar flagName = this.id;\r\n\t\tvar checkbox = $(this);\r\n\t\tif (orderState != 'ACTIVE')\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"These flags can only be set on ACTIVE orders.\"\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar newState = \"off\";\r\n\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tnewState = \"on\";\r\n\t\t\t}\r\n\r\n\t\t\tvar oldState = 1;\r\n\t\t\tif (newState == \"on\")\r\n\t\t\t{\r\n\t\t\t\toldState = 0;\r\n\t\t\t}\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Status Update',\r\n\t\t\t\tmessage: \"Are you sure you want to update the order status?\",\r\n\t\t\t\tcancel: function () {\r\n\t\t\t\t\tcheckbox.prop('checked', oldState ? true : false)\r\n\r\n\t\t\t\t},\r\n\t\t\t\tconfirm: function () {\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\t\t\ttype: 'POST',\r\n\t\t\t\t\t\ttimeout: 20000,\r\n\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\t\t\top: 'update_status_flag',\r\n\t\t\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\t\t\tflag: flagName,\r\n\t\t\t\t\t\t\tnew_state: newState\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tsuccess: function (json) {\r\n\t\t\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Update Success',\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\t\tintenseLogging(\"update_status_flag: \" + json.processor_message);\r\n\r\n\t\t\t\t\t\t\t\t$(this).attr(\"checked\", oldState);\r\n\r\n\t\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\t\t\t\t\tintenseLogging(\"update_status_flag: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\t\t\t\t$(this).attr(\"checked\", oldState);\r\n\r\n\t\t\t\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\tmessage: response\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction updateMealCustomizationOrgValues()\r\n{\r\n\tdd_toast({\r\n\t\tmessage: 'Meal Customization Fee Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\t$(\"#subtotal_meal_customization_fee\").data('org_value', $(\"#subtotal_meal_customization_fee\").val());\r\n\r\n}\r\nfunction updateItemsOrgValues()\r\n{\r\n\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\t$('#selectedBundle').data('org_value', $('#selectedBundle').is(':checked') ? \"1\" : \"0\");\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t$(this).data('org_value', $(this).val());\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t$(this).data('org_value', $(this).is(':checked') ? \"1\" : \"0\");\r\n\t\t});\r\n\t}\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction saveAll()\r\n{\r\n\tsaveItems(true, false, true);\r\n}\r\n\r\nfunction saveItems(saveDiscountsUponCompletion, activateOnSaveDiscountsCompletion, saveDeliveryAddressUponCompletion)\r\n{\r\n\r\n\tintenseLogging(\"saveItems() called\");\r\n\r\n\tif (currentlySavingOrder)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Items are still being saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tdd_toast({\r\n\t\tmessage: 'Items Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\r\n\tvar itemsList = {};\r\n\tvar introItemsList = {};\r\n\tvar subItemsList = {};\r\n\r\n\tvar is_intro = \"false\";\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// this will pick up any FT items\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($(\"#selectedBundle\").is(\":checked\"))\r\n\t\t{\r\n\r\n\t\t\tis_intro = \"true\";\r\n\r\n\t\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\t\tintroItemsList[item_id] = \"on\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\t$(\"[id^=sbi_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\tsubItemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tvar misc_food_subtotal = $(\"#misc_food_subtotal\").val();\r\n\tif (isNaN(misc_food_subtotal))\r\n\t{\r\n\t\tmisc_food_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_nonfood_subtotal = $(\"#misc_nonfood_subtotal\").val();\r\n\tif (isNaN(misc_nonfood_subtotal))\r\n\t{\r\n\t\tmisc_nonfood_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_service_fee = $(\"#subtotal_service_fee\").val();\r\n\tif (isNaN(subtotal_service_fee))\r\n\t{\r\n\t\tsubtotal_service_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_delivery_fee = $(\"#subtotal_delivery_fee\").val();\r\n\tif (isNaN(subtotal_delivery_fee))\r\n\t{\r\n\t\tsubtotal_delivery_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_food_subtotal_desc = $(\"#misc_food_subtotal_desc\").val();\r\n\tvar misc_nonfood_subtotal_desc = $(\"#misc_nonfood_subtotal_desc\").val();\r\n\tvar service_fee_description = $(\"#service_fee_description\").val();\r\n\r\n\tvar special_instructions = $(\"#order_user_notes\").val();\r\n\r\n\tvar ltdOrderedMealsArray = $(\"#ltdOrderedMealsArray\").val();\r\n\r\n\tvar bagFeeTotal = 0;\r\n\tvar bagFeeCount = 0;\r\n\tif (storeSupportsBagFees)\r\n\t{\r\n\t\tvar bagFeeCount = $(\"#total_bag_count\").val();\r\n\r\n\t\tif (isNaN(bagFeeCount))\r\n\t\t{\r\n\t\t\tbagFeeCount = 0;\r\n\t\t}\r\n\r\n\t\tbagFeeTotal = storeDefaultBagFee * bagFeeCount;\r\n\t}\r\n\r\n\tlet opted_to_bring_bags = $(\"#opted_to_bring_bags\").is(\":checked\");\r\n\r\n\tlet manual_customization_fee = $(\"#manual_customization_fee\").val();\r\n\tlet opted_to_customize = ($(\"#opted_to_customize_recipes\").length > 0 && !$(\"#opted_to_customize_recipes\").is(\":checked\"));\r\n\tlet mealCustomizationFee = $(\"#subtotal_meal_customization_fee\").val();\r\n\r\n\tcurrentlySavingOrder = true;\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_items',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: itemsList,\r\n\t\t\tmisc_food_subtotal: misc_food_subtotal,\r\n\t\t\tmisc_nonfood_subtotal: misc_nonfood_subtotal,\r\n\t\t\tsubtotal_service_fee: subtotal_service_fee,\r\n\t\t\tmisc_food_subtotal_desc: misc_food_subtotal_desc,\r\n\t\t\tmisc_nonfood_subtotal_desc: misc_nonfood_subtotal_desc,\r\n\t\t\tservice_fee_description: service_fee_description,\r\n\t\t\tsubtotal_delivery_fee: subtotal_delivery_fee,\r\n\t\t\tmanual_customization_fee: manual_customization_fee,\r\n\t\t\topted_to_customize: opted_to_customize,\r\n\t\t\tmeal_customization_fee: mealCustomizationFee,\r\n\t\t\tis_intro: is_intro,\r\n\t\t\tintro_items: introItemsList,\r\n\t\t\tsub_items: subItemsList,\r\n\t\t\tltdOrderedMealsArray: ltdOrderedMealsArray,\r\n\t\t\tspecial_instructions: special_instructions,\r\n\t\t\tstoreSupportsBagFees: storeSupportsBagFees,\r\n\t\t\tbagFeeTotal: bagFeeTotal,\r\n\t\t\tbagFeeCount: bagFeeCount,\r\n\t\t\topted_to_bring_bags: opted_to_bring_bags\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tfeesTabIsDirty = false;\r\n\t\t\t\tif(opted_to_customize){\r\n\t\t\t\t\tupdateMealCustomizationOrgValues();\r\n\t\t\t\t}\r\n\t\t\t\tupdateItemsOrgValues();\r\n\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"saveItems() successful\");\r\n\r\n\t\t\t\tif (saveDiscountsUponCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDiscounts(activateOnSaveDiscountsCompletion, saveDeliveryAddressUponCompletion);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"update_items: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tcurrentlySavingOrder = false;\r\n\t\t\tintenseLogging(\"update_items: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction setSessionAndSave(session_id)\r\n{\r\n\r\n\tintenseLogging(\"setSessionAndSave() called\");\r\n\r\n\tdisplayModalWaitDialog('saving_div', \"Setting session. Please wait ...\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'set_session_and_save',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val()\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"setSessionAndSave() successful\");\r\n\r\n\t\t\t\tif (json.full_session_warning_required)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr&order=\" + json.order_id + \"&session_full=true\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"#saving_div\").remove();\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tintenseLogging(\"set_session_and_save: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t$(\"#saving_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"set_session_and_save: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction Reschedule(org_session_id, transition_type, suppressEmail)\r\n{\r\n\r\n\tintenseLogging(\"Reschedule() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'reschedule',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tsaved_booking_id: saved_booking_id,\r\n\t\t\torg_session_id: org_session_id,\r\n\t\t\torder_state: orderState,\r\n\t\t\ttransition_type: transition_type,\r\n\t\t\tsuppressEmail: suppressEmail\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"Reschedule() successful\");\r\n\r\n\t\t\t\tsession_id = json.new_session_id;\r\n\t\t\t\t$(\"#curSessionDate\").html(json.new_session_time);\r\n\r\n\t\t\t\t$(\"#session\").val(json.new_session_id);\r\n\r\n\t\t\t\tRetrieveCalendar(0);\r\n\r\n\t\t\t\tif (!json.canDelayPayment)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\".delayedPaymentSection\").hideFlex();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\".delayedPaymentSection\").showFlex();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (json.session_discount)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#noSessionDiscountRow\").hide();\r\n\t\t\t\t\t$(\"#newSessionDiscountBody\").show();\r\n\t\t\t\t\t$(\"#sessionDiscountTypeSpan\").html(json.session_discount.type);\r\n\t\t\t\t\t$(\"#sessionDiscountValueSpan\").html(json.session_discount.value);\r\n\t\t\t\t\tactiveSessionDiscount.id = json.session_discount.id;\r\n\t\t\t\t\tactiveSessionDiscount.type = json.session_discount.type;\r\n\t\t\t\t\tactiveSessionDiscount.value = json.session_discount.value;\r\n\t\t\t\t\tcalculateTotal();\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#noSessionDiscountRow\").show();\r\n\t\t\t\t\t$(\"#newSessionDiscountBody\").hide();\r\n\t\t\t\t\tactiveSessionDiscount.id = 0;\r\n\t\t\t\t\tactiveSessionDiscount.type = 'none';\r\n\t\t\t\t\tactiveSessionDiscount.value = 0;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(\"#curSessionTypeSpan\").html(json.session_info.session_type_title);\r\n\t\t\t\t$(\"#curSessionRemainingSlotsSpan\").html(json.session_info.remaining_slots);\r\n\t\t\t\t$(\"#curSessionRemainingIntroSlotsSpan\").html(json.session_info.remaining_intro_slots);\r\n\r\n\t\t\t\tif (json.client_ops.hasOwnProperty('require_delivery_address') && !$(\"#shipping_address_line1\").length)\r\n\t\t\t\t{\r\n\t\t\t\t\t// rather than load a new tab for now just reload the page\r\n\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor (var key in json.client_ops)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (json.client_ops.hasOwnProperty(key))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tswitch (key)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tcase 'adj_service_fee':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"#subtotal_service_fee\").val(json.client_ops[key]);\r\n\t\t\t\t\t\t\t\t$(\"#OEH_subtotal_service_fee_org\").html(formatAsMoney(json.client_ops[key]));\r\n\t\t\t\t\t\t\t\tid = \"OEH_subtotal_service_fee_org\"\r\n\t\t\t\t\t\t\t\tcalculateTotal();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'update_svc_fee_desc':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"#service_fee_description\").val(json.client_ops[key]);\r\n\t\t\t\t\t\t\t\tcalculateTotal();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'adj_delivery_fee':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tif (!$(\"#subtotal_delivery_fee\").length)\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t// The current DOM has no delivery fee field so for now causea refresh\r\n\t\t\t\t\t\t\t\t\tbounce(window.location.href);\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t$(\"#subtotal_delivery_fee\").val(json.client_ops[key]);\r\n\t\t\t\t\t\t\t\t$(\"#OEH_subtotal_delivery_fee_org\").html(formatAsMoney(json.client_ops[key]));\r\n\t\t\t\t\t\t\t\tcalculateTotal();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'require_delivery_address':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"[id^='shipping_']\").each(function () {\r\n\t\t\t\t\t\t\t\t\t$(this).attr('required', 'required');\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'delete_delivery_address':\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t$(\"#delivery_tab_li\").remove();\r\n\t\t\t\t\t\t\t\t$(\"#delivery\").remove();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"reschedule: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"reschedule: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction onSetSessionAndSave(obj)\r\n{\r\n\tintenseLogging(\"onSetSessionAndSave() called\");\r\n\r\n\tvar session_id = $(\"#selected_session\").attr(\"data-session_id\");\r\n\tsetSessionAndSave(session_id);\r\n\treturn false;\r\n}\r\n\r\nfunction onSaveItems()\r\n{\r\n\tintenseLogging(\"onSaveItems() called\");\r\n\r\n\tsaveItems(false, false, false);\r\n\treturn false;\r\n\r\n}\r\n\r\nfunction setupForNewOrder()\r\n{\r\n\tHideLineItemsIfZero();\r\n\tvar timestamp = getQueryVariable('month');\r\n\tif (!timestamp)\r\n\t{\r\n\t\ttimestamp = \"0\";\r\n\t}\r\n\tRetrieveCalendar(timestamp);\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\r\n}\r\n\r\nfunction setupForSavedOrder()\r\n{\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n}\r\n\r\nfunction setupForActiveOrder()\r\n{\r\n\tif (discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").click();\r\n\r\n\t\t$(\"#items_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#fees_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#sessions_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#discountsDiv\").find(\":input\").prop(\"disabled\", true);\r\n\t\t$(\"#discountsDiv\").find(\"*\").addClass(\"om_disabled\");\r\n\r\n\t}\r\n\r\n\t$(\"#addPaymentAndActivate\").hide();\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n}\r\n\r\nfunction isDeliveryAddressComplete()\r\n{\r\n\tvar validated = true;\r\n\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\r\n\t\tif (!$(this).val() && $(this).attr('required'))\r\n\t\t{\r\n\t\t\tvalidated = false;\r\n\t\t}\r\n\t});\r\n\treturn validated;\r\n}\r\n\r\nfunction saveDeliveryAddress(payOnCompletion, token)\r\n{\r\n\r\n\tvar shipping_data = {};\r\n\t$(\"[id^='shipping_']\").each(function () {\r\n\t\tshipping_data[this.id] = $(this).val();\r\n\t});\r\n\r\n\tintenseLogging(\"saveDeliveryAddress() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 200000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'save_delivery_address',\r\n\t\t\torder_id: order_id,\r\n\t\t\tshipping_data: shipping_data\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDeliveryAddress() successful\");\r\n\r\n\t\t\t\tdd_toast({\r\n\t\t\t\t\tmessage: 'Delivery Address Saved',\r\n\t\t\t\t\tposition: 'topcenter'\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, token);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"save_delivery_address: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"save_delivery_address: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDeliveryTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onDeliveryTabDeselected()\r\n{\r\n\tif (!isDeliveryAddressComplete())\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please check the Delivery Address and phone number fields for completeness.'\r\n\t\t});\r\n\r\n\t\treturn false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsaveDeliveryAddress(false, false);\r\n\t\treturn true;\r\n\t}\r\n\r\n}\r\n\r\nfunction onSessionTabSelected()\r\n{\r\n\tRetrieveCalendar(0);\r\n}\r\n\r\nfunction onSessionTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onItemsTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onItemsTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\tif (itemTabIsDirty)\r\n\t\t{\r\n\t\t\t/*\r\n\t\t\t dd_message({\r\n\t\t\t title: 'Attention',\r\n\t\t\t message: 'You have unsaved changes. Do you wish to save changes to the items tab?',\r\n\t\t\t confirm: function() {\r\n\t\t\t }\r\n\t\t\t });\r\n\t\t\t */\r\n\r\n\t\t\tsaveItems(false, false, false);\r\n\t\t}\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onFeesTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onFeesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentTabSelected()\r\n{\r\n\thandle_admin_order_notes();\r\n\thandle_free_menu_item_edit();\r\n}\r\n\r\nfunction onPaymentTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE' && (discountChanges || reportingChanges))\r\n\t{\r\n\t\tsaveDiscounts(false, false);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onRelatedOrdersTabSelected()\r\n{\r\n\tif (!relatedOrdersAreLoaded)\r\n\t{\r\n\r\n\t\tintenseLogging(\"Loading related Orders\");\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'retrieve_related_orders',\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\r\n\t\t\t\tintenseLogging(\"Loading related Orders successful\");\r\n\r\n\t\t\t\t$(\"#related_orders\").html(json.data);\r\n\t\t\t\t$(\"#loading_related_orders\").remove();\r\n\t\t\t\trelatedOrdersAreLoaded = true;\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#loading_related_orders\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"retrieve_related_orders: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nfunction onRelatedOrdersTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onNotesTabSelected()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_history',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$(\"#history_div\").html(json.html);\r\n\r\n\t\t\thandle_guest_account_notes();\r\n\r\n\t\t\thandle_admin_carryover_notes();\r\n\r\n\t\t\thandle_admin_order_notes();\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"get_history: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onNotesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentSelected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n}\r\n\r\nfunction onPaymentDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\t\tupdateChangeList();\r\n\t\tpaymentChanges = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = false;\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction onSiteAdminTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onSiteAdminTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction updateDiscountOrgValues()\r\n{\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\t$(\"#org_coupon_id\").val($(\"#coupon_id\").val());\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction updateActiveOrder(payOnCompletion, go_to_confirm)\r\n{\r\n\tintenseLogging(\"updateActiveOrder() called\");\r\n\r\n\tvar itemsList = {};\r\n\tvar introItemsList = {};\r\n\tvar subItemsList = {};\r\n\r\n\tvar is_intro = \"false\";\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t//pick up any sides\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($(\"#selectedBundle\").is(\":checked\"))\r\n\t\t{\r\n\r\n\t\t\tis_intro = \"true\";\r\n\r\n\t\t\t$(\"[id^=bnd_]\").each(function () {\r\n\r\n\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\t\tintroItemsList[item_id] = \"on\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t\t$(\"[id^=qty_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id^=sbi_]\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\tsubItemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tvar misc_food_subtotal = $(\"#misc_food_subtotal\").val();\r\n\tif (isNaN(misc_food_subtotal))\r\n\t{\r\n\t\tmisc_food_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_nonfood_subtotal = $(\"#misc_nonfood_subtotal\").val();\r\n\tif (isNaN(misc_nonfood_subtotal))\r\n\t{\r\n\t\tmisc_nonfood_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_service_fee = $(\"#subtotal_service_fee\").val();\r\n\tif (isNaN(subtotal_service_fee))\r\n\t{\r\n\t\tsubtotal_service_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_delivery_fee = $(\"#subtotal_delivery_fee\").val();\r\n\tif (isNaN(subtotal_delivery_fee))\r\n\t{\r\n\t\tsubtotal_delivery_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_food_subtotal_desc = $(\"#misc_food_subtotal_desc\").val();\r\n\tvar misc_nonfood_subtotal_desc = $(\"#misc_nonfood_subtotal_desc\").val();\r\n\tvar service_fee_description = $(\"#service_fee_description\").val();\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar PUDSetting = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\tif (PUDSetting == null || PUDSetting == \"\")\r\n\t{\r\n\t\tPUDSetting = \"noUP\";\r\n\t}\r\n\r\n\tvar plate_points_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(plate_points_discount))\r\n\t{\r\n\t\tplate_points_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar SessDiscSetting = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\tif (SessDiscSetting == null || SessDiscSetting == \"\")\r\n\t{\r\n\t\tSessDiscSetting = \"noSD\";\r\n\t}\r\n\r\n\tvar DR_level = 0;\r\n\tif ($(\"#dr_level_for_order\").length)\r\n\t{\r\n\t\tvar curOrderLevel = $(\"#dr_level_for_order\").val();\r\n\t\tif (curOrderLevel > 0)\r\n\t\t{\r\n\t\t\tDR_level = curOrderLevel;\r\n\t\t}\r\n\t}\r\n\r\n\tvar ltdOrderedMealsArray = $(\"#ltdOrderedMealsArray\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_active_order',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: itemsList,\r\n\t\t\tmisc_food_subtotal: misc_food_subtotal,\r\n\t\t\tmisc_nonfood_subtotal: misc_nonfood_subtotal,\r\n\t\t\tsubtotal_service_fee: subtotal_service_fee,\r\n\t\t\tsubtotal_delivery_fee: subtotal_delivery_fee,\r\n\t\t\tmisc_food_subtotal_desc: misc_food_subtotal_desc,\r\n\t\t\tmisc_nonfood_subtotal_desc: misc_nonfood_subtotal_desc,\r\n\t\t\tservice_fee_description: service_fee_description,\r\n\t\t\tis_intro: is_intro,\r\n\t\t\tintro_items: introItemsList,\r\n\t\t\tsub_items: subItemsList,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tPUDSetting: PUDSetting,\r\n\t\t\tplate_points_discount: plate_points_discount,\r\n\t\t\tSessDiscSetting: SessDiscSetting,\r\n\t\t\tdream_rewards_level: DR_level,\r\n\t\t\tchangeList: JSON.stringify(changeList),\r\n\t\t\tchangeListStr: getChangeListHTML(),\r\n\t\t\tltdOrderedMealsArray: ltdOrderedMealsArray,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val()\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"updateActiveOrder() successful\");\r\n\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tupdateItemsOrgValues();\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(payOnCompletion, go_to_confirm, json.getTokenToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_active_order: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"update_active_order: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction _validate_discounts()\r\n{\r\n\t// check to see if coupon requires free menu selection\r\n\tif (couponFreeMenuItemRequired)\r\n\t{\r\n\t\treturn _check_elements([$('#free_menu_item_coupon').get(0)]);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction saveDiscounts(payOnCompletion, saveDeliveryAddressUponCompletion)\r\n{\r\n\tintenseLogging(\"saveDiscounts() called\");\r\n\r\n\tif (!_validate_discounts())\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (!payOnCompletion)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Discounts Saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t}\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar PUDSetting = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\tif (PUDSetting == null || PUDSetting == \"\")\r\n\t{\r\n\t\tPUDSetting = \"noUP\";\r\n\t}\r\n\r\n\tvar plate_points_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(plate_points_discount))\r\n\t{\r\n\t\tplate_points_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar SessDiscSetting = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\tif (SessDiscSetting == null || SessDiscSetting == \"\")\r\n\t{\r\n\t\tSessDiscSetting = \"noSD\";\r\n\t}\r\n\r\n\tvar DR_level = 0;\r\n\tif ($(\"#dr_level_for_order\").length)\r\n\t{\r\n\t\tvar curOrderLevel = $(\"#dr_level_for_order\").val();\r\n\t\tif (curOrderLevel > 0)\r\n\t\t{\r\n\t\t\tDR_level = curOrderLevel;\r\n\t\t}\r\n\t}\r\n\r\n\tvar coupon_id = 0;\r\n\tvar coupon_free_menu_item = 0;\r\n\tif ($(\"#coupon_id\").val())\r\n\t{\r\n\t\tif (couponFreeMenuItemRequired)\r\n\t\t{\r\n\t\t\tif ($('#free_menu_item_coupon').val())\r\n\t\t\t{\r\n\t\t\t\tcoupon_free_menu_item = $('#free_menu_item_coupon').val();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tcoupon_id = $(\"#coupon_id\").val();\r\n\t}\r\n\r\n\tvar fundraiser_id = $('#fundraiser_id').val();\r\n\tvar fundraiser_value = $('#fundraiser_value').val();\r\n\tvar add_ltd_round_up = ($('#add_ltd_round_up').is(':checked') ? true : false);\r\n\tvar ltd_round_up_select = $('#ltd_round_up_select').val();\r\n\r\n\tvar bagFeeTotal = 0;\r\n\tvar bagFeeCount = 0;\r\n\tif (storeSupportsBagFees)\r\n\t{\r\n\t\tvar bagFeeCount = $(\"#total_bag_count\").val();\r\n\r\n\t\tif (isNaN(bagFeeCount))\r\n\t\t{\r\n\t\t\tbagFeeCount = 0;\r\n\t\t}\r\n\r\n\t\tbagFeeTotal = storeDefaultBagFee * bagFeeCount;\r\n\t}\r\n\r\n\tlet opted_to_bring_bags = $(\"#opted_to_bring_bags\").is(\":checked\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'update_discounts',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tPUDSetting: PUDSetting,\r\n\t\t\tplate_points_discount: plate_points_discount,\r\n\t\t\tSessDiscSetting: SessDiscSetting,\r\n\t\t\tcoupon_id: coupon_id,\r\n\t\t\tcoupon_free_menu_item: coupon_free_menu_item,\r\n\t\t\tdream_rewards_level: DR_level,\r\n\t\t\tfundraiser_id: fundraiser_id,\r\n\t\t\tfundraiser_value: fundraiser_value,\r\n\t\t\tadd_ltd_round_up: add_ltd_round_up,\r\n\t\t\tltd_round_up_select: ltd_round_up_select,\r\n\t\t\tstoreSupportsBagFees: storeSupportsBagFees,\r\n\t\t\tbagFeeTotal: bagFeeTotal,\r\n\t\t\tbagFeeCount: bagFeeCount,\r\n\t\t\topted_to_bring_bags: opted_to_bring_bags\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDiscounts() successful\");\r\n\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\t\t\t\tupdateReportingOrgValues();\r\n\r\n\t\t\t\tif (coupon_free_menu_item)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#free_menu_item_coupon').attr('disabled', true);\r\n\t\t\t\t\tcouponFreeMenuItem = coupon_free_menu_item;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (saveDeliveryAddressUponCompletion && $(\"#shipping_firstname\")[0])\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDeliveryAddress(payOnCompletion, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t\telse if (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_discounts: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\r\n\t\t\tintenseLogging(\"update_discounts: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction updateReportingOrgValues()\r\n{\r\n\t$('#fundraiser_id').data('org_value', $('#fundraiser_id').val());\r\n\t$('#fundraiser_value').data('org_value', $('#fundraiser_value').val());\r\n\t$('#ltd_round_up_select').data('org_value', $('#ltd_round_up_select').val());\r\n\t$('#OEH_ltd_round_up_org').data('org_value', $('#ltd_round_up_select').val());\r\n\r\n\tif ($('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\t$('#add_ltd_round_up').data('org_value', true);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#add_ltd_round_up').data('org_value', false);\r\n\t}\r\n\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction send(token, paymentNumber, warnOfOutstandingSavedOrdersOnFullSession, addOnly, go_to_confirm, payment1Data)\r\n{\r\n\r\n\tintenseLogging(\"send() called for payment# \" + paymentNumber);\r\n\r\n\t$('#paypal-result').on(\"load\", function () {\r\n\r\n\t\tintenseLogging(\"result iFrame loading\");\r\n\r\n\t\ttry\r\n\t\t{\r\n\t\t\tvar next_dest = $('#paypal-result').get(0).contentWindow.next_dest;\r\n\t\t\tvar success = $('#paypal-result').get(0).contentWindow.pp_success;\r\n\r\n\t\t}\r\n\t\tcatch (e)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"exception occurred accessing result iframe\");\r\n\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Exception',\r\n\t\t\t\tmessage: 'We are sorry but an unexpected error occurred during payment processing. Please try again or contact support.'\r\n\t\t\t});\r\n\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// in Safari - exception is not thrown and success is undefined\r\n\t\t// the test is false and we drop into the success = false block\r\n\t\t// then error_code and message also are set to undefined\r\n\r\n\t\tif (success)\r\n\t\t{\r\n\t\t\tintenseLogging(\"success found in iframe\");\r\n\r\n\t\t\tbounce(next_dest);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar error_code = $('#paypal-result').get(0).contentWindow.error_code;\r\n\t\t\tvar message = $('#paypal-result').get(0).contentWindow.message;\r\n\r\n\t\t\tintenseLogging(\"error found in iframe: #\" + error_code + \" | \" + message);\r\n\r\n\t\t\tif (typeof error_code == 'undefined')\r\n\t\t\t{\r\n\t\t\t\terror_code = \"Generic\";\r\n\t\t\t\tmessage = 'Some required information is missing or incorrect. Please correct the fields below and try again.';\r\n\r\n\t\t\t\tintenseLogging(\"error code undefined in iframe\");\r\n\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\tmessage: message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t\telse if (next_dest && next_dest.length > 0)\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"Okay\": function () {\r\n\t\t\t\t\t\t\tbounce(next_dest);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tvar reload = $('#paypal-result').get(0).contentWindow.reloadOnFailure;\r\n\r\n\t\t\t\tif (reload)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"reloadOnFailure found in iframe: reloading\");\r\n\r\n\t\t\t\t\tmessage += \"<br /><br /><span style='color:red'>The credit card payment failed however the order was booked with the gift certificate. The page will now reload.</span>\";\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\t\tmessage: message,\r\n\t\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\"Okay\": function () {\r\n\t\t\t\t\t\t\t\tbounce(window.location.href);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\t\tmessage: message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t});\r\n\r\n\tvar comment_payload = new PayFlow_Payload();\r\n\r\n\tcomment_payload.addNameValuePair('UserID', user_id);\r\n\tcomment_payload.addNameValuePair('StoreID', STORE_DETAILS.id);\r\n\tcomment_payload.addNameValuePair('OrderID', order_id); // TODO: need id here of somekind so the payment can be tracked to an order. Either we create a \"blank\" order\r\n\t// or we use another id that is tied to the order when it is later inserted.\r\n\tcomment_payload.addNameValuePair('Email', user_email);\r\n\r\n\tif (paymentNumber == 1)\r\n\t{\r\n\t\tvar expdate = $(\"#payment1_ccMonth\").val();\r\n\t\texpdate += $(\"#payment1_ccYear\").val();\r\n\t\tvar csc = $(\"#payment1_cc_security_code\").val();\r\n\t\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t\tvar payload = new PayFlow_Payload();\r\n\r\n\t\tpayload.addNameValuePair('admin_user_id', USER_DETAILS.id);\r\n\t\tpayload.addNameValuePair('user_id', user_id);\r\n\t\tpayload.addNameValuePair('store_id', STORE_DETAILS.id);\r\n\t\tpayload.addNameValuePair('order_id', order_id);\r\n\t\tpayload.addNameValuePair('caller_id', 'fadmin_order');\r\n\t\tif (addOnly)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('add_only', 'true');\r\n\t\t}\r\n\t\tif (go_to_confirm)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('go_to_confirm', 'true');\r\n\t\t}\r\n\t\tpayload.addNameValuePair('is_second_payment', 'false');\r\n\r\n\t\tvar use_store_credits = false;\r\n\t\tvar store_credit_amount = 0;\r\n\t\tif ($(\"#use_store_credits\").length)\r\n\t\t{\r\n\t\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\t\tpayload.addNameValuePair('use_sc', 'true');\r\n\t\t\t\tpayload.addNameValuePair('sc_amt', store_credit_amount);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\tpayload.addNameValuePair('DP_State', DP_State);\r\n\t\t\t\tpayload.addNameValuePair('org_amount', amt);\r\n\r\n\t\t\t\tvar depositAmount = 20;\r\n\t\t\t\tif (DP_State == 1 && store_specific_deposit && store_specific_deposit > 20)\r\n\t\t\t\t{\r\n\t\t\t\t\tdepositAmount = store_specific_deposit;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (amt * 1 <= depositAmount * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Delayed Payment Error',\r\n\t\t\t\t\t\tmessage: \"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tamt = depositAmount;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof payflowErrorURL == 'undefined')\r\n\t\t{\r\n\t\t\tpayflowErrorURL = \"https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback\";\r\n\t\t}\r\n\r\n\t\t// make PARMLIST\r\n\t\tvar parmList = 'ERRORURL=' + payflowErrorURL + \"&ACCT=\" + $(\"#payment1_ccNumber\").val() + \"&EXPDATE=\" + expdate + \"&CSC=\" + csc + \"&AMT=\" + amt + \"&USER1=\" + payload.retrieveEncodedString() + \"&COMMENT1=\" + comment_payload.retrieveEncodedString();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar expdate = $(\"#payment2_ccMonth\").val();\r\n\t\texpdate += $(\"#payment2_ccYear\").val();\r\n\t\tvar csc = $(\"#payment2_cc_security_code\").val();\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\tvar payload = new PayFlow_Payload();\r\n\r\n\t\tpayload.addNameValuePair('user_id', user_id);\r\n\t\tpayload.addNameValuePair('store_id', STORE_DETAILS.id);\r\n\t\tpayload.addNameValuePair('order_id', order_id);\r\n\t\tpayload.addNameValuePair('caller_id', 'fadmin_order');\r\n\t\tpayload.addNameValuePair('add_only', 'false');\r\n\t\tpayload.addNameValuePair('is_second_payment', 'true');\r\n\t\tif (go_to_confirm)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('go_to_confirm', 'true');\r\n\t\t}\r\n\r\n\t\tif (payment1Data)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair(\"hasPayment1\", true);\r\n\r\n\t\t\tfor (var key in payment1Data)\r\n\t\t\t{\r\n\t\t\t\tif (payment1Data.hasOwnProperty(key))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayload.addNameValuePair(\"p1_\" + key, payment1Data[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#payment2_is_store_specific_flat_rate_deposit_delayed_payment1').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\tpayload.addNameValuePair('DP_State', DP_State);\r\n\t\t\t\tpayload.addNameValuePair('org_amount', amt);\r\n\r\n\t\t\t\tvar depositAmount = 20;\r\n\t\t\t\tif (DP_State == 1 && store_specific_deposit && store_specific_deposit > 20)\r\n\t\t\t\t{\r\n\t\t\t\t\tdepositAmount = store_specific_deposit;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (amt * 1 <= depositAmount * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Delayed Payment Error',\r\n\t\t\t\t\t\tmessage: \"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tamt = depositAmount;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof payflowErrorURL == 'undefined')\r\n\t\t{\r\n\t\t\tpayflowErrorURL = \"https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback\";\r\n\t\t}\r\n\r\n\t\t// make PARMLIST\r\n\t\tvar parmList = 'ERRORURL=' + payflowErrorURL + \"&ACCT=\" + $(\"#payment2_ccNumber\").val() + \"&EXPDATE=\" + expdate + \"&CSC=\" + csc + \"&AMT=\" + amt + \"&USER1=\" + payload.retrieveEncodedString() + \"&COMMENT1=\" + comment_payload.retrieveEncodedString();\r\n\t}\r\n\r\n\tvar tr_action = 'https://payflowlink.paypal.com';\r\n\tif (typeof pfp_test_mode != 'undefined' && pfp_test_mode)\r\n\t{\r\n\t\tvar tr_action = 'https://pilot-payflowlink.paypal.com';\r\n\t}\r\n\r\n\tif (typeof transparent_redirect_link != 'undefined')\r\n\t{\r\n\t\ttr_action = transparent_redirect_link;\r\n\t}\r\n\r\n\tintenseLogging(\"posting to PayFlow\");\r\n\r\n\t// Create dynamic form to post and redirect to session_menu\r\n\tcreate_and_submit_form({\r\n\t\taction: tr_action,\r\n\t\ttarget: \"paypal-result\",\r\n\t\tinput: ({\r\n\t\t\tSECURETOKEN: token.token,\r\n\t\t\tSECURETOKENID: token.tokenID,\r\n\t\t\tPARMLIST: parmList\r\n\t\t})\r\n\t});\r\n\r\n}\r\n\r\nfunction getPaymentData(type, payment_number)\r\n{\r\n\r\n\tif (type != 'CC')\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val()\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val(),\r\n\t\t\tccNameOnCard: \"\",\r\n\t\t\tccType: 'CC',\r\n\t\t\tccMonth: \"\",\r\n\t\t\tccYear: \"\",\r\n\t\t\tcc_security_code: \"\",\r\n\t\t\tbilling_address: \"\",\r\n\t\t\tbilling_city: \"\",\r\n\t\t\tbilling_state_id: \"\",\r\n\t\t\tbilling_postal_code: \"\",\r\n\t\t\tis_store_specific_flat_rate_deposit_delayed_payment: 0,\r\n\t\t\tdo_not_ref: 0\r\n\t\t}\r\n\t}\r\n\r\n\tif (payment_number == 1)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"REFERENCE\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_reference_total_amount\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CERT\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_gc_total_amount\").val();\r\n\t\t\t\tpaymentData.cert_type = $(\"#payment1_gift_cert_type\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_gc_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFUND_CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_refund_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_refund_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CREDIT\":\r\n\t\t\t\tpaymentData.amount = $(\"#OEH_remaing_balance\").html();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment1_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment1_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment1_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment1_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment1_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_1\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_1\").val();\r\n\t\t\t\tpaymentData.billing_city = $(\"#billing_city_1\").val();\r\n\t\t\t\tpaymentData.billing_state_id = $(\"#billing_state_id_1\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_1').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CARD\":\r\n\t\t\t\tpaymentData.amount = $(\"#debit_gift_card_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#debit_gift_card_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"DPADJUST\":\r\n\t\t\t\t// TODO: ???\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p1_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\r\n\t}\r\n\telse if (payment_number == 2)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment2_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment2_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment2_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment2_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment2_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_2\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\t\t\tif ($('#save_cc_as_ref_2').is(':checked'))\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.save_card = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p2_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\t}\r\n\r\n}\r\n\r\nfunction validatePayment1(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\t\tcase \"REFERENCE\":\r\n\t\t\tinputArray = $(\"#payment1_reference :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CERT\":\r\n\t\t\tinputArray = $(\"#payment1_gc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment1_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFUND_CASH\":\r\n\t\t\tinputArray = $(\"#payment1_refund_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment1_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CREDIT\":\r\n\t\t\tinputArray = $(\"#payment1_credit :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment1_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CARD\":\r\n\t\t\tinputArray = $(\"#payment1_debit_gift_card :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"DPADJUST\":\r\n\t\t\tinputArray = $(\"#dp_adjust_div :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment1_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n\r\n}\r\n\r\nfunction validatePayment2(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment2_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment2_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n}\r\n\r\nfunction addPaymentAndActivate()\r\n{\r\n\tlet minimumVal = null;\r\n\tlet minimumType = null;\r\n\r\n\tif (typeof order_minimum !== 'undefined' && typeof order_minimum.minimum !== 'undefined')\r\n\t{\r\n\t\tminimumVal = order_minimum.minimum;\r\n\t\tminimumType = order_minimum.minimum_type\r\n\t}\r\n\r\n\tintenseLogging(\"addPaymentAndActivate() called\");\r\n\tlet servingsCount = 0;\r\n\tlet enforce36ServingMinimum = false;\r\n\tlet underFilledMessage = 'This order is for less than 36 servings. Do you wish to continue?';\r\n\r\n\tif (minimumVal != null)\r\n\t{\r\n\t\tunderFilledMessage = 'This order is for less than ' + minimumVal + ' ' + minimumType.toLowerCase() + 's. Do you wish to continue?';\r\n\t}\r\n\r\n\tservingsCount = Number($('#OEH_number_servings').html());\r\n\tlet itemCount = Number($('#OEH_number_core_servings').html());\r\n\r\n\tif (orderIsEligibleForMembershipDiscount && storeSupportsMembership)\r\n\t{\r\n\t\tif (membership_status.eligible_menus[menu_id].number_qualifying_orders == 0)\r\n\t\t{\r\n\t\t\tunderFilledMessage = 'This Meal Prep+ order has less than 36 core servings. Because this guest does not have a consecutive standard order for this menu month, this order is required to have at least 36 servings before a smaller order can be added.';\r\n\t\t\tenforce36ServingMinimum = true;\r\n\t\t}\r\n\t}\r\n\r\n\tlet quantityOrdered = servingsCount.valueOf();\r\n\tlet requiredMinimum = 36;\r\n\tif (minimumVal != null)\r\n\t{\r\n\t\trequiredMinimum = minimumVal;\r\n\t\tif (minimumType === 'ITEM')\r\n\t\t{\r\n\t\t\tquantityOrdered = itemCount.valueOf();\r\n\t\t}\r\n\t}\r\n\r\n\tif (quantityOrdered < requiredMinimum && enforce36ServingMinimum)\r\n\t{\r\n\t\tintenseLogging(\"addPaymentAndActivate() - warning for less than \" + requiredMinimum + '' + minimumType);\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Warning',\r\n\t\t\tmessage: underFilledMessage\r\n\t\t});\r\n\r\n\t\treturn false;\r\n\r\n\t}\r\n\telse if (quantityOrdered < requiredMinimum && !isDreamTaste && !isFundraiser && !$(\"#selectedBundle\").is(\":checked\"))\r\n\t{\r\n\r\n\t\tintenseLogging(\"addPaymentAndActivate() - warning for less than \" + requiredMinimum + '' + minimumType);\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Warning',\r\n\t\t\tmessage: underFilledMessage,\r\n\t\t\tconfirm: function () {\r\n\t\t\t\t// always first ensure that discounts are updated on server\r\n\t\t\t\tintenseLogging(\"addPaymentAndActivate() - confirm dialog\");\r\n\r\n\t\t\t\tlet message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\t\t\t\tlet changesBlurb = getAbbreviatedSummaryString();\r\n\t\t\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Add Payment and Book Order',\r\n\t\t\t\t\tdiv_id: 'aPaBO',\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\twidth: 400,\r\n\t\t\t\t\theight: 460,\r\n\t\t\t\t\tconfirm: function () {\r\n\t\t\t\t\t\tvar discounts_are_valid = saveItems(true, true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tintenseLogging(\"addPaymentAndActivate() - confirm dialog\");\r\n\r\n\t\tif (hasBundle)\r\n\t\t{\r\n\t\t\tlet bundleIsSelected = false;\r\n\t\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tbundleIsSelected = true;\r\n\t\t\t}\r\n\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\r\n\t\t\t\tlet numBundItems = countSelectedBundleItems();\r\n\t\t\t\tif (numBundItems < intro_servings_required)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Please select at least ' + intro_servings_required + ' servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\telse if (numBundItems > 18)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Please select no more than 18 servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (stationNeedsAttention)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Please review the Side Station and ensure the correct number of items are selected.'\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\t// always first ensure that discounts are updated on server\r\n\t\tlet message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\t\tlet changesBlurb = getAbbreviatedSummaryString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Add Payment and Book Order',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: 460,\r\n\t\t\tconfirm: function () {\r\n\t\t\t\tlet discounts_are_valid = saveItems(true, true, true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction save2PaymentsAndBookOrder(payment2Type, payment1Data, token)\r\n{\r\n\r\n\tintenseLogging(\"save2PaymentsAndBookOrder() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\t\tif (!max_plate_points_deduction)\r\n\t\t{\r\n\t\t\tmax_plate_points_deduction = 0;\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tadd_payment_data: payment2Data,\r\n\t\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, json.warnOfOutstandingSavedOrdersOnFullSession, false, false, payment1Data);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction savePayment2(payment2Type, warnOfOutstandingSavedOrdersOnFullSession, token)\r\n{\r\n\r\n\tintenseLogging(\"savePayment2() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'add_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment2Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"savePayment2() add_payment successful\");\r\n\r\n\t\t\t\t\tif (warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, warnOfOutstandingSavedOrdersOnFullSession, false, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction handleDirectPayment(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"handleDirectPayment() called\");\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\t// Handle Payment 1 for certain\r\n\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\tvar DP_State = 0;\r\n\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t{\r\n\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\tif (DP_State == 1)\r\n\t\t{\r\n\t\t\tDP_State = 4;\r\n\t\t} // translate to CPayment constants - for now\r\n\t\tif (DP_State == 2)\r\n\t\t{\r\n\t\t\tDP_State = 5;\r\n\t\t}\r\n\r\n\t\tif (DP_State > 0)\r\n\t\t{\r\n\t\t\t// TODO: validate amounts\r\n\t\t}\r\n\t}\r\n\r\n\tvar use_store_credits = false;\r\n\tvar store_credit_amount = 0;\r\n\tif ($(\"#use_store_credits\").length)\r\n\t{\r\n\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t{\r\n\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\tuse_store_credits = true;\r\n\t\t}\r\n\t}\r\n\r\n\tvar mainPaymentData = null;\r\n\tvar additionalPaymentData = null;\r\n\r\n\tif (payment2Type)\r\n\t{\r\n\t\tmainPaymentData = getPaymentData(payment2Type, 2);\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t}\r\n\t\t}\r\n\t\tadditionalPaymentData = payment1Data;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmainPaymentData = payment1Data;\r\n\t}\r\n\r\n\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\tif (!max_plate_points_deduction)\r\n\t{\r\n\t\tmax_plate_points_deduction = 0;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: store_id,\r\n\t\t\top: 'save_payment',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tpayment_data: mainPaymentData,\r\n\t\t\tadd_payment_data: additionalPaymentData,\r\n\t\t\tdelay_remainder: DP_State,\r\n\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\tdd_csrf_token: token,\r\n\t\t\tpayment2Type: payment2Type\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"handleDirectPayment() save_payment successful\");\r\n\r\n\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tif (strError == 'timeout')\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Order Processing Timed Out',\r\n\t\t\t\t\tmessage: \"The request to finalized the order has timed out. This may be due to network congestion. The order may have been successful. The page will refresh and show the actual current status.\",\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t'Refresh': function () {\r\n\t\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onAddPaymentAndActivate(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"onAddPaymentAndActivate() called\");\r\n\r\n\tif (!supports_transparent_redirect)\r\n\t{\r\n\t\treturn handleDirectPayment(addOnly, go_to_confirm, token);\r\n\t}\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\tif (payment2Type && payment2Type != \"\")\r\n\t{\r\n\t\tsave2PaymentsAndBookOrder(payment2Type, payment1Data, token);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (payment1Type != \"\" && payment1Type != \"CC\")\r\n\t{\r\n\t\t// Handle Payment 1 for certain\r\n\t\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar use_store_credits = false;\r\n\t\tvar store_credit_amount = 0;\r\n\t\tif ($(\"#use_store_credits\").length)\r\n\t\t{\r\n\t\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\t\tuse_store_credits = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar max_plate_points_deduction = $(\"#max_plate_points_deduction\").html();\r\n\t\tif (!max_plate_points_deduction)\r\n\t\t{\r\n\t\t\tmax_plate_points_deduction = 0;\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\t\tmax_plate_points_deduction: max_plate_points_deduction,\r\n\t\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"onAddPaymentAndActivate save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse if (payment1Type != \"\" && payment1Type == \"CC\")\r\n\t{\r\n\t\t/*\r\n\r\n\t\t '#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t ' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t ' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t ' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2'\r\n\t\t */\r\n\r\n\t\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_1\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\t\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json) {\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 1, false, addOnly, go_to_confirm, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"onAddPaymentAndActivate get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction RetrieveCalendar(timestamp)\r\n{\r\n\r\n\tintenseLogging(\"RetrieveCalendar() called\");\r\n\r\n\tvar op = 'retrieve';\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\top = 'retrieve_for_reschedule';\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'GET',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_calendarProcessor',\r\n\t\t\tstore_id: store_id,\r\n\t\t\taction: op,\r\n\t\t\tcur_session_id: session_id,\r\n\t\t\ttimestamp: timestamp\r\n\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar() successful\");\r\n\r\n\t\t\t\t$(\"#calendar_holder\").html(json.data);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tintenseLogging(\"RetrieveCalendar: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDayClick(obj)\r\n{\r\n}\r\n\r\nfunction doReschedule(id, sessionTime, transition_type)\r\n{\r\n\tvar curSessionDate = $(\"#curSessionDate\").html();\r\n\r\n\tdd_message({\r\n\t\ttitle: 'Reschedule',\r\n\t\tmessage: '<div style=\"text-align: center;\"><div>From</div><div style=\"font-weight: bold;\">' + curSessionDate + '</div><div>to</div><div style=\"font-weight: bold;\">' + sessionTime + '</div>'\r\n\t\t\t+ '<div style=\"margin-top:5px;\"><input type=\"checkbox\" name=\"reschedule_suppress_email\" id=\"reschedule_suppress_email\" />&nbsp;<label for=\"reschedule_suppress_email\">Suppress Sending Reschedule Email to Guest</label></div>',\r\n\t\tmodal: true,\r\n\t\tconfirm: function () {\r\n\t\t\tvar suppressEmail = false;\r\n\t\t\tif ($(\"#reschedule_suppress_email\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tsuppressEmail = true;\r\n\t\t\t}\r\n\r\n\t\t\tvar org_session_id = session_id;\r\n\t\t\tsession_id = id;\r\n\t\t\tReschedule(org_session_id, transition_type, suppressEmail);\r\n\r\n\t\t},\r\n\t\topen: function () {\r\n\r\n\t\t\t$(this).siblings('.ui-dialog-buttonpane').find(\"button:contains('Confirm')\").focus();\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onRescheduleClick(id, sessionTime, isDiscounted, control_message)\r\n{\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tif (control_message == \"locked\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"This order cannot be rescheduled as it is in the previous calendar month and that month has been locked and finalized.\"\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to an Assembly.</span><br /><br />The Service Fee will be removed. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"tononpreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"MFY_to_Assembled\");\r\n\t\t\t\t\t\t$(\"#tononpreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Pickup.</span><br /><br />The Service Fee will be applied. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"Assembly_to_MFY\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Home Delivery.</span><br /><br />The Service Fee will be adjusted, the Delivery Fee will be added and a Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"MFY_to_HD\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Community Pick Up.</span><br />\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"MFY_to_CPU\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"CPU_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Pick Up.</span><br />\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"CPU_to_MFY\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Assembly.</span><br /><br />The Delivery Fee, Service Fee, and Delivery Address will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"HD_to_Assembled\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Pick Up.</span><br /><br />The Delivery Fee will be removed. The Service Fee will be adjusted. The Delivery Address will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"HD_to_MFY\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Community Pick Up.</span><br /><br />The Delivery Address will be removed and the Delivery Fee and Service Fee may be adjusted.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"HD_to_CPU\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"CPU_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Assembly.</span><br /><br />The Delivery Fee and Service Fee will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"CPU_to_Assembled\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"CPU_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Home Delivery.</span><br /><br />The Delivery Fee and Service Fee may be adjusted. The Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"CPU_to_HD\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Community Pick Up.</span><br /><br />A Delivery Fee and Service Fee may be added.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"Assembly_to_CPU\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Home Delivery.</span><br /><br />The Service and Delivery Fees will be added. The Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, \"Assembly_to_HD\");\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"MFY_to_WI\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Walk-in.</span><br /><br /> \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"Assembly_to_WI\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Walk-in.</span><br /><br /> \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"HD_to_WI\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Walk-in.</span><br /><br />The Delivery Fee will be removed. The Service Fee will be adjusted. The Delivery Address will be removed.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_Assembled\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Pickup.</span><br /><br />The Service Fee will be adjusted. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_MFY\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Pick Up.</span><br /><br />The Service Fee will be adjusted. \" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_CPU\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-In to Community Pick Up.</span><br />\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"WI_to_HD\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Home Delivery.</span><br /><br />The Service Fee will be adjusted, the Delivery Fee will be added and a Delivery Address is now required.\" +\r\n\t\t\t\t\t\"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tnoOk: true,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tContinue: function () {\r\n\t\t\t\t\t\tdoReschedule(id, sessionTime, control_message);\r\n\t\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t\t},\r\n\t\t\t\t\tCancel: function () {\r\n\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if (control_message == \"none_wi\")\r\n\t\t{\r\n\t\t\tsessionTime = sessionTime.substring(0, sessionTime.indexOf(' - '));\r\n\t\t\tsessionTime = 'Walk-In on ' + sessionTime;\r\n\t\t\tdoReschedule(id, sessionTime, \"None\");\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tdoReschedule(id, sessionTime, \"None\");\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSessionClick(id, sessionTime, isDiscounted)\r\n{\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetSessionAndSave(id);\r\n\t}\r\n}\r\n\r\nfunction monthChange(monthVal)\r\n{\r\n\tRetrieveCalendar(monthVal);\r\n}\r\n\r\nfunction handle_delayed_payment()\r\n{\r\n\tif (GUEST_PREFERENCES[user_id].TC_DELAYED_PAYMENT_AGREE.value == 1)\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2').on('click', function (e) {\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\tmessage: lang.en.tc.delayed_payment,\r\n\t\t\tmodal: true,\r\n\t\t\tnoOk: true,\r\n\t\t\tcloseOnEscape: false,\r\n\t\t\topen: function (event, ui) {\r\n\t\t\t\t$(this).parent().find('.ui-dialog-titlebar-close').hide();\r\n\t\t\t},\r\n\t\t\tbuttons: {\r\n\t\t\t\t'Agree': function () {\r\n\r\n\t\t\t\t\t$(this).remove();\r\n\r\n\t\t\t\t\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t\t\t\t\t' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t\t\t\t\t' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t\t\t\t\t' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2').off('click');\r\n\r\n\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 1, user_id);\r\n\r\n\t\t\t\t},\r\n\t\t\t\t'Decline': function () {\r\n\r\n\t\t\t\t\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment0, #payment2_is_store_specific_flat_rate_deposit_delayed_payment0, ' +\r\n\t\t\t\t\t\t'#ref_payment1_is_store_specific_flat_rate_deposit_delayed0, #ref_payment2_is_store_specific_flat_rate_deposit_delayed0').trigger('click');\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\t\t\t\tmessage: lang.en.tc.delayed_payment_decline\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 0, user_id);\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction createBonusCredit(creditConsumed)\r\n{\r\n\tisFactoringCredit = true;\r\n\tcurrentCreditAvailable = creditBasis * 0.10;\r\n\r\n\tif (creditConsumed > currentCreditAvailable)\r\n\t{\r\n\t\tcreditConsumed = currentCreditAvailable;\r\n\t\tcurrentCreditAvailable = 0;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tcurrentCreditAvailable -= creditConsumed;\r\n\r\n\t}\r\n\r\n\t$('#couponValue').val(creditConsumed);\r\n\t$(\"#OEH_bonus_credit\").html(\" ( Bonus Credit: \" + formatAsMoney(currentCreditAvailable) + \" )\");\r\n}\r\n\r\nfunction removeBonusCredit()\r\n{\r\n\tisFactoringCredit = false;\r\n\t$(\"#OEH_bonus_credit\").html(\"\");\r\n}\r\n\r\nfunction handleSummaryDisplayChange(obj)\r\n{\r\n\tif (obj.checked)\r\n\t{\r\n\t\tShowAllLineItems();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tHideLineItemsIfZero();\r\n\t}\r\n}\r\n\r\nfunction HideLineItemsIfZero()\r\n{\r\n\tvar bagFeeOrg = Number($('#OEH_subtotal_bag_fee_org').html());\r\n\tvar bagFee = Number($('#OEH_subtotal_bag_fee').html());\r\n\r\n\tif (bagFeeOrg == 0 && bagFee == 0)\r\n\t{\r\n\t\t$('#BagFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#BagFeeRow').show();\r\n\t}\r\n\r\n\tvar bagFeeTaxOrg = Number($('#OEH_bag_fee_tax_subtotal_org').html());\r\n\tvar bagFeeTax = Number($('#OEH_bag_fee_tax_subtotal').html());\r\n\r\n\tif (bagFeeTaxOrg == 0 && bagFeeTax == 0)\r\n\t{\r\n\t\t$('#BagFeeTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#BagFeeTaxRow').show();\r\n\t}\r\n\r\n\tvar serviceFeeOrg = Number($('#OEH_subtotal_service_fee_org').html());\r\n\tvar serviceFee = Number($('#OEH_subtotal_service_fee').html());\r\n\r\n\tif (serviceFeeOrg == 0 && serviceFee == 0)\r\n\t{\r\n\t\t$('#ServiceFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#ServiceFeeRow').show();\r\n\t}\r\n\r\n\tvar deliveryFeeOrg = Number($('#OEH_subtotal_delivery_fee_org').html());\r\n\tvar deliveryFee = Number($('#OEH_subtotal_delivery_fee').html());\r\n\r\n\tif (deliveryFeeOrg == 0 && deliveryFee == 0)\r\n\t{\r\n\t\t$('#DeliveryFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryFeeRow').show();\r\n\t}\r\n\r\n\tvar serviceTaxOrg = Number($('#OEH_service_tax_subtotal_org').html());\r\n\tvar serviceTax = Number($('#OEH_service_tax_subtotal').html());\r\n\r\n\tif (serviceTaxOrg == 0 && serviceTax == 0)\r\n\t{\r\n\t\t$('#ServiceTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#ServiceTaxRow').show();\r\n\t}\r\n\r\n\tvar miscFoodOrg = Number($('#OEH_misc_food_subtotal_org').html());\r\n\tvar miscFood = Number($('#OEH_misc_food_subtotal').html());\r\n\r\n\tif (miscFoodOrg == 0 && miscFood == 0)\r\n\t{\r\n\t\t$('#miscFoodRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#miscFoodRow').show();\r\n\t}\r\n\r\n\tvar miscNonFoodOrg = Number($('#OEH_misc_nonfood_subtotal_org').html());\r\n\tvar miscNonFood = Number($('#OEH_misc_nonfood_subtotal').html());\r\n\r\n\tif (miscNonFoodOrg == 0 && miscNonFood == 0)\r\n\t{\r\n\t\t$('#miscNonFoodRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#miscNonFoodRow').show();\r\n\t}\r\n\r\n\tvar miscMealCustomizationFeeOrg = Number($('#OEH_subtotal_meal_customization_fee').html());\r\n\tvar miscMealCustomizationFee = Number($('#OEH_subtotal_meal_customization_fee_org').html());\r\n\r\n\tif (miscMealCustomizationFeeOrg == 0 && miscMealCustomizationFee == 0)\r\n\t{\r\n\t\t$('#MealCustomizationFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#MealCustomizationFeeRow').show();\r\n\t}\r\n\r\n\r\n\tvar doDiscountOrg = Number($('#OEH_direct_order_discount_org').html());\r\n\tvar doDiscount = Number($('#OEH_direct_order_discount').html());\r\n\r\n\tif (doDiscountOrg == 0 && doDiscount == 0)\r\n\t{\r\n\t\t$('#directDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#directDiscountRow').show();\r\n\t}\r\n\r\n\tvar couponDiscountOrg = Number($('#OEH_coupon_discount_org').html());\r\n\tvar couponDiscount = Number($('#OEH_coupon_discount').html());\r\n\r\n\tif (couponDiscountOrg == 0 && couponDiscount == 0)\r\n\t{\r\n\t\t$('#couponDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#couponDiscountRow').show();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_food').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_food').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#platePointsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#platePointsDiscountRow').show();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_fee').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#platePointsFeeDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#platePointsFeeDiscountRow').show();\r\n\t}\r\n\r\n\tvar membershipDiscountOrg = Number($('#OEH_membership_discount_org').html());\r\n\tvar membershipDiscount = Number($('#OEH_membership_discount').html());\r\n\r\n\tif (membershipDiscountOrg == 0 && membershipDiscount == 0)\r\n\t{\r\n\t\t$('#membershipDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#membershipDiscountRow').show();\r\n\t}\r\n\r\n\tvar sessionDiscountOrg = Number($('#OEH_session_discount').html());\r\n\r\n\tif (sessionDiscountOrg == 0)\r\n\t{\r\n\t\t$('#sessionDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#sessionDiscountRow').show();\r\n\t}\r\n\r\n\tvar pudDiscount = Number($('#OEH_preferred').html());\r\n\r\n\tif (pudDiscount == 0)\r\n\t{\r\n\t\t$('#preferredUserDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#preferredUserDiscountRow').show();\r\n\t}\r\n\r\n\tvar foodTaxOrg = Number($('#OEH_food_tax_subtotal_org').html());\r\n\tvar foodTax = Number($('#OEH_food_tax_subtotal').html());\r\n\r\n\tif (foodTaxOrg == 0 && foodTax == 0)\r\n\t{\r\n\t\t$('#foodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#foodTaxRow').show();\r\n\t}\r\n\r\n\tvar nonFoodTaxOrg = Number($('#OEH_tax_subtotal_org').html());\r\n\tvar nonFoodTax = Number($('#OEH_tax_subtotal').html());\r\n\r\n\tif (nonFoodTaxOrg == 0 && nonFoodTax == 0)\r\n\t{\r\n\t\t$('#nonFoodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxRow').show();\r\n\t}\r\n\r\n\tlet deliveryTaxOrg = Number($('#OEH_delivery_tax_subtotal_org').html());\r\n\tlet deliveryTax = Number($('#OEH_delivery_tax_subtotal').html());\r\n\r\n\tif (deliveryTaxOrg == 0 && deliveryTax == 0)\r\n\t{\r\n\t\t$('#DeliveryTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#DeliveryTaxRow').show();\r\n\t}\r\n\r\n\tlet productsSubtotalOrg = Number($('#OEH_products_subtotal_org').html());\r\n\tlet productsSubtotal = Number($('#OEH_products_subtotal').html());\r\n\r\n\tif (productsSubtotalOrg == 0 && productsSubtotal == 0)\r\n\t{\r\n\t\t$('#productSubtotalRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#productSubtotalRow').show();\r\n\t}\r\n\r\n\tif (!$('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\t$('#LTDRoundUpRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#LTDRoundUpRow').show();\r\n\t}\r\n}\r\n\r\nfunction ShowAllLineItems()\r\n{\r\n\t$('#ServiceFeeRow').show();\r\n\t$('#DeliveryFeeRow').show();\r\n\t$('#ServiceTaxRow').show();\r\n\t$('#miscFoodRow').show();\r\n\t$('#miscNonFoodRow').show();\r\n\t$('#directDiscountRow').show();\r\n\t$('#couponDiscountRow').show();\r\n\t$('#foodTaxRow').show();\r\n\t$('#nonFoodTaxRow').show();\r\n\t$('#productSubtotalRow').show();\r\n\t$('#platePointsDiscountRow').show();\r\n\t$('#preferredUserDiscountRow').show();\r\n\t$('#sessionDiscountRow').show();\r\n\t$('#LTDRoundUpRow').show();\r\n\t$('#MealCustomizationFeeRow').show();\r\n\t$('#BagFeeRow').show();\r\n}\r\n\r\nfunction sort_by_price(a, b)\r\n{\r\n\tif (a.price == b.price)\r\n\t{\r\n\t\treturn 0;\r\n\t}\r\n\r\n\treturn (a.price < b.price) ? 1 : -1;\r\n}\r\n\r\nfunction drawChangeList()\r\n{\r\n\tvar html = getChangeListHTML();\r\n\t$(\"#changelist\").html(html);\r\n\r\n}\r\n\r\nfunction getChangeListHTML()\r\n{\r\n\r\n\tlet htmlStr = \"\";\r\n\tlet first = true;\r\n\r\n\tfor (let item in changeList.stdMenuItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Standard Items <span id='changed-item-count'> - \" + localStorage.getItem('core-item-count') + \" total</span></h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.stdMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tlet title = $(\"#qty_\" + item).data(\"item_title\");\r\n\r\n\t\t\tlet pricing_type = translateServingSize($(\"#qty_\" + item).data(\"servings\"));\r\n\r\n\t\t\tpricing_type = \"(\" + pricing_type + \")\";\r\n\r\n\t\t\tif (changeList.stdMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.stdMenuItems[item] + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.stdMenuItems[item] * -1 + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\r\n\tlet indexedItems = [];\r\n\tfor (let item in changeList.FTMenuItems)\r\n\t{\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tvar index = $(\"#qty_\" + item).data(\"index\");\r\n\t\t\tindexedItems[index] = item;\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (let key in indexedItems)\r\n\t{\r\n\t\tlet item = indexedItems[key];\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Sides <span id='changed-sides-count'> - \" + localStorage.getItem('side-item-count') + \" total</span></h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tlet title = $(\"#qty_\" + item).data(\"item_title\");\r\n\r\n\t\t\tif (changeList.FTMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.FTMenuItems[item] + \" <i>\" + title + \"</i>\";\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.FTMenuItems[item] * -1 + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tlet hadMiscCostChanges = false;\r\n\tfor (let item in changeList.miscCosts)\r\n\t{\r\n\t\thadMiscCostChanges = true;\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.sideBundleItem)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Sides Bundle Item List</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.sideBundleItem.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tlet title = $(\"#sbi_\" + item).data(\"item_title\");\r\n\r\n\t\t\tif (changeList.sideBundleItem[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.sideBundleItem[item] + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.sideBundleItem[item] * -1 + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.miscDescs)\r\n\t{\r\n\t\tif (!hadMiscCostChanges && first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.bundleItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\tif (isDreamTaste)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Meal Prep Workshop Items List</h3><ul style='margin: 4px;'>\";\r\n\r\n\t\t\t}\r\n\t\t\telse if (isFundraiser)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Fundraiser Event Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Intro Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\t}\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.bundleItems.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tlet title = $(\"#bnd_\" + item).data(\"item_title\");\r\n\t\t\tlet pricing_type = \"(\" + $(\"#bnd_\" + item).data(\"servings\") + \" Serving)\";\r\n\r\n\t\t\tif (changeList.bundleItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.bundleItems[item] + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.bundleItems[item] * -1 + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (let item in changeList.reporting)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Reporting</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.reporting.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (item == 'fundraiser')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse if (changeList.reporting[item][\"orgVal\"] > 0 && changeList.reporting[item][\"orgVal\"] != changeList.reporting[item][\"newVal\"])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Changed \" + getHumanReadableName(item) + \" to \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (item == 'fundraiser_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == false)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was removed from the order.'\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + ' was added to the order.'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (item == 'ltd_roundup_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.coupon)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.coupon.change_type == 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Added coupon code: \" + changeList.coupon.code + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type == 'removed')\r\n\t\t{\r\n\t\t\thtmlStr += \"Removed coupon code: \" + changeList.coupon.code + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type == 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Change coupon code to: \" + changeList.coupon.code + \"<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.bagFee['Bag Count'])\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Bag Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Updated Bag Count: Was \" + changeList.bagFee['Bag Count']['orgVal'] + \" bags. Updated to \" + changeList.bagFee['Bag Count']['newVal'] + \" bags<br />\";\r\n\t}\r\n\r\n\tif (changeList.mealCustomizationFee['Meal Customization Fee'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Meal Customization Fee: Was $\" + changeList.mealCustomizationFee['Meal Customization Fee']['orgVal'] + \". Updated to $\" + changeList.mealCustomizationFee['Meal Customization Fee']['newVal'] + \"<br />\";\r\n\t}\r\n\r\n\tif (typeof changeList.mealCustomizationFee['Meal Customization Selection'] != 'undefined' && typeof changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] != 'undefined' && changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Selection</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tlet previous = changeList.mealCustomizationFee['Meal Customization Selection']['orgVal'] == 1 ? \" not selected\" : \" selected\";\r\n\t\tlet newVal = changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] == \"on\" ? \" selected\" : \" not selected\";\r\n\r\n\r\n\t\thtmlStr += \"Meal Customization was\" + previous + \". Updated to \" + newVal+ \".<br />\";\r\n\t}\r\n\r\n\r\n\r\n\tif (changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tfor (let key in changeList.mealCustomizationFee['Meal Customization'])\r\n\t\t{\r\n\t\t\tif(typeof changeList.mealCustomizationFee['Meal Customization'][key] !== 'undefined' && typeof changeList.mealCustomizationFee['Meal Customization'][key]['name'] !== 'undefined')\r\n\t\t\t{\r\n\t\t\t\tif(changeList.mealCustomizationFee['Meal Customization'][key]['newVal'].toUpperCase() == 'OPTED IN')\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" to \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" of \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tlet payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment2_type').val() != \"\")\r\n\t\t{\r\n\t\t\tlet payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\t}\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction translateServingSize(servings)\r\n{\r\n\tvar result = '';\r\n\tswitch (servings)\r\n\t{\r\n\t\tcase 6:\r\n\t\t\tresult = 'Large - ' + servings + '';\r\n\t\t\tbreak;\r\n\t\tcase 3:\r\n\t\tcase 4:\r\n\t\t\tresult = 'Medium - ' + servings + '';\r\n\t\t\tbreak;\r\n\t\tcase 2:\r\n\t\t\tresult = 'Small - ' + servings + '';\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tresult = servings;\r\n\t}\r\n\r\n\treturn result;\r\n\r\n}\r\n\r\nfunction getHumanReadableName(id)\r\n{\r\n\tswitch (id)\r\n\t{\r\n\t\tcase 'direct_order_discount':\r\n\t\t\treturn \"Direct Order Discount\";\r\n\t\tcase 'plate_points_discount':\r\n\t\t\treturn \"Dinner Dollars\";\r\n\t\tcase \"misc_food_subtotal\":\r\n\t\t\treturn \"Miscellaneous Food Cost\";\r\n\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\treturn \"Miscellaneous Non-food Cost\";\r\n\t\tcase \"subtotal_service_fee\":\r\n\t\t\treturn \"Service Fee\";\r\n\t\tcase \"subtotal_delivery_fee\":\r\n\t\t\treturn \"Delivery Fee\";\r\n\t\tcase 'misc_food_subtotal_desc':\r\n\t\t\treturn 'Misc Food Description';\r\n\t\tcase 'misc_nonfood_subtotal_desc':\r\n\t\t\treturn 'Misc Non-food Description';\r\n\t\tcase 'service_fee_description':\r\n\t\t\treturn 'Service Fee Description';\r\n\t\tcase 'session_discount':\r\n\t\t\treturn 'Session Discount';\r\n\t\tcase 'fundraiser':\r\n\t\t\treturn 'Fundraiser';\r\n\t\tcase 'fundraiser_value':\r\n\t\t\treturn 'Fundraiser Value';\r\n\t\tcase 'ltd_roundup_value':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up Value';\r\n\t\tcase 'ltd_roundup':\r\n\t\t\treturn 'Dream Dinners Foundation Round Up';\r\n\t\tdefault:\r\n\t\t\treturn 'error';\r\n\t}\r\n}\r\n\r\nfunction getAbbreviatedSummaryString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\r\n\tif (isDreamTaste)\r\n\t{\r\n\t\thtmlStr += \"<h3>Meal Prep Workshop Order</h3>\";\r\n\t}\r\n\telse if (isFundraiser)\r\n\t{\r\n\t\thtmlStr += \"<h3>Fundraiser Order</h3>\";\r\n\t}\r\n\telse if (bundleChecked)\r\n\t{\r\n\t\thtmlStr += \"<h3>Starter Pack Order</h3>\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\thtmlStr += \"<h3>Standard Order</h3>\";\r\n\t}\r\n\r\n\tvar stdItemCount = 0;\r\n\tvar FTItemCount = 0;\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\tif ($(this).val() > 0)\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tFTItemCount += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tstdItemCount += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tif (stdItemCount > 0)\r\n\t{\r\n\t\thtmlStr += stdItemCount + \" Standard Items Selected.<br />\"\r\n\t}\r\n\tif (FTItemCount > 0)\r\n\t{\r\n\t\thtmlStr += FTItemCount + \" Sides &amp; Sweets Items Selected.<br />\"\r\n\t}\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif (curVal > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += getHumanReadableName(this.id) + \" costs of $\" + formatAsMoney(curVal);\r\n\r\n\t\t\t\tvar descIDStr = \"\";\r\n\r\n\t\t\t\tswitch (this.id)\r\n\t\t\t\t{\r\n\t\t\t\t\tcase \"misc_food_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_food_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_nonfood_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"subtotal_service_fee\":\r\n\t\t\t\t\t\tdescIDStr = \"service_fee_description\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar desc = null;\r\n\t\t\t\tif (descIDStr != \"\")\r\n\t\t\t\t{\r\n\t\t\t\t\tdesc = $(\"#\" + descIDStr).val();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (desc)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \". <span>( \" + desc + \" )</span><br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \".<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\tvar bundleOrgVal = $('#selectedBundle').data('org_value');\r\n\r\n\tvar bundleItems = 0;\r\n\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\tif ($(this).is(\":checked\"))\r\n\t\t{\r\n\t\t\tbundleItems++;\r\n\t\t}\r\n\t});\r\n\r\n\tif (bundleItems > 0)\r\n\t{\r\n\t\thtmlStr += bundleItems + \" Intro Items Selected.<br />\"\r\n\t}\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\tvar bundleItems = 0;\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tbundleItems += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (bundleItems > 0)\r\n\t\t{\r\n\t\t\thtmlStr += bundleItems + \" Items Selected.<br />\"\r\n\t\t}\r\n\t}\r\n\r\n\t// Discounts\r\n\r\n\tvar discountsHTML = \"\";\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() > 0)\r\n\t\t{\r\n\t\t\tdiscountsHTML += getHumanReadableName(this.id) + \" applied.<br />\";\r\n\t\t}\r\n\t});\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\r\n\t\tvar newSDValue = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\r\n\t\tif (newSDValue && newSDValue != \"noSD\")\r\n\t\t{\r\n\t\t\tdiscountsHTML += \"Session discount is applied.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tvar newPUDValue = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\r\n\t\tif (newPUDValue && newPUDValue != \"noUP\")\r\n\t\t{\r\n\t\t\tdiscountsHTML += \"Preferred User Discount is applied.<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (discountsHTML != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Discounts</h3>\" + discountsHTML;\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_']\").each(function () {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (changeList.bagFee['Bag Count'])\r\n\t\t{\r\n\t\t\thtmlStr += \"Bag Count set to \" + changeList.bagFee['Bag Count']['newVal'] + \" bags<br />\";\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction updateChangeList()\r\n{\r\n\r\n\titemChanges = false;\r\n\tdiscountChanges = false;\r\n\treportingChanges = false;\r\n\tfeeChanges = false;\r\n\r\n\tdiscountOrPaymentChanges = false;\r\n\tlet showSaveButton = false;\r\n\r\n\tchangeList = {};\r\n\tchangeList.stdMenuItems = {};\r\n\tchangeList.FTMenuItems = {};\r\n\tchangeList.miscCosts = {};\r\n\tchangeList.miscDescs = {};\r\n\tchangeList.bundleItems = {};\r\n\tchangeList.order_type = \"\";\r\n\tchangeList.discounts = {};\r\n\tchangeList.reporting = {};\r\n\tchangeList.delivery = {};\r\n\tchangeList.bagFee = {};\r\n\tchangeList.mealCustomizationFee = {'Meal Customization':null,'Meal Customization Fee':null};\r\n\r\n\r\n\tchangeList.sideBundleItem = {};\r\n\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tchangeList.FTMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.stdMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// bundle items\r\n\t$(\"[name^='sbi_']\").each(function () {\r\n\t\tif ($(this).val() != $(this).data('lastqty'))\r\n\t\t{\r\n\t\t\tchangeList.sideBundleItem[$(this).attr('id').split(\"_\")[1]] = $(this).val() - $(this).data('lastqty');\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Misc Costs\r\n\t$(\"[data-dd_type='item_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.miscDescs[this.id] = 1;\r\n\t\t\t}\r\n\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\tvar bundleOrgVal = $('#selectedBundle').data('org_value');\r\n\r\n\tif (bundleChecked)\r\n\t{\r\n\t\tif (bundleOrgVal == \"0\")\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').addClass('unsaved_data_cb');\r\n\t\t\tchangeList.order_type = \"to Intro\";\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif (bundleOrgVal == \"1\")\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').addClass('unsaved_data_cb');\r\n\t\t\tchangeList.order_type = \"to Standard\";\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t\t{\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\t\titemChanges = true;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('org_value') == \"0\")\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().addClass('unsaved_data_cb');\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = 1;\r\n\t\t\t\t\titemChanges = true;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().removeClass('unsaved_data_cb');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('org_value') == \"1\")\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().addClass('unsaved_data_cb');\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = -1;\r\n\t\t\t\t\titemChanges = true;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().removeClass('unsaved_data_cb');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\t// bag fees\r\n\tif ($(\"#total_bag_count\").length)\r\n\t{\r\n\t\tif ($(\"#total_bag_count\").val() != $(\"#total_bag_count\").data(\"org_value\"))\r\n\t\t{\r\n\t\t\tchangeList.bagFee['Bag Count'] = {\r\n\t\t\t\tnewVal: $(\"#total_bag_count\").val(),\r\n\t\t\t\torgVal: $(\"#total_bag_count\").data(\"org_value\")\r\n\t\t\t}\r\n\t\t\tfeeChanges = true;\r\n\t\t\t$(\"#total_bag_count\").addClass('unsaved_data');\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#total_bag_count\").removeClass('unsaved_data');\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// meal customization fees\r\n\tif ($(\"#subtotal_meal_customization_fee\").length)\r\n\t{\r\n\t\tif($(\"#subtotal_meal_customization_fee\").val() == ''){\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").val('0.00');\r\n\t\t}\r\n\t\tif ($(\"#subtotal_meal_customization_fee\").val() != $(\"#subtotal_meal_customization_fee\").data(\"org_value\"))\r\n\t\t{\r\n\t\t\tchangeList.mealCustomizationFee['Meal Customization Fee'] = {\r\n\t\t\t\tnewVal: $(\"#subtotal_meal_customization_fee\").val(),\r\n\t\t\t\torgVal: $(\"#subtotal_meal_customization_fee\").data(\"org_value\")\r\n\t\t\t}\r\n\t\t\tfeeChanges = true;\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").addClass('unsaved_data');\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").removeClass('unsaved_data');\r\n\t\t}\r\n\t}\r\n\r\n\tlet customizationSelection = $(\"#opted_to_customize_recipes\").is(\":checked\")  ? '1':'0';\r\n\tlet origCustomizationSelection = (typeof $(\"#opted_to_customize_recipes\").data(\"org_value\") == 'undefined' || $(\"#opted_to_customize_recipes\").data(\"org_value\") == '' || $(\"#opted_to_customize_recipes\").data(\"org_value\") == '0') ? '0':'1';\r\n\tif( origCustomizationSelection != customizationSelection){\r\n\t\tchangeList.mealCustomizationFee['Meal Customization Selection'] = {\r\n\t\t\tnewVal: $(\"#opted_to_customize_recipes\").val(),\r\n\t\t\torgVal: $(\"#opted_to_customize_recipes\").data(\"org_value\")\r\n\t\t}\r\n\t\tfeeChanges = true;\r\n\t\t$(\"#opted_to_customize_recipes\").addClass('unsaved_data');\r\n\t}\r\n\r\n\t$(\"[data-dd_type='fee_field']\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.miscDescs[this.id] = 1;\r\n\t\t\t}\r\n\r\n\t\t\tfeeChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"[data-dd_type='customization_fee_toggle']\").each(function () {\r\n\t\tvar curVal = $(this).is(\":checked\") ? 'Opted in' : 'Opted out';\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\t\tvar name = $(this).data('name');\r\n\r\n\r\n\t\tif (curVal.toLowerCase() != orgVal.toLowerCase() )\r\n\t\t{\r\n\t\t\t//$(this).addClass('unsaved_data');\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] == null){\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'] = [];\r\n\t\t\t}\r\n\r\n\r\n\t\t\tchangeList.mealCustomizationFee['Meal Customization'][this.id] = {\r\n\t\t\t\tname : name,\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal\r\n\t\t\t}\r\n\r\n\t\t\t//feeChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t\t\t{\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'][this.id] = '';\r\n\t\t\t}\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"[data-dd_type='customization_fee_detail']\").each(function () {\r\n\t\tlet curVal = $.trim($(this).val());\r\n\t\tlet orgVal = $(this).data('org_value');\r\n\t\tlet name = $(this).data('name');\r\n\r\n\t\tlet key = this.id + 'detail';\r\n\r\n\t\tif (curVal.toLowerCase() != orgVal.toLowerCase() )\r\n\t\t{\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] == null){\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'] = [];\r\n\t\t\t}\r\n\r\n\r\n\t\t\tchangeList.mealCustomizationFee['Meal Customization'][key] = {\r\n\t\t\t\tname : name,\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif( changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t\t\t{\r\n\t\t\t\tchangeList.mealCustomizationFee['Meal Customization'][key] = '';\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\r\n\tif (feeChanges)\r\n\t{\r\n\t\t$(\"#fees_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#fees_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (itemChanges)\r\n\t{\r\n\t\t$(\"#items_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\t// Reporting Fundraising\r\n\t$(\"#fundraiser_id\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\tchangeList.reporting['fundraiser'] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\ttitle: $(this).find(':selected').text()\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#fundraiser_value\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\tchangeList.reporting['fundraiser_value'] = {\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal,\r\n\t\t\t\tdiff: curVal - orgVal\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Reporting, LTD Roundup\r\n\t$(\"#add_ltd_round_up\").each(function () {\r\n\t\tvar curVal = false;\r\n\r\n\t\tif ($(this).is(':checked'))\r\n\t\t{\r\n\t\t\tcurVal = true;\r\n\t\t}\r\n\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif (curVal != orgVal)\r\n\t\t{\r\n\t\t\tchangeList.reporting['ltd_roundup'] = {\r\n\t\t\t\tnewVal: curVal,\r\n\t\t\t\torgVal: orgVal\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t$(\"#ltd_round_up_select\").each(function () {\r\n\t\tif (!$(\"#add_ltd_round_up\").is(':checked'))\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal).toFixed(2);\r\n\t\t\torgVal = parseFloat(orgVal).toFixed(2);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\tchangeList.reporting['ltd_roundup_value'] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: curVal - orgVal\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\treportingChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Discounts\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function () {\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\tcurVal = parseFloat(curVal);\r\n\t\torgVal = parseFloat(orgVal);\r\n\t\tif (isNaN(curVal))\r\n\t\t{\r\n\t\t\tcurVal = Number(0);\r\n\t\t}\r\n\t\tif (isNaN(orgVal))\r\n\t\t{\r\n\t\t\torgVal = Number(0);\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t// we're not  tracking description fields for now\r\n\t\t\tchangeList.discounts[this.id] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tif (initialSessionDiscountSetting != $(\"input[name='SessDisc']:checked\", '#editorForm').val())\r\n\t\t{\r\n\t\t\t$(\".SD_area\").addClass('unsaved_data_cb');\r\n\r\n\t\t\tvar newSDValue = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\r\n\t\t\tif (newSDValue == \"noSD\")\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['session_discount'] = {\r\n\t\t\t\t\tnewVal: 0,\r\n\t\t\t\t\torgVal: $(\"#OEH_session_discount_org\").html(),\r\n\t\t\t\t\tdiff: $(\"#OEH_session_discount_org\").html() * -1\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['session_discount'] = {\r\n\t\t\t\t\tnewVal: $(\"#OEH_session_discount\").html(),\r\n\t\t\t\t\torgVal: 0,\r\n\t\t\t\t\tdiff: $(\"#OEH_session_discount\").html()\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\".SD_area\").removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tif (initialPreferredUserDiscountSetting != $(\"input[name='PUD']:checked\", '#editorForm').val())\r\n\t\t{\r\n\t\t\t$(\"#PUD_area\").addClass('unsaved_data_cb');\r\n\r\n\t\t\tvar newPUDValue = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\r\n\t\t\tif (newPUDValue == \"noUP\")\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['preferred_user_discount'] = {\r\n\t\t\t\t\tnewVal: 0,\r\n\t\t\t\t\torgVal: $(\"#OEH_preferred_org\").html(),\r\n\t\t\t\t\tdiff: $(\"#OEH_preferred_org\").html() * -1\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['preferred_user_discount'] = {\r\n\t\t\t\t\tnewVal: $(\"#OEH_preferred\").html(),\r\n\t\t\t\t\torgVal: 0,\r\n\t\t\t\t\tdiff: $(\"#OEH_preferred\").html()\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#PUD_area\").removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\t// coupons\r\n\tvar orgCouponVal = $(\"#org_coupon_id\").val();\r\n\tvar curCouponVal = $(\"#coupon_id\").val();\r\n\tvar curCouponCode = $(\"#coupon_code\").val();\r\n\r\n\tif (orgCouponVal != curCouponVal)\r\n\t{\r\n\t\tdiscountOrPaymentChanges = true;\r\n\r\n\t\tif (orgCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tcode: curCouponCode,\r\n\t\t\t\tchange_type: \"added\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse if (curCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//removed\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tcode: curCouponCode,\r\n\t\t\t\tchange_type: \"removed\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tcode: curCouponCode,\r\n\t\t\t\tchange_type: \"changed\"\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (deliveryChanges)\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#delivery_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#payments_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && (showSaveButton || $('#use_store_credit').is(':checked')))\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && ($('#use_store_credit').is(':checked') || paymentChanges))\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\r\n\t}\r\n\r\n\tif (orderState == 'ACTIVE' || discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").show();\r\n\t\tif (showSaveButton || paymentChanges || $('#use_store_credits').is(':checked'))\r\n\t\t{\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", true);\r\n\t\t\t$(\"#finalize_msg\").hide();\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (itemChanges || discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#changeListTab\").addClass('unsaved_data_list');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#changeListTab\").removeClass('unsaved_data_list');\r\n\t}\r\n\r\n\tdrawChangeList();\r\n}\r\n\r\nfunction handleAutoAdjust(obj)\r\n{\r\n\t// called when the document is loaded or when the \"autoAdjust\" check box changes\r\n\r\n\t// if checked then setup the amounts to be credited/debited\r\n\tif (obj.checked)\r\n\t{\r\n\t\tvar balance = Number($('#OEH_remaing_balance').html());\r\n\r\n\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || balance > 0))\r\n\t\t{\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('DPADJUST');\r\n\t\t\t\tchangePayment1('DPADJUST');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tadjustPendingDelayedPayment(balance);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('REFERENCE');\r\n\t\t\t\tchangePayment1('REFERENCE');\r\n\t\t\t}\r\n\r\n\t\t\tassignBalanceToRefTransactions(balance);\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\t$('#payment1_type').val('');\r\n\t\t\tchangePayment1('');\r\n\t\t}\r\n\r\n\t\t// also clear any credits\r\n\t\tfor (ident in existingPaymentAmountArray)\r\n\t\t{\r\n\t\t\t$('#Cr_RT_' + ident).val(\"\");\r\n\t\t}\r\n\r\n\t\t// or if trying to credit\r\n\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n}\r\n\r\nfunction getAbbreviatedChangeString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\tvar addedStd = 0;\r\n\tvar removedStd = 0;\r\n\r\n\tif (needPlatePointsMaxDiscountChangeWarning)\r\n\t{\r\n\t\thtmlStr += \"<div style='color:red;'>Warning: The amount discountable by Dinner Dollars has changed. You may wish to review and adjust the Dinner Dollars discount.</div>\";\r\n\r\n\t}\r\n\r\n\tfor (var item in changeList.stdMenuItems)\r\n\t{\r\n\t\tif (changeList.stdMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.stdMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedStd += (changeList.stdMenuItems[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedStd += (changeList.stdMenuItems[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedStd)\r\n\t{\r\n\t\thtmlStr += addedStd + \" Standard items were added.<br />\"\r\n\t}\r\n\tif (removedStd)\r\n\t{\r\n\t\thtmlStr += removedStd + \" Standard items were removed.<br />\"\r\n\t}\r\n\r\n\tvar addedFT = 0;\r\n\tvar removedFT = 0;\r\n\r\n\tfor (var item in changeList.FTMenuItems)\r\n\t{\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.FTMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedFT += (changeList.FTMenuItems[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedFT += (changeList.FTMenuItems[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedFT)\r\n\t{\r\n\t\thtmlStr += addedFT + \" Sides &amp; Sweets items were added.<br />\"\r\n\t}\r\n\tif (removedFT)\r\n\t{\r\n\t\thtmlStr += removedFT + \" Sides &amp; Sweets items were removed.<br />\"\r\n\t}\r\n\r\n\tvar addedSBI = 0;\r\n\tvar removedSBI = 0;\r\n\r\n\tfor (var item in changeList.sideBundleItem)\r\n\t{\r\n\t\tif (changeList.sideBundleItem.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.sideBundleItem[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedSBI += (changeList.sideBundleItem[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedSBI += (changeList.sideBundleItem[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedSBI)\r\n\t{\r\n\t\thtmlStr += addedSBI + \" Sides &amp; Sweets bundle items were added.<br />\"\r\n\t}\r\n\tif (removedSBI)\r\n\t{\r\n\t\thtmlStr += removedSBI + \" Sides &amp; Sweets bundle items were removed.<br />\"\r\n\t}\r\n\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tvar addedBI = 0;\r\n\tvar removedBI = 0;\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.bundleItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\tif (isDreamTaste)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Meal Prep Workshop Items List</h3>\";\r\n\t\t\t}\r\n\t\t\telse if (isFundraiser)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Fundraiser Event Items List</h3>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Intro Items List</h3>\";\r\n\t\t\t}\r\n\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.bundleItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.bundleItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedBI += (changeList.bundleItems[item] * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedBI += (changeList.bundleItems[item] * -1);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (addedBI)\r\n\t{\r\n\t\thtmlStr += addedBI + \" items were added.<br />\"\r\n\t}\r\n\tif (removedBI)\r\n\t{\r\n\t\thtmlStr += removedBI + \" items were removed.<br />\"\r\n\t}\r\n\r\n\tif (htmlStr != \"\")\r\n\t{\r\n\t\thtmlStr = \"<h3>Purchase Changes</h3>\" + htmlStr;\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.bagFee['Bag Count'])\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Bag Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Updated Bag Count: Was \" + changeList.bagFee['Bag Count']['orgVal'] + \" bags. Updated to \" + changeList.bagFee['Bag Count']['newVal'] + \" bags<br />\";\r\n\t}\r\n\r\n\tif (typeof changeList.mealCustomizationFee['Meal Customization Selection'] != 'undefined' && changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Selection</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tlet previous = changeList.mealCustomizationFee['Meal Customization Selection']['orgVal'] == 1 ? \" not selected\" : \" selected\";\r\n\t\tlet newVal = changeList.mealCustomizationFee['Meal Customization Selection']['newVal'] == \"on\" ? \" selected\" : \" not selected\";\r\n\r\n\r\n\t\thtmlStr += \"Meal Customization was\" + previous + \". Updated to \" + newVal+ \".<br />\";\r\n\r\n\t}\r\n\tif (changeList.mealCustomizationFee['Meal Customization Fee'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization Fee</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"Updated Meal Customization Fee: Was $\" + changeList.mealCustomizationFee['Meal Customization Fee']['orgVal'] + \". Updated to $\" + changeList.mealCustomizationFee['Meal Customization Fee']['newVal'] + \"<br />\";\r\n\t}\r\n\tif (changeList.mealCustomizationFee['Meal Customization'] != null)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Meal Customization</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tfor (let key in changeList.mealCustomizationFee['Meal Customization'])\r\n\t\t{\r\n\t\t\tif(typeof changeList.mealCustomizationFee['Meal Customization'][key] !== 'undefined' && typeof changeList.mealCustomizationFee['Meal Customization'][key]['name'] !== 'undefined')\r\n\t\t\t{\r\n\t\t\t\tif(changeList.mealCustomizationFee['Meal Customization'][key]['newVal'].toUpperCase() == 'OPTED IN')\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" to \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += changeList.mealCustomizationFee['Meal Customization'][key]['newVal'] + \" of \"+changeList.mealCustomizationFee['Meal Customization'][key]['name'] +\"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif ($('#autoAdjust').is(\":checked\"))\r\n\t{\r\n\t\thtmlStr += \"<span style='color:red'>Auto-Adjust is checked and will \" + $(\"#adj_action\").html() + \"</span>\";\r\n\r\n\t}\r\n\r\n\thtmlStr = \"<div id='finalize_changes_div'>\" + htmlStr + \"</div>\";\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction addPaymentToLockedOrder()\r\n{\r\n\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\tvar billing_address = $(\"#billing_address_1\").val();\r\n\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_token',\r\n\t\t\torder_id: order_id,\r\n\t\t\tamount: amt,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tbilling_name: billing_name,\r\n\t\t\tbilling_address: billing_address,\r\n\t\t\tbilling_zip: billing_zip,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val(),\r\n\t\t\tchain_token: true\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder() get_token successful\");\r\n\r\n\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\tsend(token, 1, false, true, true, false);\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction submitPage()\r\n{\r\n\tintenseLogging(\"submitPage() called\");\r\n\r\n\tvar form = $(\"#editorForm\")[0];\r\n\r\n\tvar is_valid = confirm_and_check_form(form);\r\n\r\n\tif (is_valid)\r\n\t{\r\n\t\tvar message = \"This can not be undone. Are you sure you want to submit the changes?\";\r\n\t\tvar changesBlurb = getAbbreviatedChangeString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tvar dialogHeight = 460;\r\n\r\n\t\tif (message.length < 128)\r\n\t\t{\r\n\t\t\tdialogHeight = 160;\r\n\t\t}\r\n\t\telse if (message.length < 256)\r\n\t\t{\r\n\t\t\tdialogHeight = 260;\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Finalize',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: dialogHeight,\r\n\t\t\tconfirm: function () {\r\n\r\n\t\t\t\tif (supports_transparent_redirect && $(\"#payment1_type\").val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"submitPage() confirmed\");\r\n\r\n\t\t\t\t\tif (!discountEligable.limited_access)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tupdateActiveOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\taddPaymentToLockedOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeList',\r\n\t\t\t\t\t\tvalue: JSON.stringify(changeList)\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeListStr',\r\n\t\t\t\t\t\tvalue: getChangeListHTML()\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$(\"#submit_changes\").val(\"true\");\r\n\t\t\t\t\t$(\"#editorForm\").submit();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n}\r\n\r\nfunction resetPage()\r\n{\r\n\tintenseLogging(\"resetPage() called\");\r\n\r\n\tbounce(window.location.href);\r\n}\r\n\r\nfunction confirm_and_check_form(form)\r\n{\r\n\r\n\tintenseLogging(\"confirm_and_check_form() called\");\r\n\r\n\tif (orderState == 'NEW' || orderState == 'SAVED')\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tvar bundleIsSelected = false;\r\n\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t{\r\n\t\t\tbundleIsSelected = true;\r\n\t\t}\r\n\r\n\t\tif (bundleIsSelected)\r\n\t\t{\r\n\r\n\t\t\tvar numBundItems = countSelectedBundleItems();\r\n\t\t\tif (numBundItems < intro_servings_required)\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Please select at least ' + intro_servings_required + ' servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\telse if (numBundItems > 18)\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Please select no more than 18 servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (stationNeedsAttention)\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please review the Side Station and ensure the correct number of items are selected.'\r\n\t\t});\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn _check_form(form);\r\n}\r\n\r\n// rounds to the nearest penny\r\n// move to global once this is found to be reliable\r\nfunction dd_round_amount(inAmount)\r\n{\r\n\tinAmount += .000005;\r\n\r\n\tvar tempVal = inAmount * 1000.0;\r\n\ttempVal = parseInt(tempVal);\r\n\ttempVal = tempVal / 10;\r\n\tvar pennyFraction = tempVal - Math.floor(tempVal);\r\n\tif (pennyFraction >= .5)\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal) + 1;\r\n\t}\r\n\telse\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal);\r\n\t}\r\n\r\n\treturn tempVal / 100;\r\n}\r\n\r\n/*\r\n\r\n function reportTestFailure(testNum, actual, correct)\r\n {\r\n if (actual != correct)\r\n {\r\n alert(\"Test #: \" + testNum + \" actual: \" + actual + \" correct: \" + correct);\r\n }\r\n }\r\n\r\n function doTests()\r\n {\r\n\r\n var testmultiplier = \".5\";\r\n\r\n var testNum = \"260.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(1, newResult, 130.05);\r\n\r\n var testNum = \"209.10\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(2, newResult, 104.55);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(3, newResult, 104.55);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(4, newResult, 104.5);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(5, newResult, .5);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(6, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(7, newResult, .03);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(8, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(9, newResult, 250);\r\n\r\n var testNum = \"209.10\";\r\n var testmultiplier = \".12\";\r\n\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(10, newResult, 25.09);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(11, newResult, 25.09);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(12, newResult, 25.08);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(13, newResult, .12);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(14, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(15, newResult, .01);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(16, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(17, newResult, 60);\r\n\r\n }\r\n\r\n doTests();\r\n\r\n */\r\n\r\nfunction updateSideStationStatus(entree_id, qty)\r\n{\r\n\tqty = Number(qty);\r\n\tstationNeedsAttention = false;\r\n\r\n\tif (qty == 0)\r\n\t{\r\n\t\t$('#desc' + entree_id).slideUp();\r\n\t\t$(\"#sidestation_help_\" + entree_id).css('color', \"#b00\").html(\"You must set the Bundle quantity to greater than zero.\");\r\n\t\t$('.bundle-subitem-qty[data-parent_item=\"' + entree_id + '\"]').val(0);\r\n\t\treturn;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#desc' + entree_id).slideDown();\r\n\t}\r\n\r\n\tlet requiredItemCount = qty * sideStationBundleInfo[entree_id].number_items_required;\r\n\t$(\"#required_items_station_\" + entree_id).text(requiredItemCount);\r\n\r\n\tlet numSelected = 0;\r\n\r\n\t$.each(sideStationBundleInfo[entree_id].bundle, function (mid, menu_item) {\r\n\r\n\t\tlet itemQty = $('#sbi_' + mid);\r\n\r\n\t\tif (itemQty && itemQty.val() != \"\")\r\n\t\t{\r\n\t\t\tif (isNaN(itemQty.val()) == true || itemQty.val() - parseInt(itemQty.val()) != 0)\r\n\t\t\t{\r\n\t\t\t\titemQty.val(0);\r\n\t\t\t}\r\n\r\n\t\t\t// if it is a fixed quantity, the input is read only so update the value times the master quantity\r\n\t\t\tif (menu_item.fixed_quantity !== '0')\r\n\t\t\t{\r\n\t\t\t\titemQty.val(qty * Number(menu_item.fixed_quantity));\r\n\t\t\t}\r\n\r\n\t\t\tif (itemQty.val() > 0)\r\n\t\t\t{\r\n\t\t\t\titemQty.val(parseInt(itemQty.val()));\r\n\t\t\t\tnumSelected += (itemQty.val() * 1);\r\n\t\t\t}\r\n\r\n\t\t\tlet inv_qty = entreeIDToInventoryMap[menu_item.entree_id].remaining;\r\n\t\t\tinv_qty -= (itemQty.val() * menu_item.servings_per_item);\r\n\r\n\t\t\t$('[data-entree_inventory_remaining=\"' + menu_item.entree_id + '\"]').text(inv_qty);\r\n\r\n\t\t\tentreeIDToInventoryMap[menu_item.entree_id].remaining = inv_qty;\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t$.each(sideStationBundleInfo[entree_id].bundle_groups, function (bid, group_info) {\r\n\t\t$('.group-select-num[data-group_id=\"' + group_info.id + '\"]').text(parseInt(group_info.number_items_required) * parseInt(qty));\r\n\t});\r\n\r\n\t$(\"#selected_items_station_\" + entree_id).html(numSelected);\r\n\r\n\tlet stationHelpElem = $(\"#sidestation_help_\" + entree_id);\r\n\tlet help_message = \"\";\r\n\tif (numSelected == 0)\r\n\t{\r\n\t\thelp_message = \"Please select \" + requiredItemCount + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#b00\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse if (numSelected > requiredItemCount)\r\n\t{\r\n\t\thelp_message = \"You have selected \" + (numSelected - requiredItemCount) + \" items more than the required amount. Please remove \" + (numSelected - requiredItemCount) + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#b00\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse if (numSelected < requiredItemCount)\r\n\t{\r\n\t\thelp_message = \"You have selected \" + (requiredItemCount - numSelected) + \" items less than the required amount. Please add \" + (requiredItemCount - numSelected) + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#b00\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\thelp_message = \"You have selected the correct number of sidestation items. You may continue with item selection or checkout.\";\r\n\t\tstationHelpElem.css('color', \"#0b0\");\r\n\t\tstationNeedsAttention = false;\r\n\t}\r\n\r\n\tstationHelpElem.html(help_message);\r\n}\r\n\r\nfunction handleMealCustomizationFeeInput()\r\n{\r\n\t$('#manual_customization_fee').val('true');\r\n\tcalculateTotal();\r\n}\r\n\r\n\r\nfunction handleBagCountInput()\r\n{\r\n\tbagCountLockedToField = true;\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction handleBagWaiverInput()\r\n{\r\n\tif (!$(\"#opted_to_bring_bags\").is(\":checked\"))\r\n\t{\r\n\t\tbagCountLockedToField = false;\r\n\t}\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction handleMealCustomizationWaiverInput()\r\n{\r\n\tif ($(\"#opted_to_customize_recipes\").is(\":checked\"))\r\n\t{\r\n\t\tmealCustomizationFeeFieldLocked = true;\r\n\r\n\t\t$('.icon-customize').hide();\r\n\r\n\t}else{\r\n\t\tlet mealCustomizationFeeTotal = $(\"#subtotal_meal_customization_fee\").data('org_value');\r\n\t\t$(\"#subtotal_meal_customization_fee\").prop(\"disabled\", false);\r\n\t\t$(\"#subtotal_meal_customization_fee\").val(formatAsMoney(mealCustomizationFeeTotal));\r\n\r\n\t\t$(\"#customization-row-container\").show();\r\n\t\tmealCustomizationFeeFieldLocked = false;\r\n\t\t$('.icon-customize').show();\r\n\r\n\t\tif (true)\r\n\t\t{\r\n\t\t\tfeeChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t}\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction calculateMealCustomizationFee(customizableMealQty){\r\n\tlet priceConfig = meal_customization_cost;\r\n\r\n\tif(typeof priceConfig === 'undefined' || priceConfig.length == 0){\r\n\t\treturn 0;\r\n\t}\r\n\r\n\tlet fee = 0;\r\n\tfor (var key in priceConfig) {\r\n\r\n\t\tswitch(priceConfig[key].operator) {\r\n\t\t\tcase 'EQUAL_OR_LESS':\r\n\t\t\t\tif(customizableMealQty <= parseInt(priceConfig[key].value)){\r\n\t\t\t\t\tfee = priceConfig[key].cost;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'BETWEEN_INCLUSIVE':\r\n\t\t\t\tlet limit = priceConfig[key].value.split('-');\r\n\t\t\t\tlet limitLow = parseInt(limit[0]);\r\n\t\t\t\tlet limitHigh = parseInt(limit[1]);\r\n\t\t\t\tif(customizableMealQty >= limitLow && customizableMealQty <= limitHigh ){\r\n\t\t\t\t\tfee = priceConfig[key].cost;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'GREATER':\r\n\t\t\t\tif(customizableMealQty > parseInt(priceConfig[key].value)){\r\n\t\t\t\t\tfee = priceConfig[key].cost;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t// code block\r\n\t\t}\r\n\t}\r\n\r\n\treturn fee;\r\n\r\n}\r\n\r\nfunction getNumberBagsRequiredFromItems(entreeCount, sidesCount)\r\n{\r\n\r\n\tlet entreesPerBag = 4;\r\n\t//\tlet sidesPerBag = 6;\r\n\r\n\tlet bagsRequired = Math.floor(entreeCount / entreesPerBag);\r\n\tlet entreeRemainder = 0;\r\n\tif (entreeCount % entreesPerBag > 0)\r\n\t{\r\n\t\tentreeRemainder = entreesPerBag - (entreeCount % entreesPerBag);\r\n\t}\r\n\r\n\tif (entreeRemainder > 0)\r\n\t{\r\n\t\tbagsRequired++;\r\n\t}\r\n\t/*\r\n\t\t// simple for now since we are assuming 2 sides fit the space of 1 entree. this could change\r\n\r\n\t\tlet sidesCapacityOfRemainder = entreeRemainder * 2;\r\n\t\tsidesCount -= sidesCapacityOfRemainder;\r\n\r\n\t\tif (sidesCount <= 0)\r\n\t\t{\r\n\t\t\treturn bagsRequired;\r\n\t\t}\r\n\r\n\t\tlet sidesBagsRequired = Math.floor(sidesCount / sidesPerBag);\r\n\t\tlet sidesRemainder = 0;\r\n\t\tif (sidesCount % sidesPerBag > 0)\r\n\t\t{\r\n\t\t\tsidesRemainder = sidesPerBag - (sidesCount % sidesPerBag);\r\n\t\t}\r\n\r\n\t\tif (sidesRemainder > 0)\r\n\t\t{\r\n\t\t\tsidesBagsRequired++;\r\n\t\t}\r\n\t*/\r\n\r\n\t//return bagsRequired + sidesBagsRequired;\r\n\r\n\treturn bagsRequired;\r\n}\r\n\r\n// this massive function is called anytime something that affects costs or payments is altered\r\nfunction calculateTotal()\r\n{\r\n\tlet total = 0;\r\n\tlet entrees = 0;\r\n\tlet servings = 0;\r\n\tlet core_servings = 0;\r\n\tlet halfQty = 0;\r\n\tlet wholeQty = 0;\r\n\tlet customizableMealQty = 0;\r\n\tlet introQty = 0;\r\n\tlet sideDishQty = 0;\r\n\tlet sideDishSubTotal = 0;\r\n\tlet bundlesSubTotal = 0;\r\n\tlet productsSubTotal = 0;\r\n\tlet coreItemsSubtotal = 0;\r\n\tlet bundlesQty = 0;\r\n\tlet discounted_total = 0;\r\n\tlet creditContribution = 0;\r\n\tlet main_items_count = 0;\r\n\tlet bundleIsSelected = false;\r\n\tlet PUDExcludedItemsTotal = 0;\r\n\tlet PUDExcludedFullItemsCount = 0;\r\n\tlet PUDExcludedHalfItemsCount = 0;\r\n\tlet creditConsumed = 0;\r\n\tlet hasServiceFeeWithMFYCoupon = false;\r\n\tlet hasDeliveryFeeWithCoupon = false;\r\n\r\n\tlet sortedCoreItemList = [];\r\n\r\n\tlet itemsSelected = [];\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t{\r\n\t\t\tbundleIsSelected = true;\r\n\t\t}\r\n\t}\r\n\r\n\tfor (let x in entreeIDToInventoryMap)\r\n\t{\r\n\t\tentreeIDToInventoryMap[x].remaining = entreeIDToInventoryMap[x].org_remaining;\r\n\t\t$('[data-entree_inventory_remaining=\"' + x + '\"]').text(entreeIDToInventoryMap[x].org_remaining);\r\n\r\n\t}\r\n\r\n\t// ---------------------------------------------------------- Items\r\n\t// loop through all the quantity input boxes and gather up the totals\r\n\r\n\t// var count = 0;\r\n\t$(\"[id^='qty_']\").each(function () {\r\n\t\t//  count++;\r\n\r\n\t\tif ($(this).val() != \"\")\r\n\t\t{\r\n\t\t\tif (isNaN($(this).val()) == true || $(this).val() - parseInt($(this).val(), 10) != 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).val(0);\r\n\t\t\t}\r\n\r\n\t\t\tlet itemQty = Number($(this).val());\r\n\t\t\tlet itemId = this.id.split(\"_\")[1];\r\n\r\n\t\t\tif (isFactoringCredit)\r\n\t\t\t{\r\n\t\t\t\tlet orgAmount = $(this).data('org_value');\r\n\t\t\t\tif ($(this).data('dd_type') == 'std')\r\n\t\t\t\t{\r\n\t\t\t\t\tif (orgAmount < itemQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = itemQty - orgAmount;\r\n\t\t\t\t\t\tcreditContribution += (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (itemQty < orgAmount)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = orgAmount - itemQty;\r\n\t\t\t\t\t\tcreditContribution -= (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse // addon\r\n\t\t\t\t{\r\n\t\t\t\t\tlet orgAmount = itemQty.getAttribute('data-org_value');\r\n\t\t\t\t\tif (orgAmount < itemQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = itemQty - orgAmount;\r\n\t\t\t\t\t\tcreditConsumed += (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (itemQty < orgAmount)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = orgAmount - itemQty;\r\n\t\t\t\t\t\tcreditContribution -= (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ((isNaN(itemQty) == false))\r\n\t\t\t{\r\n\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\tlet temp_servings = Number($(this).data('servings'));\r\n\t\t\t\tinv_qty = inv_qty - (itemQty * temp_servings);\r\n\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\r\n\t\t\t\tif ($(this).data('dd_type') != 'cts' && ($(this).data('menu_class') != 'Extended Fast Lane' || PlatePointsRulesVersion == 1))\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (itemQty > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet obj = {\r\n\t\t\t\t\t\t\tid: itemId,\r\n\t\t\t\t\t\t\tqty: itemQty,\r\n\t\t\t\t\t\t\tprice: $(this).data('price'),\r\n\t\t\t\t\t\t\tserving_size: $(this).data('servings')\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tsortedCoreItemList.push(obj)\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttotal += itemQty * $(this).data('price');\r\n\r\n\t\t\t\tif ($(this).data('dd_type') != 'cts')\r\n\t\t\t\t{\r\n\t\t\t\t\tentrees += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\tservings += itemQty * $(this).data('servings');\r\n\r\n\t\t\t\t\tif ($(this).data('menu_class') != 'Extended Fast Lane' || PlatePointsRulesVersion == 1)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcore_servings += itemQty * $(this).data('servings');\r\n\t\t\t\t\t\tcoreItemsSubtotal += itemQty * $(this).data('price');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif ($(this).data('pricing_type') == 'FULL')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\twholeQty += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\thalfQty += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif($(this).data('item_is_customizable') == '1'){\r\n\t\t\t\t\t\tcustomizableMealQty += itemQty * $(this).data('item_count_per_item');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tsideDishQty += itemQty;\r\n\t\t\t\t\tsideDishSubTotal += itemQty * $(this).data('price');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ($(this).data('is_bundle') == true)\r\n\t\t\t\t{\r\n\t\t\t\t\tbundlesSubTotal += itemQty * $(this).data('price');\r\n\t\t\t\t\tbundlesQty += itemQty;\r\n\t\t\t\t}\r\n\r\n\t\t\t\titemsSelected[itemId] = itemQty;\r\n\r\n\t\t\t\t$('#sbi_inv_' + entree_id).html(inv_qty);\r\n\t\t\t}\r\n\r\n\t\t\tif ($(this).data('is_bundle') == true)\r\n\t\t\t{\r\n\t\t\t\tupdateSideStationStatus(itemId, itemQty);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\t// bundle support\r\n\t\tlet selectedBundleItemCount = 0;\r\n\t\tlet selectedBundleServingsCount = 0;\r\n\r\n\t\tif (originallyHadBundle)\r\n\t\t{\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t\t\tif ($(this).data('org_value') == \"1\") //was initially chosen\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!$(this).is(\":checked\"))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\t\tinv_qty = inv_qty + $(this).data('servings');\r\n\t\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\r\n\t\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\t\tinv_qty = inv_qty - $(this).data('servings');\r\n\t\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\r\n\t\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{ //bundle is not selected\r\n\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t\t\tif ($(this).data('org_value') == \"1\") //was initially chosen\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\tinv_qty = inv_qty + $(this).data('servings');\r\n\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\t\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\t\tinv_qty = inv_qty - $(this).data('servings');\r\n\t\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// bundle support\r\n\t\tif (bundleIsSelected)\r\n\t\t{\r\n\t\t\ttotal += (bundleInfo.price * 1);\r\n\t\t\twholeQty += selectedBundleItemCount;\r\n\t\t\tservings += selectedBundleServingsCount;\r\n\t\t}\r\n\t}\r\n\r\n\tif (tasteBundleMenuData)\r\n\t{\r\n\t\tif (isDreamTaste || isFundraiser)\r\n\t\t{\r\n\r\n\t\t\t$(\"#OEH_number_core_servings\").html(bundleInfo.number_servings_required);\r\n\r\n\t\t\t// bundle support\r\n\t\t\tlet selectedWholeBundleItemCount = 0;\r\n\t\t\tlet selectedHalfBundleItemCount = 0;\r\n\t\t\tlet selectedBundleServingsCount = 0;\r\n\r\n\t\t\ttotal += Number(bundleInfo.price);\r\n\r\n\t\t\t$(\"[id^='bnd_']\").each(function () {\r\n\r\n\t\t\t\tlet tasteItemQty = $(this).val();\r\n\t\t\t\tif (tasteItemQty > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tservings += ($(this).data('servings') * tasteItemQty);\r\n\t\t\t\t\tif ($(this).data('servings') == 3)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tselectedHalfBundleItemCount += (tasteItemQty * 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tselectedWholeBundleItemCount += (tasteItemQty * 1);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet entree_id = $(this).data('entreeid');\r\n\t\t\t\t\tlet inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\t\tinv_qty = inv_qty - (tasteItemQty * 3);\r\n\t\t\t\t\t$('[data-entree_inventory_remaining=\"' + entree_id + '\"]').text(inv_qty);\r\n\t\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\twholeQty += (selectedWholeBundleItemCount * 1);\r\n\t\t\thalfQty += (selectedHalfBundleItemCount * 1);\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tlet discountablePlatePointsAmount = 0;\r\n\r\n\tif ($(\"#selectedBundle\").is(':checked'))\r\n\t{\r\n\t\t$(\"#max_plate_points_deduction\").html(formatAsMoney(0));\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\r\n\t\t\tif (currentServiceFee > 0)\r\n\t\t\t{\r\n\t\t\t\thasServiceFeeWithMFYCoupon = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\r\n\t\t\tif (currentDeliveryFee > 0)\r\n\t\t\t{\r\n\t\t\t\thasDeliveryFeeWithCoupon = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\t\tlet serviceFee = Number(document.getElementById('subtotal_service_fee').value);\r\n\t\tdiscountablePlatePointsAmount = total + serviceFee.valueOf();\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\r\n\t\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\r\n\t\t\t// adjust the discountablePlatePointsAmount and service to match coupon\r\n\t\t\tdiscountablePlatePointsAmount = formatAsMoney(discountablePlatePointsAmount - currentServiceFee);\r\n\t\t\t$(\"#OEH_subtotal_service_fee\").val(currentServiceFee);\r\n\r\n\t\t\thasServiceFeeWithMFYCoupon = true;\r\n\t\t\tif (discountablePlatePointsAmount < 0)\r\n\t\t\t{\r\n\t\t\t\tdiscountablePlatePointsAmount = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (typeof coupon != 'undefined' && coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\t\t\thasDeliveryFeeWithCoupon = true;\r\n\t\t}\r\n\r\n\t\tneedPlatePointsMaxDiscountChangeWarning = false;\r\n\r\n\t\tif (discountablePlatePointsAmount != lastMaxPPDiscountAmount && lastMaxPPDiscountAmount != -1)\r\n\t\t{\r\n\t\t\tneedPlatePointsMaxDiscountChangeWarning = true;\r\n\t\t}\r\n\r\n\t\tlastMaxPPDiscountAmount = discountablePlatePointsAmount;\r\n\r\n\t\tif (couponlimitedToFT)\r\n\t\t{\r\n\t\t\tlet tempCouponVal = Number(document.getElementById('couponValue').value);\r\n\t\t\tdiscountablePlatePointsAmount -= tempCouponVal;\r\n\t\t\tif (discountablePlatePointsAmount < 0)\r\n\t\t\t{\r\n\t\t\t\tdiscountablePlatePointsAmount = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$(\"#max_plate_points_deduction\").html(formatAsMoney(discountablePlatePointsAmount))\r\n\t}\r\n\r\n\tif (discountablePlatePointsAmount <= 0)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").attr(\"disabled\", \"disabled\");\r\n\t\t$(\"#plate_points_discount\").css({\r\n\t\t\t\"background-color\": \"#c0c0c0\",\r\n\t\t\t\"color\": \"#060606\"\r\n\t\t});\r\n\t\t$(\"#pp_discountable_cost_msg\").show();\r\n\r\n\t}\r\n\telse if (!discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").removeAttr(\"disabled\");\r\n\t\t$(\"#plate_points_discount\").css({\r\n\t\t\t\"background-color\": \"#fff\",\r\n\t\t\t\"color\": \"#000\"\r\n\t\t});\r\n\t\t$(\"#pp_discountable_cost_msg\").hide();\r\n\r\n\t}\r\n\r\n\tlet maxPPCredit = $(\"#plate_points_available\").html() * 1;\r\n\tlet maxPPDeduction = $(\"#max_plate_points_deduction\").html() * 1;\r\n\tlet curPPDiscount = $(\"#plate_points_discount\").val() * 1;\r\n\r\n\tif (maxPPDeduction < curPPDiscount)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").val(maxPPDeduction);\r\n\t}\r\n\r\n\tif (maxPPCredit > maxPPDeduction)\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').hide();\r\n\t}\r\n\r\n\tdiscounted_total = total;\r\n\r\n\tlet addonsSubtotal = 0;\r\n\tlet addonsQty = 0;\r\n\r\n\t//var itemRows = document.getElementById('itemsTbl').rows;\r\n\t//for (i = 0; i < itemRows.length; i++)\r\n\r\n\t$(\"#itemsTbl tr\").each(function () {\r\n\r\n\t\tif (this.id.indexOf('row_') != -1)\r\n\t\t{\r\n\t\t\tlet itemNumber = this.id.substr(4);\r\n\r\n\t\t\tlet qty_str = 'qna_' + itemNumber;\r\n\t\t\tlet prc_str = 'prc_' + itemNumber;\r\n\r\n\t\t\tlet addQty = $('#' + qty_str).val();\r\n\t\t\tlet addonsQtyNumber = Number(addQty);\r\n\t\t\tlet addPrc = $(\"#\" + prc_str).html();\r\n\t\t\tlet addPrcNumber = Number(addPrc);\r\n\t\t\taddonsSubtotal += (Number(addPrc) * addQty);\r\n\t\t\taddonsQty += addonsQtyNumber;\r\n\r\n\t\t\t/// var inv_qty =  Number(document.getElementById('inv_org_' + itemNumber).innerHTML);\r\n\t\t\tlet inv_qty = entreeIDToInventoryMap[itemNumber].remaining;\r\n\r\n\t\t\tinv_qty = inv_qty - addQty;\r\n\t\t\t$('[data-entree_inventory_remaining=\"' + itemNumber + '\"]').text(inv_qty);\r\n\t\t\tentreeIDToInventoryMap[itemNumber].remaining = inv_qty;\r\n\r\n\t\t\tif (isFactoringCredit)\r\n\t\t\t{\r\n\t\t\t\torgAmount = document.getElementById(qty_str).getAttribute('data-org_value');\r\n\t\t\t\tif (orgAmount < addonsQtyNumber)\r\n\t\t\t\t{\r\n\t\t\t\t\tdiff = addonsQtyNumber - orgAmount;\r\n\t\t\t\t\tcreditConsumed += (diff * addPrcNumber);\r\n\t\t\t\t}\r\n\t\t\t\telse if (addQty < orgAmount)\r\n\t\t\t\t{\r\n\t\t\t\t\tdiff = orgAmount - addQty;\r\n\t\t\t\t\tcreditContribution -= (diff * addPrcNumber);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tmain_items_count = halfQty + wholeQty + sideDishQty;\r\n\tcore_items_count = halfQty + wholeQty;\r\n\r\n\tlet totalMealQuantity = Number(halfQty + wholeQty);\r\n\r\n\tlet itemCountLabel = $('#OEH_item_count_label');\r\n\r\n\tlet itemCountAdjustmentAmount = 0;\r\n\tlet displayServingsAdjustment = 0;\r\n\r\n\t// coupon code free meal count contribution\r\n\tlet couponTypeElem = $('#coupon_type');\r\n\tif (couponTypeElem.length && couponTypeElem.val() == 'FREE_MEAL')\r\n\t{\r\n\t\tcfm_size = Number($('#free_entree_servings').val());\r\n\r\n\t\tif (cfm_size > 0)\r\n\t\t{\r\n\t\t\tdisplayServingsAdjustment += cfm_size;\r\n\t\t\titemCountAdjustmentAmount++;\r\n\t\t}\r\n\t}\r\n\r\n\tif (itemCountAdjustmentAmount == 0)\r\n\t{\r\n\t\tdisplayMealCount = introQty + wholeQty + halfQty + sideDishQty + addonsQty;\r\n\t\tdisplayServingCount = servings;\r\n\t\titemCountLabel.html(\"Total Item Count\");\r\n\t}\r\n\telse\r\n\t{\r\n\t\tdisplayMealCount = introQty + wholeQty + sideDishQty + halfQty + itemCountAdjustmentAmount + addonsQty;\r\n\t\tdisplayServingCount = servings + displayServingsAdjustment;\r\n\t\titemCountLabel.html(\"Total # Items (incl. free meals)\");\r\n\t}\r\n\r\n\tif (orderEditSuccess)\r\n\t{\r\n\t\tdisplayMealCount += newAddonQty;\r\n\t}\r\n\r\n\t// update the entree and serving totals display\r\n\t$('#OEH_item_count').html(displayMealCount);\r\n\t$('#OEH_number_servings').html(displayServingCount);\r\n\r\n\tif (typeof (order_minimum) !== 'undefined' && order_minimum.minimum_type == 'ITEM')\r\n\t{\r\n\t\tcore_servings = core_items_count;\r\n\t}\r\n\tlocalStorage.setItem('core-item-count', core_items_count);\r\n\tlocalStorage.setItem('side-item-count', sideDishQty);\r\n\r\n\tif (PlatePointsRulesVersion > 1)\r\n\t{\r\n\t\t$('#OEH_number_core_servings').html(core_servings);\r\n\t}\r\n\r\n\tlet premarkup_total = 0;\r\n\r\n\tlet freeMealValue = 0;\r\n\r\n\t// also must add coupon code free meal\r\n\t// coupon code free meal count contribution\r\n\tcouponTypeElem = $('#coupon_type');\r\n\tif (couponTypeElem.length && couponTypeElem.val() == 'FREE_MEAL')\r\n\t{\r\n\t\tfreeMealValue = Number($('#couponValue').val());\r\n\r\n\t\tif (freeMealValue > 0)\r\n\t\t{\r\n\t\t\tdiscounted_total += freeMealValue;\r\n\t\t}\r\n\t}\r\n\r\n\tdiscounted_total += addonsSubtotal;\r\n\r\n\tif (orderEditSuccess)\r\n\t{\r\n\t\tdiscounted_total += newAddonAmount;\r\n\t}\r\n\r\n\tdiscounted_total = Math.round(discounted_total * 100) / 100;\r\n\r\n\t// --------------------------------------------------------------------- menu items subtotal\r\n\t$('#orderSubTotal').val(formatAsMoney(Math.round(total * 100) / 100));\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney(discounted_total));\r\n\t$('#orderTotal').val(formatAsMoney(discounted_total));\r\n\r\n\t// ------------------------------------------------------ food subtotal\r\n\r\n\tlet miscFoodSubtotal = Number(document.getElementById('misc_food_subtotal').value);\r\n\r\n\t// menu items total plus misc food cost\r\n\tlet food_costs = (discounted_total * 1) + (miscFoodSubtotal * 1);\r\n\t$('#OEH_food_cost_subtotal').html(formatAsMoney((discounted_total * 1) + (miscFoodSubtotal * 1)));\r\n\r\n\tlet newGrandTotal = discounted_total;\r\n\tlet pre_discounts_grand_total = newGrandTotal;\r\n\r\n\t// -------------------------------DISCOUNTS-----------------------------------------\r\n\r\n\tcurPPDiscount = 0;\r\n\t// ----------------------------------------------  PLATEPOINTS Discount\r\n\tif ($('#plate_points_discount').length)\r\n\t{\r\n\t\tcurPPDiscount = $('#plate_points_discount').val();\r\n\t\tif (curPPDiscount * 1 > discountablePlatePointsAmount * 1)\r\n\t\t{\r\n\t\t\tcurPPDiscount = discountablePlatePointsAmount;\r\n\r\n\t\t\tif (curPPDiscount == 0)\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(\"\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$('#plate_points_discount').val(formatAsMoney(curPPDiscount));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//$('#OEH_plate_points_order_discount').html(formatAsMoney(curPPDiscount));\r\n\t\t// This is now done in the taxesd section\r\n\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - curPPDiscount);\r\n\t}\r\n\r\n\t// ---------------------------------------------- Direct Order\r\n\tlet directDiscountVal = Number(0);\r\n\r\n\tdirectDiscount = $('#direct_order_discount');\r\n\r\n\tif (directDiscount.length)\r\n\t{\r\n\t\tdirectDiscountVal = directDiscount.val();\r\n\r\n\t\tif (isNaN(directDiscountVal))\r\n\t\t{\r\n\t\t\tdirectDiscountVal = 0;\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal > food_costs)\r\n\t\t{\r\n\t\t\tdirectDiscountVal = food_costs;\r\n\t\t\tdirectDiscount.val(directDiscountVal);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal)\r\n\t\t{\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - directDiscountVal);\r\n\t\t}\r\n\r\n\t\t$('#OEH_direct_order_discount').html(formatAsMoney(directDiscountVal));\r\n\r\n\t}\r\n\r\n\t// Adjust Bonus Credit and discount\r\n\tif (isFactoringCredit)\r\n\t{\r\n\t\t//alert(creditContribution);\r\n\t\t//alert(creditConsumed);\r\n\t\tcreditBasis += creditContribution;\r\n\t\tcreateBonusCredit(creditConsumed);\r\n\t}\r\n\r\n\t// ------------------------------------------------------------------- coupon Discount\r\n\r\n\tif (couponDiscountMethod == 'PERCENT')\r\n\t{\r\n\r\n\t\tlet CouponCodeStr = $('#coupon_code').val();\r\n\t\tvar newDiscountAmount = 0;\r\n\t\ttry\r\n\t\t{\r\n\t\t\t//this method correctly handles rounding in a way that matches server side\r\n\t\t\tlet formatterUSD = new Intl.NumberFormat('en-US', {\r\n\t\t\t\tminimumFractionDigits: 2,\r\n\t\t\t\tmaximumFractionDigits: 2\r\n\t\t\t});\r\n\t\t\tif (CouponCodeStr == 'VOLUME' || couponlimitedToCore)\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount =  formatterUSD.format(coreItemsSubtotal * (couponDiscountVar / 100))\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = formatterUSD.format(pre_discounts_grand_total * (couponDiscountVar / 100))\r\n\t\t\t}\r\n\t\t}\r\n\t\tcatch(e)\r\n\t\t{\r\n\t\t\t//original way which lead to off-by-one issue compared to server's method of rounding\r\n\t\t\tif (CouponCodeStr == 'VOLUME' || couponlimitedToCore )\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = Math.floor(coreItemsSubtotal * (couponDiscountVar));\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = Math.floor(pre_discounts_grand_total * (couponDiscountVar));\r\n\t\t\t}\r\n\r\n\t\t\tnewDiscountAmount /= 100;\r\n\t\t}\r\n\r\n\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tif (couponlimitedToFT)\r\n\t{\r\n\t\tif (couponDiscountMethod == 'FLAT')\r\n\t\t{\r\n\t\t\tlet newDiscountVal = sideDishSubTotal;\r\n\r\n\t\t\tif (newDiscountVal > couponDiscountVar)\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = couponDiscountVar;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnewDiscountAmount = newDiscountVal;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (couponDiscountMethod == 'PERCENT')\r\n\t\t{\r\n\t\t\tlet newDiscountVal = sideDishSubTotal;\r\n\r\n\t\t\tvar newDiscountAmount = Math.floor(newDiscountVal * (couponDiscountVar));\r\n\r\n\t\t\tnewDiscountAmount /= 100;\r\n\t\t}\r\n\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tlet couponDiscountVal = Number(0);\r\n\tcouponDiscount = $('#couponValue');\r\n\r\n\tif (couponDiscount.length)\r\n\t{\r\n\t\tif (couponDiscount.val() == \"\")\r\n\t\t{\r\n\t\t\tcouponDiscount.val('0.00');\r\n\t\t}\r\n\t\tcouponDiscountVal = couponDiscount.val();\r\n\t}\r\n\r\n\tlet couponDiscountValIsServiceFee = false;\r\n\tlet couponDiscountValIsDeliveryFee = false;\r\n\r\n\tif (typeof coupon != 'undefined')\r\n\t{\r\n\t\tif (coupon.limit_to_mfy_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentServiceFee = $(\"#subtotal_service_fee\").val();\r\n\t\t\tif (couponDiscountVal != currentServiceFee)\r\n\t\t\t{\r\n\t\t\t\tcouponDiscountVal = currentServiceFee;\r\n\t\t\t}\r\n\r\n\t\t\tcouponDiscountValIsServiceFee = true;\r\n\t\t}\r\n\r\n\t\tif (coupon.limit_to_delivery_fee == '1' && coupon.discount_method == 'FLAT')\r\n\t\t{\r\n\t\t\tlet currentDeliveryFee = $(\"#subtotal_delivery_fee\").val();\r\n\t\t\tif (couponDiscountVal != currentDeliveryFee)\r\n\t\t\t{\r\n\t\t\t\tif(parseFloat(couponDiscountVal) > parseFloat(currentDeliveryFee)){\r\n\t\t\t\t\tcouponDiscountVal = currentDeliveryFee;\r\n\t\t\t\t\tcouponDiscountValIsDeliveryFee = true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//couponDiscountValIsDeliveryFee = true;\r\n\t\t}\r\n\r\n\t\tif (coupon.limit_to_recipe_id == '1')\r\n\t\t{\r\n\t\t\tlet prc_str = $('#prc_' + coupon.menu_item_id).text();\r\n\r\n\t\t\tif (coupon.discount_method == 'FLAT')\r\n\t\t\t{\r\n\t\t\t\tif (prc_str > coupon.discount_var)\r\n\t\t\t\t{\r\n\t\t\t\t\tcouponDiscountVal = formatAsMoney(prc_str - coupon.discount_var);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tcouponDiscountVal = formatAsMoney(prc_str);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (coupon.discount_method == 'PERCENT')\r\n\t\t\t{\r\n\t\t\t\tcouponDiscountVal = formatAsMoney(prc_str * (coupon.discount_var / 100));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$('#couponValue').val(couponDiscountVal);\r\n\t}\r\n\r\n\tif (couponDiscountVal)\r\n\t{\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - couponDiscountVal);\r\n\t\t$('#OEH_coupon_discount').html(formatAsMoney(couponDiscountVal));\r\n\t}\r\n\r\n\t// ------------------------------------------------ Preferred Customer\r\n\tlet PUDElem = $('#PUDnoUP');\r\n\tlet UPDiscountElem;\r\n\tif (PUDElem.length && !bundleIsSelected)\r\n\t{\r\n\t\tlet selectedUP = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\t\tif (selectedUP == null || selectedUP == \"\")\r\n\t\t{\r\n\t\t\tselectedUP = \"noUP\";\r\n\t\t}\r\n\r\n\t\tlet UPDiscount = -1;\r\n\r\n\t\tlet UPType = 'none';\r\n\t\tlet PcntTypeValue = 0.0;\r\n\r\n\t\tif (originalUP != false || activeUP != false)\r\n\t\t{\r\n\t\t\tlet preferredData = false;\r\n\r\n\t\t\tif (selectedUP == \"activeUP\")\r\n\t\t\t{\r\n\t\t\t\tpreferredData = activeUP;\r\n\t\t\t}\r\n\t\t\telse if (selectedUP == \"originalUP\")\r\n\t\t\t{\r\n\t\t\t\tpreferredData = originalUP;\r\n\t\t\t}\r\n\r\n\t\t\tlet preferredCapRemaining = preferredData.preferred_cap_value;\r\n\r\n\t\t\tif (capacityUP.remainingObj.countRemaining !== null)\r\n\t\t\t{\r\n\t\t\t\tpreferredCapRemaining = capacityUP.remainingObj.countRemaining\r\n\t\t\t}\r\n\r\n\t\t\tif (preferredData.type == \"FLAT\")//Only allows ITEMS type\r\n\t\t\t{\r\n\r\n\t\t\t\tif ((preferredData.preferred_cap_type == 'ITEMS' && totalMealQuantity <= preferredCapRemaining) ||\r\n\t\t\t\t\tpreferredData.preferred_cap_type == 'NONE')\r\n\t\t\t\t{\r\n\t\t\t\t\tlet cost = (wholeQty - PUDExcludedFullItemsCount) * preferredData.value;\r\n\t\t\t\t\tlet halfCost = Number(formatAsMoney(((halfQty - PUDExcludedHalfItemsCount) * (preferredData.value / 2))));\r\n\t\t\t\t\tcost += halfCost;\r\n\t\t\t\t\tlet basis = discounted_total - cost - addonsSubtotal - productsSubTotal - PUDExcludedItemsTotal;\r\n\t\t\t\t\tif (preferredData.include_sides === '0')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbasis -= sideDishSubTotal;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tUPDiscount = formatAsMoney(basis);\r\n\t\t\t\t\tUPType = 'flat';\r\n\t\t\t\t}else if((preferredData.preferred_cap_type == 'ITEMS' && totalMealQuantity > preferredCapRemaining)){\r\n\r\n\t\t\t\t\tlet cost = 0;\r\n\t\t\t\t\tlet halfCost = 0;\r\n\t\t\t\t\tlet itemCount = 0;\r\n\t\t\t\t\tsortedCoreItemList.sort((a, b) => (a.price < b.price) ? 1 : -1);\r\n\t\t\t\t\tfor(let i = 0; i < totalMealQuantity; i++){\r\n\t\t\t\t\t\titemCount += sortedCoreItemList[i].qty;\r\n\t\t\t\t\t\tif(itemCount <= preferredCapRemaining){\r\n\t\t\t\t\t\t\tif(sortedCoreItemList[i].serving_size > 5)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tcost += sortedCoreItemList[i].qty * preferredData.value;\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\thalfCost += Number(formatAsMoney(((sortedCoreItemList[i].qty - PUDExcludedHalfItemsCount) * (preferredData.value / 2))))\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tcost += sortedCoreItemList[i].qty * sortedCoreItemList[i].price;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tcost += halfCost;\r\n\r\n\r\n\t\t\t\t\tlet basis = discounted_total - cost - addonsSubtotal - productsSubTotal - PUDExcludedItemsTotal;\r\n\t\t\t\t\tif (preferredData.include_sides === '0')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbasis -= sideDishSubTotal;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tUPDiscount = formatAsMoney(basis);\r\n\t\t\t\t\tUPType = 'flat';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (preferredData.type == \"PERCENT\")\r\n\t\t\t{\r\n\t\t\t\tif ((preferredData.preferred_cap_type == 'ITEMS' && totalMealQuantity <= preferredCapRemaining) ||\r\n\t\t\t\t\t(preferredData.preferred_cap_type == 'SERVINGS' && servings <= preferredCapRemaining) ||\r\n\t\t\t\t\tpreferredData.preferred_cap_type == 'NONE')\r\n\t\t\t\t{\r\n\t\t\t\t\tlet basis = pre_discounts_grand_total - addonsSubtotal - productsSubTotal;\r\n\t\t\t\t\tif (preferredData.include_sides === '0')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbasis -= sideDishSubTotal;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlet multiplier = preferredData.value / 100;\r\n\t\t\t\t\tlet pud_result = basis * multiplier;\r\n\t\t\t\t\tlet rounded_pud_result = dd_round_amount(pud_result);\r\n\t\t\t\t\tUPDiscount = formatAsMoney(rounded_pud_result);\r\n\t\t\t\t\tUPType = 'pcnt';\r\n\t\t\t\t\tPcntTypeValue = preferredData.value / 100;\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (selectedUP == \"noUP\")\r\n\t\t{\r\n\t\t\tUPDiscount = 0;\r\n\t\t}\r\n\r\n\t\tif (UPType == 'flat')\r\n\t\t{\r\n\t\t\tif (typeof promoVal != 'undefined' && promoVal > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= promoVal;\r\n\t\t\t}\r\n\r\n\t\t\tif (freeMealValue > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= freeMealValue;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (UPType == 'pcnt')\r\n\t\t{\r\n\t\t\tif (typeof promoVal != 'undefined' && promoVal > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= (promoVal * PcntTypeValue);\r\n\t\t\t\tUPDiscount = Math.round(UPDiscount * 100) / 100;\r\n\t\t\t}\r\n\r\n\t\t\tif (freeMealValue > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= (freeMealValue * PcntTypeValue);\r\n\t\t\t\tUPDiscount = Math.round(UPDiscount * 100) / 100;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (UPDiscount != -1)\r\n\t\t{\r\n\t\t\tUPDiscountElem = $('#OEH_preferred');\r\n\t\t\tif (UPDiscountElem.length)\r\n\t\t\t{\r\n\t\t\t\tUPDiscountElem.html(formatAsMoney(UPDiscount));\r\n\t\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - UPDiscount);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// ----------------------------------------------------------Membership Discount\r\n\r\n\tif (orderIsEligibleForMembershipDiscount && storeSupportsMembership)\r\n\t{\r\n\t\tlet couponAdjustment = Number(0);\r\n\t\tif (couponDiscountValIsServiceFee || couponDiscountValIsDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponAdjustment = couponDiscountVal;\r\n\t\t}\r\n\r\n\t\tlet membership_discount_basis = Number((newGrandTotal * 1) + (couponAdjustment * 1));\r\n\t\tlet memberDiscountAmount = Number(membership_discount_basis * (membership_status.discount_var / 100));\r\n\t\tmemberDiscountAmount = Math.round(memberDiscountAmount * 100) / 100;\r\n\r\n\t\t$(\"#OEH_membership_discount\").html(formatAsMoney(memberDiscountAmount));\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - memberDiscountAmount);\r\n\r\n\t}\r\n\r\n\t// -------------------------------------------------------- Session Discount\r\n\r\n\tSessDisc = $('#SessDiscnoSD');\r\n\tif (SessDisc.length && !orderIsEligibleForMembershipDiscount)\r\n\t{\r\n\t\tlet couponAdjustment = Number(0);\r\n\t\tif (couponDiscountValIsServiceFee || couponDiscountValIsDeliveryFee)\r\n\t\t{\r\n\t\t\tcouponAdjustment = couponDiscountVal;\r\n\t\t}\r\n\r\n\t\tlet session_discount_basis = Number((newGrandTotal * 1) + (directDiscountVal * 1) + (miscFoodSubtotal * 1) + (couponAdjustment * 1));\r\n\r\n\t\tlet selectedSD = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\t\tif (selectedSD == null || selectedSD == \"\")\r\n\t\t{\r\n\t\t\tselectedSD = \"noSD\";\r\n\t\t}\r\n\r\n\t\tlet sessionDiscount = -1;\r\n\r\n\t\tif (selectedSD == \"originalSD\")\r\n\t\t{\r\n\r\n\t\t\tlet rawAmount = (session_discount_basis * originalSD.value) / 100;\r\n\t\t\trawAmount += .00000001; // salt to avoid rounding error\r\n\t\t\t// can't do this in formatAsMoney without a full validation of order manager as odd things happen\r\n\t\t\tsessionDiscount = formatAsMoney(rawAmount);\r\n\t\t}\r\n\t\telse if (selectedSD == \"activeSD\")\r\n\t\t{\r\n\t\t\tsessionDiscount = formatAsMoney((session_discount_basis * activeSessionDiscount.value) / 100);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsessionDiscount = 0;\r\n\t\t}\r\n\r\n\t\tSDiscountElem = $('#OEH_session_discount');\r\n\t\tif (SDiscountElem.length)\r\n\t\t{\r\n\t\t\tSDiscountElem.html(formatAsMoney(sessionDiscount));\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - sessionDiscount);\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (miscFoodSubtotal * 1));\r\n\t$('#OEH_misc_food_subtotal').html(formatAsMoney(miscFoodSubtotal));\r\n\r\n\tlet miscNonFoodSubtotal = Number($('#misc_nonfood_subtotal').val());\r\n\t$('#OEH_misc_nonfood_subtotal').html(formatAsMoney(miscNonFoodSubtotal));\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (miscNonFoodSubtotal * 1));\r\n\r\n\tlet serviceFee = Number($('#subtotal_service_fee').val());\r\n\t$('#OEH_subtotal_service_fee').html(formatAsMoney(serviceFee));\r\n\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (serviceFee * 1));\r\n\r\n\tlet deliveryFee = Number(0);\r\n\tif ($('#subtotal_delivery_fee')[0])\r\n\t{\r\n\t\tdeliveryFee = Number($('#subtotal_delivery_fee').val());\r\n\t\t$('#OEH_subtotal_delivery_fee').html(formatAsMoney(deliveryFee));\r\n\r\n\t\tnewGrandTotal = Number((newGrandTotal * 1) + (deliveryFee * 1));\r\n\t}\r\n\r\n\tlet BagFeeTotal = Number(0);\r\n\t// Bag Fees\r\n\tif (storeSupportsBagFees)\r\n\t{\r\n\t\tlet calculatedBagCount = getNumberBagsRequiredFromItems(halfQty + wholeQty, sideDishQty);\r\n\r\n\t\tif (!$(\"#opted_to_bring_bags\").is(\":checked\"))\r\n\t\t{\r\n\t\t\t$(\"#total_bag_count\").prop(\"disabled\", false);\r\n\r\n\t\t\tif (bagCountLockedToField)\r\n\t\t\t{\r\n\t\t\t\tnumBagsRequired = $(\"#total_bag_count\").val();\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnumBagsRequired = calculatedBagCount;\r\n\t\t\t\t$(\"#total_bag_count\").val(calculatedBagCount);\r\n\t\t\t}\r\n\r\n\t\t\tif (isNaN(numBagsRequired))\r\n\t\t\t{\r\n\t\t\t\tnumBagsRequired = 0;\r\n\t\t\t}\r\n\r\n\t\t\tBagFeeTotal = storeDefaultBagFee * numBagsRequired;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#total_bag_count\").prop(\"disabled\", \"disabled\");\r\n\t\t\t$(\"#total_bag_count\").val(\"0\");\r\n\t\t}\r\n\r\n\t\t$(\"#OEH_subtotal_bag_fee\").html(formatAsMoney(BagFeeTotal));\r\n\r\n\t}\r\n\tlet mealCustomizationFeeTotal = 0;\r\n\t// Meal Customization Fees\r\n\tif (storeSupportsMealCustomization)\r\n\t{\r\n\r\n\t\tif($('#manual_customization_fee').val() == 'true')\r\n\t\t{\r\n\t\t\t//use manually entered value\r\n\t\t\tmealCustomizationFeeTotal = Number($(\"#subtotal_meal_customization_fee\").val());\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tmealCustomizationFeeTotal =  calculateMealCustomizationFee(customizableMealQty);\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").val(formatAsMoney(mealCustomizationFeeTotal));\r\n\t\t}\r\n\r\n\t\tif ($(\"#opted_to_customize_recipes\").is(\":checked\"))\r\n\t\t{\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").prop(\"disabled\", \"disabled\");\r\n\t\t\t$(\"#subtotal_meal_customization_fee\").val(\"\");\r\n\t\t\tmealCustomizationFeeTotal = 0;\r\n\t\t\t$(\"#customization-row-container\").hide();\r\n\t\t}\r\n\r\n\t\t$(\"#OEH_subtotal_meal_customization_fee\").html(formatAsMoney(mealCustomizationFeeTotal));\r\n\t}\r\n\r\n\t// --------------------------------------------------------------------- tax\r\n\r\n\t// Currently the only taxed product is the enrollment fee which is taxed at a special rate\r\n\tlet newNonFoodTax = formatAsMoney(miscNonFoodSubtotal * (curNonFoodTax / 100));\r\n\tlet enrollmentTax = formatAsMoney(productsSubTotal * (curEnrollmentTax / 100));\r\n\r\n\tlet newDeliveryTax = 0;\r\n\tif (!hasDeliveryFeeWithCoupon)\r\n\t{\r\n\t\tnewDeliveryTax = formatAsMoney(deliveryFee * (curDeliveryTax / 100));\r\n\t}\r\n\r\n\tnewNonFoodTax *= 1; // convert to float\r\n\tnewNonFoodTax += (enrollmentTax * 1);\r\n\t//TODO: will have other products than enrollment someday.\r\n\tif (productsSubTotal)\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food & Enrollment Tax');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food Tax');\r\n\r\n\t}\r\n\r\n\tlet newFoodTax = 0;\r\n\tlet newServiceTax = 0;\r\n\r\n\tif (curPPDiscount > 0)\r\n\t{\r\n\t\tlet food_portion_of_points_credit = 0;\r\n\t\tlet fee_portion_of_points_credit = 0;\r\n\r\n\t\tif (hasServiceFeeWithMFYCoupon)\r\n\t\t{\r\n\t\t\tfood_portion_of_points_credit = curPPDiscount;\r\n\t\t\tfee_portion_of_points_credit = 0;\r\n\t\t}\r\n\t\telse if (discountMFYFeeFirst && serviceFee > 0)\r\n\t\t{\r\n\r\n\t\t\tif (curPPDiscount > serviceFee)\r\n\t\t\t{\r\n\t\t\t\tfood_portion_of_points_credit = curPPDiscount - serviceFee;\r\n\t\t\t\tfee_portion_of_points_credit = serviceFee;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tfee_portion_of_points_credit = curPPDiscount;\r\n\t\t\t\tfood_portion_of_points_credit = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tlet foodPortionOfMaxDeduction = discountablePlatePointsAmount - serviceFee;\r\n\r\n\t\t\tif (curPPDiscount > foodPortionOfMaxDeduction)\r\n\t\t\t{\r\n\t\t\t\tlet remainderAfterFoodDiscount = curPPDiscount - foodPortionOfMaxDeduction;\r\n\t\t\t\tfood_portion_of_points_credit = foodPortionOfMaxDeduction;\r\n\t\t\t\tfee_portion_of_points_credit = remainderAfterFoodDiscount;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tfood_portion_of_points_credit = curPPDiscount;\r\n\t\t\t\tfee_portion_of_points_credit = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (hasServiceFeeWithMFYCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - food_portion_of_points_credit - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewServiceTax = 0;\r\n\t\t}\r\n\t\telse if (hasDeliveryFeeWithCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - food_portion_of_points_credit - serviceFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewDeliveryTax = 0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - serviceFee - food_portion_of_points_credit - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tlet mealCustomizationFee = Number($('#subtotal_meal_customization_fee').val())\r\n\t\t\tif (isNaN(mealCustomizationFee)) { mealCustomizationFee = 0;}\r\n\t\t\tnewServiceTax = formatAsMoney(((((serviceFee + mealCustomizationFee) - fee_portion_of_points_credit)) * (curServiceTax / 100)) + .000001);\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_food').html(formatAsMoney(food_portion_of_points_credit));\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(fee_portion_of_points_credit));\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif (hasServiceFeeWithMFYCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewServiceTax = 0;\r\n\t\t}\r\n\t\telse if (hasDeliveryFeeWithCoupon)\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - serviceFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tnewDeliveryTax = 0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - serviceFee - deliveryFee) * (curFoodTax / 100)) + .000001);\r\n\t\t\tlet mealCustomizationFee = Number($('#subtotal_meal_customization_fee').val())\r\n\t\t\tif (isNaN(mealCustomizationFee)) { mealCustomizationFee = 0;}\r\n\t\t\tnewServiceTax = formatAsMoney((serviceFee + mealCustomizationFee) * (curServiceTax / 100) + .000001);\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_food').html(formatAsMoney(0));\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(0));\r\n\t}\r\n\r\n\tlet newBagFeeTax = formatAsMoney(BagFeeTotal * (curBagFeeTax / 100) + .000001);\r\n\r\n\ttaxElem = document.getElementById('OEH_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newNonFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_food_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newFoodTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_service_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newServiceTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_delivery_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newDeliveryTax);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_bag_fee_tax_subtotal');\r\n\tif (taxElem)\r\n\t{\r\n\t\ttaxElem.innerHTML = formatAsMoney(newBagFeeTax);\r\n\t}\r\n\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (BagFeeTotal * 1) + (mealCustomizationFeeTotal * 1));\r\n\r\n\tlet preTaxTotal = Number(newGrandTotal);\r\n\tnewGrandTotal = (newGrandTotal * 1) + (newFoodTax * 1) + (newNonFoodTax * 1) + (newServiceTax * 1) + (newDeliveryTax * 1) + (newBagFeeTax * 1);\r\n\r\n\t/*\r\n\t * *\r\n\t * LTD ROUND UP, MUST BE AFTER GRAND TOTAL\r\n\t * *\r\n\t */\r\n\tlet round_up_donation = 0;\r\n\r\n\tlet subtotal_round_up = Math.ceil(newGrandTotal);\r\n\tlet subtotal_round_up_diff = parseFloat((subtotal_round_up - (newGrandTotal)).toFixed(2));\r\n\r\n\tif (subtotal_round_up_diff == 0)\r\n\t{\r\n\t\tsubtotal_round_up_diff = 1.00;\r\n\t}\r\n\r\n\tif ($('#round_up_nearest_dollar').val() != subtotal_round_up_diff)\r\n\t{\r\n\t\t$('#round_up_nearest_dollar').val(subtotal_round_up_diff).text('$ ' + formatAsMoney(subtotal_round_up_diff));\r\n\t\t$('#add_ltd_round_up').trigger('change');\r\n\t}\r\n\r\n\tif ($('#add_ltd_round_up').is(':checked'))\r\n\t{\r\n\t\tif ($('#ltd_round_up_select').find(':selected').attr('id') == 'round_up_nearest_dollar')\r\n\t\t{\r\n\t\t\tround_up_donation = subtotal_round_up_diff;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tround_up_donation = parseFloat($('#ltd_round_up_select').val());\r\n\t\t}\r\n\t}\r\n\r\n\tif (isNaN(round_up_donation))\r\n\t{\r\n\t\tround_up_donation = 0;\r\n\t}\r\n\r\n\t$('#OEH_ltd_round_up').html(formatAsMoney(round_up_donation));\r\n\r\n\tnewGrandTotal += Number(round_up_donation);\r\n\t/*\r\n\t * end Round UP\r\n\t */\r\n\r\n\t// -------------------------------------------------------------------- grand total\r\n\t$('#OEH_grandtotal').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_new_total').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_delta').html(formatAsMoney((orderInfoGrandTotal - newGrandTotal) * -1));\r\n\r\n\tlet paymentTotal = 0;\r\n\tif ($('#OEH_paymentsTotal').length)\r\n\t{\r\n\t\tpaymentTotal = $('#OEH_paymentsTotal').html();\r\n\t}\r\n\r\n\tlet remainingBalance = Number(formatAsMoney(paymentTotal - newGrandTotal));\r\n\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance * -1));\r\n\r\n\t// Values are now calculated and the summary display updated\r\n\t// Next Display \"balance\" messages and set up payments\r\n\r\n\tif (orderState == 'CANCELLED')\r\n\t{\r\n\t\tremainingBalance = paymentTotal;\r\n\t\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance));\r\n\r\n\t}\r\n\r\n\tif (remainingBalance > 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to the customer.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_customer_owed');\r\n\t\t$(\"#newPaymentDiv\").hide();\r\n\r\n\t\tif (canAdjustDelayedPayment && currentDPAmount > 0)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').show();\r\n\t\t}\r\n\r\n\t\t$('#payment1_type').val('');\r\n\t\t$('#payment2_type').val('');\r\n\t\tchangePayment1('');\r\n\t\tchangePayment2('');\r\n\r\n\t\tpaymentChanges = true;\r\n\r\n\t\t$(\"#use_store_credits\").prop('checked', false);\r\n\t\t$(\"#use_store_credits\").prop('disabled', true);\r\n\r\n\t}\r\n\telse if (remainingBalance < 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to your store.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_store_owed');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tlet doNewLivePaymentAdjustments = true;\r\n\t\tif (doNewLivePaymentAdjustments)\r\n\t\t{\r\n\r\n\t\t\tlet defaultPaymentAmount = remainingBalance * -1;\r\n\r\n\t\t\tif ($(\"#use_store_credits\").is(\":checked\"))\r\n\t\t\t{\r\n\r\n\t\t\t\tlet amountStoreCredit = Number($(\"#store_credits_amount\").val());\r\n\t\t\t\tif (isNaN(amountStoreCredit.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tamountStoreCredit = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount -= amountStoreCredit.valueOf();\r\n\t\t\t}\r\n\r\n\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount);\r\n\r\n\t\t\tif ($('#payment1_type').val() == 'CC')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val() == 'CHECK')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if (($('#payment1_type').val() == 'GIFT_CERT' || $('#payment1_type').val() == \"GIFT_CARD\") && $('#payment2_type').val() != \"\")\r\n\t\t\t{\r\n\t\t\t\tlet payment1Amount = null;\r\n\t\t\t\tif ($('#payment1_type').val() == 'GIFT_CERT')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#payment1_gc_total_amount').val());\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment1_type').val() == 'GIFT_CARD')\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#debit_gift_card_amount').val());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isNaN(payment1Amount.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount - payment1Amount.valueOf());\r\n\t\t\t\tif ($('#payment2_type').val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CHECK')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val() == 'CASH')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_cash_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\t\t\t\telse if ($('#payment2_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#payment2_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse // == 0\r\n\t{\r\n\t\t$(\"#balance_msg\").html(\"0.00\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_balanced');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tassignBalanceToRefTransactions(0);\r\n\t}\r\n\r\n\tif (newGrandTotal == 0 && $('#payment1_type').val() == \"\" && $('#payment2_type').val() == \"\" && !onTimeShotAtSupplyingZeroPaymentHasOccurred && orderState == 'SAVED')\r\n\t{\r\n\t\t$('#payment1_type').val('CASH');\r\n\t\tchangePayment1('CASH');\r\n\t\t$('#payment1_cash_total_amount').val(\"0.00\");\r\n\r\n\t\tonTimeShotAtSupplyingZeroPaymentHasOccurred = true;\r\n\t}\r\n\r\n\tlet autoAdjustDiv = $('#autoAdjustDiv');\r\n\tif (autoAdjustDiv.length)\r\n\t{\r\n\r\n\t\tif (remainingBalance != 0 && canAutoAdjust)\r\n\t\t{\r\n\t\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || remainingBalance < 0))\r\n\t\t\t{\r\n\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>adjust customer's delayed payment.</b></span>\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (remainingBalance > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>credit customer's credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>charge original credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tautoAdjustDiv.show();\r\n\t\t\tif (!forceManualAutoAdjust)\r\n\t\t\t{\r\n\t\t\t\t$('#autoAdjust').prop('checked', true);\r\n\t\t\t\thandleAutoAdjust($('#autoAdjust').get()[0]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// if the div is hidden skip these steps\r\n\r\n\t\t\tif (autoAdjustDiv.is(\":visible\"))\r\n\t\t\t{\r\n\t\t\t\tautoAdjustDiv.hide();\r\n\t\t\t\t$('#autoAdjust').prop('checked', false);\r\n\t\t\t\t$('#payment1_type').val('');\r\n\t\t\t\t$('#payment2_type').val('');\r\n\t\t\t\tchangePayment1('');\r\n\t\t\t\tchangePayment2('');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$('#help_msg').html(\"\");\r\n\r\n\t// enforce a few rules by disallowing checkout\r\n\tif ($('#submit_changes').length)\r\n\t{\r\n\r\n\t\tif (servings > 0 || sideDishQty > 0 || addonsSubtotal > 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", false);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal >= (Number(preTaxTotal) + Number(directDiscountVal)) && preTaxTotal != 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t\t$('#help_msg').html($('#help_msg').html() + \"You cannot use a Direct Order Discount that is equal to or greater than the food cost total. Please use the \\\"No Charge\\\" payment type to give away an order.\");\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($('#help_msg').length)\r\n\t{\r\n\t\tif ($('#help_msg').html() != \"\")\r\n\t\t{\r\n\t\t\t$('#help_msg').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#help_msg').hide();\r\n\t\t}\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n\r\n\tHideLineItemsIfZero();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n}\r\n\r\n$(document).on('focusin', '.bundle-subitem-qty', function (e) {\r\n\r\n\t$(this).data('org_val', $(this).val());\r\n\r\n}).on('keyup change', '.bundle-subitem-qty', function (e) {\r\n\r\n\tlet canIncrement = canIncrementBundleSubItem($(this), '.bundle-subitem-qty');\r\n\r\n\tif (canIncrement !== true)\r\n\t{\r\n\t\t$(this).val($(this).data('org_val'));\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Max Items Reached',\r\n\t\t\tmessage: canIncrement\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(this).data('org_val', $(this).val());\r\n\r\n\t\tqtyUpdate(this);\r\n\t}\r\n\r\n\tcalculateTotal();\r\n\r\n});\r\n\r\nfunction canIncrementBundleSubItem(input, selector)\r\n{\r\n\tlet mid = $(input).data('menu_item_id');\r\n\tlet pid = $(input).data('parent_item');\r\n\r\n\tlet itemInfo = sideStationBundleInfo[pid].bundle[mid];\r\n\tlet parentItemInfo = sideStationBundleInfo[pid];\r\n\tlet parentNumItemsRequired = parseInt(parentItemInfo.number_items_required);\r\n\tlet groupID = parseInt(itemInfo.bundle_to_menu_item_group_id) || 0;\r\n\r\n\t// check that we aren't going over the total\r\n\tlet total_org = 0;\r\n\tlet total_current = 0;\r\n\tlet groupInfo = [];\r\n\r\n\t$(selector + '[data-parent_item=\"' + pid + '\"]').each(function () {\r\n\r\n\t\tlet mid = $(this).data('menu_item_id');\r\n\t\tlet pid = $(this).data('parent_item');\r\n\r\n\t\tlet inputItemInfo = sideStationBundleInfo[pid].bundle[mid];\r\n\t\tlet inputGroupID = parseInt(inputItemInfo.bundle_to_menu_item_group_id) || 0;\r\n\r\n\t\tlet this_org = parseInt($(this).data('org_val')) || 0;\r\n\t\tlet this_cur = parseInt($(this).val()) || 0;\r\n\r\n\t\ttotal_org += this_org;\r\n\t\ttotal_current += this_cur;\r\n\r\n\t\tif (typeof groupInfo[inputGroupID] == 'undefined')\r\n\t\t{\r\n\t\t\tgroupInfo[inputGroupID] = {\r\n\t\t\t\ttotal_org: 0,\r\n\t\t\t\ttotal_current: 0\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tgroupInfo[inputGroupID].total_org += this_org;\r\n\t\tgroupInfo[inputGroupID].total_current += this_cur;\r\n\r\n\t});\r\n\r\n\t// check if over the bundle total\r\n\tif (total_current > (parentNumItemsRequired * parseInt($('#qty_' + pid).val())))\r\n\t{\r\n\t\treturn 'Number of items for the bundle has been reached';\r\n\t}\r\n\r\n\t// check if over the group total\r\n\tif (parentItemInfo.bundle_groups.length > 0)\r\n\t{\r\n\t\tif (groupInfo[groupID].total_current > (parseInt(parentItemInfo.bundle_groups[groupID].number_items_required) * parseInt($('#qty_' + pid).val())))\r\n\t\t{\r\n\t\t\treturn 'Number of items for the group has been reached';\r\n\t\t}\r\n\t}\r\n\r\n\t// all else\r\n\treturn true;\r\n\r\n}\r\n\r\n\r\nfunction preferenceChangeListener(pref, setting, user, callback){\r\n\r\n\tpref = pref.toUpperCase();\r\n\tlet pref_value = USER_PREFERENCES[pref].value;\r\n\r\n\tif ($.isPlainObject(pref_value) && $.isPlainObject(setting))\r\n\t{\r\n\t\tsetting = JSON.stringify($.extend(USER_PREFERENCES[pref].value, setting));\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetting = setting.toString()\r\n\t}\r\n\r\n\tif(pref.includes('_DETAILS')){\r\n\t\tlet key = 'MEAL_EXCLUDE_'+pref.replace('MEAL_','').replace('_DETAILS','');\r\n\t\tmeal_customization_preferences[key].details = setting;\r\n\t}else{\r\n\t\tmeal_customization_preferences[pref].value = setting;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_orderCustomization',\r\n\t\t\top: 'update_order_meal_customization',\r\n\t\t\torder_id: order_id,\r\n\t\t\tcustomizations: JSON.stringify(meal_customization_preferences)\r\n\t\t},\r\n\t\tsuccess: function (json) {\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tif(json.cost > 0){\r\n\t\t\t\t\t$('#customization-fee-row').show();\r\n\t\t\t\t\t$('#MealCustomizationFeeRow').show();\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$('#customization-fee-row').hide();\r\n\t\t\t\t\t$('#MealCustomizationFeeRow').hide();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif($('#manual_customization_fee').val() != 'true')\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#subtotal_meal_customization_fee').val(formatAsMoney(json.cost));\r\n\t\t\t\t\t$(\"#OEH_subtotal_meal_customization_fee\").html(formatAsMoney(json.cost));\r\n\t\t\t\t}\r\n\t\t\t\thandleMealCustomizationFeeInput();\r\n\r\n\t\t\t\tif(typeof callback !== 'undefined'){\r\n\t\t\t\t\tcallback(json);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Unexpected error: ' + strError\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\n$(document).on('change', '#shipping_phone_number', function (e) {\r\n\r\n\t$('.shipping_phone_number_new_div').hideFlex();\r\n\t$('#shipping_phone_number_new').prop('required', false);\r\n\r\n\tif ($(this).val() == 'new')\r\n\t{\r\n\t\t$('.shipping_phone_number_new_div').showFlex();\r\n\t\t$('#shipping_phone_number_new').prop('required', true);\r\n\r\n\t}\r\n});\r\n\r\n$(document).on('change', '#hide-zero-sides', function (e) {\r\n\r\n\tif ($(this).is(':checked'))\r\n\t{\r\n\t\t$('#sidesTbl [data-orig-remaining=\"0\"]').hideFlex();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#sidesTbl [data-orig-remaining]').showFlex();\r\n\t}\r\n});\r\n\r\n$(document).on('change keyup', '.delivery-input', function (e) {\r\n\r\n\tdeliveryChanges = false;\r\n\r\n\t$('.delivery-input').each(function () {\r\n\r\n\t\tif ($(this).data('org_value'))\r\n\t\t{\r\n\t\t\tlet val = $(this).val();\r\n\t\t\tlet org_value = $(this).data('org_value');\r\n\r\n\t\t\tif (val != org_value)\r\n\t\t\t{\r\n\t\t\t\tdeliveryChanges = true;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n});\r\n\r\nfunction costInputFeesTab(obj)\r\n{\r\n\t// TODO: validation\r\n\r\n\tsetFeesTabAsDirty();\r\n\r\n\tcalculateTotal();\r\n}\r\n\r\nfunction setFeesTabAsDirty()\r\n{\r\n\tfeesTabIsDirty = true;\r\n}"],"names":["itemChanges","feeChanges","discountOrPaymentChanges","deliveryChanges","discountChanges","reportingChanges","paymentChanges","initialSessionDiscountSetting","initialPreferredUserDiscountSetting","changeList","isFactoringCredit","currentCreditAvailable","stationNeedsAttention","relatedOrdersAreLoaded","currentlySavingOrder","onTimeShotAtSupplyingZeroPaymentHasOccurred","needPlatePointsMaxDiscountChangeWarning","lastMaxPPDiscountAmount","let","feesTabIsDirty","admin_order_mgr_init","store_id","STORE_DETAILS","id","orderState","setupForNewOrder","setupForSavedOrder","setupForActiveOrder","hasBundle","bundleSetup","setupSiteAdminFunctions","initChangeList","calculateTotal","setAllPaymentFieldsToUnrequired","setupCouponState","setUpKeyHandlers","getQueryVariable","query","window","location","search","substring","vars","split","newQueryString","first","i","length","pair","historyPush","url","handle_special_instruction_notes","handle_cancel_order","handle_delete_saved_order","handle_free_menu_item_edit","handle_fundraiser_selection","handle_ltd_round_up","handleDirectOrderDiscountFocusing","$","trigger","handleAutoOrderButtons","initNoInventoryRows","handleDinnerDollarAccordion","handleAdminNoteAccordion","setMealCustomizationDefault","default_meal_customization_to_selected","prop","click","$header","this","$content","html","is","slideToggle","each","remaining","data","servings","entree_id","$itemCount","val","find","addClass","hide","e","size","on","countMissedMeals","entreeID","curInventory","entreeIDToInventoryMap","dd_message","title","message","setItemTabAsDirty","preventDefault","intenseLoggingOn","focus","select","blur","curVal","trim","isNaN","intenseLogging","console","log","saveSpecialInstructions","special_instructions","strip_tags","ajax","type","timeout","dataType","processor","user_id","op","order_id","success","json","processor_success","updateInstructionsOrgValues","processor_message","error","objAJAXRequest","strError","responseText","response","booking_id","do_op","do","note","textarea_elem","special_instruction_note","removeClass","show","nl2br","lastCheckedGiftCertNumber","document","onkeypress","OMDefaultKeyHandler","evt","event","charCode","which","keyCode","processCode","stopPropagation","getChangeListHTML","height","width","modal","div_id","dialogClass","noOk","position","my","at","of","close","ui","remove","flagName","checkbox","newState","oldState","cancel","confirm","flag","new_state","attr","updateMealCustomizationOrgValues","dd_toast","updateItemsOrgValues","isDreamTaste","isFundraiser","updateChangeList","saveAll","saveItems","saveDiscountsUponCompletion","activateOnSaveDiscountsCompletion","saveDeliveryAddressUponCompletion","itemsList","introItemsList","subItemsList","is_intro","item_id","misc_food_subtotal","misc_nonfood_subtotal","subtotal_service_fee","subtotal_delivery_fee","misc_food_subtotal_desc","misc_nonfood_subtotal_desc","service_fee_description","ltdOrderedMealsArray","bagFeeTotal","bagFeeCount","storeSupportsBagFees","storeDefaultBagFee","opted_to_bring_bags","manual_customization_fee","opted_to_customize","mealCustomizationFee","items","meal_customization_fee","intro_items","sub_items","itemTabIsDirty","saveDiscounts","setSessionAndSave","session_id","displayModalWaitDialog","dd_csrf_token","full_session_warning_required","bounce","getTokenToken","Reschedule","org_session_id","transition_type","suppressEmail","saved_booking_id","order_state","new_session_id","new_session_time","RetrieveCalendar","canDelayPayment","hideFlex","showFlex","session_discount","value","activeSessionDiscount","session_info","session_type_title","remaining_slots","remaining_intro_slots","client_ops","hasOwnProperty","href","key","formatAsMoney","onSetSessionAndSave","obj","onSaveItems","HideLineItemsIfZero","timestamp","discountEligable","limited_access","isDeliveryAddressComplete","validated","saveDeliveryAddress","payOnCompletion","token","shipping_data","onAddPaymentAndActivate","onDeliveryTabSelected","onDeliveryTabDeselected","onSessionTabSelected","onSessionTabDeselected","onItemsTabSelected","onItemsTabDeselected","onFeesTabSelected","onFeesTabDeselected","onPaymentTabSelected","handle_admin_order_notes","onPaymentTabDeselected","onRelatedOrdersTabSelected","onRelatedOrdersTabDeselected","onNotesTabSelected","handle_guest_account_notes","handle_admin_carryover_notes","onNotesTabDeselected","onPaymentSelected","onPaymentDeselected","onSiteAdminTabSelected","onSiteAdminTabDeselected","updateDiscountOrgValues","updateActiveOrder","go_to_confirm","direct_order_discount","PUDSetting","plate_points_discount","SessDiscSetting","DR_level","curOrderLevel","dream_rewards_level","JSON","stringify","changeListStr","_validate_discounts","couponFreeMenuItemRequired","_check_elements","get","coupon_id","coupon_free_menu_item","fundraiser_id","fundraiser_value","add_ltd_round_up","ltd_round_up_select","updateReportingOrgValues","couponFreeMenuItem","paymentToken","send","paymentNumber","warnOfOutstandingSavedOrdersOnFullSession","addOnly","payment1Data","next_dest","contentWindow","pp_success","error_code","buttons","Okay","reload","reloadOnFailure","comment_payload","PayFlow_Payload","addNameValuePair","user_email","expdate","csc","amt","payload","USER_DETAILS","use_store_credits","store_credit_amount","DP_State","depositAmount","store_specific_deposit","payflowErrorURL","parmList","retrieveEncodedString","tr_action","pfp_test_mode","transparent_redirect_link","create_and_submit_form","action","target","input","SECURETOKEN","SECURETOKENID","tokenID","PARMLIST","getPaymentData","payment_number","paymentData","number","amount","cert_type","ccNameOnCard","ccType","ccMonth","ccYear","cc_security_code","billing_address","billing_city","billing_state_id","billing_postal_code","is_store_specific_flat_rate_deposit_delayed_payment","do_not_ref","save_card","DPSetting","alert","indexOf","reference_id","validatePayment1","inputArray","validates","substr","depositWarningStr","CC1Amount","validatePayment2","addPaymentAndActivate","minimumVal","minimumType","order_minimum","minimum","minimum_type","servingsCount","enforce36ServingMinimum","underFilledMessage","toLowerCase","Number","itemCount","orderIsEligibleForMembershipDiscount","storeSupportsMembership","membership_status","eligible_menus","menu_id","number_qualifying_orders","quantityOrdered","valueOf","requiredMinimum","changesBlurb","getAbbreviatedSummaryString","discounts_are_valid","bundleIsSelected","numBundItems","countSelectedBundleItems","intro_servings_required","save2PaymentsAndBookOrder","payment2Type","payment2Data","supports_transparent_redirect","max_plate_points_deduction","async","payment_data","add_payment_data","delay_remainder","billing_name","billing_zip","chain_token","savePayment2","handleDirectPayment","payment1Type","mainPaymentData","additionalPaymentData","store_credits_amount","closeOnEscape","Refresh","cur_session_id","onDayClick","doReschedule","sessionTime","curSessionDate","open","siblings","onRescheduleClick","isDiscounted","control_message","Continue","Cancel","onSessionClick","monthChange","monthVal","handle_delayed_payment","GUEST_PREFERENCES","TC_DELAYED_PAYMENT_AGREE","lang","en","tc","terms_and_conditions","delayed_payment","parent","Agree","off","set_user_pref","Decline","delayed_payment_decline","createBonusCredit","creditConsumed","creditBasis","removeBonusCredit","handleSummaryDisplayChange","checked","ShowAllLineItems","bagFeeOrg","bagFee","bagFeeTaxOrg","bagFeeTax","serviceFeeOrg","serviceFee","deliveryFeeOrg","deliveryFee","serviceTaxOrg","serviceTax","miscFoodOrg","miscFood","miscNonFoodOrg","miscNonFood","miscMealCustomizationFeeOrg","miscMealCustomizationFee","doDiscountOrg","doDiscount","couponDiscountOrg","couponDiscount","platePointsDiscountOrg","platePointsDiscount","membershipDiscountOrg","membershipDiscount","sessionDiscountOrg","pudDiscount","foodTaxOrg","foodTax","nonFoodTaxOrg","nonFoodTax","deliveryTaxOrg","deliveryTax","productsSubtotalOrg","productsSubtotal","sort_by_price","a","b","price","drawChangeList","htmlStr","item","stdMenuItems","localStorage","getItem","pricing_type","translateServingSize","indexedItems","FTMenuItems","index","hadMiscCostChanges","miscCosts","getHumanReadableName","sideBundleItem","miscDescs","order_type","bundleItems","discounts","reporting","coupon","change_type","code","previous","newVal","toUpperCase","ccRefundTotal","parseFloat","result","bundleChecked","stdItemCount","FTItemCount","descIDStr","desc","bundleOrgVal","discountsHTML","newSDValue","newPUDValue","showSaveButton","delivery","Meal Customization","Meal Customization Fee","orgVal","diff","customizationSelection","origCustomizationSelection","name","text","toFixed","orgCouponVal","curCouponVal","curCouponCode","handleAutoAdjust","balance","canAdjustDelayedPayment","currentDPAmount","changePayment1","adjustPendingDelayedPayment","assignBalanceToRefTransactions","ident","existingPaymentAmountArray","reportPaymentStatus","getAbbreviatedChangeString","addedStd","removedStd","addedFT","removedFT","addedSBI","removedSBI","addedBI","removedBI","addPaymentToLockedOrder","submitPage","form","is_valid","confirm_and_check_form","dialogHeight","appendTo","submit","resetPage","_check_form","dd_round_amount","inAmount","tempVal","parseInt","pennyFraction","Math","floor","updateSideStationStatus","qty","slideUp","css","slideDown","requiredItemCount","sideStationBundleInfo","number_items_required","numSelected","bundle","mid","menu_item","itemQty","fixed_quantity","inv_qty","servings_per_item","bundle_groups","bid","group_info","stationHelpElem","help_message","handleMealCustomizationFeeInput","handleBagCountInput","bagCountLockedToField","handleBagWaiverInput","handleMealCustomizationWaiverInput","mealCustomizationFeeFieldLocked","mealCustomizationFeeTotal","calculateMealCustomizationFee","customizableMealQty","priceConfig","meal_customization_cost","fee","operator","cost","limit","limitLow","limitHigh","getNumberBagsRequiredFromItems","entreeCount","sidesCount","entreesPerBag","bagsRequired","entreeRemainder","total","entrees","core_servings","halfQty","wholeQty","introQty","sideDishQty","sideDishSubTotal","bundlesSubTotal","productsSubTotal","coreItemsSubtotal","bundlesQty","discounted_total","creditContribution","main_items_count","PUDExcludedItemsTotal","PUDExcludedFullItemsCount","PUDExcludedHalfItemsCount","hasServiceFeeWithMFYCoupon","hasDeliveryFeeWithCoupon","sortedCoreItemList","itemsSelected","x","org_remaining","itemId","orgAmount","getAttribute","temp_servings","PlatePointsRulesVersion","serving_size","push","selectedBundleItemCount","selectedBundleServingsCount","originallyHadBundle","bundleInfo","tasteBundleMenuData","number_servings_required","selectedWholeBundleItemCount","selectedHalfBundleItemCount","tasteItemQty","discountablePlatePointsAmount","limit_to_mfy_fee","discount_method","currentServiceFee","limit_to_delivery_fee","currentDeliveryFee","getElementById","couponlimitedToFT","tempCouponVal","background-color","color","removeAttr","maxPPCredit","maxPPDeduction","curPPDiscount","addonsSubtotal","addonsQty","itemNumber","qty_str","prc_str","addQty","addonsQtyNumber","addPrc","addPrcNumber","core_items_count","totalMealQuantity","itemCountLabel","itemCountAdjustmentAmount","displayServingsAdjustment","couponTypeElem","cfm_size","displayMealCount","displayServingCount","orderEditSuccess","newAddonQty","setItem","premarkup_total","freeMealValue","newAddonAmount","round","miscFoodSubtotal","food_costs","newGrandTotal","pre_discounts_grand_total","directDiscountVal","directDiscount","couponDiscountMethod","CouponCodeStr","newDiscountAmount","formatterUSD","Intl","NumberFormat","minimumFractionDigits","maximumFractionDigits","couponlimitedToCore","format","couponDiscountVar","newDiscountVal","couponDiscountVal","couponDiscountValIsServiceFee","couponDiscountValIsDeliveryFee","limit_to_recipe_id","menu_item_id","discount_var","PUDElem","UPDiscountElem","selectedUP","UPDiscount","UPType","PcntTypeValue","originalUP","activeUP","preferredData","preferredCapRemaining","preferred_cap_value","capacityUP","remainingObj","countRemaining","preferred_cap_type","halfCost","basis","include_sides","sort","multiplier","pud_result","rounded_pud_result","promoVal","couponAdjustment","membership_discount_basis","memberDiscountAmount","SessDisc","session_discount_basis","selectedSD","sessionDiscount","rawAmount","originalSD","SDiscountElem","miscNonFoodSubtotal","BagFeeTotal","calculatedBagCount","numBagsRequired","storeSupportsMealCustomization","newNonFoodTax","curNonFoodTax","enrollmentTax","curEnrollmentTax","newDeliveryTax","curDeliveryTax","newFoodTax","newServiceTax","food_portion_of_points_credit","fee_portion_of_points_credit","discountMFYFeeFirst","foodPortionOfMaxDeduction","remainderAfterFoodDiscount","curFoodTax","curServiceTax","newBagFeeTax","curBagFeeTax","taxElem","innerHTML","preTaxTotal","round_up_donation","subtotal_round_up","ceil","subtotal_round_up_diff","orderInfoGrandTotal","paymentTotal","remainingBalance","changePayment2","doNewLivePaymentAdjustments","defaultPaymentAmount","amountStoreCredit","payment1Amount","autoAdjustDiv","canAutoAdjust","forceManualAutoAdjust","canIncrement","canIncrementBundleSubItem","qtyUpdate","selector","pid","itemInfo","parentItemInfo","parentNumItemsRequired","groupID","bundle_to_menu_item_group_id","total_org","total_current","groupInfo","inputItemInfo","inputGroupID","this_org","this_cur","preferenceChangeListener","pref","setting","user","callback","pref_value","USER_PREFERENCES","isPlainObject","extend","toString","includes","replace","meal_customization_preferences","details","customizations","org_value","costInputFeesTab","setFeesTabAsDirty"],"mappings":"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"}