{"version":3,"sourceRoot":"js/src/dreamdinners","sources":["order_mgr_test.js"],"sourcesContent":["var itemChanges = false;\r\nvar discountOrPaymentChanges = false;\r\nvar discountChanges = false;\r\nvar reportingChanges = false;\r\nvar paymentChanges = false;\r\nvar initialSessionDiscountSetting = \"noSD\";\r\nvar initialPreferredUserDiscountSetting = \"noUP\";\r\nvar changeList = null;\r\nvar isFactoringCredit = false;\r\nvar currentCreditAvailable = 0;\r\nvar stationNeedsAttention = false;\r\nvar relatedOrdersAreLoaded = false;\r\nvar currentlySavingOrder = false;\r\nvar onTimeShotAtSupplyingZeroPaymentHasOccurred = false;\r\nvar needPlatePointsMaxDiscountChangeWarning = false;\r\nvar lastMaxPPDiscountAmount = -1;\r\n\r\nfunction admin_order_mgr_init()\r\n{\r\n\r\n\tif (store_id != STORE_DETAILS.id)\r\n\t{\r\n\t\tSTORE_DETAILS.id = store_id;\r\n\r\n\t\t//STORE_DETAILS.id is either the current fadmin store - in which case a match is guaranteed or\r\n\t\t// is the current Site Admin store (last selection from a store drop down.) However in this case if the order was accessed by the address\r\n\t\t// bar a match is not guaranteed so force STORE_DETAILS.id to store_id which is always the store of the order\r\n\t}\r\n\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetupForNewOrder();\r\n\t}\r\n\telse if (orderState == 'SAVED')\r\n\t{\r\n\t\tsetupForSavedOrder();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tsetupForActiveOrder();\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tbundleSetup();\r\n\t}\r\n\r\n\tsetupSiteAdminFunctions();\r\n\r\n\tinitChangeList();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tcalculateTotal();\r\n\r\n\t\tsetAllPaymentFieldsToUnrequired();\r\n\r\n\t\tsetupCouponState();\r\n\t}\r\n\r\n\tsetUpKeyHandlers();\r\n\r\n\tif (getQueryVariable(\"session_full\") == \"true\")\r\n\t{\r\n\t\tvar query = window.location.search.substring(1);\r\n\t\tvar vars = query.split(\"&\");\r\n\t\tvar newQueryString = \"main.php?\";\r\n\r\n\t\tvar first = true;\r\n\t\tfor (var i = 0; i < vars.length; i++)\r\n\t\t{\r\n\r\n\t\t\tvar pair = vars[i].split(\"=\");\r\n\t\t\tif (pair[0] != 'session_full')\r\n\t\t\t{\r\n\t\t\t\tif (!first)\r\n\t\t\t\t{\r\n\t\t\t\t\tnewQueryString += \"&\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewQueryString += vars[i];\r\n\t\t\t}\r\n\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thistoryPush({url: newQueryString});\r\n\t}\r\n\r\n\thandle_special_instruction_notes();\r\n\thandle_cancel_order();\r\n\thandle_delete_saved_order();\r\n\r\n\thandle_free_menu_item_edit();\r\n\thandle_fundraiser_selection();\r\n}\r\n\r\nvar intenseLoggingOn = true;\r\n\r\nfunction intenseLogging(message)\r\n{\r\n\tif (window.console && intenseLoggingOn)\r\n\t{\r\n\t\tconsole.log('OM Intense logging: ' + message);\r\n\t}\r\n}\r\n\r\nfunction saveSpecialInstructions()\r\n{\r\n\r\n\tvar special_instructions = strip_tags($(\"#order_user_notes\").val());\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_special_instructions',\r\n\t\t\torder_id: order_id,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tupdateInstructionsOrgValues();\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveSpecialInstructions: \" + json.processor_message);\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\tintenseLogging(\"saveSpecialInstructions: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction handle_special_instruction_notes()\r\n{\r\n\t$('[id^=\"gd_special_instruction_note_button-\"]').each(function ()\r\n\t{\r\n\r\n\t\t$(this).on('click', function (e)\r\n\t\t{\r\n\r\n\t\t\tvar booking_id = $(this).data('booking_id');\r\n\t\t\tvar user_id = $(this).data('user_id');\r\n\t\t\tvar do_op = 'get';\r\n\t\t\tvar special_instructions = '';\r\n\r\n\t\t\tif ($(this).data('edit_mode') == true)\r\n\t\t\t{\r\n\t\t\t\tdo_op = 'save';\r\n\r\n\t\t\t\tspecial_instructions = strip_tags($('#gd_special_instruction_note-' + booking_id + ' > textarea').val());\r\n\t\t\t}\r\n\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\ttype: 'POST',\r\n\t\t\t\ttimeout: 20000,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\t\top: 'update_special_instructions',\r\n\t\t\t\t\t'do': do_op,\r\n\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\tnote: special_instructions\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (do_op == 'get')\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar textarea_elem = $('<textarea></textarea>').addClass('form-control').val((json.special_instruction_note ? json.special_instruction_note : \"\")).on('keyup', function (e)\r\n\t\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\t\tif ($(this).val() != strip_tags($(this).val()))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t$(this).val(strip_tags($(this).val()));\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).addClass('special_instruction_note_edit').html(textarea_elem);\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', true).html('Save Note');\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).data('special_instruction_note_value', (json.special_instruction_note ? json.special_instruction_note : \"\")).on('click', function (e)\r\n\t\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + $(this).data('booking_id')).removeClass('special_instruction_note_edit').html($(this).data('special_instruction_note_value'));\r\n\r\n\t\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + $(this).data('booking_id')).data('edit_mode', false).html('Special Instructions');\r\n\r\n\t\t\t\t\t\t\t\t$(this).hide();\r\n\r\n\t\t\t\t\t\t\t}).show();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note-' + booking_id).removeClass('special_instruction_note_edit').html(nl2br(json.special_instruction_note));\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_cancel_button-' + booking_id).hide();\r\n\r\n\t\t\t\t\t\t\t$('#gd_special_instruction_note_button-' + booking_id).data('edit_mode', false).html('Special Instructions');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"handle_special_instruction_notes: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\t\t\t\t\tresponse = 'Unexpected error';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nvar lastCheckedGiftCertNumber = null;\r\n\r\nfunction setUpKeyHandlers()\r\n{\r\n\tdocument.onkeypress = OMDefaultKeyHandler;\r\n\r\n\t$(\"#coupon_code\").on('keypress', function (evt)\r\n\t{\r\n\t\t// the enter key will submit a coupon code\r\n\t\tevt = (evt) ? evt : event;\r\n\t\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\t\tif (charCode == 13)\r\n\t\t{\r\n\t\t\tprocessCode();\r\n\t\t\tevt.stopPropagation();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#order_user_notes\").on('keypress', function (evt)\r\n\t{\r\n\t\tevt.stopPropagation();\r\n\t\treturn true;\r\n\t});\r\n\r\n\t$(\"#payment1_gc_payment_number\").on('keyup', function (evt)\r\n\t{\r\n\r\n\t\tif ($(this).val().length == 15 && !isNaN($(this).val()) && $(this).val() != lastCheckedGiftCertNumber)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Warning',\r\n\t\t\t\tmessage: \"It appears that you may be entering a gift Card number. If so, select Gift Card from payment selector. This is the Certificate (Gift Certificate) payment type.\"\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tlastCheckedGiftCertNumber = $(this).val();\r\n\r\n\t\treturn true;\r\n\t});\r\n\r\n}\r\n\r\nfunction OMDefaultKeyHandler(evt)\r\n{\r\n\t// by default the document just eats the enter key\r\n\r\n\tevt = (evt) ? evt : event;\r\n\tvar charCode = (evt.charCode) ? evt.charCode : ((evt.which) ? evt.which : evt.keyCode);\r\n\r\n\tif (charCode == 13)\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction initChangeList()\r\n{\r\n\t$(\"#changeListTab\").on('click', function ()\r\n\t{\r\n\r\n\t\tvar html = getChangeListHTML();\r\n\r\n\t\tif (!html || html == \"\")\r\n\t\t{\r\n\t\t\thtml = \"<h3><i>No Changes</i></h3>\"\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Change List',\r\n\t\t\tmessage: html,\r\n\t\t\theight: 620,\r\n\t\t\twidth: 300,\r\n\t\t\tmodal: false,\r\n\t\t\tdiv_id: 'changelist',\r\n\t\t\tdialogClass: 'fixedDialog',\r\n\t\t\tnoOk: true,\r\n\t\t\tposition: {\r\n\t\t\t\tmy: \"left top\",\r\n\t\t\t\tat: \"left bottom\",\r\n\t\t\t\tof: this\r\n\t\t\t},\r\n\t\t\tclose: function (event, ui)\r\n\t\t\t{\r\n\t\t\t\t$(\"#changelist\").remove();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction setupSiteAdminFunctions()\r\n{\r\n\t$(\"#in-store_status, #plate_points_status\").on('click', function ()\r\n\t{\r\n\r\n\t\tvar flagName = this.id;\r\n\t\tvar checkbox = $(this);\r\n\t\tif (orderState != 'ACTIVE')\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: \"These flags can only be set on ACTIVE orders.\"\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar newState = \"off\";\r\n\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tnewState = \"on\";\r\n\t\t\t}\r\n\r\n\t\t\tvar oldState = 1;\r\n\t\t\tif (newState == \"on\")\r\n\t\t\t{\r\n\t\t\t\toldState = 0;\r\n\t\t\t}\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Status Update',\r\n\t\t\t\tmessage: \"Are you sure you want to update the order status?\",\r\n\t\t\t\tcancel: function ()\r\n\t\t\t\t{\r\n\t\t\t\t\tcheckbox.prop('checked', oldState ? true : false)\r\n\r\n\t\t\t\t},\r\n\t\t\t\tconfirm: function ()\r\n\t\t\t\t{\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\turl: 'ddproc.php',\r\n\t\t\t\t\t\ttype: 'POST',\r\n\t\t\t\t\t\ttimeout: 20000,\r\n\t\t\t\t\t\tdataType: 'json',\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\t\t\t\tuser_id: user_id,\r\n\t\t\t\t\t\t\top: 'update_status_flag',\r\n\t\t\t\t\t\t\torder_id: order_id,\r\n\t\t\t\t\t\t\tflag: flagName,\r\n\t\t\t\t\t\t\tnew_state: newState\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tsuccess: function (json)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tif (json.processor_success)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Update Success',\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\t\tintenseLogging(\"update_status_flag: \" + json.processor_message);\r\n\r\n\t\t\t\t\t\t\t\t$(this).attr(\"checked\", oldState);\r\n\r\n\t\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\tintenseLogging(\"update_status_flag: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\t\t\t\t$(this).attr(\"checked\", oldState);\r\n\r\n\t\t\t\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\t\t\tmessage: response\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction updateItemsOrgValues()\r\n{\r\n\r\n\t$(\"[id^='qty_']\").each(function ()\r\n\t{\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function ()\r\n\t{\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\t$('#selectedBundle').data('org_value', $('#selectedBundle').is(':checked') ? \"1\" : \"0\");\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t{\r\n\t\t\t$(this).data('org_value', $(this).val());\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t{\r\n\t\t\t$(this).data('org_value', $(this).is(':checked') ? \"1\" : \"0\");\r\n\t\t});\r\n\t}\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction saveAll()\r\n{\r\n\tsaveItems(true);\r\n}\r\n\r\nfunction saveItems(saveDiscountsUponCompletion)\r\n{\r\n\r\n\tintenseLogging(\"saveItems() called\");\r\n\r\n\tif (currentlySavingOrder)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Items are still being saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tdd_toast({\r\n\t\tmessage: 'Items Saved',\r\n\t\tposition: 'topcenter'\r\n\t});\r\n\r\n\tvar itemsList = {};\r\n\tvar introItemsList = {};\r\n\tvar subItemsList = {};\r\n\r\n\tvar is_intro = \"false\";\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^=bnd_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// this will pick up any FT items\r\n\t\t$(\"[id^=qty_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($(\"#selectedBundle\").is(\":checked\"))\r\n\t\t{\r\n\r\n\t\t\tis_intro = \"true\";\r\n\r\n\t\t\t$(\"[id^=bnd_]\").each(function ()\r\n\t\t\t{\r\n\r\n\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\t\tintroItemsList[item_id] = \"on\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t\t$(\"[id^=qty_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id^=sbi_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\tsubItemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tvar misc_food_subtotal = $(\"#misc_food_subtotal\").val();\r\n\tif (isNaN(misc_food_subtotal))\r\n\t{\r\n\t\tmisc_food_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_nonfood_subtotal = $(\"#misc_nonfood_subtotal\").val();\r\n\tif (isNaN(misc_nonfood_subtotal))\r\n\t{\r\n\t\tmisc_nonfood_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_service_fee = $(\"#subtotal_service_fee\").val();\r\n\tif (isNaN(subtotal_service_fee))\r\n\t{\r\n\t\tsubtotal_service_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_food_subtotal_desc = $(\"#misc_food_subtotal_desc\").val();\r\n\tvar misc_nonfood_subtotal_desc = $(\"#misc_nonfood_subtotal_desc\").val();\r\n\tvar service_fee_description = $(\"#service_fee_description\").val();\r\n\r\n\tvar special_instructions = $(\"#order_user_notes\").val();\r\n\r\n\tcurrentlySavingOrder = true;\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_items',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: itemsList,\r\n\t\t\tmisc_food_subtotal: misc_food_subtotal,\r\n\t\t\tmisc_nonfood_subtotal: misc_nonfood_subtotal,\r\n\t\t\tsubtotal_service_fee: subtotal_service_fee,\r\n\t\t\tmisc_food_subtotal_desc: misc_food_subtotal_desc,\r\n\t\t\tmisc_nonfood_subtotal_desc: misc_nonfood_subtotal_desc,\r\n\t\t\tservice_fee_description: service_fee_description,\r\n\t\t\tis_intro: is_intro,\r\n\t\t\tintro_items: introItemsList,\r\n\t\t\tsub_items: subItemsList,\r\n\t\t\tspecial_instructions: special_instructions\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tupdateItemsOrgValues();\r\n\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"saveItems() successful\");\r\n\r\n\t\t\t\tif (saveDiscountsUponCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tsaveDiscounts(false);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tcurrentlySavingOrder = false;\r\n\r\n\t\t\t\tintenseLogging(\"update_items: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\r\n\t\t\tcurrentlySavingOrder = false;\r\n\t\t\tintenseLogging(\"update_items: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction setSessionAndSave(session_id)\r\n{\r\n\r\n\tintenseLogging(\"setSessionAndSave() called\");\r\n\r\n\tdisplayModalWaitDialog('saving_div', \"Setting session. Please wait ...\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'set_session_and_save',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val()\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"setSessionAndSave() successful\");\r\n\r\n\t\t\t\tif (json.full_session_warning_required)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr&order=\" + json.order_id + \"&session_full=true\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"#saving_div\").remove();\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tintenseLogging(\"set_session_and_save: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\t$(\"#saving_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"set_session_and_save: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction Reschedule(org_session_id)\r\n{\r\n\r\n\tintenseLogging(\"Reschedule() called\");\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'reschedule',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id,\r\n\t\t\tsaved_booking_id: saved_booking_id,\r\n\t\t\torg_session_id: org_session_id\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"Reschedule() successful\");\r\n\r\n\t\t\t\tsession_id = json.new_session_id;\r\n\t\t\t\t$(\"#curSessionDate\").html(json.new_session_time);\r\n\r\n\t\t\t\tRetrieveCalendar(0);\r\n\r\n\t\t\t\tif (!json.canDelayPayment)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\".delayedPaymentSection\").hideFlex();\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\".delayedPaymentSection\").showFlex();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (json.session_discount)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#noSessionDiscountRow\").hide();\r\n\t\t\t\t\t$(\"#newSessionDiscountBody\").show();\r\n\t\t\t\t\t$(\"#sessionDiscountTypeSpan\").html(json.session_discount.type);\r\n\t\t\t\t\t$(\"#sessionDiscountValueSpan\").html(json.session_discount.value);\r\n\t\t\t\t\tactiveSessionDiscount.id = json.session_discount.id;\r\n\t\t\t\t\tactiveSessionDiscount.type = json.session_discount.type;\r\n\t\t\t\t\tactiveSessionDiscount.value = json.session_discount.value;\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#noSessionDiscountRow\").show();\r\n\t\t\t\t\t$(\"#newSessionDiscountBody\").hide();\r\n\t\t\t\t\tactiveSessionDiscount.id = 0;\r\n\t\t\t\t\tactiveSessionDiscount.type = 'none';\r\n\t\t\t\t\tactiveSessionDiscount.value = 0;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(\"#curSessionTypeSpan\").html(json.session_info.session_type_text);\r\n\t\t\t\t$(\"#curSessionRemainingSlotsSpan\").html(json.session_info.remaining_slots);\r\n\t\t\t\t$(\"#curSessionRemainingIntroSlotsSpan\").html(json.session_info.remaining_intro_slots);\r\n\r\n\t\t\t\tif (json.serviceFeeUpdate != -1)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t//bounce(window.location.href);\r\n\r\n\t\t\t\t\t$(\"#subtotal_service_fee\").val(formatAsMoney(json.serviceFeeUpdate));\r\n\t\t\t\t\t$(\"#service_fee_description\").val(json.serviceFeeDescUpdate);\r\n\t\t\t\t\tcalculateTotal();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"reschedule: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"reschedule: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\nfunction onSetSessionAndSave(obj)\r\n{\r\n\tintenseLogging(\"onSetSessionAndSave() called\");\r\n\r\n\tvar session_id = $(\"#selected_session\").attr(\"data-session_id\");\r\n\tsetSessionAndSave(session_id);\r\n\treturn false;\r\n}\r\n\r\nfunction onSaveItems()\r\n{\r\n\tintenseLogging(\"onSaveItems() called\");\r\n\r\n\tsaveItems();\r\n\treturn false;\r\n\r\n}\r\n\r\nfunction setupForNewOrder()\r\n{\r\n\tHideLineItemsIfZero();\r\n\tvar timestamp = getQueryVariable('month');\r\n\tif (!timestamp)\r\n\t{\r\n\t\ttimestamp = \"0\";\r\n\t}\r\n\tRetrieveCalendar(timestamp);\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\r\n}\r\n\r\nfunction setupForSavedOrder()\r\n{\r\n\t$(\"#addPaymentAndActivate\").show();\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n}\r\n\r\nfunction setupForActiveOrder()\r\n{\r\n\tif (discountEligable.limited_access)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").click();\r\n\r\n\t\t$(\"#items_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#sessions_tab_li\").addClass(\"disabled\");\r\n\t\t$(\"#discountsDiv\").find(\":input\").prop(\"disabled\", true);\r\n\t\t$(\"#discountsDiv\").find(\"*\").addClass(\"om_disabled\");\r\n\r\n\t}\r\n\r\n\t$(\"#addPaymentAndActivate\").hide();\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n}\r\n\r\nfunction onSessionTabSelected()\r\n{\r\n\tRetrieveCalendar(0);\r\n}\r\n\r\nfunction onSessionTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onItemsTabSelected()\r\n{\r\n}\r\n\r\nfunction onItemsTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\tif (itemTabIsDirty)\r\n\t\t{\r\n\t\t\t/*\r\n\t\t\t dd_message({\r\n\t\t\t title: 'Attention',\r\n\t\t\t message: 'You have unsaved changes. Do you wish to save changes to the items tab?',\r\n\t\t\t confirm: function() {\r\n\t\t\t }\r\n\t\t\t });\r\n\t\t\t */\r\n\r\n\t\t\tsaveItems();\r\n\t\t}\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentTabSelected()\r\n{\r\n\thandle_free_menu_item_edit();\r\n}\r\n\r\nfunction onPaymentTabDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE' && (discountChanges || reportingChanges))\r\n\t{\r\n\t\tsaveDiscounts(false);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction onRelatedOrdersTabSelected()\r\n{\r\n\tif (!relatedOrdersAreLoaded)\r\n\t{\r\n\r\n\t\tintenseLogging(\"Loading related Orders\");\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'retrieve_related_orders',\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"Loading related Orders successful\");\r\n\r\n\t\t\t\t$(\"#related_orders\").html(json.data);\r\n\t\t\t\t$(\"#loading_related_orders\").remove();\r\n\t\t\t\trelatedOrdersAreLoaded = true;\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#loading_related_orders\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"retrieve_related_orders: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nfunction onRelatedOrdersTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onNotesTabSelected()\r\n{\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_history',\r\n\t\t\tsession_id: session_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\torder_id: order_id\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\t$(\"#history_div\").html(json.html);\r\n\r\n\t\t\thandle_guest_account_notes();\r\n\r\n\t\t\thandle_admin_carryover_notes();\r\n\r\n\t\t\thandle_admin_order_notes();\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\r\n\t\t\tintenseLogging(\"get_history: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onNotesTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction onPaymentSelected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = true;\r\n\t\tupdateChangeList();\r\n\t}\r\n}\r\n\r\nfunction onPaymentDeselected()\r\n{\r\n\tif (orderState != 'ACTIVE')\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\t\tupdateChangeList();\r\n\t\tpaymentChanges = false;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpaymentChanges = false;\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n\treturn true;\r\n\r\n}\r\n\r\nfunction onSiteAdminTabSelected()\r\n{\r\n\r\n}\r\n\r\nfunction onSiteAdminTabDeselected()\r\n{\r\n\treturn true;\r\n}\r\n\r\nfunction updateDiscountOrgValues()\r\n{\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tinitialSessionDiscountSetting = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tinitialPreferredUserDiscountSetting = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\t}\r\n\r\n\t$(\"#org_coupon_id\").val($(\"#coupon_id\").val());\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function ()\r\n\t{\r\n\t\t$(this).data('org_value', $(this).val());\r\n\t});\r\n\r\n\tupdateChangeList();\r\n\r\n}\r\n\r\nfunction updateActiveOrder(payOnCompletion, go_to_confirm)\r\n{\r\n\tintenseLogging(\"updateActiveOrder() called\");\r\n\r\n\tvar itemsList = {};\r\n\tvar introItemsList = {};\r\n\tvar subItemsList = {};\r\n\r\n\tvar is_intro = \"false\";\r\n\r\n\tif (isDreamTaste || isFundraiser)\r\n\t{\r\n\t\t$(\"[id^=bnd_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t//pick up any sides\r\n\t\t$(\"[id^=qty_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($(\"#selectedBundle\").is(\":checked\"))\r\n\t\t{\r\n\r\n\t\t\tis_intro = \"true\";\r\n\r\n\t\t\t$(\"[id^=bnd_]\").each(function ()\r\n\t\t\t{\r\n\r\n\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\t\tintroItemsList[item_id] = \"on\";\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t\t$(\"[id^=qty_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\titemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id^=sbi_]\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tvar item_id = this.id.split(\"_\")[1];\r\n\t\t\t\tsubItemsList[item_id] = $(this).val();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tvar misc_food_subtotal = $(\"#misc_food_subtotal\").val();\r\n\tif (isNaN(misc_food_subtotal))\r\n\t{\r\n\t\tmisc_food_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_nonfood_subtotal = $(\"#misc_nonfood_subtotal\").val();\r\n\tif (isNaN(misc_nonfood_subtotal))\r\n\t{\r\n\t\tmisc_nonfood_subtotal = \"0.00\";\r\n\t}\r\n\r\n\tvar subtotal_service_fee = $(\"#subtotal_service_fee\").val();\r\n\tif (isNaN(subtotal_service_fee))\r\n\t{\r\n\t\tsubtotal_service_fee = \"0.00\";\r\n\t}\r\n\r\n\tvar misc_food_subtotal_desc = $(\"#misc_food_subtotal_desc\").val();\r\n\tvar misc_nonfood_subtotal_desc = $(\"#misc_nonfood_subtotal_desc\").val();\r\n\tvar service_fee_description = $(\"#service_fee_description\").val();\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar PUDSetting = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\tif (PUDSetting == null || PUDSetting == \"\")\r\n\t{\r\n\t\tPUDSetting = \"noUP\";\r\n\t}\r\n\r\n\tvar plate_points_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(plate_points_discount))\r\n\t{\r\n\t\tplate_points_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar SessDiscSetting = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\tif (SessDiscSetting == null || SessDiscSetting == \"\")\r\n\t{\r\n\t\tSessDiscSetting = \"noSD\";\r\n\t}\r\n\r\n\tvar DR_level = 0;\r\n\tif ($(\"#dr_level_for_order\").length)\r\n\t{\r\n\t\tvar curOrderLevel = $(\"#dr_level_for_order\").val();\r\n\t\tif (curOrderLevel > 0)\r\n\t\t{\r\n\t\t\tDR_level = curOrderLevel;\r\n\t\t}\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\top: 'update_active_order',\r\n\t\t\torder_id: order_id,\r\n\t\t\titems: itemsList,\r\n\t\t\tmisc_food_subtotal: misc_food_subtotal,\r\n\t\t\tmisc_nonfood_subtotal: misc_nonfood_subtotal,\r\n\t\t\tsubtotal_service_fee: subtotal_service_fee,\r\n\t\t\tmisc_food_subtotal_desc: misc_food_subtotal_desc,\r\n\t\t\tmisc_nonfood_subtotal_desc: misc_nonfood_subtotal_desc,\r\n\t\t\tservice_fee_description: service_fee_description,\r\n\t\t\tis_intro: is_intro,\r\n\t\t\tintro_items: introItemsList,\r\n\t\t\tsub_items: subItemsList,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tPUDSetting: PUDSetting,\r\n\t\t\tplate_points_discount: plate_points_discount,\r\n\t\t\tSessDiscSetting: SessDiscSetting,\r\n\t\t\tdream_rewards_level: DR_level,\r\n\t\t\tchangeList: JSON.stringify(changeList),\r\n\t\t\tchangeListStr: getChangeListHTML(),\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val()\r\n\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"updateActiveOrder() successful\");\r\n\r\n\t\t\t\titemTabIsDirty = false;\r\n\t\t\t\tupdateItemsOrgValues();\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(payOnCompletion, go_to_confirm, json.getTokenToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_active_order: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"update_active_order: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction _validate_discounts()\r\n{\r\n\t// check to see if coupon requires free menu selection\r\n\tif (couponFreeMenuItemRequired)\r\n\t{\r\n\t\treturn _check_elements([$('#free_menu_item_coupon').get(0)]);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction saveDiscounts(payOnCompletion)\r\n{\r\n\tintenseLogging(\"saveDiscounts() called\");\r\n\r\n\tif (!_validate_discounts())\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (!payOnCompletion)\r\n\t{\r\n\t\tdd_toast({\r\n\t\t\tmessage: 'Discounts Saved',\r\n\t\t\tposition: 'topcenter'\r\n\t\t});\r\n\t}\r\n\r\n\tvar direct_order_discount = $(\"#direct_order_discount\").val();\r\n\tif (isNaN(direct_order_discount))\r\n\t{\r\n\t\tdirect_order_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar PUDSetting = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\tif (PUDSetting == null || PUDSetting == \"\")\r\n\t{\r\n\t\tPUDSetting = \"noUP\";\r\n\t}\r\n\r\n\tvar plate_points_discount = $(\"#plate_points_discount\").val();\r\n\tif (isNaN(plate_points_discount))\r\n\t{\r\n\t\tplate_points_discount = \"0.00\";\r\n\t}\r\n\r\n\tvar SessDiscSetting = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\tif (SessDiscSetting == null || SessDiscSetting == \"\")\r\n\t{\r\n\t\tSessDiscSetting = \"noSD\";\r\n\t}\r\n\r\n\tvar DR_level = 0;\r\n\tif ($(\"#dr_level_for_order\").length)\r\n\t{\r\n\t\tvar curOrderLevel = $(\"#dr_level_for_order\").val();\r\n\t\tif (curOrderLevel > 0)\r\n\t\t{\r\n\t\t\tDR_level = curOrderLevel;\r\n\t\t}\r\n\t}\r\n\r\n\tvar coupon_id = 0;\r\n\tvar coupon_free_menu_item = 0;\r\n\tif ($(\"#coupon_id\").val())\r\n\t{\r\n\t\tif (couponFreeMenuItemRequired)\r\n\t\t{\r\n\t\t\tif ($('#free_menu_item_coupon').val())\r\n\t\t\t{\r\n\t\t\t\tcoupon_free_menu_item = $('#free_menu_item_coupon').val();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tcoupon_id = $(\"#coupon_id\").val();\r\n\t}\r\n\r\n\tvar fundraiser_id = $('#fundraiser_id').val();\r\n\tvar fundraiser_value = $('#fundraiser_value').val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'update_discounts',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tdirect_order_discount: direct_order_discount,\r\n\t\t\tPUDSetting: PUDSetting,\r\n\t\t\tplate_points_discount: plate_points_discount,\r\n\t\t\tSessDiscSetting: SessDiscSetting,\r\n\t\t\tcoupon_id: coupon_id,\r\n\t\t\tcoupon_free_menu_item: coupon_free_menu_item,\r\n\t\t\tdream_rewards_level: DR_level,\r\n\t\t\tfundraiser_id: fundraiser_id,\r\n\t\t\tfundraiser_value: fundraiser_value\r\n\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"saveDiscounts() successful\");\r\n\r\n\t\t\t\tupdateDiscountOrgValues();\r\n\t\t\t\tupdateReportingOrgValues();\r\n\r\n\t\t\t\tif (coupon_free_menu_item)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#free_menu_item_coupon').attr('disabled', true);\r\n\t\t\t\t\tcouponFreeMenuItem = coupon_free_menu_item;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (payOnCompletion)\r\n\t\t\t\t{\r\n\t\t\t\t\tonAddPaymentAndActivate(false, true, json.paymentToken);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"update_discounts: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"update_discounts: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n}\r\n\r\n\r\nfunction updateReportingOrgValues()\r\n{\r\n\t$('#fundraiser_id').data('org_value', $('#fundraiser_id').val());\r\n\t$('#fundraiser_value').data('org_value', $('#fundraiser_value').val());\r\n\r\n\tupdateChangeList();\r\n}\r\n\r\nfunction send(token, paymentNumber, warnOfOutstandingSavedOrdersOnFullSession, addOnly, go_to_confirm, payment1Data)\r\n{\r\n\r\n\tintenseLogging(\"send() called for payment# \" + paymentNumber);\r\n\r\n\t$('#paypal-result').on(\"load\", function ()\r\n\t{\r\n\r\n\t\tintenseLogging(\"result iFrame loading\");\r\n\r\n\t\ttry\r\n\t\t{\r\n\t\t\tvar next_dest = $('#paypal-result').get(0).contentWindow.next_dest;\r\n\t\t\tvar success = $('#paypal-result').get(0).contentWindow.pp_success;\r\n\r\n\t\t}\r\n\t\tcatch (e)\r\n\t\t{\r\n\r\n\t\t\tintenseLogging(\"exception occurred accessing result iframe\");\r\n\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Exception',\r\n\t\t\t\tmessage: 'We are sorry but an unexpected error occurred during payment processing. Please try again or contact support.'\r\n\t\t\t});\r\n\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// in Safari - exception is not thrown and success is undefined\r\n\t\t// the test is false and we drop into the success = false block\r\n\t\t// then error_code and message also are set to undefined\r\n\r\n\t\tif (success)\r\n\t\t{\r\n\t\t\tintenseLogging(\"success found in iframe\");\r\n\r\n\t\t\tbounce(next_dest);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar error_code = $('#paypal-result').get(0).contentWindow.error_code;\r\n\t\t\tvar message = $('#paypal-result').get(0).contentWindow.message;\r\n\r\n\t\t\tintenseLogging(\"error found in iframe: #\" + error_code + \" | \" + message);\r\n\r\n\t\t\tif (typeof error_code == 'undefined')\r\n\t\t\t{\r\n\t\t\t\terror_code = \"Generic\";\r\n\t\t\t\tmessage = 'Some required information is missing or incorrect. Please correct the fields below and try again.';\r\n\r\n\t\t\t\tintenseLogging(\"error code undefined in iframe\");\r\n\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\tmessage: message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t\telse if (next_dest && next_dest.length > 0)\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"Okay\": function ()\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tbounce(next_dest);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tvar reload = $('#paypal-result').get(0).contentWindow.reloadOnFailure;\r\n\r\n\t\t\t\tif (reload)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"reloadOnFailure found in iframe: reloading\");\r\n\r\n\t\t\t\t\tmessage += \"<br /><br /><span style='color:red'>The credit card payment failed however the order was booked with the gift certificate. The page will now reload.</span>\";\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\t\tmessage: message,\r\n\t\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\t\"Okay\": function ()\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tbounce(window.location.href);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error: ' + error_code,\r\n\t\t\t\t\t\tmessage: message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t});\r\n\r\n\tvar comment_payload = new PayFlow_Payload();\r\n\r\n\tcomment_payload.addNameValuePair('UserID', user_id);\r\n\tcomment_payload.addNameValuePair('StoreID', STORE_DETAILS.id);\r\n\tcomment_payload.addNameValuePair('OrderID', order_id); // TODO: need id here of somekind so the payment can be tracked to an order. Either we create a \"blank\" order\r\n\t// or we use another id that is tied to the order when it is later inserted.\r\n\tcomment_payload.addNameValuePair('Email', user_email);\r\n\r\n\tif (paymentNumber == 1)\r\n\t{\r\n\t\tvar expdate = $(\"#payment1_ccMonth\").val();\r\n\t\texpdate += $(\"#payment1_ccYear\").val();\r\n\t\tvar csc = $(\"#payment1_cc_security_code\").val();\r\n\t\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t\tvar payload = new PayFlow_Payload();\r\n\r\n\t\tpayload.addNameValuePair('admin_user_id', USER_DETAILS.id);\r\n\t\tpayload.addNameValuePair('user_id', user_id);\r\n\t\tpayload.addNameValuePair('store_id', STORE_DETAILS.id);\r\n\t\tpayload.addNameValuePair('order_id', order_id);\r\n\t\tpayload.addNameValuePair('caller_id', 'fadmin_order');\r\n\t\tif (addOnly)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('add_only', 'true');\r\n\t\t}\r\n\t\tif (go_to_confirm)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('go_to_confirm', 'true');\r\n\t\t}\r\n\t\tpayload.addNameValuePair('is_second_payment', 'false');\r\n\r\n\t\tvar use_store_credits = false;\r\n\t\tvar store_credit_amount = 0;\r\n\t\tif ($(\"#use_store_credits\").length)\r\n\t\t{\r\n\t\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\t\tpayload.addNameValuePair('use_sc', 'true');\r\n\t\t\t\tpayload.addNameValuePair('sc_amt', store_credit_amount);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\tpayload.addNameValuePair('DP_State', DP_State);\r\n\t\t\t\tpayload.addNameValuePair('org_amount', amt);\r\n\r\n\r\n\t\t\t\tvar depositAmount = 20;\r\n\t\t\t\tif (DP_State == 1 && store_specific_deposit && store_specific_deposit > 20)\r\n\t\t\t\t{\r\n\t\t\t\t\tdepositAmount = store_specific_deposit;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (amt * 1 <= depositAmount * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Delayed Payment Error',\r\n\t\t\t\t\t\tmessage: \"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tamt = depositAmount;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof payflowErrorURL == 'undefined')\r\n\t\t{\r\n\t\t\tpayflowErrorURL = \"https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback\";\r\n\t\t}\r\n\r\n\t\t// make PARMLIST\r\n\t\tvar parmList = 'ERRORURL=' + payflowErrorURL + \"&ACCT=\" + $(\"#payment1_ccNumber\").val() + \"&EXPDATE=\" + expdate + \"&CSC=\" + csc + \"&AMT=\" + amt + \"&USER1=\" + payload.retrieveEncodedString() + \"&COMMENT1=\" + comment_payload.retrieveEncodedString();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar expdate = $(\"#payment2_ccMonth\").val();\r\n\t\texpdate += $(\"#payment2_ccYear\").val();\r\n\t\tvar csc = $(\"#payment2_cc_security_code\").val();\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\tvar payload = new PayFlow_Payload();\r\n\r\n\t\tpayload.addNameValuePair('user_id', user_id);\r\n\t\tpayload.addNameValuePair('store_id', STORE_DETAILS.id);\r\n\t\tpayload.addNameValuePair('order_id', order_id);\r\n\t\tpayload.addNameValuePair('caller_id', 'fadmin_order');\r\n\t\tpayload.addNameValuePair('add_only', 'false');\r\n\t\tpayload.addNameValuePair('is_second_payment', 'true');\r\n\t\tif (go_to_confirm)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair('go_to_confirm', 'true');\r\n\t\t}\r\n\r\n\t\tif (payment1Data)\r\n\t\t{\r\n\t\t\tpayload.addNameValuePair(\"hasPayment1\", true);\r\n\r\n\t\t\tfor (var key in payment1Data)\r\n\t\t\t{\r\n\t\t\t\tif (payment1Data.hasOwnProperty(key))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayload.addNameValuePair(\"p1_\" + key, payment1Data[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#payment2_is_store_specific_flat_rate_deposit_delayed_payment1').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\tpayload.addNameValuePair('DP_State', DP_State);\r\n\t\t\t\tpayload.addNameValuePair('org_amount', amt);\r\n\r\n\t\t\t\tvar depositAmount = 20;\r\n\t\t\t\tif (DP_State == 1 && store_specific_deposit && store_specific_deposit > 20)\r\n\t\t\t\t{\r\n\t\t\t\t\tdepositAmount = store_specific_deposit;\r\n\t\t\t\t}\r\n\r\n\r\n\t\t\t\tif (amt * 1 <= depositAmount * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Delayed Payment Error',\r\n\t\t\t\t\t\tmessage: \"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used.\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tamt = depositAmount;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (typeof payflowErrorURL == 'undefined')\r\n\t\t{\r\n\t\t\tpayflowErrorURL = \"https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback\";\r\n\t\t}\r\n\r\n\t\t// make PARMLIST\r\n\t\tvar parmList = 'ERRORURL=' + payflowErrorURL + \"&ACCT=\" + $(\"#payment2_ccNumber\").val() + \"&EXPDATE=\" + expdate + \"&CSC=\" + csc + \"&AMT=\" + amt + \"&USER1=\" + payload.retrieveEncodedString() + \"&COMMENT1=\" + comment_payload.retrieveEncodedString();\r\n\t}\r\n\r\n\tvar tr_action = 'https://payflowlink.paypal.com';\r\n\tif (typeof pfp_test_mode != 'undefined' && pfp_test_mode)\r\n\t{\r\n\t\tvar tr_action = 'https://pilot-payflowlink.paypal.com';\r\n\t}\r\n\r\n\tif (typeof transparent_redirect_link != 'undefined')\r\n\t{\r\n\t\ttr_action = transparent_redirect_link;\r\n\t}\r\n\r\n\tintenseLogging(\"posting to PayFlow\");\r\n\r\n\t// Create dynamic form to post and redirect to session_menu\r\n\tcreate_and_submit_form({\r\n\t\taction: tr_action,\r\n\t\ttarget: \"paypal-result\",\r\n\t\tinput: ({\r\n\t\t\tSECURETOKEN: token.token,\r\n\t\t\tSECURETOKENID: token.tokenID,\r\n\t\t\tPARMLIST: parmList\r\n\t\t})\r\n\t});\r\n\r\n}\r\n\r\nfunction getPaymentData(type, payment_number)\r\n{\r\n\r\n\tif (type != 'CC')\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val()\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar paymentData = {\r\n\t\t\ttype: type,\r\n\t\t\tnumber: 0,\r\n\t\t\tamount: 0,\r\n\t\t\tcert_type: '',\r\n\t\t\tnote: $(\"#payment_note\").val(),\r\n\t\t\tccNameOnCard: \"\",\r\n\t\t\tccType: 'CC',\r\n\t\t\tccMonth: \"\",\r\n\t\t\tccYear: \"\",\r\n\t\t\tcc_security_code: \"\",\r\n\t\t\tbilling_address: \"\",\r\n\t\t\tbilling_postal_code: \"\",\r\n\t\t\tis_store_specific_flat_rate_deposit_delayed_payment: 0,\r\n\t\t\tdo_not_ref: 0\r\n\t\t}\r\n\t}\r\n\r\n\tif (payment_number == 1)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"REFERENCE\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_reference_total_amount\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CERT\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_gc_total_amount\").val();\r\n\t\t\t\tpaymentData.cert_type = $(\"#payment1_gift_cert_type\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_gc_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFUND_CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_refund_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_refund_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CREDIT\":\r\n\t\t\t\tpaymentData.amount = $(\"#OEH_remaing_balance\").html();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment1_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment1_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment1_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment1_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment1_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment1_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_1\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_1\").val();\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"GIFT_CARD\":\r\n\t\t\t\tpaymentData.amount = $(\"#debit_gift_card_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#debit_gift_card_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"DPADJUST\":\r\n\t\t\t\t// TODO: ???\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p1_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\r\n\t}\r\n\telse if (payment_number == 2)\r\n\t{\r\n\t\tswitch (type)\r\n\t\t{\r\n\t\t\tcase \"CASH\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cash_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_cash_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CHECK\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_check_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_check_payment_number\").val();\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"CC\":\r\n\t\t\t\tpaymentData.amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tpaymentData.number = $(\"#payment2_ccNumber\").val();\r\n\t\t\t\tpaymentData.ccNameOnCard = $(\"#payment2_ccNameOnCard\").val();\r\n\t\t\t\tpaymentData.ccType = $(\"#payment2_ccType\").val();\r\n\t\t\t\tpaymentData.ccMonth = $(\"#payment2_ccMonth\").val();\r\n\t\t\t\tpaymentData.ccYear = $(\"#payment2_ccYear\").val();\r\n\t\t\t\tpaymentData.cc_security_code = $(\"#payment2_cc_security_code\").val();\r\n\t\t\t\tpaymentData.billing_address = $(\"#billing_address_2\").val();\r\n\t\t\t\tpaymentData.billing_postal_code = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\t\t\tvar DPSetting = $('input[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked').val();\r\n\r\n\t\t\t\tpaymentData.is_store_specific_flat_rate_deposit_delayed_payment = DPSetting;\r\n\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\t\talert('investigate REFERENCE_OTHER');\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\r\n\t\t\t\tif (type.indexOf(\"REF_\") == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tpaymentData.amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\t\tpaymentData.reference_id = $(\"#p2_ref_id\").html();\r\n\t\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\treturn paymentData;\r\n\t}\r\n\r\n}\r\n\r\nfunction validatePayment1(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\t\tcase \"REFERENCE\":\r\n\t\t\tinputArray = $(\"#payment1_reference :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CERT\":\r\n\t\t\tinputArray = $(\"#payment1_gc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment1_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFUND_CASH\":\r\n\t\t\tinputArray = $(\"#payment1_refund_cash :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment1_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CREDIT\":\r\n\t\t\tinputArray = $(\"#payment1_credit :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment1_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment1_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"GIFT_CARD\":\r\n\t\t\tinputArray = $(\"#payment1_debit_gift_card :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"DPADJUST\":\r\n\t\t\tinputArray = $(\"#dp_adjust_div :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment1_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment1_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment1_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment1_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n\r\n}\r\n\r\nfunction validatePayment2(type)\r\n{\r\n\r\n\tvar inputArray = null;\r\n\tvar validates = true;\r\n\r\n\tif (type.substr(0, 4) == \"REF_\")\r\n\t{\r\n\t\ttype = \"REFERENCE_OTHER\";\r\n\t}\r\n\r\n\tswitch (type)\r\n\t{\r\n\r\n\t\tcase \"CASH\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CHECK\":\r\n\t\t\tinputArray = $(\"#payment2_check :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"CC\":\r\n\t\t\tinputArray = $(\"#payment2_cc :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment1\").is(\":checked\") || $(\"#payment2_is_store_specific_flat_rate_deposit_delayed_payment2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_cc_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_CC_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tcase \"REFERENCE_OTHER\":\r\n\t\t\tinputArray = $(\"#payment2_ref :input\");\r\n\t\t\tvalidates = _check_elements(inputArray);\r\n\r\n\t\t\tvar depositWarningStr = \"The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.\";\r\n\r\n\t\t\tif ($(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed1\").is(\":checked\") || $(\"#ref_payment2_is_store_specific_flat_rate_deposit_delayed2\").is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tvar CC1Amount = $(\"#payment2_ref_total_amount\").val();\r\n\t\t\t\tif (CC1Amount * 1 <= store_specific_deposit * 1)\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").html(depositWarningStr);\r\n\t\t\t\t\t$(\"#payment2_Ref_DP_note\").show();\r\n\t\t\t\t\tvalidates = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t}\r\n\r\n\treturn validates;\r\n}\r\n\r\nfunction addPaymentAndActivate()\r\n{\r\n\r\n\tintenseLogging(\"addPaymentAndActivate() called\");\r\n\r\n\tvar servingsCount = Number($('#OEH_number_servings').html());\r\n\r\n\tif (servingsCount.valueOf() < 36 && !isDreamTaste && !isFundraiser && !$(\"#selectedBundle\").is(\":checked\"))\r\n\t{\r\n\r\n\t\tintenseLogging(\"addPaymentAndActivate() - warning for less than 36 servings\");\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Warning',\r\n\t\t\tmessage: 'This order is for less than 36 servings. Do you wish to continue?',\r\n\t\t\tconfirm: function ()\r\n\t\t\t{\r\n\t\t\t\t// always first ensure that discounts are updated on server\r\n\t\t\t\tintenseLogging(\"addPaymentAndActivate() - confirm dialog\");\r\n\r\n\t\t\t\tvar message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\t\t\t\tvar changesBlurb = getAbbreviatedSummaryString();\r\n\t\t\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Add Payment and Book Order',\r\n\t\t\t\t\tdiv_id: 'aPaBO',\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\twidth: 400,\r\n\t\t\t\t\theight: 460,\r\n\t\t\t\t\tconfirm: function ()\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar discounts_are_valid = saveDiscounts(true);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tintenseLogging(\"addPaymentAndActivate() - confirm dialog\");\r\n\r\n\t\tif (hasBundle)\r\n\t\t{\r\n\t\t\tvar bundleIsSelected = false;\r\n\t\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tbundleIsSelected = true;\r\n\t\t\t}\r\n\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\r\n\t\t\t\tvar numBundItems = countSelectedBundleItems();\r\n\t\t\t\tif (numBundItems < 18)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Please select at least 18-servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\telse if (numBundItems > 18)\r\n\t\t\t\t{\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: 'Please select no more than 18 servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (stationNeedsAttention)\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: 'Please review the Side Station and ensure the correct number of items are selected.'\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\r\n\t\t// always first ensure that discounts are updated on server\r\n\t\tvar message = \"You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?\";\r\n\t\tvar changesBlurb = getAbbreviatedSummaryString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Add Payment and Book Order',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: 460,\r\n\t\t\tconfirm: function ()\r\n\t\t\t{\r\n\t\t\t\tvar discounts_are_valid = saveDiscounts(true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction save2PaymentsAndBookOrder(payment2Type, payment1Data, token)\r\n{\r\n\r\n\tintenseLogging(\"save2PaymentsAndBookOrder() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tsession_id: session_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tadd_payment_data: payment2Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, json.warnOfOutstandingSavedOrdersOnFullSession, false, false, payment1Data);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"save2PaymentsAndBookOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction savePayment2(payment2Type, warnOfOutstandingSavedOrdersOnFullSession, token)\r\n{\r\n\r\n\tintenseLogging(\"savePayment2() called\");\r\n\r\n\tvar payment2Data = getPaymentData(payment2Type, 2);\r\n\r\n\tif (payment2Type != \"CC\" || !supports_transparent_redirect)\r\n\t{\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment2_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'add_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment2Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"savePayment2() add_payment successful\");\r\n\r\n\t\t\t\t\tif (warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 add_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\telse if (payment2Type == \"CC\")\r\n\t{\r\n\r\n\t\tvar billing_name = $(\"#payment2_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_2\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_2\").val();\r\n\r\n\t\tvar amt = $(\"#payment2_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 2, warnOfOutstandingSavedOrdersOnFullSession, false, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"savePayment2 get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction handleDirectPayment(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"handleDirectPayment() called\");\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\t// Handle Payment 1 for certain\r\n\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\tvar DP_State = 0;\r\n\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t{\r\n\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\tif (DP_State == 1)\r\n\t\t{\r\n\t\t\tDP_State = 4;\r\n\t\t} // translate to CPayment constants - for now\r\n\t\tif (DP_State == 2)\r\n\t\t{\r\n\t\t\tDP_State = 5;\r\n\t\t}\r\n\r\n\t\tif (DP_State > 0)\r\n\t\t{\r\n\t\t\t// TODO: validate amounts\r\n\t\t}\r\n\t}\r\n\r\n\tvar use_store_credits = false;\r\n\tvar store_credit_amount = 0;\r\n\tif ($(\"#use_store_credits\").length)\r\n\t{\r\n\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t{\r\n\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\tuse_store_credits = true;\r\n\t\t}\r\n\t}\r\n\r\n\tvar mainPaymentData = null;\r\n\tvar additionalPaymentData = null;\r\n\r\n\tif (payment2Type)\r\n\t{\r\n\t\tmainPaymentData = getPaymentData(payment2Type, 2);\r\n\t\tadditionalPaymentData = payment1Data;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmainPaymentData = payment1Data;\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 90000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: store_id,\r\n\t\t\top: 'save_payment',\r\n\t\t\torder_id: order_id,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tpayment_data: mainPaymentData,\r\n\t\t\tadd_payment_data: additionalPaymentData,\r\n\t\t\tdelay_remainder: DP_State,\r\n\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\tdd_csrf_token: token,\r\n\t\t\tpayment2Type: payment2Type\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\t\t\t\tintenseLogging(\"handleDirectPayment() save_payment successful\");\r\n\r\n\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\tif (strError == 'timeout')\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Order Processing Timed Out',\r\n\t\t\t\t\tmessage: \"The request to finalized the order has timed out. This may be due to network congestion. The order may have been successful. The page will refresh and show the actual current status.\",\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\tnoOk: true,\r\n\t\t\t\t\tcloseOnEscape: false,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t'Refresh': function ()\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t$(this).remove();\r\n\t\t\t\t\t\t\tbounce(window.location.href);\r\n\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"handleDirectPayment save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction onAddPaymentAndActivate(addOnly, go_to_confirm, token)\r\n{\r\n\r\n\tintenseLogging(\"onAddPaymentAndActivate() called\");\r\n\r\n\tif (!supports_transparent_redirect)\r\n\t{\r\n\t\treturn handleDirectPayment(addOnly, go_to_confirm, token);\r\n\t}\r\n\r\n\tvar payment1Type = $(\"#payment1_type\").val();\r\n\tvar payment2Type = false;\r\n\r\n\tif (payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD')\r\n\t{\r\n\t\tpayment2Type = $(\"#payment2_type\").val();\r\n\t}\r\n\r\n\t// validation\r\n\tif (!validatePayment1(payment1Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\t// validation\r\n\tif (payment2Type && payment2Type != \"\" && !validatePayment2(payment2Type))\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tdisplayModalWaitDialog('paying_div', \"Sending Payment. Please wait ...\");\r\n\r\n\tvar payment1Data = getPaymentData(payment1Type, 1);\r\n\r\n\tif (payment2Type && payment2Type != \"\")\r\n\t{\r\n\t\tsave2PaymentsAndBookOrder(payment2Type, payment1Data, token);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (payment1Type != \"\" && payment1Type != \"CC\")\r\n\t{\r\n\t\t// Handle Payment 1 for certain\r\n\t\t// Then handle Payment 2 unless it's a CC payment.\r\n\r\n\t\tvar DP_State = 0;\r\n\t\tif ($('#ref_payment1_is_store_specific_flat_rate_deposit_delayed0').length)\r\n\t\t{\r\n\t\t\tDP_State = $('input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked').val();\r\n\r\n\t\t\tif (DP_State == 1)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 4;\r\n\t\t\t} // translate to CPayment constants - for now\r\n\t\t\tif (DP_State == 2)\r\n\t\t\t{\r\n\t\t\t\tDP_State = 5;\r\n\t\t\t}\r\n\r\n\t\t\tif (DP_State > 0)\r\n\t\t\t{\r\n\t\t\t\t// TODO: validate amounts\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar use_store_credits = false;\r\n\t\tvar store_credit_amount = 0;\r\n\t\tif ($(\"#use_store_credits\").length)\r\n\t\t{\r\n\t\t\tif ($(\"#use_store_credits\").is(':checked'))\r\n\t\t\t{\r\n\t\t\t\tstore_credit_amount = $(\"#store_credits_amount\").val();\r\n\t\t\t\tuse_store_credits = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'save_payment',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tpayment_data: payment1Data,\r\n\t\t\t\tdelay_remainder: DP_State,\r\n\t\t\t\tuse_store_credits: use_store_credits,\r\n\t\t\t\tstore_credits_amount: store_credit_amount,\r\n\t\t\t\tdd_csrf_token: token\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate() save_payment successful\");\r\n\r\n\t\t\t\t\tif (json.warnOfOutstandingSavedOrdersOnFullSession)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id + '&full_session=true');\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tbounce(\"main.php?page=admin_order_mgr_thankyou&order=\" + json.order_id);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate save_payment: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"onAddPaymentAndActivate save_payment: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse if (payment1Type != \"\" && payment1Type == \"CC\")\r\n\t{\r\n\t\t/*\r\n\r\n\t\t '#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t ' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t ' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t ' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2'\r\n\t\t */\r\n\r\n\t\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\t\tvar billing_address = $(\"#billing_address_1\").val();\r\n\t\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\t\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 20000,\r\n\t\t\tasync: true,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\t\top: 'get_token',\r\n\t\t\t\torder_id: order_id,\r\n\t\t\t\tamount: amt,\r\n\t\t\t\tuser_id: user_id,\r\n\t\t\t\tbilling_name: billing_name,\r\n\t\t\t\tbilling_address: billing_address,\r\n\t\t\t\tbilling_zip: billing_zip,\r\n\t\t\t\tdd_csrf_token: token,\r\n\t\t\t\tchain_token: true\r\n\t\t\t},\r\n\t\t\tsuccess: function (json)\r\n\t\t\t{\r\n\t\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\t\tif (json.processor_success)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate() get_token successful\");\r\n\r\n\t\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\t\tsend(token, 1, false, addOnly, go_to_confirm, false);\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\t\tintenseLogging(\"onAddPaymentAndActivate get_token: \" + json.processor_message);\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError)\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"onAddPaymentAndActivate get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: response\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction RetrieveCalendar(timestamp)\r\n{\r\n\r\n\tintenseLogging(\"RetrieveCalendar() called\");\r\n\r\n\tvar op = 'retrieve';\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\top = 'retrieve_for_reschedule';\r\n\t}\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'GET',\r\n\t\ttimeout: 20000,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_calendarProcessor',\r\n\t\t\tstore_id: store_id,\r\n\t\t\taction: op,\r\n\t\t\tcur_session_id: session_id,\r\n\t\t\ttimestamp: timestamp\r\n\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar() successful\");\r\n\r\n\t\t\t\t$(\"#calendar_holder\").html(json.data);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"RetrieveCalendar: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\tintenseLogging(\"RetrieveCalendar: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onDayClick(obj)\r\n{\r\n}\r\n\r\nfunction doReschedule(id, sessionTime)\r\n{\r\n\tvar curSessionDate = $(\"#curSessionDate\").html();\r\n\r\n\tdd_message({\r\n\t\ttitle: 'Reschedule',\r\n\t\tmessage: '<div style=\"text-align: center;\"><div>From</div><div style=\"font-weight: bold;\">' + curSessionDate + '</div><div>to</div><div style=\"font-weight: bold;\">' + sessionTime + '</div>',\r\n\t\tmodal: true,\r\n\t\tconfirm: function ()\r\n\t\t{\r\n\r\n\t\t\tvar org_session_id = session_id;\r\n\t\t\tsession_id = id;\r\n\t\t\tReschedule(org_session_id);\r\n\r\n\t\t},\r\n\t\topen: function ()\r\n\t\t{\r\n\r\n\t\t\t$(this).siblings('.ui-dialog-buttonpane').find(\"button:contains('Confirm')\").focus();\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction onRescheduleClick(id, sessionTime, isDiscounted, control_message)\r\n{\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tif (control_message == \"locked\")\r\n\t\t{\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"You cannot reschedule to this session as it is in the previous calendar month and all activity for that month has been locked and finalized.\"\r\n\t\t\t});\r\n\r\n\r\n\t\t}\r\n\t\telse if (control_message == \"tononpreasm\")\r\n\t\t{\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"This session is a standard customer assembly session; your order is for Made for You items. Are you sure you want to select a Standard session? The service fee will be removed.\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"tononpreasm_div\",\r\n\t\t\t\tconfirm: function ()\r\n\t\t\t\t{\r\n\t\t\t\t\tdoReschedule(id, sessionTime);\r\n\t\t\t\t\t$(\"#tononpreasm_div\").remove();\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\telse if (control_message == \"topreasm\")\r\n\t\t{\r\n\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Reschedule',\r\n\t\t\t\tmessage: \"This session is a Made for You session; your order is for standard customer assembly items. Are you sure you want to select a Special Event session? A service fee will be applied.\",\r\n\t\t\t\tmodal: true,\r\n\t\t\t\tdiv_id: \"topreasm_div\",\r\n\t\t\t\tconfirm: function ()\r\n\t\t\t\t{\r\n\t\t\t\t\tdoReschedule(id, sessionTime);\r\n\t\t\t\t\t$(\"#topreasm_div\").remove();\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tdoReschedule(id, sessionTime);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onSessionClick(id, sessionTime, isDiscounted)\r\n{\r\n\tif (orderState == 'NEW')\r\n\t{\r\n\t\tsetSessionAndSave(id);\r\n\t}\r\n}\r\n\r\nfunction monthChange(monthVal)\r\n{\r\n\tRetrieveCalendar(monthVal);\r\n}\r\n\r\nfunction handle_delayed_payment()\r\n{\r\n\tif (tc_delayed_payment_agree)\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2').on('click', function (e)\r\n\t{\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\tmessage: lang.en.tc.delayed_payment,\r\n\t\t\tmodal: true,\r\n\t\t\tnoOk: true,\r\n\t\t\tcloseOnEscape: false,\r\n\t\t\topen: function (event, ui)\r\n\t\t\t{\r\n\t\t\t\t$(this).parent().find('.ui-dialog-titlebar-close').hide();\r\n\t\t\t},\r\n\t\t\tbuttons: {\r\n\t\t\t\t'Agree': function ()\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$(this).remove();\r\n\r\n\t\t\t\t\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t\t\t\t' #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, ' +\r\n\t\t\t\t\t' #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, ' +\r\n\t\t\t\t\t' #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2').off('click');\r\n\r\n\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 1, user_id);\r\n\r\n\t\t\t\t},\r\n\t\t\t\t'Decline': function ()\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\t$('#payment1_is_store_specific_flat_rate_deposit_delayed_payment0, #payment2_is_store_specific_flat_rate_deposit_delayed_payment0, ' +\r\n\t\t\t\t\t'#ref_payment1_is_store_specific_flat_rate_deposit_delayed0, #ref_payment2_is_store_specific_flat_rate_deposit_delayed0').trigger('click');\r\n\r\n\t\t\t\t\tdd_message({\r\n\t\t\t\t\t\ttitle: lang.en.tc.terms_and_conditions,\r\n\t\t\t\t\t\tmessage: lang.en.tc.delayed_payment_decline\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tset_user_pref('TC_DELAYED_PAYMENT_AGREE', 0, user_id);\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n}\r\n\r\nfunction createBonusCredit(creditConsumed)\r\n{\r\n\tisFactoringCredit = true;\r\n\tcurrentCreditAvailable = creditBasis * 0.10;\r\n\r\n\tif (creditConsumed > currentCreditAvailable)\r\n\t{\r\n\t\tcreditConsumed = currentCreditAvailable;\r\n\t\tcurrentCreditAvailable = 0;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tcurrentCreditAvailable -= creditConsumed;\r\n\r\n\t}\r\n\r\n\t$('#couponValue').val(creditConsumed);\r\n\t$(\"#OEH_bonus_credit\").html(\" ( Bonus Credit: \" + formatAsMoney(currentCreditAvailable) + \" )\");\r\n}\r\n\r\nfunction removeBonusCredit()\r\n{\r\n\tisFactoringCredit = false;\r\n\t$(\"#OEH_bonus_credit\").html(\"\");\r\n}\r\n\r\nfunction handleSummaryDisplayChange(obj)\r\n{\r\n\tif (obj.checked)\r\n\t{\r\n\t\tShowAllLineItems();\r\n\t}\r\n\telse\r\n\t{\r\n\t\tHideLineItemsIfZero();\r\n\t}\r\n}\r\n\r\nfunction HideLineItemsIfZero()\r\n{\r\n\tvar serviceFeeOrg = Number($('#OEH_subtotal_service_fee_org').html());\r\n\tvar serviceFee = Number($('#OEH_subtotal_service_fee').html());\r\n\r\n\tif (serviceFeeOrg == 0 && serviceFee == 0)\r\n\t{\r\n\t\t$('#ServiceFeeRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#ServiceFeeRow').show();\r\n\t}\r\n\r\n\tvar serviceTaxOrg = Number($('#OEH_service_tax_subtotal_org').html());\r\n\tvar serviceTax = Number($('#OEH_service_tax_subtotal').html());\r\n\r\n\tif (serviceTaxOrg == 0 && serviceTax == 0)\r\n\t{\r\n\t\t$('#ServiceTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#ServiceTaxRow').show();\r\n\t}\r\n\r\n\tvar miscFoodOrg = Number($('#OEH_misc_food_subtotal_org').html());\r\n\tvar miscFood = Number($('#OEH_misc_food_subtotal').html());\r\n\r\n\tif (miscFoodOrg == 0 && miscFood == 0)\r\n\t{\r\n\t\t$('#miscFoodRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#miscFoodRow').show();\r\n\t}\r\n\r\n\tvar miscNonFoodOrg = Number($('#OEH_misc_nonfood_subtotal_org').html());\r\n\tvar miscNonFood = Number($('#OEH_misc_nonfood_subtotal').html());\r\n\r\n\tif (miscNonFoodOrg == 0 && miscNonFood == 0)\r\n\t{\r\n\t\t$('#miscNonFoodRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#miscNonFoodRow').show();\r\n\t}\r\n\r\n\tvar doDiscountOrg = Number($('#OEH_direct_order_discount_org').html());\r\n\tvar doDiscount = Number($('#OEH_direct_order_discount').html());\r\n\r\n\tif (doDiscountOrg == 0 && doDiscount == 0)\r\n\t{\r\n\t\t$('#directDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#directDiscountRow').show();\r\n\t}\r\n\r\n\tvar couponDiscountOrg = Number($('#OEH_coupon_discount_org').html());\r\n\tvar couponDiscount = Number($('#OEH_coupon_discount').html());\r\n\r\n\tif (couponDiscountOrg == 0 && couponDiscount == 0)\r\n\t{\r\n\t\t$('#couponDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#couponDiscountRow').show();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_food').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_food').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#platePointsDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#platePointsDiscountRow').show();\r\n\t}\r\n\r\n\tvar platePointsDiscountOrg = Number($('#OEH_plate_points_discount_org_fee').html());\r\n\tvar platePointsDiscount = Number($('#OEH_plate_points_order_discount_fee').html());\r\n\r\n\tif (platePointsDiscountOrg == 0 && platePointsDiscount == 0)\r\n\t{\r\n\t\t$('#platePointsFeeDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#platePointsFeeDiscountRow').show();\r\n\t}\r\n\r\n\tvar sessionDiscountOrg = Number($('#OEH_session_discount').html());\r\n\r\n\tif (sessionDiscountOrg == 0)\r\n\t{\r\n\t\t$('#sessionDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#sessionDiscountRow').show();\r\n\t}\r\n\r\n\tvar pudDiscount = Number($('#OEH_preferred').html());\r\n\r\n\tif (pudDiscount == 0)\r\n\t{\r\n\t\t$('#preferredUserDiscountRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#preferredUserDiscountRow').show();\r\n\t}\r\n\r\n\tvar foodTaxOrg = Number($('#OEH_food_tax_subtotal_org').html());\r\n\tvar foodTax = Number($('#OEH_food_tax_subtotal').html());\r\n\r\n\tif (foodTaxOrg == 0 && foodTax == 0)\r\n\t{\r\n\t\t$('#foodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#foodTaxRow').show();\r\n\t}\r\n\r\n\tvar nonFoodTaxOrg = Number($('#OEH_tax_subtotal_org').html());\r\n\tvar nonFoodTax = Number($('#OEH_tax_subtotal').html());\r\n\r\n\tif (nonFoodTaxOrg == 0 && nonFoodTax == 0)\r\n\t{\r\n\t\t$('#nonFoodTaxRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxRow').show();\r\n\t}\r\n\r\n\tvar productsSubtotalOrg = Number($('#OEH_products_subtotal_org').html());\r\n\tvar productsSubtotal = Number($('#OEH_products_subtotal').html());\r\n\r\n\tif (productsSubtotalOrg == 0 && productsSubtotal == 0)\r\n\t{\r\n\t\t$('#productSubtotalRow').hide();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#productSubtotalRow').show();\r\n\t}\r\n}\r\n\r\nfunction ShowAllLineItems()\r\n{\r\n\t$('#ServiceFeeRow').show();\r\n\t$('#ServiceTaxRow').show();\r\n\t$('#miscFoodRow').show();\r\n\t$('#miscNonFoodRow').show();\r\n\t$('#directDiscountRow').show();\r\n\t$('#couponDiscountRow').show();\r\n\t$('#foodTaxRow').show();\r\n\t$('#nonFoodTaxRow').show();\r\n\t$('#productSubtotalRow').show();\r\n\t$('#platePointsDiscountRow').show();\r\n\t$('#preferredUserDiscountRow').show();\r\n\t$('#sessionDiscountRow').show();\r\n}\r\n\r\nfunction sort_by_price(a, b)\r\n{\r\n\tif (a.price == b.price)\r\n\t{\r\n\t\treturn 0;\r\n\t}\r\n\r\n\treturn (a.price < b.price) ? 1 : -1;\r\n}\r\n\r\nfunction getPlatePointsDiscountableAmount(items, total)\r\n{\r\n\tretVal = 0;\r\n\r\n\tvar nonDiscountableAmount = 0;\r\n\tvar servingsCount = 0;\r\n\r\n\tif (items.length > 0)\r\n\t{\r\n\t\titems.sort(sort_by_price);\r\n\r\n\t\tfor (var i = 0; i < items.length; i++)\r\n\t\t{\r\n\r\n\t\t\tvar thisItem = items[i];\r\n\r\n\t\t\tvar servingThisItem = thisItem.qty * thisItem.serving_size;\r\n\t\t\tvar costThisItem = thisItem.qty * thisItem.price;\r\n\t\t\tservingsCount += servingThisItem;\r\n\r\n\t\t\tif (servingsCount == 36)\r\n\t\t\t{\r\n\t\t\t\tnonDiscountableAmount += costThisItem;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\telse if (servingsCount > 36)\r\n\t\t\t{\r\n\t\t\t\tvar orgAmount = servingsCount - servingThisItem;\r\n\t\t\t\tvar remainingServings = 36 - orgAmount;\r\n\t\t\t\tvar remainingItems = remainingServings / thisItem.serving_size;\r\n\t\t\t\tnonDiscountableAmount += (remainingItems * thisItem.price);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tnonDiscountableAmount += costThisItem;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tretVal = total - nonDiscountableAmount;\r\n\r\n\t}\r\n\r\n\tif (servingsCount < 36)\r\n\t{\r\n\t\treturn 0;\r\n\t}\r\n\r\n\tvar serviceFee = Number(document.getElementById('subtotal_service_fee').value);\r\n\tretVal += serviceFee.valueOf();\r\n\r\n\tvar miscFoodSubtotal = Number(document.getElementById('misc_food_subtotal').value);\r\n\tretVal += miscFoodSubtotal.valueOf();\r\n\r\n\treturn retVal;\r\n}\r\n\r\nfunction drawChangeList()\r\n{\r\n\tvar html = getChangeListHTML();\r\n\t$(\"#changelist\").html(html);\r\n\r\n}\r\n\r\nfunction getChangeListHTML()\r\n{\r\n\r\n\tvar htmlStr = \"\";\r\n\tvar first = true;\r\n\tfor (var item in changeList.stdMenuItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Standard Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.stdMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tvar title = $(\"#qty_\" + item).data(\"item_title\");\r\n\t\t\tvar pricing_type = \"(\" + $(\"#qty_\" + item).data(\"servings\") + \" Serving)\";\r\n\r\n\t\t\tif (changeList.stdMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.stdMenuItems[item] + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.stdMenuItems[item] * -1 + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.FTMenuItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Sides List</h3><ul style='margin: 4px;'>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tvar title = $(\"#qty_\" + item).data(\"item_title\");\r\n\r\n\t\t\tif (changeList.FTMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.FTMenuItems[item] + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.FTMenuItems[item] * -1 + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tvar hadMiscCostChanges = false;\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\t\thadMiscCostChanges = true;\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (!hadMiscCostChanges && first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Misc Costs</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.bundleItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\tif (isDreamTaste)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Meal Prep Workshop Items List</h3><ul style='margin: 4px;'>\";\r\n\r\n\t\t\t}\r\n\t\t\telse if (isFundraiser)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Fundraiser Event Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Intro Items List</h3><ul style='margin: 4px;'>\";\r\n\t\t\t}\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\thtmlStr += \"<li>\";\r\n\r\n\t\tif (changeList.bundleItems.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tvar title = $(\"#bnd_\" + item).data(\"item_title\");\r\n\t\t\tvar pricing_type = \"(\" + $(\"#bnd_\" + item).data(\"servings\") + \" Serving)\";\r\n\r\n\t\t\tif (changeList.bundleItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Added \" + changeList.bundleItems[item] + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Removed \" + changeList.bundleItems[item] * -1 + \" \" + pricing_type + \" <i>\" + title + \"</i>\";\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\thtmlStr += \"</li>\";\r\n\r\n\t}\r\n\r\n\tif (!first)\r\n\t{\r\n\t\thtmlStr += \"</ul>\";\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.reporting)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Reporting</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.reporting.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (item == 'fundraiser')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse if (changeList.reporting[item][\"orgVal\"] > 0 && changeList.reporting[item][\"orgVal\"] != changeList.reporting[item][\"newVal\"])\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Changed \" + getHumanReadableName(item) + \" to \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" \" + changeList.reporting[item][\"title\"] + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (item == 'fundraiser_value')\r\n\t\t\t{\r\n\t\t\t\tif (changeList.reporting[item][\"diff\"] > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.reporting[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.reporting[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.coupon)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.coupon.change_type = 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Added coupon code: \" + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type = 'removed')\r\n\t\t{\r\n\t\t\thtmlStr += \"Removed coupon code: \" + \"<br />\";\r\n\t\t}\r\n\t\telse if (changeList.coupon.change_type = 'added')\r\n\t\t{\r\n\t\t\thtmlStr += \"Change coupon code to: \" + \"<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\r\n\t\tif (payment1Type != '')\r\n\t\t{\r\n\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').is(\":visible\");\r\n\t\t\t{\r\n\t\t\t\tif ($(\"#credit_to_customer_refund_cash_amount\").val() > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding Cash to customer.<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar ccRefundTotal = 0;\r\n\t\t\t\t$(\"[id^='Cr_RT_'\").each(function() {\r\n\t\t\t\t\tccRefundTotal += parseFloat($(this).val());\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (ccRefundTotal > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Refunding to customer credit card(s).<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment2_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\t}\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction getHumanReadableName(id)\r\n{\r\n\tswitch (id)\r\n\t{\r\n\t\tcase 'direct_order_discount':\r\n\t\t\treturn \"Direct Order Discount\";\r\n\t\tcase 'plate_points_discount':\r\n\t\t\treturn \"Dinner Dollars\";\r\n\t\tcase \"misc_food_subtotal\":\r\n\t\t\treturn \"Miscellaneous Food Cost\";\r\n\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\treturn \"Miscellaneous Non-food Cost\";\r\n\t\tcase \"subtotal_service_fee\":\r\n\t\t\treturn \"Service Fee\";\r\n\t\tcase 'misc_food_subtotal_desc':\r\n\t\t\treturn 'Misc Food Description';\r\n\t\tcase 'misc_nonfood_subtotal_desc':\r\n\t\t\treturn 'Misc Non-food Description';\r\n\t\tcase 'service_fee_description':\r\n\t\t\treturn 'Service Fee Description';\r\n\t\tcase 'session_discount':\r\n\t\t\treturn 'Session Discount';\r\n\t\tdefault:\r\n\t\t\treturn 'error';\r\n\t}\r\n}\r\n\r\nfunction getAbbreviatedSummaryString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\r\n\tif (isDreamTaste)\r\n\t{\r\n\t\thtmlStr += \"<h3>Meal Prep Workshop Order</h3>\";\r\n\t}\r\n\telse if (bundleChecked)\r\n\t{\r\n\t\thtmlStr += \"<h3>Starter Pack Order</h3>\";\r\n\t}\r\n\telse\r\n\t{\r\n\t\thtmlStr += \"<h3>Standard Order</h3>\";\r\n\t}\r\n\r\n\tvar stdItemCount = 0;\r\n\tvar FTItemCount = 0;\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function ()\r\n\t{\r\n\t\tif ($(this).val() > 0)\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tFTItemCount += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tstdItemCount += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tif (stdItemCount > 0)\r\n\t{\r\n\t\thtmlStr += stdItemCount + \" Standard Items Selected.<br />\"\r\n\t}\r\n\tif (FTItemCount > 0)\r\n\t{\r\n\t\thtmlStr += FTItemCount + \" Sides &amp; Sweets Items Selected.<br />\"\r\n\t}\r\n\r\n\t$(\"[data-dd_type='item_field']\").each(function ()\r\n\t{\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif (curVal > 0)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += getHumanReadableName(this.id) + \" costs of $\" + formatAsMoney(curVal);\r\n\r\n\t\t\t\tvar descIDStr = \"\";\r\n\r\n\t\t\t\tswitch (this.id)\r\n\t\t\t\t{\r\n\t\t\t\t\tcase \"misc_food_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_food_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"misc_nonfood_subtotal\":\r\n\t\t\t\t\t\tdescIDStr = \"misc_nonfood_subtotal_desc\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"subtotal_service_fee\":\r\n\t\t\t\t\t\tdescIDStr = \"service_fee_description\";\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar desc = $(\"#\" + descIDStr).val();\r\n\r\n\t\t\t\tif (desc)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \". <span>( \" + desc + \" )</span><br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \".<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\tvar bundleOrgVal = $('#selectedBundle').data('org_value');\r\n\r\n\tvar bundleItems = 0;\r\n\t$(\"[id^='bnd_']\").each(function ()\r\n\t{\r\n\r\n\t\tif ($(this).is(\":checked\"))\r\n\t\t{\r\n\t\t\tbundleItems++;\r\n\t\t}\r\n\t});\r\n\r\n\tif (bundleItems > 0)\r\n\t{\r\n\t\thtmlStr += bundleItems + \" Intro Items Selected.<br />\"\r\n\t}\r\n\r\n\tif (isDreamTaste)\r\n\t{\r\n\t\tvar bundleItems = 0;\r\n\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() > 0)\r\n\t\t\t{\r\n\t\t\t\tbundleItems += ($(this).val() * 1);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (bundleItems > 0)\r\n\t\t{\r\n\t\t\thtmlStr += bundleItems + \" Items Selected.<br />\"\r\n\t\t}\r\n\t}\r\n\r\n\t// Discounts\r\n\r\n\tvar discountsHTML = \"\";\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function ()\r\n\t{\r\n\r\n\t\tvar curVal = $(this).val();\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() > 0)\r\n\t\t{\r\n\t\t\tdiscountsHTML += getHumanReadableName(this.id) + \" applied.<br />\";\r\n\t\t}\r\n\t});\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\r\n\t\tvar newSDValue = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\r\n\t\tif (newSDValue && newSDValue != \"noSD\")\r\n\t\t{\r\n\t\t\tdiscountsHTML += \"Session discount is applied.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tvar newPUDValue = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\r\n\t\tif (newPUDValue && newPUDValue != \"noUP\")\r\n\t\t{\r\n\t\t\tdiscountsHTML += \"Preferred User Discount is applied.<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (discountsHTML != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Discounts</h3>\" + discountsHTML;\r\n\t}\r\n\r\n\tif (paymentChanges || $('#use_store_credit').is(':checked'))\r\n\t{\r\n\t\thtmlStr += \"<h3>Payments</h3>\";\r\n\r\n\t\tvar payment1Type = $('#payment1_type').val();\r\n\t\thtmlStr += \"Payment of type \" + payment1Type + \" selected.<br />\";\r\n\r\n\t\tif ((payment1Type == 'GIFT_CERT' || payment1Type == 'GIFT_CARD') && $('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\tvar payment2Type = $('#payment2_type').val();\r\n\t\t\tif (payment2Type && payment2Type != \"\")\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"Payment of type \" + payment2Type + \" selected.<br />\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif ($('#use_store_credit').is(':checked'))\r\n\t\t{\r\n\t\t\thtmlStr += \"Store Credit selected for payment.<br />\";\r\n\t\t}\r\n\r\n\t}\r\n\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction updateChangeList()\r\n{\r\n\r\n\titemChanges = false;\r\n\tdiscountChanges = false;\r\n\r\n\tdiscountOrPaymentChanges = false;\r\n\tvar showSaveButton = false;\r\n\r\n\tchangeList = {};\r\n\tchangeList.stdMenuItems = {};\r\n\tchangeList.FTMenuItems = {};\r\n\tchangeList.miscCosts = {};\r\n\tchangeList.miscDescs = {};\r\n\tchangeList.bundleItems = {};\r\n\tchangeList.order_type = \"\";\r\n\tchangeList.discounts = {};\r\n\r\n\t// Items\r\n\t$(\"[id^='qty_']\").each(function ()\r\n\t{\r\n\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t{\r\n\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t{\r\n\t\t\t\tchangeList.FTMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.stdMenuItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t}\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\t// Misc Costs\r\n\t$(\"[data-dd_type='item_field']\").each(function ()\r\n\t{\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\r\n\t\t\tif ($(this).data(\"number\") == true)\r\n\t\t\t{\r\n\t\t\t\t// we're not tracking description fields for now\r\n\t\t\t\tchangeList.miscCosts[this.id] = {\r\n\t\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t\t};\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.miscDescs[this.id] = 1;\r\n\t\t\t}\r\n\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tvar bundleChecked = $('#selectedBundle').is(':checked');\r\n\tvar bundleOrgVal = $('#selectedBundle').data('org_value');\r\n\r\n\tif (bundleChecked)\r\n\t{\r\n\t\tif (bundleOrgVal == \"0\")\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').addClass('unsaved_data_cb');\r\n\t\t\tchangeList.order_type = \"to Intro\";\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\tif (bundleOrgVal == \"1\")\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').addClass('unsaved_data_cb');\r\n\t\t\tchangeList.order_type = \"to Standard\";\r\n\t\t\titemChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#bundle_header_div').removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\tif (isDreamTaste)\r\n\t{\r\n\r\n\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).val() != $(this).data('org_value'))\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('dd_type') == 'cts')\r\n\t\t\t\t{\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = $(this).val() - $(this).data('org_value');\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\t\titemChanges = true;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t{\r\n\r\n\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('org_value') == \"0\")\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().addClass('unsaved_data_cb');\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = 1;\r\n\t\t\t\t\titemChanges = true;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().removeClass('unsaved_data_cb');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif ($(this).data('org_value') == \"1\")\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().addClass('unsaved_data_cb');\r\n\t\t\t\t\tchangeList.bundleItems[this.id.split(\"_\")[1]] = -1;\r\n\t\t\t\t\titemChanges = true;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$(this).parent().removeClass('unsaved_data_cb');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tif (itemChanges)\r\n\t{\r\n\t\t$(\"#items_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#items_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\t// Discounts\r\n\r\n\t$(\"#plate_points_discount, #direct_order_discount\").each(function ()\r\n\t{\r\n\r\n\t\tvar curVal = $(this).val();\r\n\t\tvar orgVal = $(this).data('org_value');\r\n\r\n\t\tif ($(this).data(\"number\") == true)\r\n\t\t{\r\n\t\t\t// reduce to similar formatting for numeric vs textual equivalency\r\n\t\t\tcurVal = parseFloat(curVal);\r\n\t\t\torgVal = parseFloat(orgVal);\r\n\r\n\t\t\tif (isNaN(curVal))\r\n\t\t\t{\r\n\t\t\t\tcurVal = 0;\r\n\t\t\t}\r\n\t\t\tif (isNaN(orgVal))\r\n\t\t\t{\r\n\t\t\t\torgVal = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (curVal.valueOf() != orgVal.valueOf())\r\n\t\t{\r\n\r\n\t\t\t// we're not  tracking description fields for now\r\n\r\n\t\t\tchangeList.discounts[this.id] = {\r\n\t\t\t\tnewVal: $(this).val(),\r\n\t\t\t\torgVal: $(this).data('org_value'),\r\n\t\t\t\tdiff: $(this).val() - $(this).data('org_value')\r\n\t\t\t};\r\n\r\n\t\t\t$(this).addClass('unsaved_data');\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(this).removeClass('unsaved_data');\r\n\t\t}\r\n\t});\r\n\r\n\tif ($(\"#SessDiscnoSD\").length)\r\n\t{\r\n\t\tif (initialSessionDiscountSetting != $(\"input[name='SessDisc']:checked\", '#editorForm').val())\r\n\t\t{\r\n\t\t\t$(\".SD_area\").addClass('unsaved_data_cb');\r\n\r\n\t\t\tvar newSDValue = $(\"input[name='SessDisc']:checked\", '#editorForm').val();\r\n\r\n\t\t\tif (newSDValue == \"noSD\")\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['session_discount'] = {\r\n\t\t\t\t\tnewVal: 0,\r\n\t\t\t\t\torgVal: $(\"#OEH_session_discount_org\").html(),\r\n\t\t\t\t\tdiff: $(\"#OEH_session_discount_org\").html() * -1\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['session_discount'] = {\r\n\t\t\t\t\tnewVal: $(\"#OEH_session_discount\").html(),\r\n\t\t\t\t\torgVal: 0,\r\n\t\t\t\t\tdiff: $(\"#OEH_session_discount\").html()\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\".SD_area\").removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\tif ($(\"#PUDnoUP\").length)\r\n\t{\r\n\t\tif (initialPreferredUserDiscountSetting != $(\"input[name='PUD']:checked\", '#editorForm').val())\r\n\t\t{\r\n\t\t\t$(\"#PUD_area\").addClass('unsaved_data_cb');\r\n\r\n\t\t\tvar newPUDValue = $(\"input[name='PUD']:checked\", '#editorForm').val();\r\n\r\n\t\t\tif (newPUDValue == \"noUP\")\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['preferred_user_discount'] = {\r\n\t\t\t\t\tnewVal: 0,\r\n\t\t\t\t\torgVal: $(\"#OEH_preferred_org\").html(),\r\n\t\t\t\t\tdiff: $(\"#OEH_preferred_org\").html() * -1\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tchangeList.discounts['preferred_user_discount'] = {\r\n\t\t\t\t\tnewVal: $(\"#OEH_preferred\").html(),\r\n\t\t\t\t\torgVal: 0,\r\n\t\t\t\t\tdiff: $(\"#OEH_preferred\").html()\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\tdiscountChanges = true;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#PUD_area\").removeClass('unsaved_data_cb');\r\n\t\t}\r\n\t}\r\n\r\n\t// coupons\r\n\tvar orgCouponVal = $(\"#org_coupon_id\").val();\r\n\tvar curCouponVal = $(\"#coupon_id\").val();\r\n\r\n\tif (orgCouponVal != curCouponVal)\r\n\t{\r\n\t\tdiscountOrPaymentChanges = true;\r\n\r\n\t\tif (orgCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"added\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse if (curCouponVal == \"\")\r\n\t\t{\r\n\t\t\t//removed\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"removed\"\r\n\t\t\t};\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//added\r\n\t\t\tchangeList.coupon = {\r\n\t\t\t\tnewVal: curCouponVal,\r\n\t\t\t\torgVal: orgCouponVal,\r\n\t\t\t\tchange_type: \"changed\"\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#payments_tab_li\").addClass(\"unsaved_data_on_tab\");\r\n\t\tshowSaveButton = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#payments_tab_li\").removeClass(\"unsaved_data_on_tab\");\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && (showSaveButton || $('#use_store_credit').is(':checked')))\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#saveOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (orderState == 'SAVED' && ($('#use_store_credit').is(':checked') || paymentChanges))\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", false);\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#addPaymentAndActivateButton\").attr(\"disabled\", true);\r\n\r\n\t}\r\n\r\n\tif (orderState == 'ACTIVE' || allowLimitedAccess)\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").show();\r\n\t\tif (showSaveButton || paymentChanges || $('#use_store_credits').is(':checked'))\r\n\t\t{\r\n\t\t\tdiscountOrPaymentChanges = true;\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", false);\r\n\t\t\t$(\"#finalize_msg\").show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$(\"#submit_button\").attr(\"disabled\", true);\r\n\t\t\t$(\"#finalize_msg\").hide();\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#finalizeOrderSpan\").hide();\r\n\t}\r\n\r\n\tif (itemChanges || discountOrPaymentChanges)\r\n\t{\r\n\t\t$(\"#changeListTab\").addClass('unsaved_data_list');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$(\"#changeListTab\").removeClass('unsaved_data_list');\r\n\t}\r\n\r\n\tdrawChangeList();\r\n}\r\n\r\nfunction handleAutoAdjust(obj)\r\n{\r\n\t// called when the document is loaded or when the \"autoAdjust\" check box changes\r\n\r\n\t// if checked then setup the amounts to be credited/debited\r\n\tif (obj.checked)\r\n\t{\r\n\t\tvar balance = Number($('#OEH_remaing_balance').html());\r\n\r\n\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || balance > 0))\r\n\t\t{\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('DPADJUST');\r\n\t\t\t\tchangePayment1('DPADJUST');\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tadjustPendingDelayedPayment(balance);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\r\n\t\t\tif (balance > 0)\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_type').val('REFERENCE');\r\n\t\t\t\tchangePayment1('REFERENCE');\r\n\t\t\t}\r\n\r\n\t\t\tassignBalanceToRefTransactions(balance);\r\n\t\t}\r\n\t}\r\n\telse\r\n\t{\r\n\r\n\t\tif ($('#payment1_type').val() != \"\")\r\n\t\t{\r\n\t\t\t$('#payment1_type').val('');\r\n\t\t\tchangePayment1('');\r\n\t\t}\r\n\r\n\t\t// also clear any credits\r\n\t\tfor (ident in existingPaymentAmountArray)\r\n\t\t{\r\n\t\t\t$('#Cr_RT_' + ident).val(\"\");\r\n\t\t}\r\n\r\n\t\t// or if trying to credit\r\n\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n}\r\n\r\nfunction getAbbreviatedChangeString()\r\n{\r\n\tvar htmlStr = \"\";\r\n\tvar addedStd = 0;\r\n\tvar removedStd = 0;\r\n\r\n\tif (needPlatePointsMaxDiscountChangeWarning)\r\n\t{\r\n\t\thtmlStr += \"<div style='color:red;'>Warning: The amount discountable by Dinner Dollars has changed. You may wish to review and adjust the Dinner Dollars discount.</div>\";\r\n\r\n\t}\r\n\r\n\tfor (var item in changeList.stdMenuItems)\r\n\t{\r\n\t\tif (changeList.stdMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.stdMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedStd++;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedStd++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedStd)\r\n\t{\r\n\t\thtmlStr += addedStd + \" Standard items were added.<br />\"\r\n\t}\r\n\tif (removedStd)\r\n\t{\r\n\t\thtmlStr += removedStd + \" Standard items were removed.<br />\"\r\n\t}\r\n\r\n\tvar addedFT = 0;\r\n\tvar removedFT = 0;\r\n\r\n\tfor (var item in changeList.FTMenuItems)\r\n\t{\r\n\t\tif (changeList.FTMenuItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.FTMenuItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedFT++;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedFT++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (addedFT)\r\n\t{\r\n\t\thtmlStr += addedFT + \" Sides &amp; Sweets items were added.<br />\"\r\n\t}\r\n\tif (removedFT)\r\n\t{\r\n\t\thtmlStr += removedFT + \" Sides &amp; Sweets items were removed.<br />\"\r\n\t}\r\n\r\n\tfor (var item in changeList.miscCosts)\r\n\t{\r\n\r\n\t\tif (changeList.miscCosts.hasOwnProperty(item))\r\n\t\t{\r\n\r\n\t\t\tif (changeList.miscCosts[item][\"newVal\"] > changeList.miscCosts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.miscCosts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.miscCosts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.miscCosts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.miscCosts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tfor (var item in changeList.miscDescs)\r\n\t{\r\n\t\tif (changeList.miscDescs.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\thtmlStr += getHumanReadableName(item) + \" updated<br />\";\r\n\t\t}\r\n\t}\r\n\r\n\tif (changeList.order_type != \"\")\r\n\t{\r\n\t\thtmlStr += \"<h3>Order changed \" + changeList.order_type + \"</h3>\";\r\n\t}\r\n\r\n\tvar addedBI = 0;\r\n\tvar removedBI = 0;\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.bundleItems)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\tif (isDreamTaste)\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Meal Prep Workshop Items List</h3>\";\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\thtmlStr += \"<h3>Intro Items List</h3>\";\r\n\t\t\t}\r\n\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.bundleItems.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.bundleItems[item] > 0)\r\n\t\t\t{\r\n\t\t\t\taddedBI++;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tremovedBI++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (addedBI)\r\n\t{\r\n\t\thtmlStr += addedBI + \" items were added.<br />\"\r\n\t}\r\n\tif (removedBI)\r\n\t{\r\n\t\thtmlStr += removedBI + \" items were removed.<br />\"\r\n\t}\r\n\r\n\tif (htmlStr != \"\")\r\n\t{\r\n\t\thtmlStr = \"<h3>Purchase Changes</h3>\" + htmlStr;\r\n\t}\r\n\r\n\tfirst = true;\r\n\tfor (var item in changeList.discounts)\r\n\t{\r\n\t\tif (first)\r\n\t\t{\r\n\t\t\thtmlStr += \"<h3>Discounts</h3>\";\r\n\t\t\tfirst = false;\r\n\t\t}\r\n\r\n\t\tif (changeList.discounts.hasOwnProperty(item))\r\n\t\t{\r\n\t\t\tif (changeList.discounts[item][\"newVal\"] > changeList.discounts[item][\"orgVal\"])\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"orgVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Added \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was increased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"]) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (changeList.discounts[item][\"newVal\"] == 0)\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += \"Removed \" + getHumanReadableName(item) + \" of $\" + formatAsMoney(changeList.discounts[item][\"orgVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\thtmlStr += getHumanReadableName(item) + \" was decreased by $\" + formatAsMoney(changeList.discounts[item][\"diff\"] * -1) + \" to $\" + formatAsMoney(changeList.discounts[item][\"newVal\"]) + \"<br />\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tif ($('#autoAdjust').is(\":checked\"))\r\n\t{\r\n\t\thtmlStr += \"<span style='color:red'>Auto-Adjust is checked and will \" + $(\"#adj_action\").html() + \"</span>\";\r\n\r\n\t}\r\n\r\n\thtmlStr = \"<div id='finalize_changes_div'>\" + htmlStr + \"</div>\";\r\n\treturn htmlStr;\r\n}\r\n\r\nfunction addPaymentToLockedOrder()\r\n{\r\n\tvar billing_name = $(\"#payment1_ccNameOnCard\").val();\r\n\tvar billing_address = $(\"#billing_address_1\").val();\r\n\tvar billing_zip = $(\"#billing_postal_code_1\").val();\r\n\tvar amt = $(\"#payment1_cc_total_amount\").val();\r\n\r\n\t$.ajax({\r\n\t\turl: 'ddproc.php',\r\n\t\ttype: 'POST',\r\n\t\ttimeout: 20000,\r\n\t\tasync: true,\r\n\t\tdataType: 'json',\r\n\t\tdata: {\r\n\t\t\tprocessor: 'admin_order_mgr_processor',\r\n\t\t\tstore_id: STORE_DETAILS.id,\r\n\t\t\top: 'get_token',\r\n\t\t\torder_id: order_id,\r\n\t\t\tamount: amt,\r\n\t\t\tuser_id: user_id,\r\n\t\t\tbilling_name: billing_name,\r\n\t\t\tbilling_address: billing_address,\r\n\t\t\tbilling_zip: billing_zip,\r\n\t\t\tdd_csrf_token: $('input[name=dd_csrf_token]', '#editorForm').val(),\r\n\t\t\tchain_token: true\r\n\t\t},\r\n\t\tsuccess: function (json)\r\n\t\t{\r\n\t\t\t$('input[name=dd_csrf_token]', '#editorForm').val(json.getTokenToken);\r\n\r\n\t\t\tif (json.processor_success)\r\n\t\t\t{\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder() get_token successful\");\r\n\r\n\t\t\t\tvar token = json.token;\r\n\r\n\t\t\t\tsend(token, 1, false, true, true, false);\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + json.processor_message);\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: json.processor_message\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t},\r\n\t\terror: function (objAJAXRequest, strError)\r\n\t\t{\r\n\t\t\t$(\"#paying_div\").remove();\r\n\r\n\t\t\tintenseLogging(\"addPaymentToLockedOrder get_token: \" + strError + \" | \" + objAJAXRequest.responseText);\r\n\r\n\t\t\tresponse = 'Unexpected error: ' + strError;\r\n\t\t\tdd_message({\r\n\t\t\t\ttitle: 'Error',\r\n\t\t\t\tmessage: response\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction submitPage()\r\n{\r\n\tintenseLogging(\"submitPage() called\");\r\n\r\n\tvar form = $(\"#editorForm\")[0];\r\n\r\n\tvar is_valid = confirm_and_check_form(form);\r\n\r\n\tif (is_valid)\r\n\t{\r\n\t\tvar message = \"This can not be undone. Are you sure you want to submit the changes?\";\r\n\t\tvar changesBlurb = getAbbreviatedChangeString();\r\n\t\tmessage += \"<br /><br />\" + changesBlurb;\r\n\r\n\t\tvar dialogHeight = 460;\r\n\r\n\t\tif (message.length < 128)\r\n\t\t{\r\n\t\t\tdialogHeight = 160;\r\n\t\t}\r\n\t\telse if (message.length < 256)\r\n\t\t{\r\n\t\t\tdialogHeight = 260;\r\n\t\t}\r\n\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Finalize',\r\n\t\t\tmessage: message,\r\n\t\t\tmodal: true,\r\n\t\t\twidth: 400,\r\n\t\t\theight: dialogHeight,\r\n\t\t\tconfirm: function ()\r\n\t\t\t{\r\n\r\n\t\t\t\tif (supports_transparent_redirect && $(\"#payment1_type\").val() == 'CC')\r\n\t\t\t\t{\r\n\t\t\t\t\tintenseLogging(\"submitPage() confirmed\");\r\n\r\n\t\t\t\t\tif (!allowLimitedAccess)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tupdateActiveOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\taddPaymentToLockedOrder(true, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeList',\r\n\t\t\t\t\t\tvalue: JSON.stringify(changeList)\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$('<input>').attr({\r\n\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\tname: 'changeListStr',\r\n\t\t\t\t\t\tvalue: getChangeListHTML()\r\n\t\t\t\t\t}).appendTo($(form));\r\n\r\n\t\t\t\t\t$(\"#submit_changes\").val(\"true\");\r\n\t\t\t\t\t$(\"#editorForm\").submit();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t}\r\n}\r\n\r\nfunction resetPage()\r\n{\r\n\tintenseLogging(\"resetPage() called\");\r\n\r\n\tbounce(window.location.href);\r\n}\r\n\r\nfunction confirm_and_check_form(form)\r\n{\r\n\r\n\tintenseLogging(\"confirm_and_check_form() called\");\r\n\r\n\tif (orderState == 'NEW' || orderState == 'SAVED')\r\n\t{\r\n\t\treturn false;\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tvar bundleIsSelected = false;\r\n\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t{\r\n\t\t\tbundleIsSelected = true;\r\n\t\t}\r\n\r\n\t\tif (bundleIsSelected)\r\n\t\t{\r\n\r\n\t\t\tvar numBundItems = countSelectedBundleItems();\r\n\t\t\tif (numBundItems < 18)\r\n\t\t\t{\r\n\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Please select at least 18-servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\telse if (numBundItems > 18)\r\n\t\t\t{\r\n\t\t\t\tdd_message({\r\n\t\t\t\t\ttitle: 'Error',\r\n\t\t\t\t\tmessage: 'Please select no more than 18 servings of Meal Prep Starter Pack items.'\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (stationNeedsAttention)\r\n\t{\r\n\t\tdd_message({\r\n\t\t\ttitle: 'Error',\r\n\t\t\tmessage: 'Please review the Side Station and ensure the correct number of items are selected.'\r\n\t\t});\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn _check_form(form);\r\n}\r\n\r\n// rounds to the nearest penny\r\n// move to global once this is found to be reliable\r\nfunction dd_round_amount(inAmount)\r\n{\r\n\tinAmount += .000005;\r\n\r\n\tvar tempVal = inAmount * 1000.0;\r\n\ttempVal = parseInt(tempVal);\r\n\ttempVal = tempVal / 10;\r\n\tvar pennyFraction = tempVal - Math.floor(tempVal);\r\n\tif (pennyFraction >= .5)\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal) + 1;\r\n\t}\r\n\telse\r\n\t{\r\n\t\ttempVal = Math.floor(tempVal);\r\n\t}\r\n\r\n\treturn tempVal / 100;\r\n}\r\n\r\n/*\r\n\r\n function reportTestFailure(testNum, actual, correct)\r\n {\r\n if (actual != correct)\r\n {\r\n alert(\"Test #: \" + testNum + \" actual: \" + actual + \" correct: \" + correct);\r\n }\r\n }\r\n\r\n function doTests()\r\n {\r\n\r\n var testmultiplier = \".5\";\r\n\r\n var testNum = \"260.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(1, newResult, 130.05);\r\n\r\n var testNum = \"209.10\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(2, newResult, 104.55);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(3, newResult, 104.55);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(4, newResult, 104.5);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(5, newResult, .5);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(6, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(7, newResult, .03);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(8, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(9, newResult, 250);\r\n\r\n var testNum = \"209.10\";\r\n var testmultiplier = \".12\";\r\n\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(10, newResult, 25.09);\r\n\r\n testNum = \"209.09\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(11, newResult, 25.09);\r\n\r\n testNum = \"209\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(12, newResult, 25.08);\r\n\r\n testNum = \"1\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(13, newResult, .12);\r\n\r\n testNum = \"0\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(14, newResult, 0);\r\n\r\n testNum = \".05\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(15, newResult, .01);\r\n\r\n testNum = \".005\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(16, newResult, 0);\r\n\r\n testNum = \"499.99\";\r\n var testResult = testNum * testmultiplier;\r\n var newResult = dd_round_amount(testResult);\r\n console.log('testResult: ' + testResult + '   New Result: ' + newResult);\r\n reportTestFailure(17, newResult, 60);\r\n\r\n }\r\n\r\n doTests();\r\n\r\n */\r\n\r\nfunction updateSideStationStatus(entree_id, qty)\r\n{\r\n\tif (qty == 0)\r\n\t{\r\n\t\tstationNeedsAttention = false;\r\n\t\thelp_message = \"You must set the Bundle quantity to greater than zero.\";\r\n\t\tvar stationHelpName = \"sidestation_help_\" + entree_id;\r\n\t\tvar stationHelpElem = $(\"#\" + stationHelpName);\r\n\t\tstationHelpElem.css('color', \"#bb0000\");\r\n\t\tstationHelpElem.html(help_message);\r\n\r\n\t\treturn;\r\n\t}\r\n\r\n\tvar requiredItemCount = qty * sideStationBundleInfo[entree_id].number_items_required;\r\n\tvar numRequiredSpanName = \"required_items_station_\" + entree_id;\r\n\t$(\"#\" + numRequiredSpanName).html(requiredItemCount);\r\n\r\n\tvar numSelected = 0;\r\n\r\n\t$.each(sideStationBundleInfo[entree_id].bundle, function (sid, sinfo)\r\n\t{\r\n\r\n\t\tvar itemQty = $('#sbi_' + sid);\r\n\r\n\t\tif (itemQty && itemQty.val() != \"\")\r\n\t\t{\r\n\t\t\tif (isNaN(itemQty.val()) == true || itemQty.val() - parseInt(itemQty.val()) != 0)\r\n\t\t\t{\r\n\t\t\t\titemQty.val(0);\r\n\t\t\t}\r\n\r\n\t\t\tif (itemQty.val() > 0)\r\n\t\t\t{\r\n\t\t\t\titemQty.val(parseInt(itemQty.val()));\r\n\t\t\t\tnumSelected += (itemQty.val() * 1);\r\n\t\t\t}\r\n\r\n\t\t\tvar inv_qty = entreeIDToInventoryMap[sid].remaining;\r\n\t\t\tinv_qty -= (itemQty.val() * sinfo.servings_per_item);\r\n\r\n\t\t\t$('#sbi_inv_' + sid).html(inv_qty);\r\n\r\n\t\t\t$('#inv_' + sid).html(inv_qty);\r\n\r\n\t\t\tentreeIDToInventoryMap[sid].remaining = inv_qty;\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tvar numSelectedSpanName = \"selected_items_station_\" + entree_id;\r\n\t$(\"#\" + numSelectedSpanName).html(numSelected);\r\n\r\n\tvar stationHelpName = \"sidestation_help_\" + entree_id;\r\n\tvar stationHelpElem = $(\"#\" + stationHelpName);\r\n\tvar help_message = \"\";\r\n\tif (numSelected == 0)\r\n\t{\r\n\t\thelp_message = \"Please select \" + requiredItemCount + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#bb0000\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse if (numSelected > requiredItemCount)\r\n\t{\r\n\t\thelp_message = \"You have selected \" + (numSelected - requiredItemCount) + \" items more than the required amount. Please remove \" + (numSelected - requiredItemCount) + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#bb0000\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse if (numSelected < requiredItemCount)\r\n\t{\r\n\t\thelp_message = \"You have selected \" + (requiredItemCount - numSelected) + \" items less than the required amount. Please add \" + (requiredItemCount - numSelected ) + \" items.\";\r\n\t\tstationHelpElem.css('color', \"#bb0000\");\r\n\t\tstationNeedsAttention = true;\r\n\t}\r\n\telse\r\n\t{\r\n\t\thelp_message = \"You have selected the correct number of sidestation items. You may continue with item selection or checkout.\";\r\n\t\tstationHelpElem.css('color', \"#00bb00\");\r\n\t\tstationNeedsAttention = false;\r\n\t}\r\n\r\n\tstationHelpElem.html(help_message);\r\n\r\n}\r\n\r\n// this massive function is called anytime something that affects costs or payments is altered\r\nfunction calculateTotal()\r\n{\r\n\r\n\tvar total = 0;\r\n\tvar entrees = 0;\r\n\tvar servings = 0;\r\n\tvar halfQty = 0;\r\n\tvar wholeQty = 0;\r\n\tvar introQty = 0;\r\n\tvar sideDishQty = 0;\r\n\tvar sideDishSubTotal = 0;\r\n\tvar bundlesSubTotal = 0;\r\n\tvar productsSubTotal = 0;\r\n\tvar bundlesQty = 0;\r\n\tvar discounted_total = 0;\r\n\tvar creditContribution = 0;\r\n\tvar DRSubjectCreditContribution = 0;\r\n\tvar main_items_count = 0;\r\n\tvar aux_items_count = 0;\r\n\tvar bundleIsSelected = false;\r\n\tvar PUDExcludedItemsTotal = 0;\r\n\tvar PUDExcludedFullItemsCount = 0;\r\n\tvar PUDExcludedHalfItemsCount = 0;\r\n\tvar creditConsumed = 0;\r\n\r\n\tvar sortedCoreItemList = [];\r\n\tvar itemsSelected = [];\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tif ($('#selectedBundle').is(':checked'))\r\n\t\t{\r\n\t\t\tbundleIsSelected = true;\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tfor (var x in entreeIDToInventoryMap)\r\n\t{\r\n\t\tentreeIDToInventoryMap[x].remaining = entreeIDToInventoryMap[x].org_remaining;\r\n\t\t$('#inv_' + x).html(entreeIDToInventoryMap[x].org_remaining);\r\n\r\n\t}\r\n\r\n\t// ---------------------------------------------------------- Items\r\n\t// loop through all the quantity input boxes and gather up the totals\r\n\r\n\r\n\t// var count = 0;\r\n\t$(\"[id^='qty_']\").each(function ()\r\n\t{\r\n\t\t//  count++;\r\n\r\n\t\tif ($(this).val() != \"\")\r\n\t\t{\r\n\t\t\tif (isNaN($(this).val()) == true || $(this).val() - parseInt($(this).val(), 10) != 0)\r\n\t\t\t{\r\n\t\t\t\t$(this).val(0);\r\n\t\t\t}\r\n\r\n\t\t\tvar itemQty = $(this).val();\r\n\t\t\tvar itemId = this.id.split(\"_\")[1];\r\n\r\n\t\t\tif ( isFactoringCredit )\r\n\t\t\t{\r\n\t\t\t\tvar orgAmount = $(this).data('org_value');\r\n\t\t\t\tif ($(this).data('dd_type') == 'std')\r\n\t\t\t\t{\r\n\t\t\t\t\tif (orgAmount < itemQty)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = itemQty - orgAmount;\r\n\t\t\t\t\t\tcreditContribution += (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (itemQty  < orgAmount)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = orgAmount - itemQty ;\r\n\t\t\t\t\t\tcreditContribution -= (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse // addon\r\n\t\t\t\t{\r\n\t\t\t\t\tvar orgAmount = itemQty.getAttribute('data-org_value');\r\n\t\t\t\t\tif (orgAmount < itemQty )\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = itemQty  - orgAmount;\r\n\t\t\t\t\t\tcreditConsumed += (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (itemQty < orgAmount)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdiff = orgAmount - itemQty;\r\n\t\t\t\t\t\tcreditContribution -= (diff * $(this).data('price'));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ( (isNaN(itemQty) == false) )\r\n\t\t\t{\r\n\t\t\t\tvar entree_id = $(this).data('entreeid');\r\n\t\t\t\tvar inv_qty = entreeIDToInventoryMap[entree_id].remaining;\r\n\t\t\t\tvar temp_servings = Number($(this).data('servings'));\r\n\t\t\t\tinv_qty = inv_qty - (itemQty * temp_servings);\r\n\t\t\t\t$('#inv_' + entree_id).html(inv_qty);\r\n\t\t\t\tentreeIDToInventoryMap[entree_id].remaining = inv_qty;\r\n\r\n\t\t\t\tif ($(this).data('dd_type') != 'cts')\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (itemQty > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\tid: itemId,\r\n\t\t\t\t\t\t\tqty: itemQty,\r\n\t\t\t\t\t\t\tprice: $(this).data('price'),\r\n\t\t\t\t\t\t\tserving_size: $(this).data('servings')\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tsortedCoreItemList.push(obj)\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\r\n\t\t\t\ttotal += itemQty * $(this).data('price');\r\n\r\n\t\t\t\tif ($(this).data('dd_type') != 'cts')\r\n\t\t\t\t{\r\n\t\t\t\t\tentrees += itemQty * 1;\r\n\t\t\t\t\tservings += itemQty * $(this).data('servings');\r\n\r\n\t\t\t\t\tif ($(this).data('pricing_type') == 'FULL')\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\twholeQty += itemQty * 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\thalfQty += itemQty * 1;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tsideDishQty += itemQty * 1;\r\n\t\t\t\t\tsideDishSubTotal += itemQty * $(this).data('price');\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ($(this).data('is_bundle') == 'true')\r\n\t\t\t\t{\r\n\t\t\t\t\tbundlesSubTotal += itemQty * $(this).data('price');\r\n\t\t\t\t\tbundlesQty += (itemQty * 1);\r\n\t\t\t\t}\r\n\r\n\t\t\t\titemsSelected[itemId] = itemQty;\r\n\r\n\t\t\t\t$('#sbi_inv_' + entree_id).html(inv_qty);\r\n\t\t\t}\r\n\r\n\t\t\tif ($(this).data('is_bundle') == 'true')\r\n\t\t\t{\r\n\t\t\t\tupdateSideStationStatus(entree_id, itemQty);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tmain_items_count = halfQty + wholeQty  + sideDishQty;\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\tif (originallyHadBundle)\r\n\t\t{\r\n\t\t\t// bundle support\r\n\t\t\tvar selectedBundleItemCount = 0;\r\n\t\t\tvar selectedBundleServingsCount = 0;\r\n\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t\t\t{\r\n\t\t\t\t\tif ($(this).data('org_value') == \"1\") //was initially chosen\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (!$(this).is(\":checked\"))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar inv_qty = entreeIDToInventoryMap[$(this).data('entreeid')].remaining;\r\n\t\t\t\t\t\t\tinv_qty = inv_qty + $(this).data('servings');\r\n\t\t\t\t\t\t\t$('#inv_' + $(this).data('entreeid')).html(inv_qty);\r\n\t\t\t\t\t\t\tentreeIDToInventoryMap[$(this).data('entreeid')].remaining = inv_qty;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar inv_qty = entreeIDToInventoryMap[$(this).data('entreeid')].remaining;\r\n\t\t\t\t\t\t\tinv_qty = inv_qty - $(this).data('servings');\r\n\t\t\t\t\t\t\t$('#inv_ ' + $(this).data('entreeid')).html(inv_qty);\r\n\t\t\t\t\t\t\tentreeIDToInventoryMap[$(this).data('entreeid')].remaining = inv_qty;\r\n\t\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{ //bundle is not selected\r\n\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t\t\t{\r\n\t\t\t\t\tif ($(this).data('org_value') == \"1\") //was initially chosen\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar inv_qty = entreeIDToInventoryMap[$(this).data('entreeid')].remaining;\r\n\t\t\t\t\t\tinv_qty = inv_qty + $(this).data('servings');\r\n\t\t\t\t\t\t$('#inv_' + $(this).data('entreeid')).html(inv_qty);\r\n\t\t\t\t\t\tentreeIDToInventoryMap[$(this).data('entreeid')].remaining = inv_qty;\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar selectedBundleItemCount = 0;\r\n\t\t\tvar selectedBundleServingsCount = 0;\r\n\t\t\tif (bundleIsSelected)\r\n\t\t\t{\r\n\r\n\t\t\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t\t\t{\r\n\t\t\t\t\tif ($(this).is(\":checked\"))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar inv_qty = entreeIDToInventoryMap[$(this).data('entreeid')].remaining;\r\n\t\t\t\t\t\tinv_qty = inv_qty - $(this).data('servings');\r\n\t\t\t\t\t\t$('#inv_' + $(this).data('entreeid')).html(inv_qty);\r\n\t\t\t\t\t\tentreeIDToInventoryMap[$(this).data('entreeid')].remaining = inv_qty;\r\n\t\t\t\t\t\tselectedBundleItemCount++;\r\n\t\t\t\t\t\tselectedBundleServingsCount += $(this).data('servings');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (hasBundle)\r\n\t{\r\n\t\t// bundle support\r\n\t\tif (bundleIsSelected)\r\n\t\t{\r\n\t\t\ttotal += (bundleInfo.price * 1);\r\n\t\t\twholeQty += selectedBundleItemCount;\r\n\t\t\tservings += selectedBundleServingsCount;\r\n\t\t}\r\n\t}\r\n\r\n\tif (tasteBundleMenuData)\r\n\t{\r\n\t\tif (hasDreamTasteBundle)\r\n\t\t{\r\n\t\t\t// bundle support\r\n\t\t\tvar selectedWholeBundleItemCount = 0;\r\n\t\t\tvar selectedHalfBundleItemCount = 0;\r\n\t\t\tvar selectedBundleServingsCount = 0;\r\n\r\n\t\t\ttotal += dreamTastePrice;\r\n\r\n\t\t\t$(\"[id^='bnd_']\").each(function ()\r\n\t\t\t{\r\n\r\n\t\t\t\tvar tasteItemQty = $(this).val();\r\n\t\t\t\tif (tasteItemQty > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tservings += ($(this).data('servings') * tasteItemQty);\r\n\t\t\t\t\tif ($(this).data('servings') == 3)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tselectedHalfBundleItemCount += (tasteItemQty * 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tselectedWholeBundleItemCount += (tasteItemQty * 1);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar inv_qty = entreeIDToInventoryMap[$(this).data('entreeid')].remaining;\r\n\t\t\t\t\tinv_qty = inv_qty - (tasteItemQty * 3);\r\n\t\t\t\t\t$('#inv_' + $(this).data('entreeid')).html(inv_qty);\r\n\t\t\t\t\tentreeIDToInventoryMap[$(this).data('entreeid')].remaining = inv_qty;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\twholeQty += (selectedWholeBundleItemCount * 1);\r\n\t\t\thalfQty += (selectedHalfBundleItemCount * 1);\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tvar discountablePlatePointsAmount = 0;\r\n\r\n\tif ($(\"#selectedBundle\").is(':checked') )\r\n\t{\r\n\t\t$(\"#max_plate_points_deduction\").html(formatAsMoney(0))\r\n\t}\r\n\telse\r\n\t{\r\n\t\tdiscountablePlatePointsAmount = getPlatePointsDiscountableAmount(sortedCoreItemList, total);\r\n\r\n\t    needPlatePointsMaxDiscountChangeWarning = false;\r\n\r\n\t    if (discountablePlatePointsAmount != lastMaxPPDiscountAmount && lastMaxPPDiscountAmount != -1)\r\n\t    {\r\n\t    \tneedPlatePointsMaxDiscountChangeWarning = true;\r\n\t    }\r\n\r\n\t    lastMaxPPDiscountAmount = discountablePlatePointsAmount;\r\n\r\n\r\n\t\tif (couponlimitedToFT)\r\n\t\t{\r\n\t\t\tvar tempCouponVal = Number(document.getElementById('couponValue').value);\r\n\t\t\tdiscountablePlatePointsAmount -= tempCouponVal;\r\n\t\t\tif (discountablePlatePointsAmount < 0)\r\n\t\t\t{\r\n\t\t\t\tdiscountablePlatePointsAmount = 0;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t$(\"#max_plate_points_deduction\").html(formatAsMoney(discountablePlatePointsAmount))\r\n\t}\r\n\r\n\tif (discountablePlatePointsAmount <= 0)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").attr(\"disabled\", \"disabled\");\r\n\t\t$(\"#plate_points_discount\").css({\r\n\t\t\t\"background-color\": \"#c0c0c0\",\r\n\t\t\t\"color\": \"#060606\"\r\n\t\t});\r\n\t\t$(\"#pp_discountable_cost_msg\").show();\r\n\r\n\t}\r\n\telse if (!allowLimitedAccess)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").removeAttr(\"disabled\");\r\n\t\t$(\"#plate_points_discount\").css({\r\n\t\t\t\"background-color\": \"#ffffff\",\r\n\t\t\t\"color\": \"#000000\"\r\n\t\t});\r\n\t\t$(\"#pp_discountable_cost_msg\").hide();\r\n\r\n\t}\r\n\r\n\r\n\tvar maxPPCredit = $(\"#plate_points_available\").html() * 1;\r\n\tvar maxPPDeduction = $(\"#max_plate_points_deduction\").html() * 1;\r\n\tvar curPPDiscount = $(\"#plate_points_discount\").val() * 1;\r\n\r\n\tif (maxPPDeduction < curPPDiscount)\r\n\t{\r\n\t\t$(\"#plate_points_discount\").val(maxPPDeduction);\r\n\t}\r\n\r\n\tif (maxPPCredit > maxPPDeduction)\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').show();\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#tbody_max_plate_points_deduction').hide();\r\n\t}\r\n\r\n\tdiscounted_total = total;\r\n\r\n\tvar addonsSubtotal = 0;\r\n\tvar addonsQty = 0;\r\n\r\n\r\n\t//var itemRows = document.getElementById('itemsTbl').rows;\r\n\t//for (i = 0; i < itemRows.length; i++)\r\n\r\n\t$(\"#itemsTbl tr\").each(function ()\r\n\t{\r\n\r\n\t\tif (this.id.indexOf('row_') != -1)\r\n\t\t{\r\n\t\t\tvar itemNumber = this.id.substr(4);\r\n\r\n\t\t\tvar qty_str = 'qna_' + itemNumber;\r\n\t\t\tvar prc_str = 'prc_' + itemNumber;\r\n\r\n\t\t\tvar addQty = $('#' + qty_str).val();\r\n\t\t\tvar addonsQtyNumber = Number(addQty);\r\n\t\t\tvar addPrc = $(\"#\" + prc_str).html();\r\n\t\t\tvar addPrcNumber = Number(addPrc);\r\n\t\t\taddonsSubtotal += (Number(addPrc) * addQty);\r\n\t\t\taddonsQty += addonsQtyNumber;\r\n\r\n\t\t\t/// var inv_qty =  Number(document.getElementById('inv_org_' + itemNumber).innerHTML);\r\n\t\t\tvar inv_qty = entreeIDToInventoryMap[itemNumber].remaining;\r\n\r\n\t\t\tinv_qty = inv_qty - addQty;\r\n\t\t\t$('#inv_' + itemNumber).html(inv_qty.toString());\r\n\t\t\tentreeIDToInventoryMap[itemNumber].remaining = inv_qty;\r\n\r\n\t\t\tif ( isFactoringCredit )\r\n\t\t\t{\r\n\t\t\t\torgAmount = document.getElementById(qty_str).getAttribute('data-org_value');\r\n\t\t\t\tif (orgAmount < addonsQtyNumber)\r\n\t\t\t\t{\r\n\t\t\t\t\tdiff = addonsQtyNumber - orgAmount;\r\n\t\t\t\t\tcreditConsumed += (diff * addPrcNumber);\r\n\t\t\t\t}\r\n\t\t\t\telse if (addQty < orgAmount)\r\n\t\t\t\t{\r\n\t\t\t\t\tdiff = orgAmount - addQty;\r\n\t\t\t\t\tcreditContribution -= (diff * addPrcNumber);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n\tvar totalMealQuantity = Number(halfQty + wholeQty);\r\n\r\n\tvar itemCountLabel = $('#OEH_item_count_label');\r\n\r\n\tvar itemCountAdjustmentAmount = 0;\r\n\tvar displayServingsAdjustment = 0;\r\n\r\n\t// coupon code free meal count contribution\r\n\tvar couponTypeElem = $('#coupon_type');\r\n\tif (couponTypeElem.length && couponTypeElem.val() == 'FREE_MEAL')\r\n\t{\r\n\t\tcfm_size = Number($('#free_entree_servings').val());\r\n\r\n\t\tif (cfm_size > 0)\r\n\t\t{\r\n\t\t\tdisplayServingsAdjustment += cfm_size;\r\n\t\t\titemCountAdjustmentAmount++;\r\n\t\t}\r\n\t}\r\n\r\n\tif (itemCountAdjustmentAmount == 0)\r\n\t{\r\n\t\tdisplayMealCount = introQty + wholeQty + halfQty + sideDishQty + addonsQty;\r\n\t\tdisplayServingCount = servings;\r\n\t\titemCountLabel.html(\"Total Item Count\");\r\n\t}\r\n\telse\r\n\t{\r\n\t\tdisplayMealCount = introQty + wholeQty +  sideDishQty + halfQty + itemCountAdjustmentAmount + addonsQty;\r\n\t\tdisplayServingCount = servings + displayServingsAdjustment;\r\n\t\titemCountLabel.html(\"Total # Items (incl. free meals)\");\r\n\t}\r\n\r\n\tif (orderEditSuccess)\r\n\t{\r\n\t\tdisplayMealCount += newAddonQty;\r\n\t}\r\n\r\n\t// update the entree and serving totals display\r\n\t$('#OEH_item_count').html(displayMealCount);\r\n\t$('#OEH_number_servings').html(displayServingCount);\r\n\r\n\tvar premarkup_total = 0;\r\n\r\n\tvar freeMealValue = 0;\r\n\r\n\t// also must add coupon code free meal\r\n\t// coupon code free meal count contribution\r\n\tcouponTypeElem = $('#coupon_type');\r\n\tif (couponTypeElem.length && couponTypeElem.val() == 'FREE_MEAL')\r\n\t{\r\n\t\tfreeMealValue = Number($('#couponValue').val());\r\n\r\n\t\tif (freeMealValue > 0)\r\n\t\t{\r\n\t\t\tdiscounted_total += freeMealValue;\r\n\t\t}\r\n\t}\r\n\r\n\tdiscounted_total += addonsSubtotal;\r\n\r\n\tif (orderEditSuccess)\r\n\t{\r\n\t\tdiscounted_total += newAddonAmount;\r\n\t}\r\n\r\n\tdiscounted_total = Math.round(discounted_total*100)/100;\r\n\r\n\t// --------------------------------------------------------------------- menu items subtotal\r\n\t$('#orderSubTotal').val(formatAsMoney(Math.round(total*100)/100));\r\n\t$('#OEH_menu_subtotal').html(formatAsMoney(discounted_total));\r\n\t$('#orderTotal').val(formatAsMoney(discounted_total));\r\n\r\n\t// ------------------------------------------------------ food subtotal\r\n\r\n\tvar miscFoodSubtotal = Number(document.getElementById('misc_food_subtotal').value);\r\n\r\n\t// menu items total plus misc food cost\r\n\t//(Note that discountedTotal is misleading here. This reflects legacy of Family savings discount on menu items which no longer applies)\r\n\tvar food_costs = (discounted_total * 1) + (miscFoodSubtotal *1);\r\n\tvar session_discount_basis = food_costs;\r\n\t$('#OEH_food_cost_subtotal').html(formatAsMoney((discounted_total * 1) + (miscFoodSubtotal *1)));\r\n\r\n\tvar newGrandTotal = discounted_total;\r\n\tvar pre_discounts_grand_total = newGrandTotal;\r\n\r\n\r\n\t// -------------------------------DISCOUNTS-----------------------------------------\r\n\r\n\r\n\tvar curPPDiscount = 0;\r\n\t// ----------------------------------------------  PLATEPOINTS Discount\r\n\tif ( $('#plate_points_discount').length)\r\n\t{\r\n\t\tcurPPDiscount = $('#plate_points_discount').val();\r\n\t\tif (curPPDiscount > discountablePlatePointsAmount)\r\n\t\t{\r\n\t\t\tcurPPDiscount = discountablePlatePointsAmount;\r\n\t\t\t$('#plate_points_discount').val(formatAsMoney(curPPDiscount));\r\n\t\t}\r\n\r\n\r\n\t\t//$('#OEH_plate_points_order_discount').html(formatAsMoney(curPPDiscount));\r\n\t\t// This is now done in the taxesd section\r\n\r\n\r\n\t\tnewGrandTotal = formatAsMoney(newGrandTotal - curPPDiscount);\r\n\t}\r\n\r\n\t// ---------------------------------------------- Direct Order\r\n\tvar directDiscountVal = Number(0);\r\n\r\n\tdirectDiscount = $('#direct_order_discount');\r\n\tif (directDiscount.val() == \"\")\r\n\t{\r\n\t\tdirectDiscount.val('0.00');\r\n\t}\r\n\tif ( directDiscount.length )\r\n\t{\r\n\t\tdirectDiscountVal = directDiscount.val();\r\n\r\n\t\tif (directDiscountVal > food_costs)\r\n\t\t{\r\n\t\t\tdirectDiscountVal = food_costs;\r\n\t\t\tdirectDiscount.val(directDiscountVal);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal)\r\n\t\t{\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - directDiscountVal);\r\n\t\t\t$('#OEH_direct_order_discount').html(formatAsMoney(directDiscountVal));\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t// Adjust Bonus Credit and discount\r\n\tif (isFactoringCredit)\r\n\t{\r\n\t\t//alert(creditContribution);\r\n\t\t//alert(creditConsumed);\r\n\t\tcreditBasis += \tcreditContribution;\r\n\t\tcreateBonusCredit(creditConsumed);\r\n\t}\r\n\r\n\r\n\t// ------------------------------------------------------------------- coupon Discount\r\n\r\n\tif (couponDiscountMethod == 'PERCENT')\r\n\t{\r\n\t\tvar newDiscountAmount = pre_discounts_grand_total * (couponDiscountVar / 100);\r\n\r\n\t\t$('#couponValue').val(newDiscountAmount);\r\n\t}\r\n\r\n\tif (couponlimitedToFT)\r\n\t{\r\n\t\tvar newDiscountVal = sideDishSubTotal;\r\n\t\tif (newDiscountVal > couponDiscountVar)\r\n\t\t{\r\n\t\t\tnewDiscountVal = couponDiscountVar;\r\n\t\t}\r\n\r\n\t\t$('#couponValue').val(newDiscountVal);\r\n\r\n\t}\r\n\r\n\tvar couponDiscountVal = Number(0);\r\n\tcouponDiscount = $('#couponValue');\r\n\r\n\tif ( couponDiscount.length)\r\n\t{\r\n\t\tif (couponDiscount.val() == \"\")\r\n\t\t{\r\n\t\t\tcouponDiscount.val('0.00');\r\n\t\t}\r\n\t\tcouponDiscountVal = couponDiscount.val();\r\n\r\n\t\tif (couponDiscountVal)\r\n\t\t{\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - couponDiscountVal);\r\n\t\t\t$('#OEH_coupon_discount').html(formatAsMoney(couponDiscountVal));\r\n\t\t\tsession_discount_basis -= couponDiscountVal;\r\n\t\t}\r\n\t}\r\n\r\n\t// ------------------------------------------------ Preferred Customer\r\n\tPUDElem = $('#PUDnoUP');\r\n\tif (PUDElem.length)\r\n\t{\r\n\t\tvar selectedUP = $('input[name=PUD]:checked', '#editorForm').val();\r\n\r\n\t\tif (selectedUP == null || selectedUP == \"\")\r\n\t\t{\r\n\t\t\tselectedUP = \"noUP\";\r\n\t\t}\r\n\r\n\t\tvar UPDiscount = -1;\r\n\r\n\t\tpremarkup_discounted_total = premarkup_total - (total - discounted_total);\r\n\t\tvar UPType = 'none';\r\n\t\tvar PcntTypeValue = 0.0;\r\n\r\n\tif (originalUP != false)\r\n\t{\r\n\t\tif (selectedUP == \"originalUP\")\r\n\t\t{\r\n\t\t\tif (originalUP.type == \"FLAT\")\r\n\t\t\t{\r\n\t\t\t\tvar cost = (wholeQty - PUDExcludedFullItemsCount) * originalUP.value;\r\n\t\t\t\tvar halfCost = Number(formatAsMoney(((halfQty - PUDExcludedHalfItemsCount) * (originalUP.value / 2))));\r\n\t\t\t\tcost += halfCost;\r\n\t\t\t\tUPDiscount = formatAsMoney(discounted_total - cost - sideDishSubTotal - addonsSubtotal - productsSubTotal - PUDExcludedItemsTotal);\r\n\t\t\t\tUPType = 'flat';\r\n\r\n\t\t\t}\r\n\t\t\telse if (originalUP.type == \"PERCENT\")\r\n\t\t\t{\r\n\t\t\t\tvar basis = pre_discounts_grand_total - sideDishSubTotal - addonsSubtotal - productsSubTotal;\r\n\t\t\t\tvar multiplier = originalUP.value / 100;\r\n\t\t\t\tvar pud_result = basis * multiplier;\r\n\t\t\t\tvar rounded_pud_result = dd_round_amount(pud_result);\r\n\t\t\t\tUPDiscount = formatAsMoney( rounded_pud_result );\r\n\t\t\t\tUPType = 'pcnt';\r\n\t\t\t\tPcntTypeValue = originalUP.value / 100;\r\n\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (activeUP != false)\r\n\t\t{\r\n\t\t\tif (selectedUP == \"activeUP\")\r\n\t\t\t{\r\n\t\t\t\tif (activeUP.type == \"FLAT\")\r\n\t\t\t\t{\r\n\t\t\t\t\tvar cost = (wholeQty - PUDExcludedFullItemsCount) * activeUP.value;\r\n\t\t\t\t\tvar halfCost2 = Number(formatAsMoney(((halfQty - PUDExcludedHalfItemsCount) * (originalUP.value / 2))));\r\n\t\t\t\t\tcost += halfCost2;\r\n\r\n\t\t\t\t\tUPDiscount = formatAsMoney((premarkup_discounted_total - cost - sideDishSubTotal- addonsSubtotal - productsSubTotal - PUDExcludedItemsTotal) * -1);\r\n\t\t\t\t\tUPType = 'flat';\r\n\t\t\t\t}\r\n\t\t\t\telse if (activeUP.type == \"PERCENT\")\r\n\t\t\t\t{\r\n\t\t\t\t\tvar basis = pre_discounts_grand_total - sideDishSubTotal - addonsSubtotal - productsSubTotal;\r\n\t\t\t\t\tvar multiplier = activeUP.value / 100;\r\n\t\t\t\t\tvar pud_result = basis * multiplier;\r\n\t\t\t\t\tvar rounded_pud_result = dd_round_amount(pud_result);\r\n\t\t\t\t\tUPDiscount = formatAsMoney( rounded_pud_result );\r\n\t\t\t\t\tUPType = 'pcnt';\r\n\t\t\t\t\tPcntTypeValue = activeUP.value / 100;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\tif (selectedUP == \"noUP\")\r\n\t\t{\r\n\t\t\tUPDiscount = 0;\r\n\t\t}\r\n\r\n\t\tif (UPType == 'flat')\r\n\t\t{\r\n\t\t\tif (typeof promoVal  != 'undefined' && promoVal > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= promoVal;\r\n\t\t\t}\r\n\r\n\t\t\tif (freeMealValue > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= freeMealValue;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (UPType == 'pcnt')\r\n\t\t{\r\n\t\t\tif (typeof promoVal  != 'undefined' && promoVal > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= (promoVal * PcntTypeValue);\r\n\t\t\t\tUPDiscount = Math.round(UPDiscount * 100) / 100;\r\n\t\t\t}\r\n\r\n\t\t\tif (freeMealValue > 0 && UPDiscount > 0)\r\n\t\t\t{\r\n\t\t\t\tUPDiscount -= (freeMealValue * PcntTypeValue);\r\n\t\t\t\tUPDiscount = Math.round(UPDiscount * 100) / 100;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (UPDiscount != -1)\r\n\t\t{\r\n\t\t\tUPDiscountElem = $('#OEH_preferred');\r\n\t\t\tif (UPDiscountElem.length)\r\n\t\t\t{\r\n\t\t\t\tUPDiscountElem.html(formatAsMoney(UPDiscount));\r\n\t\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - UPDiscount);\r\n\t\t\t\tsession_discount_basis -= UPDiscount;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// Need to break food and service fee portions early enough to\r\n\t// calculate session discount\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (miscFoodSubtotal * 1));\r\n\t$('#OEH_misc_food_subtotal').html(formatAsMoney(miscFoodSubtotal));\r\n\r\n\tvar serviceFee = Number($('#subtotal_service_fee').val());\r\n\t$('#OEH_subtotal_service_fee').html(formatAsMoney(serviceFee));\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (serviceFee * 1));\r\n\r\n\tif (curPPDiscount > 0)\r\n\t{\r\n\t\tvar food_portion_of_points_credit = 0;\r\n\t\tvar fee_portion_of_points_credit = 0;\r\n\r\n\t\tif (discountMFYFeeFirst && serviceFee > 0)\r\n\t\t{\r\n\r\n\t\t\tif (curPPDiscount > serviceFee)\r\n\t\t\t{\r\n\t\t\t\tfood_portion_of_points_credit = curPPDiscount - serviceFee;\r\n\t\t\t\tfee_portion_of_points_credit = serviceFee;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tfee_portion_of_points_credit = curPPDiscount;\r\n\t\t\t\tfood_portion_of_points_credit = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar foodPortionOfMaxDeduction = discountablePlatePointsAmount - serviceFee;\r\n\r\n\t\t\tif (curPPDiscount > foodPortionOfMaxDeduction)\r\n\t\t\t{\r\n\t\t\t\tvar remainderAfterFoodDiscount = curPPDiscount - foodPortionOfMaxDeduction;\r\n\t\t\t\tfood_portion_of_points_credit = foodPortionOfMaxDeduction;\r\n\t\t\t\tfee_portion_of_points_credit = remainderAfterFoodDiscount;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tfood_portion_of_points_credit = curPPDiscount;\r\n\t\t\t\tfee_portion_of_points_credit = 0;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$('#OEH_plate_points_order_discount_food').html(formatAsMoney(food_portion_of_points_credit));\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(fee_portion_of_points_credit));\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#OEH_plate_points_order_discount_food').html(formatAsMoney(0));\r\n\t\t$('#OEH_plate_points_order_discount_fee').html(formatAsMoney(0));\r\n\t}\r\n\r\n\r\n\r\n\t// -------------------------------------------------------- Session Discount\r\n\r\n\tSessDisc = $('#SessDiscnoSD');\r\n\tif (SessDisc.length)\r\n\t{\r\n\r\n\t\tsession_discount_basis = Number((session_discount_basis * 1) - (directDiscountVal * 1) - (food_portion_of_points_credit * 1));\r\n\r\n\t\tvar selectedSD = $('input[name=SessDisc]:checked', '#editorForm').val();\r\n\r\n\t\tif (selectedSD == null || selectedSD == \"\")\r\n\t\t\tselectedSD = \"noSD\";\r\n\r\n\t\tvar sessionDiscount = -1;\r\n\r\n\t\tif (selectedSD == \"originalSD\")\r\n\t\t{\r\n\t\t\tsessionDiscount = formatAsMoney((session_discount_basis * (originalSD) ? originalSD.value : \"0\") / 100);\r\n\t\t}\r\n\t\telse if (selectedSD == \"activeSD\")\r\n\t\t{\r\n\t\t\tsessionDiscount = formatAsMoney((session_discount_basis * activeSessionDiscount.value) / 100);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tsessionDiscount = 0;\r\n\t\t}\r\n\r\n\r\n\t\tSDiscountElem = $('#OEH_session_discount');\r\n\t\tif (SDiscountElem.length)\r\n\t\t{\r\n\t\t\tSDiscountElem.html(formatAsMoney(sessionDiscount));\r\n\t\t\tnewGrandTotal = formatAsMoney(newGrandTotal - sessionDiscount);\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// nonFood\r\n\tvar miscNonFoodSubtotal = Number($('#misc_nonfood_subtotal').val());\r\n\t$('#OEH_misc_nonfood_subtotal').html(formatAsMoney(miscNonFoodSubtotal));\r\n\tnewGrandTotal = Number((newGrandTotal * 1) + (miscNonFoodSubtotal * 1));\r\n\r\n\r\n\t// --------------------------------------------------------------------- tax\r\n\r\n\t// Currently the only taxed product is the enrollment fee which is taxed at a special rate\r\n\tvar newNonFoodTax = formatAsMoney(miscNonFoodSubtotal * (curNonFoodTax / 100 ));\r\n\tvar enrollmentTax = formatAsMoney(productsSubTotal * (curEnrollmentTax / 100 ));\r\n\tnewNonFoodTax *= 1; // convert to float\r\n\tnewNonFoodTax += (enrollmentTax * 1);\r\n\t//TODO: will have other products than enrollment someday.\r\n\tif (productsSubTotal)\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food & Enrollment Tax');\r\n\t}\r\n\telse\r\n\t{\r\n\t\t$('#nonFoodTaxLabel').html('Non-Food Tax');\r\n\t}\r\n\r\n\tvar newFoodTax = 0;\r\n\tvar newServiceTax = 0;\r\n\r\n\r\n\tif (curPPDiscount > 0)\r\n\t{\r\n\t\tnewFoodTax = formatAsMoney(((newGrandTotal + (curPPDiscount * 1) - miscNonFoodSubtotal - serviceFee - food_portion_of_points_credit) * (curFoodTax / 100 )) + .000001);\r\n\t\tnewServiceTax = formatAsMoney(((serviceFee -  fee_portion_of_points_credit) * (curServiceTax / 100 )) + .000001);\r\n\t}\r\n\telse\r\n\t{\r\n\t\tnewFoodTax = formatAsMoney(((newGrandTotal - miscNonFoodSubtotal - serviceFee) * (curFoodTax / 100 )) + .000001);\r\n\t\tnewServiceTax = formatAsMoney(serviceFee * (curServiceTax / 100 ) + .000001);\r\n\t}\r\n\r\n\ttaxElem = document.getElementById('OEH_tax_subtotal');\r\n\tif ( taxElem )\r\n\t\ttaxElem.innerHTML = formatAsMoney(newNonFoodTax);\r\n\r\n\ttaxElem = document.getElementById('OEH_food_tax_subtotal');\r\n\tif ( taxElem )\r\n\t\ttaxElem.innerHTML = formatAsMoney(newFoodTax);\r\n\r\n\ttaxElem = document.getElementById('OEH_service_tax_subtotal');\r\n\tif ( taxElem )\r\n\t\ttaxElem.innerHTML = formatAsMoney(newServiceTax);\r\n\r\n\tvar preTaxTotal = Number(newGrandTotal);\r\n\tnewGrandTotal = (newGrandTotal * 1) + (newFoodTax * 1) + (newNonFoodTax * 1) + (newServiceTax * 1);\r\n\r\n\t// -------------------------------------------------------------------- grand total\r\n\t$('#OEH_grandtotal').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_new_total').html(formatAsMoney(newGrandTotal));\r\n\t$('#OEH_delta').html(formatAsMoney((orderInfoGrandTotal - newGrandTotal) * -1));\r\n\r\n\tvar paymentTotal = 0;\r\n\tif($('#OEH_paymentsTotal').length)\r\n\t{\r\n\t\tpaymentTotal = $('#OEH_paymentsTotal').html();\r\n\t}\r\n\r\n\tvar remainingBalance = Number(formatAsMoney(paymentTotal - newGrandTotal));\r\n\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance * -1));\r\n\r\n\t// Values are now calculated and the summary display updated\r\n\t// Next Display \"balance\" messages and set up payments\r\n\r\n\tif (orderState == 'CANCELLED')\r\n\t{\r\n\t\tremainingBalance = paymentTotal;\r\n\t\t$('#OEH_remaing_balance').html(formatAsMoney(remainingBalance));\r\n\r\n\t}\r\n\r\n\tif (remainingBalance > 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to the customer.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_customer_owed');\r\n\t\t$(\"#newPaymentDiv\").hide();\r\n\r\n\t\tif (canAdjustDelayedPayment && currentDPAmount > 0)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#creditDiv').show();\r\n\t\t}\r\n\r\n\r\n\t\t$('#payment1_type').val('');\r\n\t\t$('#payment2_type').val('');\r\n\t\tchangePayment1('');\r\n\t\tchangePayment2('');\r\n\r\n\t\tpaymentChanges = true;\r\n\r\n\t\t$(\"#use_store_credits\").prop('checked', false);\r\n\t\t$(\"#use_store_credits\").prop('disabled', true);\r\n\r\n\t}\r\n\telse if (remainingBalance < 0)\r\n\t{\r\n\t\t$(\"#balance_msg\").html(formatAsMoney(remainingBalance * -1) + \" owed to your store.\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_store_owed');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\r\n\t\tvar doNewLivePaymentAdjustments = true;\r\n\t\tif (doNewLivePaymentAdjustments)\r\n\t\t{\r\n\r\n\t\t\tvar defaultPaymentAmount = remainingBalance * -1;\r\n\r\n\t\t\tif ($(\"#use_store_credits\").is(\":checked\"))\r\n\t\t\t{\r\n\r\n\t\t\t\tvar amountStoreCredit = Number($(\"#store_credits_amount\").val());\r\n\t\t\t\tif (isNaN(amountStoreCredit.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tamountStoreCredit = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount -= amountStoreCredit.valueOf();\r\n\t\t\t}\r\n\r\n\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount);\r\n\r\n\t\t\tif ($('#payment1_type').val()  == 'CC')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_cc_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val() == 'CHECK')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if ($('#payment1_type').val().split(\"_\")[0] == 'REF')\r\n\t\t\t{\r\n\t\t\t\t$('#payment1_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t}\r\n\t\t\telse if (($('#payment1_type').val() == 'GIFT_CERT' || $('#payment1_type').val() == \"GIFT_CARD\") && $('#payment2_type').val() != \"\")\r\n\t\t\t{\r\n\t\t\t\tvar payment1Amount = null;\r\n    \t\t\tif ($('#payment1_type').val()  == 'GIFT_CERT')\r\n    \t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#payment1_gc_total_amount').val());\r\n    \t\t\t}\r\n    \t\t\telse if ($('#payment1_type').val() == 'GIFT_CARD')\r\n    \t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number($('#debit_gift_card_amount').val());\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isNaN(payment1Amount.valueOf()))\r\n\t\t\t\t{\r\n\t\t\t\t\tpayment1Amount = Number(0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdefaultPaymentAmount = formatAsMoney(defaultPaymentAmount - payment1Amount.valueOf());\r\n    \t\t\tif ($('#payment2_type').val()  == 'CC')\r\n    \t\t\t{\r\n    \t\t\t\t$('#payment2_cc_total_amount').val(defaultPaymentAmount);\r\n    \t\t\t}\r\n    \t\t\telse if ($('#payment2_type').val() == 'CHECK')\r\n    \t\t\t{\r\n    \t\t\t\t$('#payment2_check_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n    \t\t\telse if ($('#payment2_type').val() == 'CASH')\r\n    \t\t\t{\r\n    \t\t\t\t$('#payment2_cash_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n    \t\t\telse if ($('#payment2_type').val().split(\"_\")[0] == 'REF')\r\n    \t\t\t{\r\n    \t\t\t\t$('#payment2_ref_total_amount').val(defaultPaymentAmount);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\telse // == 0\r\n\t{\r\n\t\t$(\"#balance_msg\").html(\"0.00\");\r\n\t\t$(\"#balanceRow\").addClass('balance_msg_balanced');\r\n\t\t$(\"#newPaymentDiv\").show();\r\n\t\t$('#creditDiv').hide();\r\n\r\n\t\tif (canAdjustDelayedPayment)\r\n\t\t{\r\n\t\t\t$('#dp_adjust_down_div').hide();\r\n\t\t}\r\n\r\n\t\t$(\"#use_store_credits\").prop('disabled', false);\r\n\r\n\t\tassignBalanceToRefTransactions(0);\r\n\t}\r\n\r\n\tif (newGrandTotal == 0 && $('#payment1_type').val() == \"\" && $('#payment2_type').val() == \"\" && !onTimeShotAtSupplyingZeroPaymentHasOccurred && orderState == 'SAVED')\r\n\t{\r\n\t\t$('#payment1_type').val('CASH');\r\n\t\tchangePayment1('CASH');\r\n\t\t$('#payment1_cash_total_amount').val(\"0.00\");\r\n\r\n\t\tonTimeShotAtSupplyingZeroPaymentHasOccurred = true;\r\n\t}\r\n\r\n\r\n\tvar autoAdjustDiv = $('#autoAdjustDiv');\r\n\tif \t(autoAdjustDiv.length)\r\n\t{\r\n\r\n\t\tif (remainingBalance != 0 && canAutoAdjust)\r\n\t\t{\r\n\t\t\tif (canAdjustDelayedPayment && (currentDPAmount > 0 || remainingBalance < 0))\r\n\t\t\t{\r\n\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>adjust customer's delayed payment.</b></span>\");\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif (remainingBalance > 0)\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>credit customer's credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t$('#OEH_auto_pay_msg').html(\"Check this to <span id='adj_action'><b>charge original credit card now.</b></span>\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tautoAdjustDiv.show();\r\n\t\t\tif (!forceManualAutoAdjust)\r\n\t\t\t{\r\n\t\t\t\t$('#autoAdjust').prop('checked', true);\r\n\t\t\t\thandleAutoAdjust($('#autoAdjust').get()[0]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t    // if the div is hidden skip these steps\r\n\r\n\t\t    if (autoAdjustDiv.is(\":visible\"))\r\n\t\t    {\r\n\t\t\t\tautoAdjustDiv.hide();\r\n\t\t\t\t$('#autoAdjust').prop('checked', false);\r\n\t\t\t\t$('#payment1_type').val('');\r\n\t\t\t\t$('#payment2_type').val('');\r\n\t\t\t\tchangePayment1('');\r\n\t\t\t\tchangePayment2('');\r\n\t\t    }\r\n\t\t}\r\n\t}\r\n\r\n\t$('#help_msg').html(\"\");\r\n\r\n\t// enforce a few rules by disallowing checkout\r\n\tif ( $('#submit_changes').length )\r\n\t{\r\n\r\n\t\tif ( servings > 0 || sideDishQty > 0 || addonsSubtotal > 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", false);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t}\r\n\r\n\t\tif (directDiscountVal >= (Number(preTaxTotal) + Number(directDiscountVal)) && preTaxTotal != 0)\r\n\t\t{\r\n\t\t\t$('#submit_changes').prop(\"disabled\", true);\r\n\t\t\t$('#help_msg').html($('#help_msg').html() + \"You cannot use a Direct Order Discount that is equal to or greater than the new grand total. Please use the \\\"No Charge\\\" payment type to give away an order.\");\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif ($('#help_msg').length)\r\n\t{\r\n\t\tif ($('#help_msg').html() != \"\")\r\n\t\t{\r\n\t\t\t$('#help_msg').show();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$('#help_msg').hide();\r\n\t\t}\r\n\t}\r\n\r\n\treportPaymentStatus(false);\r\n\r\n\tHideLineItemsIfZero();\r\n\r\n\tif (orderState != 'NEW')\r\n\t{\r\n\t\tupdateChangeList();\r\n\t}\r\n\r\n}"],"names":["itemChanges","discountOrPaymentChanges","discountChanges","reportingChanges","paymentChanges","initialSessionDiscountSetting","initialPreferredUserDiscountSetting","changeList","isFactoringCredit","currentCreditAvailable","stationNeedsAttention","relatedOrdersAreLoaded","currentlySavingOrder","onTimeShotAtSupplyingZeroPaymentHasOccurred","needPlatePointsMaxDiscountChangeWarning","lastMaxPPDiscountAmount","admin_order_mgr_init","store_id","STORE_DETAILS","id","orderState","setupForNewOrder","setupForSavedOrder","setupForActiveOrder","hasBundle","bundleSetup","setupSiteAdminFunctions","initChangeList","calculateTotal","setAllPaymentFieldsToUnrequired","setupCouponState","setUpKeyHandlers","getQueryVariable","query","window","location","search","substring","vars","split","newQueryString","first","i","length","pair","historyPush","url","handle_special_instruction_notes","handle_cancel_order","handle_delete_saved_order","handle_free_menu_item_edit","handle_fundraiser_selection","intenseLoggingOn","intenseLogging","message","console","log","saveSpecialInstructions","special_instructions","strip_tags","$","val","ajax","type","timeout","dataType","data","processor","user_id","op","order_id","success","json","processor_success","updateInstructionsOrgValues","processor_message","dd_message","title","error","objAJAXRequest","strError","responseText","response","each","this","on","e","booking_id","do_op","do","note","textarea_elem","addClass","special_instruction_note","html","removeClass","hide","show","nl2br","lastCheckedGiftCertNumber","document","onkeypress","OMDefaultKeyHandler","evt","event","charCode","which","keyCode","processCode","stopPropagation","isNaN","getChangeListHTML","height","width","modal","div_id","dialogClass","noOk","position","my","at","of","close","ui","remove","flagName","checkbox","newState","is","oldState","cancel","prop","confirm","flag","new_state","attr","updateItemsOrgValues","isDreamTaste","isFundraiser","updateChangeList","saveAll","saveItems","saveDiscountsUponCompletion","dd_toast","itemsList","introItemsList","subItemsList","is_intro","item_id","misc_food_subtotal","misc_nonfood_subtotal","subtotal_service_fee","misc_food_subtotal_desc","misc_nonfood_subtotal_desc","service_fee_description","items","intro_items","sub_items","itemTabIsDirty","saveDiscounts","setSessionAndSave","session_id","displayModalWaitDialog","dd_csrf_token","full_session_warning_required","bounce","getTokenToken","Reschedule","org_session_id","saved_booking_id","new_session_id","new_session_time","RetrieveCalendar","canDelayPayment","hideFlex","showFlex","session_discount","value","activeSessionDiscount","session_info","session_type_text","remaining_slots","remaining_intro_slots","serviceFeeUpdate","formatAsMoney","serviceFeeDescUpdate","onSetSessionAndSave","obj","onSaveItems","HideLineItemsIfZero","timestamp","discountEligable","limited_access","click","find","onSessionTabSelected","onSessionTabDeselected","onItemsTabSelected","onItemsTabDeselected","onPaymentTabSelected","onPaymentTabDeselected","onRelatedOrdersTabSelected","onRelatedOrdersTabDeselected","onNotesTabSelected","handle_guest_account_notes","handle_admin_carryover_notes","handle_admin_order_notes","onNotesTabDeselected","onPaymentSelected","onPaymentDeselected","onSiteAdminTabSelected","onSiteAdminTabDeselected","updateDiscountOrgValues","updateActiveOrder","payOnCompletion","go_to_confirm","direct_order_discount","PUDSetting","plate_points_discount","SessDiscSetting","DR_level","curOrderLevel","dream_rewards_level","JSON","stringify","changeListStr","onAddPaymentAndActivate","_validate_discounts","couponFreeMenuItemRequired","_check_elements","get","coupon_id","coupon_free_menu_item","fundraiser_id","fundraiser_value","updateReportingOrgValues","couponFreeMenuItem","paymentToken","send","token","paymentNumber","warnOfOutstandingSavedOrdersOnFullSession","addOnly","payment1Data","next_dest","contentWindow","pp_success","error_code","buttons","Okay","reload","reloadOnFailure","href","comment_payload","PayFlow_Payload","addNameValuePair","user_email","expdate","csc","amt","payload","USER_DETAILS","use_store_credits","store_credit_amount","DP_State","depositAmount","store_specific_deposit","payflowErrorURL","parmList","retrieveEncodedString","key","hasOwnProperty","tr_action","pfp_test_mode","transparent_redirect_link","create_and_submit_form","action","target","input","SECURETOKEN","SECURETOKENID","tokenID","PARMLIST","getPaymentData","payment_number","paymentData","number","amount","cert_type","ccNameOnCard","ccType","ccMonth","ccYear","cc_security_code","billing_address","billing_postal_code","is_store_specific_flat_rate_deposit_delayed_payment","do_not_ref","DPSetting","alert","indexOf","reference_id","validatePayment1","inputArray","validates","substr","depositWarningStr","CC1Amount","validatePayment2","addPaymentAndActivate","servingsCount","Number","valueOf","changesBlurb","getAbbreviatedSummaryString","discounts_are_valid","bundleIsSelected","numBundItems","countSelectedBundleItems","save2PaymentsAndBookOrder","payment2Type","payment2Data","supports_transparent_redirect","async","payment_data","add_payment_data","delay_remainder","billing_name","billing_zip","chain_token","savePayment2","handleDirectPayment","payment1Type","mainPaymentData","additionalPaymentData","store_credits_amount","closeOnEscape","Refresh","cur_session_id","onDayClick","doReschedule","sessionTime","curSessionDate","open","siblings","focus","onRescheduleClick","isDiscounted","control_message","onSessionClick","monthChange","monthVal","handle_delayed_payment","tc_delayed_payment_agree","lang","en","tc","terms_and_conditions","delayed_payment","parent","Agree","off","set_user_pref","Decline","trigger","delayed_payment_decline","createBonusCredit","creditConsumed","creditBasis","removeBonusCredit","handleSummaryDisplayChange","checked","ShowAllLineItems","serviceFeeOrg","serviceFee","serviceTaxOrg","serviceTax","miscFoodOrg","miscFood","miscNonFoodOrg","miscNonFood","doDiscountOrg","doDiscount","couponDiscountOrg","couponDiscount","platePointsDiscountOrg","platePointsDiscount","sessionDiscountOrg","pudDiscount","foodTaxOrg","foodTax","nonFoodTaxOrg","nonFoodTax","productsSubtotalOrg","productsSubtotal","sort_by_price","a","b","price","getPlatePointsDiscountableAmount","total","retVal","nonDiscountableAmount","sort","thisItem","servingThisItem","qty","serving_size","costThisItem","orgAmount","remainingServings","remainingItems","getElementById","miscFoodSubtotal","drawChangeList","htmlStr","item","stdMenuItems","pricing_type","FTMenuItems","hadMiscCostChanges","miscCosts","getHumanReadableName","miscDescs","order_type","bundleItems","discounts","reporting","coupon","change_type","ccRefundTotal","parseFloat","bundleChecked","stdItemCount","FTItemCount","curVal","descIDStr","desc","bundleOrgVal","discountsHTML","newSDValue","newPUDValue","showSaveButton","orgVal","newVal","diff","orgCouponVal","curCouponVal","allowLimitedAccess","handleAutoAdjust","balance","canAdjustDelayedPayment","currentDPAmount","changePayment1","adjustPendingDelayedPayment","assignBalanceToRefTransactions","ident","existingPaymentAmountArray","reportPaymentStatus","getAbbreviatedChangeString","addedStd","removedStd","addedFT","removedFT","addedBI","removedBI","addPaymentToLockedOrder","submitPage","form","is_valid","confirm_and_check_form","dialogHeight","name","appendTo","submit","resetPage","_check_form","dd_round_amount","inAmount","tempVal","parseInt","pennyFraction","Math","floor","updateSideStationStatus","entree_id","help_message","stationHelpName","stationHelpElem","css","requiredItemCount","sideStationBundleInfo","number_items_required","numRequiredSpanName","numSelected","bundle","sid","sinfo","itemQty","inv_qty","entreeIDToInventoryMap","remaining","servings_per_item","numSelectedSpanName","entrees","servings","halfQty","wholeQty","introQty","sideDishQty","sideDishSubTotal","bundlesSubTotal","productsSubTotal","bundlesQty","discounted_total","creditContribution","DRSubjectCreditContribution","main_items_count","aux_items_count","PUDExcludedItemsTotal","PUDExcludedFullItemsCount","PUDExcludedHalfItemsCount","sortedCoreItemList","itemsSelected","x","org_remaining","itemId","getAttribute","temp_servings","push","originallyHadBundle","selectedBundleItemCount","selectedBundleServingsCount","bundleInfo","tasteBundleMenuData","hasDreamTasteBundle","selectedWholeBundleItemCount","selectedHalfBundleItemCount","dreamTastePrice","tasteItemQty","discountablePlatePointsAmount","couponlimitedToFT","tempCouponVal","background-color","color","removeAttr","maxPPCredit","maxPPDeduction","curPPDiscount","addonsSubtotal","addonsQty","itemNumber","qty_str","prc_str","addQty","addonsQtyNumber","addPrc","addPrcNumber","toString","totalMealQuantity","itemCountLabel","itemCountAdjustmentAmount","displayServingsAdjustment","couponTypeElem","cfm_size","displayMealCount","displayServingCount","orderEditSuccess","newAddonQty","premarkup_total","freeMealValue","newAddonAmount","round","food_costs","session_discount_basis","newGrandTotal","pre_discounts_grand_total","directDiscountVal","directDiscount","couponDiscountMethod","newDiscountAmount","couponDiscountVar","newDiscountVal","couponDiscountVal","PUDElem","selectedUP","UPDiscount","premarkup_discounted_total","UPType","PcntTypeValue","originalUP","cost","halfCost","basis","multiplier","pud_result","rounded_pud_result","activeUP","halfCost2","promoVal","UPDiscountElem","food_portion_of_points_credit","fee_portion_of_points_credit","discountMFYFeeFirst","foodPortionOfMaxDeduction","remainderAfterFoodDiscount","SessDisc","selectedSD","sessionDiscount","originalSD","SDiscountElem","miscNonFoodSubtotal","newNonFoodTax","curNonFoodTax","enrollmentTax","curEnrollmentTax","newFoodTax","newServiceTax","curFoodTax","curServiceTax","taxElem","innerHTML","preTaxTotal","orderInfoGrandTotal","paymentTotal","remainingBalance","changePayment2","doNewLivePaymentAdjustments","defaultPaymentAmount","amountStoreCredit","payment1Amount","autoAdjustDiv","canAutoAdjust","forceManualAutoAdjust"],"mappings":"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"}