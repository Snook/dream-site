var useTransparentRedirect=!1,codes="",i=0,x=0,browser=navigator.appName;function keyHandler(e){if("Microsoft Internet Explorer"==browser)var a=document.all?event.keyCode:e.keyCode;else a=e.keyCode?e.keyCode:e.charCode;if(13==a)return!1;if(94==a){if(codes.length>=15){var r=document.getElementById("gift_card_number");r&&(r.value=codes)}else codes="",i=0;return!1}if(15==codes.length)return!1;if("%"==String.fromCharCode(a)&&0==i)i=1;else if("B"==String.fromCharCode(a)&&1==i)i=2;else{if(2==i&&(parseInt(a)>57||parseInt(a)<48)&&94!=a&&8!=a)return!1;if((parseInt(a)>57||parseInt(a)<48)&&i<2&&94!=a&&"B"!=String.fromCharCode(a)&&8!=a)return!1}"B"!=String.fromCharCode(a)&&2==i&&"^"!=String.fromCharCode(a)&&(codes+=String.fromCharCode(a))}function _override_check_form(e){return!1}function _submit_click(e){e.style.display="none";var a=$("#gift_card_load")[0];if(_check_form(a)){var r=$("#amount").val();if(isNaN(r)||r<25||r>500)return dd_message({title:"Error",message:"Please enter a dollar amount greater or equal to $25 and no greater than $500."}),$("#amount").addClass("input_in_error"),document.getElementById("procCardLoadBtn").style.display="block",!0;var o="Load Gift Card #"+$("#gift_card_number").val()+" by the amount of $"+formatAsMoney($("#amount").val())+"?";dd_message({title:"Submit Gift Card Order",message:o,modal:!0,confirm:function(){useTransparentRedirect?getTokenAndSubmit():submitDirect()},cancel:function(){$("#procCardLoadBtn").show()}})}else document.getElementById("procCardLoadBtn").style.display="block";return!0}function submitDirect(){$("<input>").attr({type:"hidden",name:"load_submit",value:"load_submit"}).appendTo($("#gift_card_load")),$("#gift_card_load").submit()}function getTokenAndSubmit(){displayModalWaitDialog("TR_process_dialog","Please wait as the payment is processed. This may take a short while.");var e=$("#billing_name").val(),a=$("#billing_address").val(),r=$("#billing_zip").val(),o=$("#primary_email").val(),t=new PayFlow_Payload,d={bname:e,badd:a,bzip:r,bemail:o},n=new PayFlow_Payload;n.addNameValuePair("UserID",0),n.addNameValuePair("StoreID",0),n.addNameValuePair("OrderID",0),n.addNameValuePair("Email",o),t.addAssocArray("billing_data",d);var i=$("#amount").val();$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:store_id,op:"get_token",order_id:0,amount:i,billing_name:e,billing_address:a,billing_zip:r,use_corp:!0,check_smart_transactions:!0,dd_csrf_token:$("input[name=dd_csrf_token]","#gift_card_load").val(),chain_token:!0},success:function(e){($("input[name=dd_csrf_token]","#gift_card_load").val(e.getTokenToken),e.processor_success)?submit_to_paypal(e.token,t,n):($("#procCardLoadBtn").show(),$("#TR_process_dialog").remove(),dd_message({title:"Error",message:e.processor_message}))},error:function(e,a){$("#procCardLoadBtn").show(),$("#TR_process_dialog").remove(),response="Unexpected error: "+a,dd_message({title:"Error",message:response})}})}function submit_to_paypal(e,a,r){$("#paypal-result").on("load",(function(){dd_console_log("frame is loading in submit_to_paypal()");try{var e=$("#paypal-result").get(0).contentWindow.next_dest,a=$("#paypal-result").get(0).contentWindow.pp_success;dd_console_log("successful access with next_dest as "+e)}catch(e){return dd_console_log("exception thrown accessing iFrame: "+e.message),$("#TR_process_dialog").remove(),$("#procCardLoadBtn").show(),void dd_message({title:"Exception",message:"Some required information is missing or incorrect. Please correct the fields below and try again."})}if(a)dd_console_log("sucess! about to bounce to "+e),bounce(e);else{dd_console_log("failure! ");var r=$("#paypal-result").get(0).contentWindow.error_code,o=$("#paypal-result").get(0).contentWindow.message;void 0===o&&(dd_console_log("failure with no data! "),r="Generic",o="An unexpected error has occurred. It appears that the Gift Card processor is currently unavailable. Please contact Dream Dinners support at 1-360-804-2020."),$("#TR_process_dialog").remove(),dd_message({title:"Error: "+r,message:o}),$("#procCardLoadBtn").show()}}));var o=$("#credit_card_exp_month").val();o+=$("#credit_card_exp_year").val();var t=$("#credit_card_cvv").val(),d=$("#amount").val(),n=$("#gift_card_number").val(),i=$("#credit_card_type").val();a.addNameValuePair("user_id",0),a.addNameValuePair("store_id",store_id),a.addNameValuePair("order_id","none"),a.addNameValuePair("caller_id","fadmin_load"),a.addNameValuePair("card_type",i),a.addNameValuePair("gcnum",n),a.addNameValuePair("admin_user_id",USER_DETAILS.id),"undefined"==typeof payflowErrorURL&&(payflowErrorURL="https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback");var s="ERRORURL="+payflowErrorURL+"&ACCT="+$("#credit_card_number").val()+"&EXPDATE="+o+"&CSC="+t+"&AMT="+d+"&USER1="+a.retrieveEncodedString()+"&COMMENT1="+r.retrieveEncodedString(),l="https://payflowlink.paypal.com";if("undefined"!=typeof pfp_test_mode&&pfp_test_mode)l="https://pilot-payflowlink.paypal.com";"undefined"!=typeof transparent_redirect_link&&(l=transparent_redirect_link),dd_console_log("About to send! "),create_and_submit_form({action:l,target:"paypal-result",input:{SECURETOKEN:e.token,SECURETOKENID:e.tokenID,PARMLIST:s}})}