var hasChangedCOGS=!1;function reports_p_and_l_init(){$("html").bind("keypress",(function(e){if(13==e.keyCode)return!1})),init_money_formatting(),init_update_p_and_l_data(),$(".gt_input").each((function(){$(this).val(addFormatting($(this).val()))})),window.onbeforeunload=function(e){if(detectChanges()){var t="Important: Please click on 'Save' button to leave this page.";return void 0===e&&(e=window.event),e&&(e.returnValue=t),t}}}function init_money_formatting(){$(".gt_input").focus((function(){$(this).val(removeFormatting($(this).val()))})),$(".gt_input").blur((function(){$(this).val(addFormatting($(this).val()))})),$(".gt_input").keypress((function(e){return 188==e.which||190==e.which||46==e.which||45==e.which||8==e.keyCode||9==e.keyCode||37==e.keyCode||39==e.keyCode||45==e.keyCode||e.which>47&&e.which<58||13==e.keyCode&&($(this).blur(),!0)})),$(".gt_input").change((function(){if(isNaN($(this).val()))return!1}))}function detectChanges(){var e=!1;return $("#finance_div input").each((function(){"other_expenses"!=this.id&&(1*$(this).data("org_value")!=1*removeFormatting($(this).val())?($(this).addClass("unsaved_field"),e=!0):$(this).removeClass("unsaved_field"))})),e}function init_update_p_and_l_data(){var e=new Number(0);$('[data-dd_subtype="expense"]').each((function(){e+=new Number(removeFormatting($(this).val()))}));var t=new Number(removeFormatting($("#p_and_l_total_agr").html())),n=new Number(removeFormatting($("#p_and_l_marketing_total").html())),a=new Number(removeFormatting($("#p_and_l_royalty_total").html())),r=new Number(removeFormatting($("#net_income").val())),o=new Number(removeFormatting($("#p_and_l_salesforce_fee").html()));$("#other_expenses").val(addFormatting(t-(e+n+a+o)-r)),$(".gt_input").keyup((function(){var e=new Number(removeFormatting($("#net_income").val())),t=new Number(0);$('[data-dd_subtype="expense"]').each((function(){t+=new Number(removeFormatting($(this).val()))}));var r=new Number(removeFormatting($("#p_and_l_total_agr").html()));$("#other_expenses").val(addFormatting(r-(t+n+a+o)-e))})),$("#update_p_and_l").click((function(){var e=!1;if($("#owner_hours, #employee_hours, #manager_hours").each((function(){isNaN($(this).val())&&(dd_message({title:"Error",message:"The hours fields must be a number."}),e=!0)})),e)return!1;var t=new Object;return $("#finance_div input").each((function(){t[this.id]=removeFormatting($(this).val())})),$("#finance_div input").each((function(){""==t[this.id]&&(t[this.id]="not supplied")})),$("#cost_of_goods_and_services").data("org_value")!=$("#cost_of_goods_and_services").val()&&(hasChangedCOGS=!0),$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_p_and_l_data",store_id:store_id,month:month,year:year,p_and_l_data:t},success:function(e){e.processor_success?(dd_toast({message:"Your data was saved."}),hasChangedCOGS&&(hasChangedCOGS=!1,$("#cogs_msg").html("")),$("#finance_div input").each((function(){if("other_expenses"!=this.id){var e=removeFormatting($(this).val());$(this).data("org_value",e),$(this).removeClass("unsaved_field")}}))):(dd_message({title:"Error",message:e.processor_message}),detectChanges())},error:function(e,t){response="Unexpected error: "+t,dd_message({title:"Error",message:response})}}),!1}))}function roundToTenths(e){return e-=0,(e=Math.round(10*e)/10)==Math.floor(e)?e+".0":e==Math.floor(e)?e+"0":e}function doRunReport(){var e=parseInt($("#year_field_001").val());return isNaN(e)?(dd_message({title:"Error",message:"The year is not an integer."}),!1):e<2011?(dd_message({title:"Error",message:"The year must be greater than 2010."}),!1):($("#avg_ticket_goal").remove(),$("#finishing_touch_goal").remove(),$("#taste_sessions_goal").remove(),$("#regular_guest_count_goal").remove(),$("#taste_guest_count_goal").remove(),$("#intro_guest_count_goal").remove(),$("[data-dd_type='p&l_widget']").remove(),void $("#p_and_l_form").submit())}function _report_submitClick(e){var t=!0;if(detectChanges()&&(t=!1,dd_message({title:"Unsaved Changes",message:"You have some unsaved changes. Click 'Cancel' to return and save your changes.",cancel:function(){},confirm:function(){return doRunReport()}})),t)return doRunReport()}function removeFormatting(e){return null==e||""==e?e:e=(e=e.replace(/,/,"")).replace(/\$/,"")}function addFormatting(e){return null==e||""==e?"":e=accounting.formatMoney(e,"$",2,",",".","%s%v")}