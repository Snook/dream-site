{"version":3,"sourceRoot":"js/src/dreamdinners","sources":["reports_map_activity.js"],"sourcesContent":["var timeframe = 60; // minutes\r\nvar checkperiod = 10; // seconds\r\nvar last_time = (((new Date).getTime() / 1000) - (timeframe * 60));\r\nvar map = null;\r\nvar markers = [];\r\nvar hasrun = false;\r\n\r\nfunction initMap()\r\n{\r\n\tvar country = \"United States\";\r\n\r\n\tvar myOptions = {\r\n\t\tzoom: 5,\r\n\t\tmapTypeId: 'roadmap'\r\n\t};\r\n\r\n\t// create map\r\n\tmap = new google.maps.Map(document.getElementById(\"map\"), myOptions);\r\n\r\n\t// center map on country\r\n\tvar geocoder = new google.maps.Geocoder();\r\n\tgeocoder.geocode({'address': country}, function (results, status) {\r\n\t\tif (status == google.maps.GeocoderStatus.OK)\r\n\t\t{\r\n\t\t\tmap.setCenter(results[0].geometry.location);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\talert(\"Could not find location: \" + location);\r\n\t\t}\r\n\t});\r\n\r\n\t// start loop\r\n\tmap_activity_timer();\r\n}\r\n\r\nfunction map_activity_timer()\r\n{\r\n\t// cancel existing timer if there is one\r\n\t$.doTimeout('map_activity_timer');\r\n\r\n\t// check every checkperiod for new activity\r\n\t$.doTimeout('map_activity_timer', (checkperiod * 1000), function () {\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 60000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_reports_map_activity',\r\n\t\t\t\tlast_time: last_time\r\n\t\t\t},\r\n\t\t\tsuccess: function (json, status) {\r\n\r\n\t\t\t\ttime_in = 1;\r\n\r\n\t\t\t\t$.each(json.data, function (key) {\r\n\r\n\t\t\t\t\t// first load drops pins separately\r\n\t\t\t\t\ttime_in++;\r\n\r\n\t\t\t\t\t// store data\r\n\t\t\t\t\tvar marker_data = this;\r\n\r\n\t\t\t\t\t// set latest timestamp from data\r\n\t\t\t\t\tif (this.timestamp_updated_unix > last_time)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlast_time = this.timestamp_updated_unix;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tsetTimeout(function (expire) {\r\n\t\t\t\t\t\tset_marker(marker_data, PATH.image + '/style/logo/heart-grn-75x55.png', 0);\r\n\t\t\t\t\t\tconsole.log((new Date).toTimeString().slice(0, 8) + ': Adding marker #' + marker_data.id);\r\n\t\t\t\t\t}, time_in * 200);\r\n\r\n\t\t\t\t\tfadmin_is_idle(false);\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t// error\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\t// prevent fadmin logout\r\n\t\tif (USER_LOGGEDIN && $.cookie('DreamSite_TO'))\r\n\t\t{\r\n\t\t\tTO = $.cookie('DreamSite_TO');\r\n\r\n\t\t\tfadmin_is_idle(false);\r\n\t\t}\r\n\r\n\t\t// loop doTimeout\r\n\t\treturn true;\r\n\r\n\t});\r\n\r\n\t// call it immediately\r\n\t$.doTimeout('map_activity_timer', true);\r\n}\r\n\r\nfunction sort_list()\r\n{\r\n\t$(\"#event\").each(function () {\r\n\t\t$(this).html($(this).children('li').sort(function (a, b) {\r\n\t\t\treturn ($(b).data('time')) > ($(a).data('time')) ? 1 : -1;\r\n\t\t}));\r\n\t});\r\n}\r\n\r\nfunction set_marker(marker_data, icon, zindex)\r\n{\r\n\t// create marker\r\n\tvar marker = new google.maps.Marker({\r\n\t\tanimation: google.maps.Animation.DROP,\r\n\t\tposition: {\r\n\t\t\tlat: marker_data.lat,\r\n\t\t\tlng: marker_data.lon\r\n\t\t},\r\n\t\tmap: map,\r\n\t\ticon: icon,\r\n\t\tzIndex: zindex\r\n\t});\r\n\r\n\t// create event\r\n\tcreate_event(marker_data, icon);\r\n\r\n\t// figure out expire time\r\n\tvar time_now = (new Date).getTime();\r\n\tvar expire = ((marker_data.timestamp_updated_unix * 1000) + (timeframe * 60 * 1000)) - time_now;\r\n\r\n\t// store marker info\r\n\tmarkers[marker_data.id] = {\r\n\t\t'marker': marker,\r\n\t\t'expire': expire,\r\n\t\t'marker_data': marker_data\r\n\t};\r\n\r\n\t// delete marker\r\n\tsetTimeout(function (expire) {\r\n\t\tmarkers[marker_data.id].marker.setMap(null);\r\n\t\t$('#' + marker_data.id).slideUp(\"normal\", function () {\r\n\t\t\t$(this).remove();\r\n\t\t});\r\n\t\tupdate_servings(marker_data, true);\r\n\t\tupdate_foundation(marker_data, true);\r\n\t\tconsole.log((new Date).toTimeString().slice(0, 8) + ': Removing marker #' + marker_data.id);\r\n\t}, expire);\r\n}\r\n\r\nfunction create_event(marker_data, icon)\r\n{\r\n\t// create order event\r\n\t$('<li id=\"' + marker_data.id + '\" data-time=\"' + marker_data.timestamp_updated_unix + '\" class=\"event row py-1 m-0 border-bottom cursor-pointer\">').html('<div class=\"col-2 align-self-center\"><img src=\"' + icon + '\" /></div><div class=\"col-10\"><div class=\"font-weight-bold\">' + marker_data.firstname + ' ' + marker_data.lastname_letter + '</div><div>' + marker_data.store_name + ', ' + marker_data.state + '</div><div class=\"text-muted font-size-small\">' + marker_data.date_time + '</div></div>').prependTo($('#event')).hide().slideDown();\r\n\r\n\t// update servings\r\n\tupdate_servings(marker_data, false);\r\n\r\n\t// update foundation\r\n\tupdate_foundation(marker_data, false);\r\n\r\n\tsort_list();\r\n}\r\n\r\nfunction update_servings(marker_data, remove)\r\n{\r\n\tif (remove == false)\r\n\t{\r\n\t\tvar new_serving_total = $('#servings').data('total') + marker_data.servings_total_count;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar new_serving_total = $('#servings').data('total') - marker_data.servings_total_count;\r\n\t}\r\n\r\n\t$('#servings').data('total', new_serving_total);\r\n\t$('#servings').text(new_serving_total.toLocaleString(\"en\"));\r\n}\r\n\r\nfunction update_foundation(marker_data, remove)\r\n{\r\n\tif (remove == false)\r\n\t{\r\n\t\tvar new_foundation_total = $('#foundation').data('total') + marker_data.ltd_round_up_value + marker_data.subtotal_ltd_menu_item_value;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar new_foundation_total = $('#foundation').data('total') - marker_data.ltd_round_up_value - marker_data.subtotal_ltd_menu_item_value;\r\n\t}\r\n\r\n\t$('#foundation').data('total', new_foundation_total);\r\n\t$('#foundation').text(Math.floor(new_foundation_total / .25).toLocaleString(\"en\"));\r\n}\r\n\r\nfunction toggleBounce(id)\r\n{\r\n\tif (markers[id].marker.getAnimation() !== null)\r\n\t{\r\n\t\tmarkers[id].marker.setAnimation(null);\r\n\t\t$('#' + id).removeClass('border-width-2-imp border-green');\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmarkers[id].marker.setZIndex(100);\r\n\t\tmarkers[id].marker.setAnimation(google.maps.Animation.BOUNCE);\r\n\t\t$('#' + id).addClass('border-width-2-imp border-green');\r\n\t}\r\n}\r\n\r\n$(document).on(\"click\", \".event\", function () {\r\n\r\n\ttoggleBounce(this.id);\r\n\r\n});"],"names":["timeframe","checkperiod","last_time","Date","getTime","map","markers","hasrun","initMap","country","myOptions","zoom","mapTypeId","google","maps","Map","document","getElementById","geocoder","Geocoder","geocode","address","results","status","GeocoderStatus","OK","setCenter","geometry","location","alert","map_activity_timer","$","doTimeout","ajax","url","type","timeout","dataType","data","processor","success","json","time_in","each","key","marker_data","this","timestamp_updated_unix","setTimeout","expire","set_marker","PATH","image","console","log","toTimeString","slice","id","fadmin_is_idle","error","objAJAXRequest","strError","USER_LOGGEDIN","cookie","TO","sort_list","html","children","sort","a","b","icon","zindex","marker","Marker","animation","Animation","DROP","position","lat","lng","lon","zIndex","create_event","time_now","setMap","slideUp","remove","update_servings","update_foundation","firstname","lastname_letter","store_name","state","date_time","prependTo","hide","slideDown","new_serving_total","servings_total_count","text","toLocaleString","new_foundation_total","ltd_round_up_value","subtotal_ltd_menu_item_value","Math","floor","toggleBounce","getAnimation","setAnimation","removeClass","setZIndex","BOUNCE","addClass","on"],"mappings":"AAAA,IAAIA,UAAY,GAChB,IAAIC,YAAc,GAClB,IAAIC,WAAc,IAAKC,MAAMC,QAAQ,EAAI,IAASJ,UAAY,GAC9D,IAAIK,IAAM,KACV,IAAIC,QAAU,GACd,IAAIC,OAAS,MAEb,SAASC,UAER,IAAIC,EAAU,gBAEd,IAAIC,EAAY,CACfC,KAAM,EACNC,UAAW,SACZ,EAGAP,IAAM,IAAIQ,OAAOC,KAAKC,IAAIC,SAASC,eAAe,KAAK,EAAGP,CAAS,EAGnE,IAAIQ,EAAW,IAAIL,OAAOC,KAAKK,SAC/BD,EAASE,QAAQ,CAACC,QAAWZ,CAAO,EAAG,SAAUa,EAASC,GACzD,GAAIA,GAAUV,OAAOC,KAAKU,eAAeC,GACzC,CACCpB,IAAIqB,UAAUJ,EAAQ,GAAGK,SAASC,QAAQ,CAC3C,KAEA,CACCC,MAAM,4BAA8BD,QAAQ,CAC7C,CACD,CAAC,EAGDE,mBAAmB,CACpB,CAEA,SAASA,qBAGRC,EAAEC,UAAU,oBAAoB,EAGhCD,EAAEC,UAAU,qBAAuB/B,YAAc,IAAO,WAEvD8B,EAAEE,KAAK,CACNC,IAAK,aACLC,KAAM,OACNC,QAAS,IACTC,SAAU,OACVC,KAAM,CACLC,UAAW,6BACXrC,UAAWA,SACZ,EACAsC,QAAS,SAAUC,EAAMlB,GAExBmB,QAAU,EAEVX,EAAEY,KAAKF,EAAKH,KAAM,SAAUM,GAG3BF,OAAO,GAGP,IAAIG,EAAcC,KAGlB,GAAIA,KAAKC,uBAAyB7C,UAClC,CACCA,UAAY4C,KAAKC,sBAClB,CAEAC,WAAW,SAAUC,GACpBC,WAAWL,EAAaM,KAAKC,MAAQ,kCAAmC,CAAC,EACzEC,QAAQC,KAAI,IAAKnD,MAAMoD,aAAa,EAAEC,MAAM,EAAG,CAAC,EAAI,oBAAsBX,EAAYY,EAAE,CACzF,EAAGf,QAAU,GAAG,EAEhBgB,eAAe,KAAK,CAErB,CAAC,CAEF,EACAC,MAAO,SAAUC,EAAgBC,IAIlC,CAAC,EAGD,GAAIC,eAAiB/B,EAAEgC,OAAO,cAAc,EAC5C,CACCC,GAAKjC,EAAEgC,OAAO,cAAc,EAE5BL,eAAe,KAAK,CACrB,CAGA,OAAO,IAER,CAAC,EAGD3B,EAAEC,UAAU,qBAAsB,IAAI,CACvC,CAEA,SAASiC,YAERlC,EAAE,QAAQ,EAAEY,KAAK,WAChBZ,EAAEe,IAAI,EAAEoB,KAAKnC,EAAEe,IAAI,EAAEqB,SAAS,IAAI,EAAEC,KAAK,SAAUC,EAAGC,GACrD,OAAQvC,EAAEuC,CAAC,EAAEhC,KAAK,MAAO,EAAKP,EAAEsC,CAAC,EAAE/B,KAAK,MAAO,EAAI,EAAI,CAAC,CACzD,CAAC,CAAC,CACH,CAAC,CACF,CAEA,SAASY,WAAWL,EAAa0B,EAAMC,GAGtC,IAAIC,EAAS,IAAI5D,OAAOC,KAAK4D,OAAO,CACnCC,UAAW9D,OAAOC,KAAK8D,UAAUC,KACjCC,SAAU,CACTC,IAAKlC,EAAYkC,IACjBC,IAAKnC,EAAYoC,GAClB,EACA5E,IAAKA,IACLkE,KAAMA,EACNW,OAAQV,CACT,CAAC,EAGDW,aAAatC,EAAa0B,CAAI,EAG9B,IAAIa,GAAW,IAAKjF,MAAMC,QAAQ,EAClC,IAAI6C,EAAWJ,EAAYE,uBAAyB,IAAS/C,UAAY,GAAK,IAASoF,EAGvF9E,QAAQuC,EAAYY,IAAM,CACzBgB,OAAUA,EACVxB,OAAUA,EACVJ,YAAeA,CAChB,EAGAG,WAAW,SAAUC,GACpB3C,QAAQuC,EAAYY,IAAIgB,OAAOY,OAAO,IAAI,EAC1CtD,EAAE,IAAMc,EAAYY,EAAE,EAAE6B,QAAQ,SAAU,WACzCvD,EAAEe,IAAI,EAAEyC,OAAO,CAChB,CAAC,EACDC,gBAAgB3C,EAAa,IAAI,EACjC4C,kBAAkB5C,EAAa,IAAI,EACnCQ,QAAQC,KAAI,IAAKnD,MAAMoD,aAAa,EAAEC,MAAM,EAAG,CAAC,EAAI,sBAAwBX,EAAYY,EAAE,CAC3F,EAAGR,CAAM,CACV,CAEA,SAASkC,aAAatC,EAAa0B,GAGlCxC,EAAE,WAAac,EAAYY,GAAK,gBAAkBZ,EAAYE,uBAAyB,4DAA4D,EAAEmB,KAAK,kDAAoDK,EAAO,+DAAiE1B,EAAY6C,UAAY,IAAM7C,EAAY8C,gBAAkB,cAAgB9C,EAAY+C,WAAa,KAAO/C,EAAYgD,MAAQ,iDAAmDhD,EAAYiD,UAAY,cAAc,EAAEC,UAAUhE,EAAE,QAAQ,CAAC,EAAEiE,KAAK,EAAEC,UAAU,EAGzhBT,gBAAgB3C,EAAa,KAAK,EAGlC4C,kBAAkB5C,EAAa,KAAK,EAEpCoB,UAAU,CACX,CAEA,SAASuB,gBAAgB3C,EAAa0C,GAErC,GAAIA,GAAU,MACd,CACC,IAAIW,EAAoBnE,EAAE,WAAW,EAAEO,KAAK,OAAO,EAAIO,EAAYsD,oBACpE,KAEA,CACC,IAAID,EAAoBnE,EAAE,WAAW,EAAEO,KAAK,OAAO,EAAIO,EAAYsD,oBACpE,CAEApE,EAAE,WAAW,EAAEO,KAAK,QAAS4D,CAAiB,EAC9CnE,EAAE,WAAW,EAAEqE,KAAKF,EAAkBG,eAAe,IAAI,CAAC,CAC3D,CAEA,SAASZ,kBAAkB5C,EAAa0C,GAEvC,GAAIA,GAAU,MACd,CACC,IAAIe,EAAuBvE,EAAE,aAAa,EAAEO,KAAK,OAAO,EAAIO,EAAY0D,mBAAqB1D,EAAY2D,4BAC1G,KAEA,CACC,IAAIF,EAAuBvE,EAAE,aAAa,EAAEO,KAAK,OAAO,EAAIO,EAAY0D,mBAAqB1D,EAAY2D,4BAC1G,CAEAzE,EAAE,aAAa,EAAEO,KAAK,QAASgE,CAAoB,EACnDvE,EAAE,aAAa,EAAEqE,KAAKK,KAAKC,MAAMJ,EAAuB,GAAG,EAAED,eAAe,IAAI,CAAC,CAClF,CAEA,SAASM,aAAalD,GAErB,GAAInD,QAAQmD,GAAIgB,OAAOmC,aAAa,IAAM,KAC1C,CACCtG,QAAQmD,GAAIgB,OAAOoC,aAAa,IAAI,EACpC9E,EAAE,IAAM0B,CAAE,EAAEqD,YAAY,iCAAiC,CAC1D,KAEA,CACCxG,QAAQmD,GAAIgB,OAAOsC,UAAU,GAAG,EAChCzG,QAAQmD,GAAIgB,OAAOoC,aAAahG,OAAOC,KAAK8D,UAAUoC,MAAM,EAC5DjF,EAAE,IAAM0B,CAAE,EAAEwD,SAAS,iCAAiC,CACvD,CACD,CAEAlF,EAAEf,QAAQ,EAAEkG,GAAG,QAAS,SAAU,WAEjCP,aAAa7D,KAAKW,EAAE,CAErB,CAAC"}