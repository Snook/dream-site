{"version":3,"names":["timeframe","checkperiod","last_time","Date","getTime","map","markers","hasrun","initMap","google","maps","Map","document","getElementById","zoom","mapTypeId","Geocoder","geocode","address","results","status","GeocoderStatus","OK","setCenter","geometry","location","alert","map_activity_timer","$","doTimeout","ajax","url","type","timeout","dataType","data","processor","success","json","time_in","each","key","marker_data","this","timestamp_updated_unix","setTimeout","expire","set_marker","PATH","image","console","log","toTimeString","slice","id","fadmin_is_idle","error","objAJAXRequest","strError","USER_LOGGEDIN","cookie","TO","sort_list","html","children","sort","a","b","icon","zindex","marker","Marker","animation","Animation","DROP","position","lat","lng","lon","zIndex","create_event","time_now","setMap","slideUp","remove","update_servings","update_foundation","firstname","lastname_letter","store_name","state","date_time","prependTo","hide","slideDown","new_serving_total","servings_total_count","text","toLocaleString","new_foundation_total","ltd_round_up_value","subtotal_ltd_menu_item_value","Math","floor","toggleBounce","getAnimation","setAnimation","removeClass","setZIndex","BOUNCE","addClass","on"],"sourceRoot":"js/src/admin","sources":["reports_map_activity.js"],"sourcesContent":["var timeframe = 60; // minutes\r\nvar checkperiod = 10; // seconds\r\nvar last_time = (((new Date).getTime() / 1000) - (timeframe * 60));\r\nvar map = null;\r\nvar markers = [];\r\nvar hasrun = false;\r\n\r\nfunction initMap()\r\n{\r\n\tvar country = \"United States\";\r\n\r\n\tvar myOptions = {\r\n\t\tzoom: 5,\r\n\t\tmapTypeId: 'roadmap'\r\n\t};\r\n\r\n\t// create map\r\n\tmap = new google.maps.Map(document.getElementById(\"map\"), myOptions);\r\n\r\n\t// center map on country\r\n\tvar geocoder = new google.maps.Geocoder();\r\n\tgeocoder.geocode({'address': country}, function (results, status) {\r\n\t\tif (status == google.maps.GeocoderStatus.OK)\r\n\t\t{\r\n\t\t\tmap.setCenter(results[0].geometry.location);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\talert(\"Could not find location: \" + location);\r\n\t\t}\r\n\t});\r\n\r\n\t// start loop\r\n\tmap_activity_timer();\r\n}\r\n\r\nfunction map_activity_timer()\r\n{\r\n\t// cancel existing timer if there is one\r\n\t$.doTimeout('map_activity_timer');\r\n\r\n\t// check every checkperiod for new activity\r\n\t$.doTimeout('map_activity_timer', (checkperiod * 1000), function () {\r\n\r\n\t\t$.ajax({\r\n\t\t\turl: 'ddproc.php',\r\n\t\t\ttype: 'POST',\r\n\t\t\ttimeout: 60000,\r\n\t\t\tdataType: 'json',\r\n\t\t\tdata: {\r\n\t\t\t\tprocessor: 'admin_reports_map_activity',\r\n\t\t\t\tlast_time: last_time\r\n\t\t\t},\r\n\t\t\tsuccess: function (json, status) {\r\n\r\n\t\t\t\ttime_in = 1;\r\n\r\n\t\t\t\t$.each(json.data, function (key) {\r\n\r\n\t\t\t\t\t// first load drops pins separately\r\n\t\t\t\t\ttime_in++;\r\n\r\n\t\t\t\t\t// store data\r\n\t\t\t\t\tvar marker_data = this;\r\n\r\n\t\t\t\t\t// set latest timestamp from data\r\n\t\t\t\t\tif (this.timestamp_updated_unix > last_time)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlast_time = this.timestamp_updated_unix;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tsetTimeout(function (expire) {\r\n\t\t\t\t\t\tset_marker(marker_data, PATH.image + '/style/logo/heart-grn-75x55.png', 0);\r\n\t\t\t\t\t\tconsole.log((new Date).toTimeString().slice(0, 8) + ': Adding marker #' + marker_data.id);\r\n\t\t\t\t\t}, time_in * 200);\r\n\r\n\t\t\t\t\tfadmin_is_idle(false);\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t},\r\n\t\t\terror: function (objAJAXRequest, strError) {\r\n\t\t\t\t// error\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\t// prevent fadmin logout\r\n\t\tif (USER_LOGGEDIN && $.cookie('DreamSite_TO'))\r\n\t\t{\r\n\t\t\tTO = $.cookie('DreamSite_TO');\r\n\r\n\t\t\tfadmin_is_idle(false);\r\n\t\t}\r\n\r\n\t\t// loop doTimeout\r\n\t\treturn true;\r\n\r\n\t});\r\n\r\n\t// call it immediately\r\n\t$.doTimeout('map_activity_timer', true);\r\n}\r\n\r\nfunction sort_list()\r\n{\r\n\t$(\"#event\").each(function () {\r\n\t\t$(this).html($(this).children('li').sort(function (a, b) {\r\n\t\t\treturn ($(b).data('time')) > ($(a).data('time')) ? 1 : -1;\r\n\t\t}));\r\n\t});\r\n}\r\n\r\nfunction set_marker(marker_data, icon, zindex)\r\n{\r\n\t// create marker\r\n\tvar marker = new google.maps.Marker({\r\n\t\tanimation: google.maps.Animation.DROP,\r\n\t\tposition: {\r\n\t\t\tlat: marker_data.lat,\r\n\t\t\tlng: marker_data.lon\r\n\t\t},\r\n\t\tmap: map,\r\n\t\ticon: icon,\r\n\t\tzIndex: zindex\r\n\t});\r\n\r\n\t// create event\r\n\tcreate_event(marker_data, icon);\r\n\r\n\t// figure out expire time\r\n\tvar time_now = (new Date).getTime();\r\n\tvar expire = ((marker_data.timestamp_updated_unix * 1000) + (timeframe * 60 * 1000)) - time_now;\r\n\r\n\t// store marker info\r\n\tmarkers[marker_data.id] = {\r\n\t\t'marker': marker,\r\n\t\t'expire': expire,\r\n\t\t'marker_data': marker_data\r\n\t};\r\n\r\n\t// delete marker\r\n\tsetTimeout(function (expire) {\r\n\t\tmarkers[marker_data.id].marker.setMap(null);\r\n\t\t$('#' + marker_data.id).slideUp(\"normal\", function () {\r\n\t\t\t$(this).remove();\r\n\t\t});\r\n\t\tupdate_servings(marker_data, true);\r\n\t\tupdate_foundation(marker_data, true);\r\n\t\tconsole.log((new Date).toTimeString().slice(0, 8) + ': Removing marker #' + marker_data.id);\r\n\t}, expire);\r\n}\r\n\r\nfunction create_event(marker_data, icon)\r\n{\r\n\t// create order event\r\n\t$('<li id=\"' + marker_data.id + '\" data-time=\"' + marker_data.timestamp_updated_unix + '\" class=\"event row py-1 m-0 border-bottom cursor-pointer\">').html('<div class=\"col-2 align-self-center\"><img src=\"' + icon + '\" /></div><div class=\"col-10\"><div class=\"font-weight-bold\">' + marker_data.firstname + ' ' + marker_data.lastname_letter + '</div><div>' + marker_data.store_name + ', ' + marker_data.state + '</div><div class=\"text-muted font-size-small\">' + marker_data.date_time + '</div></div>').prependTo($('#event')).hide().slideDown();\r\n\r\n\t// update servings\r\n\tupdate_servings(marker_data, false);\r\n\r\n\t// update foundation\r\n\tupdate_foundation(marker_data, false);\r\n\r\n\tsort_list();\r\n}\r\n\r\nfunction update_servings(marker_data, remove)\r\n{\r\n\tif (remove == false)\r\n\t{\r\n\t\tvar new_serving_total = $('#servings').data('total') + marker_data.servings_total_count;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar new_serving_total = $('#servings').data('total') - marker_data.servings_total_count;\r\n\t}\r\n\r\n\t$('#servings').data('total', new_serving_total);\r\n\t$('#servings').text(new_serving_total.toLocaleString(\"en\"));\r\n}\r\n\r\nfunction update_foundation(marker_data, remove)\r\n{\r\n\tif (remove == false)\r\n\t{\r\n\t\tvar new_foundation_total = $('#foundation').data('total') + marker_data.ltd_round_up_value + marker_data.subtotal_ltd_menu_item_value;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar new_foundation_total = $('#foundation').data('total') - marker_data.ltd_round_up_value - marker_data.subtotal_ltd_menu_item_value;\r\n\t}\r\n\r\n\t$('#foundation').data('total', new_foundation_total);\r\n\t$('#foundation').text(Math.floor(new_foundation_total / .25).toLocaleString(\"en\"));\r\n}\r\n\r\nfunction toggleBounce(id)\r\n{\r\n\tif (markers[id].marker.getAnimation() !== null)\r\n\t{\r\n\t\tmarkers[id].marker.setAnimation(null);\r\n\t\t$('#' + id).removeClass('border-width-2-imp border-green');\r\n\t}\r\n\telse\r\n\t{\r\n\t\tmarkers[id].marker.setZIndex(100);\r\n\t\tmarkers[id].marker.setAnimation(google.maps.Animation.BOUNCE);\r\n\t\t$('#' + id).addClass('border-width-2-imp border-green');\r\n\t}\r\n}\r\n\r\n$(document).on(\"click\", \".event\", function () {\r\n\r\n\ttoggleBounce(this.id);\r\n\r\n});"],"mappings":"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"}