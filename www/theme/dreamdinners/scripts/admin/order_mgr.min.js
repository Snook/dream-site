var itemChanges=false;var feeChanges=false;var discountOrPaymentChanges=false;var deliveryChanges=false;var discountChanges=false;var reportingChanges=false;var paymentChanges=false;var initialSessionDiscountSetting="noSD";var initialPreferredUserDiscountSetting="noUP";var changeList=null;var isFactoringCredit=false;var currentCreditAvailable=0;var stationNeedsAttention=false;var relatedOrdersAreLoaded=false;var currentlySavingOrder=false;var onTimeShotAtSupplyingZeroPaymentHasOccurred=false;var needPlatePointsMaxDiscountChangeWarning=false;var lastMaxPPDiscountAmount=-1;let feesTabIsDirty=false;function admin_order_mgr_init(){if(store_id!=STORE_DETAILS.id){STORE_DETAILS.id=store_id}if(orderState=="NEW"){setupForNewOrder()}else if(orderState=="SAVED"){setupForSavedOrder()}else{setupForActiveOrder()}if(hasBundle){bundleSetup()}setupSiteAdminFunctions();initChangeList();if(orderState!="NEW"){calculateTotal();setAllPaymentFieldsToUnrequired();setupCouponState()}setUpKeyHandlers();if(getQueryVariable("session_full")=="true"){var e=window.location.search.substring(1);var t=e.split("&");var a="main.php?";var s=true;for(var i=0;i<t.length;i++){var n=t[i].split("=");if(n[0]!="session_full"){if(!s){a+="&"}a+=t[i]}s=false}historyPush({url:a})}handle_special_instruction_notes();handle_cancel_order();handle_delete_saved_order();handle_free_menu_item_edit();handle_fundraiser_selection();handle_ltd_round_up();handleDirectOrderDiscountFocusing();$("#shipping_phone_number").trigger("change");handleAutoOrderButtons();$("#selectedBundle").trigger("change");initNoInventoryRows();handleDinnerDollarAccordion();handleAdminNoteAccordion();setMealCustomizationDefault()}function setMealCustomizationDefault(){if($("#opted_to_customize_recipes").length&&default_meal_customization_to_selected==true&&$("#opted_to_customize_recipes").prop("checked")){$("#opted_to_customize_recipes").click()}}function handleDinnerDollarAccordion(){$(".dd_accordion_header").click(function(){$header=$(this);$content=$(".dd_accordion_content");$header.html(function(){return($content.is(":visible")?"Show ":"Hide ")+"Recent Dinner Dollar History"+($content.is(":visible")?" &#8744;":" &#8743;")});$content.slideToggle(500,function(){})})}function handleAdminNoteAccordion(){$(".dod_accordion_header").click(function(){$header=$(this);$content=$(".dod_accordion_content");$header.html(function(){return($content.is(":visible")?"Show ":"Hide ")+"Admin Order Notes"+($content.is(":visible")?" &#8744;":" &#8743;")});$content.slideToggle(500,function(){})})}function initNoInventoryRows(){$(".inventory-row").each(function(){let e=$(this).data("orig-remaining");let t=$(this).data("servings");let a=$(this).data("entree");if(e<t){$itemCount=$('input[name="qty_'+a+'"]').val();if($itemCount==0){$(this).find("input,button,textarea,select,a,td").addClass("text-muted");$(this).find("img").hide()}}})}function handleAutoOrderButtons(e,t){$("#selectMediumStarterPackEntrees").on("click",function(e){var a=0;$("[id^='bnd_'] input").each(function(){if($(this).data("pricing_type")=="HALF"){var e=this.id.split("_")[1];$("#qty_"+e).each(function(){var e=$(this).data("entreeid");var t=entreeIDToInventoryMap[e].remaining;if(3>t){a++}else{$(this).val(1)}})}})});$("#selectLargeStarterPackEntrees").on("click",function(e){var a=0;$("[id^='bnd_'] input").each(function(){if($(this).data("pricing_type")=="FULL"){var e=this.id.split("_")[1];$("#qty_"+e).each(function(){var e=$(this).data("entreeid");var t=entreeIDToInventoryMap[e].remaining;if(6>t){a++}else{$(this).val(1)}})}});if(a>0){dd_message({title:"Error",message:"1 or more items could not be selected due to lack of inventory.  Please review the selections and adjust to select a full 12 item order."})}calculateTotal();setItemTabAsDirty();e.preventDefault()})}var intenseLoggingOn=true;function handleDirectOrderDiscountFocusing(){$("#plate_points_discount, #direct_order_discount").focus(function(e){if($(this).val()==0){$(this).val("")}if($(this).val().length>0){$(this).select()}});$("#plate_points_discount, #direct_order_discount").blur(function(e){var t=$(this).val();t=t.trim();if(t==""||isNaN(t)){$(this).val("0")}})}function intenseLogging(e){if(window.console&&intenseLoggingOn){console.log("OM Intense logging: "+e)}}function saveSpecialInstructions(){var e=strip_tags($("#order_user_notes").val());$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"update_special_instructions",order_id:order_id,special_instructions:e},success:function(e){if(e.processor_success){updateInstructionsOrgValues()}else{intenseLogging("saveSpecialInstructions: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){intenseLogging("saveSpecialInstructions: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function handle_special_instruction_notes(){$('[id^="gd_special_instruction_note_button-"]').each(function(){$(this).on("click",function(e){var a=$(this).data("booking_id");var t=$(this).data("user_id");var s="get";var i="";if($(this).data("edit_mode")==true){s="save";i=strip_tags($("#gd_special_instruction_note-"+a+" > textarea").val())}$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",op:"update_special_instructions",do:s,store_id:STORE_DETAILS.id,user_id:t,order_id:order_id,note:i},success:function(e){if(e.processor_success){if(s=="get"){var t=$("<textarea></textarea>").addClass("form-control").val(e.special_instruction_note?e.special_instruction_note:"").on("keyup",function(e){if($(this).val()!=strip_tags($(this).val())){$(this).val(strip_tags($(this).val()))}});$("#gd_special_instruction_note-"+a).addClass("special_instruction_note_edit").html(t);$("#gd_special_instruction_note_button-"+a).data("edit_mode",true).html("Save Note");$("#gd_special_instruction_note_cancel_button-"+a).data("special_instruction_note_value",e.special_instruction_note?e.special_instruction_note:"").on("click",function(e){$("#gd_special_instruction_note-"+$(this).data("booking_id")).removeClass("special_instruction_note_edit").html($(this).data("special_instruction_note_value"));$("#gd_special_instruction_note_button-"+$(this).data("booking_id")).data("edit_mode",false).html("Special Instructions");$(this).hide()}).show()}else{$("#gd_special_instruction_note-"+a).removeClass("special_instruction_note_edit").html(nl2br(e.special_instruction_note));$("#gd_special_instruction_note_cancel_button-"+a).hide();$("#gd_special_instruction_note_button-"+a).data("edit_mode",false).html("Special Instructions")}}},error:function(e,t){intenseLogging("handle_special_instruction_notes: "+t+" | "+e.responseText);response="Unexpected error"}})})})}var lastCheckedGiftCertNumber=null;function setUpKeyHandlers(){document.onkeypress=OMDefaultKeyHandler;$("#coupon_code").on("keypress",function(e){e=e?e:event;var t=e.charCode?e.charCode:e.which?e.which:e.keyCode;if(t==13){processCode();e.stopPropagation();return false}return true});$("#order_user_notes").on("keypress",function(e){e.stopPropagation();return true});$("#payment1_gc_payment_number").on("keyup",function(e){if($(this).val().length==15&&!isNaN($(this).val())&&$(this).val()!=lastCheckedGiftCertNumber){dd_message({title:"Warning",message:"It appears that you may be entering a gift Card number. If so, select Gift Card from payment selector. This is the Certificate (Gift Certificate) payment type."})}lastCheckedGiftCertNumber=$(this).val();return true})}function OMDefaultKeyHandler(e){e=e?e:event;var t=e.charCode?e.charCode:e.which?e.which:e.keyCode;if(t==13){return false}return true}function initChangeList(){$("#changeListTab").on("click",function(){let e=getChangeListHTML();if(!e||e==""){e="<h3><i>No Changes</i></h3>"}dd_message({title:"Change List",message:e,height:620,width:300,modal:false,div_id:"changelist",dialogClass:"fixedDialog",noOk:true,position:{my:"left top",at:"left bottom",of:this},close:function(e,t){$("#changelist").remove()}})})}function setupSiteAdminFunctions(){$("#in-store_status, #plate_points_status").on("click",function(){var e=this.id;var t=$(this);if(orderState!="ACTIVE"){dd_message({title:"Error",message:"These flags can only be set on ACTIVE orders."})}else{var a="off";if($(this).is(":checked")){a="on"}var s=1;if(a=="on"){s=0}dd_message({title:"Status Update",message:"Are you sure you want to update the order status?",cancel:function(){t.prop("checked",s?true:false)},confirm:function(){$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"update_status_flag",order_id:order_id,flag:e,new_state:a},success:function(e){if(e.processor_success){dd_message({title:"Update Success",message:e.processor_message})}else{intenseLogging("update_status_flag: "+e.processor_message);$(this).attr("checked",s);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){intenseLogging("update_status_flag: "+t+" | "+e.responseText);$(this).attr("checked",s);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}})}})}function updateMealCustomizationOrgValues(){dd_toast({message:"Meal Customization Fee Saved",position:"topcenter"});$("#subtotal_meal_customization_fee").data("org_value",$("#subtotal_meal_customization_fee").val())}function updateItemsOrgValues(){$("[id^='qty_']").each(function(){$(this).data("org_value",$(this).val())});$("[data-dd_type='item_field']").each(function(){$(this).data("org_value",$(this).val())});$("#selectedBundle").data("org_value",$("#selectedBundle").is(":checked")?"1":"0");if(isDreamTaste||isFundraiser){$("[id^='bnd_']").each(function(){$(this).data("org_value",$(this).val())})}else{$("[id^='bnd_']").each(function(){$(this).data("org_value",$(this).is(":checked")?"1":"0")})}updateChangeList()}function saveAll(){saveItems(true,false,true)}function saveItems(t,a,s){intenseLogging("saveItems() called");if(currentlySavingOrder){dd_toast({message:"Items are still being saved",position:"topcenter"});return}dd_toast({message:"Items Saved",position:"topcenter"});var i={};var n={};var o={};var e="false";if(isDreamTaste||isFundraiser){$("[id^=bnd_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];i[e]=$(this).val()}});$("[id^=qty_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];i[e]=$(this).val()}})}else{if($("#selectedBundle").is(":checked")){e="true";$("[id^=bnd_]").each(function(){if($(this).is(":checked")){var e=this.id.split("_")[1];n[e]="on"}})}$("[id^=qty_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];i[e]=$(this).val()}});$("[id^=sbi_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];o[e]=$(this).val()}})}var r=$("#misc_food_subtotal").val();if(isNaN(r)){r="0.00"}var d=$("#misc_nonfood_subtotal").val();if(isNaN(d)){d="0.00"}var l=$("#subtotal_service_fee").val();if(isNaN(l)){l="0.00"}var _=$("#subtotal_delivery_fee").val();if(isNaN(_)){_="0.00"}var c=$("#misc_food_subtotal_desc").val();var u=$("#misc_nonfood_subtotal_desc").val();var m=$("#service_fee_description").val();var f=$("#order_user_notes").val();var p=$("#ltdOrderedMealsArray").val();var h=0;var g=0;if(storeSupportsBagFees){var g=$("#total_bag_count").val();if(isNaN(g)){g=0}h=storeDefaultBagFee*g}let v=$("#opted_to_bring_bags").is(":checked");let y=$("#manual_customization_fee").val();let b=$("#opted_to_customize_recipes").length>0&&!$("#opted_to_customize_recipes").is(":checked");let C=$("#subtotal_meal_customization_fee").val();currentlySavingOrder=true;$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"update_items",order_id:order_id,items:i,misc_food_subtotal:r,misc_nonfood_subtotal:d,subtotal_service_fee:l,misc_food_subtotal_desc:c,misc_nonfood_subtotal_desc:u,service_fee_description:m,subtotal_delivery_fee:_,manual_customization_fee:y,opted_to_customize:b,meal_customization_fee:C,is_intro:e,intro_items:n,sub_items:o,ltdOrderedMealsArray:p,special_instructions:f,storeSupportsBagFees:storeSupportsBagFees,bagFeeTotal:h,bagFeeCount:g,opted_to_bring_bags:v},success:function(e){if(e.processor_success){itemTabIsDirty=false;feesTabIsDirty=false;if(b){updateMealCustomizationOrgValues()}updateItemsOrgValues();currentlySavingOrder=false;intenseLogging("saveItems() successful");if(t){saveDiscounts(a,s)}}else{currentlySavingOrder=false;intenseLogging("update_items: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){currentlySavingOrder=false;intenseLogging("update_items: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function setSessionAndSave(e){intenseLogging("setSessionAndSave() called");displayModalWaitDialog("saving_div","Setting session. Please wait ...");$.ajax({url:"ddproc.php",type:"POST",timeout:9e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"set_session_and_save",session_id:e,user_id:user_id,dd_csrf_token:$("input[name=dd_csrf_token]","#editorForm").val()},success:function(e){if(e.processor_success){intenseLogging("setSessionAndSave() successful");if(e.full_session_warning_required){bounce("main.php?page=admin_order_mgr&order="+e.order_id+"&session_full=true")}else{bounce("main.php?page=admin_order_mgr&order="+e.order_id)}}else{$("#saving_div").remove();$("input[name=dd_csrf_token]","#editorForm").val(e.getTokenToken);intenseLogging("set_session_and_save: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#saving_div").remove();intenseLogging("set_session_and_save: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function Reschedule(e,t,a){intenseLogging("Reschedule() called");$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"reschedule",session_id:session_id,user_id:user_id,order_id:order_id,saved_booking_id:saved_booking_id,org_session_id:e,order_state:orderState,transition_type:t,suppressEmail:a},success:function(e){if(e.processor_success){intenseLogging("Reschedule() successful");session_id=e.new_session_id;$("#curSessionDate").html(e.new_session_time);$("#session").val(e.new_session_id);RetrieveCalendar(0);if(!e.canDelayPayment){$(".delayedPaymentSection").hideFlex()}else{$(".delayedPaymentSection").showFlex()}if(e.session_discount){$("#noSessionDiscountRow").hide();$("#newSessionDiscountBody").show();$("#sessionDiscountTypeSpan").html(e.session_discount.type);$("#sessionDiscountValueSpan").html(e.session_discount.value);activeSessionDiscount.id=e.session_discount.id;activeSessionDiscount.type=e.session_discount.type;activeSessionDiscount.value=e.session_discount.value;calculateTotal()}else{$("#noSessionDiscountRow").show();$("#newSessionDiscountBody").hide();activeSessionDiscount.id=0;activeSessionDiscount.type="none";activeSessionDiscount.value=0}$("#curSessionTypeSpan").html(e.session_info.session_type_title);$("#curSessionRemainingSlotsSpan").html(e.session_info.remaining_slots);$("#curSessionRemainingIntroSlotsSpan").html(e.session_info.remaining_intro_slots);if(e.client_ops.hasOwnProperty("require_delivery_address")&&!$("#shipping_address_line1").length){bounce(window.location.href)}for(var t in e.client_ops){if(e.client_ops.hasOwnProperty(t)){switch(t){case"adj_service_fee":{$("#subtotal_service_fee").val(e.client_ops[t]);$("#OEH_subtotal_service_fee_org").html(formatAsMoney(e.client_ops[t]));id="OEH_subtotal_service_fee_org";calculateTotal()}break;case"update_svc_fee_desc":{$("#service_fee_description").val(e.client_ops[t]);calculateTotal()}break;case"adj_delivery_fee":{if(!$("#subtotal_delivery_fee").length){bounce(window.location.href)}$("#subtotal_delivery_fee").val(e.client_ops[t]);$("#OEH_subtotal_delivery_fee_org").html(formatAsMoney(e.client_ops[t]));calculateTotal()}break;case"require_delivery_address":{$("[id^='shipping_']").each(function(){$(this).attr("required","required")})}break;case"delete_delivery_address":{$("#delivery_tab_li").remove();$("#delivery").remove()}break}}}}else{intenseLogging("reschedule: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){response="Unexpected error: "+t;intenseLogging("reschedule: "+t+" | "+e.responseText);dd_message({title:"Error",message:response})}})}function onSetSessionAndSave(e){intenseLogging("onSetSessionAndSave() called");var t=$("#selected_session").attr("data-session_id");setSessionAndSave(t);return false}function onSaveItems(){intenseLogging("onSaveItems() called");saveItems(false,false,false);return false}function setupForNewOrder(){HideLineItemsIfZero();var e=getQueryVariable("month");if(!e){e="0"}RetrieveCalendar(e);$("#addPaymentAndActivate").show()}function setupForSavedOrder(){$("#addPaymentAndActivate").show();if($("#SessDiscnoSD").length){initialSessionDiscountSetting=$("input[name='SessDisc']:checked","#editorForm").val()}if($("#PUDnoUP").length){initialPreferredUserDiscountSetting=$("input[name='PUD']:checked","#editorForm").val()}}function setupForActiveOrder(){if(discountEligable.limited_access){$("#payments_tab_li").click();$("#items_tab_li").addClass("disabled");$("#fees_tab_li").addClass("disabled");$("#sessions_tab_li").addClass("disabled");$("#discountsDiv").find(":input").prop("disabled",true);$("#discountsDiv").find("*").addClass("om_disabled")}$("#addPaymentAndActivate").hide();if($("#SessDiscnoSD").length){initialSessionDiscountSetting=$("input[name='SessDisc']:checked","#editorForm").val()}if($("#PUDnoUP").length){initialPreferredUserDiscountSetting=$("input[name='PUD']:checked","#editorForm").val()}}function isDeliveryAddressComplete(){var e=true;$("[id^='shipping_']").each(function(){if(!$(this).val()&&$(this).attr("required")){e=false}});return e}function saveDeliveryAddress(t,a){var e={};$("[id^='shipping_']").each(function(){e[this.id]=$(this).val()});intenseLogging("saveDeliveryAddress() called");$.ajax({url:"ddproc.php",type:"POST",timeout:2e5,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"save_delivery_address",order_id:order_id,shipping_data:e},success:function(e){if(e.processor_success){intenseLogging("saveDeliveryAddress() successful");dd_toast({message:"Delivery Address Saved",position:"topcenter"});if(t){onAddPaymentAndActivate(false,true,a)}}else{intenseLogging("save_delivery_address: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){intenseLogging("save_delivery_address: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function onDeliveryTabSelected(){}function onDeliveryTabDeselected(){if(!isDeliveryAddressComplete()){dd_message({title:"Error",message:"Please check the Delivery Address and phone number fields for completeness."});return false}else{saveDeliveryAddress(false,false);return true}}function onSessionTabSelected(){RetrieveCalendar(0)}function onSessionTabDeselected(){return true}function onItemsTabSelected(){}function onItemsTabDeselected(){if(orderState!="ACTIVE"){if(itemTabIsDirty){saveItems(false,false,false)}}return true}function onFeesTabSelected(){}function onFeesTabDeselected(){return true}function onPaymentTabSelected(){handle_admin_order_notes();handle_free_menu_item_edit()}function onPaymentTabDeselected(){if(orderState!="ACTIVE"&&(discountChanges||reportingChanges)){saveDiscounts(false,false)}return true}function onRelatedOrdersTabSelected(){if(!relatedOrdersAreLoaded){intenseLogging("Loading related Orders");$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"retrieve_related_orders",session_id:session_id,order_id:order_id,user_id:user_id},success:function(e){intenseLogging("Loading related Orders successful");$("#related_orders").html(e.data);$("#loading_related_orders").remove();relatedOrdersAreLoaded=true},error:function(e,t){$("#loading_related_orders").remove();intenseLogging("retrieve_related_orders: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}}function onRelatedOrdersTabDeselected(){return true}function onNotesTabSelected(){$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"get_history",session_id:session_id,user_id:user_id,order_id:order_id},success:function(e){$("#history_div").html(e.html);handle_guest_account_notes();handle_admin_carryover_notes();handle_admin_order_notes()},error:function(e,t){response="Unexpected error: "+t;intenseLogging("get_history: "+t+" | "+e.responseText);dd_message({title:"Error",message:response})}})}function onNotesTabDeselected(){return true}function onPaymentSelected(){if(orderState!="ACTIVE"){$("#addPaymentAndActivateButton").attr("disabled",false);paymentChanges=true;updateChangeList()}else{paymentChanges=true;updateChangeList()}}function onPaymentDeselected(){if(orderState!="ACTIVE"){$("#addPaymentAndActivateButton").attr("disabled",true);updateChangeList();paymentChanges=false}else{paymentChanges=false;updateChangeList()}return true}function onSiteAdminTabSelected(){}function onSiteAdminTabDeselected(){return true}function updateDiscountOrgValues(){if($("#SessDiscnoSD").length){initialSessionDiscountSetting=$("input[name='SessDisc']:checked","#editorForm").val()}if($("#PUDnoUP").length){initialPreferredUserDiscountSetting=$("input[name='PUD']:checked","#editorForm").val()}$("#org_coupon_id").val($("#coupon_id").val());$("#plate_points_discount, #direct_order_discount").each(function(){$(this).data("org_value",$(this).val())});updateChangeList()}function updateActiveOrder(t,a){intenseLogging("updateActiveOrder() called");var s={};var i={};var n={};var e="false";if(isDreamTaste||isFundraiser){$("[id^=bnd_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];s[e]=$(this).val()}});$("[id^=qty_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];s[e]=$(this).val()}})}else{if($("#selectedBundle").is(":checked")){e="true";$("[id^=bnd_]").each(function(){if($(this).is(":checked")){var e=this.id.split("_")[1];i[e]="on"}})}$("[id^=qty_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];s[e]=$(this).val()}});$("[id^=sbi_]").each(function(){if($(this).val()>0){var e=this.id.split("_")[1];n[e]=$(this).val()}})}var o=$("#misc_food_subtotal").val();if(isNaN(o)){o="0.00"}var r=$("#misc_nonfood_subtotal").val();if(isNaN(r)){r="0.00"}var d=$("#subtotal_service_fee").val();if(isNaN(d)){d="0.00"}var l=$("#subtotal_delivery_fee").val();if(isNaN(l)){l="0.00"}var _=$("#misc_food_subtotal_desc").val();var c=$("#misc_nonfood_subtotal_desc").val();var u=$("#service_fee_description").val();var m=$("#direct_order_discount").val();if(isNaN(m)){m="0.00"}var f=$("input[name=PUD]:checked","#editorForm").val();if(f==null||f==""){f="noUP"}var p=$("#plate_points_discount").val();if(isNaN(p)){p="0.00"}var h=$("input[name=SessDisc]:checked","#editorForm").val();if(h==null||h==""){h="noSD"}var g=0;if($("#dr_level_for_order").length){var v=$("#dr_level_for_order").val();if(v>0){g=v}}var y=$("#ltdOrderedMealsArray").val();$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"update_active_order",order_id:order_id,items:s,misc_food_subtotal:o,misc_nonfood_subtotal:r,subtotal_service_fee:d,subtotal_delivery_fee:l,misc_food_subtotal_desc:_,misc_nonfood_subtotal_desc:c,service_fee_description:u,is_intro:e,intro_items:i,sub_items:n,direct_order_discount:m,PUDSetting:f,plate_points_discount:p,SessDiscSetting:h,dream_rewards_level:g,changeList:JSON.stringify(changeList),changeListStr:getChangeListHTML(),ltdOrderedMealsArray:y,dd_csrf_token:$("input[name=dd_csrf_token]","#editorForm").val()},success:function(e){if(e.processor_success){intenseLogging("updateActiveOrder() successful");itemTabIsDirty=false;updateItemsOrgValues();updateDiscountOrgValues();if(t){onAddPaymentAndActivate(t,a,e.getTokenToken)}}else{intenseLogging("update_active_order: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){intenseLogging("update_active_order: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function _validate_discounts(){if(couponFreeMenuItemRequired){return _check_elements([$("#free_menu_item_coupon").get(0)])}return true}function saveDiscounts(t,a){intenseLogging("saveDiscounts() called");if(!_validate_discounts()){return false}if(!t){dd_toast({message:"Discounts Saved",position:"topcenter"})}var e=$("#direct_order_discount").val();if(isNaN(e)){e="0.00"}var s=$("input[name=PUD]:checked","#editorForm").val();if(s==null||s==""){s="noUP"}var i=$("#plate_points_discount").val();if(isNaN(i)){i="0.00"}var n=$("input[name=SessDisc]:checked","#editorForm").val();if(n==null||n==""){n="noSD"}var o=0;if($("#dr_level_for_order").length){var r=$("#dr_level_for_order").val();if(r>0){o=r}}var d=0;var l=0;if($("#coupon_id").val()){if(couponFreeMenuItemRequired){if($("#free_menu_item_coupon").val()){l=$("#free_menu_item_coupon").val()}}d=$("#coupon_id").val()}var _=$("#fundraiser_id").val();var c=$("#fundraiser_value").val();var u=$("#add_ltd_round_up").is(":checked")?true:false;var m=$("#ltd_round_up_select").val();var f=0;var p=0;if(storeSupportsBagFees){var p=$("#total_bag_count").val();if(isNaN(p)){p=0}f=storeDefaultBagFee*p}let h=$("#opted_to_bring_bags").is(":checked");$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"update_discounts",order_id:order_id,user_id:user_id,direct_order_discount:e,PUDSetting:s,plate_points_discount:i,SessDiscSetting:n,coupon_id:d,coupon_free_menu_item:l,dream_rewards_level:o,fundraiser_id:_,fundraiser_value:c,add_ltd_round_up:u,ltd_round_up_select:m,storeSupportsBagFees:storeSupportsBagFees,bagFeeTotal:f,bagFeeCount:p,opted_to_bring_bags:h},success:function(e){if(e.processor_success){intenseLogging("saveDiscounts() successful");updateDiscountOrgValues();updateReportingOrgValues();if(l){$("#free_menu_item_coupon").attr("disabled",true);couponFreeMenuItem=l}if(a&&$("#shipping_firstname")[0]){saveDeliveryAddress(t,e.paymentToken)}else if(t){onAddPaymentAndActivate(false,true,e.paymentToken)}}else{intenseLogging("update_discounts: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){intenseLogging("update_discounts: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function updateReportingOrgValues(){$("#fundraiser_id").data("org_value",$("#fundraiser_id").val());$("#fundraiser_value").data("org_value",$("#fundraiser_value").val());$("#ltd_round_up_select").data("org_value",$("#ltd_round_up_select").val());$("#OEH_ltd_round_up_org").data("org_value",$("#ltd_round_up_select").val());if($("#add_ltd_round_up").is(":checked")){$("#add_ltd_round_up").data("org_value",true)}else{$("#add_ltd_round_up").data("org_value",false)}updateChangeList()}function send(e,t,a,s,i,n){intenseLogging("send() called for payment# "+t);$("#paypal-result").on("load",function(){intenseLogging("result iFrame loading");try{var e=$("#paypal-result").get(0).contentWindow.next_dest;var t=$("#paypal-result").get(0).contentWindow.pp_success}catch(e){intenseLogging("exception occurred accessing result iframe");$("#paying_div").remove();dd_message({title:"Exception",message:"We are sorry but an unexpected error occurred during payment processing. Please try again or contact support."});return}if(t){intenseLogging("success found in iframe");bounce(e)}else{var a=$("#paypal-result").get(0).contentWindow.error_code;var s=$("#paypal-result").get(0).contentWindow.message;intenseLogging("error found in iframe: #"+a+" | "+s);if(typeof a=="undefined"){a="Generic";s="Some required information is missing or incorrect. Please correct the fields below and try again.";intenseLogging("error code undefined in iframe");$("#paying_div").remove();dd_message({title:"Error: "+a,message:s})}else if(e&&e.length>0){$("#paying_div").remove();dd_message({title:"Error: "+a,message:s,noOk:true,buttons:{Okay:function(){bounce(e)}}})}else{$("#paying_div").remove();var i=$("#paypal-result").get(0).contentWindow.reloadOnFailure;if(i){intenseLogging("reloadOnFailure found in iframe: reloading");s+="<br /><br /><span style='color:red'>The credit card payment failed however the order was booked with the gift certificate. The page will now reload.</span>";dd_message({title:"Error: "+a,message:s,noOk:true,buttons:{Okay:function(){bounce(window.location.href)}}})}else{dd_message({title:"Error: "+a,message:s})}}}});var o=new PayFlow_Payload;o.addNameValuePair("UserID",user_id);o.addNameValuePair("StoreID",STORE_DETAILS.id);o.addNameValuePair("OrderID",order_id);o.addNameValuePair("Email",user_email);if(t==1){var r=$("#payment1_ccMonth").val();r+=$("#payment1_ccYear").val();var d=$("#payment1_cc_security_code").val();var l=$("#payment1_cc_total_amount").val();var _=new PayFlow_Payload;_.addNameValuePair("admin_user_id",USER_DETAILS.id);_.addNameValuePair("user_id",user_id);_.addNameValuePair("store_id",STORE_DETAILS.id);_.addNameValuePair("order_id",order_id);_.addNameValuePair("caller_id","fadmin_order");if(s){_.addNameValuePair("add_only","true")}if(i){_.addNameValuePair("go_to_confirm","true")}_.addNameValuePair("is_second_payment","false");var c=false;var u=0;if($("#use_store_credits").length){if($("#use_store_credits").is(":checked")){u=$("#store_credits_amount").val();_.addNameValuePair("use_sc","true");_.addNameValuePair("sc_amt",u)}}var m=0;if($("#payment1_is_store_specific_flat_rate_deposit_delayed_payment1").length){m=$("input:radio[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked").val();if(m>0){_.addNameValuePair("DP_State",m);_.addNameValuePair("org_amount",l);var f=20;if(m==1&&store_specific_deposit&&store_specific_deposit>20){f=store_specific_deposit}if(l*1<=f*1){dd_message({title:"Delayed Payment Error",message:"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used."});return}l=f}}if(typeof payflowErrorURL=="undefined"){payflowErrorURL="https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback"}var p="ERRORURL="+payflowErrorURL+"&ACCT="+$("#payment1_ccNumber").val()+"&EXPDATE="+r+"&CSC="+d+"&AMT="+l+"&USER1="+_.retrieveEncodedString()+"&COMMENT1="+o.retrieveEncodedString()}else{var r=$("#payment2_ccMonth").val();r+=$("#payment2_ccYear").val();var d=$("#payment2_cc_security_code").val();var l=$("#payment2_cc_total_amount").val();var _=new PayFlow_Payload;_.addNameValuePair("user_id",user_id);_.addNameValuePair("store_id",STORE_DETAILS.id);_.addNameValuePair("order_id",order_id);_.addNameValuePair("caller_id","fadmin_order");_.addNameValuePair("add_only","false");_.addNameValuePair("is_second_payment","true");if(i){_.addNameValuePair("go_to_confirm","true")}if(n){_.addNameValuePair("hasPayment1",true);for(var h in n){if(n.hasOwnProperty(h)){_.addNameValuePair("p1_"+h,n[h])}}}var m=0;if($("#payment2_is_store_specific_flat_rate_deposit_delayed_payment1").length){m=$("input:radio[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked").val();if(m>0){_.addNameValuePair("DP_State",m);_.addNameValuePair("org_amount",l);var f=20;if(m==1&&store_specific_deposit&&store_specific_deposit>20){f=store_specific_deposit}if(l*1<=f*1){dd_message({title:"Delayed Payment Error",message:"The amount of the payment is less than or equal to the deposit. Delayed Payment cannot be used."});return}l=f}}if(typeof payflowErrorURL=="undefined"){payflowErrorURL="https://dreamdinners.com/ddproc.php?processor=admin_payflow_callback"}var p="ERRORURL="+payflowErrorURL+"&ACCT="+$("#payment2_ccNumber").val()+"&EXPDATE="+r+"&CSC="+d+"&AMT="+l+"&USER1="+_.retrieveEncodedString()+"&COMMENT1="+o.retrieveEncodedString()}var g="https://payflowlink.paypal.com";if(typeof pfp_test_mode!="undefined"&&pfp_test_mode){var g="https://pilot-payflowlink.paypal.com"}if(typeof transparent_redirect_link!="undefined"){g=transparent_redirect_link}intenseLogging("posting to PayFlow");create_and_submit_form({action:g,target:"paypal-result",input:{SECURETOKEN:e.token,SECURETOKENID:e.tokenID,PARMLIST:p}})}function getPaymentData(e,t){if(e!="CC"){var a={type:e,number:0,amount:0,cert_type:"",note:$("#payment_note").val()}}else{var a={type:e,number:0,amount:0,cert_type:"",note:$("#payment_note").val(),ccNameOnCard:"",ccType:"CC",ccMonth:"",ccYear:"",cc_security_code:"",billing_address:"",billing_city:"",billing_state_id:"",billing_postal_code:"",is_store_specific_flat_rate_deposit_delayed_payment:0,do_not_ref:0}}if(t==1){switch(e){case"REFERENCE":a.amount=$("#payment1_reference_total_amount").val();break;case"GIFT_CERT":a.amount=$("#payment1_gc_total_amount").val();a.cert_type=$("#payment1_gift_cert_type").val();a.number=$("#payment1_gc_payment_number").val();break;case"CASH":a.amount=$("#payment1_cash_total_amount").val();a.number=$("#payment1_cash_payment_number").val();break;case"REFUND_CASH":a.amount=$("#payment1_refund_cash_total_amount").val();a.number=$("#payment1_refund_cash_payment_number").val();break;case"CHECK":a.amount=$("#payment1_check_total_amount").val();a.number=$("#payment1_check_payment_number").val();break;case"CREDIT":a.amount=$("#OEH_remaing_balance").html();break;case"CC":a.amount=$("#payment1_cc_total_amount").val();a.number=$("#payment1_ccNumber").val();a.ccNameOnCard=$("#payment1_ccNameOnCard").val();a.ccType=$("#payment1_ccType").val();a.ccMonth=$("#payment1_ccMonth").val();a.ccYear=$("#payment1_ccYear").val();a.cc_security_code=$("#payment1_cc_security_code").val();a.billing_address=$("#billing_address_1").val();a.billing_postal_code=$("#billing_postal_code_1").val();a.billing_city=$("#billing_city_1").val();a.billing_state_id=$("#billing_state_id_1").val();if($("#save_cc_as_ref_1").is(":checked")){a.save_card=true}var s=$("input[name=payment1_is_store_specific_flat_rate_deposit_delayed_payment]:checked").val();a.is_store_specific_flat_rate_deposit_delayed_payment=s;break;case"GIFT_CARD":a.amount=$("#debit_gift_card_amount").val();a.number=$("#debit_gift_card_number").val();break;case"DPADJUST":break;case"REFERENCE_OTHER":alert("investigate REFERENCE_OTHER");break;default:if(e.indexOf("REF_")==0){a.amount=$("#payment1_ref_total_amount").val();a.reference_id=$("#p1_ref_id").html()}}return a}else if(t==2){switch(e){case"CASH":a.amount=$("#payment2_cash_total_amount").val();a.number=$("#payment2_cash_payment_number").val();break;case"CHECK":a.amount=$("#payment2_check_total_amount").val();a.number=$("#payment2_check_payment_number").val();break;case"CC":a.amount=$("#payment2_cc_total_amount").val();a.number=$("#payment2_ccNumber").val();a.ccNameOnCard=$("#payment2_ccNameOnCard").val();a.ccType=$("#payment2_ccType").val();a.ccMonth=$("#payment2_ccMonth").val();a.ccYear=$("#payment2_ccYear").val();a.cc_security_code=$("#payment2_cc_security_code").val();a.billing_address=$("#billing_address_2").val();a.billing_postal_code=$("#billing_postal_code_2").val();if($("#save_cc_as_ref_2").is(":checked")){a.save_card=true}var s=$("input[name=payment2_is_store_specific_flat_rate_deposit_delayed_payment]:checked").val();a.is_store_specific_flat_rate_deposit_delayed_payment=s;break;case"REFERENCE_OTHER":alert("investigate REFERENCE_OTHER");break;default:if(e.indexOf("REF_")==0){a.amount=$("#payment2_ref_total_amount").val();a.reference_id=$("#p2_ref_id").html()}}return a}}function validatePayment1(e){var t=null;var a=true;if(e.substr(0,4)=="REF_"){e="REFERENCE_OTHER"}switch(e){case"REFERENCE":t=$("#payment1_reference :input");a=_check_elements(t);break;case"GIFT_CERT":t=$("#payment1_gc :input");a=_check_elements(t);break;case"CASH":t=$("#payment1_cash :input");a=_check_elements(t);break;case"REFUND_CASH":t=$("#payment1_refund_cash :input");a=_check_elements(t);break;case"CHECK":t=$("#payment1_check :input");a=_check_elements(t);break;case"CREDIT":t=$("#payment1_credit :input");a=_check_elements(t);break;case"CC":t=$("#payment1_cc :input");a=_check_elements(t);var s="The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.";if($("#payment1_is_store_specific_flat_rate_deposit_delayed_payment1").is(":checked")||$("#payment1_is_store_specific_flat_rate_deposit_delayed_payment2").is(":checked")){var i=$("#payment1_cc_total_amount").val();if(i*1<=store_specific_deposit*1){$("#payment1_CC_DP_note").html(s);$("#payment1_CC_DP_note").show();a=false}}break;case"GIFT_CARD":t=$("#payment1_debit_gift_card :input");a=_check_elements(t);break;case"DPADJUST":t=$("#dp_adjust_div :input");a=_check_elements(t);break;case"REFERENCE_OTHER":t=$("#payment1_ref :input");a=_check_elements(t);var s="The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.";if($("#ref_payment1_is_store_specific_flat_rate_deposit_delayed1").is(":checked")||$("#ref_payment1_is_store_specific_flat_rate_deposit_delayed2").is(":checked")){var i=$("#payment1_ref_total_amount").val();if(i*1<=store_specific_deposit*1){$("#payment1_Ref_DP_note").html(s);$("#payment1_Ref_DP_note").show();a=false}}break;default:}return a}function validatePayment2(e){var t=null;var a=true;if(e.substr(0,4)=="REF_"){e="REFERENCE_OTHER"}switch(e){case"CASH":t=$("#payment2_check :input");a=_check_elements(t);break;case"CHECK":t=$("#payment2_check :input");a=_check_elements(t);break;case"CC":t=$("#payment2_cc :input");a=_check_elements(t);var s="The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.";if($("#payment2_is_store_specific_flat_rate_deposit_delayed_payment1").is(":checked")||$("#payment2_is_store_specific_flat_rate_deposit_delayed_payment2").is(":checked")){var i=$("#payment2_cc_total_amount").val();if(i*1<=store_specific_deposit*1){$("#payment2_CC_DP_note").html(s);$("#payment2_CC_DP_note").show();a=false}}break;case"REFERENCE_OTHER":t=$("#payment2_ref :input");a=_check_elements(t);var s="The deposit must be less than the payment amount entered. Note that the amount entered should be for the full payment (both deposit and delayed payment). The deposit will be deducted automatically.";if($("#ref_payment2_is_store_specific_flat_rate_deposit_delayed1").is(":checked")||$("#ref_payment2_is_store_specific_flat_rate_deposit_delayed2").is(":checked")){var i=$("#payment2_ref_total_amount").val();if(i*1<=store_specific_deposit*1){$("#payment2_Ref_DP_note").html(s);$("#payment2_Ref_DP_note").show();a=false}}break;default:}return a}function addPaymentAndActivate(){let e=null;let t=null;if(typeof order_minimum!=="undefined"&&typeof order_minimum.minimum!=="undefined"){e=order_minimum.minimum;t=order_minimum.minimum_type}intenseLogging("addPaymentAndActivate() called");let a=0;let s=false;let i="This order is for less than 36 servings. Do you wish to continue?";if(e!=null){i="This order is for less than "+e+" "+t.toLowerCase()+"s. Do you wish to continue?"}a=Number($("#OEH_number_servings").html());let n=Number($("#OEH_number_core_servings").html());if(orderIsEligibleForMembershipDiscount&&storeSupportsMembership){if(membership_status.eligible_menus[menu_id].number_qualifying_orders==0){i="This Meal Prep+ order has less than 36 core servings. Because this guest does not have a consecutive standard order for this menu month, this order is required to have at least 36 servings before a smaller order can be added.";s=true}}let o=a.valueOf();let r=36;if(e!=null){r=e;if(t==="ITEM"){o=n.valueOf()}}if(o<r&&s){intenseLogging("addPaymentAndActivate() - warning for less than "+r+""+t);dd_message({title:"Warning",message:i});return false}else if(o<r&&!isDreamTaste&&!isFundraiser&&!$("#selectedBundle").is(":checked")){intenseLogging("addPaymentAndActivate() - warning for less than "+r+""+t);dd_message({title:"Warning",message:i,confirm:function(){intenseLogging("addPaymentAndActivate() - confirm dialog");let e="You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?";let t=getAbbreviatedSummaryString();e+="<br /><br />"+t;dd_message({title:"Add Payment and Book Order",div_id:"aPaBO",message:e,modal:true,width:400,height:460,confirm:function(){var e=saveItems(true,true,true)}})}})}else{intenseLogging("addPaymentAndActivate() - confirm dialog");if(hasBundle){let e=false;if($("#selectedBundle").is(":checked")){e=true}if(e){let e=countSelectedBundleItems();if(e<intro_servings_required){dd_message({title:"Error",message:"Please select at least "+intro_servings_required+" servings of Meal Prep Starter Pack items."});return false}else if(e>18){dd_message({title:"Error",message:"Please select no more than 18 servings of Meal Prep Starter Pack items."});return false}}}if(stationNeedsAttention){dd_message({title:"Error",message:"Please review the Side Station and ensure the correct number of items are selected."});return false}let e="You are about to activate a Saved order. This will consume inventory and a session slot. Are you sure you want to continue?";let t=getAbbreviatedSummaryString();e+="<br /><br />"+t;dd_message({title:"Add Payment and Book Order",message:e,modal:true,width:400,height:460,confirm:function(){let e=saveItems(true,true,true)}})}return true}function save2PaymentsAndBookOrder(e,a,t){intenseLogging("save2PaymentsAndBookOrder() called");var s=getPaymentData(e,2);if(e!="CC"||!supports_transparent_redirect){var i=0;if($("#ref_payment2_is_store_specific_flat_rate_deposit_delayed0").length){i=$("input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked").val();if(i==1){i=4}if(i==2){i=5}if(i>0){}}var n=$("#max_plate_points_deduction").html();if(!n){n=0}$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"save_payment",order_id:order_id,session_id:session_id,user_id:user_id,payment_data:a,add_payment_data:s,max_plate_points_deduction:n,delay_remainder:i,dd_csrf_token:t},success:function(e){if(e.processor_success){intenseLogging("save2PaymentsAndBookOrder() save_payment successful");if(e.warnOfOutstandingSavedOrdersOnFullSession){bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id+"&full_session=true")}else{bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id)}}else{$("#paying_div").remove();intenseLogging("save2PaymentsAndBookOrder save_payment: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("save2PaymentsAndBookOrder save_payment: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}else if(e=="CC"){var o=$("#payment2_ccNameOnCard").val();var r=$("#billing_address_2").val();var d=$("#billing_postal_code_2").val();var l=$("#payment2_cc_total_amount").val();$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"get_token",order_id:order_id,amount:l,billing_name:o,billing_address:r,billing_zip:d,dd_csrf_token:t,chain_token:true},success:function(e){$("input[name=dd_csrf_token]","#editorForm").val(e.getTokenToken);if(e.processor_success){intenseLogging("save2PaymentsAndBookOrder() get_token successful");var t=e.token;send(t,2,e.warnOfOutstandingSavedOrdersOnFullSession,false,false,a)}else{$("#paying_div").remove();intenseLogging("save2PaymentsAndBookOrder get_token: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("save2PaymentsAndBookOrder get_token: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}}function savePayment2(e,a,t){intenseLogging("savePayment2() called");var s=getPaymentData(e,2);if(e!="CC"||!supports_transparent_redirect){var i=0;if($("#ref_payment2_is_store_specific_flat_rate_deposit_delayed0").length){i=$("input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked").val();if(i==1){i=4}if(i==2){i=5}if(i>0){}}$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"add_payment",order_id:order_id,user_id:user_id,payment_data:s,delay_remainder:i,dd_csrf_token:t},success:function(e){if(e.processor_success){intenseLogging("savePayment2() add_payment successful");if(a){bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id+"&full_session=true")}else{bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id)}}else{$("#paying_div").remove();intenseLogging("savePayment2 add_payment: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("savePayment2 add_payment: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}else if(e=="CC"){var n=$("#payment2_ccNameOnCard").val();var o=$("#billing_address_2").val();var r=$("#billing_postal_code_2").val();var d=$("#payment2_cc_total_amount").val();$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,user_id:user_id,op:"get_token",order_id:order_id,amount:d,billing_name:n,billing_address:o,billing_zip:r,dd_csrf_token:t,chain_token:true},success:function(e){$("input[name=dd_csrf_token]","#editorForm").val(e.getTokenToken);if(e.processor_success){intenseLogging("savePayment2() get_token successful");var t=e.token;send(t,2,a,false,false)}else{$("#paying_div").remove();intenseLogging("savePayment2 get_token: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("savePayment2 get_token: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}}function handleDirectPayment(e,t,a){intenseLogging("handleDirectPayment() called");var s=$("#payment1_type").val();var i=false;if(s=="GIFT_CERT"||s=="GIFT_CARD"){i=$("#payment2_type").val()}if(!validatePayment1(s)){return false}if(i&&i!=""&&!validatePayment2(i)){return false}displayModalWaitDialog("paying_div","Sending Payment. Please wait ...");var n=getPaymentData(s,1);var o=0;if($("#ref_payment1_is_store_specific_flat_rate_deposit_delayed0").length){o=$("input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked").val();if(o==1){o=4}if(o==2){o=5}if(o>0){}}var r=false;var d=0;if($("#use_store_credits").length){if($("#use_store_credits").is(":checked")){d=$("#store_credits_amount").val();r=true}}var l=null;var _=null;if(i){l=getPaymentData(i,2);var o=0;if($("#ref_payment2_is_store_specific_flat_rate_deposit_delayed0").length){o=$("input:radio[name=ref_payment2_is_store_specific_flat_rate_deposit_delayed]:checked").val();if(o==1){o=4}}_=n}else{l=n}var c=$("#max_plate_points_deduction").html();if(!c){c=0}$.ajax({url:"ddproc.php",type:"POST",timeout:9e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:store_id,op:"save_payment",order_id:order_id,user_id:user_id,payment_data:l,add_payment_data:_,delay_remainder:o,use_store_credits:r,max_plate_points_deduction:c,store_credits_amount:d,dd_csrf_token:a,payment2Type:i},success:function(e){if(e.processor_success){intenseLogging("handleDirectPayment() save_payment successful");if(e.warnOfOutstandingSavedOrdersOnFullSession){bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id+"&full_session=true")}else{bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id)}}else{$("#paying_div").remove();intenseLogging("handleDirectPayment save_payment: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){if(t=="timeout"){dd_message({title:"Order Processing Timed Out",message:"The request to finalized the order has timed out. This may be due to network congestion. The order may have been successful. The page will refresh and show the actual current status.",modal:true,noOk:true,closeOnEscape:false,buttons:{Refresh:function(){$(this).remove();bounce(window.location.href)}}})}else{$("#paying_div").remove();intenseLogging("handleDirectPayment save_payment: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}}})}function onAddPaymentAndActivate(a,s,e){intenseLogging("onAddPaymentAndActivate() called");if(!supports_transparent_redirect){return handleDirectPayment(a,s,e)}var t=$("#payment1_type").val();var i=false;if(t=="GIFT_CERT"||t=="GIFT_CARD"){i=$("#payment2_type").val()}if(!validatePayment1(t)){return false}if(i&&i!=""&&!validatePayment2(i)){return false}displayModalWaitDialog("paying_div","Sending Payment. Please wait ...");var n=getPaymentData(t,1);if(i&&i!=""){save2PaymentsAndBookOrder(i,n,e);return}if(t!=""&&t!="CC"){var o=0;if($("#ref_payment1_is_store_specific_flat_rate_deposit_delayed0").length){o=$("input:radio[name=ref_payment1_is_store_specific_flat_rate_deposit_delayed]:checked").val();if(o==1){o=4}if(o==2){o=5}if(o>0){}}var r=false;var d=0;if($("#use_store_credits").length){if($("#use_store_credits").is(":checked")){d=$("#store_credits_amount").val();r=true}}var l=$("#max_plate_points_deduction").html();if(!l){l=0}$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"save_payment",order_id:order_id,user_id:user_id,payment_data:n,delay_remainder:o,use_store_credits:r,max_plate_points_deduction:l,store_credits_amount:d,dd_csrf_token:e},success:function(e){if(e.processor_success){intenseLogging("onAddPaymentAndActivate() save_payment successful");if(e.warnOfOutstandingSavedOrdersOnFullSession){bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id+"&full_session=true")}else{bounce("main.php?page=admin_order_mgr_thankyou&order="+e.order_id)}}else{$("#paying_div").remove();intenseLogging("onAddPaymentAndActivate save_payment: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("onAddPaymentAndActivate save_payment: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}else if(t!=""&&t=="CC"){var _=$("#payment1_ccNameOnCard").val();var c=$("#billing_address_1").val();var u=$("#billing_postal_code_1").val();var m=$("#payment1_cc_total_amount").val();$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"get_token",order_id:order_id,amount:m,user_id:user_id,billing_name:_,billing_address:c,billing_zip:u,dd_csrf_token:e,chain_token:true},success:function(e){$("input[name=dd_csrf_token]","#editorForm").val(e.getTokenToken);if(e.processor_success){intenseLogging("onAddPaymentAndActivate() get_token successful");var t=e.token;send(t,1,false,a,s,false)}else{$("#paying_div").remove();intenseLogging("onAddPaymentAndActivate get_token: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("onAddPaymentAndActivate get_token: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}}function RetrieveCalendar(e){intenseLogging("RetrieveCalendar() called");var t="retrieve";if(orderState!="NEW"){t="retrieve_for_reschedule"}$.ajax({url:"ddproc.php",type:"GET",timeout:2e4,dataType:"json",data:{processor:"admin_calendarProcessor",store_id:store_id,action:t,cur_session_id:session_id,timestamp:e},success:function(e){if(e.processor_success){intenseLogging("RetrieveCalendar() successful");$("#calendar_holder").html(e.data)}else{intenseLogging("RetrieveCalendar: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){intenseLogging("RetrieveCalendar: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function onDayClick(e){}function doReschedule(a,e,s){var t=$("#curSessionDate").html();dd_message({title:"Reschedule",message:'<div style="text-align: center;"><div>From</div><div style="font-weight: bold;">'+t+'</div><div>to</div><div style="font-weight: bold;">'+e+"</div>"+'<div style="margin-top:5px;"><input type="checkbox" name="reschedule_suppress_email" id="reschedule_suppress_email" />&nbsp;<label for="reschedule_suppress_email">Suppress Sending Reschedule Email to Guest</label></div>',modal:true,confirm:function(){var e=false;if($("#reschedule_suppress_email").is(":checked")){e=true}var t=session_id;session_id=a;Reschedule(t,s,e)},open:function(){$(this).siblings(".ui-dialog-buttonpane").find("button:contains('Confirm')").focus()}})}function onRescheduleClick(e,t,a,s){if(orderState!="NEW"){if(s=="locked"){dd_message({title:"Reschedule",message:"This order cannot be rescheduled as it is in the previous calendar month and that month has been locked and finalized."})}else if(s=="MFY_to_Assembled"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to an Assembly.</span><br /><br />The Service Fee will be removed. "+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"tononpreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"MFY_to_Assembled");$("#tononpreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="Assembly_to_MFY"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Pickup.</span><br /><br />The Service Fee will be applied. "+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"Assembly_to_MFY");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="MFY_to_HD"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Home Delivery.</span><br /><br />The Service Fee will be adjusted, the Delivery Fee will be added and a Delivery Address is now required."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"MFY_to_HD");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="MFY_to_CPU"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Community Pick Up.</span><br />",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"MFY_to_CPU");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="CPU_to_MFY"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Pick Up.</span><br />",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"CPU_to_MFY");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="HD_to_Assembled"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Assembly.</span><br /><br />The Delivery Fee, Service Fee, and Delivery Address will be removed."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"HD_to_Assembled");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="HD_to_MFY"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Pick Up.</span><br /><br />The Delivery Fee will be removed. The Service Fee will be adjusted. The Delivery Address will be removed."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"HD_to_MFY");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="HD_to_CPU"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Community Pick Up.</span><br /><br />The Delivery Address will be removed and the Delivery Fee and Service Fee may be adjusted."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"HD_to_CPU");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="CPU_to_Assembled"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Assembly.</span><br /><br />The Delivery Fee and Service Fee will be removed."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"CPU_to_Assembled");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="CPU_to_HD"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Community Pick Up to Home Delivery.</span><br /><br />The Delivery Fee and Service Fee may be adjusted. The Delivery Address is now required."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"CPU_to_HD");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="Assembly_to_CPU"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Community Pick Up.</span><br /><br />A Delivery Fee and Service Fee may be added."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"Assembly_to_CPU");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="Assembly_to_HD"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Home Delivery.</span><br /><br />The Service and Delivery Fees will be added. The Delivery Address is now required."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,"Assembly_to_HD");$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="MFY_to_WI"){t=t.substring(0,t.indexOf(" - "));t="Walk-In on "+t;dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Pick Up to Walk-in.</span><br /><br /> "+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="Assembly_to_WI"){t=t.substring(0,t.indexOf(" - "));t="Walk-In on "+t;dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Assembly to Walk-in.</span><br /><br /> "+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="HD_to_WI"){t=t.substring(0,t.indexOf(" - "));t="Walk-In on "+t;dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Home Delivery to Walk-in.</span><br /><br />The Delivery Fee will be removed. The Service Fee will be adjusted. The Delivery Address will be removed."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="WI_to_Assembled"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Pickup.</span><br /><br />The Service Fee will be adjusted. "+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="WI_to_MFY"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Pick Up.</span><br /><br />The Service Fee will be adjusted. "+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="WI_to_CPU"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-In to Community Pick Up.</span><br />",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="WI_to_HD"){dd_message({title:"Reschedule",message:"<br /><span style='font-weight:bold;'>You are rescheduling from Walk-in to Home Delivery.</span><br /><br />The Service Fee will be adjusted, the Delivery Fee will be added and a Delivery Address is now required."+"<br /><br /><span style='color:red; font-weight:bold;'>After Rescheduling this Order, Please Review this Order, Adjust Payments, Add the Delivery Address and Finalize to complete the Reschedule.</span>",modal:true,div_id:"topreasm_div",noOk:true,buttons:{Continue:function(){doReschedule(e,t,s);$("#topreasm_div").remove()},Cancel:function(){$(this).remove()}}})}else if(s=="none_wi"){t=t.substring(0,t.indexOf(" - "));t="Walk-In on "+t;doReschedule(e,t,"None")}else{doReschedule(e,t,"None")}}}function onSessionClick(e,t,a){if(orderState=="NEW"){setSessionAndSave(e)}}function monthChange(e){RetrieveCalendar(e)}function handle_delayed_payment(){if(GUEST_PREFERENCES[user_id].TC_DELAYED_PAYMENT_AGREE.value==1){return}$("#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, "+" #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, "+" #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, "+" #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2").on("click",function(e){dd_message({title:lang.en.tc.terms_and_conditions,message:lang.en.tc.delayed_payment,modal:true,noOk:true,closeOnEscape:false,open:function(e,t){$(this).parent().find(".ui-dialog-titlebar-close").hide()},buttons:{Agree:function(){$(this).remove();$("#payment1_is_store_specific_flat_rate_deposit_delayed_payment1, #payment1_is_store_specific_flat_rate_deposit_delayed_payment2, "+" #ref_payment1_is_store_specific_flat_rate_deposit_delayed1, #ref_payment1_is_store_specific_flat_rate_deposit_delayed2, "+" #payment2_is_store_specific_flat_rate_deposit_delayed_payment1, #payment2_is_store_specific_flat_rate_deposit_delayed_payment2, "+" #ref_payment2_is_store_specific_flat_rate_deposit_delayed1, #ref_payment2_is_store_specific_flat_rate_deposit_delayed2").off("click");set_user_pref("TC_DELAYED_PAYMENT_AGREE",1,user_id)},Decline:function(){$("#payment1_is_store_specific_flat_rate_deposit_delayed_payment0, #payment2_is_store_specific_flat_rate_deposit_delayed_payment0, "+"#ref_payment1_is_store_specific_flat_rate_deposit_delayed0, #ref_payment2_is_store_specific_flat_rate_deposit_delayed0").trigger("click");dd_message({title:lang.en.tc.terms_and_conditions,message:lang.en.tc.delayed_payment_decline});set_user_pref("TC_DELAYED_PAYMENT_AGREE",0,user_id)}}})})}function createBonusCredit(e){isFactoringCredit=true;currentCreditAvailable=creditBasis*.1;if(e>currentCreditAvailable){e=currentCreditAvailable;currentCreditAvailable=0}else{currentCreditAvailable-=e}$("#couponValue").val(e);$("#OEH_bonus_credit").html(" ( Bonus Credit: "+formatAsMoney(currentCreditAvailable)+" )")}function removeBonusCredit(){isFactoringCredit=false;$("#OEH_bonus_credit").html("")}function handleSummaryDisplayChange(e){if(e.checked){ShowAllLineItems()}else{HideLineItemsIfZero()}}function HideLineItemsIfZero(){var e=Number($("#OEH_subtotal_bag_fee_org").html());var t=Number($("#OEH_subtotal_bag_fee").html());if(e==0&&t==0){$("#BagFeeRow").hide()}else{$("#BagFeeRow").show()}var a=Number($("#OEH_bag_fee_tax_subtotal_org").html());var s=Number($("#OEH_bag_fee_tax_subtotal").html());if(a==0&&s==0){$("#BagFeeTaxRow").hide()}else{$("#BagFeeTaxRow").show()}var i=Number($("#OEH_subtotal_service_fee_org").html());var n=Number($("#OEH_subtotal_service_fee").html());if(i==0&&n==0){$("#ServiceFeeRow").hide()}else{$("#ServiceFeeRow").show()}var o=Number($("#OEH_subtotal_delivery_fee_org").html());var r=Number($("#OEH_subtotal_delivery_fee").html());if(o==0&&r==0){$("#DeliveryFeeRow").hide()}else{$("#DeliveryFeeRow").show()}var d=Number($("#OEH_service_tax_subtotal_org").html());var l=Number($("#OEH_service_tax_subtotal").html());if(d==0&&l==0){$("#ServiceTaxRow").hide()}else{$("#ServiceTaxRow").show()}var _=Number($("#OEH_misc_food_subtotal_org").html());var c=Number($("#OEH_misc_food_subtotal").html());if(_==0&&c==0){$("#miscFoodRow").hide()}else{$("#miscFoodRow").show()}var u=Number($("#OEH_misc_nonfood_subtotal_org").html());var m=Number($("#OEH_misc_nonfood_subtotal").html());if(u==0&&m==0){$("#miscNonFoodRow").hide()}else{$("#miscNonFoodRow").show()}var f=Number($("#OEH_subtotal_meal_customization_fee").html());var p=Number($("#OEH_subtotal_meal_customization_fee_org").html());if(f==0&&p==0){$("#MealCustomizationFeeRow").hide()}else{$("#MealCustomizationFeeRow").show()}var h=Number($("#OEH_direct_order_discount_org").html());var g=Number($("#OEH_direct_order_discount").html());if(h==0&&g==0){$("#directDiscountRow").hide()}else{$("#directDiscountRow").show()}var v=Number($("#OEH_coupon_discount_org").html());var y=Number($("#OEH_coupon_discount").html());if(v==0&&y==0){$("#couponDiscountRow").hide()}else{$("#couponDiscountRow").show()}var b=Number($("#OEH_plate_points_discount_org_food").html());var C=Number($("#OEH_plate_points_order_discount_food").html());if(b==0&&C==0){$("#platePointsDiscountRow").hide()}else{$("#platePointsDiscountRow").show()}var b=Number($("#OEH_plate_points_discount_org_fee").html());var C=Number($("#OEH_plate_points_order_discount_fee").html());if(b==0&&C==0){$("#platePointsFeeDiscountRow").hide()}else{$("#platePointsFeeDiscountRow").show()}var A=Number($("#OEH_membership_discount_org").html());var w=Number($("#OEH_membership_discount").html());if(A==0&&w==0){$("#membershipDiscountRow").hide()}else{$("#membershipDiscountRow").show()}var L=Number($("#OEH_session_discount").html());if(L==0){$("#sessionDiscountRow").hide()}else{$("#sessionDiscountRow").show()}var E=Number($("#OEH_preferred").html());if(E==0){$("#preferredUserDiscountRow").hide()}else{$("#preferredUserDiscountRow").show()}var S=Number($("#OEH_food_tax_subtotal_org").html());var D=Number($("#OEH_food_tax_subtotal").html());if(S==0&&D==0){$("#foodTaxRow").hide()}else{$("#foodTaxRow").show()}var T=Number($("#OEH_tax_subtotal_org").html());var P=Number($("#OEH_tax_subtotal").html());if(T==0&&P==0){$("#nonFoodTaxRow").hide()}else{$("#nonFoodTaxRow").show()}let O=Number($("#OEH_delivery_tax_subtotal_org").html());let F=Number($("#OEH_delivery_tax_subtotal").html());if(O==0&&F==0){$("#DeliveryTaxRow").hide()}else{$("#DeliveryTaxRow").show()}let R=Number($("#OEH_products_subtotal_org").html());let k=Number($("#OEH_products_subtotal").html());if(R==0&&k==0){$("#productSubtotalRow").hide()}else{$("#productSubtotalRow").show()}if(!$("#add_ltd_round_up").is(":checked")){$("#LTDRoundUpRow").hide()}else{$("#LTDRoundUpRow").show()}}function ShowAllLineItems(){$("#ServiceFeeRow").show();$("#DeliveryFeeRow").show();$("#ServiceTaxRow").show();$("#miscFoodRow").show();$("#miscNonFoodRow").show();$("#directDiscountRow").show();$("#couponDiscountRow").show();$("#foodTaxRow").show();$("#nonFoodTaxRow").show();$("#productSubtotalRow").show();$("#platePointsDiscountRow").show();$("#preferredUserDiscountRow").show();$("#sessionDiscountRow").show();$("#LTDRoundUpRow").show();$("#MealCustomizationFeeRow").show();$("#BagFeeRow").show()}function sort_by_price(e,t){if(e.price==t.price){return 0}return e.price<t.price?1:-1}function drawChangeList(){var e=getChangeListHTML();$("#changelist").html(e)}function getChangeListHTML(){let s="";let i=true;for(let a in changeList.stdMenuItems){if(i){s+="<h3>Standard Items <span id='changed-item-count'> - "+localStorage.getItem("core-item-count")+" total</span></h3><ul style='margin: 4px;'>";i=false}s+="<li>";if(changeList.stdMenuItems.hasOwnProperty(a)){let e=$("#qty_"+a).data("item_title");let t=translateServingSize($("#qty_"+a).data("servings"));t="("+t+")";if(changeList.stdMenuItems[a]>0){s+="Added "+changeList.stdMenuItems[a]+" "+t+" <i>"+e+"</i>"}else{s+="Removed "+changeList.stdMenuItems[a]*-1+" "+t+" <i>"+e+"</i>"}}s+="</li>"}if(!i){s+="</ul>"}i=true;let a=[];for(let e in changeList.FTMenuItems){if(changeList.FTMenuItems.hasOwnProperty(e)){var t=$("#qty_"+e).data("index");a[t]=e}}for(let e in a){let t=a[e];if(i){s+="<h3>Sides <span id='changed-sides-count'> - "+localStorage.getItem("side-item-count")+" total</span></h3><ul style='margin: 4px;'>";i=false}s+="<li>";if(changeList.FTMenuItems.hasOwnProperty(t)){let e=$("#qty_"+t).data("item_title");if(changeList.FTMenuItems[t]>0){s+="Added "+changeList.FTMenuItems[t]+" <i>"+e+"</i>"}else{s+="Removed "+changeList.FTMenuItems[t]*-1+" <i>"+e+"</i>"}}s+="</li>"}if(!i){s+="</ul>"}i=true;let n=false;for(let e in changeList.miscCosts){n=true;if(i){s+="<h3>Misc Costs</h3>";i=false}if(changeList.miscCosts.hasOwnProperty(e)){if(changeList.miscCosts[e]["newVal"]>changeList.miscCosts[e]["orgVal"]){if(changeList.miscCosts[e]["orgVal"]==0){s+="Added "+getHumanReadableName(e)+" of $"+formatAsMoney(changeList.miscCosts[e]["newVal"])+"<br />"}else{s+=getHumanReadableName(e)+" was increased by $"+formatAsMoney(changeList.miscCosts[e]["diff"])+" to $"+formatAsMoney(changeList.miscCosts[e]["newVal"])+"<br />"}}else{if(changeList.miscCosts[e]["newVal"]==0){s+="Removed "+getHumanReadableName(e)+" of $"+formatAsMoney(changeList.miscCosts[e]["orgVal"])+"<br />"}else{s+=getHumanReadableName(e)+" was decreased by $"+formatAsMoney(changeList.miscCosts[e]["diff"]*-1)+" to $"+formatAsMoney(changeList.miscCosts[e]["newVal"])+"<br />"}}}}if(!i){s+="</ul>"}i=true;for(let t in changeList.sideBundleItem){if(i){s+="<h3>Sides Bundle Item List</h3><ul style='margin: 4px;'>";i=false}s+="<li>";if(changeList.sideBundleItem.hasOwnProperty(t)){let e=$("#sbi_"+t).data("item_title");if(changeList.sideBundleItem[t]>0){s+="Added "+changeList.sideBundleItem[t]+" <i>"+e+"</i>"}else{s+="Removed "+changeList.sideBundleItem[t]*-1+" <i>"+e+"</i>"}}s+="</li>"}if(!i){s+="</ul>"}i=true;for(let e in changeList.miscDescs){if(!n&&i){s+="<h3>Misc Costs</h3>";i=false}if(changeList.miscDescs.hasOwnProperty(e)){s+=getHumanReadableName(e)+" updated<br />"}}if(changeList.order_type!=""){s+="<h3>Order changed "+changeList.order_type+"</h3>"}i=true;for(let a in changeList.bundleItems){if(i){if(isDreamTaste){s+="<h3>Meal Prep Workshop Items List</h3><ul style='margin: 4px;'>"}else if(isFundraiser){s+="<h3>Fundraiser Event Items List</h3><ul style='margin: 4px;'>"}else{s+="<h3>Intro Items List</h3><ul style='margin: 4px;'>"}i=false}s+="<li>";if(changeList.bundleItems.hasOwnProperty(a)){let e=$("#bnd_"+a).data("item_title");let t="("+$("#bnd_"+a).data("servings")+" Serving)";if(changeList.bundleItems[a]>0){s+="Added "+changeList.bundleItems[a]+" "+t+" <i>"+e+"</i>"}else{s+="Removed "+changeList.bundleItems[a]*-1+" "+t+" <i>"+e+"</i>"}}s+="</li>"}if(!i){s+="</ul>"}i=true;for(let e in changeList.discounts){if(i){s+="<h3>Discounts</h3>";i=false}if(changeList.discounts.hasOwnProperty(e)){if(changeList.discounts[e]["newVal"]>changeList.discounts[e]["orgVal"]){if(changeList.discounts[e]["orgVal"]==0){s+="Added "+getHumanReadableName(e)+" of $"+formatAsMoney(changeList.discounts[e]["newVal"])+"<br />"}else{s+=getHumanReadableName(e)+" was increased by $"+formatAsMoney(changeList.discounts[e]["diff"])+" to $"+formatAsMoney(changeList.discounts[e]["newVal"])+"<br />"}}else{if(changeList.discounts[e]["newVal"]==0){s+="Removed "+getHumanReadableName(e)+" of $"+formatAsMoney(changeList.discounts[e]["orgVal"])+"<br />"}else{s+=getHumanReadableName(e)+" was decreased by $"+formatAsMoney(changeList.discounts[e]["diff"]*-1)+" to $"+formatAsMoney(changeList.discounts[e]["newVal"])+"<br />"}}}}i=true;for(let e in changeList.reporting){if(i){s+="<h3>Reporting</h3>";i=false}if(changeList.reporting.hasOwnProperty(e)){if(e=="fundraiser"){if(changeList.reporting[e]["newVal"]==0){s+="Removed "+getHumanReadableName(e)+" "+changeList.reporting[e]["title"]+"<br />"}else if(changeList.reporting[e]["orgVal"]>0&&changeList.reporting[e]["orgVal"]!=changeList.reporting[e]["newVal"]){s+="Changed "+getHumanReadableName(e)+" to "+changeList.reporting[e]["title"]+"<br />"}else{s+="Added "+getHumanReadableName(e)+" "+changeList.reporting[e]["title"]+"<br />"}}else if(e=="fundraiser_value"){if(changeList.reporting[e]["diff"]>0){s+=getHumanReadableName(e)+" was increased by $"+formatAsMoney(changeList.reporting[e]["diff"])+" to $"+formatAsMoney(changeList.reporting[e]["newVal"])+"<br />"}else{s+=getHumanReadableName(e)+" was decreased by $"+formatAsMoney(changeList.reporting[e]["diff"]*-1)+" to $"+formatAsMoney(changeList.reporting[e]["newVal"])+"<br />"}}if(e=="ltd_roundup"){if(changeList.reporting[e]["newVal"]==false){s+=getHumanReadableName(e)+" was removed from the order."}else{s+=getHumanReadableName(e)+" was added to the order."}}if(e=="ltd_roundup_value"){if(changeList.reporting[e]["diff"]>0){s+=getHumanReadableName(e)+" was increased by $"+formatAsMoney(changeList.reporting[e]["diff"])+" to $"+formatAsMoney(changeList.reporting[e]["newVal"])+"<br />"}else{s+=getHumanReadableName(e)+" was decreased by $"+formatAsMoney(changeList.reporting[e]["diff"]*-1)+" to $"+formatAsMoney(changeList.reporting[e]["newVal"])+"<br />"}}}}if(changeList.coupon){if(i){s+="<h3>Discounts</h3>";i=false}if(changeList.coupon.change_type=="added"){s+="Added coupon code: "+changeList.coupon.code+"<br />"}else if(changeList.coupon.change_type=="removed"){s+="Removed coupon code: "+changeList.coupon.code+"<br />"}else if(changeList.coupon.change_type=="added"){s+="Change coupon code to: "+changeList.coupon.code+"<br />"}}if(changeList.bagFee["Bag Count"]){if(i){s+="<h3>Bag Fee</h3>";i=false}s+="Updated Bag Count: Was "+changeList.bagFee["Bag Count"]["orgVal"]+" bags. Updated to "+changeList.bagFee["Bag Count"]["newVal"]+" bags<br />"}if(changeList.mealCustomizationFee["Meal Customization Fee"]!=null){if(i){s+="<h3>Meal Customization Fee</h3>";i=false}s+="Meal Customization Fee: Was $"+changeList.mealCustomizationFee["Meal Customization Fee"]["orgVal"]+". Updated to $"+changeList.mealCustomizationFee["Meal Customization Fee"]["newVal"]+"<br />"}if(typeof changeList.mealCustomizationFee["Meal Customization Selection"]!="undefined"&&typeof changeList.mealCustomizationFee["Meal Customization Selection"]["newVal"]!="undefined"&&changeList.mealCustomizationFee["Meal Customization Selection"]["newVal"]!=null){if(i){s+="<h3>Meal Customization Selection</h3>";i=false}let e=changeList.mealCustomizationFee["Meal Customization Selection"]["orgVal"]==1?" not selected":" selected";let t=changeList.mealCustomizationFee["Meal Customization Selection"]["newVal"]=="on"?" selected":" not selected";s+="Meal Customization was"+e+". Updated to "+t+".<br />"}if(changeList.mealCustomizationFee["Meal Customization"]!=null){if(i){s+="<h3>Meal Customization</h3>";i=false}for(let e in changeList.mealCustomizationFee["Meal Customization"]){if(typeof changeList.mealCustomizationFee["Meal Customization"][e]!=="undefined"&&typeof changeList.mealCustomizationFee["Meal Customization"][e]["name"]!=="undefined"){if(changeList.mealCustomizationFee["Meal Customization"][e]["newVal"].toUpperCase()=="OPTED IN"){s+=changeList.mealCustomizationFee["Meal Customization"][e]["newVal"]+" to "+changeList.mealCustomizationFee["Meal Customization"][e]["name"]+"<br />"}else{s+=changeList.mealCustomizationFee["Meal Customization"][e]["newVal"]+" of "+changeList.mealCustomizationFee["Meal Customization"][e]["name"]+"<br />"}}}}if(paymentChanges||$("#use_store_credit").is(":checked")){s+="<h3>Payments</h3>";let e=$("#payment1_type").val();if(e!=""){s+="Payment of type "+e+" selected.<br />"}else{$("#creditDiv").is(":visible");{if($("#credit_to_customer_refund_cash_amount").val()>0){s+="Refunding Cash to customer.<br />"}let e=0;$("[id^='Cr_RT_']").each(function(){e+=parseFloat($(this).val())});if(e>0){s+="Refunding to customer credit card(s).<br />"}}}if((e=="GIFT_CERT"||e=="GIFT_CARD")&&$("#payment2_type").val()!=""){let e=$("#payment2_type").val();if(e&&e!=""){s+="Payment of type "+e+" selected.<br />"}}if($("#use_store_credit").is(":checked")){s+="Store Credit selected for payment.<br />"}}return s}function translateServingSize(e){var t="";switch(e){case 6:t="Large - "+e+"";break;case 3:case 4:t="Medium - "+e+"";break;case 2:t="Small - "+e+"";break;default:t=e}return t}function getHumanReadableName(e){switch(e){case"direct_order_discount":return"Direct Order Discount";case"plate_points_discount":return"Dinner Dollars";case"misc_food_subtotal":return"Miscellaneous Food Cost";case"misc_nonfood_subtotal":return"Miscellaneous Non-food Cost";case"subtotal_service_fee":return"Service Fee";case"subtotal_delivery_fee":return"Delivery Fee";case"misc_food_subtotal_desc":return"Misc Food Description";case"misc_nonfood_subtotal_desc":return"Misc Non-food Description";case"service_fee_description":return"Service Fee Description";case"session_discount":return"Session Discount";case"fundraiser":return"Fundraiser";case"fundraiser_value":return"Fundraiser Value";case"ltd_roundup_value":return"Dream Dinners Foundation Round Up Value";case"ltd_roundup":return"Dream Dinners Foundation Round Up";default:return"error"}}function getAbbreviatedSummaryString(){var s="";var e=$("#selectedBundle").is(":checked");if(isDreamTaste){s+="<h3>Meal Prep Workshop Order</h3>"}else if(isFundraiser){s+="<h3>Fundraiser Order</h3>"}else if(e){s+="<h3>Starter Pack Order</h3>"}else{s+="<h3>Standard Order</h3>"}var t=0;var a=0;$("[id^='qty_']").each(function(){if($(this).val()>0){if($(this).data("dd_type")=="cts"){a+=$(this).val()*1}else{t+=$(this).val()*1}}});if(t>0){s+=t+" Standard Items Selected.<br />"}if(a>0){s+=a+" Sides &amp; Sweets Items Selected.<br />"}$("[data-dd_type='item_field']").each(function(){var e=$(this).val();if($(this).data("number")==true){e=parseFloat(e);if(isNaN(e)){e=0}if(e>0){s+=getHumanReadableName(this.id)+" costs of $"+formatAsMoney(e);var t="";switch(this.id){case"misc_food_subtotal":t="misc_food_subtotal_desc";break;case"misc_nonfood_subtotal":t="misc_nonfood_subtotal_desc";break;case"subtotal_service_fee":t="service_fee_description";break}var a=null;if(t!=""){a=$("#"+t).val()}if(a){s+=". <span>( "+a+" )</span><br />"}else{s+=".<br />"}}}});var e=$("#selectedBundle").is(":checked");var i=$("#selectedBundle").data("org_value");var n=0;$("[id^='bnd_']").each(function(){if($(this).is(":checked")){n++}});if(n>0){s+=n+" Intro Items Selected.<br />"}if(isDreamTaste||isFundraiser){var n=0;$("[id^='bnd_']").each(function(){if($(this).val()>0){n+=$(this).val()*1}});if(n>0){s+=n+" Items Selected.<br />"}}var o="";$("#plate_points_discount, #direct_order_discount").each(function(){var e=$(this).val();if($(this).data("number")==true){e=parseFloat(e);if(isNaN(e)){e=0}}if(e.valueOf()>0){o+=getHumanReadableName(this.id)+" applied.<br />"}});if($("#SessDiscnoSD").length){var r=$("input[name='SessDisc']:checked","#editorForm").val();if(r&&r!="noSD"){o+="Session discount is applied.<br />"}}if($("#PUDnoUP").length){var d=$("input[name='PUD']:checked","#editorForm").val();if(d&&d!="noUP"){o+="Preferred User Discount is applied.<br />"}}if(o!=""){s+="<h3>Discounts</h3>"+o}if(paymentChanges||$("#use_store_credit").is(":checked")){s+="<h3>Payments</h3>";var l=$("#payment1_type").val();if(l!=""){s+="Payment of type "+l+" selected.<br />"}else{$("#creditDiv").is(":visible");{if($("#credit_to_customer_refund_cash_amount").val()>0){s+="Refunding Cash to customer.<br />"}var _=0;$("[id^='Cr_RT_']").each(function(){_+=parseFloat($(this).val())});if(_>0){s+="Refunding to customer credit card(s).<br />"}}}if((l=="GIFT_CERT"||l=="GIFT_CARD")&&$("#payment1_type").val()!=""){var c=$("#payment2_type").val();if(c&&c!=""){s+="Payment of type "+c+" selected.<br />"}}if(changeList.bagFee["Bag Count"]){s+="Bag Count set to "+changeList.bagFee["Bag Count"]["newVal"]+" bags<br />"}if($("#use_store_credit").is(":checked")){s+="Store Credit selected for payment.<br />"}}return s}function updateChangeList(){itemChanges=false;discountChanges=false;reportingChanges=false;feeChanges=false;discountOrPaymentChanges=false;let e=false;changeList={};changeList.stdMenuItems={};changeList.FTMenuItems={};changeList.miscCosts={};changeList.miscDescs={};changeList.bundleItems={};changeList.order_type="";changeList.discounts={};changeList.reporting={};changeList.delivery={};changeList.bagFee={};changeList.mealCustomizationFee={"Meal Customization":null,"Meal Customization Fee":null};changeList.sideBundleItem={};$("[id^='qty_']").each(function(){if($(this).val()!=$(this).data("org_value")){if($(this).data("dd_type")=="cts"){changeList.FTMenuItems[this.id.split("_")[1]]=$(this).val()-$(this).data("org_value")}else{changeList.stdMenuItems[this.id.split("_")[1]]=$(this).val()-$(this).data("org_value")}$(this).addClass("unsaved_data");itemChanges=true}else{$(this).removeClass("unsaved_data")}});$("[name^='sbi_']").each(function(){if($(this).val()!=$(this).data("lastqty")){changeList.sideBundleItem[$(this).attr("id").split("_")[1]]=$(this).val()-$(this).data("lastqty");$(this).addClass("unsaved_data");itemChanges=true}else{$(this).removeClass("unsaved_data")}});$("[data-dd_type='item_field']").each(function(){var e=$(this).val();var t=$(this).data("org_value");if($(this).data("number")==true){e=parseFloat(e);t=parseFloat(t);if(isNaN(e)){e=0}if(isNaN(t)){t=0}}if(e.valueOf()!=t.valueOf()){$(this).addClass("unsaved_data");if($(this).data("number")==true){changeList.miscCosts[this.id]={newVal:$(this).val(),orgVal:$(this).data("org_value"),diff:$(this).val()-$(this).data("org_value")}}else{changeList.miscDescs[this.id]=1}itemChanges=true}else{$(this).removeClass("unsaved_data")}});var t=$("#selectedBundle").is(":checked");var a=$("#selectedBundle").data("org_value");if(t){if(a=="0"){$("#bundle_header_div").addClass("unsaved_data_cb");changeList.order_type="to Intro";itemChanges=true}else{$("#bundle_header_div").removeClass("unsaved_data_cb")}}else{if(a=="1"){$("#bundle_header_div").addClass("unsaved_data_cb");changeList.order_type="to Standard";itemChanges=true}else{$("#bundle_header_div").removeClass("unsaved_data_cb")}}if(isDreamTaste||isFundraiser){$("[id^='bnd_']").each(function(){if($(this).val()!=$(this).data("org_value")){if($(this).data("dd_type")=="cts"){changeList.bundleItems[this.id.split("_")[1]]=$(this).val()-$(this).data("org_value")}else{changeList.bundleItems[this.id.split("_")[1]]=$(this).val()-$(this).data("org_value")}$(this).addClass("unsaved_data");itemChanges=true}else{$(this).removeClass("unsaved_data")}})}else{$("[id^='bnd_']").each(function(){if($(this).is(":checked")){if($(this).data("org_value")=="0"){$(this).parent().addClass("unsaved_data_cb");changeList.bundleItems[this.id.split("_")[1]]=1;itemChanges=true}else{$(this).parent().removeClass("unsaved_data_cb")}}else{if($(this).data("org_value")=="1"){$(this).parent().addClass("unsaved_data_cb");changeList.bundleItems[this.id.split("_")[1]]=-1;itemChanges=true}else{$(this).parent().removeClass("unsaved_data_cb")}}})}if($("#total_bag_count").length){if($("#total_bag_count").val()!=$("#total_bag_count").data("org_value")){changeList.bagFee["Bag Count"]={newVal:$("#total_bag_count").val(),orgVal:$("#total_bag_count").data("org_value")};feeChanges=true;$("#total_bag_count").addClass("unsaved_data")}else{$("#total_bag_count").removeClass("unsaved_data")}}if($("#subtotal_meal_customization_fee").length){if($("#subtotal_meal_customization_fee").val()==""){$("#subtotal_meal_customization_fee").val("0.00")}if($("#subtotal_meal_customization_fee").val()!=$("#subtotal_meal_customization_fee").data("org_value")){changeList.mealCustomizationFee["Meal Customization Fee"]={newVal:$("#subtotal_meal_customization_fee").val(),orgVal:$("#subtotal_meal_customization_fee").data("org_value")};feeChanges=true;$("#subtotal_meal_customization_fee").addClass("unsaved_data")}else{$("#subtotal_meal_customization_fee").removeClass("unsaved_data")}}let s=$("#opted_to_customize_recipes").is(":checked")?"1":"0";let i=typeof $("#opted_to_customize_recipes").data("org_value")=="undefined"||$("#opted_to_customize_recipes").data("org_value")==""||$("#opted_to_customize_recipes").data("org_value")=="0"?"0":"1";if(i!=s){changeList.mealCustomizationFee["Meal Customization Selection"]={newVal:$("#opted_to_customize_recipes").val(),orgVal:$("#opted_to_customize_recipes").data("org_value")};feeChanges=true;$("#opted_to_customize_recipes").addClass("unsaved_data")}$("[data-dd_type='fee_field']").each(function(){var e=$(this).val();var t=$(this).data("org_value");if($(this).data("number")==true){e=parseFloat(e);t=parseFloat(t);if(isNaN(e)){e=0}if(isNaN(t)){t=0}}if(e.valueOf()!=t.valueOf()){$(this).addClass("unsaved_data");if($(this).data("number")==true){changeList.miscCosts[this.id]={newVal:$(this).val(),orgVal:$(this).data("org_value"),diff:$(this).val()-$(this).data("org_value")}}else{changeList.miscDescs[this.id]=1}feeChanges=true}else{$(this).removeClass("unsaved_data")}});$("[data-dd_type='customization_fee_toggle']").each(function(){var e=$(this).is(":checked")?"Opted in":"Opted out";var t=$(this).data("org_value");var a=$(this).data("name");if(e.toLowerCase()!=t.toLowerCase()){if(changeList.mealCustomizationFee["Meal Customization"]==null){changeList.mealCustomizationFee["Meal Customization"]=[]}changeList.mealCustomizationFee["Meal Customization"][this.id]={name:a,newVal:e,orgVal:t}}else{if(changeList.mealCustomizationFee["Meal Customization"]!=null){changeList.mealCustomizationFee["Meal Customization"][this.id]=""}$(this).removeClass("unsaved_data")}});$("[data-dd_type='customization_fee_detail']").each(function(){let e=$.trim($(this).val());let t=$(this).data("org_value");let a=$(this).data("name");let s=this.id+"detail";if(e.toLowerCase()!=t.toLowerCase()){if(changeList.mealCustomizationFee["Meal Customization"]==null){changeList.mealCustomizationFee["Meal Customization"]=[]}changeList.mealCustomizationFee["Meal Customization"][s]={name:a,newVal:e,orgVal:t}}else{if(changeList.mealCustomizationFee["Meal Customization"]!=null){changeList.mealCustomizationFee["Meal Customization"][s]=""}}});if(feeChanges){$("#fees_tab_li").addClass("unsaved_data_on_tab");e=true}else{$("#fees_tab_li").removeClass("unsaved_data_on_tab")}if(itemChanges){$("#items_tab_li").addClass("unsaved_data_on_tab");e=true}else{$("#items_tab_li").removeClass("unsaved_data_on_tab")}$("#fundraiser_id").each(function(){var e=$(this).val();var t=$(this).data("org_value");if($(this).data("number")==true){e=parseFloat(e);t=parseFloat(t);if(isNaN(e)){e=0}if(isNaN(t)){t=0}}if(e.valueOf()!=t.valueOf()){changeList.reporting["fundraiser"]={newVal:$(this).val(),orgVal:$(this).data("org_value"),title:$(this).find(":selected").text()};$(this).addClass("unsaved_data");discountOrPaymentChanges=true;reportingChanges=true}else{$(this).removeClass("unsaved_data")}});$("#fundraiser_value").each(function(){var e=$(this).val();var t=$(this).data("org_value");if($(this).data("number")==true){e=parseFloat(e);t=parseFloat(t);if(isNaN(e)){e=0}if(isNaN(t)){t=0}}if(e.valueOf()!=t.valueOf()){changeList.reporting["fundraiser_value"]={newVal:e,orgVal:t,diff:e-t};$(this).addClass("unsaved_data");discountOrPaymentChanges=true;reportingChanges=true}else{$(this).removeClass("unsaved_data")}});$("#add_ltd_round_up").each(function(){var e=false;if($(this).is(":checked")){e=true}var t=$(this).data("org_value");if(e!=t){changeList.reporting["ltd_roundup"]={newVal:e,orgVal:t};$(this).addClass("unsaved_data");discountOrPaymentChanges=true;reportingChanges=true}else{$(this).removeClass("unsaved_data")}});$("#ltd_round_up_select").each(function(){if(!$("#add_ltd_round_up").is(":checked")){return}var e=$(this).val();var t=$(this).data("org_value");if($(this).data("number")==true){e=parseFloat(e).toFixed(2);t=parseFloat(t).toFixed(2);if(isNaN(e)){e=0}if(isNaN(t)){t=0}}if(e.valueOf()!=t.valueOf()){changeList.reporting["ltd_roundup_value"]={newVal:$(this).val(),orgVal:$(this).data("org_value"),diff:e-t};$(this).addClass("unsaved_data");discountOrPaymentChanges=true;reportingChanges=true}else{$(this).removeClass("unsaved_data")}});$("#plate_points_discount, #direct_order_discount").each(function(){var e=$(this).val();var t=$(this).data("org_value");e=parseFloat(e);t=parseFloat(t);if(isNaN(e)){e=Number(0)}if(isNaN(t)){t=Number(0)}if(e.valueOf()!=t.valueOf()){changeList.discounts[this.id]={newVal:$(this).val(),orgVal:$(this).data("org_value"),diff:$(this).val()-$(this).data("org_value")};$(this).addClass("unsaved_data");discountOrPaymentChanges=true;discountChanges=true}else{$(this).removeClass("unsaved_data")}});if($("#SessDiscnoSD").length){if(initialSessionDiscountSetting!=$("input[name='SessDisc']:checked","#editorForm").val()){$(".SD_area").addClass("unsaved_data_cb");var n=$("input[name='SessDisc']:checked","#editorForm").val();if(n=="noSD"){changeList.discounts["session_discount"]={newVal:0,orgVal:$("#OEH_session_discount_org").html(),diff:$("#OEH_session_discount_org").html()*-1}}else{changeList.discounts["session_discount"]={newVal:$("#OEH_session_discount").html(),orgVal:0,diff:$("#OEH_session_discount").html()}}discountOrPaymentChanges=true;discountChanges=true}else{$(".SD_area").removeClass("unsaved_data_cb")}}if($("#PUDnoUP").length){if(initialPreferredUserDiscountSetting!=$("input[name='PUD']:checked","#editorForm").val()){$("#PUD_area").addClass("unsaved_data_cb");var o=$("input[name='PUD']:checked","#editorForm").val();if(o=="noUP"){changeList.discounts["preferred_user_discount"]={newVal:0,orgVal:$("#OEH_preferred_org").html(),diff:$("#OEH_preferred_org").html()*-1}}else{changeList.discounts["preferred_user_discount"]={newVal:$("#OEH_preferred").html(),orgVal:0,diff:$("#OEH_preferred").html()}}discountOrPaymentChanges=true;discountChanges=true}else{$("#PUD_area").removeClass("unsaved_data_cb")}}var r=$("#org_coupon_id").val();var d=$("#coupon_id").val();var l=$("#coupon_code").val();if(r!=d){discountOrPaymentChanges=true;if(r==""){changeList.coupon={newVal:d,orgVal:r,code:l,change_type:"added"}}else if(d==""){changeList.coupon={newVal:d,orgVal:r,code:l,change_type:"removed"}}else{changeList.coupon={newVal:d,orgVal:r,code:l,change_type:"changed"}}}if(deliveryChanges){$("#delivery_tab_li").addClass("unsaved_data_on_tab");e=true}else{$("#delivery_tab_li").removeClass("unsaved_data_on_tab")}if(discountOrPaymentChanges){$("#payments_tab_li").addClass("unsaved_data_on_tab");e=true}else{$("#payments_tab_li").removeClass("unsaved_data_on_tab")}if(orderState=="SAVED"&&(e||$("#use_store_credit").is(":checked"))){$("#saveOrderSpan").show()}else{$("#saveOrderSpan").hide()}if(orderState=="SAVED"&&($("#use_store_credit").is(":checked")||paymentChanges)){$("#addPaymentAndActivateButton").attr("disabled",false)}else{$("#addPaymentAndActivateButton").attr("disabled",true)}if(orderState=="ACTIVE"||discountEligable.limited_access){$("#finalizeOrderSpan").show();if(e||paymentChanges||$("#use_store_credits").is(":checked")){discountOrPaymentChanges=true;$("#submit_button").attr("disabled",false);$("#finalize_msg").show()}else{$("#submit_button").attr("disabled",true);$("#finalize_msg").hide()}}else{$("#finalizeOrderSpan").hide()}if(itemChanges||discountOrPaymentChanges){$("#changeListTab").addClass("unsaved_data_list")}else{$("#changeListTab").removeClass("unsaved_data_list")}drawChangeList()}function handleAutoAdjust(e){if(e.checked){var t=Number($("#OEH_remaing_balance").html());if(canAdjustDelayedPayment&&(currentDPAmount>0||t>0)){if(t>0){$("#payment1_type").val("DPADJUST");changePayment1("DPADJUST")}else{adjustPendingDelayedPayment(t)}}else{if(t>0){$("#payment1_type").val("REFERENCE");changePayment1("REFERENCE")}assignBalanceToRefTransactions(t)}}else{if($("#payment1_type").val()!=""){$("#payment1_type").val("");changePayment1("")}for(ident in existingPaymentAmountArray){$("#Cr_RT_"+ident).val("")}}reportPaymentStatus(false)}function getAbbreviatedChangeString(){var a="";var e=0;var t=0;if(needPlatePointsMaxDiscountChangeWarning){a+="<div style='color:red;'>Warning: The amount discountable by Dinner Dollars has changed. You may wish to review and adjust the Dinner Dollars discount.</div>"}for(var s in changeList.stdMenuItems){if(changeList.stdMenuItems.hasOwnProperty(s)){if(changeList.stdMenuItems[s]>0){e+=changeList.stdMenuItems[s]*1}else{t+=changeList.stdMenuItems[s]*-1}}}if(e){a+=e+" Standard items were added.<br />"}if(t){a+=t+" Standard items were removed.<br />"}var i=0;var n=0;for(var s in changeList.FTMenuItems){if(changeList.FTMenuItems.hasOwnProperty(s)){if(changeList.FTMenuItems[s]>0){i+=changeList.FTMenuItems[s]*1}else{n+=changeList.FTMenuItems[s]*-1}}}if(i){a+=i+" Sides &amp; Sweets items were added.<br />"}if(n){a+=n+" Sides &amp; Sweets items were removed.<br />"}var o=0;var r=0;for(var s in changeList.sideBundleItem){if(changeList.sideBundleItem.hasOwnProperty(s)){if(changeList.sideBundleItem[s]>0){o+=changeList.sideBundleItem[s]*1}else{r+=changeList.sideBundleItem[s]*-1}}}if(o){a+=o+" Sides &amp; Sweets bundle items were added.<br />"}if(r){a+=r+" Sides &amp; Sweets bundle items were removed.<br />"}for(var s in changeList.miscCosts){if(changeList.miscCosts.hasOwnProperty(s)){if(changeList.miscCosts[s]["newVal"]>changeList.miscCosts[s]["orgVal"]){if(changeList.miscCosts[s]["orgVal"]==0){a+="Added "+getHumanReadableName(s)+" of $"+formatAsMoney(changeList.miscCosts[s]["newVal"])+"<br />"}else{a+=getHumanReadableName(s)+" was increased by $"+formatAsMoney(changeList.miscCosts[s]["diff"])+" to $"+formatAsMoney(changeList.miscCosts[s]["newVal"])+"<br />"}}else{if(changeList.miscCosts[s]["newVal"]==0){a+="Removed "+getHumanReadableName(s)+" of $"+formatAsMoney(changeList.miscCosts[s]["orgVal"])+"<br />"}else{a+=getHumanReadableName(s)+" was decreased by $"+formatAsMoney(changeList.miscCosts[s]["diff"]*-1)+" to $"+formatAsMoney(changeList.miscCosts[s]["newVal"])+"<br />"}}}}for(var s in changeList.miscDescs){if(changeList.miscDescs.hasOwnProperty(s)){a+=getHumanReadableName(s)+" updated<br />"}}if(changeList.order_type!=""){a+="<h3>Order changed "+changeList.order_type+"</h3>"}var d=0;var l=0;first=true;for(var s in changeList.bundleItems){if(first){if(isDreamTaste){a+="<h3>Meal Prep Workshop Items List</h3>"}else if(isFundraiser){a+="<h3>Fundraiser Event Items List</h3>"}else{a+="<h3>Intro Items List</h3>"}first=false}if(changeList.bundleItems.hasOwnProperty(s)){if(changeList.bundleItems[s]>0){d+=changeList.bundleItems[s]*1}else{l+=changeList.bundleItems[s]*-1}}}if(d){a+=d+" items were added.<br />"}if(l){a+=l+" items were removed.<br />"}if(a!=""){a="<h3>Purchase Changes</h3>"+a}first=true;for(var s in changeList.discounts){if(first){a+="<h3>Discounts</h3>";first=false}if(changeList.discounts.hasOwnProperty(s)){if(changeList.discounts[s]["newVal"]>changeList.discounts[s]["orgVal"]){if(changeList.discounts[s]["orgVal"]==0){a+="Added "+getHumanReadableName(s)+" of $"+formatAsMoney(changeList.discounts[s]["newVal"])+"<br />"}else{a+=getHumanReadableName(s)+" was increased by $"+formatAsMoney(changeList.discounts[s]["diff"])+" to $"+formatAsMoney(changeList.discounts[s]["newVal"])+"<br />"}}else{if(changeList.discounts[s]["newVal"]==0){a+="Removed "+getHumanReadableName(s)+" of $"+formatAsMoney(changeList.discounts[s]["orgVal"])+"<br />"}else{a+=getHumanReadableName(s)+" was decreased by $"+formatAsMoney(changeList.discounts[s]["diff"]*-1)+" to $"+formatAsMoney(changeList.discounts[s]["newVal"])+"<br />"}}}}if(changeList.bagFee["Bag Count"]){if(first){a+="<h3>Bag Fee</h3>";first=false}a+="Updated Bag Count: Was "+changeList.bagFee["Bag Count"]["orgVal"]+" bags. Updated to "+changeList.bagFee["Bag Count"]["newVal"]+" bags<br />"}if(typeof changeList.mealCustomizationFee["Meal Customization Selection"]!="undefined"&&changeList.mealCustomizationFee["Meal Customization Selection"]["newVal"]!=null){if(first){a+="<h3>Meal Customization Selection</h3>";first=false}let e=changeList.mealCustomizationFee["Meal Customization Selection"]["orgVal"]==1?" not selected":" selected";let t=changeList.mealCustomizationFee["Meal Customization Selection"]["newVal"]=="on"?" selected":" not selected";a+="Meal Customization was"+e+". Updated to "+t+".<br />"}if(changeList.mealCustomizationFee["Meal Customization Fee"]!=null){if(first){a+="<h3>Meal Customization Fee</h3>";first=false}a+="Updated Meal Customization Fee: Was $"+changeList.mealCustomizationFee["Meal Customization Fee"]["orgVal"]+". Updated to $"+changeList.mealCustomizationFee["Meal Customization Fee"]["newVal"]+"<br />"}if(changeList.mealCustomizationFee["Meal Customization"]!=null){if(first){a+="<h3>Meal Customization</h3>";first=false}for(let e in changeList.mealCustomizationFee["Meal Customization"]){if(typeof changeList.mealCustomizationFee["Meal Customization"][e]!=="undefined"&&typeof changeList.mealCustomizationFee["Meal Customization"][e]["name"]!=="undefined"){if(changeList.mealCustomizationFee["Meal Customization"][e]["newVal"].toUpperCase()=="OPTED IN"){a+=changeList.mealCustomizationFee["Meal Customization"][e]["newVal"]+" to "+changeList.mealCustomizationFee["Meal Customization"][e]["name"]+"<br />"}else{a+=changeList.mealCustomizationFee["Meal Customization"][e]["newVal"]+" of "+changeList.mealCustomizationFee["Meal Customization"][e]["name"]+"<br />"}}}}if($("#autoAdjust").is(":checked")){a+="<span style='color:red'>Auto-Adjust is checked and will "+$("#adj_action").html()+"</span>"}a="<div id='finalize_changes_div'>"+a+"</div>";return a}function addPaymentToLockedOrder(){var e=$("#payment1_ccNameOnCard").val();var t=$("#billing_address_1").val();var a=$("#billing_postal_code_1").val();var s=$("#payment1_cc_total_amount").val();$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,async:true,dataType:"json",data:{processor:"admin_order_mgr_processor",store_id:STORE_DETAILS.id,op:"get_token",order_id:order_id,amount:s,user_id:user_id,billing_name:e,billing_address:t,billing_zip:a,dd_csrf_token:$("input[name=dd_csrf_token]","#editorForm").val(),chain_token:true},success:function(e){$("input[name=dd_csrf_token]","#editorForm").val(e.getTokenToken);if(e.processor_success){intenseLogging("addPaymentToLockedOrder() get_token successful");var t=e.token;send(t,1,false,true,true,false)}else{$("#paying_div").remove();intenseLogging("addPaymentToLockedOrder get_token: "+e.processor_message);dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){$("#paying_div").remove();intenseLogging("addPaymentToLockedOrder get_token: "+t+" | "+e.responseText);response="Unexpected error: "+t;dd_message({title:"Error",message:response})}})}function submitPage(){intenseLogging("submitPage() called");var e=$("#editorForm")[0];var t=confirm_and_check_form(e);if(t){var a="This can not be undone. Are you sure you want to submit the changes?";var s=getAbbreviatedChangeString();a+="<br /><br />"+s;var i=460;if(a.length<128){i=160}else if(a.length<256){i=260}dd_message({title:"Finalize",message:a,modal:true,width:400,height:i,confirm:function(){if(supports_transparent_redirect&&$("#payment1_type").val()=="CC"){intenseLogging("submitPage() confirmed");if(!discountEligable.limited_access){updateActiveOrder(true,true)}else{addPaymentToLockedOrder(true,true)}}else{$("<input>").attr({type:"hidden",name:"changeList",value:JSON.stringify(changeList)}).appendTo($(e));$("<input>").attr({type:"hidden",name:"changeListStr",value:getChangeListHTML()}).appendTo($(e));$("#submit_changes").val("true");$("#editorForm").submit()}}})}}function resetPage(){intenseLogging("resetPage() called");bounce(window.location.href)}function confirm_and_check_form(e){intenseLogging("confirm_and_check_form() called");if(orderState=="NEW"||orderState=="SAVED"){return false}if(hasBundle){var t=false;if($("#selectedBundle").is(":checked")){t=true}if(t){var a=countSelectedBundleItems();if(a<intro_servings_required){dd_message({title:"Error",message:"Please select at least "+intro_servings_required+" servings of Meal Prep Starter Pack items."});return false}else if(a>18){dd_message({title:"Error",message:"Please select no more than 18 servings of Meal Prep Starter Pack items."});return false}}}if(stationNeedsAttention){dd_message({title:"Error",message:"Please review the Side Station and ensure the correct number of items are selected."});return false}return _check_form(e)}function dd_round_amount(e){e+=5e-6;var t=e*1e3;t=parseInt(t);t=t/10;var a=t-Math.floor(t);if(a>=.5){t=Math.floor(t)+1}else{t=Math.floor(t)}return t/100}function updateSideStationStatus(e,s){s=Number(s);stationNeedsAttention=false;if(s==0){$("#desc"+e).slideUp();$("#sidestation_help_"+e).css("color","#b00").html("You must set the Bundle quantity to greater than zero.");$('.bundle-subitem-qty[data-parent_item="'+e+'"]').val(0);return}else{$("#desc"+e).slideDown()}let t=s*sideStationBundleInfo[e].number_items_required;$("#required_items_station_"+e).text(t);let i=0;$.each(sideStationBundleInfo[e].bundle,function(e,t){let a=$("#sbi_"+e);if(a&&a.val()!=""){if(isNaN(a.val())==true||a.val()-parseInt(a.val())!=0){a.val(0)}if(t.fixed_quantity!=="0"){a.val(s*Number(t.fixed_quantity))}if(a.val()>0){a.val(parseInt(a.val()));i+=a.val()*1}let e=entreeIDToInventoryMap[t.entree_id].remaining;e-=a.val()*t.servings_per_item;$('[data-entree_inventory_remaining="'+t.entree_id+'"]').text(e);entreeIDToInventoryMap[t.entree_id].remaining=e}});$.each(sideStationBundleInfo[e].bundle_groups,function(e,t){$('.group-select-num[data-group_id="'+t.id+'"]').text(parseInt(t.number_items_required)*parseInt(s))});$("#selected_items_station_"+e).html(i);let a=$("#sidestation_help_"+e);let n="";if(i==0){n="Please select "+t+" items.";a.css("color","#b00");stationNeedsAttention=true}else if(i>t){n="You have selected "+(i-t)+" items more than the required amount. Please remove "+(i-t)+" items.";a.css("color","#b00");stationNeedsAttention=true}else if(i<t){n="You have selected "+(t-i)+" items less than the required amount. Please add "+(t-i)+" items.";a.css("color","#b00");stationNeedsAttention=true}else{n="You have selected the correct number of sidestation items. You may continue with item selection or checkout.";a.css("color","#0b0");stationNeedsAttention=false}a.html(n)}function handleMealCustomizationFeeInput(){$("#manual_customization_fee").val("true");calculateTotal()}function handleBagCountInput(){bagCountLockedToField=true;calculateTotal()}function handleBagWaiverInput(){if(!$("#opted_to_bring_bags").is(":checked")){bagCountLockedToField=false}calculateTotal()}function handleMealCustomizationWaiverInput(){if($("#opted_to_customize_recipes").is(":checked")){mealCustomizationFeeFieldLocked=true;$(".icon-customize").hide()}else{let e=$("#subtotal_meal_customization_fee").data("org_value");$("#subtotal_meal_customization_fee").prop("disabled",false);$("#subtotal_meal_customization_fee").val(formatAsMoney(e));$("#customization-row-container").show();mealCustomizationFeeFieldLocked=false;$(".icon-customize").show();if(true){feeChanges=true;$("#submit_button").attr("disabled",false);$("#finalize_msg").show()}}calculateTotal()}function calculateMealCustomizationFee(s){let i=meal_customization_cost;if(typeof i==="undefined"||i.length==0){return 0}let n=0;for(var o in i){switch(i[o].operator){case"EQUAL_OR_LESS":if(s<=parseInt(i[o].value)){n=i[o].cost}break;case"BETWEEN_INCLUSIVE":let e=i[o].value.split("-");let t=parseInt(e[0]);let a=parseInt(e[1]);if(s>=t&&s<=a){n=i[o].cost}break;case"GREATER":if(s>parseInt(i[o].value)){n=i[o].cost}break;default:}}return n}function getNumberBagsRequiredFromItems(e,t){let a=4;let s=Math.floor(e/a);let i=0;if(e%a>0){i=a-e%a}if(i>0){s++}return s}function calculateTotal(){let n=0;let I=0;let l=0;let z=0;let _=0;let c=0;let x=0;let H=0;let o=0;let u=0;let V=0;let m=0;let U=0;let B=0;let f=0;let d=0;let j=0;let e=false;let q=0;let Y=0;let W=0;let G=0;let t=false;let i=false;let p=[];let K=[];if(hasBundle){if($("#selectedBundle").is(":checked")){e=true}}for(let e in entreeIDToInventoryMap){entreeIDToInventoryMap[e].remaining=entreeIDToInventoryMap[e].org_remaining;$('[data-entree_inventory_remaining="'+e+'"]').text(entreeIDToInventoryMap[e].org_remaining)}$("[id^='qty_']").each(function(){if($(this).val()!=""){if(isNaN($(this).val())==true||$(this).val()-parseInt($(this).val(),10)!=0){$(this).val(0)}let s=Number($(this).val());let i=this.id.split("_")[1];if(isFactoringCredit){let e=$(this).data("org_value");if($(this).data("dd_type")=="std"){if(e<s){diff=s-e;d+=diff*$(this).data("price")}else if(s<e){diff=e-s;d-=diff*$(this).data("price")}}else{let e=s.getAttribute("data-org_value");if(e<s){diff=s-e;G+=diff*$(this).data("price")}else if(s<e){diff=e-s;d-=diff*$(this).data("price")}}}if(isNaN(s)==false){let e=$(this).data("entreeid");let t=entreeIDToInventoryMap[e].remaining;let a=Number($(this).data("servings"));t=t-s*a;$('[data-entree_inventory_remaining="'+e+'"]').text(t);entreeIDToInventoryMap[e].remaining=t;if($(this).data("dd_type")!="cts"&&($(this).data("menu_class")!="Extended Fast Lane"||PlatePointsRulesVersion==1)){if(s>0){let e={id:i,qty:s,price:$(this).data("price"),serving_size:$(this).data("servings")};p.push(e)}}n+=s*$(this).data("price");if($(this).data("dd_type")!="cts"){I+=s*$(this).data("item_count_per_item");l+=s*$(this).data("servings");if($(this).data("menu_class")!="Extended Fast Lane"||PlatePointsRulesVersion==1){z+=s*$(this).data("servings");U+=s*$(this).data("price")}if($(this).data("pricing_type")=="FULL"){c+=s*$(this).data("item_count_per_item")}else{_+=s*$(this).data("item_count_per_item")}if($(this).data("item_is_customizable")=="1"){x+=s*$(this).data("item_count_per_item")}}else{o+=s;u+=s*$(this).data("price")}if($(this).data("is_bundle")==true){V+=s*$(this).data("price");B+=s}K[i]=s;$("#sbi_inv_"+e).html(t)}if($(this).data("is_bundle")==true){updateSideStationStatus(i,s)}}});if(hasBundle){let a=0;let s=0;if(originallyHadBundle){if(e){$("[id^='bnd_']").each(function(){if($(this).data("org_value")=="1"){if(!$(this).is(":checked")){let e=$(this).data("entreeid");let t=entreeIDToInventoryMap[e].remaining;t=t+$(this).data("servings");$('[data-entree_inventory_remaining="'+e+'"]').text(t);entreeIDToInventoryMap[e].remaining=t}else{a++;s+=$(this).data("servings")}}else{if($(this).is(":checked")){let e=$(this).data("entreeid");let t=entreeIDToInventoryMap[e].remaining;t=t-$(this).data("servings");$('[data-entree_inventory_remaining="'+e+'"]').text(t);entreeIDToInventoryMap[e].remaining=t;a++;s+=$(this).data("servings")}}})}else{$("[id^='bnd_']").each(function(){if($(this).data("org_value")=="1"){let e=$(this).data("entreeid");let t=entreeIDToInventoryMap[e].remaining;t=t+$(this).data("servings");$('[data-entree_inventory_remaining="'+e+'"]').text(t);entreeIDToInventoryMap[e].remaining=t}})}}else{if(e){$("[id^='bnd_']").each(function(){if($(this).is(":checked")){let e=$(this).data("entreeid");let t=entreeIDToInventoryMap[e].remaining;t=t-$(this).data("servings");$('[data-entree_inventory_remaining="'+e+'"]').text(t);entreeIDToInventoryMap[e].remaining=t;a++;s+=$(this).data("servings")}})}}if(e){n+=bundleInfo.price*1;c+=a;l+=s}}if(tasteBundleMenuData){if(isDreamTaste||isFundraiser){$("#OEH_number_core_servings").html(bundleInfo.number_servings_required);let s=0;let i=0;let e=0;n+=Number(bundleInfo.price);$("[id^='bnd_']").each(function(){let a=$(this).val();if(a>0){l+=$(this).data("servings")*a;if($(this).data("servings")==3){i+=a*1}else{s+=a*1}let e=$(this).data("entreeid");let t=entreeIDToInventoryMap[e].remaining;t=t-a*3;$('[data-entree_inventory_remaining="'+e+'"]').text(t);entreeIDToInventoryMap[e].remaining=t}});c+=s*1;_+=i*1}}let r=0;if($("#selectedBundle").is(":checked")){$("#max_plate_points_deduction").html(formatAsMoney(0));if(typeof coupon!="undefined"&&coupon.limit_to_mfy_fee=="1"&&coupon.discount_method=="FLAT"){let e=$("#subtotal_service_fee").val();if(e>0){t=true}}if(typeof coupon!="undefined"&&coupon.limit_to_delivery_fee=="1"&&coupon.discount_method=="FLAT"){let e=$("#subtotal_delivery_fee").val();if(e>0){i=true}}}else{let e=Number(document.getElementById("subtotal_service_fee").value);r=n+e.valueOf();if(typeof coupon!="undefined"&&coupon.limit_to_mfy_fee=="1"&&coupon.discount_method=="FLAT"){let e=$("#subtotal_service_fee").val();r=formatAsMoney(r-e);$("#OEH_subtotal_service_fee").val(e);t=true;if(r<0){r=0}}if(typeof coupon!="undefined"&&coupon.limit_to_delivery_fee=="1"&&coupon.discount_method=="FLAT"){let e=$("#subtotal_delivery_fee").val();i=true}needPlatePointsMaxDiscountChangeWarning=false;if(r!=lastMaxPPDiscountAmount&&lastMaxPPDiscountAmount!=-1){needPlatePointsMaxDiscountChangeWarning=true}lastMaxPPDiscountAmount=r;if(couponlimitedToFT){let e=Number(document.getElementById("couponValue").value);r-=e;if(r<0){r=0}}$("#max_plate_points_deduction").html(formatAsMoney(r))}if(r<=0){$("#plate_points_discount").attr("disabled","disabled");$("#plate_points_discount").css({"background-color":"#c0c0c0",color:"#060606"});$("#pp_discountable_cost_msg").show()}else if(!discountEligable.limited_access){$("#plate_points_discount").removeAttr("disabled");$("#plate_points_discount").css({"background-color":"#fff",color:"#000"});$("#pp_discountable_cost_msg").hide()}let J=$("#plate_points_available").html()*1;let Z=$("#max_plate_points_deduction").html()*1;let h=$("#plate_points_discount").val()*1;if(Z<h){$("#plate_points_discount").val(Z)}if(J>Z){$("#tbody_max_plate_points_deduction").show()}else{$("#tbody_max_plate_points_deduction").hide()}f=n;let g=0;let Q=0;$("#itemsTbl tr").each(function(){if(this.id.indexOf("row_")!=-1){let e=this.id.substr(4);let t="qna_"+e;let a="prc_"+e;let s=$("#"+t).val();let i=Number(s);let n=$("#"+a).html();let o=Number(n);g+=Number(n)*s;Q+=i;let r=entreeIDToInventoryMap[e].remaining;r=r-s;$('[data-entree_inventory_remaining="'+e+'"]').text(r);entreeIDToInventoryMap[e].remaining=r;if(isFactoringCredit){orgAmount=document.getElementById(t).getAttribute("data-org_value");if(orgAmount<i){diff=i-orgAmount;G+=diff*o}else if(s<orgAmount){diff=orgAmount-s;d-=diff*o}}}});j=_+c+o;core_items_count=_+c;let v=Number(_+c);let X=$("#OEH_item_count_label");let ee=0;let te=0;let a=$("#coupon_type");if(a.length&&a.val()=="FREE_MEAL"){cfm_size=Number($("#free_entree_servings").val());if(cfm_size>0){te+=cfm_size;ee++}}if(ee==0){displayMealCount=H+c+_+o+Q;displayServingCount=l;X.html("Total Item Count")}else{displayMealCount=H+c+o+_+ee+Q;displayServingCount=l+te;X.html("Total # Items (incl. free meals)")}if(orderEditSuccess){displayMealCount+=newAddonQty}$("#OEH_item_count").html(displayMealCount);$("#OEH_number_servings").html(displayServingCount);if(typeof order_minimum!=="undefined"&&order_minimum.minimum_type=="ITEM"){z=core_items_count}localStorage.setItem("core-item-count",core_items_count);localStorage.setItem("side-item-count",o);if(PlatePointsRulesVersion>1){$("#OEH_number_core_servings").html(z)}let ae=0;let s=0;a=$("#coupon_type");if(a.length&&a.val()=="FREE_MEAL"){s=Number($("#couponValue").val());if(s>0){f+=s}}f+=g;if(orderEditSuccess){f+=newAddonAmount}f=Math.round(f*100)/100;$("#orderSubTotal").val(formatAsMoney(Math.round(n*100)/100));$("#OEH_menu_subtotal").html(formatAsMoney(f));$("#orderTotal").val(formatAsMoney(f));let y=Number(document.getElementById("misc_food_subtotal").value);let se=f*1+y*1;$("#OEH_food_cost_subtotal").html(formatAsMoney(f*1+y*1));let b=f;let ie=b;h=0;if($("#plate_points_discount").length){h=$("#plate_points_discount").val();if(h*1>r*1){h=r;if(h==0){$("#plate_points_discount").val("")}else{$("#plate_points_discount").val(formatAsMoney(h))}}b=formatAsMoney(b-h)}let C=Number(0);directDiscount=$("#direct_order_discount");if(directDiscount.length){C=directDiscount.val();if(isNaN(C)){C=0}if(C>se){C=se;directDiscount.val(C)}if(C){b=formatAsMoney(b-C)}$("#OEH_direct_order_discount").html(formatAsMoney(C))}if(isFactoringCredit){creditBasis+=d;createBonusCredit(G)}if(couponDiscountMethod=="PERCENT"){let t=$("#coupon_code").val();var A=0;try{let e=new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});if(t=="VOLUME"){A=e.format(U*(couponDiscountVar/100))}else{A=e.format(ie*(couponDiscountVar/100))}}catch(e){if(t=="VOLUME"){A=Math.floor(U*couponDiscountVar)}else{A=Math.floor(ie*couponDiscountVar)}A/=100}$("#couponValue").val(A)}if(couponlimitedToFT){if(couponDiscountMethod=="FLAT"){let e=u;if(e>couponDiscountVar){A=couponDiscountVar}else{A=e}}if(couponDiscountMethod=="PERCENT"){let e=u;var A=Math.floor(e*couponDiscountVar);A/=100}$("#couponValue").val(A)}let w=Number(0);couponDiscount=$("#couponValue");if(couponDiscount.length){if(couponDiscount.val()==""){couponDiscount.val("0.00")}w=couponDiscount.val()}let ne=false;let oe=false;if(typeof coupon!="undefined"){if(coupon.limit_to_mfy_fee=="1"&&coupon.discount_method=="FLAT"){let e=$("#subtotal_service_fee").val();if(w!=e){w=e}ne=true}if(coupon.limit_to_delivery_fee=="1"&&coupon.discount_method=="FLAT"){let e=$("#subtotal_delivery_fee").val();if(w!=e){if(parseFloat(w)>parseFloat(e)){w=e;oe=true}}}if(coupon.limit_to_recipe_id=="1"){let e=$("#prc_"+coupon.menu_item_id).text();if(coupon.discount_method=="FLAT"){if(e>coupon.discount_var){w=formatAsMoney(e-coupon.discount_var)}else{w=formatAsMoney(e)}}else if(coupon.discount_method=="PERCENT"){w=formatAsMoney(e*(coupon.discount_var/100))}}$("#couponValue").val(w)}if(w){b=formatAsMoney(b-w);$("#OEH_coupon_discount").html(formatAsMoney(w))}let re=$("#PUDnoUP");let de;if(re.length&&!e){let e=$("input[name=PUD]:checked","#editorForm").val();if(e==null||e==""){e="noUP"}let o=-1;let r="none";let d=0;if(originalUP!=false||activeUP!=false){let i=false;if(e=="activeUP"){i=activeUP}else if(e=="originalUP"){i=originalUP}let n=i.preferred_cap_value;if(capacityUP.remainingObj.countRemaining!==null){n=capacityUP.remainingObj.countRemaining}if(i.type=="FLAT"){if(i.preferred_cap_type=="ITEMS"&&v<=n||i.preferred_cap_type=="NONE"){let e=(c-Y)*i.value;let t=Number(formatAsMoney((_-W)*(i.value/2)));e+=t;let a=f-e-g-m-q;if(i.include_sides==="0"){a-=u}o=formatAsMoney(a);r="flat"}else if(i.preferred_cap_type=="ITEMS"&&v>n){let t=0;let a=0;let s=0;p.sort((e,t)=>e.price<t.price?1:-1);for(let e=0;e<v;e++){s+=p[e].qty;if(s<=n){if(p[e].serving_size>5){t+=p[e].qty*i.value}else{a+=Number(formatAsMoney((p[e].qty-W)*(i.value/2)))}}else{t+=p[e].qty*p[e].price}}t+=a;let e=f-t-g-m-q;if(i.include_sides==="0"){e-=u}o=formatAsMoney(e);r="flat"}}else if(i.type=="PERCENT"){if(i.preferred_cap_type=="ITEMS"&&v<=n||i.preferred_cap_type=="SERVINGS"&&l<=n||i.preferred_cap_type=="NONE"){let e=ie-g-m;if(i.include_sides==="0"){e-=u}let t=i.value/100;let a=e*t;let s=dd_round_amount(a);o=formatAsMoney(s);r="pcnt";d=i.value/100}}}if(e=="noUP"){o=0}if(r=="flat"){if(typeof promoVal!="undefined"&&promoVal>0&&o>0){o-=promoVal}if(s>0&&o>0){o-=s}}else if(r=="pcnt"){if(typeof promoVal!="undefined"&&promoVal>0&&o>0){o-=promoVal*d;o=Math.round(o*100)/100}if(s>0&&o>0){o-=s*d;o=Math.round(o*100)/100}}if(o!=-1){de=$("#OEH_preferred");if(de.length){de.html(formatAsMoney(o));b=formatAsMoney(b-o)}}}if(orderIsEligibleForMembershipDiscount&&storeSupportsMembership){let e=Number(0);if(ne||oe){e=w}let t=Number(b*1+e*1);let a=Number(t*(membership_status.discount_var/100));a=Math.round(a*100)/100;$("#OEH_membership_discount").html(formatAsMoney(a));b=formatAsMoney(b-a)}SessDisc=$("#SessDiscnoSD");if(SessDisc.length&&!orderIsEligibleForMembershipDiscount){let e=Number(0);if(ne||oe){e=w}let t=Number(b*1+C*1+y*1+e*1);let a=$("input[name=SessDisc]:checked","#editorForm").val();if(a==null||a==""){a="noSD"}let s=-1;if(a=="originalSD"){let e=t*originalSD.value/100;e+=1e-8;s=formatAsMoney(e)}else if(a=="activeSD"){s=formatAsMoney(t*activeSessionDiscount.value/100)}else{s=0}SDiscountElem=$("#OEH_session_discount");if(SDiscountElem.length){SDiscountElem.html(formatAsMoney(s));b=formatAsMoney(b-s)}}b=Number(b*1+y*1);$("#OEH_misc_food_subtotal").html(formatAsMoney(y));let L=Number($("#misc_nonfood_subtotal").val());$("#OEH_misc_nonfood_subtotal").html(formatAsMoney(L));b=Number(b*1+L*1);let E=Number($("#subtotal_service_fee").val());$("#OEH_subtotal_service_fee").html(formatAsMoney(E));b=Number(b*1+E*1);let S=Number(0);if($("#subtotal_delivery_fee")[0]){S=Number($("#subtotal_delivery_fee").val());$("#OEH_subtotal_delivery_fee").html(formatAsMoney(S));b=Number(b*1+S*1)}let D=Number(0);if(storeSupportsBagFees){let e=getNumberBagsRequiredFromItems(_+c,o);if(!$("#opted_to_bring_bags").is(":checked")){$("#total_bag_count").prop("disabled",false);if(bagCountLockedToField){numBagsRequired=$("#total_bag_count").val()}else{numBagsRequired=e;$("#total_bag_count").val(e)}if(isNaN(numBagsRequired)){numBagsRequired=0}D=storeDefaultBagFee*numBagsRequired}else{$("#total_bag_count").prop("disabled","disabled");$("#total_bag_count").val("0")}$("#OEH_subtotal_bag_fee").html(formatAsMoney(D))}let T=0;if(storeSupportsMealCustomization){if($("#manual_customization_fee").val()=="true"){T=Number($("#subtotal_meal_customization_fee").val())}else{T=calculateMealCustomizationFee(x);$("#subtotal_meal_customization_fee").val(formatAsMoney(T))}if($("#opted_to_customize_recipes").is(":checked")){$("#subtotal_meal_customization_fee").prop("disabled","disabled");$("#subtotal_meal_customization_fee").val("");T=0;$("#customization-row-container").hide()}$("#OEH_subtotal_meal_customization_fee").html(formatAsMoney(T))}let P=formatAsMoney(L*(curNonFoodTax/100));let le=formatAsMoney(m*(curEnrollmentTax/100));let O=0;if(!i){O=formatAsMoney(S*(curDeliveryTax/100))}P*=1;P+=le*1;if(m){$("#nonFoodTaxLabel").html("Non-Food & Enrollment Tax")}else{$("#nonFoodTaxLabel").html("Non-Food Tax")}let F=0;let R=0;if(h>0){let a=0;let s=0;if(t){a=h;s=0}else if(discountMFYFeeFirst&&E>0){if(h>E){a=h-E;s=E}else{s=h;a=0}}else{let t=r-E;if(h>t){let e=h-t;a=t;s=e}else{a=h;s=0}}if(t){F=formatAsMoney((b+h*1-L-a-S)*(curFoodTax/100)+1e-6);R=0}else if(i){F=formatAsMoney((b+h*1-L-a-E)*(curFoodTax/100)+1e-6);O=0}else{F=formatAsMoney((b+h*1-L-E-a-S)*(curFoodTax/100)+1e-6);let e=Number($("#subtotal_meal_customization_fee").val());if(isNaN(e)){e=0}R=formatAsMoney((E+e-s)*(curServiceTax/100)+1e-6)}$("#OEH_plate_points_order_discount_food").html(formatAsMoney(a));$("#OEH_plate_points_order_discount_fee").html(formatAsMoney(s))}else{if(t){F=formatAsMoney((b-L-S)*(curFoodTax/100)+1e-6);R=0}else if(i){F=formatAsMoney((b-L-E)*(curFoodTax/100)+1e-6);O=0}else{F=formatAsMoney((b-L-E-S)*(curFoodTax/100)+1e-6);let e=Number($("#subtotal_meal_customization_fee").val());if(isNaN(e)){e=0}R=formatAsMoney((E+e)*(curServiceTax/100)+1e-6)}$("#OEH_plate_points_order_discount_food").html(formatAsMoney(0));$("#OEH_plate_points_order_discount_fee").html(formatAsMoney(0))}let _e=formatAsMoney(D*(curBagFeeTax/100)+1e-6);taxElem=document.getElementById("OEH_tax_subtotal");if(taxElem){taxElem.innerHTML=formatAsMoney(P)}taxElem=document.getElementById("OEH_food_tax_subtotal");if(taxElem){taxElem.innerHTML=formatAsMoney(F)}taxElem=document.getElementById("OEH_service_tax_subtotal");if(taxElem){taxElem.innerHTML=formatAsMoney(R)}taxElem=document.getElementById("OEH_delivery_tax_subtotal");if(taxElem){taxElem.innerHTML=formatAsMoney(O)}taxElem=document.getElementById("OEH_bag_fee_tax_subtotal");if(taxElem){taxElem.innerHTML=formatAsMoney(_e)}b=Number(b*1+D*1+T*1);let ce=Number(b);b=b*1+F*1+P*1+R*1+O*1+_e*1;let k=0;let ue=Math.ceil(b);let M=parseFloat((ue-b).toFixed(2));if(M==0){M=1}if($("#round_up_nearest_dollar").val()!=M){$("#round_up_nearest_dollar").val(M).text("$ "+formatAsMoney(M));$("#add_ltd_round_up").trigger("change")}if($("#add_ltd_round_up").is(":checked")){if($("#ltd_round_up_select").find(":selected").attr("id")=="round_up_nearest_dollar"){k=M}else{k=parseFloat($("#ltd_round_up_select").val())}}if(isNaN(k)){k=0}$("#OEH_ltd_round_up").html(formatAsMoney(k));b+=Number(k);$("#OEH_grandtotal").html(formatAsMoney(b));$("#OEH_new_total").html(formatAsMoney(b));$("#OEH_delta").html(formatAsMoney((orderInfoGrandTotal-b)*-1));let me=0;if($("#OEH_paymentsTotal").length){me=$("#OEH_paymentsTotal").html()}let N=Number(formatAsMoney(me-b));$("#OEH_remaing_balance").html(formatAsMoney(N*-1));if(orderState=="CANCELLED"){N=me;$("#OEH_remaing_balance").html(formatAsMoney(N))}if(N>0){$("#balance_msg").html(formatAsMoney(N*-1)+" owed to the customer.");$("#balanceRow").addClass("balance_msg_customer_owed");$("#newPaymentDiv").hide();if(canAdjustDelayedPayment&&currentDPAmount>0){$("#dp_adjust_down_div").show()}else{$("#creditDiv").show()}$("#payment1_type").val("");$("#payment2_type").val("");changePayment1("");changePayment2("");paymentChanges=true;$("#use_store_credits").prop("checked",false);$("#use_store_credits").prop("disabled",true)}else if(N<0){$("#balance_msg").html(formatAsMoney(N*-1)+" owed to your store.");$("#balanceRow").addClass("balance_msg_store_owed");$("#newPaymentDiv").show();$("#creditDiv").hide();if(canAdjustDelayedPayment){$("#dp_adjust_down_div").hide()}$("#use_store_credits").prop("disabled",false);let e=true;if(e){let t=N*-1;if($("#use_store_credits").is(":checked")){let e=Number($("#store_credits_amount").val());if(isNaN(e.valueOf())){e=Number(0)}t-=e.valueOf()}t=formatAsMoney(t);if($("#payment1_type").val()=="CC"){$("#payment1_cc_total_amount").val(t)}else if($("#payment1_type").val()=="CHECK"){$("#payment1_check_total_amount").val(t)}else if($("#payment1_type").val().split("_")[0]=="REF"){$("#payment1_ref_total_amount").val(t)}else if(($("#payment1_type").val()=="GIFT_CERT"||$("#payment1_type").val()=="GIFT_CARD")&&$("#payment2_type").val()!=""){let e=null;if($("#payment1_type").val()=="GIFT_CERT"){e=Number($("#payment1_gc_total_amount").val())}else if($("#payment1_type").val()=="GIFT_CARD"){e=Number($("#debit_gift_card_amount").val())}if(isNaN(e.valueOf())){e=Number(0)}t=formatAsMoney(t-e.valueOf());if($("#payment2_type").val()=="CC"){$("#payment2_cc_total_amount").val(t)}else if($("#payment2_type").val()=="CHECK"){$("#payment2_check_total_amount").val(t)}else if($("#payment2_type").val()=="CASH"){$("#payment2_cash_total_amount").val(t)}else if($("#payment2_type").val().split("_")[0]=="REF"){$("#payment2_ref_total_amount").val(t)}}}}else{$("#balance_msg").html("0.00");$("#balanceRow").addClass("balance_msg_balanced");$("#newPaymentDiv").show();$("#creditDiv").hide();if(canAdjustDelayedPayment){$("#dp_adjust_down_div").hide()}$("#use_store_credits").prop("disabled",false);assignBalanceToRefTransactions(0)}if(b==0&&$("#payment1_type").val()==""&&$("#payment2_type").val()==""&&!onTimeShotAtSupplyingZeroPaymentHasOccurred&&orderState=="SAVED"){$("#payment1_type").val("CASH");changePayment1("CASH");$("#payment1_cash_total_amount").val("0.00");onTimeShotAtSupplyingZeroPaymentHasOccurred=true}let fe=$("#autoAdjustDiv");if(fe.length){if(N!=0&&canAutoAdjust){if(canAdjustDelayedPayment&&(currentDPAmount>0||N<0)){$("#OEH_auto_pay_msg").html("Check this to <span id='adj_action'><b>adjust customer's delayed payment.</b></span>")}else{if(N>0){$("#OEH_auto_pay_msg").html("Check this to <span id='adj_action'><b>credit customer's credit card now.</b></span>")}else{$("#OEH_auto_pay_msg").html("Check this to <span id='adj_action'><b>charge original credit card now.</b></span>")}}fe.show();if(!forceManualAutoAdjust){$("#autoAdjust").prop("checked",true);handleAutoAdjust($("#autoAdjust").get()[0])}}else{if(fe.is(":visible")){fe.hide();$("#autoAdjust").prop("checked",false);$("#payment1_type").val("");$("#payment2_type").val("");changePayment1("");changePayment2("")}}}$("#help_msg").html("");if($("#submit_changes").length){if(l>0||o>0||g>0){$("#submit_changes").prop("disabled",false)}else{$("#submit_changes").prop("disabled",true)}if(C>=Number(ce)+Number(C)&&ce!=0){$("#submit_changes").prop("disabled",true);$("#help_msg").html($("#help_msg").html()+'You cannot use a Direct Order Discount that is equal to or greater than the food cost total. Please use the "No Charge" payment type to give away an order.')}}if($("#help_msg").length){if($("#help_msg").html()!=""){$("#help_msg").show()}else{$("#help_msg").hide()}}reportPaymentStatus(false);HideLineItemsIfZero();if(orderState!="NEW"){updateChangeList()}}$(document).on("focusin",".bundle-subitem-qty",function(e){$(this).data("org_val",$(this).val())}).on("keyup change",".bundle-subitem-qty",function(e){let t=canIncrementBundleSubItem($(this),".bundle-subitem-qty");if(t!==true){$(this).val($(this).data("org_val"));dd_message({title:"Max Items Reached",message:t})}else{$(this).data("org_val",$(this).val());qtyUpdate(this)}calculateTotal()});function canIncrementBundleSubItem(e,t){let a=$(e).data("menu_item_id");let s=$(e).data("parent_item");let i=sideStationBundleInfo[s].bundle[a];let n=sideStationBundleInfo[s];let o=parseInt(n.number_items_required);let r=parseInt(i.bundle_to_menu_item_group_id)||0;let d=0;let l=0;let _=[];$(t+'[data-parent_item="'+s+'"]').each(function(){let e=$(this).data("menu_item_id");let t=$(this).data("parent_item");let a=sideStationBundleInfo[t].bundle[e];let s=parseInt(a.bundle_to_menu_item_group_id)||0;let i=parseInt($(this).data("org_val"))||0;let n=parseInt($(this).val())||0;d+=i;l+=n;if(typeof _[s]=="undefined"){_[s]={total_org:0,total_current:0}}_[s].total_org+=i;_[s].total_current+=n});if(l>o*parseInt($("#qty_"+s).val())){return"Number of items for the bundle has been reached"}if(n.bundle_groups.length>0){if(_[r].total_current>parseInt(n.bundle_groups[r].number_items_required)*parseInt($("#qty_"+s).val())){return"Number of items for the group has been reached"}}return true}function preferenceChangeListener(t,a,e,s){t=t.toUpperCase();let i=USER_PREFERENCES[t].value;if($.isPlainObject(i)&&$.isPlainObject(a)){a=JSON.stringify($.extend(USER_PREFERENCES[t].value,a))}else{a=a.toString()}if(t.includes("_DETAILS")){let e="MEAL_EXCLUDE_"+t.replace("MEAL_","").replace("_DETAILS","");meal_customization_preferences[e].details=a}else{meal_customization_preferences[t].value=a}$.ajax({url:"ddproc.php",type:"POST",timeout:2e4,dataType:"json",data:{processor:"admin_orderCustomization",op:"update_order_meal_customization",order_id:order_id,customizations:JSON.stringify(meal_customization_preferences)},success:function(e){if(e.processor_success){if(e.cost>0){$("#customization-fee-row").show();$("#MealCustomizationFeeRow").show()}else{$("#customization-fee-row").hide();$("#MealCustomizationFeeRow").hide()}if($("#manual_customization_fee").val()!="true"){$("#subtotal_meal_customization_fee").val(formatAsMoney(e.cost));$("#OEH_subtotal_meal_customization_fee").html(formatAsMoney(e.cost))}handleMealCustomizationFeeInput();if(typeof s!=="undefined"){s(e)}}else{dd_message({title:"Error",message:e.processor_message})}},error:function(e,t){dd_message({title:"Error",message:"Unexpected error: "+t})}})}$(document).on("change","#shipping_phone_number",function(e){$(".shipping_phone_number_new_div").hideFlex();$("#shipping_phone_number_new").prop("required",false);if($(this).val()=="new"){$(".shipping_phone_number_new_div").showFlex();$("#shipping_phone_number_new").prop("required",true)}});$(document).on("change","#hide-zero-sides",function(e){if($(this).is(":checked")){$('#sidesTbl [data-orig-remaining="0"]').hideFlex()}else{$("#sidesTbl [data-orig-remaining]").showFlex()}});$(document).on("change keyup",".delivery-input",function(e){deliveryChanges=false;$(".delivery-input").each(function(){if($(this).data("org_value")){let e=$(this).val();let t=$(this).data("org_value");if(e!=t){deliveryChanges=true}}});updateChangeList()});function costInputFeesTab(e){setFeesTabAsDirty();calculateTotal()}function setFeesTabAsDirty(){feesTabIsDirty=true}
//# sourceMappingURL=order_mgr.min.js.map