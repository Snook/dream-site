<?php
require_once(dirname(__FILE__) . "/../includes/Config.inc");
require_once("DAO/BusinessObject/CUser.php");
require_once("DAO/BusinessObject/CUserData.php");
require_once("DAO/BusinessObject/CPointsUserHistory.php");
require_once("DAO/CFactory.php");
require_once("CLog.inc");
require_once("CMailHandlers.inc");
require_once('ExcelExport.inc');

define('DEV', false);

$path = "/DreamReports/thaw_opt_in_detail.csv";
$path2 = "/DreamReports/thaw_opt_in_not_found.csv";

ini_set('memory_limit', '-1');
set_time_limit(3600 * 24);

$currentOptins = array(
	'12535084833',
	'14257609078',
	'13608153314',
	'13105291116',
	'16618105153',
	'16028201774',
	'18042009425',
	'14844329135',
	'14258917641',
	'15133687839',
	'12515335684',
	'19135221307',
	'16198183940',
	'17073309913',
	'17176153428',
	'17174051227',
	'17175727089',
	'19512069919',
	'15205397710',
	'13107737727',
	'19288146430',
	'18325702960',
	'17174903908',
	'14846956412',
	'18329077387',
	'17133039676',
	'14083077616',
	'13036676083',
	'13102915475',
	'18606379118',
	'19377500211',
	'13054793434',
	'12064653686',
	'13053316326',
	'12517097671',
	'12487876400',
	'16619727717',
	'12514594043',
	'17343581359',
	'14088814154',
	'14046171936',
	'14802057790',
	'17347887928',
	'15083263113',
	'12063727462',
	'19513269239',
	'18186135446',
	'16262744096',
	'17145988934',
	'13365750677',
	'18043872832',
	'15202549538',
	'12519786605',
	'18325358630',
	'15122281368',
	'14084104106',
	'12817257035',
	'17608159284',
	'16029318577',
	'15082726322',
	'13034899576',
	'19497027475',
	'15084047154',
	'17132050753',
	'14807731813',
	'18313319229',
	'14049064647',
	'13039218895',
	'19516635084',
	'15132052619',
	'12404407462',
	'16196727801',
	'13038072521',
	'17192443354',
	'18052768776',
	'16024817129',
	'16199975524',
	'16144406257',
	'15135439005',
	'13179893452',
	'19715335934',
	'12163746622',
	'13048392587',
	'13035640709',
	'19134882048',
	'15868794981',
	'16198229195',
	'17204809305',
	'12403675002',
	'16824659642',
	'15087897386',
	'15134102862',
	'14257727819',
	'17608156142',
	'14087713437',
	'14084106676',
	'14086240250',
	'15082599407',
	'13365281633',
	'13365756720',
	'12518021688',
	'14087105000',
	'17134984313',
	'14084399164',
	'18182072842',
	'19377761795',
	'18287791717',
	'14073356948',
	'15033106232',
	'13176701576',
	'13172949967',
	'16199943132',
	'14252997248',
	'17073178199',
	'13234495235',
	'17174688881',
	'17143251527',
	'17175147954',
	'13057103767',
	'15134057374',
	'12403081442',
	'17149315564',
	'18012010605',
	'12513756667',
	'17143458945',
	'16612123606',
	'12144357781',
	'13176799229',
	'13854957807',
	'12514548505',
	'14085157164',
	'17146583468',
	'19492871292',
	'19545203593',
	'18052172049',
	'19092820358',
	'18052316998',
	'16193019057',
	'19077756186',
	'12536322026',
	'19188099371',
	'13059790488',
	'17179518955',
	'12814133053',
	'12518956045',
	'16023204274',
	'18058040730',
	'15417401348',
	'14802158662',
	'16196946180',
	'16196473242',
	'17346731430',
	'18328142551',
	'13174591681',
	'17602777577',
	'12514555738',
	'18324198626',
	'19547901556',
	'16026952835',
	'17133763303',
	'18045918139',
	'18174542999',
	'15133259671',
	'18327228624',
	'13609075693',
	'18015970484',
	'18016029105',
	'13852187755',
	'14136274703',
	'16614331601',
	'17658940492',
	'12094998509',
	'18609666660',
	'17205305488',
	'15097377192',
	'19548542018',
	'19098556599',
	'17654653571',
	'12487018111',
	'16098650195',
	'19515516966',
	'18032421924',
	'12488913881',
	'13173792023',
	'12672505404',
	'17708422065',
	'17135303052',
	'18622089463',
	'13039565706',
	'16027585359',
	'17175140519',
	'19739451549',
	'18603890266',
	'13347142349',
	'14085693043',
	'19548733898',
	'13609047614',
	'15135493590',
	'16024881188',
	'15125676367',
	'13175230678',
	'16102831912',
	'14258918024',
	'13607715904',
	'19374773314',
	'19184074417',
	'17192424357',
	'19802330124',
	'18653890098',
	'18055502356',
	'17143562593',
	'15033809744',
	'17202778169',
	'18058907875',
	'14437168872',
	'19544150699',
	'12094828910',
	'17607178900',
	'12516109828',
	'15014280424',
	'18598038996',
	'14258793027',
	'13059724300',
	'18126304757',
	'16207945008',
	'14082182898',
	'16199904892',
	'17247086729',
	'18057486285',
	'14844598821',
	'18013180978',
	'14806953777',
	'17049042907',
	'15133498158',
	'15135322785',
	'19083391678',
	'15132936760',
	'13109181836',
	'16026391464',
	'16508149306',
	'14802873686',
	'19492857013',
	'17177250928',
	'15037810109',
	'16193014834',
	'12483204163',
	'19546834681',
	'15084547263',
	'16789839747',
	'16023004570',
	'19259892777',
	'16024992729',
	'15038511481',
	'16198202179',
	'12199023401',
	'13014424081',
	'17179516114',
	'15135206671',
	'17192054819',
	'16103508123',
	'15132258010',
	'18476369853',
	'14016926744',
	'18593919922',
	'16194469993',
	'12816392191',
	'12144485575',
	'18189266297',
	'17143577975',
	'16025626138',
	'17209825000',
	'17138946474',
	'12516042381',
	'15134602155',
	'17576636093',
	'13104877584',
	'13039607423',
	'17817714025',
	'19373699671',
	'18582912131',
	'13039159216',
	'19715703331',
	'17602120119',
	'19097096753',
	'17074951167',
	'17148017275',
	'18323859227',
	'12149574162',
	'12487626862',
	'19284998598',
	'18172233330',
	'12069196861',
	'14438669878',
	'18602508765',
	'19083102412',
	'19096187539',
	'19082273953',
	'18184390768',
	'12067947496',
	'13369714455',
	'17138852778',
	'15025945224',
	'19092282932',
	'17177795029',
	'18144702774',
	'13017889859',
	'13015095415',
	'15627430275',
	'16197561946',
	'14085156824',
	'15618666691',
	'18057041859',
	'12516564721',
	'12677386082',
	'14044552770',
	'12515912178',
	'18507120674',
	'15126993806',
	'19376543957',
	'18183992940',
	'17409733426',
	'17409754647',
	'15039756159',
	'12818028610',
	'19375335582',
	'17277723475',
	'15122890587',
	'18182491302',
	'16177504729',
	'19379744134',
	'19548826801',
	'18608052524',
	'12063913480',
	'19519701567',
	'17072492894',
	'15037505364',
	'17607156025',
	'13172707734',
	'16193223745',
	'12067902817',
	'18103341961',
	'12483027132',
	'18043044513',
	'15034534133',
	'12513270135',
	'12514236053',
	'15419909885',
	'18434224242',
	'17814915065',
	'15089541922',
	'15082084350',
	'18185991982',
	'17209718528',
	'15124155329',
	'13053222216',
	'15202504784',
	'14252199086',
	'18082281294',
	'18017839937',
	'17573038443',
	'13058041943',
	'13852155385',
	'19517950643',
	'15415174675',
	'16193978497',
	'16265433880',
	'15097607242',
	'12485349565',
	'12698499869',
	'17134804304',
	'12543195487',
	'19082403132',
	'15093085420',
	'15132521460',
	'13015377227',
	'18082847225',
	'12024873214',
	'18322442954',
	'12516239439',
	'17133986610',
	'16505211131',
	'16785579014',
	'15136044376',
	'18476826201',
	'15134979680',
	'14047132295',
	'15082121334',
	'16197239569',
	'12065511822',
	'12516898153',
	'18327794283',
	'12099693425',
	'15089225187',
	'14803327690',
	'13609219365',
	'17137759319',
	'14802298684',
	'18584019014',
	'15095889989',
	'15416229569',
	'17173090626',
	'15135436825',
	'12069724830',
	'15124227560',
	'15209541453',
	'19712352499',
	'17193605779',
	'14803900966',
	'12519793549',
	'19376941757',
	'19495003036',
	'18502122902',
	'17205600906',
	'17076890533',
	'13176523175',
	'18578919182',
	'19375422352',
	'12022360002',
	'17607152704',
	'14084580178',
	'16235125342',
	'16107165878',
	'16094689167',
	'18606149546',
	'15085093643',
	'15127454204',
	'12094047835',
	'16193029878',
	'15419089536',
	'16514706470',
	'14692316656',
	'19546754646',
	'13175138969',
	'19197605521',
	'16783726863',
	'17132563906',
	'12814508301',
	'17608998797',
	'18173124556',
	'19374752365',
	'12516045284',
	'16176788493',
	'13174081340',
	'17042546667',
	'13103675025',
	'12526753315',
	'16785498190',
	'18053382112',
	'18012440067',
	'15417401326',
	'16198817904',
	'15129247881',
	'15094305313',
	'18596304955',
	'13606749927',
	'13238100561',
	'16263535669',
	'16264828988',
	'12404767307',
	'18053905312',
	'16193186158',
	'16193155581',
	'18452824685',
	'15712015942',
	'18052189089',
	'18054076371',
	'18053382385',
	'12069003229',
	'19167093583',
	'18013805465',
	'16175139405',
	'13038875534',
	'12489432346',
	'19515336941',
	'16193799465',
	'14106153847',
	'17012136957',
	'15136083421',
	'16187131291',
	'17742595771',
	'15209097752',
	'12096144447',
	'18043825484',
	'18326462589',
	'12514901825',
	'18583448360',
	'12484203997',
	'19795750726',
	'15203903151',
	'13608362173',
	'19519704650',
	'18044797591',
	'16025707194',
	'12149123480',
	'13109016190',
	'14049335847',
	'16145627953',
	'15082946406',
	'16146578391',
	'13609096396',
	'17194596578',
	'15417608796',
	'16192770459',
	'15086927331',
	'19082020120',
	'12092724893',
	'14253871353',
	'13076794226',
	'18012307976',
	'17144035054',
	'17208794175',
	'13106001080',
	'14016172616',
	'12814676892',
	'13033562955',
	'12402778076',
	'12483182860',
	'17706338798',
	'13034081861',
	'15132365289',
	'19734798089',
	'12069200155',
	'15202052655',
	'16198877778',
	'14434871662',
	'16193003464',
	'18605431222',
	'18609893938',
	'13059790095',
	'15036546030',
	'15305269518',
	'18592409832',
	'17076880457',
	'15868733855',
	'12064050454',
	'19376726896',
	'18014009038',
	'16502186085',
	'16199288787',
	'13059750287',
	'14086790612',
	'19515458557',
	'15086494489',
	'14084274656',
	'19736004456',
	'17604025697',
	'17604450797',
	'15124315157',
	'14259714157',
	'12517534780',
	'16198898584',
	'15092210379',
	'17072080603',
	'18034124184',
	'17604450922',
	'18587745143',
	'19167161844',
	'14082307111',
	'15083281137',
	'18049316671',
	'17742544209',
	'18597576101',
	'17607303829',
	'13604897360',
	'14805408661',
	'19097311816',
	'12064278148',
	'14254462935',
	'14258764926',
	'12105636203',
	'18048941337',
	'17135458807',
	'15133104814',
	'15209066386',
	'12513773281',
	'12516051466',
	'19092287777',
	'15132609853',
	'14789575050',
	'15094301166',
	'17147241237',
	'16028031966',
	'17203264086',
	'12035000008',
	'16175120991',
	'18057489861',
	'17657141501',
	'17605336907',
	'12514595476',
	'14086919874',
	'19548024130',
	'12096144270',
	'17604204614',
	'17608153764',
	'18583491345',
	'17606131339',
	'15124137054',
	'18043637251',
	'18045513442',
	'17604205735',
	'17033624063',
	'15712416303',
	'16784626325',
	'18608840109',
	'13178096592',
	'16024781918',
	'18172356251',
	'16026143654',
	'17202335590',
	'18586994601',
	'17608038192',
	'19493785864',
	'17605198704',
	'17605866832',
	'16024999691',
	'16787490005',
	'17608452322',
	'15134768622',
	'15415317706',
	'18583531977',
	'17742087797',
	'17604195046',
	'19547908268',
	'18585197414',
	'18502934334',
	'15203607164',
	'17608452333',
	'12099185184',
	'15038286919',
	'15034676003',
	'17604739219',
	'15039363153',
	'12672181155',
	'18055353065',
	'19545583118',
	'18018853296',
	'16302911944',
	'14109842008',
	'17173096251',
	'12483790762',
	'17143191590',
	'16503531986',
	'13609035905',
	'18173683683',
	'13607495013',
	'12814147479',
	'13176101830',
	'15083318606',
	'18052180863',
	'15037526052',
	'16026191482',
	'15136580157',
	'18186189733',
	'12483965371',
	'15136756047',
	'13035073817',
	'15612717834',
	'16782318400',
	'17655859668',
	'18598165990',
	'15134609409',
	'15136521780',
	'18313208784',
	'19132209695',
	'14802122718',
	'16142078992',
	'16196072192',
	'12098572111',
	'13103508160',
	'16012481946',
	'15104328851',
	'15132335983',
	'15412313037',
	'13054793223',
	'18586993614',
	'12817039225',
	'19089638932',
	'19083051231',
	'15209811211',
	'19194144493',
	'15597188548',
	'13036185148',
	'16232298620',
	'15129144488',
	'12484955754',
	'17605834058',
	'16232171433',
	'18609899775',
	'13107299583',
	'15088019705',
	'17817997503',
	'18183890181',
	'15202400892',
	'15033276993',
	'17202315820',
	'16262333615',
	'13034068637',
	'16238894046',
	'12488606716',
	'18014737938',
	'18186458135',
	'18054446624',
	'16193845312',
	'15864914751',
	'18322179263',
	'19415458430',
	'12567947273',
	'16784677544',
	'17703299915',
	'18058013047',
	'18586996403',
	'16024513811',
	'19177555315',
	'17174954436',
	'15132655438',
	'13057941065',
	'19375727883',
	'18019283505',
	'12062760549',
	'13132201443',
	'15409039663',
	'17034774122',
	'13109419055',
	'18014715023',
	'18013692657',
	'18055502803',
	'18312349966',
	'12814683018',
	'15095281486',
	'17208793216',
	'16198383899',
	'14083932798',
	'12148020401',
	'16025618748',
	'15125078230',
	'19136341183',
	'19134615967',
	'16145707346',
	'16028590204',
	'17138547714',
	'18057987414',
	'17742321611',
	'17742772443',
	'15083971334',
	'15083805192',
	'18586929067',
	'19135445731',
	'17077613354',
	'18052165435',
	'12067693454',
	'15129649218',
	'12157688951',
	'19494667701',
	'17173190321',
	'14846366089',
	'19162052821',
	'18044025759',
	'18589226178',
	'19099380376',
	'18054411234',
	'12817977132',
	'18327238577',
	'16176862748',
	'15095915840',
	'16192413214',
	'16502691442',
	'13038689311',
	'15093782460',
	'15625564456',
	'19094356487',
	'15417608264',
	'19374788302',
	'16199227345',
	'19168494568',
	'13052823911',
	'13366824757',
	'12815360404',
	'13039070264',
	'16172936840',
	'12095056578',
	'15862156612',
	'13607981953',
	'17133035304',
	'16199228417',
	'14084646579',
	'19378300972',
	'14084899164',
	'16265336303',
	'13303171243',
	'16194545223',
	'16197086163',
	'16196654215',
	'12514043440',
	'19169969271',
	'16192043161',
	'18016029683',
	'16143526359',
	'13125052443',
	'15136526460',
	'12405773012',
	'12814350729',
	'17174955822',
	'17174059061',
	'17752243365',
	'17816401033',
	'16179660743',
	'19374784654',
	'19375249682',
	'19546122779',
	'12814143539',
	'19716785893',
	'13136832375',
	'17605215237',
	'18325269768',
	'12403724783',
	'12288066891',
	'14044314267',
	'16149895710',
	'15035773285',
	'18012431997',
	'15412243886',
	'17347889362',
	'15089497460',
	'19543245735',
	'18186452744',
	'14803074750',
	'18014719855',
	'18587350155',
	'18587614281',
	'15132569127',
	'17326140404',
	'19169901676',
	'15206611257',
	'18185164781',
	'12488771891',
	'17194592825',
	'12036236909',
	'18172532941',
	'19736470158',
	'17202528253',
	'14083061414',
	'17046193326',
	'19515512834',
	'17706349437',
	'19376893635',
	'18017552497',
	'16023210235',
	'17176828894',
	'16194175597',
	'17654095866',
	'19515004887',
	'18049372465',
	'18048921671',
	'18047125690',
	'18044325589',
	'14358647976',
	'12069151469',
	'19498742842',
	'15132253560',
	'15129658415',
	'17602087317',
	'17202722052',
	'17193471583',
	'19548490457',
	'12513792730',
	'15138841713',
	'13054796217',
	'15135209820',
	'17818643371',
	'17143196055',
	'17077047099',
	'15629651788',
	'17135946113',
	'16192000554',
	'15035800650',
	'15039134863',
	'15099428353',
	'18324522903',
	'15124318342',
	'18312459464',
	'16262601062',
	'18173077588',
	'18609822516',
	'12813819527',
	'15134703589',
	'12139254352',
	'19137091089',
	'17742540947',
	'19543099233',
	'14049224737',
	'17077619088',
	'12487013928',
	'19089305704',
	'17175727571',
	'18179918774',
	'18174809248',
	'12152851562',
	'17605002164',
	'14253302633',
	'15088465405',
	'19135584813',
	'12146329686',
	'14257609054',
	'17069695394',
	'16506196183',
	'17609536970',
	'18083471845',
	'13124047040',
	'15134793676',
	'12067780734',
	'16789256282',
	'15039013808',
	'19518059115',
	'16783864595',
	'17173156940',
	'15038713623',
	'13017504270',
	'19377632822',
	'15032608802',
	'13176976591',
	'19493785531',
	'16262779307',
	'12516898588',
	'17604453937',
	'15093801681',
	'16147384675',
	'13609212072',
	'15095287628',
	'16026928981',
	'15088168310',
	'15205912023',
	'15084796872',
	'17608458746',
	'19374695008',
	'16105637503',
	'17654188898',
	'18582040701',
	'19252855919',
	'16783575756',
	'17077182102',
	'17175877885',
	'18013769292',
	'17604194556',
	'14253087460',
	'13177973155',
	'12608200382',
	'15132078714',
	'12152903440',
	'15035169275',
	'14848812839',
	'13017170828',
	'15209071027',
	'15133151555',
	'18185719477',
	'17134780421',
	'18592402784',
	'13019190454',
	'13013704994',
	'14088884348',
	'19513034816',
	'14083863915',
	'16028033778',
	'17146062422',
	'15136465901',
	'17194659500',
	'17755606431',
	'18604903730',
	'19373085226',
	'13174500337',
	'18484590932',
	'14087182361',
	'19099360455',
	'15126896354',
	'15155700263',
	'15417402204',
	'12062349680',
	'16193701146',
	'17607913049',
	'17608353368',
	'15132271515',
	'17133923898',
	'16193025471',
	'17703671905',
	'13174329683',
	'19546507762',
	'17605052770',
	'17605861182',
	'17757414289',
	'13017288906',
	'18013605329',
	'15417403943',
	'12517696242',
	'16174627566',
	'16143578952',
	'12242803341',
	'19132052254',
	'14257914792',
	'17176828181',
	'14843549538',
	'17174715177',
	'16264290076',
	'15138185953',
	'18016524932',
	'19082094811',
	'18057144161',
	'19086167921',
	'14252636107',
	'19132690139',
	'15035028491',
	'16107371838',
	'15132884061',
	'17344241315',
	'17193515726',
	'12819236092',
	'14257507380',
	'12515544659',
	'13015026995',
	'12063009811',
	'13013257912',
	'15132655775',
	'14045836274',
	'18607098726',
	'17194400091',
	'19169552866',
	'13179413096',
	'14013168844',
	'15033140296',
	'14254171165',
	'18057920700',
	'16198554199',
	'12819004955',
	'13106297930',
	'12067955206',
	'17175862733',
	'17149284210',
	'16264822298',
	'13602694162',
	'18182310082',
	'15127699620',
	'15127369912',
	'17138589696',
	'16099471223',
	'15129402475',
	'16193684249',
	'19514919592',
	'18589975425',
	'12814603320',
	'13606913443',
	'13054580846',
	'17142691706',
	'19135585263',
	'15093660760',
	'15132360952',
	'14257732762',
	'13018731510',
	'15125609761',
	'17073329607',
	'17379321199',
	'15082591885',
	'13052813885',
	'13052832719',
	'15132251877',
	'18326680718',
	'12407503571',
	'13177480148',
	'13605136263',
	'17073378764',
	'15174257002',
	'13037178491',
	'18582125224',
	'13035141694',
	'14802169548',
	'15095397333',
	'14088912878',
	'18042481014',
	'15136684529',
	'12817889344',
	'15866159396',
	'16143075571',
	'17637447483',
	'18054714777',
	'19175893046',
	'17179911598',
	'14013784764',
	'18015735531',
	'19098966728',
	'13037270010',
	'16502694356',
	'18045644668',
	'18015507265',
	'17703101799',
	'18606140299',
	'18593947610',
	'15082725797',
	'19164758579',
	'17738601881',
	'17408153088',
	'12402914562',
	'16269268772',
	'16144065487',
	'19096728499',
	'19082960501',
	'15136154341',
	'17204368811',
	'14084992238',
	'18054052399',
	'15414010451',
	'13176775726',
	'15205461423',
	'17655326967',
	'16145066397',
	'13044156324',
	'15864845762',
	'17147218253',
	'19495255280',
	'14437429304',
	'15133091627',
	'15036894497',
	'18608331848',
	'19727431850',
	'18586881130',
	'19524526896',
	'18583498119',
	'18184707263',
	'14252696319',
	'17148558851',
	'13036538357',
	'15417401894',
	'15867098542',
	'13034785954',
	'18584447231',
	'17132045685',
	'18178453246',
	'19165910596',
	'17604923691',
	'18057482047',
	'17075645019',
	'19546121521',
	'14802099348',
	'19045340089',
	'13035889029',
	'17074809482',
	'12098157620',
	'12817852643',
	'15135090429',
	'15129699020',
	'13237082891',
	'19372195765',
	'13039901109',
	'14153703638',
	'17146510591',
	'17144884524',
	'15083979268',
	'14803101779',
	'17607590436',
	'17196845482',
	'19094809380',
	'12515109621',
	'17174970815',
	'16026157846',
	'15134790062',
	'18177931788',
	'18178757910',
	'17607153434',
	'18166682976',
	'17036270589',
	'15039130088',
	'19376748305',
	'15417403659',
	'12064847258',
	'14086130686',
	'14254666453',
	'16026223153',
	'15126565776',
	'15714997129',
	'18189032293',
	'17175150255',
	'12403513081',
	'19372691045',
	'12487921951',
	'15128797673',
	'17148834388',
	'19495335414',
	'13178470751',
	'13175231579',
	'15135439365',
	'14043605966',
	'15032779709',
	'17022046503',
	'13176980778',
	'13123390308',
	'14256222309',
	'17875566745',
	'17018486267',
	'18048732794',
	'15415177803',
	'15203880552',
	'15126608080',
	'17133494348',
	'12145639259',
	'19136690670',
	'12147552751',
	'12073562905',
	'15033075300',
	'18324831453',
	'13607084934',
	'18183897055',
	'18322775619',
	'18652555220',
	'19088098062',
	'12103810332',
	'19728905820',
	'19043825472',
	'16239804774',
	'14258774837',
	'17049418878',
	'19163465455',
	'18015922930',
	'19546106247',
	'15139178707',
	'17402621305',
	'18312079137',
	'17074376315',
	'19512594458',
	'17209885658',
	'13363375650',
	'17197221861',
	'19257859767',
	'18049208324',
	'13035142535',
	'12515103445',
	'17146151018',
	'19496365008',
	'12068500003',
	'15037937590',
	'19514429165',
	'19373047449',
	'17193390454',
	'17037288425',
	'18057097024',
	'18504455930',
	'17178087726',
	'12516058760',
	'16154007195',
	'19522125996',
	'16822215450',
	'19376570487',
	'19514532122',
	'17865662613',
	'12402917409',
	'18182812435',
	'17605095771',
	'15407606766',
	'13172233964',
	'19099363936',
	'17172244165',
	'17174130475',
	'19513157119',
	'19082851977',
	'14252686141',
	'12812356203',
	'13168411519',
	'19082296375',
	'12138069451',
	'17173335335',
	'16262724919',
	'18605088105',
	'12516809225',
	'19548818221',
	'15095218351',
	'15083605961',
	'19092222824',
	'18179464963',
	'17208990336',
	'15132589519',
	'13145186420',
	'15415611354',
	'18045030474',
	'14438782135',
	'19377680065',
	'12054517800',
	'16193394251',
	'15857480131',
	'16266656255',
	'17196492541',
	'13053318162',
	'14803694888',
	'12513792115',
	'15203103105',
	'17132067925',
	'14097899695',
	'15132956609',
	'13035141365',
	'13173197233',
	'19167308433',
	'15209049194',
	'12513771008',
	'19512830806',
	'18019109579',
	'19034360254',
	'15135920524',
	'18173121516',
	'15023147523',
	'17023392944',
	'17348125339',
	'12103717696',
	'12317404354',
	'18504999572',
	'12404057141',
	'18605597658',
	'17606709440',
	'12819487394',
	'17654265427',
	'15083301499',
	'17247194477',
	'12404465380',
	'14082040592',
	'15125173674',
	'19134816604',
	'15037525239',
	'18016718449',
	'14433925149',
	'12489412596',
	'15139674609',
	'17209556305',
	'19062412220',
	'16198717597',
	'15094302659',
	'17122537560',
	'15416660586',
	'13038773305',
	'18043012238',
	'12545419083',
	'14259718976',
	'15415719797',
	'18013808244',
	'12315106068',
	'15202716528',
	'13136005870',
	'15093089885',
	'17147973002',
	'17172014788',
	'13059784457',
	'12516544965',
	'14046646824',
	'18057952530',
	'18596538121',
	'12516899206',
	'15127738575',
	'19193943859',
	'12487010589',
	'15098511813',
	'14084093013',
	'16503031281',
	'17047242205',
	'15204449272',
	'18328160233',
	'15096279071',
	'18328684322',
	'15205913850',
	'13365759142',
	'17707107280',
	'16176028055',
	'17609006947',
	'18508900678',
	'15034078743',
	'17209825243',
	'19372721847',
	'13362517790',
	'12178409341',
	'19546056006',
	'12482276525',
	'17607157193',
	'12256030931',
	'13606000663',
	'17576515905',
	'13609360841',
	'13034758970',
	'19084328196',
	'17172011142',
	'15412241709',
	'12488071501',
	'14806950990',
	'19166275071',
	'18609950848',
	'17175380622',
	'15035446807',
	'12817336657',
	'18042390372',
	'15088267475',
	'14802007522',
	'13039010444',
	'15203066906',
	'18604788253',
	'16264299260',
	'17202039273',
	'17148619240',
	'16147536514',
	'17607072876',
	'13153989542',
	'18013691942',
	'14088355375',
	'18054022642',
	'17193672038',
	'13367498562',
	'15209777017',
	'17819744170',
	'19375947444',
	'15093082687',
	'17142252841',
	'17605359941',
	'17073412944',
	'16503032763',
	'15303048871',
	'16198380343',
	'19097207669',
	'14127603132',
	'16143521554',
	'15204444446',
	'13105293959',
	'13035030296',
	'18165343853',
	'18018306323',
	'13015204905',
	'15128481782',
	'17737260840',
	'13016063838',
	'18603849816',
	'13014124264',
	'17708432659',
	'18325847005',
	'17175126975',
	'18155460472',
	'19167435550',
	'17206309874',
	'15126995561',
	'17203632503',
	'18582433423',
	'14085980980',
	'18179487590',
	'18054798084',
	'12087311257',
	'14084833365',
	'19373076277',
	'17143077456',
	'15417608746',
	'12034943705',
	'14046302719',
	'17209517028',
	'17654907741',
	'17147427851',
	'19515515285',
	'18325743081',
	'19168723266',
	'17813676881',
	'15417408683',
	'15097278676',
	'15094926330',
	'16146027231',
	'17178240020',
	'14692353015',
	'15093087421',
	'12057465735',
	'12095056990',
	'18054054598',
	'18052353820',
	'12405850988',
	'18582297234',
	'16155795108',
	'17076284962',
	'19376206957',
	'19518160722',
	'13176966180',
	'17863521594',
	'12512321626',
	'12403298604',
	'16028033381',
	'13038875080',
	'15415132264',
	'14086684142',
	'17735698700',
	'16262904908',
	'19379742066',
	'16147466438',
	'17148879824',
	'19082462573',
	'16143130664',
	'14086797808',
	'18042452784',
	'13178336425',
	'15309170349',
	'16023694472',
	'13109774036',
	'12098140176',
	'17173646857',
	'12817726653',
	'12516806154',
	'14406664148',
	'17177992926',
	'18596305859',
	'13104976221',
	'17194330417',
	'13175020001',
	'19787359854',
	'18082600097',
	'19548059770',
	'12516561379',
	'17148156321',
	'12514217527',
	'15093082351',
	'18016359951',
	'19515884687',
	'13606353053',
	'18014250072',
	'15134981076',
	'19802570028',
	'18177096943',
	'16613106577',
	'15125874752',
	'17074283771',
	'13178482668',
	'18609181208',
	'16787350627',
	'14252485057',
	'18019289935',
	'12516047707',
	'18049374583',
	'16503158105',
	'17176068312',
	'19257659657',
	'14352149417',
	'15038285137',
	'18048369939',
	'17407390472',
	'12487366871',
	'19174509086'
);

$resultTemplate = array(
	'MC_number' => "",
	"num_accounts_found" => 0,
	"users" => array()
);
try
{
	$fh = fopen($path, 'w');

	$results = array();

	$labels = array(
		'MC Number',
		'num accounts found',
		'user_id',
		'lastlogin',
		'time_created',
		'last_session',
		'num_orders',
		'has_number_pref',
		'has_pref',
		'upsert number sql',
		'upsert number sql 2',
	);
	$length = fputs($fh, implode(",", $labels) . "\r\n");

	$userDAO = new DAO();

	echo "begin user query\r\n";

	$userDAO->query("select iq.*, max(s.session_start) as last_session, COUNT(distinct b.id) as num_orders, u2.sf_id from (
                            select u.id, u.telephone_1, u.telephone_2, u.is_deleted, u.last_login, u.timestamp_created from user u
                                        where (not isnull(u.telephone_2) and LENGTH(u.telephone_2) > 9)
                                        or (not isnull(u.telephone_1) and LENGTH(u.telephone_1) > 9) and u.is_deleted = 0
                                        ) as iq
                                left join booking b on b.user_id = iq.id and b.status= 'ACTIVE' and b.is_deleted  = 0
                                left join session s on s.id = b.session_id
                                left join dreamdigest.user u2 on iq.id = u2.DD_USER_ID
                                group by iq.id");

	echo "found {$userDAO->N} users\r\n";

	$processed = 0;

	while ($userDAO->fetch())
	{
		$processed++;
		if ($processed % 500 == 0)
		{
			echo "processed $processed users\r\n";
		}

		$telephone1 = $userDAO->telephone_1;
		$telephone1 = preg_replace('/\D/', '', $telephone1);
		if (strlen($telephone1) == 10 && $telephone1[0] != 1)
		{
			// good number
			$telephone1 = "1" . $telephone1;

			if (in_array($telephone1, $currentOptins))
			{
				if (!isset($results[$telephone1]))
				{
					$results[$telephone1] = $resultTemplate;
					$results[$telephone1]['MC_number'] = $telephone1;
				}
				$results[$telephone1]['num_accounts_found']++;

				$results[$telephone1]['users'][$userDAO->id] = array(
					'id' => $userDAO->id,
					'last_login' => $userDAO->last_login,
					'created' => $userDAO->timestamp_created,
					'last_session' => $userDAO->last_session,
					'num_orders' => $userDAO->num_orders,
					'has_number_pref' => 0,
					'has_pref' => 0,
					'sf_id' => $userDAO->sf_id,
					'upsert_number_sql' => "",
					'upsert_number_sql_2' => ""
				);

				$prefTest = new DAO();
				$prefTest->query("select * from user_preferences where pkey = 'TEXT_MESSAGE_TARGET_NUMBER' and user_id = {$userDAO->id} and is_deleted = 0");
				if ($prefTest->N > 0)
				{
					$prefTest->fetch();

					$results[$telephone1]['users'][$userDAO->id] ['has_number_pref'] = $prefTest->pvalue;
					$results[$telephone1]['users'][$userDAO->id] ['upsert_number_sql'] = "update user_preference set pvalue = ''" . CTemplate::telephoneFormat($telephone1) . "' where user_id = " . $userDAO->id . " and is_deleted = 0 and pkey = 'TEXT_MESSAGE_TARGET_NUMBER';";
				}
				else
				{
					$results[$telephone1]['users'][$userDAO->id] ['upsert_number_sql'] = "\"insert into user_preferences (user_id, pkey, pvalue, timestamp_created, created_by) values ({$userDAO->id}, 'TEXT_MESSAGE_TARGET_NUMBER','" . CTemplate::telephoneFormat($telephone1) . "', now(), 1);\"";
				}

				$prefTest2 = new DAO();
				$prefTest2->query("select * from user_preferences where pkey = 'TEXT_MESSAGE_PROMO_PRIMARY' and user_id = {$userDAO->id} and is_deleted = 0");
				if ($prefTest2->N > 0)
				{
					$results[$telephone1]['users'][$userDAO->id]['has_pref'] = 1;
					$results[$telephone1]['users'][$userDAO->id]['upsert_number_sql_2'] = "update user_preference set pvalue = 'OPTED_IN' where user_id = " . $userDAO->id . " and is_deleted = 0 and pkey = 'TEXT_MESSAGE_PROMO_PRIMARY';";
				}
				else
				{
					$results[$telephone1]['users'][$userDAO->id]['upsert_number_sql_2'] = "\"insert into user_preferences (user_id, pkey, pvalue, timestamp_created, created_by) values ({$userDAO->id}, 'TEXT_MESSAGE_PROMO_PRIMARY','OPTED_IN', now(), 1);\"";
				}
			}
		}

		$telephone2 = $userDAO->telephone_2;
		$telephone2 = preg_replace('/\D/', '', $telephone2);
		if (strlen($telephone2) == 10 && $telephone2[0] != 1)
		{
			// good number
			$telephone2 = "1" . $telephone2;

			if ($telephone2 == $telephone1)
			{
				continue;
			}

			if (in_array($telephone2, $currentOptins))
			{
				if (!isset($results[$telephone2]))
				{
					$results[$telephone2] = $resultTemplate;
					$results[$telephone2]['MC_number'] = $telephone2;
				}
				$results[$telephone2]['num_accounts_found']++;

				$results[$telephone2]['users'][$userDAO->id] = array(
					'id' => $userDAO->id,
					'last_login' => $userDAO->last_login,
					'created' => $userDAO->timestamp_created,
					'last_session' => $userDAO->last_session,
					'num_orders' => $userDAO->num_orders,
					'has_number_pref' => 0,
					'has_pref' => 0,
					'sf_id' => $userDAO->sf_id,
					'upsert_number_sql' => "",
					'upsert_number_sql_2' => ""
				);

				$prefTest = new DAO();
				$prefTest->query("select * from user_preferences where pkey = 'TEXT_MESSAGE_TARGET_NUMBER' and user_id = {$userDAO->id} and is_deleted = 0");
				if ($prefTest->N > 0)
				{
					$prefTest->fetch();

					$results[$telephone2]['users'][$userDAO->id]['has_number_pref'] = $prefTest->pvalue;
					$results[$telephone2]['users'][$userDAO->id]['upsert_number_sql'] = "update user_preference set pvalue = ''" . CTemplate::telephoneFormat($telephone2) . "' where user_id = " . $userDAO->id . " and is_deleted = 0 and pkey = 'TEXT_MESSAGE_TARGET_NUMBER';";
				}
				else
				{
					$results[$telephone2]['users'][$userDAO->id]['upsert_number_sql'] = "\"insert into user_preferences (user_id, pkey, pvalue, timestamp_created, created_by) values ({$userDAO->id}, 'TEXT_MESSAGE_TARGET_NUMBER','" . CTemplate::telephoneFormat($telephone2) . "', now(), 1);\"";
				}

				$prefTest2 = new DAO();
				$prefTest2->query("select * from user_preferences where pkey = 'TEXT_MESSAGE_THAW_PRIMARY' and user_id = {$userDAO->id} and is_deleted = 0");
				if ($prefTest2->N > 0)
				{
					$results[$telephone2]['users'][$userDAO->id]['has_pref'] = 1;
					$results[$telephone2]['users'][$userDAO->id]['upsert_number_sql_2'] = "update user_preference set pvalue = 'OPTED_IN' where user_id = " . $userDAO->id . " and is_deleted = 0 and pkey = 'TEXT_MESSAGE_THAW_PRIMARY';";
				}
				else
				{
					$results[$telephone2]['users'][$userDAO->id]['upsert_number_sql_2'] = "\"insert into user_preferences (user_id, pkey, pvalue, timestamp_created, created_by) values ({$userDAO->id}, 'TEXT_MESSAGE_THAW_PRIMARY','OPTED_IN', now(), 1);\"";
				}
			}
		}
	}

	foreach ($results as $thisRow)
	{
		if ($thisRow['num_accounts_found'] == 1)
		{
			$UDA = array_shift($thisRow['users']);
			$userData = implode(",", $UDA);
			unset($thisRow['users']);
			$phoneData = implode(",", $thisRow);
			$length = fputs($fh, $phoneData . "," . $userData . "\r\n");
		}
		else if ($thisRow['num_accounts_found'] == 2)
		{
			$chosenUser = null;
			$user1 = array_shift($thisRow['users']);
			$user2 = array_shift($thisRow['users']);

			if ($user1['num_orders'] > 0 && $user1['num_orders'] > 0)
			{
				if (strtotime($user1['last_session']) > strtotime($user2['last_session']))
				{
					$chosenUser = $user1;
				}
				else
				{
					$chosenUser = $user2;
				}
			}
			else if ($user1['num_orders'] > 0 || $user2['num_orders'] > 0)
			{
				if ($user1['num_orders'] > 0)
				{
					$chosenUser = $user1;
				}
				else
				{
					$chosenUser = $user2;
				}
			}
			else
			{
				$user1Time = null;
				$user2Time = null;

				if (strtotime($user1['created']) > strtotime($user1['last_login']))
				{
					$user1Time = strtotime($user1['created']);
				}
				else
				{
					$user1Time = strtotime($user1['last_login']);
				}

				if (strtotime($user2['created']) > strtotime($user2['last_login']))
				{
					$user2Time = strtotime($user2['created']);
				}
				else
				{
					$user2Time = strtotime($user2['last_login']);
				}

				if ($user1Time > $user2Time)
				{
					$chosenUser = $user1;
				}
				else
				{
					$chosenUser = $user2;
				}
			}

			$userData = implode(",", $chosenUser);
			unset($thisRow['users']);

			$phoneData = implode(",", $thisRow);
			$length = fputs($fh, $phoneData . "," . $userData . "\r\n");
		}
		else
		{
			unset($thisRow['users']);
			$thisRow = array_merge($thisRow, array(
				"-",
				"-",
				"-",
				"-",
				"-",
				"-",
				"-",
				"-",
				"-",
				"-"
			));
			$phoneData = implode(",", $thisRow);
			$length = fputs($fh, $phoneData . "\r\n");
		}
	}

	$fh2 = fopen($path2, 'w');

	foreach ($currentOptins as $disNum)
	{
		$disNum = $disNum;
		if (!isset($results[$disNum]))
		{
			$length = fputs($fh2, $disNum . "\r\n");
		}
	}

	echo "all done\r\n";
	fclose($fh);
	fclose($fh2);
}
catch (exception $e)
{
	CLog::RecordException($e);
}

?>